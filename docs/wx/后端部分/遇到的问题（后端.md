---
title: é‡åˆ°çš„é—®é¢˜ï¼ˆåç«¯ï¼‰
date: 2025-11-28
---

### ä»€ä¹ˆæ˜¯æšä¸¾ï¼Ÿ

**æšä¸¾ï¼ˆEnumerationï¼Œç®€ç§° Enumï¼‰** æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œç”¨äºå®šä¹‰ä¸€ç»„**å›ºå®šçš„ã€æœ‰é™çš„å¸¸é‡é›†åˆ**ã€‚å®ƒè®©ç¨‹åºä¸­çš„å¸¸é‡ç®¡ç†æ›´å®‰å…¨ã€æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ã€‚


#### ğŸŒ° ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š

æ¯”å¦‚â€œä¸€å‘¨çš„æ˜ŸæœŸâ€åªæœ‰ 7 å¤©ï¼šæ˜ŸæœŸä¸€ã€æ˜ŸæœŸäºŒâ€¦â€¦æ˜ŸæœŸæ—¥ã€‚  
æˆ‘ä»¬å¯ä»¥ç”¨æ•°å­— `1~7` è¡¨ç¤ºï¼Œä½†è¿™æ ·å®¹æ˜“å‡ºé”™ï¼ˆæ¯”å¦‚ä¼ äº† `8`ï¼‰ï¼Œä¹Ÿä¸ç›´è§‚ã€‚

ä½¿ç”¨æšä¸¾ï¼Œå°±å¯ä»¥è¿™æ ·å®šä¹‰ï¼š

```java
public enum DayOfWeek {
    MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY
}
```

ç„¶åè¿™æ ·ä½¿ç”¨ï¼š

```java
DayOfWeek today = DayOfWeek.MONDAY;
```

è¿™æ ·ï¼Œ`today` çš„å€¼åªèƒ½æ˜¯ `MONDAY` åˆ° `SUNDAY` ä¸­çš„ä¸€ä¸ªï¼Œ**ä¸å¯èƒ½æ˜¯å…¶ä»–å€¼**ï¼Œéå¸¸å®‰å…¨ã€‚

---

#### âœ… æšä¸¾çš„ä¼˜ç‚¹

| ä¼˜ç‚¹           | è¯´æ˜                                                         |
| -------------- | ------------------------------------------------------------ |
| **ç±»å‹å®‰å…¨**   | åªèƒ½å–æšä¸¾ä¸­å®šä¹‰çš„å€¼ï¼Œä¸èƒ½éšæ„èµ‹å€¼                           |
| **å¯è¯»æ€§å¼º**   | ä»£ç æ›´æ¸…æ™°ï¼Œä¸€çœ‹å°±çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€                             |
| **é¿å…é­”æ³•å€¼** | é¿å…ä½¿ç”¨ `0`, `1`, `"male"`, `"female"` è¿™æ ·çš„â€œé­”æ³•å­—ç¬¦ä¸²/æ•°å­—â€ |
| **å¯æ‰©å±•**     | æšä¸¾å¯ä»¥æœ‰æ„é€ æ–¹æ³•ã€å­—æ®µã€æ–¹æ³•ï¼Œç”šè‡³å®ç°æ¥å£                 |

---

#### ğŸ§© Java ä¸­æšä¸¾çš„åŸºæœ¬è¯­æ³•

```java
public enum Status {
    // æšä¸¾å¸¸é‡ï¼ˆé€šå¸¸å¤§å†™ï¼‰
    PENDING,   // å¾…å¤„ç†
    SUCCESS,   // æˆåŠŸ
    FAILED     // å¤±è´¥
}
```

ä½¿ç”¨ï¼š

```java
Status status = Status.SUCCESS;
if (status == Status.SUCCESS) {
    System.out.println("æ“ä½œæˆåŠŸï¼");
}
```

---

#### ğŸ”§ æšä¸¾çš„é«˜çº§ç”¨æ³•ï¼ˆå¸¦å±æ€§å’Œæ–¹æ³•ï¼‰

```java
public enum Gender {
    MALE("m", "ç”·"),
    FEMALE("f", "å¥³");

    private String code;
    private String desc;

    // æ„é€ æ–¹æ³•
    Gender(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }

    // getter æ–¹æ³•
    public String getCode() { return code; }
    public String getDesc() { return desc; }

    // æ ¹æ® code æŸ¥æ‰¾æšä¸¾
    public static Gender fromCode(String code) {
        for (Gender g : values()) {
            if (g.code.equals(code)) {
                return g;
            }
        }
        throw new IllegalArgumentException("æœªçŸ¥çš„æ€§åˆ«ä»£ç : " + code);
    }
}
```

ä½¿ç”¨ï¼š

```java
Gender gender = Gender.fromCode("m");
System.out.println(gender.getDesc()); // è¾“å‡ºï¼šç”·
```

---

#### ğŸ“Œ å¸¸è§ä½¿ç”¨åœºæ™¯

1. **çŠ¶æ€ç **ï¼šå¦‚è®¢å•çŠ¶æ€ï¼ˆå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å‘è´§ï¼‰
2. **ç±»å‹æ ‡è¯†**ï¼šå¦‚ç”¨æˆ·ç±»å‹ï¼ˆæ™®é€šç”¨æˆ·ã€VIPã€ç®¡ç†å‘˜ï¼‰
3. **é…ç½®é¡¹**ï¼šå¦‚æ¶ˆæ¯ç±»å‹ï¼ˆç³»ç»Ÿæ¶ˆæ¯ã€é€šçŸ¥ã€ç§ä¿¡ï¼‰
4. **å¼€å…³é€‰é¡¹**ï¼šå¦‚æ˜¯å¦å¯ç”¨ï¼ˆENABLED, DISABLEDï¼‰

---

#### âš ï¸ æ³¨æ„äº‹é¡¹

- æšä¸¾ç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼ˆéšå¼ `final`ï¼‰
- æšä¸¾å¸¸é‡å¿…é¡»å†™åœ¨æœ€å‰é¢
- `values()` æ–¹æ³•è¿”å›æ‰€æœ‰æšä¸¾å€¼æ•°ç»„
- `valueOf("XXX")` å¯ä»¥æ ¹æ®åå­—è·å–æšä¸¾ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

> **æšä¸¾ = ä¸€ç»„å‘½åçš„å¸¸é‡ + ç±»çš„ç‰¹æ€§**

-----





### å¦‚ä½•é¿å…ç”Ÿæˆç”¨æˆ·IDæ—¶çš„é‡å¤é—®é¢˜

**æŒ‡å‘ï¼š**userinfo registerä¸šåŠ¡

ä½“é‡å°ç›´æ¥éšæœºå°±è¡Œï¼Œä½†ä½“é‡å¤§äº†æ€ä¹ˆåŠï¼Ÿ





### å¦‚ä½•å®ç°ç™»å½•æŒ¤æ‰å…¶ä»–æ­£åœ¨ä½¿ç”¨è¯¥è´¦æˆ·çš„äººï¼Ÿ

**æŒ‡å‘ï¼š**userinfo loginä¸šåŠ¡

è¢«å¡æ­»éš¾é“è¿˜è¦æ‰“ç”µè¯æ±‚æ•‘ç®¡ç†å‘˜ï¼Ÿ

1. è¾“å…¥å®‰å…¨å¯†é’¥å†»ç»“è´¦å·





### è·¨åŸŸäº†æ€ä¹ˆåŠï¼Ÿå®é™…æƒ…å†µä¸‹æ€ä¹ˆå¤„ç†æœ€å¦¥å½“ï¼Ÿ





### æ€ä¹ˆæ£€æŸ¥è¡¨å¤´æ¯”è¾ƒå¥½ï¼Ÿæ‹¦æˆªå™¨è¿˜æ˜¯AOPï¼Ÿæ€ä¹ˆå®ç°ï¼Ÿ

AOPæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Aroundä¸€ç§è‡ªå®šä¹‰æ³¨è§£çš„æ–¹å¼æ¥å®ç°å¯¹æŒ‡å®šæ–¹æ³•çš„æ‹¦æˆªæ£€æŸ¥ï¼Œè¿™ç§æ–¹å¼é€‚åˆçµæ´»å¤æ‚çš„åœºæ™¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç»Ÿä¸€ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é…ï¼Œæ¯”å¦‚ï¼š`@Around("execution(* com.example.service.*.*(..))")`



### æ‹¦æˆªå™¨å’ŒAOPä¸€å—ä½¿ç”¨çš„æƒ…å†µä¸‹ä¼šå†²çªå—ï¼Ÿæ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ



### äº‹åŠ¡å¤±æ•ˆ

åœ¨ä½¿ç”¨ AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰å’Œäº‹åŠ¡ç®¡ç†æ—¶ï¼Œæœ‰å‡ ä¸ªå…³é”®çš„æ³¨æ„äº‹é¡¹éœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚è¿™äº›æ³¨æ„äº‹é¡¹ä¸»è¦æ¶‰åŠ Spring çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶ã€AOP ä»£ç†çš„å·¥ä½œåŸç†ä»¥åŠå®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯é¿å…è‡ªè°ƒç”¨ï¼ˆ**è‡ªè°ƒç”¨ä¼šå¯¼è‡´ç»•è¿‡AOPçš„ä»£ç†ï¼Œä½¿ç”¨åŸå§‹å¯¹è±¡this.method()ï¼Œè€Œæ­¤æ—¶åŸå§‹å¯¹è±¡çš„äº‹åŠ¡æ˜¯åŸºäºä¸€ä¸ªä»£ç†å®ç°çš„ï¼Œè€Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„æ–¹å¼thisæŒ‡é’ˆä¼šä½¿å¾—é‚£ä¸ªä»£ç†æ— æ³•è¢«è§¦å‘ä»è€Œå¯¼è‡´äº‹åŠ¡å›æ»šå¤±æ•ˆ**ï¼‰ä¸¾ä¸ªä¾‹å­ï¼š

```java
@Service
public class MyService {

     @Transactional
    public void methodB() {
        userRepository.save(new User("Alice"));
        throw new RuntimeException("å‡ºé”™ï¼");
    }

    public void methodA() {
        methodB(); 
    }
}
```

è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°Bæ–¹æ³•è¢«Aæ–¹æ³•åœ¨ä¸€ä¸ªBeanå¯¹è±¡å†…è‡ªè°ƒç”¨ï¼Œæ­¤æ—¶thisæŒ‡é’ˆæŒ‡å‘**åŸå§‹æ–¹æ³•**è€Œéäº‹åŠ¡æ³¨è§£å®ç°çš„**ä»£ç†**ï¼Œå¯¼è‡´äº‹åŠ¡æ³¨è§£å¤±æ•ˆï¼Œåœ¨å®Œæˆsaveä¹‹åï¼Œ**sqlä¼šç›´æ¥æäº¤**ï¼Œå³ä¾¿åç»­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå›æ»šï¼ï¼ï¼

ä½†æ³¨æ„ï¼å¦‚æœä½ åœ¨å¤–éƒ¨ç›´æ¥è°ƒç”¨äº†Bæ–¹æ³•è€ŒéAæ–¹æ³•ï¼Œäº‹åŠ¡ä»æ—§ç”Ÿæ•ˆï¼Œè¿™ä¸€ç‚¹è¯·ä¸è¦æé”™ã€‚

å†æ¥çœ‹è¿™ä¸ªï¼š

```java
@Service
public class MyService {

    public void methodB() {
        userRepository.save(new User("Alice"));
        throw new RuntimeException("å‡ºé”™ï¼");
    }

    @Transactional
    public void methodA() {
        orderRepository.save(new Order(100));
        methodB(); // è°ƒç”¨æ— äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•
    }
}
```

è¿™æ—¶è°ƒç”¨æ–¹æ³•Aï¼Œæ–¹æ³•Bçš„å†…å®¹ä¹Ÿä¼šåŠ å…¥äº‹åŠ¡ï¼Œå‘ç”Ÿäº†å¼‚å¸¸åæ˜¯å¯ä»¥å›æ»šçš„ï¼

å½“ç„¶å¦‚æœä½ ç›´æ¥è°ƒç”¨äº†æ–¹æ³•Aé‚£è‚¯å®šæ˜¯å›æ»šä¸äº†äº†ã€‚

è¿˜æœ‰å°±æ˜¯ä¸¤ä¸ªæ–¹æ³•éƒ½æœ‰äº‹åŠ¡æ³¨è§£ï¼Œé‚£ä¹ˆç­”æ¡ˆä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¢«è°ƒç”¨çš„äº‹åŠ¡æ³¨è§£å¤±æ•ˆï¼Œå¤–å±‚çš„æ–¹æ³•äº‹åŠ¡ä¾æ—§ç”Ÿæ•ˆï¼Œå‘ç”Ÿå¼‚å¸¸ä¹Ÿè¿˜æ˜¯å¯ä»¥å›æ»šçš„ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦é¿å…çš„æƒ…å†µåªæœ‰ä¸€ç§ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªæœªè¢«äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•è‡ªè°ƒç”¨äº†ä¸€ä¸ªäº‹åŠ¡æ³¨è§£çš„æ–¹æ³•å¯¼è‡´è¯¥æ–¹æ³•äº‹åŠ¡æ³¨è§£å¤±æ•ˆæ— æ³•å›æ»šï¼Œä¸”æœ€ç»ˆå›æº¯åˆ°æœ€å¤–å±‚å‡æ²¡æœ‰äº‹åŠ¡æ³¨è§£ï¼Œè¿™æ—¶å°±å®Œå…¨ä¸ä¼šå‘ç”Ÿå¼‚å¸¸å›æ»šäº†ã€‚å…¶ä»–æƒ…å†µåªè¦ä¿è¯ä¸å»è°ƒç”¨ä¸€ä¸ªè¿äº‹åŠ¡æ³¨è§£éƒ½æ²¡æœ‰çš„æ–¹æ³•ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ„å¤–äº†ã€‚å‡ ç§äº‹åŠ¡å¤±æ•ˆçš„æƒ…å†µï¼š

 **å†…éƒ¨æ–¹æ³•è°ƒç”¨å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ**

 **é`public`æ–¹æ³•ä¸Šçš„äº‹åŠ¡æ³¨è§£**

 **å¼‚å¸¸å¤„ç†ä¸å½“å¯¼è‡´äº‹åŠ¡æœªå›æ»šï¼ˆå¦‚aspectåæ‰äº†å¼‚å¸¸**

 **äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆPropagationï¼‰é…ç½®é”™è¯¯**

 **äº‹åŠ¡è¶…æ—¶ï¼ˆ`timeout`ï¼‰å±æ€§çš„è¯¯ç”¨ä¸é™åˆ¶**

ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†æ¢è®¨ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼š

#### 1. **ç†è§£ Spring äº‹åŠ¡ç®¡ç†çš„åŸºç¡€**

Spring æä¾›äº†å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼Œé€šå¸¸é€šè¿‡ `@Transactional` æ³¨è§£æ¥å®ç°ã€‚è¿™ä¸ªæ³¨è§£å¯ä»¥åº”ç”¨åˆ°ç±»çº§åˆ«æˆ–æ–¹æ³•çº§åˆ«ï¼Œç”¨äºå®šä¹‰äº‹åŠ¡è¾¹ç•Œã€‚å½“ä¸€ä¸ªæ–¹æ³•è¢«æ ‡è®°ä¸º `@Transactional`ï¼ŒSpring å°†ä¼šåœ¨è¯¥æ–¹æ³•æ‰§è¡Œå‰å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼ˆå¦‚æœè¿˜æ²¡æœ‰äº‹åŠ¡å­˜åœ¨çš„è¯ï¼‰ï¼Œå¹¶åœ¨æ–¹æ³•æˆåŠŸå®Œæˆåæäº¤äº‹åŠ¡ï¼›å¦‚æœæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä¼šå›æ»šäº‹åŠ¡ã€‚

#### 2. **è‡ªè°ƒç”¨é—®é¢˜ï¼ˆSelf-invocation Issueï¼‰**

è¿™æ˜¯ AOP å’Œäº‹åŠ¡ç®¡ç†ä¸­ä¸€ä¸ªå¸¸è§çš„é™·é˜±ã€‚å½“ä½ åœ¨ä¸€ä¸ª Bean å†…éƒ¨ç›´æ¥è°ƒç”¨å¦ä¸€ä¸ªå¸¦æœ‰ `@Transactional` æ³¨è§£çš„æ–¹æ³•æ—¶ï¼Œäº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚è¿™æ˜¯å› ä¸º Spring AOP æ˜¯åŸºäºä»£ç†çš„ï¼Œå†…éƒ¨è°ƒç”¨å¹¶ä¸ä¼šç»è¿‡ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥äº‹åŠ¡ç®¡ç†ä¹Ÿä¸ä¼šè¢«è§¦å‘ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

- å°½é‡é¿å…åœ¨åŒä¸€ä¸ª Bean ä¸­è¿›è¡Œè‡ªæˆ‘è°ƒç”¨ï¼Œæ¢åˆ°å¦ä¸€ä¸ªBeanä¸­è°ƒç”¨ã€‚
- å¦‚æœå¿…é¡»è¿™æ ·åšï¼Œå¯ä»¥é€šè¿‡ `AopContext.currentProxy()` è·å–å½“å‰ä»£ç†å¯¹è±¡ï¼Œå¹¶é€šè¿‡å®ƒæ¥è°ƒç”¨ç›®æ ‡æ–¹æ³•ã€‚

#### 3. **äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆPropagation Behaviorï¼‰**

Spring æ”¯æŒå¤šç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œå¦‚ `REQUIRED`, `REQUIRES_NEW`, `SUPPORTS`, `NOT_SUPPORTED`, `MANDATORY`, `NEVER`, `NESTED`ã€‚é€‰æ‹©æ­£ç¡®çš„ä¼ æ’­è¡Œä¸ºå¯¹äºç¡®ä¿äº‹åŠ¡æ­£ç¡®å¤„ç†è‡³å…³é‡è¦ã€‚

ä¾‹å¦‚ï¼š
- `REQUIRED`ï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœæ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°äº‹åŠ¡ã€‚
- `REQUIRES_NEW`ï¼šæ€»æ˜¯åˆ›å»ºæ–°çš„äº‹åŠ¡ï¼Œå¹¶æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚

#### 4. **å¼‚å¸¸å¤„ç†ä¸äº‹åŠ¡å›æ»š**

é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰æœªæ£€æŸ¥å¼‚å¸¸ï¼ˆå³è¿è¡Œæ—¶å¼‚å¸¸åŠå…¶å­ç±»ï¼‰ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šã€‚å¦‚æœä½ æƒ³è®©äº‹åŠ¡åœ¨æ£€æŸ¥å¼‚å¸¸ï¼ˆå¦‚ `SQLException`ï¼‰å‘ç”Ÿæ—¶ä¹Ÿå›æ»šï¼Œéœ€è¦æ˜¾å¼æŒ‡å®šï¼š

```java
@Transactional(rollbackFor = Exception.class)
public void someMethod() {
    // æ–¹æ³•é€»è¾‘
}
```

æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `noRollbackFor` å±æ€§æ¥æŒ‡å®šå“ªäº›å¼‚å¸¸ä¸åº”å¯¼è‡´å›æ»šã€‚




### ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ

`ThreadLocal` æœ¬èº«æ˜¯ Java æ ‡å‡†åº“ï¼ˆ`java.lang.ThreadLocal`ï¼‰ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒå¹¶ä¸æ˜¯ Spring Boot ç‰¹æœ‰çš„ã€‚ä½†æ˜¯ï¼Œåœ¨ Spring Boot åº”ç”¨ä¸­ï¼Œç”±äºå…¶å¤šçº¿ç¨‹å¤„ç†è¯·æ±‚çš„ç‰¹æ€§ï¼ˆæ¯ä¸ª HTTP è¯·æ±‚é€šå¸¸ç”±ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å¤„ç†ï¼‰ï¼Œ`ThreadLocal` æˆä¸ºäº†ä¸€ä¸ªéå¸¸æœ‰ç”¨ä¸”å¸¸ç”¨çš„å·¥å…·ï¼Œç”¨äºåœ¨åŒä¸€çº¿ç¨‹å†…è·¨æ–¹æ³•ã€è·¨ç»„ä»¶ä¼ é€’æ•°æ®ï¼ŒåŒæ—¶ä¿è¯æ•°æ®çš„çº¿ç¨‹éš”ç¦»æ€§ã€‚

---

#### ä¸€ã€ä»€ä¹ˆæ˜¯ ThreadLocalï¼Ÿ

**æ ¸å¿ƒæ¦‚å¿µï¼š**
`ThreadLocal` ä¸ºæ¯ä¸ªä½¿ç”¨å®ƒçš„çº¿ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚è¿™æ„å‘³ç€æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚

ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªâ€œçº¿ç¨‹çº§åˆ«çš„å±€éƒ¨å˜é‡â€ï¼Œä½†å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ˜ å°„ï¼ˆMapï¼‰ï¼Œå…¶ä¸­ï¼š
*   **Key**ï¼šå½“å‰çº¿ç¨‹ï¼ˆ`Thread` å¯¹è±¡ï¼‰
*   **Value**ï¼šè¯¥çº¿ç¨‹ç»‘å®šçš„å˜é‡å€¼

**ç®€å•æ¥è¯´ï¼š**
> `ThreadLocal` è®©ä½ åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è·å–åˆ°ä½ ä¹‹å‰è®¾ç½®çš„æ•°æ®ï¼Œå°±åƒè¿™ä¸ªæ•°æ®æ˜¯â€œå…¨å±€â€çš„ï¼Œä½†åªå¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚

---

#### äºŒã€ä¸ºä»€ä¹ˆåœ¨ Spring Boot ä¸­ä½¿ç”¨ ThreadLocalï¼Ÿ

Spring Boot åº”ç”¨é€šå¸¸æ˜¯åŸºäº Servlet å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰è¿è¡Œçš„ï¼Œå®¹å™¨ä¼šä½¿ç”¨çº¿ç¨‹æ± æ¥å¤„ç†å¹¶å‘è¯·æ±‚ã€‚æ¯ä¸ª HTTP è¯·æ±‚ç”±ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åçº¿ç¨‹ä¼šè¢«æ”¾å›æ± ä¸­ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œ`ThreadLocal` çš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†ï¼š

1.  **çº¿ç¨‹å®‰å…¨çš„æ•°æ®ä¼ é€’**ï¼š
    *   åœ¨ä¸€æ¬¡è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½éœ€è¦ç»è¿‡å¤šä¸ª Serviceã€DAO å±‚ã€‚
    *   å¦‚æœä½ æƒ³åœ¨æ•´ä¸ªè¯·æ±‚é“¾è·¯ä¸­ä¼ é€’ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ· IDã€è¯·æ±‚ IDã€è®¤è¯ä¿¡æ¯ç­‰ï¼‰ï¼Œé€šè¿‡å‚æ•°å±‚å±‚ä¼ é€’éå¸¸éº»çƒ¦ã€‚
    *   ä½¿ç”¨ `ThreadLocal`ï¼Œä½ å¯ä»¥åœ¨è¯·æ±‚å¼€å§‹æ—¶ï¼ˆå¦‚åœ¨æ‹¦æˆªå™¨æˆ–è¿‡æ»¤å™¨ä¸­ï¼‰è®¾ç½®è¿™äº›ä¿¡æ¯ï¼Œåç»­æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥ç›´æ¥ä» `ThreadLocal` ä¸­è·å–ï¼Œæ— éœ€ä¼ å‚ã€‚

2.  **é¿å…é‡å¤åˆ›å»ºå¯¹è±¡**ï¼š
    *   æŸäº›å¯¹è±¡ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€SimpleDateFormatï¼‰åˆ›å»ºå¼€é”€è¾ƒå¤§ï¼Œä¸”ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
    *   å¯ä»¥å°†å®ƒä»¬å­˜å‚¨åœ¨ `ThreadLocal` ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„å®ä¾‹ï¼Œæ—¢èŠ‚çœèµ„æºåˆä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

3.  **å®ç°ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š
    *   Spring è‡ªèº«ä¹Ÿå¤§é‡ä½¿ç”¨ `ThreadLocal` æ¥ç®¡ç†äº‹åŠ¡ã€å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆå¦‚ `SecurityContextHolder`ï¼‰ç­‰ã€‚

---

#### ä¸‰ã€å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ

##### åŸºæœ¬ç”¨æ³•

```java
// 1. åˆ›å»ºä¸€ä¸ª ThreadLocal å®ä¾‹ï¼ˆé€šå¸¸ä½œä¸ºé™æ€å˜é‡ï¼‰
public class UserContext {
    private static final ThreadLocal<String> userIdHolder = new ThreadLocal<>();
    
    // è®¾ç½®å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ID
    public static void setUserId(String userId) {
        userIdHolder.set(userId);
    }
    
    // è·å–å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ID
    public static String getUserId() {
        return userIdHolder.get();
    }
    
    // æ¸…é™¤å½“å‰çº¿ç¨‹çš„ç”¨æˆ·IDï¼ˆéå¸¸é‡è¦ï¼ï¼‰
    public static void clear() {
        userIdHolder.remove();
    }
}
```

##### åœ¨ Spring Boot ä¸­çš„å®é™…åº”ç”¨ç¤ºä¾‹

###### åœºæ™¯ï¼šè®°å½•æ¯æ¬¡è¯·æ±‚çš„å”¯ä¸€ ID å’Œç”¨æˆ·ä¿¡æ¯

1.  **å®šä¹‰ ThreadLocal å·¥å…·ç±»**

```java
@Component
public class RequestContext {
    // å­˜å‚¨è¯·æ±‚ID
    private static final ThreadLocal<String> requestIdHolder = new ThreadLocal<>();
    // å­˜å‚¨ç”¨æˆ·ID
    private static final ThreadLocal<String> userIdHolder = new ThreadLocal<>();

    public void setRequestId(String requestId) {
        requestIdHolder.set(requestId);
    }

    public String getRequestId() {
        return requestIdHolder.get();
    }

    public void setUserId(String userId) {
        userIdHolder.set(userId);
    }

    public String getUserId() {
        return userIdHolder.get();
    }

    public void clear() {
        requestIdHolder.remove();
        userIdHolder.remove();
    }
}
```

2.  **åˆ›å»ºæ‹¦æˆªå™¨æˆ–è¿‡æ»¤å™¨ï¼Œåœ¨è¯·æ±‚å¼€å§‹æ—¶è®¾ç½®ï¼Œç»“æŸæ—¶æ¸…é™¤**

```java
@Component
@Order(1) // ç¡®ä¿ä¼˜å…ˆçº§
public class RequestContextInterceptor implements HandlerInterceptor {

    @Autowired
    private RequestContext requestContext;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // ç”Ÿæˆè¯·æ±‚ID
        String requestId = UUID.randomUUID().toString();
        // å‡è®¾ä» Header æˆ– Token ä¸­è§£æç”¨æˆ·ID
        String userId = request.getHeader("X-User-Id"); 
        if (userId == null) userId = "anonymous";

        // è®¾ç½®åˆ° ThreadLocal
        requestContext.setRequestId(requestId);
        requestContext.setUserId(userId);

        System.out.println("Request started: ID=" + requestId + ", User=" + userId);
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        // å…³é”®ï¼šå¿…é¡»æ¸…é™¤ï¼é˜²æ­¢å†…å­˜æ³„æ¼å’Œè„æ•°æ®
        requestContext.clear();
        System.out.println("Request completed, ThreadLocal cleared.");
    }
}
```

3.  **æ³¨å†Œæ‹¦æˆªå™¨**

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private RequestContextInterceptor requestContextInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(requestContextInterceptor);
    }
}
```

4.  **åœ¨ä»»æ„ Service ä¸­ä½¿ç”¨**

```java
@Service
public class UserService {
    @Autowired
    private RequestContext requestContext;

    public void doSomething() {
        String currentRequestId = requestContext.getRequestId();
        String currentUserId = requestContext.getUserId();
        
        System.out.println("Processing for user: " + currentUserId + " [RequestID: " + currentRequestId + "]");
        // åç»­é€»è¾‘...
    }
}
```

---

#### å››ã€é‡è¦æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

1.  **å¿…é¡»æ‰‹åŠ¨æ¸…é™¤ï¼ˆremoveï¼‰**ï¼š
    *   è¿™æ˜¯**æœ€é‡è¦çš„ä¸€ç‚¹**ï¼
    *   ç”±äº Web å®¹å™¨ä½¿ç”¨çº¿ç¨‹æ± ï¼Œçº¿ç¨‹ä¼šè¢«å¤ç”¨ã€‚å¦‚æœä¸è°ƒç”¨ `remove()`ï¼Œä¸Šä¸€ä¸ªè¯·æ±‚è®¾ç½®çš„ `ThreadLocal` å€¼å¯èƒ½ä¼šè¢«ä¸‹ä¸€ä¸ªè¯·æ±‚é”™è¯¯åœ°è¯»å–ï¼Œå¯¼è‡´**è„æ•°æ®**é—®é¢˜ã€‚
    *   æ›´ä¸¥é‡çš„æ˜¯ï¼Œå¦‚æœ `ThreadLocal` ä¸­æŒæœ‰å¤§å¯¹è±¡æˆ–å­˜åœ¨å¼ºå¼•ç”¨ï¼Œä¼šå¯¼è‡´**å†…å­˜æ³„æ¼**ã€‚å› ä¸º `ThreadLocalMap` çš„ Entry æ˜¯ `WeakReference<ThreadLocal>`ï¼Œä½† Value æ˜¯å¼ºå¼•ç”¨ã€‚å¦‚æœ `ThreadLocal` å®ä¾‹ä¸å†è¢«å¼•ç”¨ï¼ŒKey ä¼šè¢«å›æ”¶ï¼Œä½† Value ä¸ä¼šï¼Œå½¢æˆâ€œå¼±é”®å¼ºå€¼â€çš„æ³„æ¼ã€‚
    *   **è§£å†³æ–¹æ¡ˆ**ï¼šåŠ¡å¿…åœ¨è¯·æ±‚ç»“æŸæ—¶ï¼ˆå¦‚ `afterCompletion` æˆ– `finally` å—ï¼‰è°ƒç”¨ `remove()`ã€‚

2.  **é¿å…è¿‡åº¦ä½¿ç”¨**ï¼š
    *   è™½ç„¶æ–¹ä¾¿ï¼Œä½†æ»¥ç”¨ `ThreadLocal` ä¼šä½¿ä»£ç å˜å¾—â€œéšå¼â€å’Œéš¾ä»¥æµ‹è¯•ã€‚
    *   æ•°æ®ä¼ é€’ä¸é€æ˜ï¼Œå¢åŠ äº†ç†è§£æˆæœ¬ã€‚
    *   å°½é‡åªç”¨äºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·ã€è¯·æ±‚IDã€äº‹åŠ¡çŠ¶æ€ç­‰ï¼‰ã€‚

3.  **è€ƒè™‘ä½¿ç”¨ InheritableThreadLocal**ï¼š
    *   å¦‚æœä¸»çº¿ç¨‹åˆ›å»ºäº†å­çº¿ç¨‹ï¼ˆå¦‚ä½¿ç”¨ `@Async` æ³¨è§£çš„å¼‚æ­¥æ–¹æ³•ï¼‰ï¼Œæ™®é€š `ThreadLocal` çš„å€¼ä¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™å­çº¿ç¨‹ã€‚
    *   æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `InheritableThreadLocal`ï¼Œå®ƒä¼šåœ¨å­çº¿ç¨‹åˆ›å»ºæ—¶è‡ªåŠ¨å¤åˆ¶çˆ¶çº¿ç¨‹çš„ `ThreadLocal` å€¼ã€‚

4.  **Spring æä¾›çš„æ›¿ä»£æ–¹æ¡ˆ**ï¼š
    *   å¯¹äºæŸäº›åœºæ™¯ï¼ŒSpring æä¾›äº†æ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š
        *   **`@RequestScope` Bean**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Bean å®ä¾‹ï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨ã€‚
        *   **MDC (Mapped Diagnostic Context)**ï¼šé…åˆæ—¥å¿—æ¡†æ¶ï¼ˆå¦‚ Logbackï¼‰ï¼Œç”¨äºæ—¥å¿—è¿½è¸ªï¼Œæ¯”æ‰‹åŠ¨ `ThreadLocal` æ›´æ ‡å‡†ã€‚

---

#### äº”ã€æ€»ç»“

åœ¨ Spring Boot ä¸­ï¼Œ`ThreadLocal` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œä¸»è¦ç”¨äºï¼š

*   **è¯·æ±‚ä¸Šä¸‹æ–‡æ•°æ®çš„ä¼ é€’**ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚IDï¼‰
*   **çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ç®¡ç†**ï¼ˆéçº¿ç¨‹å®‰å…¨å·¥å…·ç±»çš„å®ä¾‹ï¼‰
*   **å®ç°ç‰¹å®šçš„çº¿ç¨‹éš”ç¦»é€»è¾‘**

**å…³é”®åŸåˆ™ï¼š**

*   **ç”¨å®Œå³æ¸…**ï¼šå¿…é¡»åœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨ `remove()`ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼å’Œè„æ•°æ®ã€‚
*   **è°¨æ…ä½¿ç”¨**ï¼šä¸è¦æ»¥ç”¨ï¼Œä¿æŒä»£ç çš„æ¸…æ™°å’Œå¯ç»´æŠ¤æ€§ã€‚
*   **è€ƒè™‘æ›¿ä»£æ–¹æ¡ˆ**ï¼šè¯„ä¼°æ˜¯å¦å¯ä»¥ç”¨ `@RequestScope` æˆ– MDC ç­‰æ›´åˆé€‚çš„æ–¹å¼ã€‚

æ­£ç¡®ä½¿ç”¨ `ThreadLocal`ï¼Œå¯ä»¥è®©ä½ çš„ Spring Boot åº”ç”¨æ›´åŠ é«˜æ•ˆå’Œç®€æ´ã€‚




### AOPæ— è®ºä»€ä¹ˆéƒ½æŠ›å‡ºUndeclaredThrowableExceptionï¼Œæ— æ³•å£°æ˜å—æ£€æŠ›å‡ºå¼‚å¸¸æ˜¯æ€ä¹ˆå›äº‹
https://www.cnblogs.com/maerpao/p/17975000
é€šè¿‡åå°„åˆ¤æ–­æ˜¯å¦å±äºåˆ‡ç‚¹æ‰§è¡Œæ–¹æ³•çš„å£°æ˜çš„Exceptionï¼Œå¦‚æœä¸æ˜¯ä¸”ä¸å±äº**RuntimeException**ï¼Œé‚£ä¹ˆå°†ä¼šä½¿ç”¨UndeclaredThrowableExceptionåŒ…è£…åŸå§‹çš„Exceptionã€‚
åªè¦å£°æ˜çš„å¼‚å¸¸ä¸æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œé‚£ä¹ˆåˆ‡ç‚¹æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ï¼Œéƒ½ä¼šè¢«åŒ…è£…æˆUndeclaredThrowableExceptionã€‚æ­¤æ—¶æˆ‘ä»¬æœ‰ä¸‰ç§é€‰æ‹©ï¼š
1. æ”¾äº†ä»–ï¼Œç›´æ¥è®©SpringBootå…œåº•ï¼ˆè¿˜çœŸè¡Œï¼‰ï¼Œä½†æ˜¯è¿™æ ·éå¸¸ä¸å¥½ï¼Œå¥½çš„é¡¹ç›®åº”è¯¥å°½é‡å»æ•è·æ‰€æœ‰å¼‚å¸¸ã€‚
2. ä¿®æ”¹åˆ‡ç‚¹æ–¹æ³•å£°æ˜çš„å¼‚å¸¸ï¼Œå°†å¼‚å¸¸æ”¹ä¸ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œä½†è¿™ä¹Ÿä¸ç¬¦åˆä¸šåŠ¡è¦æ±‚ï¼Œä¸€äº›ä¸šåŠ¡å¼‚å¸¸å¹¶éè¿è¡Œæ—¶å¼‚å¸¸ã€‚
3. è§£åŒ…UndeclaredThrowableExceptionï¼ˆåŸå§‹å¼‚å¸¸è¢«åŒ…è£…åˆ°å±æ€§causeä¸­ï¼‰ï¼Œå°†åŸå§‹å¼‚å¸¸æŠ›å‡ºï¼Œè·å–åˆ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼‚å¸¸ä¿¡æ¯ã€‚

äº‹å®ä¸ŠSpringBootçš„æ–¹æ¡ˆä¸€æä¾›çš„ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯å°†UndeclaredThrowableExceptionè§£åŒ…ï¼Œå°†åŸå§‹å¼‚å¸¸æŠ›å‡ºã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨å…¨å±€å¼‚å¸¸æ•è·ä¸­å¤„ç†UndeclaredThrowableExceptionå³å¯ï¼š
```java
// è§£åŒ… UndeclaredThrowableExceptionï¼ŒAOPç­‰åŠ¨æ€ä»£ç†æ— æ³•è·å–åŸå§‹å¼‚å¸¸
if (e instanceof UndeclaredThrowableException) {
    Throwable cause = e.getCause();
    e = (Exception) cause;
}
```
å…¶å®åœ¨SpringBootä¸­ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªè§£åŒ…æ–¹æ³•ï¼Œç›´æ¥å°†causeä½¿ç”¨getCauseå¼ºåˆ¶æå–å‡ºæ¥ã€‚



### Validatedå¹²ä»€ä¹ˆçš„

`@Validated` æ˜¯ Spring æ¡†æ¶ä¸­çš„ä¸€ä¸ªæ³¨è§£ï¼Œä¸»è¦ç”¨é€”å¦‚ä¸‹ï¼š

#### ä¸»è¦åŠŸèƒ½

1. **å¯ç”¨éªŒè¯åŠŸèƒ½**
   - ç”¨äºç±»æˆ–æ–¹æ³•çº§åˆ«ï¼Œå¯ç”¨ Spring çš„éªŒè¯æœºåˆ¶
   - é…åˆ JSR-303/JSR-380 éªŒè¯æ³¨è§£ï¼ˆå¦‚ `@NotNull`, `@Size`, `@Min` ç­‰ï¼‰ä½¿ç”¨

2. **åˆ†ç»„éªŒè¯**
   - æ”¯æŒéªŒè¯åˆ†ç»„ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒåœºæ™¯åº”ç”¨ä¸åŒçš„éªŒè¯è§„åˆ™
   - é€šè¿‡ `groups` å±æ€§æŒ‡å®šéªŒè¯ç»„

#### ä½¿ç”¨åœºæ™¯

- **Controller å‚æ•°éªŒè¯**ï¼šéªŒè¯ HTTP è¯·æ±‚å‚æ•°
- **Service å±‚éªŒè¯**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘å±‚éªŒè¯æ•°æ®
- **æ–¹æ³•å‚æ•°éªŒè¯**ï¼šéªŒè¯æ–¹æ³•è°ƒç”¨æ—¶çš„å‚æ•°åˆæ³•æ€§

#### ä¸ @Valid çš„åŒºåˆ«

- `@Validated`ï¼šSpring æä¾›çš„æ³¨è§£ï¼Œæ”¯æŒåˆ†ç»„éªŒè¯
- `@Valid`ï¼šJSR-303 æ ‡å‡†æ³¨è§£ï¼Œä¸æ”¯æŒåˆ†ç»„ä½†å…·æœ‰æ›´å¹¿æ³›çš„å…¼å®¹æ€§

é€šå¸¸åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œ`@Validated` æ³¨è§£ä¼šç”¨åœ¨ Controller ç±»ä¸Šï¼Œé…åˆéªŒè¯æ³¨è§£æ¥ç¡®ä¿ä¼ å…¥æ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œå¦‚ä½¿ç”¨`@NotNull`ç­‰ä¿è¯å‚æ•°æ­£ç¡®ã€‚

```java
@RequestMapping("/addOrRemoveGroupUser")
@GlobalInterceptor
public ResponseVO addOrRemoveGroupUser(HttpServletRequest request,
                                       @NotEmpty String groupId,
                                       @NotEmpty String selectContacts,
                                       @NotNull Integer opType) {

    TokenUserInfoDto tokenUserInfoDto = getTokenUserInfo(request);
    groupInfoService.addOrUpdateBatch();

    return getSuccessResponseVO(groupInfoVo);
}
```





### ä¹è§‚é”æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ä»–ï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ





### mysqlæ•°æ®åº“çš„éš”ç¦»æ€ä¹ˆå®ç°çš„ï¼Ÿäº‹åŠ¡éš”ç¦»ï¼ŒMVCCï¼Œé”éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ





### mybatisåŸºç¡€

mybatisplusæ˜¯å¥½ç”¨ï¼Œä½†æ˜¯å¤šè¡¨è”æŸ¥ç­‰å¤æ‚ä¸šåŠ¡çš„æ—¶å€™å°±ä¸å¤Ÿç”¨äº†ï¼Œå­¦ä¸€ä¸‹åŸºç¡€çš„mybatisç»ˆç©¶è¿˜æ˜¯é€ƒä¸è¿‡çš„

[MyBatis 3 | XML æ˜ å°„å™¨ â€“ mybatis](https://mybatis.org/mybatis-3/zh_CN/sqlmap-xml.html)

[MyBatis æ³¨è§£å’ŒProvideræ³¨è§£(åŠ¨æ€æ„å»ºSQL)ä½¿ç”¨_sql sql = new sql();-CSDNåšå®¢](https://blog.csdn.net/qq_42402854/article/details/102588984)ï¼ˆä¸æ¨èï¼Œç»´æŠ¤éº»çƒ¦

å½“ç„¶ä¹Ÿå¯ä»¥ç”¨`@Select`æ³¨è§£ç­‰æ–¹å¼æ¥å®ç°

åŒæ—¶ï¼Œmybatispluså’Œmybatisçš„åŸºç¡€mapperXmlæ˜¯å¯ä»¥å…±ç”¨çš„ï¼ˆä½†ä¸è¦åœ¨xmlé‡Œé¢å»å®ç°ä¸€äº›mybatispluså·²ç»å®ç°çš„åŸºç¡€sqlï¼Œå¯èƒ½ä¼šå¯¼è‡´å†²çª



### ä¸ºä»€ä¹ˆä½¿ç”¨WebSocketå®ç°ä¿¡æ¯é€šä¿¡ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼š**WebSocket å®ç°çš„é€šä¿¡ vs ç›´æ¥ç”¨æ•°æ®åº“è½®è¯¢å®ç°é€šä¿¡**ï¼Œä¸¤è€…åœ¨æ¶æ„ã€æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒä¸Šæœ‰å·¨å¤§å·®å¼‚ã€‚

å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œæ¶ˆæ¯çš„åˆ·æ–°èŠ‚ç‚¹éƒ½æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ

1. åˆšç™»é™†ï¼Œè¿›å…¥å®¢æˆ·ç«¯ï¼Œä»æ•°æ®åº“è·å–
2. å‘å¯¹æ–¹å‘é€æ¶ˆæ¯ï¼Œä¿¡æ¯ç»è¿‡åç«¯å­˜å…¥æ•°æ®åº“ï¼Œä½†æ˜¯åªæ˜¯åŸºäºæ•°æ®åº“æ— æ³•å®ç°æœåŠ¡å™¨å‘å¯¹æ–¹å®¢æˆ·ç«¯çš„é€šçŸ¥ï¼ˆä¸“èŒäºæœåŠ¡å®¢æˆ·ç«¯å‘é€çš„requestï¼Œè€Œæ— æ³•å®ç°å‘å®¢æˆ·ç«¯å‘é€ä¿¡æ¯ï¼‰
3. å¯¹æ–¹å‘é€æ¶ˆæ¯ï¼Œä¿¡æ¯å­˜å…¥æ•°æ®åº“ï¼ŒåŒæ ·æˆ‘æ–¹æ— æ³•åŠæ—¶æ¥æ”¶æ¶ˆæ¯

å¦‚æœéœ€è¦è·å–ä¿¡æ¯ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåªèƒ½é€šè¿‡å®¢æˆ·ç«¯ä¸æ–­å‘é€requestç»™åç«¯ï¼Œè®©åç«¯ä»¥**è½®è¯¢**çš„æ–¹å¼æŸ¥è¯¢æ˜¯å¦æœ‰ä¿¡æ¯éœ€è¦æ¥æ”¶ï¼Œå¯¹äºèŠå¤©è½¯ä»¶æ¥è¯´ï¼Œè¿™ç§ç¨‹åº¦çš„æ¶ˆæ¯å»¶æ—¶æ˜¯ä¸å¯æ¥å—çš„ã€‚

ä¸‹é¢æˆ‘ä»¬ä»å¤šä¸ªç»´åº¦è¿›è¡Œè¯¦ç»†å¯¹æ¯”ï¼š

---

#### âœ… 1. **é€šä¿¡æ¨¡å¼æœ¬è´¨ä¸åŒ**

| æ–¹å¼           | é€šä¿¡æ¨¡å¼         | ç‰¹ç‚¹                                             |
| -------------- | ---------------- | ------------------------------------------------ |
| **WebSocket**  | **åŒå‘å®æ—¶é€šä¿¡** | å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹é•¿è¿æ¥ï¼Œä»»æ„ä¸€æ–¹å¯éšæ—¶æ¨é€æ¶ˆæ¯ |
| **æ•°æ®åº“è½®è¯¢** | **å•å‘æ¨¡æ‹Ÿé€šä¿¡** | å®¢æˆ·ç«¯å®šæ—¶æŸ¥æ•°æ®åº“ï¼Œçœ‹æœ‰æ²¡æœ‰æ–°æ¶ˆæ¯ï¼ˆâ€œæ‹‰â€æ¨¡å¼ï¼‰   |

> ğŸ”¹ WebSocketï¼šåƒæ‰“ç”µè¯ â€”â€” åŒæ–¹å¯éšæ—¶è¯´è¯ã€‚  
> ğŸ”¹ æ•°æ®åº“è½®è¯¢ï¼šåƒæŸ¥é‚®ç®± â€”â€” ä½ æ¯éš”5åˆ†é’Ÿçœ‹ä¸€æ¬¡æœ‰æ²¡æœ‰æ–°é‚®ä»¶ã€‚

---

#### âœ… 2. **å®æ—¶æ€§å¯¹æ¯”**

| æŒ‡æ ‡             | WebSocket                  | æ•°æ®åº“è½®è¯¢                    |
| ---------------- | -------------------------- | ----------------------------- |
| å»¶è¿Ÿ             | â­ æä½ï¼ˆæ¯«ç§’çº§ï¼‰           | âš ï¸ é«˜ï¼ˆå–å†³äºè½®è¯¢é—´éš”ï¼Œå¦‚ 5sï¼‰ |
| æ˜¯å¦èƒ½â€œä¸»åŠ¨æ¨é€â€ | âœ… æ˜¯ï¼ˆæœåŠ¡ç«¯å¯ç›´æ¥å‘æ¶ˆæ¯ï¼‰ | âŒ å¦ï¼ˆåªèƒ½ç­‰å®¢æˆ·ç«¯æ¥æŸ¥ï¼‰      |

> ä¸¾ä¾‹ï¼šç”¨æˆ·Aå‘æ¶ˆæ¯ç»™Bï¼ŒBæ˜¯å¦ç«‹åˆ»çœ‹åˆ°ï¼Ÿ
- WebSocketï¼šâœ… ç«‹åˆ»æ”¶åˆ°æ¨é€ï¼Œå®æ—¶æ˜¾ç¤ºã€‚
- è½®è¯¢ï¼šâŒ è¦ç­‰ä¸‹ä¸€æ¬¡æŸ¥è¯¢ï¼ˆå¯èƒ½å»¶è¿Ÿå‡ ç§’ï¼‰ã€‚

---

#### âœ… 3. **æ€§èƒ½ä¸èµ„æºæ¶ˆè€—**

| æŒ‡æ ‡         | WebSocket                  | æ•°æ®åº“è½®è¯¢                    |
| ------------ | -------------------------- | ----------------------------- |
| å¹¶å‘è¿æ¥å‹åŠ› | ä¸­ç­‰ï¼ˆä¿æŒé•¿è¿æ¥ï¼‰         | ä½ï¼ˆä½†é¢‘ç¹çŸ­è¿æ¥ï¼‰            |
| æ•°æ®åº“å‹åŠ›   | âŒ ä½ï¼ˆåªåœ¨ä¸šåŠ¡éœ€è¦æ—¶è¯»å†™ï¼‰ | âš ï¸ é«˜ï¼ˆå¤§é‡ SELECT æŸ¥è¯¢ï¼‰      |
| ç½‘ç»œå¼€é”€     | âœ… å°‘é‡å¿ƒè·³åŒ…               | âŒ é¢‘ç¹ HTTP è¯·æ±‚ + æ•°æ®åº“æŸ¥è¯¢ |

> ä¸¾ä¸ªä¾‹å­ï¼š
- 1000 ä¸ªç”¨æˆ·æ¯ 2 ç§’è½®è¯¢ä¸€æ¬¡ â†’ æ¯åˆ†é’Ÿ 30,000 æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼
- WebSocketï¼š1000 ä¸ªè¿æ¥ï¼Œåªæœ‰æ¶ˆæ¯æ¥æ—¶æ‰è§¦å‘ä¸€æ¬¡å†™æ“ä½œã€‚

---

#### âœ… 4. **æ‰©å±•æ€§ä¸ç»´æŠ¤æ€§**

| æŒ‡æ ‡               | WebSocket                    | æ•°æ®åº“è½®è¯¢                 |
| ------------------ | ---------------------------- | -------------------------- |
| æ”¯æŒç¾¤èŠã€å¹¿æ’­     | âœ… å®¹æ˜“å®ç°ï¼ˆ`ChannelGroup`ï¼‰ | âŒ å¤æ‚ï¼ˆéœ€æŸ¥æ‰€æœ‰ç”¨æˆ·çŠ¶æ€ï¼‰ |
| ç”¨æˆ·åœ¨çº¿çŠ¶æ€ç®¡ç†   | âœ… å¤©ç„¶æ”¯æŒï¼ˆè¿æ¥å³åœ¨çº¿ï¼‰     | âŒ éœ€é¢å¤–å­—æ®µæ ‡è®°           |
| æ¶ˆæ¯ç¡®è®¤ã€é‡å‘æœºåˆ¶ | âœ… å¯è‡ªå®šä¹‰åè®®å®ç°           | âŒ éš¾ä»¥ä¿è¯ä¸€è‡´æ€§           |

---

#### âœ… 5. **é€‚ç”¨åœºæ™¯å¯¹æ¯”**

| åœºæ™¯                   | æ¨èæ–¹å¼      | åŸå›                      |
| ---------------------- | ------------- | ------------------------ |
| èŠå¤©å®¤ã€IMã€å®¢æœç³»ç»Ÿ   | âœ… WebSocket   | å¿…é¡»å®æ—¶ï¼Œä¸èƒ½æœ‰å»¶è¿Ÿ     |
| å®æ—¶é€šçŸ¥ï¼ˆå¦‚è®¢å•çŠ¶æ€ï¼‰ | âœ… WebSocket   | ç”¨æˆ·æœŸæœ›â€œç«‹åˆ»çŸ¥é“â€       |
| åœ¨çº¿åä½œï¼ˆæ–‡æ¡£ç¼–è¾‘ï¼‰   | âœ… WebSocket   | å¤šäººååŒï¼Œé«˜é¢‘æ›´æ–°       |
| åå°ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢       | âš ï¸ å¯ç”¨è½®è¯¢    | æ›´æ–°é¢‘ç‡ä½ï¼Œç®€å•å®ç°å³å¯ |
| æ–°é—»èµ„è®¯æ›´æ–°           | âš ï¸ è½®è¯¢ + ç¼“å­˜ | éå¼ºå®æ—¶ï¼Œæˆæœ¬æ•æ„Ÿ       |

---

#### âœ… 6. **ä¸¾ä¸ªçœŸå®ä¾‹å­ï¼šèŠå¤©åŠŸèƒ½**

##### âŒ ç”¨æ•°æ®åº“è½®è¯¢å®ç°ï¼š
- å®¢æˆ·ç«¯æ¯ 2 ç§’æ‰§è¡Œï¼š
  ```sql
  SELECT * FROM messages WHERE to_user = ? AND create_time > ?
  ```
- é—®é¢˜ï¼š
  - æµªè´¹èµ„æºï¼ˆ90% æŸ¥è¯¢æ— æ–°æ¶ˆæ¯ï¼‰
  - å»¶è¿Ÿé«˜ï¼ˆæœ€å¤šç­‰ 2 ç§’ï¼‰
  - æ•°æ®åº“å‹åŠ›å¤§

##### âœ… ç”¨ WebSocket å®ç°ï¼š
- ç”¨æˆ·ä¸Šçº¿ â†’ å»ºç«‹è¿æ¥ï¼ŒåŠ å…¥ `ChannelGroup`
- ç”¨æˆ·Aå‘æ¶ˆæ¯ â†’ æœåŠ¡ç«¯ç›´æ¥è°ƒç”¨ï¼š
  ```java
  channelGroup.writeAndFlush(new TextWebSocketFrame("æ–°æ¶ˆæ¯..."));
  ```
- ç”¨æˆ·B **ç«‹åˆ»** æ”¶åˆ°ï¼Œæ— éœ€æŸ¥è¯¢æ•°æ®åº“

---

#### âœ… æ€»ç»“ï¼šWebSocket çš„æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿               | è¯´æ˜                           |
| ------------------ | ------------------------------ |
| ğŸš€ **å®æ—¶æ€§é«˜**     | æ¶ˆæ¯ç§’è¾¾ï¼Œæ— å»¶è¿Ÿ               |
| ğŸ’¡ **èŠ‚çœèµ„æº**     | å‡å°‘æ— æ•ˆæ•°æ®åº“æŸ¥è¯¢å’Œ HTTP è¯·æ±‚ |
| ğŸ“¡ **æ”¯æŒä¸»åŠ¨æ¨é€** | æœåŠ¡ç«¯å¯éšæ—¶é€šçŸ¥å®¢æˆ·ç«¯         |
| ğŸ§© **é€‚åˆå¤æ‚äº¤äº’** | æ”¯æŒèŠå¤©ã€å¿ƒè·³ã€çŠ¶æ€åŒæ­¥ç­‰     |
| ğŸ“ˆ **å¯æ‰©å±•æ€§å¼º**   | æ˜“å®ç°å¹¿æ’­ã€ç¾¤ç»„ã€åœ¨çº¿çŠ¶æ€ç­‰   |

---

#### â—ï¸ æ³¨æ„ï¼šWebSocket ä¸æ˜¯ä¸‡èƒ½çš„

| ç¼ºç‚¹           | è¯´æ˜                                   |
| -------------- | -------------------------------------- |
| è¿æ¥ç®¡ç†å¤æ‚   | éœ€å¤„ç†æ–­çº¿é‡è¿ã€å¿ƒè·³ã€é›†ç¾¤ç­‰é—®é¢˜       |
| å ç”¨å†…å­˜       | æ¯ä¸ªè¿æ¥å ç”¨ä¸€å®šå†…å­˜ï¼ˆä¸é€‚åˆè¶…å¤§è§„æ¨¡ï¼‰ |
| ä¸æ”¯æŒæ‰€æœ‰ç¯å¢ƒ | æŸäº›è€æ—§æµè§ˆå™¨æˆ–ç½‘ç»œä»£ç†å¯èƒ½ä¸æ”¯æŒ     |

---

#### âœ… ç»“è®º

> **å¦‚æœä½ è¦åšçš„æ˜¯â€œå®æ—¶é€šä¿¡â€ç±»åŠŸèƒ½ï¼ˆå¦‚èŠå¤©ã€é€šçŸ¥ã€åä½œï¼‰ï¼Œä¸€å®šè¦ç”¨ WebSocketã€‚**  
> **å¦‚æœåªæ˜¯å¶å°”æŸ¥ä¸ªçŠ¶æ€ï¼Œä¸”å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥ç”¨æ•°æ®åº“è½®è¯¢ + ç¼“å­˜ã€‚**

---



### å¤šæœºéƒ¨ç½²ï¼ˆé›†ç¾¤ç¯å¢ƒï¼‰ä¸‹ï¼Œå¦‚ä½•å®ç°ç”¨æˆ·è·¨æœåŠ¡å™¨é€šä¿¡ï¼Ÿ

åœ¨æˆ‘ä»¬å­¦ä¹ äº†mysqlï¼Œredisä¹‹åï¼Œæ¥ä¸‹æ¥è¦å­¦çš„ä¸­é—´ä»¶å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—MQäº†ã€‚éƒ½çŸ¥é“mqå¯ä»¥ç”¨æ¥è°ƒå–





### SpringBootå’Œnettyå¯¹ä¸çº¿ç¨‹çš„ç®¡ç†

| **Spring Boot å¤„ç† request æ˜¯ä¸€ä¸ªçº¿ç¨‹å—ï¼Ÿ** | âœ… æ˜¯ï¼Œ**é»˜è®¤ä¸€ä¸ªè¯·æ±‚ç”±ä¸€ä¸ªçº¿ç¨‹åŒæ­¥å¤„ç†**ï¼Œç›´åˆ°è¿”å›å“åº”ã€‚çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ |
| ------------------------------------------- | ------------------------------------------------------------ |
| **Netty æ¯ä¸ªç”¨æˆ·è¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å—ï¼Ÿ**    | âŒ **ä¸æ˜¯ï¼** Netty ä½¿ç”¨å°‘é‡çº¿ç¨‹ï¼ˆEventLoopï¼‰é€šè¿‡äº‹ä»¶é©±åŠ¨å¤„ç†æˆåƒä¸Šä¸‡è¿æ¥ï¼Œ**ä¸€ä¸ªçº¿ç¨‹æœåŠ¡å¤šä¸ªè¿æ¥**ã€‚ |

---

#### âœ… ä¸€ã€Spring Boot æ˜¯æ€ä¹ˆç®¡ç†çº¿ç¨‹çš„ï¼Ÿ  
> **å¤„ç†ä¸€ä¸ª request ä¼šç”¨ä¸€ä¸ªçº¿ç¨‹å—ï¼Ÿè¿”å› response ä¹Ÿæ˜¯åŒä¸€ä¸ªçº¿ç¨‹å—ï¼Ÿ**

##### 1. é»˜è®¤æƒ…å†µï¼š**æ˜¯çš„ï¼Œä¸€ä¸ªè¯·æ±‚ç”±ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼ˆåŒæ­¥é˜»å¡ï¼‰**

Spring Bootï¼ˆåŸºäº Tomcatã€Jetty æˆ– Undertowï¼‰é»˜è®¤ä½¿ç”¨ **çº¿ç¨‹æ±  + é˜»å¡ I/O** æ¨¡å‹ã€‚

###### ğŸ“Œ å·¥ä½œæµç¨‹ï¼š

```text
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Web æœåŠ¡å™¨ï¼ˆå¦‚ Tomcatï¼‰â†’ ä»çº¿ç¨‹æ± ä¸­åˆ†é…ä¸€ä¸ªçº¿ç¨‹ â†’ å¤„ç†æ•´ä¸ªè¯·æ±‚ï¼ˆController â†’ Service â†’ DBï¼‰â†’ è¿”å›å“åº” â†’ çº¿ç¨‹å½’è¿˜çº¿ç¨‹æ± 
```

- âœ… **åŒä¸€ä¸ªçº¿ç¨‹** è´Ÿè´£ï¼š
  - æ¥æ”¶è¯·æ±‚
  - æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  - è¿”å›å“åº”
- âŒ è¿™ä¸ªçº¿ç¨‹åœ¨å¤„ç†æœŸé—´**è¢«é˜»å¡**ï¼Œä¸èƒ½å¹²åˆ«çš„äº‹ï¼ˆæ¯”å¦‚ç­‰æ•°æ®åº“æŸ¥è¯¢ã€è°ƒå¤–éƒ¨ APIï¼‰

###### ğŸŒ° ä¸¾ä¾‹ï¼š

```java
@GetMapping("/user")
public User getUser() {
    Thread.sleep(3000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    return userService.findById(1);
}
```

- è¿™ä¸ªè¯·æ±‚ä¼š**å ç”¨ä¸€ä¸ªçº¿ç¨‹æ•´æ•´ 3 ç§’**ï¼ŒæœŸé—´è¯¥çº¿ç¨‹ä¸èƒ½å¤„ç†å…¶ä»–è¯·æ±‚ã€‚

---

##### 2. é—®é¢˜ï¼šå¦‚æœå¹¶å‘é«˜ï¼Œçº¿ç¨‹ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ

- Tomcat é»˜è®¤çº¿ç¨‹æ± å¤§å°æ˜¯ **200**
- å¦‚æœæœ‰ 300 ä¸ªå¹¶å‘è¯·æ±‚ï¼Œç¬¬ 201~300 ä¸ªè¯·æ±‚ä¼šè¢«**æ’é˜Ÿæˆ–æ‹’ç»**

ğŸ‘‰ è¿™å°±æ˜¯ä¼ ç»Ÿ Web æ¡†æ¶çš„ç“¶é¢ˆï¼š**çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æº**

---

##### 3. Spring Boot å¦‚ä½•æ”¯æŒå¼‚æ­¥ï¼Ÿâ€”â€” `@Async` å’Œ WebFlux

###### âœ… æ–¹å¼ä¸€ï¼š`@Async`ï¼ˆå¼‚æ­¥æ–¹æ³•ï¼‰

```java
@Async
public CompletableFuture<User> asyncFindUser() {
    // åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œ
    return CompletableFuture.completedFuture(userService.findById(1));
}
```

- è¯·æ±‚è¿›æ¥åï¼Œä¸»çº¿ç¨‹ä¸é˜»å¡ï¼Œæäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œç«‹å³è¿”å› `CompletableFuture`
- é€‚åˆâ€œåå°ä»»åŠ¡â€ï¼Œä½†ä¸æ˜¯çœŸæ­£çš„éé˜»å¡ I/O

###### âœ… æ–¹å¼äºŒï¼š**Spring WebFluxï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰**

```java
@GetMapping("/user")
public Mono<User> getUser() {
    return userService.findUserById(1); // è¿”å› Monoï¼Œå¼‚æ­¥éé˜»å¡
}
```

- åŸºäº **Netty** æˆ– **Servlet 3.1+ éé˜»å¡ I/O**
- ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†**æˆåƒä¸Šä¸‡ä¸ªè¯·æ±‚**ï¼ˆé€šè¿‡äº‹ä»¶é©±åŠ¨ï¼‰

---

#### âœ… äºŒã€Netty æ˜¯æ€ä¹ˆç®¡ç†çº¿ç¨‹çš„ï¼Ÿ  
> **æ¯ä¸ªç”¨æˆ·è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å—ï¼Ÿ**

##### âŒ ä¸æ˜¯ï¼Netty ä½¿ç”¨ **äº‹ä»¶å¾ªç¯ï¼ˆEventLoopï¼‰æ¨¡å‹**ï¼Œ**æå°‘çº¿ç¨‹å¤„ç†å¤§é‡è¿æ¥**

###### 1. æ ¸å¿ƒæ¦‚å¿µï¼š`EventLoopGroup`

Netty æœ‰ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼š

| çº¿ç¨‹ç»„        | ä½œç”¨                        | çº¿ç¨‹æ•°                         |
| ------------- | --------------------------- | ------------------------------ |
| `bossGroup`   | æ¥å—æ–°è¿æ¥ï¼ˆacceptï¼‰        | é€šå¸¸ 1 ä¸ªçº¿ç¨‹                  |
| `workerGroup` | å¤„ç†å·²å»ºç«‹è¿æ¥çš„è¯»å†™ï¼ˆI/Oï¼‰ | é€šå¸¸æ˜¯ CPU æ ¸æ•° Ã— 2ï¼ˆå¦‚ 8 ä¸ªï¼‰ |

```java
EventLoopGroup boss = new NioEventLoopGroup(1);
EventLoopGroup worker = new NioEventLoopGroup(); // é»˜è®¤çº¿ç¨‹æ•° = 2 * CPUæ ¸å¿ƒæ•°
```

---

###### 2. æ¯ä¸ªè¿æ¥ï¼ˆChannelï¼‰ç»‘å®šåˆ°ä¸€ä¸ªå›ºå®šçš„ `EventLoop`

- å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥ï¼ŒNetty ä¼šä» `workerGroup` ä¸­**é€‰æ‹©ä¸€ä¸ª EventLoop**ï¼Œå¹¶**æ°¸ä¹…ç»‘å®š**
- è¿™ä¸ªè¿æ¥çš„**æ‰€æœ‰ I/O æ“ä½œ**ï¼ˆè¯»ã€å†™ã€å…³é—­ï¼‰éƒ½ç”±**åŒä¸€ä¸ªçº¿ç¨‹**å¤„ç†
- ä½†ä¸€ä¸ª `EventLoop` çº¿ç¨‹å¯ä»¥å¤„ç†**æˆåƒä¸Šä¸‡ä¸ªè¿æ¥**

> ğŸ”¹ ç±»æ¯”ï¼šä¸€ä¸ªå®¢æœï¼ˆçº¿ç¨‹ï¼‰å¯ä»¥æœåŠ¡å¤šä¸ªå®¢æˆ·ï¼ˆè¿æ¥ï¼‰ï¼Œé€šè¿‡â€œäº‹ä»¶è½®è¯¢â€å¤„ç†æ¯ä¸ªå®¢æˆ·çš„è¯·æ±‚

---

###### 3. äº‹ä»¶é©±åŠ¨ + éé˜»å¡ I/O

```text
EventLoop çº¿ç¨‹ï¼š
  while (true) {
    1. æ£€æŸ¥å“ªäº› Channel æœ‰äº‹ä»¶ï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰
    2. å¤„ç†è¿™äº›äº‹ä»¶ï¼ˆè°ƒç”¨ä½ çš„ ChannelHandlerï¼‰
  }
```

- æ²¡æœ‰ I/O æ—¶ï¼Œçº¿ç¨‹ä¸é˜»å¡ï¼Œå»å¤„ç†å…¶ä»–å°±ç»ªçš„ Channel
- æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œè§¦å‘ `channelRead()` æ–¹æ³•
- æ‰€ä»¥ï¼š**1 ä¸ªçº¿ç¨‹ = æ•°åƒè¿æ¥**

---

##### 4. ç¤ºä¾‹ï¼š10,000 ä¸ª WebSocket è¿æ¥

| æ¨¡å‹                 | æ‰€éœ€çº¿ç¨‹æ•°                  | å†…å­˜å ç”¨    | å¹¶å‘èƒ½åŠ› |
| -------------------- | --------------------------- | ----------- | -------- |
| Spring Boot + Tomcat | ~10,000ï¼ˆæ¯ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼‰ | æé«˜ï¼ˆOOMï¼‰ | å·®       |
| Netty                | 8 ä¸ª `EventLoop` çº¿ç¨‹       | å¾ˆä½        | æå¼º     |

ğŸ‘‰ Netty å¯ä»¥ç”¨ **8 ä¸ªçº¿ç¨‹** è½»æ¾æ”¯æŒ **10 ä¸‡+ é•¿è¿æ¥**

---

#### âœ… ä¸‰ã€å¯¹æ¯”æ€»ç»“ï¼šSpring Boot vs Netty

| ç‰¹æ€§                      | Spring Bootï¼ˆTomcatï¼‰  | Netty                                     |
| ------------------------- | ---------------------- | ----------------------------------------- |
| çº¿ç¨‹æ¨¡å‹                  | **çº¿ç¨‹æ±  + é˜»å¡ I/O**  | **äº‹ä»¶å¾ªç¯ + éé˜»å¡ I/O**                 |
| æ¯ä¸ªè¯·æ±‚/è¿æ¥æ˜¯å¦å ç”¨çº¿ç¨‹ | âœ… æ˜¯ï¼ˆç›´åˆ°å®Œæˆï¼‰       | âŒ å¦ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰                          |
| å¹¶å‘èƒ½åŠ›                  | ä¸­ç­‰ï¼ˆå—é™äºçº¿ç¨‹æ•°ï¼‰   | æé«˜ï¼ˆC10K é—®é¢˜è§£å†³æ–¹æ¡ˆï¼‰                 |
| é€‚åˆåœºæ™¯                  | æ™®é€š Web APIã€åå°æœåŠ¡ | é«˜å¹¶å‘ã€é•¿è¿æ¥ã€å®æ—¶é€šä¿¡ï¼ˆWebSocketã€IMï¼‰ |
| ç¼–ç¨‹æ¨¡å‹                  | åŒæ­¥ä¸ºä¸»               | å¼‚æ­¥ã€å›è°ƒã€Promiseï¼ˆFutureï¼‰             |
| é»˜è®¤çº¿ç¨‹æ•°                | Tomcat é»˜è®¤ 200        | Netty é»˜è®¤ 8ï¼ˆ2Ã—CPUæ ¸æ•°ï¼‰                 |

---

#### âœ… å››ã€Spring Boot + Nettyï¼Ÿå¯ä»¥ï¼

Spring Boot ä¹Ÿå¯ä»¥é›†æˆ Nettyï¼š

- **Spring WebFlux** é»˜è®¤ä½¿ç”¨ **Netty** ä½œä¸ºæœåŠ¡å™¨ï¼ˆReactive æ¨¡å¼ï¼‰
- WebSocket æœåŠ¡å¯ä»¥ç”¨ Netty å®ç°
- gRPCã€TCP æœåŠ¡å¸¸ç”¨ Netty æ„å»º

```yaml
# ä½¿ç”¨ Netty ä½œä¸º WebFlux æœåŠ¡å™¨
dependencies:
  - spring-boot-starter-webflux
```

æ­¤æ—¶å°±æ˜¯ï¼š**Spring Boot çš„ä¾¿åˆ© + Netty çš„é«˜æ€§èƒ½**

ğŸ“Œ **ä¸€å¥è¯æ€»ç»“**ï¼š

> - **Spring Bootï¼ˆTomcatï¼‰**ï¼šä¸€ä¸ªè¯·æ±‚ â†’ ä¸€ä¸ªçº¿ç¨‹ï¼ˆé˜»å¡ï¼‰  
> - **Netty**ï¼šä¸€ä¸ªçº¿ç¨‹ â†’ å¤„ç†ä¸Šä¸‡ä¸ªè¿æ¥ï¼ˆéé˜»å¡ + äº‹ä»¶é©±åŠ¨ï¼‰



### Sessionæ•°æ®åº“ç¼“å­˜ç»“æ„ï¼Ÿæ€ä¹ˆå®ç°ç¼“å­˜ç”¨æˆ·æ¶ˆæ¯çš„ï¼Ÿ



### ä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯Sessionè®°å½•è¡¨ï¼Ÿ



### **Redis çš„ Hash æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ**

Redis çš„ `Hash` æ•°æ®ç±»å‹åœ¨åº•å±‚å¹¶ä¸æ˜¯ç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªâ€œHashMapâ€æ¥å®ç°ï¼Œè€Œæ˜¯æ ¹æ®æ•°æ®çš„å¤§å°å’Œç»“æ„ï¼Œ**åŠ¨æ€é€‰æ‹©ä¸¤ç§ä¸åŒçš„ç¼–ç æ–¹å¼ï¼ˆåº•å±‚å®ç°ï¼‰**ï¼Œä»¥è¾¾åˆ°**å†…å­˜æ•ˆç‡å’Œæ€§èƒ½çš„å¹³è¡¡**ã€‚

---

#### âœ… ä¸€ã€Redis Hash çš„ä¸¤ç§åº•å±‚å®ç°

| ç¼–ç æ–¹å¼              | è¯´æ˜               | é€‚ç”¨åœºæ™¯             |
| --------------------- | ------------------ | -------------------- |
| `ziplist`ï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ | å†…å­˜ç´§å‡‘ï¼ŒèŠ‚çœç©ºé—´ | å°æ•°æ®é‡æ—¶           |
| `hashtable`ï¼ˆå“ˆå¸Œè¡¨ï¼‰ | æŸ¥æ‰¾å¿«ï¼Œæ”¯æŒå¤§æ•°æ® | æ•°æ®é‡å¤§æˆ–é”®å€¼è¾ƒé•¿æ—¶ |

Redis ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨åœ¨è¿™ä¸¤ç§ç¼–ç ä¹‹é—´è½¬æ¢ã€‚

---

#### âœ… äºŒã€1. `ziplist`ï¼šå‹ç¼©åˆ—è¡¨ï¼ˆå†…å­˜å‹å¥½ï¼‰

##### ğŸ“Œ ä»€ä¹ˆæ˜¯ ziplistï¼Ÿ
- `ziplist` æ˜¯ Redis è‡ªå®šä¹‰çš„ä¸€ç§**ç´§å‡‘çš„ã€è¿ç»­å†…å­˜å­˜å‚¨ç»“æ„**ã€‚
- å®ƒä¸æ˜¯çœŸæ­£çš„â€œå“ˆå¸Œè¡¨â€ï¼Œè€Œæ˜¯ä¸€ä¸ª**åŒå‘é“¾è¡¨çš„çº¿æ€§ç»“æ„**ï¼ŒæŒ‰é¡ºåºå­˜å‚¨ `field` å’Œ `value`ã€‚

##### ğŸ§± å­˜å‚¨ç»“æ„ï¼ˆé€»è¾‘ä¸Šï¼‰ï¼š
```
[field1][value1][field2][value2][field3][value3]
```
- æ‰€æœ‰å…ƒç´ æŒ‰ `field` â†’ `value` æˆå¯¹æ’åˆ—
- å­˜å‚¨åœ¨ä¸€å—è¿ç»­çš„å†…å­˜ä¸­

##### âœ… ä¼˜ç‚¹ï¼š
- **å†…å­˜å ç”¨æå°**ï¼šæ²¡æœ‰æŒ‡é’ˆå¼€é”€ï¼Œé€‚åˆå°æ•°æ®
- **ç¼“å­˜å‹å¥½**ï¼šCPU ç¼“å­˜å‘½ä¸­ç‡é«˜

##### âŒ ç¼ºç‚¹ï¼š
- **æŸ¥æ‰¾æ˜¯ O(n)**ï¼šéœ€è¦éå†æ•´ä¸ªåˆ—è¡¨
- **æ’å…¥/åˆ é™¤æ…¢**ï¼šæ¶‰åŠå†…å­˜ç§»åŠ¨
- **ä¸é€‚åˆå¤§æ•°æ®**

##### ğŸ”§ è§¦å‘æ¡ä»¶ï¼ˆé»˜è®¤ï¼‰ï¼š
å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼ŒRedis ä½¿ç”¨ `ziplist` ç¼–ç ï¼š
```conf
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
```
- å­—æ®µæ•°é‡ â‰¤ 512
- æ¯ä¸ª `field` å’Œ `value` çš„é•¿åº¦ â‰¤ 64 å­—èŠ‚

> âš ï¸ è¶…å‡ºä»»ä¸€æ¡ä»¶ï¼ŒRedis ä¼šè‡ªåŠ¨å°† `ziplist` å‡çº§ä¸º `hashtable`

---

#### âœ… ä¸‰ã€2. `hashtable`ï¼šçœŸæ­£çš„å“ˆå¸Œè¡¨ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰

##### ğŸ“Œ ä»€ä¹ˆæ˜¯ `hashtable`ï¼Ÿ
- ä½¿ç”¨ **å­—å…¸ï¼ˆdictï¼‰** å®ç°ï¼Œç±»ä¼¼äº Java çš„ `HashMap`
- å†…éƒ¨ç»“æ„ï¼šæ•°ç»„ + é“¾è¡¨ï¼ˆæˆ–çº¢é»‘æ ‘ï¼Œä½† Redis æ²¡ç”¨çº¢é»‘æ ‘ï¼‰
- æ”¯æŒ O(1) å¹³å‡æ—¶é—´å¤æ‚åº¦çš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤

##### ğŸ§± å­˜å‚¨ç»“æ„ï¼š
```c
typedef struct dict {
    dictEntry *table;        // å“ˆå¸Œè¡¨æ•°ç»„
    int size;                // è¡¨å¤§å°
    int used;                // å·²ç”¨æ¡ç›®æ•°
    ...
} dict;

typedef struct dictEntry {
    void *key;               // field
    void *val;               // value
    struct dictEntry *next;  // è§£å†³å“ˆå¸Œå†²çªï¼ˆé“¾åœ°å€æ³•ï¼‰
} dictEntry;
```

##### âœ… ä¼˜ç‚¹ï¼š
- **æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ O(1)**ï¼ˆå¹³å‡ï¼‰
- æ”¯æŒä»»æ„å¤§å°çš„æ•°æ®
- æ‰©å±•æ€§å¼º

##### âŒ ç¼ºç‚¹ï¼š
- **å†…å­˜å¼€é”€å¤§**ï¼šæ¯ä¸ª `dictEntry` æœ‰æŒ‡é’ˆå¼€é”€
- **å¯èƒ½è§¦å‘ rehash**ï¼ˆæ¸è¿›å¼ rehashï¼‰

---

#### âœ… å››ã€Redis Hash çš„æ“ä½œæ—¶é—´å¤æ‚åº¦

| å‘½ä»¤                   | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜                                                 |
| ---------------------- | ---------- | ---------------------------------------------------- |
| `HSET key field value` | O(1)       | å°æ•°æ®æ˜¯ O(n)ï¼ˆziplistï¼‰ï¼Œå¤§æ•°æ®æ˜¯ O(1)ï¼ˆhashtableï¼‰ |
| `HGET key field`       | O(1)       | åŒä¸Š                                                 |
| `HDEL key field`       | O(N)       | N æ˜¯åˆ é™¤çš„å­—æ®µæ•°                                     |
| `HGETALL key`          | O(n)       | n æ˜¯ hash ä¸­çš„å­—æ®µæ€»æ•°                               |
| `HEXISTS key field`    | O(1)       |                                                      |
| `HLEN key`             | O(1)       |                                                      |

> âš ï¸ æ³¨æ„ï¼šè™½ç„¶ `HSET`/`HGET` æ ‡ç§° O(1)ï¼Œä½†åœ¨ `ziplist` ä¸‹æ˜¯ O(n)ï¼Œæ‰€ä»¥åªé€‚åˆå°æ•°æ®ã€‚

---

#### âœ… äº”ã€ç¼–ç è½¬æ¢ç¤ºä¾‹

```bash
# 1. åˆ›å»ºä¸€ä¸ªå° hashï¼ˆä½¿ç”¨ ziplistï¼‰
HSET user:1001 name "Alice"
HSET user:1001 age "25"

# æŸ¥çœ‹ç¼–ç 
OBJECT ENCODING user:1001
# è¾“å‡º: "ziplist"

# 2. æ·»åŠ å¤§é‡å­—æ®µï¼Œè§¦å‘å‡çº§
# ï¼ˆå‡è®¾è¶…è¿‡ hash-max-ziplist-entries=512ï¼‰
# æ·»åŠ ç¬¬ 513 ä¸ªå­—æ®µ...

# å†æ¬¡æŸ¥çœ‹
OBJECT ENCODING user:1001
# è¾“å‡º: "hashtable"
```

> ğŸ” ä¸€æ—¦ä» `ziplist` å‡çº§åˆ° `hashtable`ï¼Œ**å°±ä¸ä¼šå†é™çº§å›å»**ã€‚

---

#### âœ… å…­ã€ä¸ºä»€ä¹ˆ Redis è¦è¿™æ ·è®¾è®¡ï¼Ÿ

| ç›®æ ‡             | å®ç°æ–¹å¼                       |
| ---------------- | ------------------------------ |
| **å°æ•°æ®çœå†…å­˜** | ç”¨ `ziplist`ï¼Œé¿å…æŒ‡é’ˆå¼€é”€     |
| **å¤§æ•°æ®é«˜æ€§èƒ½** | ç”¨ `hashtable`ï¼Œä¿è¯ O(1) æ“ä½œ |
| **è‡ªåŠ¨é€‚åº”**     | æ ¹æ®æ•°æ®é‡åŠ¨æ€åˆ‡æ¢ç¼–ç          |

> ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯ï¼š
> - ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼š`HSET user:1001 name "Tom" age "20"`
> - å•†å“å±æ€§ï¼š`HSET product:100 price "99.9" stock "100"`

---

#### âœ… ä¸ƒã€å¦‚ä½•æŸ¥çœ‹å’Œä¼˜åŒ–ï¼Ÿ

##### 1. æŸ¥çœ‹å½“å‰ hash çš„ç¼–ç ï¼š
```bash
OBJECT ENCODING <key>
```

##### 2. è°ƒæ•´é…ç½®ï¼ˆ`redis.conf`ï¼‰ï¼š
```conf
hash-max-ziplist-entries 512   # æœ€å¤§å­—æ®µæ•°
hash-max-ziplist-value 64      # æ¯ä¸ª field/value æœ€å¤§å­—èŠ‚
```

> âš ï¸ å»ºè®®ä¸è¦ç›²ç›®è°ƒå¤§ï¼Œå¦åˆ™ `ziplist` ä¼šå¤±å»å†…å­˜ä¼˜åŠ¿ã€‚

---

#### âœ… æ€»ç»“

| ç‰¹æ€§     | `ziplist`             | `hashtable` |
| -------- | --------------------- | ----------- |
| å­˜å‚¨æ–¹å¼ | è¿ç»­å†…å­˜              | æ•°ç»„ + é“¾è¡¨ |
| æŸ¥æ‰¾æ€§èƒ½ | O(n)                  | O(1)        |
| å†…å­˜å ç”¨ | å°                    | å¤§          |
| é€‚ç”¨åœºæ™¯ | å° hashï¼ˆ< 512 å­—æ®µï¼‰ | å¤§ hash     |
| æ˜¯å¦å¯é€† | å‡çº§åä¸å¯é™çº§        | â€”           |



### å¤šä¸ªæ•°æ®åº“çš„é›†ç¾¤éƒ¨ç½²è¯¥å¦‚ä½•è®¾è®¡ä»¥è§£å†³æ•°æ®åº“ä¹‹é—´æ¶ˆæ¯é€šä¿¡çš„é—®é¢˜ï¼Ÿrediså‘¢ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ä¸”å®é™…çš„é—®é¢˜ï¼Œæ¶‰åŠåˆ° **æ•°æ®åº“é«˜å¯ç”¨ã€æ‰©å±•æ€§ä¸åˆ†å¸ƒå¼æ¶æ„è®¾è®¡ä»¥åŠredisæ¶ˆæ¯ä¸€è‡´æ€§**ã€‚

---

#### âœ… ä¸€ã€ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šéƒ¨ç½²å¤šä¸ª MySQL å—ï¼Ÿ

##### **ç­”æ¡ˆæ˜¯ï¼šä¼šçš„ï¼ä½†ä¸æ˜¯â€œéšæ„â€éƒ¨ç½²å¤šä¸ªï¼Œè€Œæ˜¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œåˆç†çš„æ¶æ„è®¾è®¡ã€‚**

##### ğŸ“Œ å¸¸è§åœºæ™¯ä¸‹ä¼šä½¿ç”¨å¤šä¸ª MySQL å®ä¾‹ï¼š

| åœºæ™¯                       | æ˜¯å¦éœ€è¦å¤šå®ä¾‹ | è¯´æ˜                             |
| -------------------------- | -------------- | -------------------------------- |
| å•æœºå°é¡¹ç›®ï¼ˆå¦‚ä¸ªäººåšå®¢ï¼‰   | âŒ ä¸éœ€è¦       | ä¸€ä¸ªä¸»åº“å°±å¤Ÿäº†                   |
| ä¸­å¤§å‹åº”ç”¨ï¼ˆå¦‚ç”µå•†ã€ç¤¾äº¤ï¼‰ | âœ… éœ€è¦         | ä¸ºäº†è§£å†³æ€§èƒ½ã€é«˜å¯ç”¨ã€å®¹ç¾ç­‰é—®é¢˜ |

---

#### âœ… äºŒã€ä¸ºä»€ä¹ˆéœ€è¦éƒ¨ç½²å¤šä¸ª MySQLï¼Ÿ

##### 1. **è¯»å†™åˆ†ç¦»ï¼ˆRead-Write Splittingï¼‰**
- å†™æ“ä½œèµ° **ä¸»åº“ï¼ˆMasterï¼‰**
- è¯»æ“ä½œèµ° **ä»åº“ï¼ˆSlaveï¼‰**
- å‡è½»ä¸»åº“å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

> ğŸ” åŸç†ï¼šé€šè¿‡ **MySQL ä¸»ä»å¤åˆ¶ï¼ˆReplicationï¼‰** è‡ªåŠ¨åŒæ­¥æ•°æ®

```text
+--------+     +------------+
| Master | --> | Slave (RO) |
+--------+     +------------+
               +------------+
               | Slave (RO) |
               +------------+
```

##### 2. **é«˜å¯ç”¨ï¼ˆHigh Availabilityï¼‰**
- ä¸»åº“å®•æœº â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨åº“ï¼ˆå¦‚ä½¿ç”¨ MHAã€Orchestratorï¼‰
- é¿å…å•ç‚¹æ•…éšœ

##### 3. **åˆ†åº“åˆ†è¡¨ï¼ˆShardingï¼‰**
- æ•°æ®é‡å¤ªå¤§ï¼ˆäº¿çº§è¡¨ï¼‰â†’ æ‹†åˆ†åˆ°å¤šä¸ª MySQL å®ä¾‹
- å¦‚ï¼šæŒ‰ç”¨æˆ· ID åˆ†ç‰‡ï¼Œ`user_0`, `user_1` æ”¾åœ¨ä¸åŒå®ä¾‹ä¸Š

##### 4. **å¤šåœ°éƒ¨ç½²ï¼ˆå¼‚åœ°å®¹ç¾ï¼‰**
- åŒ—äº¬ä¸»æ•°æ®ä¸­å¿ƒ + ä¸Šæµ·å¤‡ä»½ä¸­å¿ƒ
- é˜²æ­¢æœºæˆ¿çº§æ•…éšœ

---

#### âœ… ä¸‰ã€å¤šä¸ªæ•°æ®åº“ä¹‹é—´çš„â€œé€šä¿¡â€æ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿ

ä½ é—®çš„â€œé€šä¿¡â€ï¼Œå…¶å®æ›´å‡†ç¡®è¯´æ˜¯ **æ•°æ®åŒæ­¥å’Œä¸€è‡´æ€§ä¿éšœæœºåˆ¶**ã€‚

MySQL æœ¬èº«ä¸ä¸»åŠ¨â€œé€šä¿¡â€ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°æ•°æ®åŒæ­¥ï¼š

---

##### æ–¹å¼ 1ï¸âƒ£ï¼š**ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slave Replicationï¼‰** â† æœ€å¸¸ç”¨

###### âœ… å·¥ä½œåŸç†ï¼š
1. ä¸»åº“è®°å½•æ‰€æœ‰å†™æ“ä½œåˆ° **binlog**ï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰
2. ä»åº“å¯åŠ¨ä¸€ä¸ª I/O çº¿ç¨‹ï¼Œè¿æ¥ä¸»åº“å¹¶æ‹‰å– binlog
3. ä»åº“å°†æ—¥å¿—å†™å…¥æœ¬åœ° **relay log**
4. ä»åº“çš„ SQL çº¿ç¨‹æ‰§è¡Œ relay log ä¸­çš„è¯­å¥ï¼Œå®Œæˆæ•°æ®åŒæ­¥

###### âœ… ç‰¹ç‚¹ï¼š
- å¼‚æ­¥å¤åˆ¶ï¼ˆé»˜è®¤ï¼‰ï¼šæœ‰å»¶è¿Ÿï¼ˆæ¯«ç§’~ç§’çº§ï¼‰
- åŠåŒæ­¥å¤åˆ¶ï¼ˆSemi-syncï¼‰ï¼šè‡³å°‘ä¸€ä¸ªä»åº“ç¡®è®¤æ”¶åˆ°æ—¥å¿—æ‰æäº¤ï¼Œæ›´å®‰å…¨
- å¯ç”¨äºè¯»å†™åˆ†ç¦»ã€å¤‡ä»½ã€æ•°æ®åˆ†æç­‰

###### âœ… é…ç½®ç¤ºä¾‹ï¼ˆç®€åŒ–ï¼‰ï¼š
```sql
-- ä¸»åº“å¼€å¯ binlog
log-bin = mysql-bin
server-id = 1

-- ä»åº“é…ç½®
server-id = 2
relay-log = mysql-relay-bin
```

---

##### æ–¹å¼ 2ï¸âƒ£ï¼š**åŒä¸»/å¤šä¸»å¤åˆ¶ï¼ˆMulti-Masterï¼‰**

- ä¸¤ä¸ª MySQL éƒ½å¯ä»¥å†™ï¼Œäº’ç›¸å¤åˆ¶å¯¹æ–¹çš„æ•°æ®
- é€‚ç”¨äºå¤šæ•°æ®ä¸­å¿ƒå†™å…¥

âš ï¸ **é£é™©**ï¼šå®¹æ˜“å†²çªï¼ˆå¦‚åŒä¸€è¡ŒåŒæ—¶è¢«ä¸¤ä¸ªä¸»åº“ä¿®æ”¹ï¼‰

ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ **GTID**ï¼ˆå…¨å±€äº‹åŠ¡ IDï¼‰
- è®¾ç½® **auto_increment_increment / offset** é¿å…è‡ªå¢å†²çª

---

##### æ–¹å¼ 3ï¸âƒ£ï¼š**ä¸­é—´ä»¶æˆ–ä»£ç†å±‚åè°ƒï¼ˆå¦‚ MyCatã€ShardingSphereã€ProxySQLï¼‰**

- åº”ç”¨ä¸ç›´æ¥è¿æ•°æ®åº“
- æ‰€æœ‰ SQL èµ°ä¸­é—´ä»¶ï¼Œç”±å®ƒå†³å®šè·¯ç”±åˆ°å“ªä¸ª MySQL å®ä¾‹

```text
App â†’ ProxySQL / ShardingSphere â†’ [MySQL Instance 1, MySQL Instance 2, ...]
```

âœ… ä¼˜ç‚¹ï¼š
- å¯¹åº”ç”¨é€æ˜
- æ”¯æŒåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€æ•…éšœè½¬ç§»

---

##### æ–¹å¼ 4ï¸âƒ£ï¼š**å…±äº«å­˜å‚¨ or é›†ç¾¤æ–¹æ¡ˆï¼ˆé«˜çº§ï¼‰**

| æ–¹æ¡ˆ                               | è¯´æ˜                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| **MySQL Group Replication**        | å®˜æ–¹æä¾›çš„å¤šèŠ‚ç‚¹å¼ºä¸€è‡´å¤åˆ¶ï¼ŒåŸºäº Paxos åè®®                  |
| **InnoDB Cluster**                 | åŸºäº Group Replication + MySQL Shell + Routerï¼Œè‡ªåŠ¨ç®¡ç†ä¸»ä»åˆ‡æ¢ |
| **Galera Cluster**                 | ç¬¬ä¸‰æ–¹é›†ç¾¤æ–¹æ¡ˆï¼Œæ”¯æŒå¤šä¸»åŒæ­¥å¤åˆ¶                             |
| **MGRï¼ˆMySQL Group Replicationï¼‰** | æ¨èç”¨äºé‡‘èçº§é«˜å¯ç”¨åœºæ™¯                                     |

> è¿™äº›æ–¹æ¡ˆå†…éƒ¨é€šè¿‡ **ç»„é€šä¿¡åè®®ï¼ˆGroup Communication Protocolï¼‰** å®ç°èŠ‚ç‚¹é—´é€šä¿¡å’ŒçŠ¶æ€åŒæ­¥ã€‚

---

#### âœ… å››ã€å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

| æœºåˆ¶                    | è¯´æ˜                                 |
| ----------------------- | ------------------------------------ |
| **å¼‚æ­¥å¤åˆ¶**            | é»˜è®¤ï¼Œæœ€å¿«ï¼Œä½†å¯èƒ½ä¸¢æ•°æ®             |
| **åŠåŒæ­¥å¤åˆ¶**          | è‡³å°‘ä¸€ä¸ªä»åº“æ”¶åˆ°æ—¥å¿—ï¼Œå¹³è¡¡æ€§èƒ½ä¸å®‰å…¨ |
| **å…¨åŒæ­¥å¤åˆ¶**          | æ‰€æœ‰ä»åº“éƒ½ç¡®è®¤æ‰æäº¤ï¼Œæ€§èƒ½å·®         |
| **GTID**                | å…¨å±€äº‹åŠ¡ IDï¼Œé¿å…å¤åˆ¶é”™ä½            |
| **å¿ƒè·³æ£€æµ‹ + æ•…éšœè½¬ç§»** | å¦‚ MHAã€Orchestrator è‡ªåŠ¨åˆ‡æ¢ä¸»åº“    |

---

#### âœ… äº”ã€å®é™…éƒ¨ç½²å»ºè®®

| æ¶æ„                        | é€‚ç”¨åœºæ™¯               |
| --------------------------- | ---------------------- |
| **ä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»**     | 90% çš„ä¸­å¤§å‹é¡¹ç›®é¦–é€‰   |
| **MHA + VIP åˆ‡æ¢**          | è¦æ±‚é«˜å¯ç”¨ä½†ä¸æƒ³å¤ªå¤æ‚ |
| **InnoDB Cluster**          | å®˜æ–¹æ¨èï¼Œé€‚åˆäº‘ç¯å¢ƒ   |
| **ShardingSphere åˆ†åº“åˆ†è¡¨** | è¶…å¤§æ•°æ®é‡ï¼ˆTBçº§ä»¥ä¸Šï¼‰ |

----

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç³»ç»Ÿåœ°è®²è§£ Redis é›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ã€èŠ‚ç‚¹é—´é€šä¿¡æœºåˆ¶ä»¥åŠæ•°æ®åˆ†å¸ƒç­–ç•¥ã€‚

---

#### âœ… ä¸€ã€Redis é›†ç¾¤çš„ç›®æ ‡

Redis æ˜¯å•çº¿ç¨‹å†…å­˜æ•°æ®åº“ï¼Œä¸ºäº†ï¼š
- **çªç ´å•æœºå†…å­˜é™åˆ¶**
- **æé«˜å¹¶å‘æ€§èƒ½**
- **å®ç°é«˜å¯ç”¨ï¼ˆä¸»ä»åˆ‡æ¢ï¼‰**

å°±éœ€è¦éƒ¨ç½²å¤šä¸ª Redis èŠ‚ç‚¹ç»„æˆé›†ç¾¤ã€‚

> ğŸ¯ ç›®æ ‡ï¼šè®©å¤šä¸ª Redis å®ä¾‹ååŒå·¥ä½œï¼Œå¯¹å¤–è¡¨ç°ä¸ºä¸€ä¸ªâ€œé€»è¾‘ä¸Šç»Ÿä¸€â€çš„ç¼“å­˜æœåŠ¡ã€‚

---

#### âœ… äºŒã€Redis å®˜æ–¹é›†ç¾¤æ–¹æ¡ˆï¼š**Redis Cluster**

è¿™æ˜¯ç›®å‰æœ€ä¸»æµã€å®˜æ–¹æ¨èçš„é›†ç¾¤æ–¹æ¡ˆï¼ˆæ— éœ€ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ï¼‰ã€‚

##### ğŸ”— æ¶æ„å›¾ç¤ºæ„ï¼š

```text
+----------------+     +----------------+     +----------------+
|   Redis Node   |<--->|   Redis Node   |<--->|   Redis Node   |
| (Master/Slave) |     | (Master/Slave) |     | (Master/Slave) |
+----------------+     +----------------+     +----------------+
       â†‘                       â†‘                      â†‘
    Gossipåè®®           Gossipåè®®             Gossipåè®®
       â†“                       â†“                      â†“
+----------------------------------------------------------+
|                   Cluster Busï¼ˆä¸“ç”¨ç«¯å£ï¼‰                 |
+----------------------------------------------------------+
```

æ¯ä¸ªèŠ‚ç‚¹éƒ½é€šè¿‡ **Cluster Bus** ä¸å…¶ä»–èŠ‚ç‚¹é€šä¿¡ã€‚

---

#### âœ… ä¸‰ã€Redis é›†ç¾¤çš„å…³é”®æŠ€æœ¯ç‚¹

##### 1ï¸âƒ£ æ•°æ®åˆ†ç‰‡ï¼š**å“ˆå¸Œæ§½ï¼ˆHash Slotï¼‰æœºåˆ¶**

- Redis Cluster å°†æ•´ä¸ªé”®ç©ºé—´åˆ’åˆ†ä¸º **16384 ä¸ªå“ˆå¸Œæ§½ï¼ˆhash slotsï¼‰**
- æ¯ä¸ª key é€šè¿‡ `CRC16(key) % 16384` è®¡ç®—å‡ºå¯¹åº”çš„ slot
- æ¯ä¸ª Master èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ† slot

> ğŸ’¡ ç¤ºä¾‹ï¼š
> - `user:1001` â†’ slot 5000 â†’ ç”± Node A ç®¡ç†
> - `order:2002` â†’ slot 12000 â†’ ç”± Node B ç®¡ç†

âœ… å¥½å¤„ï¼š
- å¯æ‰©å±•ï¼šå¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¿ç§»éƒ¨åˆ† slot
- è´Ÿè½½å‡è¡¡ï¼šæ•°æ®å‡åŒ€åˆ†å¸ƒ

---

##### 2ï¸âƒ£ èŠ‚ç‚¹é€šä¿¡ï¼š**Gossip åè®®**

###### â“ ä»€ä¹ˆæ˜¯ Gossipï¼Ÿ
ä¸€ç§å»ä¸­å¿ƒåŒ–çš„åˆ†å¸ƒå¼é€šä¿¡åè®®ï¼Œç±»ä¼¼â€œæµè¨€ä¼ æ’­â€ã€‚

###### âœ… å·¥ä½œæ–¹å¼ï¼š
- æ¯ä¸ª Redis èŠ‚ç‚¹æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤ 1 ç§’ï¼‰éšæœºé€‰æ‹©å‡ ä¸ªå…¶ä»–èŠ‚ç‚¹å‘é€ `PING` æ¶ˆæ¯
- æ¥æ”¶æ–¹å›å¤ `PONG`
- äº¤æ¢ä¿¡æ¯åŒ…æ‹¬ï¼š
  - èŠ‚ç‚¹çŠ¶æ€ï¼ˆä¸Šçº¿/ä¸‹çº¿ï¼‰
  - æ‰€è´Ÿè´£çš„ slot èŒƒå›´
  - ä¸»ä»å…³ç³»
  - æ•…éšœä¿¡æ¯

###### âœ… ä½¿ç”¨çš„ç«¯å£ï¼š
- **å®¢æˆ·ç«¯ç«¯å£**ï¼šå¦‚ `6379`
- **é›†ç¾¤æ€»çº¿ç«¯å£**ï¼š`å®¢æˆ·ç«¯ç«¯å£ + 10000`ï¼Œå¦‚ `16379`

> âš ï¸ å¿…é¡»å¼€æ”¾è¿™ä¸¤ä¸ªç«¯å£ä¹‹é—´çš„ç½‘ç»œäº’é€šï¼

---

##### 3ï¸âƒ£ æ•°æ®è®¿é—®æµç¨‹

å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ª keyï¼š

```text
GET user:1001
         â†“
è®¡ç®— CRC16("user:1001") % 16384 = 5000
         â†“
æŸ¥è¯¢ cluster nodes æ˜ å°„è¡¨ â†’ slot 5000 å±äº Node A
         â†“
è¯·æ±‚è¢«è·¯ç”±åˆ° Node A å¤„ç†
```

å¦‚æœå®¢æˆ·ç«¯å‘é”™äº†èŠ‚ç‚¹ï¼ŒRedis ä¼šè¿”å›ï¼š
```bash
MOVED 5000 192.168.1.10:6379
```
å‘Šè¯‰å®¢æˆ·ç«¯ï¼šâ€œè¿™ä¸ª key åº”è¯¥å»è¿™ä¸ªåœ°å€æ‰¾â€ã€‚

âœ… æ”¯æŒ MOVED é‡å®šå‘çš„å®¢æˆ·ç«¯æ‰èƒ½ä½¿ç”¨ Redis Clusterï¼ˆå¦‚ Jedisã€Lettuceï¼‰

---

##### 4ï¸âƒ£ é«˜å¯ç”¨ï¼š**ä¸»ä»å¤åˆ¶ + æ•…éšœè½¬ç§»**

- æ¯ä¸ª Master å¯ä»¥é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ª Slave
- Slave å®æ—¶åŒæ­¥ Master æ•°æ®ï¼ˆå¼‚æ­¥å¤åˆ¶ï¼‰
- å½“ Master å®•æœºï¼š
  - å…¶ä»–èŠ‚ç‚¹é€šè¿‡ Gossip å‘ç°å®ƒå¤±è”
  - è¾¾æˆå…±è¯†åï¼Œç”±å®ƒçš„ Slave å‘èµ·é€‰ä¸¾
  - é€‰ç¥¨è¿‡åŠ â†’ å‡çº§ä¸ºæ–° Masterï¼ˆè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼‰

> ä½¿ç”¨ **Raft ç®—æ³•çš„ç®€åŒ–ç‰ˆ** å®ç°é¢†å¯¼è€…é€‰ä¸¾

---

##### 5ï¸âƒ£ é…ç½®ä¸€è‡´æ€§ï¼š**é…ç½®çºªå…ƒï¼ˆConfiguration Epochï¼‰**

- æ¯æ¬¡å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ epoch ç¼–å·
- ç”¨äºè§£å†³è„‘è£‚åœºæ™¯ä¸‹çš„å†²çªï¼ˆè°æ‰æ˜¯çœŸæ­£çš„ Masterï¼‰

---

#### âœ… å››ã€å…¶ä»– Redis é›†ç¾¤æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ                        | è¯´æ˜                                      | æ˜¯å¦éœ€è¦é¢å¤–ç»„ä»¶          |
| --------------------------- | ----------------------------------------- | ------------------------- |
| **Redis Clusterï¼ˆå®˜æ–¹ï¼‰**   | å»ä¸­å¿ƒåŒ–ï¼ŒGossip + Slotï¼Œæ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§» | âŒ å¦                      |
| **Codis**                   | ä»£ç†å¼é›†ç¾¤ï¼ŒåŸºäº ZooKeeper ç®¡ç†è·¯ç”±       | âœ… æ˜¯ï¼ˆZooKeeper + Proxyï¼‰ |
| **Twemproxyï¼ˆNutcrackerï¼‰** | æ—©æœŸåˆ†ç‰‡ä»£ç†ï¼Œä¸æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹            | âœ… æ˜¯                      |
| **Redis Sentinelï¼ˆå“¨å…µï¼‰**  | ä¸»ä»ç›‘æ§ + æ•…éšœè½¬ç§»ï¼Œä½†ä¸æ”¯æŒåˆ†ç‰‡         | âœ… æ˜¯ï¼ˆSentinel è¿›ç¨‹ï¼‰     |

> âœ… æ¨èï¼šç”Ÿäº§ç¯å¢ƒä¼˜å…ˆä½¿ç”¨ **Redis Cluster**

---

#### âœ… äº”ã€Redis é›†ç¾¤éƒ¨ç½²å»ºè®®

##### ğŸ§© æœ€å°æ¨èæ¶æ„ï¼ˆ6èŠ‚ç‚¹ï¼‰ï¼š
- 3 ä¸ª Masterï¼ˆå„è´Ÿè´£çº¦ 5461 ä¸ª slotï¼‰
- 3 ä¸ª Slaveï¼ˆåˆ†åˆ«ä½œä¸º Master çš„å¤‡ä»½ï¼‰

```text
Master A (slot 0-5460) â† Slave A
Master B (slot 5461-10921) â† Slave B
Master C (slot 10922-16383) â† Slave C
```

##### ğŸ› ï¸ éƒ¨ç½²è¦ç‚¹ï¼š
1. æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»èƒ½äº’ç›¸é€šä¿¡ï¼ˆå¼€æ”¾ `6379` å’Œ `16379`ï¼‰
2. ä½¿ç”¨æ”¯æŒ Cluster çš„å®¢æˆ·ç«¯
3. åˆç†è®¾ç½® `cluster-node-timeout`ï¼ˆé»˜è®¤ 15sï¼‰
4. é¿å… bigkey å¯¼è‡´é˜»å¡
5. å¼€å¯ AOF æŒä¹…åŒ–ï¼ˆ`appendonly yes`ï¼‰

---

#### âœ… å…­ã€æ€»ç»“ï¼šRedis é›†ç¾¤å¦‚ä½•è§£å†³æ•°æ®é€šä¿¡ï¼Ÿ

| é—®é¢˜                     | è§£å†³æ–¹æ¡ˆ                                                |
| ------------------------ | ------------------------------------------------------- |
| **æ•°æ®æ€ä¹ˆåˆ†å¸ƒï¼Ÿ**       | ä½¿ç”¨ **16384 ä¸ªå“ˆå¸Œæ§½**ï¼ŒæŒ‰ key åˆ†é…åˆ°ä¸åŒèŠ‚ç‚¹          |
| **èŠ‚ç‚¹å¦‚ä½•é€šä¿¡ï¼Ÿ**       | é€šè¿‡ **Gossip åè®®** åœ¨ **Cluster Bus** ä¸Šäº¤æ¢çŠ¶æ€      |
| **å®¢æˆ·ç«¯æ€ä¹ˆæ‰¾åˆ° keyï¼Ÿ** | è¿”å› `MOVED` æˆ– `ASK` é‡å®šå‘                            |
| **ä¸»èŠ‚ç‚¹æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ**   | Slave è§¦å‘æ•…éšœè½¬ç§»ï¼Œé€šè¿‡ Raft ç±»å…±è¯†é€‰ä¸¾                |
| **æ•°æ®ä¸€è‡´æ€§ï¼Ÿ**         | å¼‚æ­¥å¤åˆ¶ä¸ºä¸»ï¼Œå¯é€šè¿‡ `min-replicas-to-write` æ§åˆ¶å†™å®‰å…¨ |

---

##### ğŸ¯ æœ€ä½³å®è·µå»ºè®®ï¼š

> - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ **Redis Cluster + å“¨å…µï¼ˆå¯é€‰ç›‘æ§ï¼‰**
> - é¿å…è·¨æœºæˆ¿éƒ¨ç½² Clusterï¼ˆå»¶è¿Ÿé«˜ï¼Œæ˜“è¯¯åˆ¤å®•æœºï¼‰
> - ä½¿ç”¨ Pipeline å’Œæ‰¹é‡æ“ä½œæå‡æ€§èƒ½
> - ç›‘æ§èŠ‚ç‚¹å¿ƒè·³ã€slot åˆ†å¸ƒã€å¤åˆ¶å»¶è¿Ÿ

---





### Redissionæ€ä¹ˆç”¨ï¼Ÿ

 



### å¯¹äºP30åç«¯è¿”å›messageæ ¼å¼çš„æ€è€ƒ

è¿”å›å“åº”ä½“ä¸­æœ‰ä¸€é¡¹contactIdï¼Œä»£è¡¨äº†è”ç³»äººidï¼Œä¹Ÿå°±æ˜¯æ¥æ”¶äººçš„idã€‚

ä½†åœ¨å‰ç«¯é¡¹ç›®ä¸­ï¼Œä¼¼ä¹æ˜¯ç›´æ¥å°†æ¥æ”¶åˆ°çš„jsonä¸­çš„contactidè½¬ä¸ºäº†å½“å‰æ¶ˆæ¯è”ç³»äººçš„idï¼Œè€Œä»¥æˆ‘ä»¬çš„è§†è§’æ¥çœ‹ï¼Œæ¥æ”¶äººidå°±æ˜¯ä»–è‡ªå·±ï¼Œè¿™ä¸€éƒ¨åˆ†è®¾è®¡å­˜åœ¨é—®é¢˜ï¼Œä½†æ˜¯å‡ºäºä¸æƒ³ä¿®æ”¹å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨åç«¯å°†å‘é€çš„æ¶ˆæ¯çš„contactidæ”¹ä¸ºäº†å‘é€è€…idã€‚

è¿™ä¸€è®¾è®¡å­˜åœ¨å¾ˆå¤§çš„é—®é¢˜ï¼Œåç«¯æœ€å¥½è¿˜æ˜¯å°†é€»è¾‘æ¸…æ™°çš„æ•°æ®ä½œä¸ºå“åº”ä½“å‘é€ç»™å‰ç«¯ï¼Œå‰ç«¯å¯¹æ¥æ”¶åˆ°çš„ä¿¡æ¯ä½œé¢å¤–å¤„ç†ï¼Œå°†æ¯æ¡æ¶ˆæ¯çš„è”ç³»äººidä»å“åº”ä½“ä¸­çš„å‘é€äººidè¿™ä¸€é¡¹ä¸­å–å‡ºã€‚

è‹¥ä¸ä½œæ­¤ä¿®æ”¹ï¼Œå‰åç«¯çš„è€¦åˆç¨‹åº¦è¾ƒå¤§ï¼Œåç»­ç»´æŠ¤ç†è§£èµ·æ¥ä¹Ÿä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œç®—æ˜¯é¡¹ç›®ä¸­æ¯”è¾ƒå¤§çš„è®¾è®¡é”™è¯¯ä¹‹ä¸€ã€‚

### Javaçš„streamæµå¼ä¼ è¾“æ–‡ä»¶



æ³¨æ„è¿”å›ç±»å‹æ”¹ä¸ºvoidï¼Œå¦åˆ™springä¼šå°è¯•ç»™å“åº”ç»“æœæ‰¾ä¸€ä¸ªåˆé€‚çš„å“åº”å¯¹è±¡ï¼Œæ‰¾ä¸åˆ°å°±ä¼šæŠ›å‡ºå¼‚å¸¸HttpMessageNotWritableExceptionï¼š[ä¸‹è½½/å¯¼å‡ºé—®é¢˜ï¼ˆç»Ÿä¸€è¿”å›ï¼‰ï¼šNo converter for xxx with preset Content-Type â€˜application/octet-streamï¼›charset=UTF-8-CSDNåšå®¢](https://blog.csdn.net/Ying_ph/article/details/133199468)





### B+æ ‘





### IOå¤šè·¯å¤ç”¨ä¸å¤šçº¿ç¨‹

[ã€ç½‘ç»œã€‘é«˜å¹¶å‘åœºæ™¯å¤„ç†ï¼šçº¿ç¨‹æ± å’ŒIOå¤šè·¯å¤ç”¨-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº](https://developer.aliyun.com/article/1620394)



### Multipartæ–‡ä»¶



### ORMæ¡†æ¶

MyBatis å’Œ Hibernate éƒ½æ˜¯ Java é¢†åŸŸæµè¡Œçš„æŒä¹…å±‚æ¡†æ¶ï¼Œç”¨äºç®€åŒ–æ•°æ®åº“æ“ä½œï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç†å¿µå’Œå·¥ä½œæ–¹å¼æœ‰æ ¹æœ¬æ€§çš„åŒºåˆ«ã€‚

#### æ ¸å¿ƒåŒºåˆ«

æœ€æ ¸å¿ƒçš„åŒºåˆ«åœ¨äºï¼š

- **MyBatis æ˜¯ä¸€ä¸ªâ€œåŠè‡ªåŠ¨åŒ–â€çš„ SQL æ˜ å°„æ¡†æ¶ã€‚**
- **Hibernate æ˜¯ä¸€ä¸ªå…¨è‡ªåŠ¨çš„ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ã€‚**

è¿™ä¸ªæ ¹æœ¬åŒºåˆ«å¯¼è‡´äº†å®ƒä»¬åœ¨ SQL å¤„ç†ã€å¼€å‘æ–¹å¼ã€çµæ´»æ€§å’Œå­¦ä¹ æ›²çº¿ä¸Šçš„ä¸åŒã€‚

------

#### ä¸ºä»€ä¹ˆè¯´ Hibernate ä¸éœ€è¦å†™ SQLï¼Ÿ

è¯´ Hibernate â€œä¸éœ€è¦å†™ SQLâ€ æ˜¯ä¸€ä¸ª**ç›¸å¯¹å’Œç®€åŒ–**çš„è¯´æ³•ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼ŒHibernate å…è®¸å¼€å‘è€…**å®Œå…¨ä¸æ‰‹å†™åŸç”Ÿçš„ SQL è¯­å¥**ï¼Œè€Œæ˜¯é€šè¿‡æ“ä½œ Java å¯¹è±¡ï¼ˆPOJOï¼‰å’Œä½¿ç”¨ HQL (Hibernate Query Language) æˆ– Criteria API æ¥å®ç°æ•°æ®åº“æ“ä½œã€‚

##### å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

1. **å¯¹è±¡å…³ç³»æ˜ å°„ (ORM)ï¼š**

   - ä½ é¦–å…ˆå®šä¹‰ä¸€ä¸ª Java ç±»ï¼ˆå®ä½“ç±»ï¼ŒEntityï¼‰ï¼Œæ¯”å¦‚ `User`ã€‚
   - é€šè¿‡æ³¨è§£ï¼ˆå¦‚ `@Entity`, `@Table`, `@Id`, `@Column`ï¼‰æˆ– XML é…ç½®æ–‡ä»¶ï¼Œä½ å‘Šè¯‰ Hibernate è¿™ä¸ª `User` ç±»å¯¹åº”æ•°æ®åº“ä¸­çš„ `user` è¡¨ï¼Œ`User` ç±»çš„ `id` å±æ€§å¯¹åº” `user` è¡¨çš„ `id` åˆ—ï¼Œ`name` å±æ€§å¯¹åº” `name` åˆ—ï¼Œç­‰ç­‰ã€‚
   - Hibernate åœ¨å¯åŠ¨æ—¶ä¼šè¯»å–è¿™äº›å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼Œå»ºç«‹èµ· Java å¯¹è±¡ä¸æ•°æ®åº“è¡¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚

2. **è‡ªåŠ¨ç”Ÿæˆ SQLï¼š**

   - å½“ä½ è°ƒç”¨ Hibernate çš„ API è¿›è¡Œæ“ä½œæ—¶ï¼Œä¾‹å¦‚ï¼š

     ```java
     User user = new User();
     user.setName("å¼ ä¸‰");
     session.save(user); // ä¿å­˜
     ```

   - Hibernate ä¼šæ ¹æ® 

     ```
     User
     ```

      ç±»çš„æ˜ å°„å…ƒæ•°æ®ï¼Œ

     åœ¨å†…éƒ¨è‡ªåŠ¨ç”Ÿæˆ

     å¯¹åº”çš„ SQL è¯­å¥ï¼š

     ```sql
     INSERT INTO user (name) VALUES ('å¼ ä¸‰');
     ```

   - åŒæ ·åœ°ï¼Œ`session.get(User.class, 1)` ä¼šç”Ÿæˆ `SELECT * FROM user WHERE id = 1;`ã€‚

3. **æŸ¥è¯¢è¯­è¨€ (HQL & Criteria API)ï¼š**

   - HQL (Hibernate Query Language):

      è¿™æ˜¯ä¸€ç§é¢å‘å¯¹è±¡çš„æŸ¥è¯¢è¯­è¨€ã€‚ä½ æŸ¥è¯¢çš„æ˜¯

     å¯¹è±¡å’Œå±æ€§

     ï¼Œè€Œä¸æ˜¯æ•°æ®åº“çš„è¡¨å’Œåˆ—ã€‚

     ```java
     // æŸ¥è¯¢æ‰€æœ‰ name ä¸º "å¼ ä¸‰" çš„ User å¯¹è±¡
     Query query = session.createQuery("FROM User WHERE name = :name");
     query.setParameter("name", "å¼ ä¸‰");
     List<User> users = query.list();
     ```

     Hibernate ä¼šå°†è¿™æ¡ HQL ç¿»è¯‘æˆç­‰æ•ˆçš„ SQL è¯­å¥å»æ‰§è¡Œã€‚

   - Criteria API:

      è¿™æ˜¯ä¸€ç§ç±»å‹å®‰å…¨çš„ã€ä»¥ç¼–ç¨‹æ–¹å¼æ„å»ºæŸ¥è¯¢çš„ APIã€‚

     ```java
     CriteriaBuilder cb = session.getCriteriaBuilder();
     CriteriaQuery<User> cq = cb.createQuery(User.class);
     Root<User> root = cq.from(User.class);
     cq.select(root).where(cb.equal(root.get("name"), "å¼ ä¸‰"));
     List<User> users = session.createQuery(cq).getResultList();
     ```

     è¿™åŒæ ·ä¼šè¢« Hibernate ç¿»è¯‘æˆ SQLã€‚

**æ€»ç»“â€œä¸éœ€è¦ SQLâ€ï¼š** å¼€å‘è€…åªéœ€è¦å…³æ³¨ Java å¯¹è±¡å’Œä¸šåŠ¡é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨ Hibernate æä¾›çš„ API æˆ–ç¼–å†™ HQLï¼ŒHibernate æ¡†æ¶ä¼šè´Ÿè´£å°†è¿™äº›æ“ä½œâ€œç¿»è¯‘â€æˆæ•°æ®åº“èƒ½ç†è§£çš„åŸç”Ÿ SQL å¹¶æ‰§è¡Œã€‚å¼€å‘è€…æ— éœ€å…³å¿ƒåº•å±‚ SQL çš„å…·ä½“è¯­æ³•ã€‚

------

#### MyBatis å¦‚ä½•å·¥ä½œï¼Ÿ

MyBatis åˆ™é‡‡å–äº†ä¸åŒçš„ç­–ç•¥ï¼š

1. **SQL æ˜¾å¼åŒ–ï¼š** MyBatis è¦æ±‚å¼€å‘è€…**è‡ªå·±ç¼–å†™ SQL è¯­å¥**ã€‚è¿™äº› SQL é€šå¸¸å†™åœ¨ XML æ˜ å°„æ–‡ä»¶ä¸­ï¼Œæˆ–è€…ä½¿ç”¨æ³¨è§£ç›´æ¥å†™åœ¨ Mapper æ¥å£ä¸Šã€‚
2. **ç»“æœæ˜ å°„ï¼š** ä½ ç¼–å†™å¥½ SQL åï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ª `<resultMap>` æˆ–ä½¿ç”¨è‡ªåŠ¨æ˜ å°„ï¼Œæ¥å‘Šè¯‰ MyBatis å¦‚ä½•å°† SQL æ‰§è¡Œåè¿”å›çš„ `ResultSet`ï¼ˆç»“æœé›†ï¼‰ä¸­çš„åˆ—ï¼Œæ˜ å°„åˆ° Java å¯¹è±¡çš„å±æ€§ä¸Šã€‚
3. æ‰§è¡Œè¿‡ç¨‹ï¼š
   - ä½ è°ƒç”¨ä¸€ä¸ª Mapper æ¥å£çš„æ–¹æ³•ï¼ˆå¦‚ `userMapper.selectById(1)`ï¼‰ã€‚
   - MyBatis æ¡†æ¶æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•å¯¹åº”çš„ SQL è¯­å¥ï¼ˆæ¯”å¦‚ `SELECT * FROM user WHERE id = #{id}`ï¼‰ã€‚
   - MyBatis å°†å‚æ•°ï¼ˆ1ï¼‰å¡«å……åˆ° SQL ä¸­ï¼Œæ‰§è¡ŒæŸ¥è¯¢ã€‚
   - MyBatis å°†æŸ¥è¯¢ç»“æœï¼ˆ`ResultSet`ï¼‰æ ¹æ®ä½ å®šä¹‰çš„æ˜ å°„è§„åˆ™ï¼Œå°è£…æˆä½ æŒ‡å®šçš„ Java å¯¹è±¡ï¼ˆå¦‚ `User` å¯¹è±¡ï¼‰å¹¶è¿”å›ã€‚

**å…³é”®ç‚¹ï¼š** MyBatis çš„æ ¸å¿ƒæ˜¯**SQL æ˜ å°„**ï¼Œå®ƒä¸ç”Ÿæˆ SQLï¼Œè€Œæ˜¯å¸®ä½ æ‰§è¡Œä½ å†™å¥½çš„ SQLï¼Œå¹¶å¤„ç†å‚æ•°å’Œç»“æœé›†çš„è½¬æ¢ã€‚

------

#### å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§             | Hibernate                                                    | MyBatis                                                      |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **æ ¸å¿ƒç†å¿µ**     | å…¨è‡ªåŠ¨ ORMï¼Œæ“ä½œå¯¹è±¡                                         | åŠè‡ªåŠ¨ SQL æ˜ å°„ï¼Œæ“ä½œ SQL                                    |
| **SQL ç¼–å†™**     | **ä¸éœ€è¦**æ‰‹å†™åŸç”Ÿ SQL (ä½¿ç”¨ HQL/Criteria)                   | **å¿…é¡»**æ‰‹å†™åŸç”Ÿ SQL                                         |
| **SQL æ§åˆ¶åŠ›**   | å¼±ã€‚SQL ç”±æ¡†æ¶ç”Ÿæˆï¼Œéš¾ä»¥è¿›è¡Œå¤æ‚çš„ã€ç‰¹å®šäºæ•°æ®åº“çš„ä¼˜åŒ–ã€‚     | **å¼º**ã€‚å¼€å‘è€…å®Œå…¨æŒæ§ SQLï¼Œå¯ä»¥è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼ˆå¦‚ä½¿ç”¨ç‰¹å®šæ•°æ®åº“å‡½æ•°ã€å¤æ‚è¿æ¥ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€‚ |
| **å­¦ä¹ æ›²çº¿**     | è¾ƒé™¡å³­ã€‚éœ€è¦ç†è§£ ORM æ¦‚å¿µã€ç¼“å­˜ã€å»¶è¿ŸåŠ è½½ã€Session ç”Ÿå‘½å‘¨æœŸã€HQL ç­‰ã€‚ | ç›¸å¯¹å¹³ç¼“ã€‚å¯¹ç†Ÿæ‚‰ SQL çš„å¼€å‘è€…æ¥è¯´ï¼Œæ›´å®¹æ˜“ä¸Šæ‰‹ã€‚              |
| **æ•°æ®åº“ç§»æ¤æ€§** | **é«˜**ã€‚HQL æ˜¯æ•°æ®åº“æ— å…³çš„ï¼Œæ›´æ¢æ•°æ®åº“é€šå¸¸åªéœ€ä¿®æ”¹æ–¹è¨€é…ç½®ã€‚ | **ä½**ã€‚SQL é€šå¸¸æ˜¯ç‰¹å®šäºæ•°æ®åº“çš„ï¼Œæ›´æ¢æ•°æ®åº“å¯èƒ½éœ€è¦é‡å†™ SQLã€‚ |
| **å¼€å‘æ•ˆç‡**     | å¯¹äºç®€å• CRUD æé«˜ï¼Œè‡ªåŠ¨ç”Ÿæˆ SQLã€‚                           | éœ€è¦ä¸ºæ¯ä¸ªæ“ä½œç¼–å†™ SQLï¼ŒåˆæœŸå¼€å‘æ•ˆç‡å¯èƒ½è¾ƒä½ã€‚               |
| **æ€§èƒ½**         | å¯¹äºç®€å•æ“ä½œè¶³å¤Ÿå¥½ï¼Œä½†å¤æ‚æŸ¥è¯¢å¯èƒ½ç”Ÿæˆä½æ•ˆ SQLã€‚             | å¯ä»¥é€šè¿‡ä¼˜åŒ– SQL è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚                              |
| **é€‚ç”¨åœºæ™¯**     | ä¸šåŠ¡æ¨¡å‹ç¨³å®šã€ä»¥ CRUD ä¸ºä¸»ã€è¿½æ±‚å¿«é€Ÿå¼€å‘ã€éœ€è¦é«˜ç§»æ¤æ€§çš„é¡¹ç›®ã€‚ | éœ€è¦å¤æ‚ SQLã€é«˜æ€§èƒ½è¦æ±‚ã€é—ç•™ç³»ç»Ÿã€SQL æŠ€èƒ½å¼ºçš„å›¢é˜Ÿã€‚       |

**ç®€å•æ¥è¯´ï¼š**

- **ç”¨ Hibernateï¼Œä½ å‘Šè¯‰æ¡†æ¶â€œæˆ‘è¦åšä»€ä¹ˆâ€**ï¼ˆæ¯”å¦‚â€œä¿å­˜è¿™ä¸ªç”¨æˆ·å¯¹è±¡â€ï¼‰ï¼Œæ¡†æ¶å¸®ä½ ç”Ÿæˆå¹¶æ‰§è¡Œ SQLã€‚
- **ç”¨ MyBatisï¼Œä½ å‘Šè¯‰æ¡†æ¶â€œSQL æ€ä¹ˆåšâ€**ï¼Œæ¡†æ¶å¸®ä½ æ‰§è¡Œå¹¶æŠŠç»“æœç»™ä½ ã€‚

#### MyBatis-Plus

**MyBatis-Plus (MP) æœ¬è´¨ä¸Šä»ç„¶æ˜¯ä¸€ä¸ªâ€œåŠè‡ªåŠ¨åŒ–â€çš„ SQL æ˜ å°„æ¡†æ¶ï¼Œå®ƒæ²¡æœ‰æ”¹å˜ MyBatis çš„æ ¸å¿ƒå®šä½ï¼Œå› æ­¤ä¸èƒ½ç®—ä½œåƒ Hibernate é‚£æ ·çš„â€œå…¨è‡ªåŠ¨ ORMâ€ã€‚**

ä½ å¯ä»¥æŠŠ MyBatis-Plus ç†è§£ä¸º **â€œMyBatis çš„è¶…çº§å¢å¼ºç‰ˆâ€** æˆ– **â€œMyBatis çš„ç”Ÿäº§åŠ›å·¥å…·é›†â€**ã€‚å®ƒåœ¨ MyBatis çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å¤§é‡è‡ªåŠ¨åŒ–å’Œä¾¿æ·çš„åŠŸèƒ½ï¼Œ**æå¤§åœ°å‡å°‘äº†å¼€å‘è€…éœ€è¦æ‰‹å†™çš„ SQL å’Œä»£ç é‡**ï¼Œä½¿å…¶åœ¨ä½¿ç”¨ä½“éªŒä¸Šæ›´æ¥è¿‘å…¨è‡ªåŠ¨ ORM çš„ä¾¿æ·æ€§ï¼Œä½†å…¶åº•å±‚åŸç†å’Œæ ¸å¿ƒæ€æƒ³ä¾ç„¶æ˜¯åŸºäºæ˜¾å¼ SQL æ˜ å°„çš„ã€‚

------

#### ä¸ºä»€ä¹ˆè¯´ MyBatis-Plus ä¸æ˜¯å…¨è‡ªåŠ¨ ORMï¼Ÿ

1. **æ ¸å¿ƒä¾èµ– MyBatisï¼š**
   - MP çš„åº•å±‚ä¾ç„¶æ˜¯ MyBatisã€‚å®ƒæ‰€æœ‰çš„ CRUD æ“ä½œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ MyBatis çš„ `Mapper` æ¥å£å’Œ SQL æ˜ å°„ï¼ˆXML æˆ–æ³¨è§£ï¼‰æ¥æ‰§è¡Œçš„ã€‚
   - å®ƒåªæ˜¯å¸®ä½ **è‡ªåŠ¨ç”Ÿæˆäº†è¿™äº›åŸºç¡€çš„ SQL æ˜ å°„**ï¼Œè€Œä¸æ˜¯åƒ Hibernate é‚£æ ·åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æ HQL å¹¶ç”Ÿæˆ SQLã€‚
2. **SQL ä¾ç„¶å­˜åœ¨ä¸”å¯è§ï¼š**
   - è™½ç„¶ MP çš„ `BaseMapper` æä¾›äº† `selectById`, `insert`, `updateById`, `delete` ç­‰æ–¹æ³•ï¼Œä½ ä¸éœ€è¦ä¸ºè¿™äº›é€šç”¨æ“ä½œå†™ SQLï¼Œä½†è¿™äº› SQL æ˜¯ MP **åœ¨å†…éƒ¨é¢„å…ˆå®šä¹‰å¥½**çš„æ¨¡æ¿ã€‚
   - ä½ å¯ä»¥é€šè¿‡æ—¥å¿—æ¸…æ™°åœ°çœ‹åˆ° MP ä¸ºä½ ç”Ÿæˆå’Œæ‰§è¡Œçš„ SQL è¯­å¥ã€‚SQL æ˜¯æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å¯¹å¼€å‘è€…å®Œå…¨é€æ˜ã€‚
3. **å¤æ‚æŸ¥è¯¢ä»éœ€æ‰‹å†™ SQLï¼š**
   - å½“é‡åˆ°å¤æ‚çš„å…³è”æŸ¥è¯¢ï¼ˆJOINï¼‰ã€å­æŸ¥è¯¢ã€ç‰¹å®šæ•°æ®åº“å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ç­‰åœºæ™¯æ—¶ï¼ŒMP çš„é€šç”¨æ–¹æ³•æ— æ³•æ»¡è¶³ã€‚
   - æ­¤æ—¶ï¼Œä½ ä»ç„¶éœ€è¦åƒä½¿ç”¨åŸç”Ÿ MyBatis ä¸€æ ·ï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„ Mapper æ–¹æ³•ï¼Œå¹¶åœ¨ XML ä¸­ç¼–å†™ SQL æˆ–ä½¿ç”¨ `@Select` ç­‰æ³¨è§£ã€‚è¿™å®Œå…¨æš´éœ²äº† SQLã€‚
4. **æ ¸å¿ƒç†å¿µæ˜¯â€œå¢å¼ºâ€è€Œéâ€œæ›¿ä»£â€ï¼š**
   - MyBatis-Plus çš„è®¾è®¡ç›®æ ‡æ˜¯â€œ**ä¸ºç®€åŒ–å¼€å‘è€Œç”Ÿ**â€ï¼Œå®ƒé€šè¿‡ `BaseMapper`ã€`Service` å±‚å°è£…ã€`Lambda` æŸ¥è¯¢ã€`è‡ªåŠ¨å¡«å……`ã€`é€»è¾‘åˆ é™¤` ç­‰åŠŸèƒ½ï¼Œ**æ¶ˆç­äº† 80% çš„ç®€å• CRUD SQL ç¼–å†™å·¥ä½œ**ã€‚
   - ä½†å®ƒä¿ç•™äº† MyBatis å¯¹ SQL çš„å®Œå…¨æ§åˆ¶åŠ›ï¼Œè®©å¼€å‘è€…åœ¨éœ€è¦æ—¶å¯ä»¥éšæ—¶ä»‹å…¥å¹¶ç¼–å†™é«˜æ€§èƒ½ã€å¤æ‚çš„ SQLã€‚

------

#### MyBatis-Plus å¦‚ä½•å®ç°â€œç±»å…¨è‡ªåŠ¨â€çš„ä¾¿æ·æ€§ï¼Ÿ

å°½ç®¡ä¸æ˜¯å…¨è‡ªåŠ¨ ORMï¼Œä½† MP é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°äº†æ¥è¿‘å…¨è‡ªåŠ¨çš„å¼€å‘æ•ˆç‡ï¼š

- **é€šç”¨ Mapper (`BaseMapper`)ï¼š** æä¾›äº† `insert`, `delete`, `update`, `select` ç­‰é€šç”¨æ–¹æ³•ï¼Œæ— éœ€ä»»ä½• SQL é…ç½®å³å¯ä½¿ç”¨ã€‚

- **é€šç”¨ Service (`IService`)ï¼š** åœ¨ `BaseMapper` åŸºç¡€ä¸Šï¼Œå°è£…äº†æ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ï¼Œå¦‚ `saveOrUpdate`, `list`, `page` ç­‰ã€‚

- **æ¡ä»¶æ„é€ å™¨** (QueryWrapper, LambdaQueryWrapper)ï¼š

   å…è®¸ä½ ç”¨ Java ä»£ç é“¾å¼ç¼–ç¨‹çš„æ–¹å¼æ¥æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼Œé¿å…äº†æ‹¼æ¥ SQL å­—ç¬¦ä¸²çš„éº»çƒ¦ã€‚è™½ç„¶æœ€ç»ˆä¼šç”Ÿæˆ SQLï¼Œä½†å¼€å‘è€…æ— éœ€ç›´æ¥å†™ SQL æ–‡æœ¬ã€‚

  ```java
  // ä½¿ç”¨ MP çš„ LambdaQueryWrapperï¼Œæ— éœ€å†™ SQL
  List<User> users = userMapper.selectList(
      new LambdaQueryWrapper<User>()
          .eq(User::getName, "å¼ ä¸‰")
          .gt(User::getAge, 18)
          .orderByDesc(User::getCreateTime)
  );
  // è¿™ä¼šè¢« MP ç¿»è¯‘æˆ: SELECT * FROM user WHERE name = 'å¼ ä¸‰' AND age > 18 ORDER BY create_time DESC
  ```

- **ä»£ç ç”Ÿæˆå™¨ï¼š** å¯ä»¥æ ¹æ®æ•°æ®åº“è¡¨ç»“æ„ä¸€é”®ç”Ÿæˆ Entityã€Mapperã€Serviceã€Controller ç­‰å…¨å¥—ä»£ç ï¼ŒåŒ…æ‹¬åŸºç¡€çš„ Mapper XMLã€‚

------

#### æ€»ç»“

| ç‰¹æ€§                      | Hibernate (å…¨è‡ªåŠ¨ ORM)        | MyBatis-Plus (MyBatis å¢å¼º)              |
| ------------------------- | ----------------------------- | ---------------------------------------- |
| **SQL ç”Ÿæˆ**              | è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆï¼Œå¯¹å¼€å‘è€…é€æ˜  | ä½¿ç”¨é¢„å®šä¹‰æ¨¡æ¿æˆ–æ¡ä»¶æ„é€ å™¨ç”Ÿæˆï¼ŒSQL å¯è§ |
| **SQL æ§åˆ¶**              | å¼±ï¼Œå—é™äº HQL å’Œæ¡†æ¶ç”Ÿæˆèƒ½åŠ› | **å¼º**ï¼Œå¯é€šè¿‡è‡ªå®šä¹‰ SQL å®Œå…¨æŒæ§        |
| **å¼€å‘ä¾¿æ·æ€§ (ç®€å•CRUD)** | â­â­â­â­â­                         | â­â­â­â­â­ (å€ŸåŠ© MP)                          |
| **å¼€å‘ä¾¿æ·æ€§ (å¤æ‚æŸ¥è¯¢)** | â­â­â­â­                          | â­â­â­ (ä»éœ€æ‰‹å†™ SQL)                       |
| **æ€§èƒ½ä¼˜åŒ–**              | ä¾èµ–æ¡†æ¶ï¼Œè¾ƒéš¾æ·±åº¦ä¼˜åŒ–        | å¯ç›´æ¥ä¼˜åŒ– SQLï¼Œæ€§èƒ½æ½œåŠ›é«˜               |
| **å­¦ä¹ æˆæœ¬**              | é«˜ (éœ€ç†è§£ ORM æ¦‚å¿µ)          | ä¸­ç­‰ (ç†Ÿæ‚‰ MyBatis + MP ç‰¹æ€§)            |

**ç»“è®ºï¼š** MyBatis-Plus **ä¸æ˜¯**å…¨è‡ªåŠ¨ ORMã€‚å®ƒæ˜¯åœ¨ MyBatis è¿™ä¸ªåŠè‡ªåŠ¨æ¡†æ¶çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æä¾›å¼ºå¤§çš„è‡ªåŠ¨åŒ–å·¥å…·å’Œé€šç”¨ç»„ä»¶ï¼Œ**æå¤§åœ°æå‡äº†å¼€å‘æ•ˆç‡ï¼Œè®©å¼€å‘è€…åœ¨äº«å— ORM ä¾¿æ·æ€§çš„åŒæ—¶ï¼Œä¾ç„¶ä¿ç•™äº†å¯¹ SQL çš„æœ€ç»ˆæ§åˆ¶æƒ**ã€‚å®ƒæ›´åƒæ˜¯ä¸€ä¸ªâ€œ**æ™ºèƒ½åŒ–çš„ SQL æ˜ å°„æ¡†æ¶**â€ï¼Œè€Œéä¸€ä¸ªçº¯ç²¹çš„â€œå¯¹è±¡å…³ç³»æ˜ å°„â€æ¡†æ¶ã€‚

### mvnçš„javaç‰ˆæœ¬ä¸ºä½•ä¸æ§åˆ¶å°è¾“å‡ºçš„ç‰ˆæœ¬ä¸åŒï¼Ÿ

è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°ç³»ç»Ÿä¸­å¤šä¸ªJavaç‰ˆæœ¬çš„å…±å­˜å’Œä½¿ç”¨ä¼˜å…ˆçº§ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š

####  ç¯å¢ƒå˜é‡é…ç½®å·®å¼‚

- **`java -version`** æ˜¾ç¤ºçš„æ˜¯ç³»ç»Ÿ `PATH` ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª `java` å‘½ä»¤ï¼Œè¿™é‡ŒæŒ‡å‘çš„æ˜¯ Java 22
- **`mvn -v`** æ˜¾ç¤ºçš„æ˜¯ Maven è¿è¡Œæ—¶ä½¿ç”¨çš„ Java ç¯å¢ƒï¼Œè¿™é‡Œé€šè¿‡ `JAVA_HOME` æŒ‡å‘äº† Java 11

####  å…·ä½“åŸå› åˆ†æ

1. **PATHç¯å¢ƒå˜é‡ä¼˜å…ˆçº§**
   - ç³»ç»Ÿ `PATH` ä¸­ Java 22 çš„è·¯å¾„æ’åœ¨å‰é¢
   - æ‰€ä»¥åœ¨å‘½ä»¤è¡Œç›´æ¥æ‰§è¡Œ `java` æ—¶ä½¿ç”¨çš„æ˜¯ Java 22

2. **Mavençš„Javaç‰ˆæœ¬é€‰æ‹©æœºåˆ¶**
   - Maven ä¼˜å…ˆä½¿ç”¨ `JAVA_HOME` ç¯å¢ƒå˜é‡æŒ‡å®šçš„Javaç‰ˆæœ¬
   - å¦‚æœ `JAVA_HOME` æœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨ `PATH` ä¸­çš„ `java` å‘½ä»¤

3. **ç¯å¢ƒå˜é‡é…ç½®**
   - `JAVA_HOME` = `C:\Program Files\Java\jdk-11`
   - `PATH` ä¸­åŒæ—¶åŒ…å«äº† Java 22 å’Œ Java 11 çš„è·¯å¾„

####  éªŒè¯æ–¹æ³•

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
echo %JAVA_HOME%
where java
```


è¿™ç§é…ç½®æ–¹å¼åœ¨å¼€å‘ç¯å¢ƒä¸­å¾ˆå¸¸è§ï¼Œå…è®¸ä¸åŒå·¥å…·ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„Javaè¿è¡Œæ—¶ã€‚

#### ä¿®æ”¹mvnçš„javaç‰ˆæœ¬

1. ä¿®æ”¹ç¯å¢ƒå˜é‡çš„`JAVA_HOME`

2. `mvn clean`å¹¶é€€å‡ºideï¼ˆå¦‚æœä½¿ç”¨ideï¼‰
3. é‡å¯åå†æ¬¡å°è¯•install

### Spring Bootåº”ç”¨å…³é—­æ—¶æ“ä½œ

åœ¨Spring Bootåº”ç”¨å…³é—­æ—¶åˆ é™¤Redisç¼“å­˜ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

1. **ä½¿ç”¨@PreDestroyæ³¨è§£**
   - åœ¨ä»»æ„Springç®¡ç†çš„Beanä¸­æ·»åŠ ä¸€ä¸ªå¸¦æœ‰`@PreDestroy`æ³¨è§£çš„æ–¹æ³•ï¼Œåœ¨åº”ç”¨å…³é—­å‰ä¼šè‡ªåŠ¨æ‰§è¡Œè¯¥æ–¹æ³•

```java
@Component
public class RedisCleanupService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @PreDestroy
    public void cleanUp() {
        // åˆ é™¤æŒ‡å®šçš„ç¼“å­˜é”®
        redisTemplate.delete("your-cache-key");
        // æˆ–è€…åˆ é™¤åŒ¹é…æ¨¡å¼çš„é”®
        // Set<String> keys = redisTemplate.keys("pattern*");
        // redisTemplate.delete(keys);
    }
}
```


2. **å®ç°DisposableBeanæ¥å£**

```java
@Component
public class RedisCleanupService implements DisposableBean {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public void destroy() throws Exception {
        // åº”ç”¨å…³é—­æ—¶æ‰§è¡Œæ¸…ç†å·¥ä½œ
        redisTemplate.delete("your-cache-key");
    }
}
```


3. **ç›‘å¬ContextClosedEventäº‹ä»¶**

```java
@Component
public class RedisCleanupListener {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @EventListener
    public void handleContextClosedEvent(ContextClosedEvent event) {
        // åº”ç”¨å…³é—­æ—¶åˆ é™¤Redisç¼“å­˜
        redisTemplate.delete("your-cache-key");
    }
}
```


æ¨èä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼(`@PreDestroy`)ï¼Œè¿™æ˜¯æœ€ç®€å•ä¸”å¸¸ç”¨çš„æ–¹å¼ã€‚ä½ éœ€è¦å°†æ¸…ç†é€»è¾‘æ”¾åœ¨Springç®¡ç†çš„ç»„ä»¶ä¸­ï¼Œå¹¶æ³¨å…¥`RedisTemplate`æ¥æ“ä½œRedisã€‚
