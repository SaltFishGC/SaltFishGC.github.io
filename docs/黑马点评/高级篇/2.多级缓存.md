---
title: å¤šçº§ç¼“å­˜
date: 2026-1-26
---

åœ¨æˆ‘ä»¬å…ˆå‰å­¦ä¹ çš„ç¼“å­˜ç»“æ„ä¸­ï¼Œæˆ‘ä»¬æ˜¯**åœ¨åç«¯æœåŠ¡å™¨ä¸­å®Œæˆå¯¹ç¼“å­˜å±‚çš„è°ƒç”¨**ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼šå‡å¦‚Springçš„**tomcatè¾¾åˆ°ä¸Šé™**äº†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´åé¢çš„ç¼“å­˜ä»¥åŠæ•°æ®åº“çš„ä¼˜åŒ–å¾—ä¸åˆ°å‘æŒ¥ï¼Œé™åˆ¶äº†é¡¹ç›®æ•´ä½“çš„æ€§èƒ½ã€‚

å› æ­¤ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå¯¹åç«¯æœåŠ¡ä¹ŸåšæŠ—å¹¶å‘ä»¥åŠæ€§èƒ½çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚é€šè¿‡Redissionç­‰æ–¹å¼æ„å»º**åˆ†å¸ƒå¼åç«¯**ï¼Œå°†æœåŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­æœåŠ¡ä»è€Œæ„å»º**å¾®æœåŠ¡**ã€‚

ä½†æŠ›å¼€åç«¯è‡ªå·±ï¼Œæˆ‘ä»¬å…¶å®è¿˜å¯ä»¥å‘å‰çœ‹ï¼Œåœ¨æ›´å‰é¢çš„**nginx**åå‘ä»£ç†å°±åŠ å…¥æ•°æ®ç¼“å­˜ï¼Œ**æå‰å¤„ç†æ‰ä¸€äº›ç®€å•çš„è¯·æ±‚**ï¼Œä»è€Œè¾¾åˆ°æ›´å¥½çš„é«˜å¹¶å‘æ€§èƒ½ã€‚ç”šè‡³æˆ‘ä»¬è¿˜å¯ä»¥å°†ä¸€äº›æ•°æ®ç›´æ¥ç¼“å­˜åœ¨å‰ç«¯æœ¬åœ°å¦‚æµè§ˆå™¨çš„storageç­‰ï¼Œå½“ç”¨æˆ·éœ€è¦æ—¶ç›´æ¥ä»æœ¬åœ°è·å–ã€‚

```mermaid
graph LR
    A[ç”¨æˆ·] --> B[æµè§ˆå™¨<br>å®¢æˆ·ç«¯ç¼“å­˜]
    B --> C[NGINX<br>æœ¬åœ°ç¼“å­˜]
    C -- ç¼“å­˜æœªå‘½ä¸­ --> D[Redis<br>ç¼“å­˜]
    D -- ç¼“å­˜æœªå‘½ä¸­ --> E[tomcatè¿›ç¨‹ç¼“å­˜]
    E -- ç¼“å­˜æœªå‘½ä¸­ --> F[æ•°æ®åº“]

    classDef client fill:#e6f7ff,stroke:#0066cc,stroke-width:2px;
    classDef nginx fill:#d4f5b8,stroke:#3c9c00,stroke-width:2px;
    classDef redis fill:#f8d5d5,stroke:#cc0000,stroke-width:2px;
    classDef app fill:#fffacd,stroke:#cc7a00,stroke-width:2px;
    classDef db fill:#d0d0d0,stroke:#333,stroke-width:2px;

    class B client;
    class C nginx;
    class D redis;
    class E app;
    class F db;
```

> Redisä¸ºä»€ä¹ˆä¼štomcatå‰é¢ï¼Ÿä¸åº”è¯¥äº¤ç”±tomcatçš„ä¸šåŠ¡å¤„ç†è°ƒç”¨å—ï¼Ÿ
> å…¶å®Nginxä¹Ÿå¯ä»¥åšä¸€äº›ä¸šåŠ¡å¤„ç†ï¼Œæˆ‘ä»¬åœ¨å®ŒæˆNginxçš„é›†ç¾¤æ­å»ºåï¼Œä¹Ÿå¯ä»¥å°†ä¸€å®šçš„ä¸šåŠ¡äº¤ç”±Nginxå¤„ç†ã€‚

æˆ‘ä»¬é€šè¿‡è¿™æ ·çš„å¤šçº§ç¼“å­˜æ¥ä¿è¯æ•°æ®å‹åŠ›çš„ç¼“è§£ã€‚

å…¶ä¸­**nginx**ï¼Œredisï¼Œtomcatéƒ½å¯ä»¥åšæˆ**é›†ç¾¤**çš„æ–¹å¼æ¥å®ç°æ›´åŠ å¼ºå¤§çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹å®ç°åœ¨è¿™ä¸ªå¤šçº§ç¼“å­˜é“¾è·¯ä¸Šå®ç°å„ä¸ªæ¨¡å—äº†

> å¯»å¸¸ä¸šåŠ¡è¿˜æ˜¯æ¨èrediså’Œæ•°æ®åº“å¤Ÿç”¨å°±è¡Œï¼Œå¯¹äºå¤šçº§ç¼“å­˜çš„ç»´æŠ¤ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ˜¯ä¸ªå¤§å·¥ç¨‹ï¼Œæ¯å¼€å‘ä¸€ä¸ªä¸šåŠ¡éƒ½è¦è€ƒè™‘åˆ°
>
> å½“ç„¶ç®€å•çš„è¿˜æ˜¯å¯ä»¥æ”¾åˆ°nginxé‡Œé¢çš„



### JVMè¿›ç¨‹ç¼“å­˜(Caffeine )

â€œJVM è¿›ç¨‹æœ¬åœ°ç¼“å­˜â€é€šå¸¸æ˜¯æŒ‡**è¿è¡Œåœ¨å•ä¸ª JVM è¿›ç¨‹å†…éƒ¨ã€ä»…å¯¹è¯¥è¿›ç¨‹å¯è§çš„ç¼“å­˜æœºåˆ¶**ï¼Œå®ƒä¸æ¶‰åŠè·¨è¿›ç¨‹æˆ–åˆ†å¸ƒå¼å…±äº«ï¼ˆå¦‚ Redisã€Memcachedï¼‰ï¼Œè€Œæ˜¯åˆ©ç”¨ JVM å †å†…å­˜ï¼ˆæˆ–å †å¤–å†…å­˜ï¼‰æ¥å­˜å‚¨ä¸´æ—¶æ•°æ®ï¼Œä»¥åŠ é€Ÿåº”ç”¨é€»è¾‘ã€å‡å°‘é‡å¤è®¡ç®—æˆ– IO å¼€é”€ã€‚

è¿™ç±»ç¼“å­˜å¹¿æ³›åº”ç”¨äº Java åº”ç”¨ä¸­ï¼Œæ˜¯**åº”ç”¨å±‚ç¼“å­˜**çš„ä¸€ç§å½¢å¼ï¼Œä½†å› å…¶ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨åŸŸé™å®šåœ¨å•ä¸ª JVM è¿›ç¨‹å†…ï¼Œå¸¸è¢«ç§°ä¸º **â€œæœ¬åœ°ç¼“å­˜â€ï¼ˆLocal Cacheï¼‰** æˆ– **â€œè¿›ç¨‹å†…ç¼“å­˜â€ï¼ˆIn-Process Cacheï¼‰**ã€‚

> **ç›¸æ¯”åˆ†å¸ƒå¼ç¼“å­˜**å¦‚Redisç­‰ï¼Œæ²¡æœ‰é€šä¿¡å¼€é”€ï¼Œä½†æ˜¯æ— æ³•æ”¯æŒ**å¤šæœºä¹‹é—´çš„é€šä¿¡**ï¼Œéœ€è¦è‡ªå·±å®ç°ï¼Œè€Œä¸”å¯é æ€§æ¯”è¾ƒå·®ï¼Œå®•æœºäº†å°±æ²¡äº†ã€‚

æˆ‘ä»¬çš„Javaæœ€å¥½çš„ç‰¹æ€§å°±æ˜¯å°è£…å¥½ä¸”ç”Ÿæ€å¥½ï¼Œå½“æˆ‘ä»¬æƒ³åˆ°æŸä¸€æ–¹é¢æ—¶ï¼Œå»æ‰¾æ‰¾æ˜¯å¦æœ‰å‰äººåšè¿‡å¾€å¾€éƒ½èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå·²ç»å¤§è‡´å®Œæˆçš„æ¡†æ¶ï¼Œè€Œå¯¹äºæˆ‘ä»¬ç°åœ¨è¦å®Œæˆçš„è¿›ç¨‹ç¼“å­˜ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰è¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œé‚£å°±æ˜¯**Caffeine**ï¼š

> ä½¿ç”¨è°¨æ…ï¼Œcrudéƒ½è¦å¸¦ä¸Šå¯¹äºè¿™ä¸€éƒ¨åˆ†çš„æ•°æ®æ›´æ–°ï¼Œåç»­ç»´æŠ¤ä¹Ÿå¥½ï¼Œèµ„æºå¼€é”€ä¹Ÿå¥½ï¼Œéƒ½éœ€è¦æå‰å‡†å¤‡å¥½
> **å•æœº**ä¸‹ç”¨çš„å¤šï¼Œå¤šæœºå°¤å…¶æ˜¯åˆ†å¸ƒå¼ä¸‹ç»´æŠ¤éº»çƒ¦ï¼ŒåŸºæœ¬ä¸ç”¨

| ç‰¹æ€§                 | è¯´æ˜                                                         |
| :------------------- | :----------------------------------------------------------- |
| âœ… **é«˜æ€§èƒ½**         | åŸºäº **Window TinyLFU** æ·˜æ±°ç®—æ³•ï¼Œåœ¨å‘½ä¸­ç‡å’Œå†…å­˜æ•ˆç‡ä¸Šä¼˜äº LRU/LFUã€‚ |
| âœ… **çº¿ç¨‹å®‰å…¨**       | æ‰€æœ‰æ“ä½œå¤©ç„¶çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€é¢å¤–åŒæ­¥ã€‚                         |
| âœ… **è‡ªåŠ¨åŠ è½½/åˆ·æ–°**  | æ”¯æŒ `get(key, mappingFunction)` è‡ªåŠ¨åŠ è½½ï¼Œä»¥åŠåŸºäºæ—¶é—´çš„å¼‚æ­¥åˆ·æ–°ã€‚ |
| âœ… **çµæ´»çš„è¿‡æœŸç­–ç•¥** | æ”¯æŒåŸºäºå†™å…¥æ—¶é—´ï¼ˆTTLï¼‰ã€è®¿é—®æ—¶é—´ï¼ˆTTIï¼‰ã€å¼±/è½¯å¼•ç”¨ç­‰ã€‚      |
| âœ… **å¼‚æ­¥ API**       | æä¾› `AsyncLoadingCache`ï¼Œæ”¯æŒéé˜»å¡å¼ç¼“å­˜æ“ä½œã€‚             |
| âœ… **ç»Ÿè®¡ç›‘æ§**       | å†…ç½®å‘½ä¸­ç‡ã€åŠ è½½æ¬¡æ•°ã€å¹³å‡åŠ è½½æ—¶é—´ç­‰æŒ‡æ ‡ï¼Œä¾¿äºå¯è§‚æµ‹æ€§ã€‚     |

**Mavené…ç½®ï¼š**

```xml
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>3.1.8</version> <!-- æ¨èä½¿ç”¨æœ€æ–°ç‰ˆ -->
</dependency>
```

> è¯¦ç»†è§jdkç‰ˆæœ¬å¯¹åº”è¡¨

**ç¤ºä¾‹ï¼š**

æ‰‹åŠ¨åŠ è½½ç¼“å­˜ï¼š

```java
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;

Cache<String, String> cache = Caffeine.newBuilder()
    .maximumSize(1000)               // æœ€å¤šç¼“å­˜ 1000 é¡¹
    .expireAfterWrite(10, TimeUnit.MINUTES) // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ
    .build();

cache.put("key1", "value1");
String value = cache.getIfPresent("key1"); // è‹¥ä¸å­˜åœ¨è¿”å› null
```

è‡ªåŠ¨åŠ è½½ç¼“å­˜ï¼š

```java
import com.github.benmanes.caffeine.cache.LoadingCache;

LoadingCache<String, User> userCache = Caffeine.newBuilder()
    .maximumSize(10_000)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .build(key -> loadUserFromDatabase(key)); // è‡ªåŠ¨åŠ è½½å‡½æ•°

User user = userCache.get("userId123"); // è‹¥ç¼“å­˜æ— ï¼Œåˆ™è°ƒç”¨ loadUserFromDatabase
```

å¼‚æ­¥æäº¤ç¼“å­˜ï¼š

```java
AsyncLoadingCache<String, User> asyncCache = Caffeine.newBuilder()
    .maximumSize(10_000)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .buildAsync(key -> CompletableFuture.supplyAsync(() -> loadUserFromDB(key)));

CompletableFuture<User> future = asyncCache.get("userId123");
User user = future.join(); // æˆ–é€šè¿‡ thenApply å¤„ç†
```

| é…ç½®æ–¹æ³•                      | ä½œç”¨                                               |
| :---------------------------- | :------------------------------------------------- |
| `maximumSize(long)`           | è®¾ç½®ç¼“å­˜æœ€å¤§æ¡ç›®æ•°ï¼ˆåŸºäºæƒé‡å¯é… `maximumWeight`ï¼‰ |
| `expireAfterAccess(duration)` | æœ€åä¸€æ¬¡è¯»/å†™åå¤šä¹…è¿‡æœŸï¼ˆTTIï¼‰                     |
| `expireAfterWrite(duration)`  | å†™å…¥åå¤šä¹…è¿‡æœŸï¼ˆTTLï¼‰                              |
| `refreshAfterWrite(duration)` | å†™å…¥åå¤šä¹…**å¼‚æ­¥åˆ·æ–°**ï¼ˆä¸ä¼šé˜»å¡è¯»ï¼‰               |
| `weakKeys()` / `weakValues()` | ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆGC å¯å›æ”¶ï¼‰                            |
| `softValues()`                | ä½¿ç”¨è½¯å¼•ç”¨ï¼ˆå†…å­˜ä¸è¶³æ—¶å›æ”¶ï¼‰âš ï¸ ä¸æ¨èï¼Œè¡Œä¸ºä¸å¯æ§   |
| `recordStats()`               | å¯ç”¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯é€šè¿‡ `cache.stats()` æŸ¥çœ‹ï¼‰        |

> ğŸ’¡ æ³¨æ„ï¼š`expireAfterWrite` å’Œ `refreshAfterWrite` å¯åŒæ—¶ä½¿ç”¨ã€‚
>
> - è¿‡æœŸåä¸‹æ¬¡è®¿é—®ä¼šè§¦å‘åŠ è½½ï¼›
> - åˆ·æ–°åˆ™æ˜¯åœ¨åå°å¼‚æ­¥æ›´æ–°ï¼Œæ—§å€¼ä»å¯è¯»ã€‚

**é¡¹ç›®ä¸­åˆ©ç”¨Beanæ³¨å…¥å®ç°å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®ä¸€è‡´ï¼š**

```java
@Configuration
@EnableCaching // å¯ç”¨ Spring Cacheï¼ˆå¯é€‰ï¼Œå¦‚æœä½ ä¹Ÿç”¨ @Cacheableï¼‰
public class CacheConfig {

    /**
     * åˆ›å»ºå…¨å±€ UserInfo ç¼“å­˜ Bean
     */
    @Bean
    public LoadingCache<String, UserInfo> userInfoCache() {
        return Caffeine.newBuilder()
                .maximumSize(10_000)                          // æœ€å¤šç¼“å­˜ 1 ä¸‡ä¸ªç”¨æˆ·
                .expireAfterWrite(10, TimeUnit.MINUTES)       // å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ
                .recordStats()                                // å¯ç”¨ç»Ÿè®¡ï¼ˆç”¨äºç›‘æ§ï¼‰
                .build(this::loadUserInfoFromSource);         // è‡ªåŠ¨åŠ è½½å‡½æ•°
    }

    /**
     * æ¨¡æ‹Ÿä»æ•°æ®åº“/è¿œç¨‹æœåŠ¡åŠ è½½ UserInfo
     * å®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºä½ çš„ UserService æˆ– FeignClient è°ƒç”¨
     */
    private UserInfo loadUserInfoFromSource(String userId) {
        // TODO: æ›¿æ¢ä¸ºçœŸå®é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
        // return userService.getUserById(userId);
        // å¦‚æœæŸ¥ä¸åˆ°ï¼Œå¯æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› nullï¼ˆCaffeine ä¸ä¼šç¼“å­˜ nullï¼‰

        if ("invalid".equals(userId)) {
            throw new IllegalArgumentException("User not found: " + userId);
        }
        return new UserInfo(userId, "Name-" + userId, userId + "@example.com");
    }
}
```

ç„¶ååœ¨Serviceä¸­ä½¿ç”¨ï¼š

```java
@Service
public class UserService {

    @Autowired
    private LoadingCache<String, UserInfo> userInfoCache;

    // ...
}
```

ä½†æ˜¯è¿™æ ·åšå¸¸å¸¸ä¼šé‡åˆ°æ³¨å…¥å¤±è´¥çš„é—®é¢˜ï¼š**å­˜åœ¨å¤šä¸ª** `LoadingCache<...>` **Beanï¼Œæ³¨å…¥æ—¶ç±»å‹å†²çª**

```java
@Bean LoadingCache<String, UserInfo> userInfoCache() { ... }
@Bean LoadingCache<Long, Product> productCache() { ... }
```

è™½ç„¶æ³›å‹ä¸åŒï¼Œä½†**Java æ³›å‹åœ¨è¿è¡Œæ—¶ä¼šè¢«æ“¦é™¤**ï¼ŒSpring çœ‹åˆ°çš„éƒ½æ˜¯ `LoadingCache`ï¼Œå¯èƒ½æ— æ³•åŒºåˆ†ã€‚

âœ… **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ **`@Qualifier`** æŒ‡å®š Bean åç§°

```java
// å®šä¹‰æ—¶ï¼ˆBean åç§°ä¸ºæ–¹æ³•å "userInfoCache"ï¼‰
@Bean
public LoadingCache<String, UserInfo> userInfoCache() { ... }

// æ³¨å…¥æ—¶
@Service
public class UserService {

    @Autowired
    @Qualifier("userInfoCache") // æ˜¾å¼æŒ‡å®š
    private LoadingCache<String, UserInfo> cache;
}
```

> ğŸ’¡ æ›´ä¼˜é›…çš„æ–¹å¼ï¼š**å°è£…ä¸ºè‡ªå®šä¹‰ç±»å‹**ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚

```java
// è‡ªå®šä¹‰ç¼“å­˜ç±»å‹ï¼Œç»§æ‰¿æˆ–åŒ…è£…
@Component
public class UserInfoCache {
    private final LoadingCache<String, UserInfo> cache;

    public UserInfoCache() {
        this.cache = Caffeine.newBuilder()
                .maximumSize(1000)
                .expireAfterWrite(10, TimeUnit.MINUTES)
                .build(this::loadUser);
    }

    public UserInfo get(String userId) {
        return cache.get(userId);
    }

    public void invalidate(String userId) {
        cache.invalidate(userId);
    }

    private UserInfo loadUser(String userId) {
        // ...
    }
}
```

æœ€åæ³¨æ„å¤šä¸ªæœåŠ¡ï¼ˆçº¿ç¨‹ä¹‹é—´é€šè¿‡Beanæ³¨å…¥ä¿è¯ä¸€è‡´ï¼‰ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ**ä¸è¦å°†å¯èƒ½ä¼šåœ¨å¤šæœºé›†ç¾¤ä¸­äº§ç”Ÿå˜åŒ–çš„æ•°æ®æ”¾åˆ°jvmçº¿ç¨‹ç¼“å­˜é‡Œï¼**è¿˜æ˜¯æ¨èåœ¨**å•æœºåç«¯æœåŠ¡é¡¹ç›®ä¸­ä½¿ç”¨**ï¼Œå¤šæœºé¡¹ç›®ä¸‹è°¨æ…ä½¿ç”¨ï¼







### luaç®€å•è®¤è¯†

#### æ•°æ®ç»“æ„

| ç±»å‹       | ç¤ºä¾‹                 | è¯´æ˜                                        |
| :--------- | :------------------- | :------------------------------------------ |
| `nil`      | `x = nil`            | è¡¨ç¤ºâ€œç©ºâ€æˆ–â€œæœªåˆå§‹åŒ–â€                        |
| `boolean`  | `true`, `false`      | å¸ƒå°”å€¼                                      |
| `number`   | `3.14`, `-42`        | **ç»Ÿä¸€ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°**ï¼ˆæ²¡æœ‰æ•´å‹/æµ®ç‚¹ä¹‹åˆ†ï¼‰ |
| `string`   | `"hello"`, `'world'` | ä¸å¯å˜å­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šè¡Œ `[[...]]`            |
| `function` | `function() end`     | ä¸€ç­‰å…¬æ°‘ï¼Œå¯èµ‹å€¼ã€ä¼ å‚                      |
| `table`    | `{}`                 | **å”¯ä¸€å¤åˆæ•°æ®ç»“æ„ï¼ä¸‡èƒ½ï¼**                |
| `thread`   | â€”â€”                   | åç¨‹ï¼ˆcoroutineï¼‰ï¼Œä¸æ˜¯ OS çº¿ç¨‹             |
| `userdata` | â€”â€”                   | ç”¨äº C æ‰©å±•ï¼Œå­˜å‚¨ C æŒ‡é’ˆ                    |

> ğŸ” ç”¨ `type(x)` æŸ¥çœ‹å˜é‡ç±»å‹ï¼š

```lua
print(type(42))        --> number
print(type("hi"))      --> string
print(type({}))        --> table
```



Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡ä¸éœ€è¦æå‰å£°æ˜ç±»å‹ï¼Œèµ‹å€¼å³å®šä¹‰ï¼š

```lua
x = 10          -- numberï¼ˆæ•°å­—ï¼‰
name = "Lua"    -- stringï¼ˆå­—ç¬¦ä¸²ï¼‰
ok = true       -- booleanï¼ˆå¸ƒå°”ï¼‰
nothing = nil   -- nilï¼ˆè¡¨ç¤ºâ€œæ— â€æˆ–â€œæœªå®šä¹‰â€ï¼‰
```

> âœ… æ‰€æœ‰å˜é‡é»˜è®¤æ˜¯ **å…¨å±€å˜é‡**ï¼
> âŒ è¿™å®¹æ˜“é€ æˆæ±¡æŸ“ï¼Œ**å¼ºçƒˆå»ºè®®ç”¨ `local` å£°æ˜å±€éƒ¨å˜é‡**ï¼š

```lua
local age = 25   -- æ¨èï¼ä½œç”¨åŸŸä»…é™å½“å‰å—
```



#### **æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šTableï¼ˆè¡¨ï¼‰**

> ğŸ’¡ **Table æ˜¯ Lua ä¸­å”¯ä¸€çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒèƒ½æ¨¡æ‹Ÿå‡ ä¹æ‰€æœ‰ä½ éœ€è¦çš„ç»“æ„ï¼**

 **1.** ***\*æœ¬è´¨ï¼šå…³è”æ•°ç»„ï¼ˆå“ˆå¸Œè¡¨ + æ•°ç»„æ··åˆï¼‰\****

- é”®ï¼ˆkeyï¼‰å¯ä»¥æ˜¯ **é™¤ `nil` å’Œ `NaN` å¤–çš„ä»»æ„ç±»å‹**ï¼ˆåŒ…æ‹¬å‡½æ•°ã€è¡¨ï¼‰ï¼›
- å€¼ï¼ˆvalueï¼‰å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼›
- è‡ªåŠ¨æ‰©å®¹ï¼Œæ— éœ€é¢„å®šä¹‰å¤§å°ã€‚

------

 **2.** ***\*ä¸¤ç§å¸¸è§ç”¨æ³•\****

 **âœ… (1) å½“ä½œ** ***\*æ•°ç»„ï¼ˆArrayï¼‰\****

- ä½¿ç”¨**æ­£æ•´æ•°ç´¢å¼•**ï¼ˆæ³¨æ„ï¼š**ä» 1 å¼€å§‹ï¼ä¸æ˜¯ 0**ï¼‰

```lua
local fruits = {"apple", "banana", "cherry"}
print(fruits[1]) --> "apple"
print(#fruits)   --> 3ï¼ˆè·å–æ•°ç»„é•¿åº¦ï¼‰
```

 **âœ… (2) å½“ä½œ** ***\*å­—å…¸ / å¯¹è±¡ï¼ˆDictionary / Mapï¼‰\****

- ä½¿ç”¨å­—ç¬¦ä¸²æˆ–å…¶ä»–ç±»å‹ä½œä¸º key

```lua
local person = {
    name = "Alice",
    age = 30,
    is_admin = true
}
print(person.name)      --> "Alice"
print(person["age"])    --> 30
```

 **âœ… (3) æ··åˆä½¿ç”¨ï¼ˆå®Œå…¨åˆæ³•ï¼ï¼‰**

```lua
local mixed = {
    "first",           -- [1] = "first"
    key = "value",     -- ["key"] = "value"
    42,                -- [2] = 42
    {nested = true}    -- [3] = {nested=true}
}
```

------

 **3.** ***\*Table æ˜¯å¼•ç”¨ç±»å‹\****

- èµ‹å€¼æ˜¯**å¤åˆ¶å¼•ç”¨**ï¼Œä¸æ˜¯æ·±æ‹·è´ï¼š

```lua
local a = {x = 1}
local b = a
b.x = 99
print(a.x) --> 99ï¼ˆa å’Œ b æŒ‡å‘åŒä¸€ä¸ªè¡¨ï¼ï¼‰
```

------

 **4.** ***\*Table å¯ä»¥å½“â€œå¯¹è±¡â€ç”¨ï¼ˆæ¨¡æ‹Ÿ OOPï¼‰\****

```lua
-- å®šä¹‰â€œç±»â€
local Dog = {}
function Dog:new(name)
    local obj = {name = name}
    setmetatable(obj, self)
    self.__index = self
    return obj
end

function Dog:bark()
    print(self.name .. " says woof!")
end

-- ä½¿ç”¨
local my_dog = Dog:new("Buddy")
my_dog:bark() --> "Buddy says woof!"
```

------



#### **å…¶ä»–â€œä¼ªâ€æ•°æ®ç»“æ„ï¼ˆéƒ½åŸºäº Table å®ç°ï¼‰**

| éœ€æ±‚                 | Lua å®ç°æ–¹å¼                                                 |
| :------------------- | :----------------------------------------------------------- |
| **åˆ—è¡¨ / æ ˆ / é˜Ÿåˆ—** | ç”¨æ•°ç»„å¼ table + `table.insert()` / `table.remove()`         |
| **é›†åˆï¼ˆSetï¼‰**      | ç”¨å­—å…¸å¼ tableï¼Œå€¼è®¾ä¸º `true`ï¼š `set = {apple=true, banana=true}` |
| **æ¨¡å—ï¼ˆModuleï¼‰**   | è¿”å›ä¸€ä¸ª tableï¼š `return { func1 = ..., func2 = ... }`       |



#### å¾ªç¯éå†

| è¿­ä»£æ–¹å¼        | ç”¨é€”        | æ˜¯å¦æœ‰åº | èƒ½å¦è·³è¿‡ nil                      | å…¸å‹åœºæ™¯       |
| :-------------- | :---------- | :------- | :-------------------------------- | :------------- |
| `for i = 1, #t` | æ•°ç»„éå†    | âœ… æœ‰åº   | âŒ é‡ nil ä¸åœï¼ˆä½† `#t` å¯èƒ½ä¸å‡†ï¼‰ | ç¡®å®šæ˜¯è¿ç»­æ•°ç»„ |
| `ipairs(t)`     | æ•°ç»„éå†    | âœ… æœ‰åº   | âœ… é‡ nil åœæ­¢                     | å®‰å…¨éå†æ•°ç»„   |
| `pairs(t)`      | å­—å…¸/æ··åˆè¡¨ | âŒ æ— åº   | âœ… è·³è¿‡ nil                        | éå†æ‰€æœ‰å­—æ®µ   |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š
>
> - å¦‚æœæ˜¯**çº¯æ•°ç»„** â†’ ç”¨ `ipairs`
> - å¦‚æœæ˜¯**å¯¹è±¡/å­—å…¸** â†’ ç”¨ `pairs`
> - å¦‚æœéœ€è¦**ä¸¥æ ¼æŒ‰ç´¢å¼• 1ï½n** ä¸”çŸ¥é“é•¿åº¦ â†’ ç”¨æ•°å€¼ for

**æ•°ç»„ï¼š**

```lua
local fruits = {"apple", "banana", "cherry"}
for i = 1, #fruits do
    print(i, fruits[i])
end
-- è¾“å‡º:
-- 1    apple
-- 2    banana
-- 3    cherry
```



**æ•°ç»„ï¼ˆé‡åˆ°nilå°±åœï¼‰ï¼š**

```lua
local colors = {"red", "green", "blue"}

for index, value in ipairs(colors) do
    print(index, value)
end
-- è¾“å‡º:
-- 1    red
-- 2    green
-- 3    blue
```



**å­—å…¸ï¼š**

```lua
local person = {
    name = "Alice",
    age = 30,
    city = "Beijing"
}

for key, value in pairs(person) do
    print(key, value)
end
-- å¯èƒ½è¾“å‡ºï¼ˆé¡ºåºä¸å®šï¼‰:
-- name    Alice
-- age     30
-- city    Beijing
```



#### å‡½æ•°ä¸æ¡ä»¶

| ç‰¹æ€§            | Lua å†™æ³•                         | å…³é”®ç‚¹                  |
| :-------------- | :------------------------------- | :---------------------- |
| **å‡½æ•°å®šä¹‰**    | `function name(...) ... end`     | æ”¯æŒå¤šè¿”å›å€¼ã€å¯å˜å‚æ•°  |
| **åŒ¿åå‡½æ•°**    | `function(...) ... end`          | å¯èµ‹å€¼ã€ä¼ å‚            |
| **æ¡ä»¶åˆ¤æ–­**    | `if ... elseif ... else ... end` | åªæœ‰ `false`/`nil` ä¸ºå‡ |
| **æ²¡æœ‰ switch** | ç”¨ `if-elseif` æˆ–è¡¨åˆ†å‘          | è¡¨åˆ†å‘æ€§èƒ½é«˜ã€å¯æ‰©å±•    |

**å‡½æ•°ï¼š**ï¼ˆå•å˜é‡ä¼ çš„æ˜¯è™šå‚**å‡ºæ¥ä¸å˜**ï¼Œtableä¼ å¼•ç”¨**å‡ºæ¥ä¼šå˜**ï¼‰

```lua
function å‡½æ•°å(å‚æ•°1, å‚æ•°2, ...)
    -- å‡½æ•°ä½“
    return è¿”å›å€¼  -- å¯é€‰ï¼Œå¯è¿”å›å¤šä¸ªå€¼
end
```



**æ¡ä»¶ï¼š**

```lua
if æ¡ä»¶1 then
    -- æ¡ä»¶1ä¸ºçœŸæ—¶æ‰§è¡Œ
elseif æ¡ä»¶2 then
    -- æ¡ä»¶2ä¸ºçœŸæ—¶æ‰§è¡Œ
else
    -- éƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œ
end
```

> âœ… **åªæœ‰ `false` å’Œ `nil` æ˜¯â€œå‡â€ï¼Œå…¶ä»–ä¸€åˆ‡ï¼ˆåŒ…æ‹¬ 0ã€ç©ºå­—ç¬¦ä¸² ""ï¼‰éƒ½æ˜¯â€œçœŸâ€ï¼**

é€»è¾‘è¿ç®—ç¬¦ï¼š

| è¿ç®—ç¬¦    | è¡Œä¸º   | è¿”å›å€¼                     |
| :-------- | :----- | :------------------------- |
| `not x`   | å–å   | **æ€»æ˜¯ `true`/`false`**    |
| `a and b` | çŸ­è·¯ä¸ | `a`ï¼ˆè‹¥ a ä¸ºå‡ï¼‰ï¼Œå¦åˆ™ `b` |
| `a or b`  | çŸ­è·¯æˆ– | `a`ï¼ˆè‹¥ a ä¸ºçœŸï¼‰ï¼Œå¦åˆ™ `b` |







### OpenResty

**OpenResty** æ˜¯ä¸€ä¸ªåŸºäº **Nginx + Lua** çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œè®©ä½ èƒ½ç”¨ **Lua è„šæœ¬ç›´æ¥åœ¨ Nginx å†…éƒ¨ç¼–å†™ä¸šåŠ¡é€»è¾‘**ï¼Œå®ç°è¶…é«˜æ€§èƒ½çš„åŠ¨æ€ç½‘å…³ã€API æœåŠ¡ã€åå‘ä»£ç†ç­‰ã€‚

#### å®‰è£…ä¸é…ç½®

```bash
# æ·»åŠ å®˜æ–¹æºï¼ˆUbuntu/Debianï¼‰
wget -O - https://openresty.org/package/pubkey.gpg | sudo gpg --dearmor -o /usr/share/keyrings/openresty.gpg
echo "deb [signed-by=/usr/share/keyrings/openresty.gpg] http://openresty.org/package/debian  $ (lsb_release -sc) openresty" | sudo tee /etc/apt/sources.list.d/openresty.list

sudo apt update
sudo apt install openresty

# å®‰è£…openrestyçš„maven/npm
sudo apt openresty-opm
```

confé…ç½®æ ·ä¾‹ï¼š

```nginx
# /usr/local/openresty/nginx/conf/nginx.conf

worker_processes auto;
error_log logs/error.log warn;
pid logs/nginx.pid;

events {
    worker_connections 1024;
    use epoll;  # Linux é«˜æ€§èƒ½ç½‘ç»œæ¨¡å‹
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format main ' $ remote_addr -  $ remote_user [ $ time_local] '
                    '" $ request"  $ status  $ body_bytes_sent '
                    '" $ http_referer" " $ http_user_agent" '
                    'rt= $ request_time uct=" $ upstream_connect_time" '
                    'uht=" $ upstream_header_time" urt=" $ upstream_response_time"';

    access_log logs/access.log main;

    # ========================
    # å…¨å±€å…±äº«å†…å­˜å­—å…¸ï¼ˆç”¨äºé™æµã€ç¼“å­˜ï¼‰
    # ========================
    lua_shared_dict rate_limit_store 10m;   # é™æµè®¡æ•°å™¨
    lua_shared_dict user_cache 50m;         # ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

    # ========================
    # åç«¯æœåŠ¡ upstreamï¼ˆå¸¦å¥åº·æ£€æŸ¥ï¼‰
    # ========================
    upstream backend_servers {
        server backend1:8080 max_fails=2 fail_timeout=10s;
        server backend2:8080 max_fails=2 fail_timeout=10s;
        server backend3:8080 max_fails=2 fail_timeout=10s;
        keepalive 32;  # é•¿è¿æ¥æ± 
    }

    # ========================
    # å…¨å±€ Lua åŒ…è·¯å¾„
    # ========================
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    server {
        listen 80;
        server_name api.example.com;

        # ========================
        # å…¨å±€é™æµï¼šæ¯ IP æ¯ç§’ 100 è¯·æ±‚
        # ========================
        access_by_lua_block {
            local limit_req = require "resty.limit.req"
            local lim, err = limit_req.new("rate_limit_store", 100, 1) -- 100 req/sec
            if not lim then
                ngx.log(ngx.ERR, "failed to instantiate a limit_req object: ", err)
                return ngx.exit(500)
            end

            local key = ngx.var.binary_remote_addr
            local delay, err = lim:incoming(key, true)
            if not delay then
                if err == "rejected" then
                    ngx.log(ngx.WARN, "rate limit rejected for ", key)
                    return ngx.exit(429)
                end
                ngx.log(ngx.ERR, "failed to limit req: ", err)
                return ngx.exit(500)
            end

            if delay > 0 then
                ngx.sleep(delay)  -- å¹³æ»‘é™æµï¼ˆå¯é€‰ï¼‰
            end
        }

        # ========================
        # JWT é‰´æƒï¼ˆå‡è®¾ Authorization: Bearer <token>ï¼‰
        # ========================
        location /api/ {
            access_by_lua_block {
                local cjson = require "cjson.safe"
                local jwt = require "resty.jwt"

                local auth_header = ngx.req.get_headers()["Authorization"]
                if not auth_header or not string.find(auth_header, "Bearer ") then
                    ngx.status = 401
                    ngx.say('{"error": "Missing or invalid Authorization header"}')
                    return ngx.exit(401)
                end

                local token = string.sub(auth_header, 8)  -- remove "Bearer "
                local verified = jwt:verify("your-secret-key", token)

                if not verified.verified then
                    ngx.status = 401
                    ngx.say('{"error": "Invalid token"}')
                    return ngx.exit(401)
                end

                -- å¯é€‰ï¼šå°†ç”¨æˆ· ID æ³¨å…¥è¯·æ±‚å¤´ç»™åç«¯
                local payload = verified.payload
                if payload and payload.user_id then
                    ngx.req.set_header("X-User-ID", payload.user_id)
                end
            }

            # ========================
            # ä»£ç†åˆ°åç«¯
            # ========================
            location ï½ ^/api/(.*) $  {
                proxy_pass http://backend_servers/ $ 1 $ is_args $ args;
                proxy_set_header Host  $ host;
                proxy_set_header X-Real-IP  $ remote_addr;
                proxy_set_header X-Forwarded-For  $ proxy_add_x_forwarded_for;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
            }
        }

        # ========================
        # å¥åº·æ£€æŸ¥æ¥å£ï¼ˆä¾›å¤–éƒ¨ LB ä½¿ç”¨ï¼‰
        # ========================
        location /health {
            access_log off;
            default_type 'text/plain';
            content_by_lua_block {
                ngx.say("OK")
                ngx.exit(200)
            }
        }

        # ========================
        # é”™è¯¯é¡µé¢ç»Ÿä¸€å¤„ç†
        # ========================
        error_page 404 /404.json;
        location = /404.json {
            internal;
            default_type application/json;
            content_by_lua_block {
                ngx.say('{"code":404,"message":"Not Found"}')
            }
        }

        error_page 500 502 503 504 /5xx.json;
        location = /5xx.json {
            internal;
            default_type application/json;
            content_by_lua_block {
                ngx.say('{"code":500,"message":"Internal Server Error"}')
            }
        }
    }
}
```



#### è¯·æ±‚è§£ææµç¨‹

**Nginx åœ¨æ”¶åˆ° HTTP è¯·æ±‚åï¼Œä¼šè‡ªåŠ¨è§£æè¯·æ±‚è¡Œä¸­çš„ URIï¼ˆè·¯å¾„ï¼‰ï¼Œç„¶åé€ä¸ªåŒ¹é… `server` å—ä¸­çš„ `location` æŒ‡ä»¤ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„ä¸€ä¸ªæ¥å¤„ç†è¯¥è¯·æ±‚ã€‚**

 **ç¬¬ä¸€æ­¥ï¼šæ¥æ”¶è¯·æ±‚**

å®¢æˆ·ç«¯å‘é€ï¼š

```http
GET /api/user/123?debug=true HTTP/1.1
Host: example.com
```

Nginx è§£æå‡ºï¼š

- **Host**: `example.com`
- **URIï¼ˆè·¯å¾„ï¼‰**: `/api/user/123`
- **Query String**: `?debug=true`

------

 **ç¬¬äºŒæ­¥ï¼šé€‰æ‹©** `server` **å—ï¼ˆåŸºäº** `Host` **å’Œç«¯å£ï¼‰**

```nginx
server {
    listen 80;
    server_name example.com;  # â† åŒ¹é… Host å¤´
    ...
}
```

> âœ… åªæœ‰ `server_name` åŒ¹é…çš„ `server` å—æ‰ä¼šè¢«é€‰ä¸­ã€‚

------

 **ç¬¬ä¸‰æ­¥ï¼šåœ¨é€‰ä¸­çš„** `server` **ä¸­åŒ¹é…** `location`

Nginx æ‹¿åˆ° URI `/api/user/123`ï¼Œå¼€å§‹**æŒ‰è§„åˆ™åŒ¹é… `location`**ï¼š

```nginx
server {
    location / {
        # æ‰€æœ‰è¯·æ±‚éƒ½åŒ¹é…ï¼ˆå‰ç¼€åŒ¹é…ï¼‰
    }

    location /api/ {
        # æ›´ç²¾ç¡®ï¼šä»¥ /api/ å¼€å¤´çš„è¯·æ±‚
    }

    location = /health {
        # ç²¾ç¡®åŒ¹é… /health
    }

    location ï½ /user/(\d+) {
        # æ­£åˆ™åŒ¹é…ï¼Œæ•è·æ•°å­—
    }
}
```

> ğŸ¯ Nginx ä¼šé€‰æ‹©**æœ€åŒ¹é…**çš„ `location`ï¼ˆéµå¾ªä¼˜å…ˆçº§è§„åˆ™ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚

| ç±»å‹                           | ç¤ºä¾‹                      | è¯´æ˜                                        |
| :----------------------------- | :------------------------ | :------------------------------------------ |
| **`=` ç²¾ç¡®åŒ¹é…**               | `location = /status`      | å®Œå…¨ç›¸ç­‰æ‰åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰                |
| **`^ï½` å‰ç¼€åŒ¹é…ï¼ˆç¦æ­¢æ­£åˆ™ï¼‰** | `location ^ï½ /static/`   | åŒ¹é…å‰ç¼€ï¼Œä¸”ä¸å†æ£€æŸ¥æ­£åˆ™                    |
| **`ï½` / `ï½\*` æ­£åˆ™åŒ¹é…**     | `location ï½ /user/(\d+)` | `ï½` åŒºåˆ†å¤§å°å†™ï¼Œ`ï½*` ä¸åŒºåˆ†               |
| **æ™®é€šå‰ç¼€åŒ¹é…**               | `location /api/`          | æœ€é•¿å‰ç¼€åŒ¹é…ï¼ˆå¦‚ `/api/v2` æ¯” `/api` æ›´ä¼˜ï¼‰ |

> âœ… **ä¸€æ—¦åŒ¹é…æˆåŠŸï¼ŒNginx å°±åœ¨è¿™ä¸ª `location` å—ä¸­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå¦‚ `proxy_pass`, `content_by_lua_block`ï¼‰**ã€‚



#### è·å–è¯·æ±‚å‚æ•°

**1. è·¯å¾„å ä½ç¬¦ï¼ˆPath Parametersï¼‰**

> @PathVariable

| å‚æ•°æ ¼å¼   | ç¤ºä¾‹         | ä»£ç                               |
| :--------- | :----------- | :-------------------------------- |
| è·¯å¾„å ä½ç¬¦ | `/item/1001` | `location ï½ /item/(\d+) { ... }` |


- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ•è·è·¯å¾„ä¸­çš„æ•°å­—ï¼›
- åŒ¹é…åˆ°çš„å†…å®¹ä¼šè‡ªåŠ¨å­˜å…¥ `ngx.var[1]`, `ngx.var[2]`...ï¼›
- å¯ä»¥ç”¨ `ngx.var[1]` è·å–ç¬¬ä¸€ä¸ªæ‹¬å·å†…çš„å€¼ã€‚

```nginx
# ä½¿ç”¨å‘½åæ•è·ï¼ˆå¯è¯»æ€§æ›´å¼ºï¼‰
location ï½ ^/item/(?<id>\d+) $  {
    content_by_lua_file lua/item.lua;
}
```

åœ¨ Lua æ–‡ä»¶ä¸­ï¼š

```nginx
local id = ngx.var.id  -- ç›´æ¥ç”¨åå­—è·å–
```

> ğŸ’¡ **ä¼˜åŠ¿**ï¼šé¿å… `ngx.var[1]` çš„â€œé»‘ç›’â€æ„Ÿï¼Œæ›´æ˜“ç»´æŠ¤ã€‚

**ğŸ”¹ 2. è¯·æ±‚å¤´ï¼ˆHeadersï¼‰**

| å‚æ•°   | ç¤ºä¾‹       | ä»£ç                                     |
| :----- | :--------- | :-------------------------------------- |
| è¯·æ±‚å¤´ | `id: 1001` | `local headers = ngx.req.get_headers()` |


- `ngx.req.get_headers()` è¿”å›ä¸€ä¸ª tableï¼Œé”®ä¸º header åï¼ˆå°å†™ï¼‰ï¼›
- å¤šå€¼ headerï¼ˆå¦‚å¤šä¸ª `Set-Cookie`ï¼‰ä¼šè¿”å›æ•°ç»„ã€‚

**ğŸ§© ç¤ºä¾‹ï¼š**

```nginx
local headers = ngx.req.get_headers()
local auth_token = headers["authorization"]
local user_agent = headers["user-agent"]

-- å¦‚æœæœ‰å¤šä¸ª Cookie
local cookies = headers["cookie"]
if type(cookies) == "table" then
    for _, c in ipairs(cookies) do
        print(c)
    end
end
```

------

**ğŸ”¹ 3. GET è¯·æ±‚å‚æ•°ï¼ˆQuery Stringï¼‰**

> RequestParam

| å‚æ•°     | ç¤ºä¾‹       | ä»£ç                                        |
| :------- | :--------- | :----------------------------------------- |
| GET å‚æ•° | `?id=1001` | `local getParams = ngx.req.get_uri_args()` |


- `ngx.req.get_uri_args()` æ˜¯æ ‡å‡†æ–¹æ³•ï¼›
- è¿”å›å€¼æ˜¯ tableï¼Œkey æ˜¯å‚æ•°åï¼Œvalue æ˜¯å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„ï¼›
- è‡ªåŠ¨è§£ç  URL ç¼–ç ï¼ˆå¦‚ `%20` â†’ ç©ºæ ¼ï¼‰ã€‚

**âš ï¸ æ³¨æ„äº‹é¡¹ï¼š**

```nginx
local args = ngx.req.get_uri_args()

-- å•ä¸ªå€¼
local id = args.id

-- å¤šä¸ªåŒåå‚æ•°
local tags = args.tag
if type(tags) == "table" then
    for i, v in ipairs(tags) do
        print("Tag ", i, ": ", v)
    end
else
    print("Tag: ", tags)
end
```

> âŒ ä¸è¦ç›´æ¥ç”¨ `ngx.var.arg_id`ï¼Œå®ƒåªèƒ½å–ç¬¬ä¸€ä¸ªå€¼ä¸”ä¸æ”¯æŒå¤æ‚åœºæ™¯ã€‚

------

**ğŸ”¹ 4. POST è¡¨å•å‚æ•°ï¼ˆForm Dataï¼‰**

> RequestBody

| å‚æ•°      | ç¤ºä¾‹      | ä»£ç                                                          |
| :-------- | :-------- | :----------------------------------------------------------- |
| POST è¡¨å• | `id=1001` | `ngx.req.read_body(); local postParams = ngx.req.get_post_args()` |


- å¿…é¡»å…ˆè°ƒç”¨ `ngx.req.read_body()` è¯»å– bodyï¼›
- `get_post_args()` è§£æ `application/x-www-form-urlencoded`ï¼›
- è¿”å›å€¼æ˜¯ tableï¼Œä¸ `get_uri_args()` ç±»ä¼¼ã€‚

 **âš ï¸ æ³¨æ„ï¼š**

```nginx
ngx.req.read_body()  -- å¿…é¡»æ”¾åœ¨å‰é¢ï¼

local post_args = ngx.req.get_post_args(1000)  -- æœ€å¤šè§£æ 1000 ä¸ªå‚æ•°
```

> âŒ å¦‚æœæ²¡è°ƒç”¨ `read_body()`ï¼Œä¼šæŠ¥é”™æˆ–è¿”å›ç©ºã€‚

------

**ğŸ”¹ 5. JSON å‚æ•°**

| å‚æ•°      | ç¤ºä¾‹           | ä»£ç                                                          |
| :-------- | :------------- | :----------------------------------------------------------- |
| JSON Body | `{"id": 1001}` | `ngx.req.read_body(); local jsonBody = ngx.req.get_body_data()` |


- `ngx.req.get_body_data()` è¿”å›åŸå§‹ body å­—ç¬¦ä¸²ï¼ˆstring ç±»å‹ï¼‰ï¼›
- éœ€è¦æ‰‹åŠ¨ç”¨ `cjson` è§£æã€‚

**âœ… å®Œæ•´ç¤ºä¾‹ï¼š**

```nginx
ngx.req.read_body()
local body_data = ngx.req.get_body_data()

if not body_data then
    return ngx.exit(400)
end

local cjson = require "cjson.safe"
local json_data, err = cjson.decode(body_data)

if not json_data then
    ngx.log(ngx.ERR, "Invalid JSON: ", err)
    return ngx.exit(400)
end

local id = json_data.id
ngx.say("ID: ", id)
```

> âš ï¸ `get_body_data()` ä»…é€‚ç”¨äºå° bodyï¼›å¤§æ–‡ä»¶ä¼šä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œéœ€ç”¨ `ngx.req.get_body_file()`ã€‚



#### ç›´æ¥å“åº”

åœ¨ OpenResty ä¸­ï¼Œé€šè¿‡ `content_by_lua_block`ï¼ˆæˆ– `content_by_lua_file`ï¼‰å¯ä»¥ç›´æ¥ç”Ÿæˆ HTTP å“åº”ï¼Œ**æ— éœ€ä»£ç†åˆ°åç«¯æœåŠ¡**ã€‚è¿™æ˜¯æ„å»º API ç½‘å…³ã€å¥åº·æ£€æŸ¥ã€Mock æœåŠ¡ç­‰åœºæ™¯çš„æ ¸å¿ƒèƒ½åŠ›ã€‚

 **1.** **è¾“å‡ºå†…å®¹ï¼š`ngx.say()`  `ngx.print()`**

```nginx
content_by_lua_block {
    ngx.say("Hello")        -- è¾“å‡º + æ¢è¡Œ
    ngx.print("World")      -- è¾“å‡ºï¼ˆæ— æ¢è¡Œï¼‰
}
-- å“åº”ä½“: "Hello\nWorld"
```

> ğŸ’¡ `ngx.say()` = `ngx.print(str, "\n")`

------

 **2.** **è®¾ç½®çŠ¶æ€ç ï¼š`ngx.exit(code)`**

```nginx
content_by_lua_block {
    if not valid_user then
        ngx.status = 403
        ngx.say('{"error": "Forbidden"}')
        ngx.exit(403)  -- ç»ˆæ­¢æ‰§è¡Œ
    end
}
```

> âš ï¸ `ngx.exit()` ä¼š**ç«‹å³ç»ˆæ­¢å½“å‰è¯·æ±‚å¤„ç†**ï¼Œåç»­ä»£ç ä¸æ‰§è¡Œã€‚

------

 **3.** **è®¾ç½®å“åº”å¤´ï¼š`ngx.header["Header-Name"]`**

```nginx
content_by_lua_block {
    ngx.header["Content-Type"] = "application/json"
    ngx.header["Cache-Control"] = "no-cache"
    ngx.say('{"status": "ok"}')
}
```

> âœ… å¯ä»¥è®¾ç½®å¤šä¸ªåŒå headerï¼ˆå¦‚ `Set-Cookie`ï¼‰ï¼š

```nginx
ngx.header["Set-Cookie"] = {"session=abc", "lang=en"}
```

 **4.** **è¿”å› JSONï¼ˆæ¨èç”¨ `cjson`ï¼‰**

```nginx
content_by_lua_block {
    local cjson = require "cjson"
    ngx.header["Content-Type"] = "application/json"

    local data = {
        id = 123,
        name = "Alice",
        tags = {"lua", "openresty"}
    }

    ngx.say(cjson.encode(data))
}
-- å“åº”: {"id":123,"name":"Alice","tags":["lua","openresty"]}
```

> ğŸ”’ å®‰å…¨å»ºè®®ï¼šç”¨ `cjson.safe` é¿å…å´©æºƒï¼š

```nginx
local cjson = require "cjson.safe"
local json_str = cjson.encode(data)
if not json_str then
    ngx.status = 500
    ngx.say('{"error": "JSON encode failed"}')
    ngx.exit(500)
end
```

------

 **5.** **è¿”å› HTML / XML / è‡ªå®šä¹‰æ ¼å¼**

```nginx
content_by_lua_block {
    ngx.header["Content-Type"] = "text/html; charset=utf-8"
    ngx.say("<h1>Welcome to OpenResty!</h1>")
}
```

------

 **6.** **é‡å®šå‘ï¼š301 / 302**

```nginx
content_by_lua_block {
    ngx.header["Location"] = "https://example.com/new-path"
    ngx.exit(302)  -- æˆ– 301
}
```

------

 **7.** **ä¸‹è½½æ–‡ä»¶ï¼ˆè®¾ç½® Content-Dispositionï¼‰**

```nginx
content_by_lua_block {
    local filename = "report.pdf"
    ngx.header["Content-Type"] = "application/pdf"
    ngx.header["Content-Disposition"] = 'attachment; filename="' .. filename .. '"'

    -- ä»æ–‡ä»¶è¯»å–ï¼ˆå°æ–‡ä»¶ï¼‰
    local file = io.open("/path/to/report.pdf", "rb")
    if file then
        ngx.print(file:read("*a"))
        file:close()
    else
        ngx.exit(404)
    end
}
```

> âš ï¸ å¤§æ–‡ä»¶å»ºè®®ç”¨ `ngx.req.socket()` æµå¼å‘é€ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚

**8. é¢å¤–é…ç½®luaè„šæœ¬æ–‡ä»¶content_by_lua_file**

```nginx
content_by_lua_file /path/to/lua/user.lua;
```

luaè„šæœ¬ï¼š

```nginx
-- /usr/local/openresty/nginx/lua/user.lua

-- è·å–è¯·æ±‚å‚æ•°
local args = ngx.req.get_uri_args()
local user_id = args.id

-- å‚æ•°æ ¡éªŒ
if not user_id then
    ngx.status = 400
    ngx.header["Content-Type"] = "application/json"
    ngx.say('{"error": "Missing id parameter"}')
    return ngx.exit(400)
end

-- æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
local user = {
    id = tonumber(user_id),
    name = "Alice",
    email = "alice@example.com"
}

-- è¿”å› JSON
local cjson = require "cjson"
ngx.header["Content-Type"] = "application/json"
ngx.say(cjson.encode(user))
```

| ç‰¹æ€§              | `content_by_lua_block`    | `content_by_lua_file`            |
| :---------------- | :------------------------ | :------------------------------- |
| **ä»£ç å¤ç”¨**      | âŒ éš¾ä»¥å¤ç”¨                | âœ… å¯è¢«å¤šä¸ª location å¼•ç”¨         |
| **è¯­æ³•é«˜äº®/è°ƒè¯•** | âŒ å­—ç¬¦ä¸²å†…åµŒï¼Œæ—  IDE æ”¯æŒ | âœ… æ ‡å‡† `.lua` æ–‡ä»¶ï¼Œæ”¯æŒ LSP     |
| **çƒ­æ›´æ–°**        | âš ï¸ éœ€ reload Nginx         | âœ… **é»˜è®¤ç¼“å­˜ï¼Œéœ€å…³é—­æ‰èƒ½çƒ­æ›´æ–°** |
| **å¤æ‚é€»è¾‘**      | âŒ éš¾ä»¥ç»´æŠ¤                | âœ… å¯åˆ†æ¨¡å—ã€å†™å‡½æ•°               |
| **ç‰ˆæœ¬æ§åˆ¶**      | âŒ æ··åœ¨é…ç½®ä¸­              | âœ… ç‹¬ç«‹æ–‡ä»¶ï¼ŒGit å‹å¥½             |

è¿˜å¯ä»¥é€šè¿‡å…¨å±€é…ç½®luaè„šæœ¬åšä¸€äº›é€šç”¨çš„å‡½æ•°åŠ è½½åˆ°confæ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨ï¼š

```nginx
lua_package_path "/usr/local/openresty/lualib/?.lua;;";
```

è¿™æ ·libä¸‹çš„æ‰€æœ‰æ–‡ä»¶å°±ä¼šè¢«åŠ è½½åˆ°confæ–‡ä»¶ä¸­ï¼ˆç±»æ¯”jsçš„importï¼‰

```lua
-- å°è£…å‡½æ•°ï¼šå‘é€ HTTP GET è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ä½“
local function read_http(path, params)
    -- ä½¿ç”¨ ngx.location.capture å‘èµ·å†…éƒ¨è¯·æ±‚
    local resp = ngx.location.capture(path, {
        method = ngx.HTTP_GET,  -- è¯·æ±‚æ–¹æ³•ï¼šGET
        args = params           -- æŸ¥è¯¢å‚æ•°ï¼ˆå¦‚ ?id=123ï¼‰
    })

    -- æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
    if not resp then
        -- è®°å½•é”™è¯¯æ—¥å¿—
        ngx.log(ngx.ERR, "http not found, path: ", path, ", args: ", params)
        ngx.exit(404)  -- è¿”å› 404 é”™è¯¯
    end

    -- è¿”å›å“åº”ä½“ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰
    return resp.body
end

-- å°†å‡½æ•°å¯¼å‡ºä¸ºæ¨¡å—ï¼Œä¾›å…¶ä»–æ–‡ä»¶ä½¿ç”¨ å°±åƒjsçš„exportä¸€æ ·
local _M = {
    read_http = read_http
}

return _M
```





#### ä»£ç†é…ç½®

å…ˆæ¥çœ‹çœ‹éœ€è¦ä»£ç†çš„è¯·æ±‚å¤„ç†æµç¨‹ï¼š

 **ç¬¬ 1 æ­¥ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚**

```http
GET /item/1001?debug=true HTTP/1.1
Host: api.example.com
Authorization: Bearer xxx
```

------

 **ç¬¬ 2 æ­¥ï¼šNginx é€‰æ‹© `server` å—**

æ ¹æ® `Host: api.example.com` å’Œç›‘å¬ç«¯å£ï¼ˆå¦‚ 80ï¼‰ï¼ŒåŒ¹é…åˆ°å¯¹åº”çš„ `server`ï¼š

```nginx
server {
    listen 80;
    server_name api.example.com;  // â† åŒ¹é…æˆåŠŸ
    ...
}
```

------

 **ç¬¬ 3 æ­¥ï¼šNginx åŒ¹é…** `location`

åœ¨ `server` å—ä¸­ï¼ŒæŸ¥æ‰¾èƒ½åŒ¹é… URI `/item/1001` çš„ `location`ã€‚

ä½ é…ç½®äº†ï¼š

```nginx
location /item/ {
    proxy_pass http://backend-service:8080;
}
```

> âœ… **åŒ¹é…è§„åˆ™**ï¼š
> `location /item/` æ˜¯**å‰ç¼€åŒ¹é…**ï¼Œåªè¦ URI ä»¥ `/item/` å¼€å¤´å°±å‘½ä¸­ï¼ˆåŒ…æ‹¬ `/item/1001`ã€`/item/list` ç­‰ï¼‰ã€‚

------

 **ç¬¬ 4 æ­¥ï¼šNginx æ„é€ è½¬å‘è¯·æ±‚**

Nginx é»˜è®¤ä¼š**ä¿ç•™åŸå§‹ URI å’Œ Query String**ï¼Œå‘åç«¯å‘èµ·æ–°è¯·æ±‚ï¼š

```http
GET /item/1001?debug=true HTTP/1.1
Host: backend-service:8080          // â† æ³¨æ„ï¼šHost å˜äº†ï¼
Authorization: Bearer xxx
X-Real-IP: 203.0.113.10             // â† å¦‚æœä½ è®¾ç½®äº†
...
```

> ğŸ”‘ å…³é”®ç‚¹ï¼š
> **`proxy_pass` åé¢å¦‚æœ** **ä¸å¸¦ URI è·¯å¾„**ï¼ˆå³åªå†™ `http://backend`ï¼‰ï¼ŒNginx ä¼š**åŸæ ·è½¬å‘åŸå§‹ URI**ã€‚

------

 **ç¬¬ 5 æ­¥ï¼šåç«¯å¤„ç†å¹¶è¿”å›å“åº”**

åç«¯æ”¶åˆ°è¯·æ±‚ï¼Œå¤„ç† `/item/1001`ï¼Œè¿”å›ï¼š

```http
HTTP/1.1 200 OK
Content-Type: application/json

{"id":1001,"name":"Book"}
```

------

 **ç¬¬ 6 æ­¥ï¼šNginx å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯**

Nginx æŠŠåç«¯çš„å“åº”**åŸæ ·ï¼ˆæˆ–ç¨ä½œä¿®æ”¹ï¼‰è¿”å›ç»™å®¢æˆ·ç«¯**ï¼Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚



**é‚£ä¹ˆå‡å¦‚æˆ‘çš„åç«¯æ˜¯é›†ç¾¤å‘¢ï¼Ÿæˆ‘è¦æ€ä¹ˆé…ç½®proxy_passï¼Ÿ**

é¦–å…ˆé…ç½®å¥½é›†ç¾¤çš„ipä»¥åŠç«¯å£ï¼š

```nginx
# åœ¨ http {} å—ä¸­å®šä¹‰ï¼ˆé€šå¸¸æ”¾åœ¨ nginx.conf çš„ http æ®µï¼‰
upstream item_backend {
    server 192.168.1.10:8080;   # åç«¯èŠ‚ç‚¹1
    server 192.168.1.11:8080;   # åç«¯èŠ‚ç‚¹2
    server 192.168.1.12:8080;   # åç«¯èŠ‚ç‚¹3
}
```

éšååœ¨locationæ¥å£ä½¿ç”¨proxy_passè°ƒç”¨ï¼š

```nginx
server {
    listen 80;
    server_name api.example.com;

    location /item/ {
        proxy_pass http://item_backend;  # â† å¼•ç”¨ upstream åç§°
        proxy_set_header Host  $ host;
        proxy_set_header X-Real-IP  $ remote_addr;
        proxy_set_header X-Forwarded-For  $ proxy_add_x_forwarded_for;
    }
}
```

è¿™é‡Œä¸åšé¢å¤–è®¾ç½®çš„è¯ï¼Œnginxé»˜è®¤ä½¿ç”¨**è½®è¯¢**çš„æ–¹å¼æ¥è´Ÿè½½å‡è¡¡è¯·æ±‚å¤„ç†ï¼š

| ç®—æ³•             | é…ç½®æ–¹å¼      | è¯´æ˜                                          |
| :--------------- | :------------ | :-------------------------------------------- |
| **è½®è¯¢ï¼ˆé»˜è®¤ï¼‰** | ä¸å†™ä»»ä½•æŒ‡ä»¤  | è¯·æ±‚ä¾æ¬¡åˆ†å‘                                  |
| **åŠ æƒè½®è¯¢**     | `weight=5`    | æƒé‡é«˜çš„æœºå™¨æ¥æ”¶æ›´å¤šè¯·æ±‚                      |
| **IP Hash**      | `ip_hash;`    | åŒä¸€å®¢æˆ·ç«¯å§‹ç»ˆè®¿é—®åŒä¸€å°ï¼ˆé€‚åˆ session ä¿æŒï¼‰ |
| **æœ€å°‘è¿æ¥**     | `least_conn;` | è½¬å‘ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„èŠ‚ç‚¹                    |

**ç¤ºä¾‹ï¼šåŠ æƒ + æœ€å°‘è¿æ¥**

```nginx
upstream item_backend {
    least_conn;
    server backend1:8080 weight=5;
    server backend2:8080 weight=3;
    server backend3:8080 weight=2;
}
```

**ç¤ºä¾‹ï¼šuri_hash**

```nginx
upstream image_backend {
    # åŸºäº URI å“ˆå¸Œï¼Œç¡®ä¿ç›¸åŒè¯·æ±‚æ€»ç”±åŒä¸€å°æœºå™¨å¤„ç†
    hash  $ uri;
    server img1:8080 max_fails=2;
    server img2:8080 max_fails=2;
    server img3:8080 max_fails=2;
}
```

| å˜é‡             | ç¤ºä¾‹è¯·æ±‚                    | å€¼                      |
| :--------------- | :-------------------------- | :---------------------- |
| ` $ uri`         | `GET /item/1001?debug=true` | `/item/1001`            |
| ` $ request_uri` | `GET /item/1001?debug=true` | `/item/1001?debug=true` |

> åŒæ—¶è¿˜å¯ä»¥é…ä¸Šé•¿è¿æ¥é¿å…æ¯æ¬¡éƒ½å»ºç«‹tcpè¿æ¥ï¼Œé™ä½åç«¯å‹åŠ›ï¼š
>
> ```nginx
> upstream item_backend {
>     server backend1:8080;
>     server backend2:8080;
>     keepalive 32;  # ä¿æŒ 32 ä¸ªç©ºé—²é•¿è¿æ¥
> }
> 
> server {
>     location /item/ {
>         proxy_pass http://item_backend;
>         proxy_http_version 1.1;
>         proxy_set_header Connection "";
>     }
> }
> ```
>
> ğŸ”¥ **å¼ºçƒˆå»ºè®®å¼€å¯ `keepalive`**ï¼Œå¯æ˜¾è‘—é™ä½åç«¯å‹åŠ›ã€‚
>
> å†é…ä¸Šè¶…æ—¶æ–­è¿ï¼š
>
> ```nginx
> location /item/ {
>     proxy_pass http://item_backend;
> 
>     # è¿æ¥è¶…æ—¶
>     proxy_connect_timeout 3s;
> 
>     # å‘é€è¯·æ±‚è¶…æ—¶
>     proxy_send_timeout 10s;
> 
>     # æ¥æ”¶å“åº”è¶…æ—¶
>     proxy_read_timeout 10s;
> 
>     # ç¼“å†²åŒºå¤§å°ï¼ˆé˜²å¤§å“åº”æ‹–å®å†…å­˜ï¼‰
>     proxy_buffering on;
>     proxy_buffer_size 4k;
>     proxy_buffers 8 4k;
> }
> ```



#### openrestyçš„redisæ¨¡å—

luaä¸­è°ƒç”¨ï¼š

 **æ­¥éª¤ 1ï¼šåˆ›å»º Redis å¯¹è±¡**

```lua
local redis = require "resty.redis"
local red = redis:new()
```

 **æ­¥éª¤ 2ï¼šè®¾ç½®è¶…æ—¶ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰**

```lua
red:set_timeout(1000)  -- 1ç§’è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
```

 **æ­¥éª¤ 3ï¼šè¿æ¥ Redis**

```lua
local ok, err = red:connect("127.0.0.1", 6379)
if not ok then
    ngx.log(ngx.ERR, "Redis connect failed: ", err)
    return ngx.exit(500)
end
```

 **æ­¥éª¤ 4ï¼šæ‰§è¡Œå‘½ä»¤**

```lua
-- SET
local res, err = red:set("user:1001", "Alice")
if not res then
    ngx.log(ngx.ERR, "SET failed: ", err)
end

-- GET
local value, err = red:get("user:1001")
if err then
    ngx.log(ngx.ERR, "GET failed: ", err)
else
    ngx.say("Value: ", value or "nil")
end
```

 **æ­¥éª¤ 5ï¼šé‡Šæ”¾è¿æ¥ï¼ˆå…³é”®ï¼ï¼‰**

```lua
-- æ–¹å¼1ï¼šæ”¾å›è¿æ¥æ± ï¼ˆæ¨èï¼‰
local ok, err = red:set_keepalive(10000, 100)  -- 10ç§’ç©ºé—²è¶…æ—¶ï¼Œæœ€å¤š100ä¸ªè¿æ¥
if not ok then
    ngx.log(ngx.ERR, "set_keepalive failed: ", err)
end

-- æ–¹å¼2ï¼šæ˜¾å¼å…³é—­ï¼ˆä¸æ¨èï¼Œæµªè´¹æ€§èƒ½ï¼‰
-- red:close()
```

> âœ… **å¿…é¡»è°ƒç”¨ `set_keepalive()`**ï¼Œå¦åˆ™æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ–°å»º TCP è¿æ¥ï¼Œå¯¼è‡´æ€§èƒ½æš´è·Œï¼ï¼ˆä¸€èˆ¬ä¼šä¸€ç›´è¿æ¥è¿™ä¸ªRedisæœåŠ¡ï¼‰



#### openrestyçš„æœ¬åœ°ç¼“å­˜

 **æ­¥éª¤ 1ï¼šåœ¨** `nginx.conf` **ä¸­å®šä¹‰å…±äº«å†…å­˜åŒº**

```nginx
http {
    # å®šä¹‰ä¸€ä¸ª 100MB çš„å…±äº«å†…å­˜å­—å…¸ï¼Œåä¸º 'my_cache'
    lua_shared_dict my_cache 100m;

    server {
        location /item/ {
            content_by_lua_file lua/item.lua;
        }
    }
}
```

 **æ­¥éª¤ 2ï¼šåœ¨ Lua è„šæœ¬ä¸­ä½¿ç”¨ç¼“å­˜**

```lua
-- lua/item.lua
local cache = ngx.shared.my_cache  -- è·å–å…±äº«å­—å…¸
local user_id = ngx.var.arg_id
local cache_key = "item:" .. user_id

-- 1. å°è¯•ä»ç¼“å­˜è¯»å–
local value, flags = cache:get(cache_key)
if value then
    ngx.header["X-Cache"] = "HIT"
    ngx.say(value)
    return
end

-- 2. ç¼“å­˜æœªå‘½ä¸­ï¼šè°ƒç”¨åç«¯ï¼ˆæˆ–æ•°æ®åº“ï¼‰
local cjson = require "cjson"
local item_data = {
    id = tonumber(user_id),
    name = "Sample Item",
    price = 99.9
}
local json_str = cjson.encode(item_data)

-- 3. å†™å…¥ç¼“å­˜ï¼ˆè¿‡æœŸæ—¶é—´ 300 ç§’ï¼‰
local success, err = cache:set(cache_key, json_str, 300)
if not success then
    ngx.log(ngx.ERR, "Failed to set cache: ", err)
end

ngx.header["X-Cache"] = "MISS"
ngx.say(json_str)
```

- **å¾®ç§’çº§è¯»å†™**ï¼ˆæ¯”ç£ç›˜å¿« 1000 å€+ï¼‰ï¼›
- **æ”¯æŒ TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰**ï¼›
- **åŸå­æ“ä½œ**ï¼ˆ`incr`, `add`, `replace`ï¼‰ï¼›
- **æ‰€æœ‰ worker è¿›ç¨‹å…±äº«**ï¼ˆè·¨è¿›ç¨‹ç¼“å­˜ï¼‰ã€‚







### ç¼“å­˜åŒæ­¥ï¼ˆCanalï¼‰

å¸¸è§çš„å¤„ç†ç¼“å­˜æ•°æ®ä¸€è‡´æ€§çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š

**æœ‰æ•ˆæ—¶é—´**ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ°æ—¶åˆ é™¤ï¼Œå†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ï¼ˆRedisçš„ttlï¼Œttlå†…ä¼šè¯»åˆ°è„æ•°æ®ï¼‰

**åŒæ­¥åŒå†™**ï¼šæ•°æ®åº“æ›´æ–°æ—¶æ›´æ–°æ‰€æœ‰ç¼“å­˜ï¼ˆä¸šåŠ¡å†…éƒ¨å¤„ç†ï¼Œç»´æŠ¤æˆæœ¬å¤§ï¼‰

**å¼‚æ­¥é€šçŸ¥**ï¼šæ•°æ®åº“æ›´æ–°æ—¶å‘é€äº‹ä»¶ï¼Œæ‰€æœ‰æœåŠ¡æ¥æ”¶åˆ°åæ›´æ–°ç¼“å­˜ï¼ˆMQï¼Œæ—¶æ•ˆæ€§æœ‰è¦æ±‚ï¼‰



#### canalç›‘å¬æ•°æ®åº“

å¦‚æœé‡‡ç”¨å¼‚æ­¥é€šçŸ¥çš„æ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•æ¯”å¦‚ä¸šåŠ¡ä¿®æ”¹æ•°æ®åº“ï¼Œå®Œæˆåå¼‚æ­¥MQä¿®æ”¹ç¼“å­˜ï¼Œè¿™æ ·çš„æ“ä½œè¦æ±‚æˆ‘ä»¬å‡†å¤‡å¥½ä¸€ä¸ªMQå¹¶è®¾ç½®å¥½ä¸€ä¸ªæ¶ˆè´¹è€…æ—¶åˆ»å‡†å¤‡å®Œæˆç¼“å­˜ä¿®æ”¹ä»»åŠ¡ï¼ŒåŒæ—¶è¿˜éœ€è¦æ•°æ®åº“éƒ¨åˆ†ä¸šåŠ¡æ˜¾å¼è°ƒç”¨æ·»åŠ æ¶ˆæ¯çš„æ¥å£ï¼Œå°†æ¶ˆæ¯å­˜å…¥MQã€‚

ç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¸€ç§æ–°çš„æ–¹å¼ï¼šå‡†å¤‡ä¸€ä¸ªæœåŠ¡æ¥ç›‘å¬æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå½“å‘ç”Ÿäº†å…³é”®ä¿¡æ¯çš„ä¿®æ”¹ç­‰æ“ä½œï¼Œå°±ä¼šè§¦å‘äº‹ä»¶ï¼Œå¼€å§‹ä¿®æ”¹ç¼“å­˜ã€‚è€Œè¿™ä¸ªæœåŠ¡ï¼Œå°±æ˜¯canalï¼š

> ç›¸æ¯”MQå¼‚æ­¥é€šçŸ¥ï¼Œè¿™ç§ç›‘å¬çš„æ–¹å¼ä»£ç è€¦åˆåº¦æ›´å°ä¸€ç‚¹ï¼Œä½†æ˜¯åç»­ç»´æŠ¤èµ·æ¥å¤æ‚åº¦æ›´å¤§

Canal æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾**åŸºäº MySQL æ•°æ®åº“å¢é‡æ—¥å¿—ï¼ˆbinlogï¼‰è§£æ**çš„ç»„ä»¶ï¼Œä¸»è¦ç”¨äº**å®æ—¶æ•è·æ•°æ®åº“å˜æ›´**ï¼ˆCDC, Change Data Captureï¼‰ï¼Œå¹¶å°†è¿™äº›å˜æ›´ä»¥äº‹ä»¶æµçš„å½¢å¼æä¾›ç»™ä¸‹æ¸¸ç³»ç»Ÿä½¿ç”¨ã€‚

**ä¸»è¦æœºåˆ¶**

MySQL æœ¬èº«æ”¯æŒä¸»ä»å¤åˆ¶ï¼Œå…¶æœºåˆ¶æ˜¯ï¼š

- ä¸»åº“å°†æ•°æ®å˜æ›´å†™å…¥ **Binary Logï¼ˆbinlogï¼‰**
- ä»åº“é€šè¿‡ I/O çº¿ç¨‹è¿æ¥ä¸»åº“ï¼Œæ‹‰å– binlog å¹¶é‡æ”¾ï¼ˆreplayï¼‰

**Canal æ­£æ˜¯æ¨¡æ‹Ÿäº† MySQL çš„ä»åº“è¡Œä¸º**ï¼š

- å®ƒ**ä¼ªè£…**æˆä¸€ä¸ª MySQL slave
- å‘ MySQL master å‘é€ dump åè®®è¯·æ±‚
- MySQL master å°† binlog æ¨é€ç»™ Canal
- Canal è§£æ binlog å†…å®¹ï¼ˆå¦‚ insert / update / deleteï¼‰
- å°†ç»“æ„åŒ–çš„å˜æ›´æ•°æ®æš´éœ²ç»™å®¢æˆ·ç«¯ï¼ˆå¦‚ Kafkaã€RocketMQã€åº”ç”¨ç¨‹åºç­‰ï¼‰

> å‰æï¼šMySQL å¿…é¡»å¼€å¯ binlogï¼Œå¹¶è®¾ç½®ä¸º `ROW` æ ¼å¼ï¼ˆæ¨è `binlog_format=ROW`ï¼‰



**ä¸»è¦ç»„æˆ**

1. Canal Server
   - è´Ÿè´£è¿æ¥ MySQLã€æ‹‰å–å¹¶è§£æ binlog
   - ç®¡ç†å®ä¾‹ï¼ˆinstanceï¼‰ï¼Œæ¯ä¸ª instance å¯¹åº”ä¸€ä¸ªæ•°æ®åº“æˆ–ä¸€ç»„è¡¨
   - æ”¯æŒ HAï¼ˆé«˜å¯ç”¨ï¼‰éƒ¨ç½²ï¼Œé€šå¸¸é…åˆ ZooKeeper å®ç°
2. Canal Clientï¼ˆAdapterï¼‰
   - æ¶ˆè´¹ Canal Server æä¾›çš„å˜æ›´æ•°æ®
   - å¯ä»¥æ˜¯è‡ªå®šä¹‰ Java åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…ç½®çš„é€‚é…å™¨ï¼ˆå¦‚å†™å…¥ Kafkaã€Elasticsearchã€HBase ç­‰ï¼‰
3. Canal Adminï¼ˆå¯é€‰ï¼‰
   - Web ç®¡ç†ç•Œé¢ï¼Œç”¨äºé…ç½®å’Œç›‘æ§ Canal å®ä¾‹ï¼ˆä» Canal 1.1.4 å¼€å§‹æä¾›ï¼‰



**åº”ç”¨åœºæ™¯**

| åœºæ™¯           | è¯´æ˜                                                         |
| :------------- | :----------------------------------------------------------- |
| **æ•°æ®åŒæ­¥**   | **MySQL** â†’ **Elasticsearch** / **HBase** / **Redis**ï¼Œå®ç°å¼‚æ„æ•°æ®æºåŒæ­¥ |
| **ç¼“å­˜æ›´æ–°**   | DB å˜æ›´åè‡ªåŠ¨å¤±æ•ˆæˆ–æ›´æ–°ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰                      |
| **ä¸šåŠ¡è§£è€¦**   | è®¢å•åˆ›å»ºã€ç”¨æˆ·æ³¨å†Œç­‰äº‹ä»¶é€šè¿‡ Canal æ•è·ï¼Œè§¦å‘ä¸‹æ¸¸å¾®æœåŠ¡      |
| **å®¡è®¡ä¸æ—¥å¿—** | è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´ç”¨äºåˆè§„æˆ–åˆ†æ                               |
| **å®æ—¶æ•°ä»“**   | å°†ä¸šåŠ¡åº“å˜æ›´å®æ—¶å¯¼å…¥æ•°æ®æ¹–æˆ– OLAP ç³»ç»Ÿï¼ˆå¦‚ Dorisã€ClickHouseï¼‰ |



#### å®‰è£…é…ç½®canal

ç”±äºcanalè¦æ±‚å¼€å¯mysqlçš„ä¸»ä»é›†ç¾¤é…ç½®ï¼Œæˆ‘ä»¬åœ¨å¼€å¯canalå‰éœ€è¦å…ˆå¼€å¯mysqlçš„ä¸»ä»é›†ç¾¤é…ç½®ï¼š

 **1. MySQL é…ç½®ï¼ˆå¿…é¡»ï¼‰**

ç¡®ä¿ä½ çš„ MySQL æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

```ini
# my.cnf æˆ– /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# å¼€å¯ binlog
log-bin=mysql-bin

# å¼€å¯binlogçš„æ•°æ®åº“åç§°
binlog-do-db=yourDBname

# binlog æ ¼å¼å¿…é¡»ä¸º ROW
binlog-format=ROW

# server-id ä¸èƒ½ä¸º 0ï¼Œä¸”æ¯ä¸ª MySQL å®ä¾‹å”¯ä¸€
server-id=1

# ï¼ˆå¯é€‰ï¼‰è®¾ç½® binlog è¿‡æœŸæ—¶é—´ï¼Œé¿å…ç£ç›˜çˆ†æ»¡
expire_logs_days=7
```

> ä¿®æ”¹åé‡å¯ MySQLï¼š`sudo systemctl restart mysql`

 **2. åˆ›å»º Canal ä¸“ç”¨è´¦å·ï¼ˆæ¨èï¼‰**

```sql
-- åˆ›å»ºç”¨æˆ·ï¼ˆIP æ ¹æ® Canal Server æ‰€åœ¨æœºå™¨è°ƒæ•´ï¼‰
CREATE USER canal@'%' IDENTIFIED BY 'canal123';

-- æˆäºˆå¤åˆ¶æƒé™ï¼ˆå…³é”®ï¼ï¼‰
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

> æ³¨æ„ï¼š`REPLICATION SLAVE` å’Œ `REPLICATION CLIENT` æ˜¯ Canal æ¨¡æ‹Ÿä»åº“æ‰€å¿…éœ€çš„ã€‚

æ¥ä¸‹æ¥å®Œæˆcanalçš„é…ç½®ï¼š

**å…¨å±€é…ç½®ï¼š** `conf/canal.properties`

```properties
# ç›‘å¬ç«¯å£ï¼ˆå®¢æˆ·ç«¯è¿æ¥ç”¨ï¼‰
canal.port = 11111

# æ˜¯å¦å¼€å¯ TCP æ¨¡å¼ï¼ˆé»˜è®¤ trueï¼‰
canal.tcp.mode = true

# å®ä¾‹åˆ—è¡¨ï¼ˆé»˜è®¤ exampleï¼‰
canal.destinations = example

# HA é…ç½®ï¼ˆå•æœºå¯å¿½ç•¥ï¼‰
# canal.zkServers = 
```

 **å®ä¾‹é…ç½®ï¼š**`conf/example/instance.properties`

```properties
# MySQL ä¸»åº“åœ°å€
canal.instance.master.address=127.0.0.1:3306

# MySQL è´¦å·å¯†ç ï¼ˆå‰é¢åˆ›å»ºçš„ï¼‰
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal123

# æ•°æ®åº“è¡¨è¿‡æ»¤ï¼ˆæ­£åˆ™ï¼‰
# ç¤ºä¾‹ï¼šåªç›‘å¬ test åº“çš„ user è¡¨
# canal.instance.filter.regex=test\\.user
# é»˜è®¤ç›‘å¬æ‰€æœ‰åº“è¡¨ï¼š
canal.instance.filter.regex=.*\\..*

# binlog æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œé¦–æ¬¡å¯åŠ¨å¯ä¸å¡«ï¼Œè‡ªåŠ¨ä»æœ€æ–°ä½ç‚¹å¼€å§‹ï¼‰
# canal.instance.master.journal.name=
# canal.instance.master.position=

# å­—ç¬¦é›†
canal.instance.connectionCharset = UTF-8

# æ˜¯å¦å¯ç”¨ TSDBï¼ˆè¡¨ç»“æ„ç¼“å­˜ï¼Œå»ºè®®å¼€å¯ï¼‰
canal.instance.tsdb.enable=true
```

ç„¶ååªè¦`sh bin/startup.sh`å¯åŠ¨å³å¯ç›‘å¬å¯¹åº”æ•°æ®åº“ã€‚



#### canalå®¢æˆ·ç«¯é…ç½®

pomå¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>top.javatool</groupId>
    <artifactId>canal-spring-boot-starter</artifactId>
    <version>1.3.0</version> <!-- è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ -->
</dependency>
```

ymlé…ç½®ï¼š

```yml
canal:
  destination: example                 # å¯¹åº” canal server çš„ instance åç§°
  server: 127.0.0.1:11111             # canal server åœ°å€
  username: canal                     # é»˜è®¤ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
  password: canal                     # é»˜è®¤å¯†ç ï¼ˆå¯é€‰ï¼‰
  batchSize: 1000                     # æ¯æ¬¡è·å–æ¶ˆæ¯çš„æœ€å¤§æ•°é‡
  flatMessage: true                   # æ˜¯å¦ä½¿ç”¨æ‰å¹³åŒ–æ¶ˆæ¯æ ¼å¼ï¼ˆæ¨è trueï¼‰
```



#### å®¢æˆ·ç«¯çš„ä½¿ç”¨

 **æ–¹å¼1ï¼šç›‘å¬ç‰¹å®šè¡¨**

```java
@CanalEventListener
public class UserTableListener {

    @InsertEvent(destination = "example", database = "mydb", table = "user")
    public void onUserInsert(RowData rowData) {
        System.out.println("User inserted: " + rowData);
    }

    @UpdateEvent(destination = "example", database = "mydb", table = "user")
    public void onUserUpdate(RowData rowData) {
        System.out.println("User updated: " + rowData);
    }

    @DeleteEvent(destination = "example", database = "mydb", table = "user")
    public void onUserDelete(RowData rowData) {
        System.out.println("User deleted: " + rowData);
    }
}
```

> æ³¨æ„ï¼š`@InsertEvent`ã€`@UpdateEvent` ç­‰æ˜¯ `canal-spring-boot-starter` æä¾›çš„ä¾¿æ·æ³¨è§£ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åœ¨**ç±»**ä¸ŠæŒ‡å®šå¯¹åº”è¡¨ï¼š

```java
@Component
@CanalTable("tb_item")
public class ItemHandler implements EntryHandler<Item> {

    @Override
    public void insert(Item item) {
        System.out.println("æ–°å¢å•†å“ï¼š" + item);
        // å°†æ•°æ®å†™å…¥ Redis
        // redisTemplate.opsForValue().set("item:" + item.getId(), item);
        // æ¸…ç†æœ¬åœ°ç¼“å­˜
    }

    @Override
    public void update(Item before, Item after) {
        System.out.println("æ›´æ–°å•†å“ï¼šæ—§å€¼=" + before + ", æ–°å€¼=" + after);
        // æ›´æ–° Redis æ•°æ®
        // redisTemplate.opsForValue().set("item:" + after.getId(), after);
        // æ¸…ç†æœ¬åœ°ç¼“å­˜
    }

    @Override
    public void delete(Item item) {
        System.out.println("åˆ é™¤å•†å“ï¼š" + item);
        // åˆ é™¤ Redis æ•°æ®
        // redisTemplate.delete("item:" + item.getId());
        // æ¸…ç†æœ¬åœ°ç¼“å­˜
    }
}
```

| æ³¨è§£                            | ä½œç”¨                                          |
| :------------------------------ | :-------------------------------------------- |
| `@CanalTable("tb_item")`        | æŒ‡å®šç›‘å¬çš„æ•°æ®åº“è¡¨åï¼ˆå¿…é¡»ä¸ MySQL è¡¨åä¸€è‡´ï¼‰ |
| `@Component`                    | Spring ç®¡ç†è¯¥ Beanï¼Œè‡ªåŠ¨æ³¨å†Œåˆ° Canal ç›‘å¬å™¨   |
| `implements EntryHandler<Item>` | å®ç°å¢åˆ æ”¹ä¸‰ä¸ªæ–¹æ³•ï¼Œæ¥æ”¶å®ä½“å¯¹è±¡              |

å…¶ä¸­å¯¹äºEntityæœ‰ä¸€äº›è¦æ±‚ï¼š

```java
@Data
@TableName("tb_item")
public class Item {
    @TableId(type = IdType.AUTO)
    @Id
    private Long id;

    @Column(name = "name")
    private String name;

    private Date updateTime;

    @TableField(exist = false)
    @Transient
    private Integer stock;

    @TableField(exist = false)
    @Transient
    private Integer sold;
}
```

| æ³¨è§£                                        | ä½œç”¨             | æ˜¯å¦å¿…é¡»                   |
| :------------------------------------------ | :--------------- | :------------------------- |
| `@TableName("tb_item")`                     | æŒ‡å®šç›‘å¬çš„è¡¨å   | æ˜¯ï¼ˆå¿…é¡»ï¼‰                 |
| `@Id` / `@TableId(type = IdType.AUTO)`      | æ ‡è®°ä¸»é”®å­—æ®µ     | æ˜¯ï¼ˆå»ºè®®ï¼‰                 |
| `@Column(name = "xxx")`                     | æ˜ å°„æ•°æ®åº“åˆ—å   | éå¿…éœ€ï¼Œä½†å­—æ®µåä¸åŒåˆ™å¿…é¡» |
| `@Transient` / `@TableField(exist = false)` | æ ‡è®°éæ•°æ®åº“å­—æ®µ | å¯é€‰                       |

 **æ–¹å¼2ï¼šä½¿ç”¨** `@CanalEventListener` **æ³¨è§£**

```java
@Component
public class BinlogListener {

    @CanalEventListener
    public void handleUpdate(Entry entry) {
        // å¤„ç†æ‰€æœ‰ DML äº‹ä»¶ï¼ˆINSERT/UPDATE/DELETEï¼‰
        if (entry.getEntryType() == EntryType.ROWDATA) {
            RowChange rowChange;
            try {
                row = RowChange.parseFrom(entry.getStoreValue());
            } catch (InvalidProtocolBufferException e) {
                throw new RuntimeException(e);
            }

            for (RowData rowData : rowChange.getRowDatasList()) {
                switch (rowChange.getEventType()) {
                    case INSERT:
                        handleInsert(rowData);
                        break;
                    case UPDATE:
                        handleUpdate(rowData);
                        break;
                    case DELETE:
                        handleDelete(rowData);
                        break;
                }
            }
        }
    }

    private void handleInsert(RowData rowData) {
        System.out.println("INSERT: " + rowData);
    }

    private void handleUpdate(RowData rowData) {
        System.out.println("UPDATE: " + rowData);
    }

    private void handleDelete(RowData rowData) {
        System.out.println("DELETE: " + rowData);
    }
}
```

