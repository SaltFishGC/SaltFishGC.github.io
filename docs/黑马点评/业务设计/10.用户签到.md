---
title: ç”¨æˆ·ç­¾åˆ°
date: 2025-1-23
---

æˆ‘ä»¬è™½ç„¶å¯ä»¥ä½¿ç”¨æ•°æ®åº“æ¥å®ç°å¯¹ç”¨æˆ·ç­¾åˆ°æ•°æ®çš„è®°å½•ï¼Œä½†æ˜¯è¿™æ ·ä¸€æ¥æ•°æ®é‡å°±ä¼šè¾¾åˆ°ææ€–çš„é‡çº§ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹å¼æ¥å­˜å‚¨ç”¨æˆ·çš„ç­¾åˆ°æƒ…å†µå‘¢ï¼Ÿ

å‡å¦‚æˆ‘ä»¬ç”¨0æ¥ä»£è¡¨æœªç­¾åˆ°ï¼Œ1ä»£è¡¨ç­¾åˆ°ï¼Œé‚£ä¹ˆ30/31ä½bitï¼Œ4ä¸ªå­—èŠ‚å°±å¯ä»¥è®°å½•æŸä¸€ç”¨æˆ·æŸä¸€æœˆçš„ç­¾åˆ°æƒ…å†µï¼Œè€Œå†å¤šå‡ ä½æ¥è¡¨ç¤ºå¹´ä»½ä»¥åŠæœˆä»½å³å¯è¡¨ç¤ºå®ç°è®°å½•è¯¥å¹´ä¸­è¯¥æœˆçš„ç­¾åˆ°æƒ…å†µ

### Redisä¸­çš„BitMap

Redis ä¸­çš„ **Bitmapï¼ˆä½å›¾ï¼‰** å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åŸºäº **Stringï¼ˆå­—ç¬¦ä¸²ï¼‰** ç±»å‹å®ç°çš„ä¸€ç§**é«˜æ•ˆå­˜å‚¨å¸ƒå°”å€¼ï¼ˆ0/1ï¼‰** çš„æ•°æ®ç»“æ„ã€‚å®ƒåˆ©ç”¨æ¯ä¸ªå­—èŠ‚çš„ 8 ä¸ª bit ä½æ¥è¡¨ç¤ºçŠ¶æ€ï¼Œ**æå¤§èŠ‚çœå†…å­˜**ï¼Œéå¸¸é€‚åˆå¤„ç†**æµ·é‡äºŒå€¼çŠ¶æ€**åœºæ™¯ã€‚è¡¨æ ¼

| å‘½ä»¤                                                         | åŠŸèƒ½                                     | ç¤ºä¾‹                                               |
| :----------------------------------------------------------- | :--------------------------------------- | :------------------------------------------------- |
| **`SETBIT key offset value`**                                | è®¾ç½®æŸä¸€ä½çš„å€¼ï¼ˆ0 æˆ– 1ï¼‰                 | `SETBIT user:sign:20240601 123 1`                  |
| **`GETBIT key offset value`**                                | è·å–æŸä¸€ä½çš„å€¼                           | `GETBIT user:sign:20240601 123` â†’ è¿”å› `1`         |
| **`BITCOUNT key [start end]`**                               | ç»Ÿè®¡ 1 çš„ä¸ªæ•°ï¼ˆå¯é€‰å­—èŠ‚èŒƒå›´ï¼‰            | `BITCOUNT user:sign:20240601`                      |
| **`BITPOS key bit [start end]`**                             | æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæŒ‡å®š bitï¼ˆ0 æˆ– 1ï¼‰çš„ä½ç½®       | `BITPOS user:sign:20240601 0` â†’ æ‰¾ç¬¬ä¸€ä¸ªæœªç­¾åˆ°ç”¨æˆ· |
| **`BITOP operation destkey key1 key2 ...`**                  | å¯¹å¤šä¸ª Bitmap åšä½è¿ç®—ï¼ˆAND/OR/XOR/NOTï¼‰ | `BITOP AND result k1 k2`                           |
| **`BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment] [OVERFLOW WRAP SAT FAIL]`** | è·å–/è®¾ç½®æŸä¸€æ®µçš„å€¼                      | `BITFIELD user:1001 SET u2 9 0`                    |

**åº”ç”¨åœºæ™¯ï¼š**

**âœ… 1. ç”¨æˆ·ç­¾åˆ° / æ‰“å¡ç³»ç»Ÿ**

- æ¯å¤©ä¸€ä¸ª keyï¼š`sign:20240601`
- ç”¨æˆ· ID ä½œä¸º offset
- ç­¾åˆ°ï¼š`SETBIT sign:20240601 1001 1`
- æŸ¥æ˜¯å¦ç­¾åˆ°ï¼š`GETBIT sign:20240601 1001`
- ç»Ÿè®¡å½“æ—¥ç­¾åˆ°äººæ•°ï¼š`BITCOUNT sign:20240601`

> ğŸ’¡ **å†…å­˜å¯¹æ¯”**ï¼š
>
> - 100 ä¸‡ç”¨æˆ·ç­¾åˆ°ï¼š
>   - ç”¨ Set å­˜ç”¨æˆ· ID â†’ çº¦ 50ï½100 MB
>   - ç”¨ Bitmap â†’ ä»…éœ€ **1000000 / 8 / 1024 â‰ˆ 122 KB**

------

 **âœ… 2. æ´»è·ƒç”¨æˆ·ç»Ÿè®¡ï¼ˆDAU/MAUï¼‰**

- æ¯å¤©ç”Ÿæˆä¸€ä¸ª Bitmapï¼ˆè®°å½•å½“å¤©æ´»è·ƒç”¨æˆ·ï¼‰
- è®¡ç®—å‘¨æ´»ï¼šå¯¹ 7 å¤© Bitmap åš `BITOP OR week_active day1 day2 ... day7`
- `BITCOUNT week_active` â†’ å‘¨æ´»äººæ•°

> ğŸ” æ”¯æŒä»»æ„æ—¶é—´æ®µç»„åˆï¼ˆå¦‚â€œå·¥ä½œæ—¥æ´»è·ƒâ€ã€â€œè¿ç»­æ´»è·ƒâ€ç­‰ï¼‰

------

 **âœ… 3. å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰åº•å±‚å®ç°**

- Bloom Filter éœ€è¦å¤šä¸ª hash å‡½æ•°æ˜ å°„åˆ° bit ä½
- Redis Bitmap å¯ä½œä¸ºå…¶å­˜å‚¨åç«¯ï¼ˆä½†å®˜æ–¹æ¨èç”¨ **RedisBloom æ¨¡å—**ï¼‰

------

**âœ… 4. æƒé™æ§åˆ¶ / æ ‡ç­¾ç³»ç»Ÿ**

- æ¯ä¸ªæƒé™å¯¹åº”ä¸€ä¸ª bit ä½
- ç”¨æˆ·æƒé™ = ä¸€ä¸ª Bitmap
- åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ Aï¼ˆç¬¬ 3 ä½ï¼‰ï¼š`GETBIT user:perm:1001 3`



### åœ¨ä¸šåŠ¡ä¸­å€ŸåŠ©bitmapå®ç°ç­¾åˆ°

ç­¾åˆ°æœ‰ä¸¤ç§åšæ³•ï¼Œå¦‚æœ**äººæ•°å¯æ§**ï¼Œä¸”æ›´åŠ éœ€è¦æ£€æŸ¥å‘˜å·¥/ç”¨æˆ·**æ•´ä½“**ç­¾åˆ°æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†**keyè®¾ç½®ä¸ºyyyyMMdd**è¡¨ç¤ºæ¯ä¸€å¤©ï¼Œè€Œå†…éƒ¨çš„value bitmapçš„æ¯ä¸€ä½è¡¨ç¤º**å¯¹åº”ç¼–å·å‘˜å·¥/ç”¨æˆ·**çš„ç­¾åˆ°æƒ…å†µã€‚

å¦‚æœ**äººæ•°æ¯”è¾ƒå¤š**ï¼Œä¸”ä¸šåŠ¡æ›´åŠ æ³¨é‡ä¸æ¯ä¸€ä½ç”¨æˆ·**è‡ªå·±**çš„ç­¾åˆ°æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†**keyè®¾ç½®ä¸ºyyyyMM + userid**æ¥è¡¨ç¤ºæŸä¸€ç”¨æˆ·çš„ä¸€ä¸ªæœˆï¼Œå†…éƒ¨value bitmapçš„æ¯ä¸€ä½è¡¨ç¤º**è¯¥ç”¨æˆ·è¯¥æœˆä»½**çš„ç­¾åˆ°æƒ…å†µã€‚

> Redisçš„bitmapè‡ªåŠ¨ä»¥**å­—èŠ‚**ä¸ºå•ä½æ‰©å®¹ï¼Œå½“æˆ‘ä»¬setä¸€ä¸ªkeyçš„ç´¢å¼•ä¸º6çš„ç‚¹ä½ä¸º1/0æ—¶ï¼Œä¼šå¯¹ä»å‰å¾€åæ•°7å·ä½ç½®æ“ä½œï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼Œluaä»1å¼€å§‹ï¼‰ï¼Œè¿™æ—¶ä¼šè‡ªåŠ¨ç”³è¯·ä¸€ä¸ªå­—èŠ‚ï¼ˆ8bitï¼‰çš„ç©ºé—´ç”¨äºå­˜å‚¨è¯¥bitmapï¼›è‹¥æ˜¯æ“ä½œç¬¬12å·ç‚¹ä½ï¼Œåˆ™ä¼šæ‰©å®¹è‡³ä¸¤ä¸ªå­—èŠ‚ä»¥å­˜å‚¨è¯¥bitmapï¼›
>
> æ‰€ä»¥ä¸å¿…æ‹…å¿ƒå…¶å ç”¨ç©ºé—´ä¸å¥½æ§åˆ¶çš„é—®é¢˜ï¼Œå…¶çš„ç”³è¯·ç©ºé—´æ˜¯åŠ¨æ€çš„ï¼ˆå°½å¯èƒ½å°ï¼‰ã€‚

è€Œç›®å‰çš„ä¸šåŠ¡æ›´å€¾å‘äºç»Ÿè®¡æ¯ä¸ªç”¨æˆ·è‡ªå·±çš„ç­¾åˆ°æƒ…å†µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†keyè®¾ç½®ä¸º suffix + userid + yyyyMM çš„å½¢å¼ï¼Œvalueçš„bitmapç”¨32ä½bitå­˜å‚¨è¯¥æœˆçš„ç­¾åˆ°æƒ…å†µï¼š

```java
@Override
public Result sign() {
    UserDTO user = UserHolder.getUser();
    String key = RedisConstants.USER_SIGN_KEY + user.getId();
    // è·å–å½“å‰æ—¶é—´ï¼Œè½¬åŒ–ä¸ºæ—¥æœŸ
    LocalDateTime now = LocalDateTime.now();
    String suffix = now.format(DateTimeFormatter.ofPattern(":yyyyMM"));
    key = key + suffix;

    // è·å–å½“å‰åœ¨æœˆä»½ä¸­çš„ç¬¬å‡ å¤©
    int day = now.getDayOfMonth();

    // è®¾ç½®ç”¨æˆ·ç­¾åˆ°ï¼Œæ³¨æ„ç´¢å¼•ä»0å¼€å§‹ setbit key offset value
    stringRedisTemplate.opsForValue().setBit(key, day - 1, true);

    return Result.ok();
}
```



### ç­¾åˆ°ç»Ÿè®¡

**éœ€æ±‚ï¼š**ç»Ÿè®¡æœ¬æœˆè¿ç»­ç­¾åˆ°å¤©æ•°

æˆ‘ä»¬å¯ä»¥å€ŸåŠ©Redisçš„bitmapæä¾›çš„ç»Ÿè®¡æ¥å£ï¼Œé€†åºç»Ÿè®¡æŸä¸€ç´¢å¼•å‘å‰çš„è¿ç»­å€¼ä¸º0/1çš„æ¬¡æ•°ï¼Œå½“è·å–åˆ°æœªç­¾åˆ°çš„æ ‡è¯†æ—¶åœæ­¢è®¡æ•°ï¼š

```java
@Override
public Result signCount() {
    UserDTO user = UserHolder.getUser();
    String key = RedisConstants.USER_SIGN_KEY + user.getId();
    // è·å–å½“å‰æ—¶é—´ï¼Œè½¬åŒ–ä¸ºæ—¥æœŸ
    LocalDateTime now = LocalDateTime.now();
    String suffix = now.format(DateTimeFormatter.ofPattern(":yyyyMM"));
    key = key + suffix;

    // è·å–å½“å‰åœ¨æœˆä»½ä¸­çš„ç¬¬å‡ å¤©
    int day = now.getDayOfMonth();

    // è·å–æœ¬æœˆçš„ç­¾åˆ°è®°å½• bitfield key get i
    List<Long> result = stringRedisTemplate.opsForValue().bitField(
            key,
            BitFieldSubCommands.create().
                    get(BitFieldSubCommands.BitFieldType.unsigned(day)).valueAt(0)
    );

    // åˆ¤æ–­ç»“æœ
    if (result == null || result.isEmpty()){
        return Result.ok(0);
    }
    Long num = result.get(0);
    if (num == null || num == 0){
        return Result.ok(0);
    }

    // å¾ªç¯éå†
    int count = 0;
    // ä¸è¿ç®—ï¼Œå’Œ1ä¸è¿ç®—åï¼Œå‰å¤šä¸ªbitä½éƒ½è¢«ç½®0ï¼Œåªä½™æœ€åä¸€ä¸ªbitä½ï¼Œä¸º1ï¼Œåˆ™countåŠ 1
    while ((num & 1) != 0){
        count++;
        // >> ä¸ºå¸¦ç¬¦å·å³ç§»ï¼ˆç®—æœ¯å³ç§»ï¼‰é«˜ä½è¡¥ç¬¦å·ä½
        // >>> æ— ç¬¦å·å³ç§»ï¼ˆé€»è¾‘å³ç§»ï¼‰é«˜ä½è¡¥0
        num = num >>> 1;
    }

    return Result.ok(count);
}
```

> ```java
> List<Long> result = stringRedisTemplate.opsForValue().bitField(
>     key,
>     BitFieldSubCommands.create().
>         get(BitFieldSubCommands.BitFieldType.unsigned(day)).valueAt(0)
> );
> ```
>
> **è¿”å›å€¼ç±»å‹**
> è¿”å›ç±»å‹: `List<Long>`
> å®é™…å†…å®¹: åŒ…å«ä¸€ä¸ª Long å…ƒç´ çš„åˆ—è¡¨ï¼Œä»£è¡¨æŒ‡å®šä½ç½®çš„ä½åŸŸå€¼
>
> **å‘½ä»¤è§£æ**
> `BitFieldSubCommands.create()`
> åˆ›å»ºä¸€ä¸ª Redis BitField å‘½ä»¤æ„å»ºå™¨
>
> `get(BitFieldType.unsigned(day))`
> unsigned(day): æŒ‡å®šè·å–æ— ç¬¦å·æ•´æ•°ï¼Œå®½åº¦ä¸º day ä½
> day æ¥è‡ª now.getDayOfMonth()ï¼Œè¡¨ç¤ºå½“å‰æœˆä»½çš„å¤©æ•°
> ä¾‹å¦‚ï¼šå¦‚æœæ˜¯15å·ï¼Œåˆ™è·å–15ä½çš„æ— ç¬¦å·æ•´æ•°
>
> `valueAt(0)`
> ä»åç§»é‡0å¼€å§‹è¯»å–ä½å€¼
> ä»æœ€å·¦è¾¹çš„ä½å¼€å§‹è·å–æŒ‡å®šæ•°é‡çš„ä½ï¼Œå³ä»0~è¾“å…¥dayæ—¥æœŸ-1
>
> **å®é™…ä½œç”¨**
> è·å–æœ¬æœˆç­¾åˆ°è®°å½•: ä»Redisä¸­è·å–å­˜å‚¨çš„æœ¬æœˆç­¾åˆ°bitmap
> ä½å›¾è§£ç : å°†è¿ç»­çš„ç­¾åˆ°ä½è½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•°
> è¿ç»­ç­¾åˆ°è®¡ç®—: é€šè¿‡ (num & 1) å’Œ num >>> 1 æ“ä½œé€ä½æ£€æŸ¥è¿ç»­ç­¾åˆ°æƒ…å†µ

> å‡å¦‚éœ€è¦ç»Ÿè®¡**è·¨æœˆ**è¿ç»­ç­¾åˆ°å‘¢ï¼Ÿ
>
> å…¶å®ä¹Ÿå¯ä»¥è®°å½•**ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´**å’Œ**è¿ç»­ç­¾åˆ°æ¬¡æ•°**ï¼Œå‡å¦‚ç­¾åˆ°åæ£€æµ‹åˆ°ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´æ˜¯**å‰ä¸€å¤©**ï¼Œé‚£ä¹ˆå°±**æ¬¡æ•°+1**åŒæ—¶åˆ·æ–°**ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´**ï¼›å‡å¦‚æ£€æµ‹åˆ°ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´ä¸æ˜¯ä¸Šä¸€å¤©ï¼Œé‚£ä¹ˆæ¬¡æ•°å½’é›¶/å˜ä¸º1ã€‚ï¼ˆä»Šæ—¥ç­¾è¿‡ä¸èƒ½å†ç­¾ï¼‰

