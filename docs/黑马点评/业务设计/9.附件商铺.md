---
title: é™„ä»¶å•†é“º
date: 2025-1-21
---

### GEOæ•°æ®ç»“æ„

é™¤äº†å…ˆå‰çš„ä¸€äº›åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒRediså¼•å…¥äº†ä¸€äº›é¢å¤–çš„æ•°æ®ç±»å‹ï¼Œåœ°ç†åæ ‡geoå°±åœ¨å…¶ä¸­ï¼š

- Redis ä½¿ç”¨ Sorted Set å­˜å‚¨åœ°ç†ä½ç½®ï¼š
  - **æˆå‘˜ï¼ˆmemberï¼‰**ï¼šä½ç½®åç§°ï¼ˆå¦‚ `"user:123"`ã€`"shop:beijing"`ï¼‰
  - **score**ï¼šè¯¥ä½ç½®çš„ **52 ä½æ•´æ•°ç¼–ç **ï¼ˆé€šè¿‡ **GeoHash ç®—æ³•** å°†ç»çº¬åº¦è½¬æ¢è€Œæ¥ï¼‰

| å‘½ä»¤                               | åŠŸèƒ½                             | è¯­æ³•                                                         | å…¸å‹å‚æ•°/é€‰é¡¹                                                | è¿”å›å€¼                                                   | æ³¨æ„äº‹é¡¹                                                 |
| :--------------------------------- | :------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------------------------------- | :------------------------------------------------------- |
| **`GEOADD`**                       | **æ·»åŠ **ä¸€ä¸ªæˆ–å¤šä¸ªåœ°ç†ä½ç½®       | `GEOADD key longitude latitude member [longitude latitude member ...]` | - ç»åº¦èŒƒå›´ï¼š-180 ï½ +180 - çº¬åº¦èŒƒå›´ï¼š-85.0511 ï½ +85.0511    | æˆåŠŸæ·»åŠ çš„æˆå‘˜æ•°é‡ï¼ˆæ•´æ•°ï¼‰                               | â€¢ åŒå member ä¼šè¦†ç›–æ—§ä½ç½® â€¢ åº•å±‚æ˜¯ `ZADD`               |
| **`GEOPOS`**                       | **è·å–**æŒ‡å®šæˆå‘˜çš„ç»çº¬åº¦         | `GEOPOS key member [member ...]`                             | æ”¯æŒæ‰¹é‡æŸ¥è¯¢                                                 | æ¯ä¸ªæˆå‘˜å¯¹åº” `[longitude, latitude]`ï¼Œä¸å­˜åœ¨åˆ™è¿”å› `nil` | è¿”å›é«˜ç²¾åº¦æµ®ç‚¹æ•°                                         |
| **`GEODIST`**                      | è®¡ç®—ä¸¤ä¸ªä½ç½®é—´çš„**è·ç¦»**         | `GEODIST key member1 member2 [unit]`                         | `unit` å¯é€‰ï¼š `m`ï¼ˆç±³ï¼Œé»˜è®¤ï¼‰ã€`km`ã€`ft`ã€`mi`              | è·ç¦»æ•°å€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå•ä½ç”±å‚æ•°å†³å®šï¼›æˆå‘˜ä¸å­˜åœ¨è¿”å› `nil` | åŸºäº Haversine å…¬å¼ï¼ˆçƒé¢è·ç¦»ï¼‰                          |
| **`GEORADIUS`** ï¼ˆå·²åºŸå¼ƒï¼‰         | æ ¹æ®**åæ ‡**æœç´¢é™„è¿‘ä½ç½®         | `GEORADIUS key longitude latitude radius unit [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT n] [ASC|DESC] [STORE key]` | â€¢ `radius`ï¼šåŠå¾„ â€¢ `unit`ï¼šm/km/ft/mi â€¢ `WITHxxx`ï¼šè¿”å›é™„åŠ ä¿¡æ¯ â€¢ `COUNT`ï¼šé™åˆ¶ç»“æœæ•° | æˆå‘˜åˆ—è¡¨ï¼ˆå¯å¸¦è·ç¦»ã€åæ ‡ç­‰ï¼‰                             | âš ï¸ Redis 6.2+ å·²åºŸå¼ƒï¼Œæ”¹ç”¨ `GEOSEARCH`                    |
| **`GEORADIUSBYMEMBER`** ï¼ˆå·²åºŸå¼ƒï¼‰ | æ ¹æ®**å·²æœ‰æˆå‘˜**æœç´¢é™„è¿‘ä½ç½®     | `GEORADIUSBYMEMBER key member radius unit [é€‰é¡¹åŒä¸Š]`        | åŒä¸Š                                                         | åŒä¸Š                                                     | âš ï¸ Redis 6.2+ å·²åºŸå¼ƒ                                      |
| **`GEOSEARCH`** ï¼ˆæ¨è âœ…ï¼‰         | ç»Ÿä¸€åœ°ç†æœç´¢å‘½ä»¤ï¼ˆåæ ‡ or æˆå‘˜ï¼‰ | `GEOSEARCH key FROM{LONLAT|MEMBER} ... BY{RADIUS|BOX} ... [WITHDIST] [WITHCOORD] [COUNT n] [ASC|DESC]` | â€¢ `FROMLONLAT lon lat` â€¢ `FROMMEMBER member` â€¢ `BYRADIUS r unit` â€¢ `BYBOX width height unit` | æˆå‘˜åˆ—è¡¨ï¼ˆæ”¯æŒä¸°å¯Œå…ƒæ•°æ®ï¼‰                               | âœ… Redis 6.2+ æ¨èä½¿ç”¨ â€¢ æ”¯æŒåœ†å½¢ & çŸ©å½¢åŒºåŸŸ â€¢ è¯­ä¹‰æ›´æ¸…æ™° |
| **`ZREM`**                         | åˆ é™¤æŸä¸ªåœ°ç†ä½ç½®                 | `ZREM key member [member ...]`                               | â€”                                                            | æˆåŠŸåˆ é™¤çš„æ•°é‡                                           | GEO æ— ä¸“ç”¨åˆ é™¤å‘½ä»¤ï¼Œå› åº•å±‚æ˜¯ ZSet                        |

------

> **ğŸ”” è¡¥å……è¯´æ˜ï¼š**
>
> - **åº•å±‚å­˜å‚¨**ï¼šæ‰€æœ‰ GEO æ•°æ®å®é™…å­˜å‚¨åœ¨ **Sorted Set** ä¸­ï¼Œå¯ç”¨ `ZRANGE key 0 -1 WITHSCORES` æŸ¥çœ‹ GeoHash å€¼ã€‚
> - **ç²¾åº¦**ï¼šçº¦ **0.5 ç±³**ï¼ˆ52 ä½ GeoHash ç¼–ç ï¼‰ã€‚
> - **æ€§èƒ½**ï¼šé€‚åˆ **ç™¾ä¸‡çº§ä»¥å†…** çš„å®æ—¶ LBS åœºæ™¯ï¼›è¶…å¤§è§„æ¨¡å»ºè®®ç»“åˆ **Elasticsearch** æˆ–ä¸“ä¸š GISã€‚
> - **å•ä½æ³¨æ„**ï¼š`GEODIST` å’Œ `GEOSEARCH` ä¸­çš„å•ä½å¿…é¡»æ˜¾å¼æŒ‡å®šï¼ˆå¦‚ `km`ï¼‰ï¼Œå¦åˆ™é»˜è®¤ä¸º **ç±³ï¼ˆmï¼‰**ã€‚
>

| ç‰¹æ€§         | è¯´æ˜                                            |
| :----------- | :---------------------------------------------- |
| **åº•å±‚å®ç°** | Sorted Set + GeoHash                            |
| **æ ¸å¿ƒèƒ½åŠ›** | å­˜å‚¨ä½ç½®ã€ç®—è·ç¦»ã€æœé™„è¿‘                        |
| **é€‚ç”¨åœºæ™¯** | LBSã€é™„è¿‘æ¨èã€å®æ—¶å®šä½                         |
| **æ›¿ä»£æ–¹æ¡ˆ** | **å¤§æ•°æ®é‡ç”¨ ES** / PostGISï¼›é«˜å¹¶å‘ç”¨ Redis GEO |
| **æ³¨æ„**     | Redis 6.2+ ä¼˜å…ˆç”¨ `GEOSEARCH`                   |

> ğŸ’¡ **ä¸€å¥è¯è®°ä½**ï¼š
> **Redis GEO = ç”¨ Sorted Set å­˜ä½ç½®ï¼Œç”¨ GeoHash å¿«é€Ÿç­›ï¼Œç”¨ Haversine ç²¾ç¡®ç®—ã€‚**



### é™„ä»¶å•†é“ºæœç´¢

æŒ‰ç…§å¦‚ä¸Šç»™å‡ºçš„Redisçš„geoæ•°æ®ç±»å‹æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆ**å­˜å‚¨å•†å®¶ç»çº¬åº¦**åˆ°Redisçš„Geo zsetä¸­ï¼Œå†ä½¿ç”¨**geosearch**æœç´¢é™„è¿‘çš„åº—é“ºã€‚

åŒæ—¶ï¼Œæ¨èå•†åº—ä¸€èˆ¬ä¼šæ¨è**ç±»ä¼¼**çš„å•†åº—ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•ä½¿ç”¨**æ•°æ®åº“çš„typeå­—æ®µ**å¯¹å•†åº—ç±»å‹åšäº†ä¸€ä¸ªåˆ†ç±»ï¼ˆè€ƒè™‘ä½¿ç”¨Enumsç»´æŠ¤ç±»å‹ä¸ä»£å·æ˜ å°„ï¼‰ï¼Œæ¨èæ—¶å°±æ˜¯ç”¨è¿™ä¸ªç±»å‹æ¥åšåŒç±»æ¨èã€‚è€Œåˆ°Redisä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©å°†æ‰€æœ‰åŒä¸€typeçš„å•†åº—å­˜è‡³åŒä¸€ä¸ªGeo zsetçš„valueä¸­ï¼Œä½¿ç”¨typeæ‹¼æ¥ä¸ºkeyã€‚

```java
    @Override
    public Result queryShopByType(Integer typeId, Integer current, Double x, Double y) {
        // åæ ‡å¯èƒ½ä¸ºnullï¼Œç›´æ¥åˆ†é¡µå³å¯
        if (x == null || y == null) {
            // æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢
            Page<Shop> page = query()
                    .eq("type_id", typeId)
                    .page(new Page<>(current, SystemConstants.DEFAULT_PAGE_SIZE));
            // è¿”å›æ•°æ®
            return Result.ok(page.getRecords());
        }
        // æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢
        int from = (current - 1) * SystemConstants.DEFAULT_PAGE_SIZE;   // è®¡ç®—åˆ†é¡µå¼€å§‹ç´¢å¼•
        int end = current * SystemConstants.DEFAULT_PAGE_SIZE;  // è®¡ç®—åˆ†é¡µç»“æŸç´¢å¼•

        // è·å–é™„ä»¶ç›¸ä¼¼ç±»å‹åº—é“ºï¼Œtypeidä¸ºkeyï¼Œè¾“å…¥xyä»¥åŠèŒƒå›´ï¼Œä¸ªæ•°ï¼Œåˆ†é¡µ
        String key = RedisConstants.SHOP_GEO_KEY + typeId;
        GeoResults<RedisGeoCommands.GeoLocation<String>> search = stringRedisTemplate.opsForGeo().search(
                key,                                // key
                GeoReference.fromCoordinate(x, y),  // è¾“å…¥åæ ‡
                new Distance(50),             		// èŒƒå›´
                RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs()
                        .includeDistance()
                        .limit(end)                 // æŸ¥è¯¢ä¸ªæ•°ï¼Œfromæ— æ³•æŒ‡å®šï¼Œåªèƒ½ä»0å¼€å§‹è¿”å›ç»“æœï¼Œéœ€è¦è‡ªè¡Œå¤„ç†0~end
        );
        // è·å–åº—é“ºid
        if (search == null || search.getContent().isEmpty()) {   // æ²¡æœ‰ç»“æœ
            return Result.ok();
        }
        List<GeoResult<RedisGeoCommands.GeoLocation<String>>> content = search.getContent();
        
        if (content.size() <= from){    // åˆ†é¡µåæ²¡æœ‰ç»“æœ
            return Result.ok();
        }
        // å¯¹æ•°æ®åšå¤„ç†
        // æˆªå–from ~ end
        List<Long> ids = new ArrayList<>(content.size());
        Map<String, Distance> map = new HashMap<>(content.size());
        content.stream().
                skip(from).                                         // è·³è¿‡fromä¸ªæ•°
                forEach(item -> {
                    String name = item.getContent().getName();
                    ids.add(Long.valueOf(name));
                    Distance distance = item.getDistance();
                    map.put(name, distance);
                });

        // æ ¹æ®idæŸ¥è¯¢
//        List<Shop> list = query().in("id", ids).last("ORDER BY FIELD(id," + ids + ")").list();
        String idsStr = StrUtil.join(",", ids);
        List<Shop> list = list(new QueryWrapper<Shop>().
                in("id", ids).
                last( "ORDER BY FIELD(id," + idsStr + ")")
        );
        for (Shop shop : list) {
            shop.setDistance(map.get(shop.getId().toString()).getValue());
        }

        return Result.ok(list);
    }
```

 