---
title: Redisæ¶ˆæ¯é˜Ÿåˆ—
date: 2025-1-18
---

## æ¶ˆæ¯é˜Ÿåˆ—

é’ˆå¯¹æˆ‘ä»¬å…ˆå‰æåˆ°çš„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚**å¼‚æ­¥**æäº¤ä»»åŠ¡çš„é˜Ÿåˆ—ä¸­ï¼Œæ€ä¹ˆå»è®°å½•**å¼‚å¸¸ä¿¡æ¯**ï¼Œå‡å¦‚åç»­éœ€è¦å»è·å–å¼‚æ­¥æ“ä½œï¼ˆä¸¤è·¯å¹¶è¡Œæ‰§è¡Œï¼‰çš„**ç»“æœ**ã€‚é‚£è¯¥æ€ä¹ˆåŠï¼Ÿ

é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å»è€ƒè™‘ä½¿ç”¨**æ¶ˆæ¯é˜Ÿåˆ—**äº†ï¼š

**æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆMessage Queueï¼‰æ˜¯ä¸€ç§**å¼‚æ­¥é€šä¿¡æœºåˆ¶**ï¼Œç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°**ç”Ÿäº§è€…**ä¸**æ¶ˆè´¹è€…**ä¹‹é—´çš„è§£è€¦ã€‚å®ƒé€šè¿‡ä¸€ä¸ªä¸­é—´å±‚ï¼ˆæ¶ˆæ¯ä»£ç†ç¼“å†²åŒºï¼‰**å­˜å‚¨**å’Œ**è½¬å‘**æ¶ˆæ¯ï¼Œç¡®ä¿æ•°æ®çš„å¯é ä¼ é€’ã€‚

| è§’è‰²                                   | è¯´æ˜                                                         |
| :------------------------------------- | :----------------------------------------------------------- |
| **ç”Ÿäº§è€…ï¼ˆProducerï¼‰**                 | è´Ÿè´£åˆ›å»ºå¹¶å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¾‹å¦‚ï¼šè®¢å•æœåŠ¡åœ¨ç”¨æˆ·ä¸‹å•åå‘é€â€œè®¢å•åˆ›å»ºâ€äº‹ä»¶ã€‚ |
| **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue / Brokerï¼‰** | å­˜å‚¨ã€ç®¡ç†æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼Œä¹Ÿç§°ä¸º**æ¶ˆæ¯ä»£ç†**ï¼ˆMessage Brokerï¼‰ã€‚è´Ÿè´£æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¹¶æŒ‰è§„åˆ™åˆ†å‘ç»™æ¶ˆè´¹è€…ã€‚ |
| **æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰**                 | ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼šåº“å­˜æœåŠ¡ç›‘å¬â€œè®¢å•åˆ›å»ºâ€äº‹ä»¶ï¼Œæ‰£å‡åº“å­˜ã€‚ |

```mermaid
graph LR
    A[ç”Ÿäº§è€…<br>Producer] --> B[æ¶ˆæ¯é˜Ÿåˆ—<br>Message Queue]
    B --> C[æ¶ˆè´¹è€…<br>Consumer]

    style A fill:#4285f5,stroke:#333,stroke-width:2px
    style B fill:#f8d7da,stroke:#dc3545,stroke-width:2px
    style C fill:#28a745,stroke:#333,stroke-width:2px

    linkStyle default stroke:#333,stroke-width:2px
```

åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸€äº›æˆç†Ÿçš„ç»„ä»¶ï¼š

| äº§å“         | ç‰¹ç‚¹           | å…¸å‹ç”¨é€”             |
| :----------- | :------------- | :------------------- |
| **RabbitMQ** | å¯é ã€çµæ´»è·¯ç”± | ä¼ä¸šçº§åº”ç”¨ã€ä»»åŠ¡è°ƒåº¦ |
| **Kafka**    | é«˜ååã€æ—¥å¿—æµ | æ—¥å¿—æ”¶é›†ã€å¤§æ•°æ®ç®¡é“ |
| **RocketMQ** | é«˜æ€§èƒ½ã€é‡‘èçº§ | ç”µå•†ã€æ”¯ä»˜ã€äº¤æ˜“ç³»ç»Ÿ |
| **Pulsar**   | å¤šç§Ÿæˆ·ã€äº‘åŸç”Ÿ | äº‘è®¡ç®—ã€å¾®æœåŠ¡       |

> çœŸåˆ°äº†å¾®æœåŠ¡å±‚çº§ï¼ŒRedisæä¾›çš„Redis Streamæ˜¯ä¸å¤Ÿç”¨çš„ï¼Œè¿˜æ˜¯ä½¿ç”¨æˆç†Ÿçš„MQä¸­é—´ä»¶æ›´åˆé€‚ï¼ˆé“¾è·¯è¿½è¸ªç­‰æ–¹é¢åšçš„å¥½å¾—å¤šï¼‰è¿™é‡Œçœ‹çœ‹å°±è¡Œ
>

Redisçš„ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—ï¼š

| æ¨¡å‹        | æ˜¯å¦æŒä¹…åŒ– | æ˜¯å¦æ”¯æŒæ¶ˆè´¹è€…ç»„ | æ˜¯å¦æ”¯æŒ ACK | é€‚ç”¨åœºæ™¯                 |
| :---------- | :--------- | :--------------- | :----------- | :----------------------- |
| **Pub/Sub** | âŒ å¦       | âŒ å¦             | âŒ å¦         | å®æ—¶é€šçŸ¥ã€å¹¿æ’­äº‹ä»¶       |
| **LIST**    | âŒ å¦       | âŒ å¦             | âŒ å¦         | ç®€å•ä»»åŠ¡åˆ†å‘ï¼ˆå…è®¸ä¸¢å¤±ï¼‰ |
| **STREAM**  | âœ… æ˜¯       | âœ… æ˜¯             | âœ… æ˜¯         | å¯é æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æº¯æº   |



## Listç±»å‹çš„Redisæ¶ˆæ¯é˜Ÿåˆ—

Listç±»å‹æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯åŸºäºRedisæœ¬èº«æä¾›çš„List**åŒå‘é“¾è¡¨**å®ç°çš„ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç»“åˆLpushä»¥åŠRpopï¼ˆæˆ–è€…å€’è¿‡æ¥ï¼‰æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ï¼Œè¿™é‡Œä¸ºäº†ä¿è¯é˜»å¡æ•ˆæœï¼ˆé˜»å¡/å¾ªç¯ç­‰å¾…æ•°æ®å¹¶æå–äº¤ç»™æ¶ˆè´¹è€…ï¼‰ï¼Œä¼šä½¿ç”¨BRpopï¼ˆ**é˜»å¡**æ³µå‡ºï¼Œå½“æœ‰æ•°æ®æ—¶æ³µå‡ºï¼Œæ— æ•°æ®æ—¶**é˜»å¡ç­‰å¾…**ï¼‰è·å–æ•°æ®/æ“ä½œæ¶ˆæ¯ã€‚

è¿™æ ·çš„é˜Ÿåˆ—æ”¯æŒå•å¯¹å•/å¤šçš„æ¶ˆæ¯ä¼ é€’ï¼ŒåŒæ—¶æ¶ˆæ¯ä¸¢å¤±æ— æ³•é¿å…ï¼ˆå†…å­˜æ±°æ¢ï¼Œä¸šåŠ¡å¤±è´¥æ¶ˆæ¯ä¸¢å¤±ï¼‰

```mermaid
graph LR
    P[ç”Ÿäº§è€…] -->|LPUSH| L(åˆ—è¡¨)
    R1[æ¶ˆè´¹è€…1] -->|RPOP| L
    R2[æ¶ˆè´¹è€…2] -->|RPOP| L
```



## PubSubç±»å‹çš„Redisæ¶ˆæ¯é˜Ÿåˆ—

è¿™ç§ç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒæ¶ˆè´¹è€…è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œå½“ç”Ÿäº§è€…å‘channelå‘é€æ¶ˆæ¯ï¼Œæ‰€æœ‰è®¢é˜…äº†è¯¥channelçš„æ¶ˆè´¹è€…éƒ½èƒ½è·å–åˆ°æ¶ˆæ¯ã€‚Redissionçš„**RTopic**å°±æ˜¯åŸºäºè¯¥æ¶ˆæ¯é˜Ÿåˆ—å®ç°çš„ï¼Œè¿™ç§æ¶ˆæ¯é˜Ÿåˆ—é€‚ç”¨äº**å¹¿æ’­**çš„åœºæ™¯ã€‚

å½“ç„¶ï¼Œä¹Ÿè¿˜æ˜¯æ— æ³•å®ç°æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ã€‚
```mermaid
graph LR
    P[ç”Ÿäº§è€…] -->|å‘å¸ƒæ¶ˆæ¯| C1(é¢‘é“)
    C1 -->|è®¢é˜…å¹¶æ¥æ”¶æ¶ˆæ¯|R1[æ¶ˆè´¹è€…1]
    C1 -->|è®¢é˜…å¹¶æ¥æ”¶æ¶ˆæ¯|R2[æ¶ˆè´¹è€…2]
```



## Streamç±»å‹çš„Redisæ¶ˆæ¯é˜Ÿåˆ—

Redisä¸­çš„è¿™ç§æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä½œä¸ºæ•°æ®ç±»å‹çš„ï¼Œä¹Ÿå³å…¶å¯ä»¥è¢«æŒä¹…åŒ–ï¼Œä¼šå°†æ¶ˆæ¯å­˜å‚¨åˆ°Redisä¸­ã€‚åŒæ—¶ä¹Ÿæ˜¯Redisä¸“é—¨ä¸ºæ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œç›¸æ¯”å‰é¢ä¸¤ä¸ªç±»å‹ï¼Œå…¶æ›´åŠ å®Œæ•´ï¼Œæä¾›äº†è¯¸å¤šMQçš„åŸºç¡€åŠŸèƒ½ï¼Œå¦‚æ˜¯å¦é˜»å¡ç­‰å¾…ï¼Œç­‰å¾…æ—¶é—´ç­‰ã€‚

streamå­˜å‚¨ç”Ÿäº§è€…æä¾›çš„æ¶ˆæ¯ï¼ˆstreamå†…çš„æ¶ˆæ¯ä¸ä¼šåˆ é™¤ï¼‰ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç»„å…±äº«æ¶ˆæ¯ï¼ˆè®¢é˜…è¯¥streamï¼‰ï¼Œç»„å†…å°†è¯¥æ¶ˆæ¯åˆ†æµåˆ°ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆxreadgroupï¼‰å°†æ•°æ®æ”¾åˆ°pending-listï¼ˆç»„å†…å…±äº«ï¼Œæ¯ç»„ä¸€ä¸ªï¼‰ä¸­ï¼Œæ¶ˆè´¹è€…å®Œæˆåxackç¡®è®¤å·²å®Œæˆå¹¶ä»pending-listä¸­åˆ é™¤è¯¥æ¶ˆæ¯

```mermaid
graph LR
    P[ç”Ÿäº§è€…] -->|XADD| S(æµ)
    CG1(æ¶ˆè´¹è€…ç»„1) -->|XREADGROUP| S
    CG1 -->|ç¡®è®¤å¤„ç†| P
    CG2(æ¶ˆè´¹è€…ç»„2) -->|XREADGROUP| S
    CG2 -->|ç¡®è®¤å¤„ç†| P
```

| ç‰¹æ€§                            | è¯´æ˜                                                         |
| :------------------------------ | :----------------------------------------------------------- |
| **æŒä¹…åŒ–å­˜å‚¨**                  | æ¶ˆæ¯å†™å…¥å†…å­˜ + å¯é€‰æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆAOF/RDBï¼‰ï¼Œ**ä¸ä¼šå› å®¢æˆ·ç«¯ç¦»çº¿ä¸¢å¤±** |
| **æ¶ˆæ¯ ID è‡ªåŠ¨ç”Ÿæˆ**            | æ¯æ¡æ¶ˆæ¯æœ‰å”¯ä¸€ IDï¼ˆå¦‚ `1678901234567-0`ï¼‰ï¼Œæ”¯æŒæŒ‰ ID èŒƒå›´æŸ¥è¯¢ |
| **æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupsï¼‰** | ç±»ä¼¼ Kafkaï¼šå¤šä¸ªæ¶ˆè´¹è€…åˆ†ç»„åä½œæ¶ˆè´¹ï¼Œ**æ¯æ¡æ¶ˆæ¯åªè¢«ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†** |
| **ACK æœºåˆ¶**                    | æ¶ˆè´¹è€…å¤„ç†æˆåŠŸåéœ€æ‰‹åŠ¨ç¡®è®¤ï¼ˆ`XACK`ï¼‰ï¼Œå¤±è´¥å¯é‡è¯•æˆ–è¿›å…¥æ­»ä¿¡é˜Ÿåˆ— |
| **æ¶ˆæ¯å›æº¯**                    | å¯ä»ä»»æ„ ID å¼€å§‹è¯»å–å†å²æ¶ˆæ¯ï¼ˆé€‚åˆæ•…éšœæ¢å¤ã€é‡æ”¾ï¼‰           |

**åŸºæœ¬å‘½ä»¤ç¤ºä¾‹**

```bash
# 1. ç”Ÿäº§æ¶ˆæ¯ï¼ˆè‡ªåŠ¨åˆ†é…IDï¼‰
XADD mystream * event "user_login" user_id 1001

# 2. åˆ›å»ºæ¶ˆè´¹è€…ç»„
XGROUP CREATE mystream mygroup $

# 3. æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯ï¼ˆ> è¡¨ç¤ºåªè¯»æ–°æ¶ˆæ¯ï¼‰
XREADGROUP GROUP mygroup consumer1 COUNT 1 STREAMS mystream >

# 4. ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
XACK mystream mygroup 1678901234567-0
```

ä¸å…¶ä»–ä¸¤ç§ç±»å‹çš„åŒºåˆ«ï¼š

| æ¨¡å¼        | æ˜¯å¦æŒä¹…åŒ– | æ¶ˆè´¹æ¨¡å‹           | ACK  | é€‚ç”¨åœºæ™¯                   |
| :---------- | :--------- | :----------------- | :--- | :------------------------- |
| **Pub/Sub** | âŒ å¦       | å¹¿æ’­ï¼ˆæ‰€æœ‰è®¢é˜…è€…ï¼‰ | âŒ    | å®æ—¶é€šçŸ¥ï¼ˆå…è®¸ä¸¢å¤±ï¼‰       |
| **LIST**    | âŒ å¦       | ç‚¹å¯¹ç‚¹ï¼ˆç«äº‰æ¶ˆè´¹ï¼‰ | âŒ    | ç®€å•ä»»åŠ¡é˜Ÿåˆ—               |
| **Stream**  | âœ… æ˜¯       | æ¶ˆè´¹è€…ç»„ + å•æ’­    | âœ…    | **å¯é æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æº¯æº** |

å¯¹äºéæ¶ˆè´¹ç»„è¯»**XREAD**ï¼Œæœ‰å‡ ä¸ªç‰¹æ€§ï¼š

- æ¶ˆæ¯å¯å›æº¯ï¼ˆæ¶ˆæ¯ä¸ä¼šåˆ é™¤ï¼‰
- ä¸€ä¸ªæ¶ˆæ¯å¯è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–ï¼ˆéç ´åå¼è¯»å–ï¼‰
- å¯ä»¥é˜»å¡è¯»å–ï¼ˆæ¯”BLPOPæ›´åŠ å®Œæ•´å®Œå–„ï¼‰

ä½†æ˜¯å­˜åœ¨æ¶ˆæ¯æ¼è¯»çš„å¯èƒ½ï¼Œæ‰€ä»¥Rediså°±æä¾›äº†å¦å¤–ä¸€ç§æ–¹å¼æ¥é˜²æ­¢è¿™ç§æƒ…å†µçš„å‡ºç°ã€‚



## Redis Streamçš„æ¶ˆè´¹è€…ç»„

**æ¶ˆæ¯åˆ†æµ**ï¼šå¤šä¸ªæ¶ˆè´¹è€…åˆ†ç»„åä½œæ¶ˆè´¹ï¼Œ**æ¯æ¡æ¶ˆæ¯åªè¢«ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†**ï¼Œä¹Ÿå³æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…ä¸åŒæ¶ˆè´¹è€…ï¼ˆå½“ç„¶éœ€è¦è¢«å¤šä¸ªæ¶ˆè´¹è€…å…±åŒè·å–çš„è¯ï¼ŒåŠ å¤šä¸ªæ¶ˆè´¹è€…ç»„å³å¯ï¼‰ã€‚

**æ¶ˆæ¯æ ‡è¯†**ï¼š**æ¶ˆæ¯ä¸ä¼šè¢«åˆ é™¤**ï¼Œæ¶ˆè´¹çš„è®°å½•æ˜¯é€šè¿‡ç»„å†…ç»´æŠ¤ä¸€ä¸ª**æ ‡è¯†**æ¥å†³å®šä¸‹ä¸€æ¬¡è¯»å–çš„æ¶ˆæ¯ã€‚

**æ¶ˆæ¯ç¡®è®¤**ï¼šæ¶ˆè´¹è€…åœ¨è·å–åˆ°æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥pending-listä¸­ï¼Œå¤„ç†å®Œæˆåéœ€è¦è·å–xackä»¥æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œå¹¶ä»pending-listä¸­åˆ é™¤ï¼ˆå®•æœºæ—¶æ¶ˆæ¯çŠ¶æ€ä¼šè¢«æŒä¹…åŒ–åˆ°æœ¬åœ°ä¸­è€Œéç›´æ¥ä¸¢å¤±ï¼‰

### **ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š**`XREADGROUP`

**å‘½ä»¤æ ¼å¼ï¼š**

```bash
XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]
```

**å‚æ•°è¯¦è§£ï¼š**

| å‚æ•°                 | è¯´æ˜                                                         |
| :------------------- | :----------------------------------------------------------- |
| `group`              | æ¶ˆè´¹ç»„åç§°                                                   |
| `consumer`           | æ¶ˆè´¹è€…åç§°ï¼Œè‹¥ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º                               |
| `COUNT count`        | æœ€å¤šè¿”å›çš„æ¶ˆæ¯æ•°é‡ï¼Œé»˜è®¤ä¸º 1                                 |
| `BLOCK milliseconds` | å½“æ— æ–°æ¶ˆæ¯æ—¶é˜»å¡ç­‰å¾…çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¦‚ `BLOCK 1000` è¡¨ç¤ºæœ€å¤šç­‰ 1 ç§’ï¼›è®¾ä¸º `0` åˆ™æ— é™ç­‰å¾… |
| `NOACK`              | å¦‚æœè®¾ç½®ï¼Œè·å–æ¶ˆæ¯åä¸ä¼šæ ‡è®°ä¸ºâ€œå·²ç¡®è®¤â€ï¼Œé€‚ç”¨äºæ— éœ€æ‰‹åŠ¨ ACK çš„åœºæ™¯ï¼ˆä¸€èˆ¬ä¸ç”¨ï¼Œä»¥é˜²ä¸‡ä¸€ï¼‰ |
| `STREAMS key ...`    | è¦è¯»å–çš„ Stream åç§°åˆ—è¡¨                                     |
| `ID`                 | ä»å“ªä¸ªæ¶ˆæ¯ ID å¼€å§‹è¯»å–                                       |

| ID å€¼               | å«ä¹‰                                                       |
| :------------------ | :--------------------------------------------------------- |
| `">"`               | ä»ä¸‹ä¸€ä¸ªæœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹ï¼ˆæ¨èç”¨äºæ­£å¸¸æ¶ˆè´¹ï¼‰             |
| `"0"`               | ä» pending-list ä¸­ç¬¬ä¸€ä¸ª**æœªç¡®è®¤**çš„æ¶ˆæ¯å¼€å§‹ï¼ˆå¸¸ç”¨äºé‡è¯•ï¼‰ |
| `"1642738912000-0"` | æŒ‡å®šæŸä¸ªå…·ä½“çš„ ID å¼€å§‹è¯»å–                                 |

> ğŸ’¡ ä½¿ç”¨ `">"` æ˜¯æœ€å¸¸è§çš„æ–¹å¼ï¼Œè¡¨ç¤ºâ€œç»™æˆ‘ä¸‹ä¸€æ¡è¿˜æ²¡æ¶ˆè´¹çš„æ¶ˆæ¯â€ã€‚

è¯»å–åæ¶ˆæ¯è¢«æ”¾å…¥ç»„å†…pending-listã€‚

### XACKç¡®è®¤æ¶ˆæ¯å·²å¤„ç†

```bash
XACK mystream mygroup <message_id>
```

- å°†æŒ‡å®šæ¶ˆæ¯ä» pending list ä¸­ç§»é™¤ï¼Œè¡¨ç¤ºå·²æˆåŠŸå¤„ç†
- è‹¥ä¸ ACKï¼Œåˆ™æ¶ˆæ¯ä¼šä¸€ç›´ç•™åœ¨ pending listï¼Œå¯ç”¨äºç›‘æ§æœªå®Œæˆä»»åŠ¡

### ä»pending-listä¸­è·å–æœªç¡®è®¤æ¶ˆæ¯

```bash
XPENDING mystream mygroup
```

- æ˜¾ç¤ºå½“å‰ç»„ä¸­æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯
- å¯æŸ¥çœ‹å“ªäº›æ¶ˆè´¹è€…å¡ä½äº†ã€å“ªäº›æ¶ˆæ¯éœ€è¦é‡è¯•

åç»­çš„ä¸šåŠ¡éœ€è¦ç”¨åˆ°streamçš„æ¶ˆæ¯é˜Ÿåˆ—çš„è¯ï¼Œæµç¨‹å°±æ˜¯ï¼š

1. ç”Ÿäº§è€…xaddæ¶ˆæ¯åˆ°stream
2. æ¶ˆè´¹è€…xreadgroupè¯»å–æ¶ˆæ¯ï¼ˆ>è¯»å–æœ€æ–°**æœªæ¥æ”¶**æ¶ˆæ¯ï¼‰ï¼Œæ¶ˆæ¯æ”¾å…¥ç»„å†…pending-listï¼Œå°è¯•å®Œæˆç›¸åº”æ“ä½œ
3. æ¶ˆè´¹è€…xackç¡®è®¤æ¶ˆæ¯å·²ç»å®Œæˆï¼Œç»„å†…pending-liståˆ é™¤è¯¥æ¶ˆæ¯
4. æ¶ˆè´¹è€…å†æ¬¡è¯»å–æ¶ˆæ¯ï¼ˆ0è¯»å–**æœªå®Œæˆ**æ¶ˆæ¯ï¼‰ï¼Œå°è¯•å®Œæˆ

> MQä¸€èˆ¬ç”¨äºå¤„ç†å¼‚æ­¥**æ— éœ€è¿”å›å€¼**ä¸šåŠ¡ï¼Œæ‰€ä»¥RedisStreamæœ¬èº«ä¸æä¾›ç”Ÿäº§è€…ç»“æœè·å–ï¼Œéœ€è¦**è‡ªè¡Œè®¾è®¡**ï¼Œå¦‚æ¶ˆè´¹è€…å°†ç»“æœå†æ¬¡å­˜å…¥Redisçš„ä¸€æ¡æ–°çš„æµæˆ–æ˜¯Stringä¸­ï¼Œç”Ÿäº§è€…é˜»å¡/è½®è¯¢è¯»å–å­˜å…¥ç»“æœã€‚
>



## åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨Streamå®ç°å¼‚æ­¥æ‰§è¡Œ

é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…ˆå‰å®Œæˆçš„luaè„šæœ¬ï¼Œåœ¨å…¶ä¸­åŠ å…¥xaddå®Œæˆå°†æ¶ˆæ¯å­˜å…¥é˜Ÿåˆ—çš„æ“ä½œï¼š

```lua
local voucherId = ARGV[1]
local userId = ARGV[2]
local orderId = ARGV[3]
-- åº“å­˜ key
local stockKey = "seckill:stock:" .. voucherId
-- è®¢å• key
local orderKey = "seckill:order:" .. voucherId

-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³
if (tonumber(redis.call("get", stockKey)) <= 0) then
    -- åº“å­˜ä¸è¶³
    return 1
end

-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦é‡å¤ä¸‹å•
if (redis.call("sismember", orderKey, userId) == 1) then
    -- ç”¨æˆ·é‡å¤ä¸‹å•
    return 2
end

-- æ‰£å‡åº“å­˜
redis.call("incr", stockKey, -1)
-- å°†ç”¨æˆ·è®°å½•åˆ° set é›†åˆä¸­
redis.call("sadd", orderKey, userId)
-- å‘é€æ¶ˆæ¯
redis.call("xadd", "stream.orders", "*", "userId", userId, "voucherId", voucherId, "id", orderId)

return 0
```

ç°åœ¨å°†luaæ”¾å…¥ä¸šåŠ¡ä¸­æ‰§è¡Œï¼š

```java
/**
 * ç§’æ€ä¼˜æƒ åˆ¸
 *
 * @param voucherId ä¼˜æƒ åˆ¸id
 * @return è®¢å•id
 */
@Override
public Result seckillVoucher(Long voucherId) throws BusinessException {
    // æ‰§è¡Œlua
    Long userId = UserHolder.getUser().getId();
    Long id = redisIdWorker.nextId("order");
    // åˆ›å»ºè®¢å•
    Long result = stringRedisTemplate.execute(
            SECKILL_SCRIPT,
            Collections.emptyList(),
            userId.toString(),
            voucherId.toString(),
            id.toString()
    );
    if (result != 0) {
        if (result == 1)
            throw new BusinessException(400, "åº“å­˜ä¸è¶³");
        if (result == 2)
            throw new BusinessException(400, "è¯·å‹¿é‡å¤ä¸‹å•");
    }
    return Result.ok(id);
}
```

æˆ‘ä»¬åœ¨luaä¸­å®Œæˆæ ¡éªŒå¹¶å°†æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±å·²ç»å®Œæˆrediså±‚çš„æ“ä½œäº†ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»“æœäº†ã€‚

ä¹‹åå°±åªè¦**å¼‚æ­¥**å®Œæˆæ•°æ®åº“çš„ä¿®æ”¹ï¼Œä¹Ÿå³å°†ä¼ å…¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®å†™å…¥æ•°æ®åº“å¹¶å®Œæˆæ›´æ–°å³å¯ï¼

è€Œç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçº¿ç¨‹å»å¾ªç¯ç­‰å¾…redisä¸­æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯å¹¶æ‰§è¡Œï¼š

```java
// ç§’æ€è®¢å•çº¿ç¨‹
public static final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.newSingleThreadExecutor();

// ç§’æ€è®¢å•åˆå§‹åŒ–
@PostConstruct
public void init() {
    SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler());
}
```

å¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—å¾ªç¯å¤„ç†æ–¹æ³•ï¼š

```java
// ç§’æ€è®¢å•å¤„ç†çº¿ç¨‹
private class VoucherOrderHandler implements Runnable {
    private String queueName = "stream.orders";
    @Override
    public void run() {
        while (true) {
            try {
                // è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ å¯¹åº”å‘½ä»¤ä¸º XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders >
                List<MapRecord<String, Object, Object>> read = stringRedisTemplate.opsForStream().read(
                        Consumer.from("g1", "c1"),                                        // æ¶ˆè´¹è€…ç»„
                        StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)),  // æ•°é‡
                        StreamOffset.create(queueName, ReadOffset.lastConsumed())         // æ¶ˆè´¹çš„é˜Ÿåˆ—
                );
                // åˆ¤æ–­æ˜¯å¦è·å–åˆ°æ¶ˆæ¯
                if (read == null || read.isEmpty()){
                    continue;
                }
                // æˆåŠŸï¼Œåˆ›å»ºè®¢å•
                MapRecord<String, Object, Object> record = read.get(0); // MapRecordæ˜¯é”®å€¼å¯¹: key : Mapï¼ˆmapåµŒå¥—mapï¼‰
                Map<Object, Object> values = record.getValue();
                VoucherOrder order = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);
                handleVoucherOrder(order);
                // ackç¡®è®¤ å¯¹åº”å‘½ä»¤ä¸º XACK stream.orders g1 id
                stringRedisTemplate.opsForStream().acknowledge(queueName, "g1",record.getId());
            } catch (Exception e) {
                log.error("å¤„ç†è®¢å•å¼‚å¸¸", e);
                // å¤„ç†pending-listä¸­çš„è®¢å•
                handlePendingOrder();
            }
        }
    }

    // å¤„ç†pending-listä¸­çš„è®¢å•
    private void handlePendingOrder() {
        while (true) {
            try {
                // è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ å¯¹åº”å‘½ä»¤ä¸º XREADGROUP GROUP g1 c1 COUNT 1 STREAMS stream.orders 0
                List<MapRecord<String, Object, Object>> read = stringRedisTemplate.opsForStream().read(
                        Consumer.from("g1", "c1"),                                      // æ¶ˆè´¹è€…ç»„
                        StreamReadOptions.empty().count(1),                             // æ•°é‡
                        StreamOffset.create(queueName, ReadOffset.from("0"))            // æ¶ˆè´¹çš„é˜Ÿåˆ—
                );
                // åˆ¤æ–­æ˜¯å¦è·å–åˆ°æ¶ˆæ¯
                if (read == null || read.isEmpty()){
                    // æ— å¼‚å¸¸ï¼Œåˆ™è¿”å›
                    break;
                }
                // æˆåŠŸï¼Œåˆ›å»ºè®¢å•
                MapRecord<String, Object, Object> record = read.get(0); // MapRecordæ˜¯é”®å€¼å¯¹: S : Mapï¼ˆmapåµŒå¥—mapï¼‰
                Map<Object, Object> values = record.getValue();
                VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);
                handleVoucherOrder(voucherOrder);
                // ackç¡®è®¤ å¯¹åº”å‘½ä»¤ä¸º XACK stream.orders g1 id
                stringRedisTemplate.opsForStream().acknowledge(queueName, "g1",record.getId());
            } catch (Exception e) {
                log.error("å¤„ç†pending-listè®¢å•å¼‚å¸¸", e);
                try {
                    Thread.sleep(50);
                } catch (InterruptedException exception) {
                    throw new RuntimeException(exception);
                }
            }
            
        }
    }
    
    
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°±æ˜¯ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ¥**å¾ªç¯read** Redisä¸­çš„å¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ï¼Œå€˜è‹¥å­˜åœ¨æ•°æ®åˆ™**è·å–æ•°æ®**ï¼Œæ¶ˆæ¯å­˜å…¥**pending-list**å¹¶å®Œæˆæ•°æ®åº“**ç›¸å…³æ“ä½œ**ï¼Œå¦‚æœä¸­é€”å‘ç”Ÿ**å¼‚å¸¸**å¯¼è‡´æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå°±ä¼šå»å¤„ç†æŒ‚èµ·çš„æ¶ˆæ¯ï¼ˆ**pending-list**ä¸­çš„æ¶ˆæ¯ï¼‰ï¼Œåœ¨å®Œæˆç›¸åº”æ“ä½œåä¼šå»**ack**æ¶ˆæ¯ï¼Œå°†ä¹‹ä»pending-listä¸­å–å‡ºï¼Œç¡®è®¤å·²å®Œæˆã€‚

åç»­å¦‚æœéœ€è¦å»æ›´è¿›ä¸€æ­¥ï¼Œé‚£å°±éœ€è¦è€ƒè™‘åŠ å…¥çº¿ç¨‹æ± ç­‰æ–¹é¢äº†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¯¹äºå¼‚å¸¸çš„å¤„ç†ï¼Œä»¥åŠé˜»å¡çš„å®‰æ’ï¼ˆå¯¹pending-listä¸­æ¶ˆæ¯çš„å¤„ç†å¯èƒ½å­˜åœ¨ç«äº‰ï¼‰å°±éœ€è¦é¢å¤–è®¾è®¡äº†ã€‚


















----



## ä¸ºä»€ä¹ˆåœ¨å¾®æœåŠ¡ä¸­ä½¿ç”¨RabbitMQç­‰MQï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨Redisæä¾›çš„MQï¼Ÿ

**Redis ä¸æ˜¯ä¸ºé«˜å¯é ã€æŒä¹…åŒ–ã€å¤æ‚è·¯ç”±çš„æ¶ˆæ¯ä¼ é€’è€Œè®¾è®¡çš„ï¼›å®ƒæ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“ï¼Œæ¶ˆæ¯èƒ½åŠ›åªæ˜¯â€œé™„å¸¦åŠŸèƒ½â€ã€‚**
è€Œ RabbitMQ/Kafka æ˜¯**ä¸“ä¸ºæ¶ˆæ¯ä¼ é€’åœºæ™¯æ‰“é€ çš„ä¸­é—´ä»¶**ï¼Œåœ¨å¯é æ€§ã€ä¸€è‡´æ€§ã€æ‰©å±•æ€§ã€è¿ç»´ç­‰æ–¹é¢è¿œèƒœ Redisã€‚

| ç»´åº¦                 | **Redisï¼ˆä½œä¸º MQï¼‰**                                         | **RabbitMQ / Kafkaï¼ˆä¸“ä¸š MQï¼‰**                              |
| :------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **1. æ¶ˆæ¯å¯é æ€§**    | âŒ å¼± â€¢ `LIST`/`PUBSUB` é»˜è®¤**ä¸æŒä¹…åŒ–** â€¢ å³ä½¿å¼€å¯ AOF/RDBï¼Œä»å¯èƒ½ä¸¢æ¶ˆæ¯ï¼ˆå¦‚å®•æœºæ—¶ç¼“å†²åŒºæœªåˆ·ç›˜ï¼‰ | âœ… å¼º â€¢ æ¶ˆæ¯é»˜è®¤**æŒä¹…åŒ–åˆ°ç£ç›˜** â€¢ æ”¯æŒ **ç”Ÿäº§è€…ç¡®è®¤ï¼ˆConfirmï¼‰ + æ¶ˆè´¹è€…æ‰‹åŠ¨ ACK** â€¢ å¯é…ç½®åŒæ­¥åˆ·ç›˜ï¼ˆå¦‚ RocketMQï¼‰ |
| **2. æ¶ˆæ¯å †ç§¯èƒ½åŠ›**  | âŒ å·® â€¢ æ‰€æœ‰æ•°æ®åœ¨å†…å­˜ä¸­ â†’ å †ç§¯å¤§é‡æ¶ˆæ¯ä¼š**è€—å°½å†…å­˜** â€¢ éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆå¦‚ LRUï¼‰ | âœ… å¼º â€¢ æ¶ˆæ¯å­˜å‚¨åœ¨**ç£ç›˜**ï¼Œå¯å †ç§¯ TB çº§æ•°æ® â€¢ å†…å­˜ä»…ä½œç¼“å­˜ï¼Œä¸å½±å“ç¨³å®šæ€§ |
| **3. æ¶ˆè´¹æ¨¡å‹**      | âš ï¸ æœ‰é™ â€¢ `LIST`ï¼šç‚¹å¯¹ç‚¹ï¼Œä½†æ—  ACK æœºåˆ¶ â†’ æ¶ˆè´¹å¤±è´¥å³ä¸¢å¤± â€¢ `PUB/SUB`ï¼šå¹¿æ’­ï¼Œä½†**ä¸æ”¯æŒæŒä¹…è®¢é˜…**ï¼ˆå®¢æˆ·ç«¯æ–­å¼€å³ä¸¢æ¶ˆæ¯ï¼‰ â€¢ `Streams`ï¼šè¾ƒæ–°ï¼Œæ”¯æŒæ¶ˆè´¹è€…ç»„ï¼Œä½†ç”Ÿæ€å¼± | âœ… å®Œå–„ â€¢ æ”¯æŒ **ç‚¹å¯¹ç‚¹ + å‘å¸ƒ/è®¢é˜…** â€¢ **æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰** â€¢ **æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰** â€¢ **å»¶è¿Ÿé˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—**ç­‰é«˜çº§ç‰¹æ€§ |
| **4. æ¶ˆæ¯é¡ºåº**      | âš ï¸ ä»…å•æµæœ‰åº â€¢ `LIST` æˆ– `Stream` å• key å†…æœ‰åºï¼Œä½†æ— æ³•è·¨ key ä¿è¯ | âœ… å¯æ§ â€¢ Kafkaï¼šåˆ†åŒºï¼ˆPartitionï¼‰å†…ä¸¥æ ¼æœ‰åº â€¢ RabbitMQï¼šå•é˜Ÿåˆ—æœ‰åºï¼ˆéœ€å•æ¶ˆè´¹è€…ï¼‰ |
| **5. è¿ç»´ä¸ç›‘æ§**    | âŒ å¼± â€¢ æ— å†…ç½®æ¶ˆæ¯è¿½è¸ªã€ç§¯å‹ç›‘æ§ â€¢ éœ€è‡ªè¡Œå¼€å‘ç®¡ç†ç•Œé¢         | âœ… å¼º â€¢ æä¾› Web UIï¼ˆå¦‚ RabbitMQ Managementï¼‰ â€¢ é›†æˆ Prometheus/Grafana ç›‘æ§ â€¢ æ”¯æŒæ¶ˆæ¯è½¨è¿¹ã€é‡è¯•ã€å›æº¯ |
| **6. åè®®ä¸ç”Ÿæ€**    | âŒ å°é—­ â€¢ ä»…æ”¯æŒ Redis åè®® â€¢ å®¢æˆ·ç«¯éœ€å¤„ç†åº•å±‚å‘½ä»¤ï¼ˆå¦‚ `XREADGROUP`ï¼‰ | âœ… å¼€æ”¾ â€¢ æ ‡å‡†åè®®ï¼ˆAMQPã€MQTTã€Kafka åè®®ï¼‰ â€¢ ä¸°å¯Œå®¢æˆ·ç«¯åº“ï¼ˆJava/Python/Go/Node.js ç­‰ï¼‰ â€¢ ä¸ Spring Cloud Streamã€Flinkã€Spark ç­‰æ— ç¼é›†æˆ |
| **7. é«˜å¯ç”¨ & æ‰©å±•** | âš ï¸ ä¾èµ– Redis é›†ç¾¤ â€¢ ä¸»ä»å¤åˆ¶å»¶è¿Ÿå¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸ä¸€è‡´ â€¢ æ‰©å®¹éœ€é‡æ–°åˆ†ç‰‡ï¼ˆå¤æ‚ï¼‰ | âœ… åŸç”Ÿæ”¯æŒ â€¢ RabbitMQï¼šé•œåƒé˜Ÿåˆ— / Quorum Queue â€¢ Kafkaï¼šå‰¯æœ¬æœºåˆ¶ + è‡ªåŠ¨ Leader é€‰ä¸¾ â€¢ æ°´å¹³æ‰©å±•ç®€å• |

**åœºæ™¯ï¼šè®¢å•åˆ›å»ºåå‘é€é‚®ä»¶**

- ç”¨ Redis LISTï¼š
  - è®¢å•æœåŠ¡ `LPUSH order_queue {orderId}`
  - é‚®ä»¶æœåŠ¡ `BRPOP order_queue`
  - **é£é™©**ï¼šé‚®ä»¶æœåŠ¡å¤„ç†ä¸­å®•æœº â†’ æ¶ˆæ¯æ°¸ä¹…ä¸¢å¤±ï¼ˆæ—  ACKï¼‰
- ç”¨ RabbitMQï¼š
  - è®¢å•æœåŠ¡å‘é€æ¶ˆæ¯åˆ° `order.created` é˜Ÿåˆ—
  - é‚®ä»¶æœåŠ¡æ¶ˆè´¹å**æ‰‹åŠ¨ ACK**
  - å¤±è´¥æ—¶è‡ªåŠ¨é‡å›é˜Ÿåˆ—æˆ–è¿›å…¥ DLQ â†’ **æ¶ˆæ¯ä¸ä¸¢**

**åœºæ™¯ï¼šé«˜å¹¶å‘æ—¥å¿—æ”¶é›†**

- **Redis**ï¼šå†…å­˜è¿…é€Ÿè€—å°½ï¼Œè§¦å‘æ·˜æ±°ç­–ç•¥ â†’ æ—¥å¿—**ä¸¢å¤±**
- **Kafka**ï¼šå†™å…¥ç£ç›˜ï¼Œå¯å †ç§¯æ•° TB æ•°æ®ï¼Œæ¶ˆè´¹è€…æŒ‰éœ€æ‹‰å–

**Redis é€‚åˆåš MQ çš„åœºæ™¯ï¼ˆå°‘æ•°ï¼‰**

| åœºæ™¯                           | è¯´æ˜                                              |
| :----------------------------- | :------------------------------------------------ |
| **è½»é‡çº§ä»»åŠ¡é˜Ÿåˆ—**             | å¦‚åå°å›¾ç‰‡å‹ç¼©ã€ç¼“å­˜é¢„çƒ­ï¼Œå…è®¸å°‘é‡ä¸¢å¤±            |
| **å®æ—¶é€šçŸ¥ï¼ˆéå…³é”®ï¼‰**         | å¦‚åœ¨çº¿ç”¨æˆ·çŠ¶æ€å¹¿æ’­ï¼ˆç”¨ PUB/SUBï¼‰                  |
| **å·²æœ‰ Redisï¼Œä¸æƒ³å¼•å…¥æ–°ç»„ä»¶** | å¿«é€ŸåŸå‹éªŒè¯ï¼ˆPoCï¼‰ï¼Œä½†**ä¸å»ºè®®ç”¨äºç”Ÿäº§æ ¸å¿ƒé“¾è·¯** |

ç®€å•ä¸€å¥æ€»ç»“ï¼ŒRedisæ¯•ç«Ÿè¿˜æ˜¯ä¸“é—¨ç”¨äºåš**ç¼“å­˜**çš„å†…å­˜æ•°æ®åº“ï¼ŒRedis Streamsåªèƒ½ç®—æ˜¯æ·»å¤´ï¼Œé¢å¯¹é«˜å¹¶å‘åœºæ™¯è¿˜æ˜¯é€‰æ‹©ä¸“é—¨çš„MQæ›´å¥½ã€‚



## ä»€ä¹ˆåœºæ™¯ä½¿ç”¨RPCï¼Ÿä»€ä¹ˆåœºæ™¯ä½¿ç”¨MQï¼ŸåŒºåˆ«åœ¨å“ªï¼Ÿ

RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰å’Œ MQï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰éƒ½æ˜¯æœåŠ¡é—´é€šä¿¡çš„æ‰‹æ®µï¼Œä½†å®ƒä»¬çš„**é€‚ç”¨åœºæ™¯ã€è®¾è®¡ç†å¿µå’Œç³»ç»Ÿå½±å“æˆªç„¶ä¸åŒ**ã€‚

> **âœ… ä¸€å¥è¯æ€»ç»“åŒºåˆ«**
> **RPC æ˜¯â€œåŒæ­¥è°ƒç”¨â€ï¼Œè¿½æ±‚**å³æ—¶å“åº”**ï¼›
> MQ æ˜¯â€œå¼‚æ­¥é€šä¿¡â€ï¼Œè¿½æ±‚**è§£è€¦ä¸å¯é ä¼ é€’**ã€‚**

> ğŸ’¡ **é»„é‡‘æ³•åˆ™**ï¼š
>
> - **è¦ç»“æœ â†’ ç”¨ RPC**
> - **å‘äº‹ä»¶ â†’ ç”¨ MQ**

**ä¸€ã€RPCï¼ˆRemote Procedure Callï¼‰â€”â€” åŒæ­¥ã€å¼ºä¾èµ–**

 **ğŸ”§ å…¸å‹ä»£è¡¨**

- gRPCã€Dubboã€Spring Cloud OpenFeignã€Thrift

 **ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹**

| ç‰¹æ€§           | è¯´æ˜                                       |
| :------------- | :----------------------------------------- |
| **åŒæ­¥é˜»å¡**   | è°ƒç”¨æ–¹ç­‰å¾…è¢«è°ƒç”¨æ–¹è¿”å›ç»“æœï¼ˆå¦‚ HTTP è¯·æ±‚ï¼‰ |
| **å®æ—¶æ€§é«˜**   | é€‚åˆéœ€è¦ç«‹å³å¾—åˆ°ç»“æœçš„åœºæ™¯                 |
| **å¼ºè€¦åˆ**     | è°ƒç”¨æ–¹å¿…é¡»çŸ¥é“è¢«è°ƒç”¨æ–¹çš„åœ°å€ã€æ¥å£ã€åè®®   |
| **å¤±è´¥å³ä¸­æ–­** | è¢«è°ƒç”¨æ–¹å®•æœº â†’ è°ƒç”¨æ–¹ç›´æ¥æŠ¥é”™              |

**âœ… é€‚ç”¨åœºæ™¯ï¼ˆç”¨ RPCï¼‰**

1. éœ€è¦ç«‹å³è¿”å›ç»“æœ
   - ç”¨æˆ·ç™»å½•ï¼šè°ƒç”¨è®¤è¯æœåŠ¡éªŒè¯å¯†ç  â†’ ç«‹å³è¿”å› token
   - æŸ¥è¯¢å•†å“è¯¦æƒ…ï¼šå‰ç«¯è¯·æ±‚ â†’ èšåˆæœåŠ¡è°ƒç”¨å•†å“ã€åº“å­˜ã€è¯„ä»·æœåŠ¡ â†’ æ‹¼è£…åè¿”å›
2. äº‹åŠ¡æ€§å¼ºçš„æ“ä½œ
   - æ”¯ä»˜å‰æ£€æŸ¥ä½™é¢ï¼ˆå¿…é¡»åŒæ­¥ç¡®è®¤ï¼‰
3. ä½å»¶è¿Ÿè¦æ±‚
   - å®æ—¶é£æ§ã€å®æ—¶æ¨è

**âŒ ä¸é€‚ç”¨åœºæ™¯**

- è¢«è°ƒç”¨æ–¹å¤„ç†æ…¢ï¼ˆå¦‚ç”ŸæˆæŠ¥è¡¨ï¼‰
- è¢«è°ƒç”¨æ–¹ä¸ç¨³å®šï¼ˆä¼šå¯¼è‡´è°ƒç”¨æ–¹é›ªå´©ï¼‰
- ä¸å…³å¿ƒç»“æœï¼ˆå¦‚å‘é€šçŸ¥ï¼‰

------

**äºŒã€MQï¼ˆMessage Queueï¼‰â€”â€” å¼‚æ­¥ã€å¼±ä¾èµ–**

**ğŸ”§ å…¸å‹ä»£è¡¨**

- RabbitMQã€Kafkaã€RocketMQ

**ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹**

| ç‰¹æ€§           | è¯´æ˜                             |
| :------------- | :------------------------------- |
| **å¼‚æ­¥éé˜»å¡** | å‘å®Œæ¶ˆæ¯å°±è¿”å›ï¼Œä¸ç­‰æ¶ˆè´¹è€…å¤„ç†   |
| **è§£è€¦**       | ç”Ÿäº§è€…ä¸çŸ¥é“æ¶ˆè´¹è€…æ˜¯å¦å­˜åœ¨       |
| **å‰Šå³°å¡«è°·**   | é«˜å³°æœŸæ¶ˆæ¯å †ç§¯ï¼Œæ¶ˆè´¹è€…æŒ‰èƒ½åŠ›æ¶ˆè´¹ |
| **æœ€ç»ˆä¸€è‡´æ€§** | ä¸ä¿è¯å®æ—¶ï¼Œä½†ä¿è¯æœ€ç»ˆä¼šå¤„ç†     |

**âœ… é€‚ç”¨åœºæ™¯ï¼ˆç”¨ MQï¼‰**

1. ä¸éœ€è¦ç«‹å³å“åº”
   - ç”¨æˆ·æ³¨å†Œ â†’ å‘æ¬¢è¿é‚®ä»¶/çŸ­ä¿¡ï¼ˆç”¨æˆ·ä¸å…³å¿ƒæ˜¯å¦æˆåŠŸï¼‰
2. æµé‡å‰Šå³°
   - ç§’æ€ä¸‹å• â†’ å…ˆå…¥é˜Ÿåˆ—ï¼Œè®¢å•æœåŠ¡åŒ€é€Ÿå¤„ç†
3. å¹¿æ’­é€šçŸ¥
   - å•†å“ä»·æ ¼å˜æ›´ â†’ é€šçŸ¥æœç´¢ã€æ¨èã€ç¼“å­˜æœåŠ¡æ›´æ–°
4. è·¨ç³»ç»Ÿé›†æˆ
   - è®¢å•ç³»ç»Ÿ â†’ è´¢åŠ¡ç³»ç»Ÿï¼ˆä¸åŒå›¢é˜Ÿã€ä¸åŒæŠ€æœ¯æ ˆï¼‰
5. æ—¥å¿—/ç›‘æ§æ•°æ®æ”¶é›†
   - åº”ç”¨åŸ‹ç‚¹ â†’ Kafka â†’ Flink å®æ—¶åˆ†æ

**âŒ ä¸é€‚ç”¨åœºæ™¯**

- éœ€è¦è¿”å›è®¡ç®—ç»“æœï¼ˆå¦‚â€œè®¡ç®—ç”¨æˆ·ç§¯åˆ†â€ï¼‰
- å¼ºä¸€è‡´æ€§è¦æ±‚ï¼ˆå¦‚é“¶è¡Œè½¬è´¦ï¼‰

------

**ä¸‰ã€å¯¹æ¯”è¡¨æ ¼ï¼šRPC vs MQ**

| ç»´åº¦           | **RPC**                 | **MQ**                           |
| :------------- | :---------------------- | :------------------------------- |
| **é€šä¿¡æ¨¡å¼**   | åŒæ­¥ï¼ˆè¯·æ±‚-å“åº”ï¼‰       | å¼‚æ­¥ï¼ˆå‘å¸ƒ-è®¢é˜… / ç‚¹å¯¹ç‚¹ï¼‰       |
| **è€¦åˆåº¦**     | é«˜ï¼ˆéœ€çŸ¥é“å¯¹æ–¹æ¥å£ï¼‰    | ä½ï¼ˆåªéœ€çº¦å®šæ¶ˆæ¯æ ¼å¼ï¼‰           |
| **å¯é æ€§**     | ä¾èµ–ç½‘ç»œå’Œå¯¹æ–¹å¯ç”¨æ€§    | æ¶ˆæ¯æŒä¹…åŒ–ï¼Œå¯é‡è¯•ï¼Œä¸ä¸¢         |
| **å»¶è¿Ÿ**       | ä½ï¼ˆms çº§ï¼‰             | è¾ƒé«˜ï¼ˆå¯èƒ½ç§’çº§ï¼Œå–å†³äºæ¶ˆè´¹é€Ÿåº¦ï¼‰ |
| **ååé‡**     | å—é™äºè¢«è°ƒç”¨æ–¹å¤„ç†èƒ½åŠ›  | é«˜ï¼ˆç”Ÿäº§å¿«ï¼Œæ¶ˆè´¹å¯æ…¢ï¼‰           |
| **é”™è¯¯å¤„ç†**   | ç›´æ¥æŠ›å¼‚å¸¸              | å¯é‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—ã€äººå·¥å¹²é¢„       |
| **å…¸å‹åè®®**   | HTTP/2, TCP, Dubbo åè®® | AMQP, Kafka åè®®, è‡ªå®šä¹‰         |
| **ç³»ç»Ÿå¤æ‚åº¦** | ä½ï¼ˆåƒæœ¬åœ°è°ƒç”¨ï¼‰        | é«˜ï¼ˆéœ€ç®¡ç†æ¶ˆæ¯æ ¼å¼ã€å¹‚ç­‰ã€ç§¯å‹ï¼‰ |

**âœ… æ€»ç»“**

| åœºæ™¯                           | æ¨è                             |
| :----------------------------- | :------------------------------- |
| **æŸ¥æ•°æ®ã€åšå†³ç­–ã€å¼ºä¸€è‡´æ€§**   | âœ… RPC                            |
| **å‘é€šçŸ¥ã€è®°æ—¥å¿—ã€å‰Šå³°ã€å¹¿æ’­** | âœ… MQ                             |
| **æ ¸å¿ƒäº¤æ˜“é“¾è·¯**               | RPCï¼ˆåŒæ­¥æ ¡éªŒï¼‰ + MQï¼ˆå¼‚æ­¥åç»­ï¼‰ |
| **è·¨å›¢é˜Ÿ/è·¨è¯­è¨€ç³»ç»Ÿé›†æˆ**      | ä¼˜å…ˆ MQï¼ˆè§£è€¦ï¼‰                  |

```mermaid
graph TD
    A[éœ€è¦è°ƒç”¨å…¶ä»–æœåŠ¡ï¼Ÿ] --> B{éœ€è¦ç«‹å³è¿”å›ç»“æœå—ï¼Ÿ}
    B -->|æ˜¯| C[ç”¨ RPC]
    B -->|å¦| D{æ“ä½œæ˜¯å¦å…³é”®ï¼Ÿ<br>ï¼ˆå¤±è´¥ä¼šå¯¼è‡´ä¸šåŠ¡ä¸­æ–­ï¼‰}
    D -->|æ˜¯| E[è€ƒè™‘ RPC + é‡è¯• æˆ– Saga äº‹åŠ¡]
    D -->|å¦| F[ç”¨ MQ]
```



## æ–°å¼€çº¿ç¨‹å†…è°ƒç”¨Beanå¯¹è±¡çš„åŠ¨æ€ä»£ç†ï¼Œå…¶çš„å¢å¼ºä¼šç”Ÿæ•ˆå—ï¼Ÿ

æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æ¯”å¦‚`@Transactional`å°±æ˜¯å¯ä»¥åœ¨**çº¿ç¨‹å†…éƒ¨**æ­£å¸¸å¼€å¯çš„ï¼Œä½†æ˜¯ç”±äºå’Œå¤–éƒ¨çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œäº‹åŠ¡æ˜¯æ— æ³•ä¼ æ’­åˆ°å¤–éƒ¨åˆæˆä¸€ä¸ªçš„ã€‚



## StringRedisTemplateçš„opsForStreamçš„ç›¸å…³æ“ä½œ

```java
// è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ å¯¹åº”å‘½ä»¤ä¸º XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders >
                List<MapRecord<String, Object, Object>> read = stringRedisTemplate.opsForStream().read(
                        Consumer.from("g1", "c1"),                                      	// æ¶ˆè´¹è€…ç»„
                        StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)),    // æ•°é‡
                        StreamOffset.create(queueName, ReadOffset.lastConsumed())           // æ¶ˆè´¹çš„é˜Ÿåˆ—
                );
```

| åŠŸèƒ½         | æ–¹æ³•                                                 |
| :----------- | :--------------------------------------------------- |
| å†™å…¥æ¶ˆæ¯     | `add(StreamRecords)`                                 |
| æ¶ˆè´¹è€…ç»„è¯»å– | `read(Consumer, StreamReadOptions, StreamOffset...)` |
| æ™®é€šè¯»å–     | `read(StreamReadOptions, StreamOffset...)`           |
| ç¡®è®¤æ¶ˆæ¯     | `acknowledge(String group, Record)`                  |
| æŸ¥çœ‹ Pending | `pending(String key, String group)`                  |
| è½¬ç§»æ¶ˆæ¯     | `claim(...)`                                         |
| åˆ›å»ºç»„       | `createGroup(...)`                                   |
| åˆ é™¤æ¶ˆæ¯     | `delete(...)`                                        |
| è£å‰ª Stream  | `trim(...)`                                          |

### **1.** **å†™å…¥æ¶ˆæ¯ï¼ˆXADDï¼‰**

**æ–¹æ³•ï¼š**

```java
String id = streamOps.add(
    StreamRecords.newRecord()
        .ofObject(orderMap)           // æ¶ˆæ¯å†…å®¹ï¼ˆMap<String, ?>ï¼‰
        .withStreamKey("stream.orders")
);
```

**æ›´ç²¾ç»†æ§åˆ¶ï¼š**

```java
String id = streamOps.add(
    StreamRecords.string("stream.orders")
        .ofEntries("orderId", "1001", "amount", "99.9")
);
```

> âœ… æ”¯æŒæŒ‡å®š IDï¼ˆå¦‚ `"*"` è‡ªåŠ¨ç”Ÿæˆï¼‰ã€è®¾ç½® `MAXLEN` è‡ªåŠ¨è£å‰ªï¼š

```java
streamOps.add(StreamRecords.newRecord()
    .ofObject(data)
    .withStreamKey(key)
    .withMaxLen(1000)  // XADD ... MAXLEN ï½ 1000
);
```

------

### **2.** **è¯»å–æ¶ˆæ¯ï¼ˆXREAD / XREADGROUPï¼‰**

**(1) æ™®é€šè¯»å–ï¼ˆæ— æ¶ˆè´¹è€…ç»„ï¼‰**

```java
List<MapRecord<String, Object, Object>> records = streamOps.read(
    StreamReadOptions.empty().count(10).block(Duration.ofSeconds(5)),
    StreamOffset.fromStart("mystream")   // ä»å¼€å¤´è¯»
    // æˆ– StreamOffset.latest("mystream")  // ä»æœ€æ–°
);
```

**(2)** **æ¶ˆè´¹è€…ç»„è¯»å–**

```java
List<MapRecord<String, Object, Object>> read = streamOps.read(
    Consumer.from("g1", "c1"),                          // æ¶ˆè´¹è€…ç»„ g1ï¼Œæ¶ˆè´¹è€… c1
    StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)),
    StreamOffset.create("stream.orders", ReadOffset.lastConsumed()) // ç›¸å½“äº ">"
);
```

> ğŸ” `ReadOffset.lastConsumed()` å¯¹åº” Redis çš„ `">"`ï¼Œè¡¨ç¤ºâ€œè¯»å–ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯â€ã€‚

**(3) ä» Pending List é‡è¯•ï¼ˆå¯¹åº” ID = "0"ï¼‰**

```java
List<MapRecord<String, Object, Object>> pending = streamOps.read(
    Consumer.from("g1", "c1"),
    StreamReadOptions.empty().count(10),
    StreamOffset.create("stream.orders", ReadOffset.from("0")) // ä» pending å¼€å§‹
);
```

------

### **3.** **ç¡®è®¤æ¶ˆæ¯ï¼ˆXACKï¼‰**

```java
Long ackCount = streamOps.acknowledge(
    "stream.orders",     // Stream key
    "g1",                // æ¶ˆè´¹è€…ç»„
    "1642738912000-0"    // æ¶ˆæ¯ IDï¼ˆå¯ä¼ å¤šä¸ªï¼‰
);

// æˆ–ä» Record ä¸­ç›´æ¥ ACK
if (!read.isEmpty()) {
    MapRecord<String, Object, Object> record = read.get(0);
    streamOps.acknowledge("g1", record); // è‡ªåŠ¨æå– key + id
}
```

> âœ… æ¨èä½¿ç”¨ `acknowledge(group, record)`ï¼Œæ›´å®‰å…¨ã€‚

------

### **4.** **æŸ¥çœ‹ Pending ä¿¡æ¯ï¼ˆXPENDINGï¼‰**

**(1) è·å–ç»„çº§åˆ«ç»Ÿè®¡**

```java
PendingMessagesSummary pendingSummary = streamOps.pending(
    "stream.orders",
    "g1"
);

System.out.println("Total pending: " + pendingSummary.getTotalPendingMessages());
System.out.println("Earliest ID: " + pendingSummary.getEarliestMessageId());
```

**(2) è·å–å…·ä½“ Pending æ¶ˆæ¯è¯¦æƒ…ï¼ˆå«æ¶ˆè´¹è€…ã€é‡è¯•æ¬¡æ•°ï¼‰**

```java
List<PendingMessages> pendingDetails = streamOps.pending(
    "stream.orders",
    Consumer.from("g1", "c1"),  // å¯æŒ‡å®šæ¶ˆè´¹è€…
    Range.unbounded(),          // ID èŒƒå›´ï¼Œå¦‚ Range.closed("0", "+")
    10                          // æœ€å¤šè¿”å›æ¡æ•°
);
```

> è¿”å›çš„ `PendingMessages` åŒ…å«ï¼š
>
> - `getId()`
> - `getConsumerName()`
> - `getElapsedTimeSinceLastDelivery()`ï¼ˆæ¯«ç§’ï¼‰
> - `getDeliveryCount()`

------

### **5.** **è½¬ç§»æ¶ˆæ¯æ‰€æœ‰æƒï¼ˆXCLAIMï¼‰**

ç”¨äºå°†é•¿æ—¶é—´æœªå¤„ç†çš„ Pending æ¶ˆæ¯è½¬ç§»ç»™å…¶ä»–æ¶ˆè´¹è€…ï¼ˆå®ç°â€œæ­»ä¿¡å¤„ç†â€ï¼‰ï¼š

```java
List<MapRecord<String, Object, Object>> claimed = streamOps.claim(
    "stream.orders",
    "g1",
    "new-consumer",             // æ–°æ¶ˆè´¹è€…
    Duration.ofMinutes(5),      // min-idle-timeï¼šè‡³å°‘ç©ºé—² 5 åˆ†é’Ÿæ‰è½¬ç§»
    "1642738912000-0"           // æ¶ˆæ¯ ID
);
```

> âš ï¸ é€šå¸¸é…åˆ `XPENDING` ä½¿ç”¨ï¼šå…ˆæŸ¥å‡ºé«˜ `deliveryCount` çš„æ¶ˆæ¯ï¼Œå† `XCLAIM` è½¬ç§»ã€‚

------

### **6.** **åˆ›å»º/åˆ é™¤æ¶ˆè´¹è€…ç»„ï¼ˆXGROUP CREATE / DESTROYï¼‰**

```java
// åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼ˆä»æœ€æ–°å¼€å§‹ï¼‰
streamOps.createGroup("stream.orders", ReadOffset.lastConsumed(), "g1");

// ä»å¼€å¤´åˆ›å»º
streamOps.createGroup("stream.orders", ReadOffset.from("0"), "g1");

// åˆ é™¤æ¶ˆè´¹è€…ç»„
streamOps.destroyGroup("stream.orders", "g1");
```

> ğŸ’¡ å¦‚æœç»„å·²å­˜åœ¨ï¼Œ`createGroup` ä¼šæŠ›å¼‚å¸¸ã€‚å¯å…ˆç”¨ `XINFO GROUPS` æ£€æŸ¥ï¼ˆä½† Spring Data Redis æœªç›´æ¥æš´éœ²ï¼‰ã€‚

------

### **7.** **å…¶ä»–å®ç”¨æ“ä½œ**

| æ“ä½œ            | æ–¹æ³•                                                  | è¯´æ˜                                       |
| :-------------- | :---------------------------------------------------- | :----------------------------------------- |
| **åˆ é™¤æ¶ˆæ¯**    | `streamOps.delete("stream.orders", "id1", "id2")`     | å¯¹åº” `XDEL`                                |
| **è£å‰ª Stream** | `streamOps.trim("stream.orders", 1000)`               | ä¿ç•™æœ€è¿‘ 1000 æ¡ï¼ˆ`XTRIM MAXLEN ï½ 1000`ï¼‰ |
| **è·å–é•¿åº¦**    | `streamOps.size("stream.orders")`                     | å¯¹åº” `XLEN`                                |
| **è¯»å–èŒƒå›´**    | `streamOps.range("stream.orders", Range.unbounded())` | å¯¹åº” `XRANGE`                              |
