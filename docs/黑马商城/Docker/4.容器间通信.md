---
title: 容器间通信
date: 2026-1-31
---

Docker 容器默认运行在**隔离的网络命名空间**中，但为了实现容器间、容器与外部世界的通信，Docker 提供了灵活的网络模型。其核心目标是：**安全隔离 + 按需连通**。

------

### 四种内置网络驱动（Network Drivers）

Docker 支持多种网络驱动，最常用的是前三种：

| 驱动类型             | 用途                        | 特点                                                |
| -------------------- | --------------------------- | --------------------------------------------------- |
| **`bridge`（默认）** | 单机多容器通信              | 容器通过虚拟网桥 `docker0` 互联，需端口映射访问外网 |
| **`host`**           | 容器共享主机网络            | 无网络隔离，性能高，仅 Linux 支持                   |
| **`none`**           | 完全禁用网络                | 容器仅有 `lo` 回环接口，用于安全隔离场景            |
| **`overlay`**        | 跨主机容器通信（Swarm/K8s） | 需 Docker Swarm 或 Kubernetes 支持                  |

> ✅ **90% 的单机场景使用 `bridge` 网络**

------

#### 默认 bridge 网络（docker0）

当你直接运行 `docker run` 而不指定网络时，容器会加入默认的 **`bridge` 网络**（由 `docker0` 虚拟网桥实现）。

##### 特点：

- 所有容器连接到同一个网桥（类似接在同一台交换机）
- 容器获得私有 IP（如 `172.17.0.2`）
- **容器间可通过 IP 通信，但不能通过容器名解析**
- 访问外部网络：通过 NAT（主机 IP 转发）
- 外部访问容器：必须通过 `-p` 显式端口映射

##### 示例：

```bash
# 启动两个容器
docker run -d --name web nginx
docker run -it --name client alpine

# 在 client 中 ping web 的 IP（需先查 IP）
docker inspect web | grep IPAddress  # 假设为 172.17.0.2
docker exec client ping 172.17.0.2   # ✅ 通
docker exec client ping web          # ❌ 不通（默认 bridge 不支持 DNS）
```

> ⚠️ **默认 bridge 网络的局限性**：  
>
> - 无法通过容器名通信  
> - 无法自定义子网/MTU 等参数  
> - 所有容器在同一广播域，安全性较低

------

#### 自定义 bridge 网络（推荐！）

使用 `docker network create` 创建的 bridge 网络**支持 DNS 自动发现**，是生产环境的最佳选择。

##### 创建与使用：

```bash
# 1. 创建自定义网络
docker network create my-web-net

# 2. 启动容器并加入网络
docker run -d --name db --network my-web-net redis
docker run -d --name app --network my-web-net nginx

# 3. 容器间可通过名称直接通信！
docker exec app ping db        # ✅ 成功（自动 DNS 解析）
docker exec app curl http://db:6379  # ✅ 访问 Redis
```

##### 优势：

| 功能                         | 默认 bridge          | 自定义 bridge                  |
| ---------------------------- | -------------------- | ------------------------------ |
| 容器名 DNS 解析              | ❌                    | ✅                              |
| 网络隔离（多组容器互不影响） | ❌ 所有容器在同一网络 | ✅ 可创建多个独立网络           |
| 自定义子网/IP 范围           | ❌                    | ✅ `--subnet 192.168.100.0/24`  |
| 安全性                       | 较低                 | 较高（默认启用 `--icc=false`） |

> 💡 **最佳实践**：
> **永远不要用默认 bridge 网络部署多容器应用！**
> 始终为每个应用创建独立的自定义 bridge 网络。

------

#### host 网络模式（高性能场景）

容器**直接使用主机的网络命名空间**，无虚拟网络开销。

##### 使用方式：

```bash
docker run --network host nginx
```

##### 效果：

- 容器监听的端口**直接绑定到主机**
- 无需 `-p` 映射：`curl http://localhost:80` 即可访问
- 容器内 `localhost` = 主机 `localhost`

##### 适用场景：

- 网络性能敏感的应用（如监控代理、高性能网关）
- 需要监听大量端口的服务

##### 缺陷：

- ❌ **完全丧失网络隔离**
- ❌ 端口冲突风险高（多个容器不能监听同一端口）
- ❌ 仅 Linux 支持（Windows/macOS 忽略此参数）

------

#### none 网络模式（完全隔离）

容器**仅有 loopback 接口**，无任何外部网络。

```bash
docker run --network none alpine ip addr
# 输出只有 lo: 127.0.0.1
```

##### 用途：

- 安全敏感任务（如离线数据处理）
- 自定义网络方案（配合第三方 CNI 插件）

------

### 容器与外部网络通信

#### 1. 容器 → 外部网络（如访问互联网）

- 默认允许（通过主机 NAT 转发）
- 无需额外配置

#### 2. 外部 → 容器（如浏览器访问 Web 服务）

- 必须通过 `-p` 或 `--publish` 映射端口

  ```bash
  docker run -p 8080:80 nginx
  # 主机 8080 → 容器 80
  ```

- 访问方式：`http://<主机IP>:8080`

> 🔍 **端口映射原理**：
> Docker 在主机 iptables 中添加 DNAT 规则，将流量转发到容器 IP。

------

### 多容器应用网络示例（Web + DB）

```bash
# 1. 创建专用网络
docker network create app-net

# 2. 启动数据库（不暴露端口到主机，仅容器间访问）
docker run -d --name mysql \
  --network app-net \
  -e MYSQL_ROOT_PASSWORD=123456 \
  mysql:8.0

# 3. 启动 Web 应用
docker run -d --name web \
  --network app-net \
  -p 80:80 \
  -e DB_HOST=mysql \          # 通过容器名连接 DB
  my-web-app
```

✅ **优势**：

- 数据库端口（3306）**不暴露到公网**，更安全
- Web 应用通过 `DB_HOST=mysql` 直接解析 IP
- 网络隔离：其他容器无法访问 `app-net` 内服务

------

### 网络管理命令速查

| 命令                                          | 作用                      |
| --------------------------------------------- | ------------------------- |
| `docker network ls`                           | 列出所有网络              |
| `docker network create my-net`                | 创建自定义 bridge 网络    |
| `docker network inspect my-net`               | 查看网络详情（含容器 IP） |
| `docker network connect my-net container1`    | 将运行中容器加入网络      |
| `docker network disconnect my-net container1` | 从网络移除容器            |
| `docker run --network my-net ...`             | 启动时指定网络            |

> **“`create` 建网，`connect` 加容器；`inspect` 看详情，`prune` 清垃圾。”**

------

### 高级功能

#### 1. 指定容器 IP（需自定义网络）

```bash
docker network create --subnet=192.168.100.0/24 my-net
docker run --network my-net --ip 192.168.100.10 nginx
```

#### 2. 链接旧式容器（已废弃，用自定义网络替代）

```bash
# ❌ 不推荐
docker run --link db:database web-app
```

#### 3. IPv6 支持

需在 Docker daemon 配置中启用（默认关闭）

------

### 故障排查技巧

1. **容器无法上网？**

   - 检查主机能否上网
   - 检查 DNS：`docker exec container cat /etc/resolv.conf`

2. **容器间 ping 不通？**

   - 是否在同一自定义网络？
   - 是否用了默认 bridge（不支持 DNS）？

3. **外部无法访问服务？**

   - 是否忘了 `-p` 端口映射？
   - 防火墙是否放行端口？（`ufw`, `firewalld`）

4. **查看网络拓扑**

   ```bash
   docker network inspect my-net  # 查看容器 IP 和网关
   ```

------

### 总结：Docker 网络最佳实践

| 场景                     | 推荐方案                                 |
| ------------------------ | ---------------------------------------- |
| **单容器对外服务**       | `docker run -p 主机端口:容器端口 镜像`   |
| **多容器应用（Web+DB）** | 创建自定义 bridge 网络，容器通过名称通信 |
| **高性能/低延迟**        | `--network host`（仅 Linux）             |
| **完全隔离任务**         | `--network none`                         |
| **跨主机集群**           | 使用 `overlay`（Swarm）或 Kubernetes CNI |