---
title: è‡ªåˆ¶å®¹å™¨
date: 2026-1-31
---

## è‡ªå®šä¹‰é•œåƒ

**è‡ªå®šä¹‰é•œåƒï¼ˆCustom Imageï¼‰** æ˜¯æŒ‡å¼€å‘è€…åŸºäºå®˜æ–¹æˆ–åŸºç¡€é•œåƒï¼Œ**æ·»åŠ è‡ªå·±çš„åº”ç”¨ç¨‹åºã€é…ç½®ã€ä¾èµ–æˆ–è„šæœ¬**åæ„å»ºå‡ºçš„æ–° Docker é•œåƒã€‚å®ƒä¸å†æ˜¯é€šç”¨çš„åŸºç¡€ç¯å¢ƒï¼ˆå¦‚ `nginx`ã€`python`ï¼‰ï¼Œè€Œæ˜¯**åŒ…å«ä½ ç‰¹å®šä¸šåŠ¡é€»è¾‘çš„å¯è¿è¡Œå•å…ƒ**ã€‚

> âœ… ä¸¾ä¾‹ï¼š
>
> - å®˜æ–¹é•œåƒï¼š`python:3.11`
> - è‡ªå®šä¹‰é•œåƒï¼š`my-company/user-service:v1`ï¼ˆå†…å«ä½ çš„ Python ä»£ç ã€requirementsã€å¯åŠ¨å‘½ä»¤ï¼‰

### **ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é•œåƒï¼Ÿ**

| åœºæ™¯           | è¯´æ˜                                        |
| :------------- | :------------------------------------------ |
| **åº”ç”¨æ‰“åŒ…**   | å°†ä»£ç  + ä¾èµ– + è¿è¡Œæ—¶æ‰“åŒ…æˆä¸€ä¸ªç‹¬ç«‹å•å…ƒ    |
| **ç¯å¢ƒä¸€è‡´æ€§** | å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä½¿ç”¨å®Œå…¨ç›¸åŒçš„é•œåƒ          |
| **å¿«é€Ÿéƒ¨ç½²**   | æ— éœ€åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…ä¾èµ–ï¼Œç›´æ¥ `docker run` |
| **ç‰ˆæœ¬ç®¡ç†**   | é€šè¿‡ Tag ç®¡ç†ä¸åŒç‰ˆæœ¬ï¼ˆå¦‚ `v1.0`, `v2.1`ï¼‰  |

------

### **å¦‚ä½•è‡ªåˆ¶è‡ªå®šä¹‰é•œåƒï¼Ÿâ€”â€” æ ¸å¿ƒå·¥å…·ï¼š**`Dockerfile`

åˆ¶ä½œè‡ªå®šä¹‰é•œåƒçš„æ ‡å‡†æ–¹å¼æ˜¯ç¼–å†™ **`Dockerfile`** â€”â€” ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œæè¿°å¦‚ä½•æ„å»ºé•œåƒã€‚







## Dockerfile

`Dockerfile` æ˜¯ä¸€ä¸ª**çº¯æ–‡æœ¬æ–‡ä»¶**ï¼ŒåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤ï¼ˆInstructionsï¼‰ï¼Œç”¨äº**è‡ªåŠ¨åŒ–æ„å»º Docker é•œåƒ**ã€‚å®ƒå®šä¹‰äº†é•œåƒçš„å®Œæ•´æ„å»ºè¿‡ç¨‹ï¼šä»åŸºç¡€é•œåƒå¼€å§‹ï¼Œé€æ­¥æ·»åŠ æ–‡ä»¶ã€å®‰è£…ä¾èµ–ã€è®¾ç½®ç¯å¢ƒï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªå¯è¿è¡Œçš„åº”ç”¨å®¹å™¨é•œåƒã€‚

> âœ… **æ ¸å¿ƒä»·å€¼**ï¼š  
>
> - å®ç°**æ„å»ºè¿‡ç¨‹å¯é‡å¤ã€å¯å®¡è®¡ã€å¯ç‰ˆæœ¬æ§åˆ¶**  
> - ç¡®ä¿â€œå¼€å‘-æµ‹è¯•-ç”Ÿäº§â€ç¯å¢ƒå®Œå…¨ä¸€è‡´  
> - æ˜¯ CI/CD æµæ°´çº¿ä¸­æ„å»ºé•œåƒçš„æ ‡å‡†æ–¹å¼

------

### åŸºæœ¬è¯­æ³•ä¸è§„åˆ™

#### 1. æŒ‡ä»¤æ ¼å¼

```dockerfile
# æ³¨é‡Šä»¥ # å¼€å¤´
INSTRUCTION arguments
```

- æŒ‡ä»¤**ä¸åŒºåˆ†å¤§å°å†™**ï¼Œä½†**çº¦å®šå…¨éƒ¨å¤§å†™**ï¼ˆå¦‚ `FROM`, `RUN`ï¼‰
- æ¯æ¡æŒ‡ä»¤**åˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼ˆLayerï¼‰**
- æŒ‡ä»¤æŒ‰**ä»ä¸Šåˆ°ä¸‹é¡ºåºæ‰§è¡Œ**

#### 2. æ„å»ºä¸Šä¸‹æ–‡ï¼ˆBuild Contextï¼‰

- æ‰§è¡Œ `docker build .` æ—¶ï¼Œ`.` è¡¨ç¤º**æ„å»ºä¸Šä¸‹æ–‡ç›®å½•**
- Docker ä¼šå°†è¯¥ç›®å½•**æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ åˆ° Docker å¼•æ“**ï¼ˆå³ä½¿æŸäº›æ–‡ä»¶æœªè¢«ä½¿ç”¨ï¼‰
- `COPY` / `ADD` åªèƒ½å¤åˆ¶ä¸Šä¸‹æ–‡å†…çš„æ–‡ä»¶ï¼ˆä¸èƒ½ `../outside/file`ï¼‰

> âš ï¸ **é‡è¦**ï¼šæ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚ `.env`, `id_rsa`ï¼‰åº”é€šè¿‡ `.dockerignore` æ’é™¤ï¼

#### 3. `.dockerignore` æ–‡ä»¶

ä½œç”¨ç±»ä¼¼ `.gitignore`ï¼Œé¿å…æ— å…³æˆ–æ•æ„Ÿæ–‡ä»¶è¢«ä¸Šä¼ ï¼š

```gitignore
.git
node_modules
*.log
.env
Dockerfile
README.md
```

------

### ç¤ºä¾‹

```dockerfile
# ä½¿ç”¨æ˜ç¡®ç‰ˆæœ¬çš„åŸºç¡€é•œåƒï¼ˆslim å‡å°ä½“ç§¯ï¼‰
FROM python:3.11-slim AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆç”¨äºç¼–è¯‘ Python åŒ…ï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        libpq-dev && \
    rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨å±‚ç¼“å­˜ï¼šä¾èµ–ä¸å˜åˆ™è·³è¿‡å®‰è£…ï¼‰
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–ï¼ˆä½¿ç”¨å›½å†…æºåŠ é€Ÿï¼‰
RUN pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# ===== è¿è¡Œé˜¶æ®µï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰=====
FROM python:3.11-slim

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨åŠ å›ºï¼‰
RUN adduser --disabled-password --gecos '' appuser && \
    mkdir -p /app && \
    chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä» builder é˜¶æ®µå¤åˆ¶å·²å®‰è£…çš„ä¾èµ–
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser . .

# å£°æ˜ç«¯å£ï¼ˆæ–‡æ¡£ä½œç”¨ï¼‰
EXPOSE 5000

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV FLASK_APP=app.py
ENV FLASK_ENV=production

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:5000/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["flask", "run", "--host=0.0.0.0"]
```

----

### æ ¸å¿ƒæŒ‡ä»¤è¯¦è§£

| æŒ‡ä»¤              | ç¤ºä¾‹                                                      | ä½œç”¨                       | å…³é”®è¯´æ˜                                             |
| :---------------- | :-------------------------------------------------------- | :------------------------- | :--------------------------------------------------- |
| **`FROM`**        | `FROM python:3.11-slim` `FROM node:18-alpine AS builder`  | æŒ‡å®šåŸºç¡€é•œåƒ               | å¿…é¡»æ˜¯ç¬¬ä¸€æ¡éæ³¨é‡ŠæŒ‡ä»¤ï¼›æ”¯æŒå¤šé˜¶æ®µæ„å»ºåˆ«åï¼ˆ`AS`ï¼‰   |
| **`WORKDIR`**     | `WORKDIR /app`                                            | è®¾ç½®åç»­æŒ‡ä»¤çš„å·¥ä½œç›®å½•     | è‡ªåŠ¨åˆ›å»ºç›®å½•ï¼›å¯å¤šæ¬¡ä½¿ç”¨                             |
| **`COPY`**        | `COPY . /app` `COPY requirements.txt .`                   | ä»æ„å»ºä¸Šä¸‹æ–‡å¤åˆ¶æ–‡ä»¶åˆ°é•œåƒ | **æ¨è**ç”¨äºæœ¬åœ°æ–‡ä»¶ï¼›ä¿ç•™æƒé™                       |
| **`ADD`**         | `ADD app.tar.gz /app/` `ADD https://x.com/file.zip /tmp/` | å¤åˆ¶å¹¶è‡ªåŠ¨è§£å‹/ä¸‹è½½        | **è°¨æ…ä½¿ç”¨**ï¼›ä»…å½“éœ€è¦è‡ªåŠ¨è§£å‹æˆ–è¿œç¨‹ URL æ—¶ç”¨        |
| **`RUN`**         | `RUN apt-get update && apt-get install -y curl`           | æ„å»ºæ—¶æ‰§è¡Œå‘½ä»¤             | æ¯æ¡åˆ›å»ºæ–°å±‚ï¼›**åˆå¹¶å‘½ä»¤+æ¸…ç†ç¼“å­˜**å‡å°ä½“ç§¯          |
| **`CMD`**         | `CMD ["python", "app.py"]`                                | å®¹å™¨å¯åŠ¨é»˜è®¤å‘½ä»¤           | å¯è¢« `docker run` è¦†ç›–ï¼›**exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰æ¨è**    |
| **`ENTRYPOINT`**  | `ENTRYPOINT ["./start.sh"]`                               | å®¹å™¨ä¸»å‘½ä»¤ï¼ˆä¸æ˜“è¦†ç›–ï¼‰     | ä¸ `CMD` ç»„åˆï¼š`ENTRYPOINT` å›ºå®šï¼Œ`CMD` æä¾›é»˜è®¤å‚æ•° |
| **`EXPOSE`**      | `EXPOSE 80 443`                                           | å£°æ˜å®¹å™¨ç›‘å¬ç«¯å£           | **ä»…æ–‡æ¡£ä½œç”¨**ï¼›å®é™…æ˜ å°„éœ€ `docker run -p`           |
| **`ENV`**         | `ENV NODE_ENV=production` `ENV PATH="/opt/bin: $ PATH"`   | è®¾ç½®ç¯å¢ƒå˜é‡               | åœ¨æ„å»ºå’Œè¿è¡Œæ—¶å‡ç”Ÿæ•ˆï¼›å¯é€šè¿‡ `-e` è¦†ç›–               |
| **`VOLUME`**      | `VOLUME ["/data"]`                                        | å£°æ˜æŒä¹…åŒ–æŒ‚è½½ç‚¹           | è¿è¡Œæ—¶è‹¥æœªæŒ‚è½½ï¼Œè‡ªåŠ¨åˆ›å»ºåŒ¿åå·                       |
| **`USER`**        | `USER appuser`                                            | åˆ‡æ¢è¿è¡Œç”¨æˆ·               | **å®‰å…¨æœ€ä½³å®è·µ**ï¼šé¿å… root æƒé™                     |
| **`HEALTHCHECK`** | `HEALTHCHECK CMD curl -f http://localhost/`               | å®šä¹‰å¥åº·æ£€æŸ¥å‘½ä»¤           | å®¹å™¨çŠ¶æ€æ˜¾ç¤ºä¸º `healthy`/`unhealthy`                 |
| **`LABEL`**       | `LABEL maintainer="dev@example.com"`                      | æ·»åŠ é•œåƒå…ƒæ•°æ®             | ç”¨äºæè¿°ä½œè€…ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯                             |
| **`ARG`**         | `ARG VERSION=1.0` `RUN echo  $ VERSION`                   | å®šä¹‰æ„å»ºå‚æ•°               | é€šè¿‡ `--build-arg` ä¼ å€¼ï¼›**ä¸åœ¨æœ€ç»ˆé•œåƒä¸­ä¿ç•™**      |

#### `FROM` â€”â€” æŒ‡å®šåŸºç¡€é•œåƒï¼ˆå¿…é¡»æ˜¯ç¬¬ä¸€æ¡éæ³¨é‡ŠæŒ‡ä»¤ï¼‰

```dockerfile
FROM ubuntu:22.04
FROM node:18-alpine AS builder  # æ”¯æŒå¤šé˜¶æ®µæ„å»ºåˆ«å
```

> âœ… **æœ€ä½³å®è·µ**ï¼š  
>
> - ä½¿ç”¨**å…·ä½“æ ‡ç­¾**ï¼ˆå¦‚ `python:3.11-slim`ï¼‰ï¼Œé¿å… `latest`  
> - ä¼˜å…ˆé€‰æ‹© **`-slim` æˆ– `alpine`** ç‰ˆæœ¬ä»¥å‡å°ä½“ç§¯

#### `WORKDIR` â€”â€” è®¾ç½®å·¥ä½œç›®å½•

```dockerfile
WORKDIR /app    # åç»­ COPYã€RUNã€CMD çš„é»˜è®¤è·¯å¾„
```

- è‹¥ç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
- å¯å¤šæ¬¡ä½¿ç”¨ï¼Œåç»­æŒ‡ä»¤åŸºäºæœ€æ–° `WORKDIR`

#### `COPY` â€”â€” å¤åˆ¶æ–‡ä»¶/ç›®å½•ï¼ˆæ¨èï¼‰

```dockerfile
COPY . /app                # å¤åˆ¶ä¸Šä¸‹æ–‡æ‰€æœ‰æ–‡ä»¶åˆ° /app
COPY requirements.txt .    # å¤åˆ¶å•ä¸ªæ–‡ä»¶åˆ°å½“å‰ WORKDIR
```

- **ä»…æ”¯æŒæœ¬åœ°æ–‡ä»¶**ï¼ˆä¸èƒ½æ˜¯ URLï¼‰
- **ä¿ç•™æ–‡ä»¶æƒé™å’Œå…ƒæ•°æ®**

#### `ADD` â€”â€” å¤åˆ¶å¹¶è‡ªåŠ¨è§£å‹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

```dockerfile
ADD https://example.com/app.tar.gz /app/   # æ”¯æŒ URL
ADD app.tar.gz /app/                       # è‡ªåŠ¨è§£å‹ .tar.gz
```

> âš ï¸ **å®˜æ–¹å»ºè®®**ï¼š
> **ä¼˜å…ˆç”¨ `COPY`**ï¼Œä»…åœ¨éœ€è¦è‡ªåŠ¨è§£å‹æˆ–ä¸‹è½½è¿œç¨‹æ–‡ä»¶æ—¶ç”¨ `ADD`

#### `RUN` â€”â€” æ‰§è¡Œå‘½ä»¤ï¼ˆæ„å»ºæ—¶ï¼‰

```dockerfile
RUN apt-get update && apt-get install -y curl vim
RUN pip install -r requirements.txt
```

- æ¯æ¡ `RUN` åˆ›å»ºä¸€ä¸ªæ–°å±‚

- âœ… åˆå¹¶å‘½ä»¤å‡å°‘å±‚æ•°ï¼ˆç”¨ `&&`è¿æ¥ï¼‰ï¼š

  ```dockerfile
  RUN apt-get update && \
      apt-get install -y --no-install-recommends \
          curl \
          vim && \
      rm -rf /var/lib/apt/lists/*
  ```

#### `CMD` â€”â€” å®¹å™¨å¯åŠ¨é»˜è®¤å‘½ä»¤ï¼ˆå¯è¢«è¦†ç›–ï¼‰

```dockerfile
CMD ["python", "app.py"]           # exec å½¢å¼ï¼ˆæ¨èï¼‰
CMD python app.py                  # shell å½¢å¼ï¼ˆä¸æ¨èï¼‰
```

- ä¸€ä¸ª Dockerfile **åªèƒ½æœ‰ä¸€ä¸ª `CMD`**ï¼ˆå¤šä¸ªåˆ™æœ€åä¸€ä¸ªç”Ÿæ•ˆï¼‰
- `docker run image command` ä¼š**è¦†ç›–** `CMD`

#### `ENTRYPOINT` â€”â€” å®¹å™¨ä¸»å‘½ä»¤ï¼ˆä¸æ˜“è¢«è¦†ç›–ï¼‰

```dockerfile
ENTRYPOINT ["./start.sh"]
```

- ä¸ `CMD` ç»„åˆä½¿ç”¨ï¼š`ENTRYPOINT` å®šä¹‰å›ºå®šå‘½ä»¤ï¼Œ`CMD` æä¾›é»˜è®¤å‚æ•°
- `docker run image arg1 arg2` â†’ ä¼šä¼ é€’ç»™ `ENTRYPOINT`

> ğŸ”„ **`CMD` vs `ENTRYPOINT`**ï¼š
>
> | åœºæ™¯                       | æ¨è                                        |
> | -------------------------- | ------------------------------------------- |
> | åº”ç”¨ç›´æ¥å¯åŠ¨ï¼ˆå¦‚ Nginxï¼‰   | `ENTRYPOINT ["nginx", "-g", "daemon off;"]` |
> | æä¾›é»˜è®¤å‚æ•°ï¼Œå…è®¸ç”¨æˆ·è¦†ç›– | `CMD ["--help"]`                            |

#### `EXPOSE` â€”â€” å£°æ˜ç«¯å£ï¼ˆæ–‡æ¡£ä½œç”¨ï¼‰

```dockerfile
EXPOSE 80 443
```

- **ä¸å®é™…å‘å¸ƒç«¯å£**ï¼ä»…ä½œä¸ºæ–‡æ¡£æç¤º
- å®é™…ç«¯å£æ˜ å°„éœ€ `docker run -p`

#### `ENV` â€”â€” è®¾ç½®ç¯å¢ƒå˜é‡

```dockerfile
ENV NODE_ENV=production
ENV PATH="/usr/local/node/bin:$PATH"
```

- å˜é‡åœ¨åç»­ `RUN` å’Œå®¹å™¨è¿è¡Œæ—¶å‡å¯ç”¨
- å¯é€šè¿‡ `docker run -e` è¦†ç›–

#### `VOLUME` â€”â€” å£°æ˜æŒ‚è½½ç‚¹

```dockerfile
VOLUME ["/data", "/var/log"]
```

- å‘ŠçŸ¥ç”¨æˆ·å“ªäº›ç›®å½•åº”æŒä¹…åŒ–
- è¿è¡Œæ—¶è‹¥æœªæŒ‚è½½ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºåŒ¿åå·

------

### å¤šé˜¶æ®µæ„å»ºï¼ˆMulti-stage Buildï¼‰

ç”¨äº**å¤§å¹…å‡å°æœ€ç»ˆé•œåƒä½“ç§¯**ï¼Œå°¤å…¶é€‚ç”¨äºç¼–è¯‘å‹è¯­è¨€ï¼ˆGoã€Javaã€C++ï¼‰ã€‚

#### ç¤ºä¾‹ï¼šGo åº”ç”¨

```dockerfile
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º
FROM golang:1.22 AS builder
WORKDIR /app
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main .

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
# ä»…ä» builder é˜¶æ®µå¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/main .
CMD ["./main"]
```

> âœ… **ä¼˜åŠ¿**ï¼š  
>
> - æœ€ç»ˆé•œåƒä¸å« Go ç¼–è¯‘å™¨ï¼ˆä» 800MB+ é™è‡³ 10MBï¼‰  
> - æ„å»ºä¾èµ–ä¸è¿è¡Œæ—¶å®Œå…¨éš”ç¦»

------

### æ„å»ºä¸éªŒè¯æµç¨‹

#### 1. æ„å»ºé•œåƒ

```bash
# åœ¨ Dockerfile æ‰€åœ¨ç›®å½•æ‰§è¡Œ
docker build -t my-app:v1 .

# æŒ‡å®š Dockerfile è·¯å¾„ï¼ˆéé»˜è®¤åç§°ï¼‰
docker build -f ./deploy/Dockerfile.prod -t my-app:prod .
```

#### 2. æŸ¥çœ‹æ„å»ºå†å²

```bash
docker history my-app:v1  # æŸ¥çœ‹å„å±‚å¤§å°å’ŒæŒ‡ä»¤
```

#### 3. æµ‹è¯•è¿è¡Œ

```bash
docker run -d -p 8080:80 --name test-app my-app:v1
curl http://localhost:8080
docker logs test-app
docker stop test-app && docker rm test-app
```

#### 4. æ¨é€é•œåƒï¼ˆå¯é€‰ï¼‰

```bash
docker tag my-app:v1 registry.example.com/my-app:v1
docker push registry.example.com/my-app:v1
```

------

### æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±

#### âœ… æ¨èåšæ³•

| å®è·µ                     | è¯´æ˜                                                         |
| ------------------------ | ------------------------------------------------------------ |
| **ä½¿ç”¨ `.dockerignore`** | é¿å…ä¸Šä¼ æ— ç”¨æ–‡ä»¶ï¼ŒåŠ é€Ÿæ„å»º                                   |
| **å›ºå®šåŸºç¡€é•œåƒç‰ˆæœ¬**     | `FROM python:3.11-slim` è€Œé `python`                        |
| **åˆå¹¶ RUN æŒ‡ä»¤**        | å‡å°‘é•œåƒå±‚æ•°ï¼Œæ¸…ç†ç¼“å­˜ï¼ˆå¦‚ `rm -rf /var/lib/apt/lists/*`ï¼‰   |
| **é root ç”¨æˆ·è¿è¡Œ**     | `RUN adduser appuser && chown -R appuser /app` + `USER appuser` |
| **ä¼˜å…ˆ COPY è€Œé ADD**   | æ˜ç¡®æ§åˆ¶æ–‡ä»¶æ¥æº                                             |
| **ä½¿ç”¨å¤šé˜¶æ®µæ„å»º**       | åˆ†ç¦»æ„å»ºç¯å¢ƒä¸è¿è¡Œç¯å¢ƒ                                       |

#### âŒ å¸¸è§é”™è¯¯

| é”™è¯¯                              | åæœ           | ä¿®å¤                                               |
| --------------------------------- | -------------- | -------------------------------------------------- |
| åœ¨ `RUN` ä¸­ä½¿ç”¨ `apt-get upgrade` | é•œåƒä¸å¯å¤ç°   | é¿å…å‡çº§ç³»ç»ŸåŒ…                                     |
| æ•æ„Ÿä¿¡æ¯å†™å…¥ Dockerfile           | å¯†ç æ³„éœ²       | ç”¨ `--secret` æˆ–æ„å»ºå‚æ•°                           |
| æœªæ¸…ç†åŒ…ç®¡ç†ç¼“å­˜                  | é•œåƒä½“ç§¯è†¨èƒ€   | `RUN apt-get clean && rm -rf /var/lib/apt/lists/*` |
| `COPY` å¤§ç›®å½•è¿‡æ—©                 | å±‚ç¼“å­˜å¤±æ•ˆé¢‘ç¹ | å°† `COPY . .` æ”¾åœ¨æœ€å                             |

------

### é«˜çº§æŠ€å·§

#### 1. æ„å»ºå‚æ•°ï¼ˆ`ARG`ï¼‰

```dockerfile
ARG VERSION=1.0
ENV APP_VERSION=$VERSION
COPY app-$VERSION.jar app.jar
```

æ„å»ºæ—¶ä¼ å‚ï¼š

```bash
docker build --build-arg VERSION=2.1 -t my-app .
```

#### 2. å¥åº·æ£€æŸ¥ï¼ˆHEALTHCHECKï¼‰

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1
```

- å®¹å™¨å¯åŠ¨åå®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦å¥åº·
- `docker ps` ä¼šæ˜¾ç¤ºçŠ¶æ€ï¼ˆhealthy/unhealthyï¼‰

#### 3. å…ƒæ•°æ®æ ‡ç­¾ï¼ˆLABELï¼‰

```dockerfile
LABEL maintainer="dev@example.com"
LABEL version="1.0"
LABEL description="My Custom App"
```

æŸ¥çœ‹æ ‡ç­¾ï¼š

```bash
docker inspect my-app --format='{{json .Config.Labels}}'
```

------







## buildä½¿ç”¨Dockerfileè‡ªåˆ¶é•œåƒ

`docker build` æ˜¯ Docker ä¸­ç”¨äº**æ ¹æ® Dockerfile æ„å»ºè‡ªå®šä¹‰é•œåƒ**çš„æ ¸å¿ƒå‘½ä»¤ã€‚

```bash
docker build [OPTIONS] PATH | URL | -
```

æœ€å¸¸ç”¨å½¢å¼ï¼š

```bash
docker build -t é•œåƒå:æ ‡ç­¾ æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„
```

- `-t`ï¼šæŒ‡å®šç”Ÿæˆçš„é•œåƒåç§°å’Œæ ‡ç­¾ï¼ˆTagï¼‰ï¼Œå¯çœç•¥æ ‡ç­¾ï¼Œé»˜è®¤ä¸º `latest`
- **æœ€åçš„ `.`**ï¼šè¡¨ç¤º**æ„å»ºä¸Šä¸‹æ–‡ï¼ˆBuild Contextï¼‰** ä¸ºå½“å‰ç›®å½•

> ğŸ“Œ **é‡è¦æ¦‚å¿µ**ï¼š
> **æ„å»ºä¸Šä¸‹æ–‡ â‰  Dockerfile æ‰€åœ¨ç›®å½•**
> å®ƒæ˜¯ Docker ä¸Šä¼ åˆ°æ„å»ºå¼•æ“çš„æ•´ä¸ªæ–‡ä»¶é›†åˆï¼Œ`COPY`/`ADD` åªèƒ½è®¿é—®å…¶ä¸­çš„æ–‡ä»¶ã€‚
>
> Docker åœ¨æ„å»ºé•œåƒæ—¶ï¼Œä¼šå°†**æ•´ä¸ªæ„å»ºä¸Šä¸‹æ–‡ç›®å½•**ä¸Šä¼ åˆ° Docker å¼•æ“ã€‚
> è€Œ `Dockerfile` è¦ä¹ˆï¼š
>
> 1. **é»˜è®¤ä½äºæ„å»ºä¸Šä¸‹æ–‡æ ¹ç›®å½•ä¸‹**ï¼ˆæ–‡ä»¶åå¿…é¡»æ˜¯ `Dockerfile`ï¼‰ï¼Œæˆ–
> 2. **é€šè¿‡ `-f` å‚æ•°æ˜¾å¼æŒ‡å®šè·¯å¾„**ï¼ˆè¯¥è·¯å¾„å¿…é¡»åœ¨æ„å»ºä¸Šä¸‹æ–‡å†…ï¼‰ï¼š
>
> ```bash
> docker build -f deploy/Dockerfile.prod -t my-app .
> ```
>
> âš ï¸ **å…³é”®é™åˆ¶**ï¼š
> **`Dockerfile` ä¸èƒ½ä½äºæ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¹‹å¤–ï¼**
> å› ä¸º Docker ä¸å…è®¸è®¿é—®ä¸Šä¸‹æ–‡ä»¥å¤–çš„æ–‡ä»¶ï¼ˆå®‰å…¨è®¾è®¡ï¼‰ã€‚

| åœºæ™¯                                              | å‘½ä»¤ç¤ºä¾‹                                                 | è¯´æ˜                                    |
| :------------------------------------------------ | :------------------------------------------------------- | :-------------------------------------- |
| **æŒ‡å®šä¸åŒåç§°çš„ Dockerfile**                     | `docker build -f ./deploy/Dockerfile.prod -t app:prod .` | `-f` æŒ‡å®š Dockerfile è·¯å¾„               |
| **ä¸ä½¿ç”¨ç¼“å­˜ï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰**                    | `docker build --no-cache -t app .`                       | å¿½ç•¥æ‰€æœ‰å±‚ç¼“å­˜                          |
| **åªè¾“å‡ºé•œåƒ IDï¼ˆé™é»˜æ¨¡å¼ï¼‰**                     | `docker build -q -t app .`                               | `-q` = quietï¼Œé€‚åˆè„šæœ¬                  |
| **ä¼ é€’æ„å»ºå‚æ•°**                                  | `docker build --build-arg VERSION=2.1 -t app .`          | éœ€åœ¨ Dockerfile ä¸­ç”¨ `ARG VERSION` æ¥æ”¶ |
| **æŒ‡å®šå¹³å°ï¼ˆå¦‚ Apple Silicon æ„å»º Linux/amd64ï¼‰** | `docker build --platform linux/amd64 -t app .`           | è·¨å¹³å°æ„å»º                              |

