---
title: IServiceçš„æ‰¹é‡æ’å…¥
date: 2026-1-29
---

> è°¨è®°mysqlæ‰¹é‡æ’å…¥å°½å¯èƒ½ä½¿ç”¨**æ‰¹å¤„ç†**çš„æ–¹å¼è€Œéä¸€å£æ°”å…¨éƒ¨æ’å…¥ï¼

 **`rewriteBatchedStatements`** æ˜¯ **MySQL JDBC é©±åŠ¨ï¼ˆConnector/Jï¼‰** ä¸­çš„ä¸€ä¸ªé‡è¦å‚æ•°ï¼Œ**å’Œ Redis çš„ Pipeline æœ‰ç›¸ä¼¼ç›®æ ‡ï¼ˆæå‡æ‰¹é‡æ“ä½œæ€§èƒ½ï¼‰ï¼Œä½†å®ç°æœºåˆ¶å®Œå…¨ä¸åŒ**ã€‚ä¸‹é¢è¯¦ç»†è§£é‡Šï¼š

------

## ä¸€ã€`rewriteBatchedStatements` æ˜¯ä»€ä¹ˆï¼Ÿ

### âœ… å®šä¹‰

å®ƒæ˜¯ MySQL JDBC é©±åŠ¨çš„ä¸€ä¸ª **è¿æ¥å‚æ•°ï¼ˆConnection Propertyï¼‰**ï¼Œç”¨äº**ä¼˜åŒ–æ‰¹é‡æ‰§è¡Œï¼ˆ`addBatch()` + `executeBatch()`ï¼‰çš„æ€§èƒ½**ã€‚

é»˜è®¤å€¼ï¼š`false`
å»ºè®®ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºï¼š`true`

### âœ… ä½œç”¨

å½“å¯ç”¨æ—¶ï¼ŒJDBC é©±åŠ¨ä¼š**è‡ªåŠ¨å°†å¤šæ¡ç›¸åŒçš„ INSERT/UPDATE è¯­å¥é‡å†™ï¼ˆrewriteï¼‰æˆä¸€æ¡å¤šå€¼ SQL**ï¼Œä»è€Œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°å’ŒæœåŠ¡å™¨è§£æå¼€é”€ã€‚

------

## äºŒã€å·¥ä½œåŸç†ï¼ˆå¯¹æ¯”è¯´æ˜ï¼‰

### ğŸ“Œ åœºæ™¯ï¼šæ‰¹é‡æ’å…¥ 3 æ¡è®°å½•

```java
PreparedStatement ps = conn.prepareStatement("INSERT INTO user(name, age) VALUES(?, ?)");
ps.setString(1, "å¼ ä¸‰"); ps.setInt(2, 20); ps.addBatch();
ps.setString(1, "æå››"); ps.setInt(2, 25); ps.addBatch();
ps.setString(1, "ç‹äº”"); ps.setInt(2, 30); ps.addBatch();
ps.executeBatch();
```

#### æƒ…å†µ 1ï¼š`rewriteBatchedStatements=false`ï¼ˆé»˜è®¤ï¼‰

é©±åŠ¨ä¼šå‘é€ **3 æ¡ç‹¬ç«‹ SQL** åˆ° MySQLï¼š

```sql
INSERT INTO user(name, age) VALUES('å¼ ä¸‰', 20);
INSERT INTO user(name, age) VALUES('æå››', 25);
INSERT INTO user(name, age) VALUES('ç‹äº”', 30);
```

â†’ **3 æ¬¡ç½‘ç»œå¾€è¿” + 3 æ¬¡ SQL è§£æ**

#### æƒ…å†µ 2ï¼š`rewriteBatchedStatements=true`

é©±åŠ¨è‡ªåŠ¨é‡å†™ä¸º **1 æ¡å¤šå€¼ SQL**ï¼š

```sql
INSERT INTO user(name, age) VALUES('å¼ ä¸‰', 20), ('æå››', 25), ('ç‹äº”', 30);
```

â†’ **1 æ¬¡ç½‘ç»œå¾€è¿” + 1 æ¬¡ SQL è§£æ**ï¼Œæ€§èƒ½å¤§å¹…æå‡ï¼

> ğŸ”¸ åŒæ ·é€‚ç”¨äº `UPDATE`ï¼ˆæ¡ä»¶ç›¸åŒæ—¶ï¼‰ï¼š
>
> ```sql
> UPDATE user SET status=0 WHERE id IN (1,2,3); -- å¦‚æœåŸ batch æ˜¯åˆ†åˆ« update id=1,2,3
> ```

------

## ä¸‰ã€å¦‚ä½•é…ç½®ï¼Ÿ

åœ¨ JDBC URL ä¸­æ·»åŠ å‚æ•°ï¼š

```java
// MySQL 5.7 / 8.0
jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true

// æ›´å®Œæ•´çš„ç”Ÿäº§é…ç½®ï¼ˆæ¨èï¼‰
jdbc:mysql://localhost:3306/test?
    rewriteBatchedStatements=true&
    useServerPrepStmts=false&
    allowMultiQueries=true
```

> âš ï¸ æ³¨æ„ï¼š
>
> - å¿…é¡»ä½¿ç”¨ **`PreparedStatement` + `addBatch()`/`executeBatch()`**ï¼Œç›´æ¥æ‹¼æ¥ SQL å­—ç¬¦ä¸²æ— æ•ˆã€‚
> - å¯¹ `Statement`ï¼ˆéé¢„ç¼–è¯‘ï¼‰æ— æ•ˆã€‚

------

## å››ã€å’Œ Redis Pipeline çš„å¯¹æ¯”

| ç‰¹æ€§                  | MySQL `rewriteBatchedStatements` | Redis Pipeline                      |
| --------------------- | -------------------------------- | ----------------------------------- |
| **ç›®æ ‡**              | å‡å°‘ç½‘ç»œå¾€è¿” + SQL è§£æå¼€é”€      | å‡å°‘ç½‘ç»œå¾€è¿”ï¼ˆRTTï¼‰                 |
| **å®ç°å±‚**            | JDBC é©±åŠ¨å±‚ï¼ˆå®¢æˆ·ç«¯é‡å†™ SQLï¼‰    | Redis å®¢æˆ·ç«¯åè®®å±‚ï¼ˆæ‰¹é‡å‘é€å‘½ä»¤ï¼‰  |
| **æ˜¯å¦æ”¹å˜ SQL/å‘½ä»¤** | âœ… é‡å†™ä¸ºå•æ¡å¤šå€¼ SQL             | âŒ å‘½ä»¤ä¸å˜ï¼Œåªæ˜¯æ‰¹é‡å‘é€            |
| **æœåŠ¡ç«¯æ„ŸçŸ¥**        | æœåŠ¡ç«¯çœ‹åˆ°çš„æ˜¯å•æ¡ SQL           | æœåŠ¡ç«¯ä¾æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤              |
| **é€‚ç”¨æ“ä½œ**          | INSERT / UPDATEï¼ˆåŒç»“æ„ï¼‰        | ä»»æ„ Redis å‘½ä»¤ï¼ˆGET/SET/HMSET ç­‰ï¼‰ |
| **äº‹åŠ¡æ€§**            | ä¸ä¿è¯åŸå­æ€§ï¼ˆé™¤éå¤–å±‚åŠ äº‹åŠ¡ï¼‰   | ä¸è‡ªåŠ¨å¼€å¯äº‹åŠ¡ï¼ˆéœ€é…åˆ MULTI/EXECï¼‰ |

### ğŸ’¡ ç›¸ä¼¼ç‚¹ï¼š

- éƒ½æ˜¯ä¸ºäº† **é™ä½å¤šæ¬¡å°æ“ä½œçš„ç½‘ç»œå»¶è¿Ÿå¼€é”€**
- éƒ½æ˜¯ **å®¢æˆ·ç«¯ä¼˜åŒ–æŠ€æœ¯**

### âŒ å…³é”®åŒºåˆ«ï¼š

- **MySQL çš„ `rewriteBatchedStatements` ä¼šæ”¹å†™ SQL è¯­å¥æœ¬èº«**  
- **Redis Pipeline åªæ˜¯â€œæ‰“åŒ…å‘é€â€ï¼Œå‘½ä»¤å†…å®¹ä¸å˜**

> ğŸŒ° ä¸¾ä¾‹ï¼š
>
> - Redis Pipelineï¼šå‘é€ `[SET a 1, SET b 2, GET a]` â†’ æœåŠ¡ç«¯æ‰§è¡Œ 3 æ¡å‘½ä»¤  
> - MySQL rewriteï¼šæŠŠ 3 æ¡ `INSERT` â†’ åˆå¹¶æˆ 1 æ¡ `INSERT ... VALUES (), (), ()`

------

## äº”ã€æ€§èƒ½æå‡æ•ˆæœ

æ ¹æ®å®˜æ–¹å’Œç¤¾åŒºæµ‹è¯•ï¼š

- æ‰¹é‡æ’å…¥ 10,000 æ¡è®°å½•ï¼š
  - `rewriteBatchedStatements=false`ï¼šå¯èƒ½éœ€è¦ **10~30 ç§’**
  - `rewriteBatchedStatements=true`ï¼šé€šå¸¸ **< 1 ç§’**

> âœ… è¿™æ˜¯ MyBatis-Plus / JPA / Hibernate ç­‰ ORM æ¡†æ¶åšæ‰¹é‡æ’å…¥æ—¶**å¿…é¡»å¼€å¯çš„å‚æ•°**ï¼
>
> **åŒæ—¶è°¨è®°mysqlæ‰¹é‡æ’å…¥å°½å¯èƒ½ä½¿ç”¨æ‰¹å¤„ç†çš„æ–¹å¼è€Œéä¸€å£æ°”å…¨éƒ¨æ’å…¥ï¼**

------

## å…­ã€MyBatis-Plus ä¸­å¦‚ä½•é…åˆä½¿ç”¨ï¼Ÿ

MP çš„ `saveBatch()` åº•å±‚å°±æ˜¯ç”¨ `PreparedStatement.addBatch()`ï¼Œæ‰€ä»¥ï¼š

### 1. æ•°æ®æºé…ç½®ï¼ˆapplication.ymlï¼‰

```yaml
spring:
  datasource:
    url: jdbc:mysql://...?rewriteBatchedStatements=true&useSSL=false
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### 2. è°ƒç”¨æ‰¹é‡æ–¹æ³•

```java
List<User> list = ...; // 1000 æ¡æ•°æ®
userService.saveBatch(list, 1000); // è‡ªåŠ¨åˆ†æ‰¹ + åˆ©ç”¨ rewrite ä¼˜åŒ–
```

> ğŸ”¸ å¦‚æœä¸åŠ  `rewriteBatchedStatements=true`ï¼Œ`saveBatch()` æ€§èƒ½ä¼šå¾ˆå·®ï¼

------

## âœ… æ€»ç»“

| é—®é¢˜                                        | ç­”æ¡ˆ                                                         |
| ------------------------------------------- | ------------------------------------------------------------ |
| **`rewriteBatchedStatements` æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ** | MySQL JDBC é©±åŠ¨å‚æ•°ï¼Œå°†æ‰¹é‡ INSERT/UPDATE é‡å†™ä¸ºå•æ¡å¤šå€¼ SQLï¼Œæå‡æ€§èƒ½ |
| **å’Œ Redis Pipeline ä¸€æ ·å—ï¼Ÿ**              | ç›®æ ‡ç›¸ä¼¼ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰ï¼Œä½†æœºåˆ¶ä¸åŒï¼šMySQL æ”¹å†™ SQLï¼ŒRedis åªæ˜¯æ‰¹é‡å‘å‘½ä»¤ |
| **è¦ä¸è¦å¼€ï¼Ÿ**                              | **å¿…é¡»å¼€ï¼** å°¤å…¶åœ¨ä½¿ç”¨ MyBatis-Plus `saveBatch()` æ—¶        |
| **æ€ä¹ˆå¼€ï¼Ÿ**                                | åœ¨ JDBC URL åŠ  `?rewriteBatchedStatements=true`              |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼š
> **æ‰€æœ‰ä½¿ç”¨ MySQL æ‰¹é‡æ“ä½œçš„ Java åº”ç”¨ï¼ŒJDBC URL åŠ¡å¿…åŠ ä¸Š `rewriteBatchedStatements=true`ï¼**