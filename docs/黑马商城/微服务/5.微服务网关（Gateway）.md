---
title: å¾®æœåŠ¡ç½‘å…³
date: 2026-2-3
---

ä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´æ—…ç¨‹ï¼š
**Client â†’ Nginxï¼ˆåå‘ä»£ç†ï¼‰ â†’ Gatewayï¼ˆè·¯ç”±+è¿‡æ»¤ï¼‰ â†’ Nacosï¼ˆæœåŠ¡å‘ç°ï¼‰ â†’ LoadBalancerï¼ˆé€‰å®ä¾‹ï¼‰ â†’ ç›®æ ‡æœåŠ¡ â†’ ï¼ˆå¯èƒ½åµŒå¥—è°ƒç”¨ï¼‰ â†’ å“åº”åŸè·¯è¿”å›**

```
[Client]
   â”‚
   â–¼
[Nginx åå‘ä»£ç†]
   â”‚
   â–¼
[Spring Cloud Gateway] â†â†’ [Nacos (æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ)]
   â”‚
   â–¼
[LoadBalancer é€‰æ‹©å®ä¾‹]
   â”‚
   â–¼
[ç›®æ ‡å¾®æœåŠ¡ï¼ˆå¦‚ order-serviceï¼‰]
   â”‚
   â–¼
[å¯èƒ½è°ƒç”¨å…¶ä»–å¾®æœåŠ¡ï¼ˆé€šè¿‡ OpenFeignï¼‰]
   â”‚
   â–¼
[è¿”å›å“åº” â†’ Gateway â†’ Client]
```

> æ¶‰åŠçš„ç»„ä»¶ï¼š
>
> | ç»„ä»¶                          | è§’è‰²                                    |
> | :---------------------------- | :-------------------------------------- |
> | **Nacos**                     | æœåŠ¡æ³¨å†Œå‘ç° + é…ç½®ä¸­å¿ƒï¼ˆåŠ¨æ€æ›´æ–°è·¯ç”±ï¼‰ |
> | **OpenFeign**                 | æœåŠ¡é—´å£°æ˜å¼è°ƒç”¨                        |
> | **Spring Cloud Gateway**      | API ç½‘å…³ï¼Œè·¯ç”± + è¿‡æ»¤ + åè®®è½¬æ¢        |
> | **Spring Cloud LoadBalancer** | æ›¿ä»£ Ribbonï¼Œå®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡         |
> | **Seata**                     | åˆ†å¸ƒå¼äº‹åŠ¡                              |
> | **Resilience4j / Sentinel**   | ç†”æ–­ã€é™çº§ã€é™æµ                        |
> | **Sleuth + Zipkin**           | åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª                          |

## Springcloud Gateway

è¯´æ˜æ–‡æ¡£ï¼š[Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/3.1.9/reference/html/)

**Spring Cloud Gateway** æ˜¯ Spring Cloud å®˜æ–¹æ¨å‡ºçš„**æ–°ä¸€ä»£ API ç½‘å…³**ï¼Œç”¨äºæ›¿ä»£ Netflix Zuulï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼‰ã€‚å®ƒåŸºäº **Project Reactor + WebFlux + Netty** æ„å»ºï¼Œæ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½ã€å“åº”å¼ã€éé˜»å¡**çš„ç½‘å…³æ¡†æ¶ã€‚

> ğŸ¯ **æ ¸å¿ƒç›®æ ‡**ï¼šä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ç»Ÿä¸€å…¥å£ï¼Œå®ç° **è·¯ç”±è½¬å‘ã€å®‰å…¨æ§åˆ¶ã€æµé‡æ²»ç†ã€å¯è§‚æµ‹æ€§** ç­‰èƒ½åŠ›ã€‚

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹ç—›ç‚¹ï¼š

- æ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹åœ°å€ï¼Œå®¢æˆ·ç«¯éœ€è®°ä½å¤šä¸ª URL
- è·¨åŸŸã€è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰é€»è¾‘é‡å¤ç¼–å†™
- æœåŠ¡åŠ¨æ€æ‰©ç¼©å®¹ï¼ŒIP ä¸å›ºå®š
- å¤–éƒ¨ç›´æ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼Œå­˜åœ¨å®‰å…¨é£é™©

âœ… **ç½‘å…³çš„ä½œç”¨**ï¼š

- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰è¯·æ±‚å…ˆç»è¿‡ç½‘å…³
- **éšè—å†…éƒ¨ç»†èŠ‚**ï¼šå®¢æˆ·ç«¯åªä¸ç½‘å…³äº¤äº’
- **æ¨ªåˆ‡å…³æ³¨ç‚¹é›†ä¸­å¤„ç†**ï¼šè®¤è¯ã€é™æµã€æ—¥å¿—ã€ç›‘æ§ç­‰



### å…³é”®å†…å®¹

#### **1.Routeï¼ˆè·¯ç”±ï¼‰**

- ç½‘å…³çš„åŸºæœ¬æ„å»ºå—

- åŒ…å«ï¼šIDã€ç›®æ ‡ URIã€æ–­è¨€é›†åˆã€è¿‡æ»¤å™¨é›†åˆ

- ç¤ºä¾‹ï¼š

  ```yml
  routes:
    - id: user-service # å”¯ä¸€è§„åˆ™idï¼Œè‡ªå®šä¹‰å³å¯
      uri: lb://user-service # ç›®æ ‡å¾®æœåŠ¡å®ä¾‹åç§°ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡
      predicates: # æ–­è¨€ï¼Œä¼šæˆªå–ä»¥ä¸‹è·¯å¾„å‘ç»™è§„åˆ™æŒ‡å®šçš„å¾®æœåŠ¡å®ä¾‹
        - Path=/api/user/**
      filters: # è¿‡æ»¤å™¨ï¼Œå¯å¯¹ä¼ å…¥è·¯å¾„ä½œé‡å†™ç­‰æ“ä½œï¼Œå¤„ç†å®Œæˆåå‘é€ç»™æŒ‡å®šå®ä¾‹
        - StripPrefix=1
  ```

> idéšæ„å³å¯ã€‚
>
> è¿™é‡Œuriçš„ `user-service` **å°±æ˜¯ Nacosï¼ˆæˆ–å…¶ä»–æ³¨å†Œä¸­å¿ƒï¼‰ä¸­æ³¨å†Œçš„æœåŠ¡åç§°**ï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡å¾®æœåŠ¡åœ¨ `application.yml` ä¸­é…ç½®çš„ï¼š
>
> ```yml
> spring:
> application:
>  name: user-service   # â† è¿™ä¸ªåå­—ï¼
> ```
>
> - `lb` æ˜¯ **LoadBalancer** çš„ç¼©å†™
>
> - å®ƒå‘Šè¯‰ Spring Cloud Gatewayï¼š
>
>   â€œä¸è¦ç›´æ¥è¿æ¥ä¸€ä¸ªå›ºå®š IPï¼Œè€Œæ˜¯å»æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰æŸ¥æ‰¾åä¸º `user-service` çš„æ‰€æœ‰å®ä¾‹ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªæ¥è½¬å‘è¯·æ±‚ã€‚â€
>
>  **æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š**
>
> 1. Gateway æ”¶åˆ°è¯·æ±‚ï¼š`GET /api/user/123`
>
> 2. åŒ¹é…åˆ°è·¯ç”± `Path=/api/user/**`
>
> 3. çœ‹åˆ° `uri: lb://user-service`
>
> 4. å‘ Nacos æŸ¥è¯¢ï¼šæœ‰å“ªäº›å®ä¾‹æ³¨å†Œäº† `spring.application.name = user-service `
>
>    - Nacos è¿”å›ï¼š`[192.168.1.10:8080, 192.168.1.11:8080]`
>
> 5. Gateway ä½¿ç”¨ **Spring Cloud LoadBalancer**ï¼ˆé»˜è®¤è½®è¯¢ï¼‰é€‰æ‹©ä¸€ä¸ªå®ä¾‹ï¼Œæ¯”å¦‚ `192.168.1.10:8080`
>
> 6. è½¬å‘è¯·æ±‚åˆ°ï¼š`http://192.168.1.10:8080/user/123`ï¼ˆæ³¨æ„è·¯å¾„å·²è¢« `StripPrefix=1` å»æ‰ `/api`ï¼‰

#### **2.Predicateï¼ˆæ–­è¨€ï¼‰**

- å†³å®šè¯·æ±‚æ˜¯å¦åŒ¹é…æŸæ¡è·¯ç”±
- å†…ç½®å¤šç§æ–­è¨€ï¼š
  - `Path=/api/**`
  - `Method=GET`
  - `Header=X-Token, \d+`
  - `Query=username, abc`
  - `Host=*.example.com`
  - `After=2026-01-01T00:00:00Z`

#### **3.Filterï¼ˆè¿‡æ»¤å™¨ï¼‰**

- åœ¨è¯·æ±‚è½¬å‘å‰åæ‰§è¡Œé€»è¾‘
- åˆ†ä¸¤ç±»ï¼š
  - **GatewayFilter**ï¼šä½œç”¨äºå•ä¸ªè·¯ç”±
  - **GlobalFilter**ï¼šä½œç”¨äºæ‰€æœ‰è·¯ç”±

 **å¸¸è§è¿‡æ»¤å™¨ï¼š**

| è¿‡æ»¤å™¨               | ä½œç”¨              |
| :------------------- | :---------------- |
| `AddRequestHeader`   | æ·»åŠ è¯·æ±‚å¤´        |
| `StripPrefix`        | å»æ‰è·¯å¾„å‰ç¼€      |
| `RewritePath`        | é‡å†™è·¯å¾„          |
| `RequestRateLimiter` | é™æµï¼ˆéœ€ Redisï¼‰  |
| `TokenRelay`         | é€ä¼  OAuth2 Token |



### å¼•å…¥ä¾èµ–

å¼•å…¥Gatewayï¼Œnacosä»¥åŠloadbalancerï¼š

```XML
    <dependencies>
        <!--common-->
        <dependency>
            <groupId>com.heima</groupId>
            <artifactId>hm-common</artifactId>
            <version>1.0.0</version>
        </dependency>
        <!--ç½‘å…³-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>
        <!--nacos discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--è´Ÿè½½å‡è¡¡-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
    </dependencies>
    <build>
        <finalName>${project.artifactId}</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
```



### é…ç½®

```yml
server:
  port: 8080
spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: 192.168.0.200:8848
    gateway:
      routes:
        - id: item # è·¯ç”±è§„åˆ™idï¼Œè‡ªå®šä¹‰ï¼Œå”¯ä¸€
          uri: lb://item-service # è·¯ç”±çš„ç›®æ ‡æœåŠ¡ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—è¡¨
          predicates: # è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è§„åˆ™ï¼Œç¬¦åˆåˆ™è·¯ç”±åˆ°ç›®æ ‡æœåŠ¡
            - Path=/items/**,/search/** # è¿™é‡Œæ˜¯ä»¥è¯·æ±‚è·¯å¾„ä½œä¸ºåˆ¤æ–­è§„åˆ™
              
        - id: cart
          uri: lb://cart-service
          predicates:
            - Path=/carts/**
              
        - id: user
          uri: lb://user-service
          predicates:
            - Path=/users/**,/addresses/**
              
        - id: trade
          uri: lb://trade-service
          predicates:
            - Path=/orders/**
              
        - id: pay
          uri: lb://pay-service
          predicates:
            - Path=/pay-orders/**
```



## è·¯ç”±å±æ€§

### æ–­è¨€Predicate

| Predicate åç§°           | YAML é…ç½®ç¤ºä¾‹                                                | åŠŸèƒ½è¯´æ˜           | åŒ¹é…æ¡ä»¶                              | æ³¨æ„äº‹é¡¹                                             |
| ------------------------ | ------------------------------------------------------------ | ------------------ | ------------------------------------- | ---------------------------------------------------- |
| Path                     | `- Path=/api/user/`                                          | åŒ¹é…è¯·æ±‚è·¯å¾„       | Ant é£æ ¼è·¯å¾„ï¼š â€¢ `*`ï¼šå•å±‚ â€¢ ``ï¼šå¤šå±‚ | æœ€å¸¸ç”¨ï¼›æ”¯æŒè·¯å¾„å˜é‡ï¼ˆå¦‚ `/api/{id}`ï¼‰               |
| Method                   | `- Method=GET,POST`                                          | åŒ¹é… HTTP æ–¹æ³•     | `GET`, `POST`, `PUT`, `DELETE` ç­‰     | å¤šä¸ªæ–¹æ³•ç”¨é€—å·åˆ†éš”                                   |
| Header                   | `- Header=X-Token` `- Header=X-Token, \d+`                   | åŒ¹é…è¯·æ±‚å¤´         | å­˜åœ¨æŸ Headerï¼Œæˆ–å€¼ç¬¦åˆæ­£åˆ™           | æ­£åˆ™éœ€è½¬ä¹‰ï¼ˆå¦‚ `\d+`ï¼‰ï¼›Header åä¸åŒºåˆ†å¤§å°å†™        |
| Query                    | `- Query=username` `- Query=username, [a-z]+`                | åŒ¹é… URL æŸ¥è¯¢å‚æ•°  | å­˜åœ¨æŸå‚æ•°ï¼Œæˆ–å€¼ç¬¦åˆæ­£åˆ™              | å‚æ•°å/å€¼å‡æ”¯æŒæ­£åˆ™                                  |
| Host                     | `- Host=*.example.com`                                       | åŒ¹é… Host å¤´       | åŸŸåé€šé…ç¬¦åŒ¹é…                        | ç”¨äºå¤šåŸŸåè·¯ç”±ï¼ˆå¦‚ mobile/api/adminï¼‰                |
| Cookie                   | `- Cookie=username, [a-z0-9]+`                               | åŒ¹é… Cookie        | Cookie åå­˜åœ¨ï¼Œä¸”å€¼ç¬¦åˆæ­£åˆ™           | å®‰å…¨æ€§è¾ƒä½ï¼Œæ…ç”¨äºæ•æ„Ÿé€»è¾‘                           |
| RemoteAddr               | `- RemoteAddr=192.168.1.0/24`                                | åŒ¹é…å®¢æˆ·ç«¯ IP      | CIDR æ ¼å¼ IP æ®µ                       | è‹¥å‰ç½® Nginxï¼Œéœ€ç¡®ä¿ä¼ é€’çœŸå® IPï¼ˆ`X-Forwarded-For`ï¼‰ |
| Before                   | `- Before=2026-06-01T00:00:00+08:00[Asia/Shanghai]`          | åœ¨æŒ‡å®šæ—¶é—´å‰åŒ¹é…   | æ—¶é—´æˆ³ï¼ˆISO 8601ï¼‰                    | ç”¨äºå®šæ—¶å¼€å…³ã€ç°åº¦é¢„çƒ­                               |
| After                    | `- After=2026-02-01T00:00:00+08:00`                          | åœ¨æŒ‡å®šæ—¶é—´ååŒ¹é…   | åŒä¸Š                                  | å¸¸ä¸ `Before` é…åˆåšæ—¶é—´æ®µæ§åˆ¶                       |
| Between                  | `- Between=2026-02-01T00:00:00+08:00, 2026-02-28T23:59:59+08:00` | åœ¨ä¸¤ä¸ªæ—¶é—´ä¹‹é—´åŒ¹é… | èµ·æ­¢æ—¶é—´                              | ç­‰ä»·äº `After && Before`                             |
| Weight                   | `- Weight=group1, 30`                                        | æŒ‰æƒé‡åˆ†é…æµé‡     | æƒé‡å€¼ï¼ˆæ•´æ•°ï¼‰                        | ç”¨äºé‡‘ä¸é›€å‘å¸ƒï¼›åŒ group å†…æŒ‰æ¯”ä¾‹åˆ†æµ                |
| ReadBody                 | ï¼ˆä»… Java é…ç½®ï¼‰                                             | è¯»å–è¯·æ±‚ä½“å†…å®¹åŒ¹é… | è‡ªå®šä¹‰ Body åˆ¤æ–­é€»è¾‘                  | âš ï¸ æ¶ˆè€—è¾“å…¥æµï¼Œå½±å“æ€§èƒ½ï¼›YAML ä¸æ”¯æŒ                  |
| CloudFoundryRouteService | ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰                                                 | CF å¹³å°è·¯ç”±æœåŠ¡    | ç‰¹å®š Header åŒ¹é…                      | ä¸€èˆ¬ä¸ç”¨                                             |

### è¿‡æ»¤å™¨filter

**å¤§è‡´ç±»å‹ï¼š**

 **GatewayFilterï¼ˆå±€éƒ¨è¿‡æ»¤å™¨ï¼‰**

- **ä½œç”¨èŒƒå›´**ï¼šä»…å¯¹**å•ä¸ªè·¯ç”±**ç”Ÿæ•ˆ

- **é…ç½®æ–¹å¼**ï¼šåœ¨ `routes` ä¸‹çš„ `filters` ä¸­å£°æ˜

- ç¤ºä¾‹ï¼š

  ```yml
  routes:
    - id: user-service
      uri: lb://user-service
      predicates:
        - Path=/api/user/**
      filters:
        - StripPrefix=1          # â† å±€éƒ¨è¿‡æ»¤å™¨
        - AddRequestHeader=X-Source, gateway
  ```

 **GlobalFilterï¼ˆå…¨å±€è¿‡æ»¤å™¨ï¼‰**

- **ä½œç”¨èŒƒå›´**ï¼šå¯¹**æ‰€æœ‰è·¯ç”±**ç”Ÿæ•ˆ

- **é…ç½®æ–¹å¼**ï¼šé€šè¿‡ `@Component` æ³¨å†Œ Bean

- ç¤ºä¾‹ï¼š

  ```java
  @Component
  public class AuthGlobalFilter implements GlobalFilter, Ordered {
      @Override
      public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
          // å…¨å±€é‰´æƒé€»è¾‘
      }
      @Override
      public int getOrder() { return -100; }
  }
  ```

> ğŸ”‘ **å…³é”®åŒºåˆ«**ï¼š
>
> - `GatewayFilter` éœ€æ˜¾å¼é…ç½®åˆ°è·¯ç”±
> - `GlobalFilter` è‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰è¯·æ±‚

----

**å…·ä½“ç±»å‹ï¼š**

 **1.è·¯å¾„é‡å†™ç±»**

| è¿‡æ»¤å™¨        | ç¤ºä¾‹                                              | ä½œç”¨                                          |
| :------------ | :------------------------------------------------ | :-------------------------------------------- |
| `StripPrefix` | `- StripPrefix=1`                                 | å»æ‰è·¯å¾„å‰ N æ®µ `/api/user/123` â†’ `/user/123` |
| `RewritePath` | `- RewritePath=/api/(?<segment>.*), /$\{segment}` | æ­£åˆ™é‡å†™è·¯å¾„                                  |

 **2.Header æ“ä½œç±»**

| è¿‡æ»¤å™¨                | ç¤ºä¾‹                                   | ä½œç”¨                     |
| :-------------------- | :------------------------------------- | :----------------------- |
| `AddRequestHeader`    | `- AddRequestHeader=X-Source, gateway` | æ·»åŠ è¯·æ±‚å¤´               |
| `RemoveRequestHeader` | `- RemoveRequestHeader=Secret`         | åˆ é™¤æ•æ„Ÿå¤´               |
| `SetPath`             | `- SetPath=/new/{id}`                  | åŠ¨æ€è®¾ç½®è·¯å¾„ï¼ˆæ”¯æŒå˜é‡ï¼‰ |

 **3.é™æµç±»**

| è¿‡æ»¤å™¨               | ç¤ºä¾‹   | è¯´æ˜                    |
| :------------------- | :----- | :---------------------- |
| `RequestRateLimiter` | è§ä¸‹æ–‡ | åŸºäº Redis çš„ä»¤ç‰Œæ¡¶é™æµ |

 **é™æµé…ç½®ç¤ºä¾‹ï¼š**

```yml
filters:
  - name: RequestRateLimiter
    args:
      redis-rate-limiter.replenishRate: 10    # æ¯ç§’ç”Ÿæˆ 10 ä¸ªä»¤ç‰Œ
      redis-rate-limiter.burstCapacity: 20    # æ¡¶å®¹é‡ 20
      key-resolver: "#{@userKeyResolver}"     # æŒ‰ç”¨æˆ·é™æµ
```

```java
@Bean
public KeyResolver userKeyResolver() {
    return exchange -> 
        Mono.just(exchange.getRequest().getHeaders().getFirst("X-User-ID"));
}
```

 **4.ç†”æ–­ç±»**

| è¿‡æ»¤å™¨           | ç¤ºä¾‹                                                         | ä½œç”¨                                           |
| :--------------- | :----------------------------------------------------------- | :--------------------------------------------- |
| `CircuitBreaker` | `- name: CircuitBreaker` `  args:` `    name: orderServiceCB` `    fallbackUri: forward:/fallback/order` | é›†æˆ Resilience4j/Sentinelï¼Œå¤±è´¥æ—¶è·³è½¬å…œåº•æ¥å£ |

 **5.å…¶ä»–å®ç”¨è¿‡æ»¤å™¨**

| è¿‡æ»¤å™¨                 | ä½œç”¨                                            |
| :--------------------- | :---------------------------------------------- |
| `PreserveHostHeader`   | ä¿ç•™åŸå§‹ Host å¤´ï¼ˆé»˜è®¤ä¼šè¢«æ›¿æ¢ä¸ºç›®æ ‡æœåŠ¡ Hostï¼‰ |
| `Retry`                | è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚ï¼ˆå¯é…ç½®æ¬¡æ•°ã€å¼‚å¸¸ç±»å‹ï¼‰        |
| `DedupeResponseHeader` | å»é™¤é‡å¤å“åº”å¤´ï¼ˆå¦‚å¤šä¸ªæœåŠ¡éƒ½åŠ äº† CORS å¤´ï¼‰      |



## ç½‘ç»œç™»å½•æ ¡éªŒ

### Gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹

```
Client
   â†“
[HttpServer] (Netty)
   â†“
[Gateway Handler Mapping] â†’ è·¯ç”±æ˜ å°„ï¼ŒåŒ¹é… Routeï¼ˆæ–­è¨€ï¼‰ï¼Œå¹¶é€šè¿‡WebHandlerå°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„è·¯ç”±è¿‡æ»¤å™¨ç»„
   â†“
[Filter Chain]
   â”œâ”€â”€ GlobalFilter 1 (pre)
   â”œâ”€â”€ GlobalFilter 2 (pre)
   â”œâ”€â”€ RouteFilter A (pre)
   â”œâ”€â”€ RouteFilter B (pre)
   â†“
[Proxy Request to Target Service]  â† NettyRoutingFilterï¼ˆæ ¸å¿ƒè½¬å‘å™¨ï¼Œå°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„å¾®æœåŠ¡å®ä¾‹ï¼‰
   â†“
   â”œâ”€â”€ RouteFilter A (post)
   â”œâ”€â”€ RouteFilter A (post)
   â”œâ”€â”€ GlobalFilter 2 (post)
   â””â”€â”€ GlobalFilter 1 (post)
   â†“
[Write Response to Client]
```

Requestæ‰“åˆ°ç½‘å…³åæ ¹æ®**æ–­è¨€**åˆ†é…åˆ°æŒ‡å®šçš„**è¿‡æ»¤å™¨ç»„**ï¼Œå®Œæˆè¿‡æ»¤å™¨ä¸­çš„**pre**æ“ä½œåï¼Œäº¤ç»™NettyRoutingFilteræ ¹æ®Nacosè·å–åˆ°çš„å¾®æœåŠ¡å®ä¾‹é€šè¿‡loadBalanceè´Ÿè½½å‡è¡¡åˆ°å‡ ä¸ªå®ä¾‹ä¸­ï¼Œ**å“åº”ç»“æœä¼ å›ç½‘å…³**ï¼Œå®Œæˆè¿‡æ»¤å™¨çš„**post**æ“ä½œï¼Œåœ¨ä¼ å›nginx/å‰ç«¯ã€‚

æˆ‘ä»¬å¦‚æœéœ€è¦**éªŒè¯ç”¨æˆ·ä¿¡æ¯**ï¼Œå°±éœ€è¦åœ¨Gatewayçš„**è¿‡æ»¤å™¨ç»„**ä¸­å®‰æ’ä¸€ä¸ªè¿‡æ»¤å™¨çš„**pre**éƒ¨åˆ†å®ŒæˆéªŒè¯æ“ä½œã€‚



### è‡ªå®šä¹‰GlobalFilter

å…¨å±€è¿‡æ»¤ï¼Œ**æ‰€æœ‰è·¯ç”±éƒ½ä¼šè¢«å¤„ç†**ï¼Œå£°æ˜åè‡ªåŠ¨ç”Ÿæ•ˆï¼Œåªéœ€å®ç°`GlobalFilter`å³å¯ï¼š

```java
@Component		// @Componentå£°æ˜å¹¶å®ç°GlobalFilterå³æ³¨å†Œå®Œæˆå…¨å±€è¿‡æ»¤å™¨
public class MyGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // è·å–è¯·æ±‚å¤´
        ServerHttpRequest request = exchange.getRequest();
        HttpHeaders headers = request.getHeaders();
        System.out.println(headers);
        // æ”¾è¡Œ
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        // è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
        return 0;
    }
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ä¼ ç»™è¿‡æ»¤å™¨çš„**è¯·æ±‚ä¸Šä¸‹æ–‡ServerWebExchange**æ‹¿åˆ°äº†è¯·æ±‚ServerHttpRequestï¼Œç„¶åå®Œæˆç›¸å…³æ“ä½œåå°±å¯ä»¥`return chain.filter(exchange);`äº¤ç»™ä¸‹ä¸€ä½è¿‡æ»¤å™¨äº†ã€‚



### è‡ªå®šä¹‰GatewayFilter

åªåœ¨è·¯ç”±é…ç½®ä¸­å£°æ˜æ—¶ä½œç”¨äºè¯¥è·¯ç”±ï¼Œ**éœ€è¦åœ¨è·¯ç”±ä¸­å£°æ˜**ã€‚

ç»§æ‰¿`AbstractGatewayFilterFactory<Config>`åé‡å†™`apply`æ–¹æ³•ï¼šreturnä¸€ä¸ªé‡å†™äº†`filter`æ–¹æ³•çš„è¿‡æ»¤å™¨ã€‚

æœ€ååœ¨ymlä¸­é…ç½®å¥½å¯¹åº”çš„è·¯ç”±routeå³å¯ã€‚

```Java
@Component
public class PrintAnyGatewayFilterFactory // çˆ¶ç±»æ³›å‹æ˜¯å†…éƒ¨ç±»çš„Configç±»å‹ï¼Œæ³¨æ„åç¼€å¿…é¡»æ˜¯GatewayFilterFactory
                extends AbstractGatewayFilterFactory<PrintAnyGatewayFilterFactory.Config> {

    @Override
    public GatewayFilter apply(Config config) {
        // OrderedGatewayFilteræ˜¯GatewayFilterçš„å­ç±»ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š
        // - GatewayFilterï¼šè¿‡æ»¤å™¨
        // - int orderå€¼ï¼šå€¼è¶Šå°ï¼Œè¿‡æ»¤å™¨æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜
        return new OrderedGatewayFilter(new GatewayFilter() {
            @Override
            public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
                // è·å–configå€¼
                String a = config.getA();
                String b = config.getB();
                String c = config.getC();
                // ç¼–å†™è¿‡æ»¤å™¨é€»è¾‘
                System.out.println("a = " + a);
                System.out.println("b = " + b);
                System.out.println("c = " + c);
                // æ”¾è¡Œ
                return chain.filter(exchange);
            }
        }, 100); // ä¼˜å…ˆçº§
    }

    // è‡ªå®šä¹‰é…ç½®å±æ€§ï¼Œæˆå‘˜å˜é‡åç§°å¾ˆé‡è¦ï¼Œä¸‹é¢ä¼šç”¨åˆ°
    @Data
    static class Config{
        private String a;
        private String b;
        private String c;
    }
    // å°†å˜é‡åç§°ä¾æ¬¡è¿”å›ï¼Œé¡ºåºå¾ˆé‡è¦ï¼Œå°†æ¥è¯»å–å‚æ•°æ—¶éœ€è¦æŒ‰é¡ºåºè·å–
    @Override
    public List<String> shortcutFieldOrder() {
        return List.of("a", "b", "c");
    }
    // è¿”å›å½“å‰é…ç½®ç±»çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨çš„Config
    @Override
    public Class<Config> getConfigClass() {
        return Config.class;
    }

}
```

> **æ³¨æ„**ï¼šè¯¥ç±»çš„åç§°ä¸€å®šè¦ä»¥`GatewayFilterFactory`ä¸ºåç¼€ï¼

ç„¶åå°±å¯ä»¥æ³¨å†Œåˆ°ymlä¸­äº†ï¼š

```YAML
spring:
  cloud:
    gateway:
      default-filters:
            - PrintAny=1,2,3 # æ³¨æ„ï¼Œè¿™é‡Œå¤šä¸ªå‚æ•°ä»¥","éš”å¼€ï¼Œå°†æ¥ä¼šæŒ‰ç…§shortcutFieldOrder()æ–¹æ³•è¿”å›çš„å‚æ•°é¡ºåºä¾æ¬¡å¤åˆ¶
```

å½“ç„¶æŒ‡æ˜äº†å‚æ•°å­—æ®µåä¹‹åï¼Œå‚æ•°å¯ä»¥ç›´æ¥ä¸€å¯¹ä¸€èµ‹å€¼ï¼š

```YAML
spring:
  cloud:
    gateway:
      default-filters:
            - name: PrintAny
              args: # æ‰‹åŠ¨æŒ‡å®šå‚æ•°åï¼Œæ— éœ€æŒ‰ç…§å‚æ•°é¡ºåº
                a: 1
                b: 2
                c: 3
```



### å®ç°ç™»å½•æ ¡éªŒ

ä¸€èˆ¬ç›´æ¥ä½¿ç”¨`GlobalFilter`å³å¯ï¼Œåé¢å†excludeæ‰ä¸€äº›ä¸éœ€è¦çš„uriè·¯å¾„å°±è¡Œï¼š

```java
@Component
@RequiredArgsConstructor
public class AuthGlobalFilter implements GlobalFilter, Ordered {

    // è®°å½•ä¸éœ€è¦éªŒè¯çš„uriè·¯å¾„
    private final AuthProperties authProperties;

    // jwtç§˜é’¥ç”Ÿæˆä»¥åŠè§£æå™¨
    private final JwtTool jwtTool;

    private final AntPathMatcher antPathMatcher = new AntPathMatcher();

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿‡æ»¤
        if (isExcludePath(request.getURI().getPath())) {
            // ä¸éœ€è¦è¿‡æ»¤
            return chain.filter(exchange);
        }
        // å–å‡ºè¯·æ±‚å¤´
        HttpHeaders headers = request.getHeaders();
        // è·å–
        String token = headers.getFirst("Authorization");
        if (token == null) {
            // ä¸å­˜åœ¨
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        // è§£æ
        Long userId = null;
        try {
            userId = jwtTool.parseToken(token);
        }catch (UnauthorizedException e){
            // è§£æå¤±è´¥ï¼Œæ‹¦æˆª
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        return chain.filter(exchange);
    }

    /**
     * åˆ¤æ–­æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­
     * @param path è¯·æ±‚è·¯å¾„
     * @return æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­
     */
    private boolean isExcludePath(String path) {
        for (String excludePath : authProperties.getExcludePaths()){
            if (antPathMatcher.match(excludePath, path)){
                return true;
            }
        }
        return false;
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

å®Œæˆäº†ç”¨æˆ·ä¿¡æ¯çš„éªŒè¯åï¼Œæˆ‘ä»¬éœ€è¦å°†è§£æå‡ºæ¥çš„ä¿¡æ¯**ä¼ ç»™åç»­çš„å¾®æœåŠ¡**ï¼Œå¯ä»¥è€ƒè™‘å°†æ•°æ®å­˜å‚¨åˆ°Requestçš„headerä¸­ï¼Œåœ¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡`ServerWebExchange`ä¸­è°ƒç”¨`mutate()`æ–¹æ³•ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ï¼Œå…¶çš„è¯·æ±‚å¤´åŒ…å«ç”¨æˆ·æ•°æ®ï¼Œå°†è¿™ä¸ªä¸Šä¸‹æ–‡ä¼ ç»™è¿‡æ»¤å™¨é“¾ï¼Œä½¿å¾—ä¸‹æ¸¸è¿‡æ»¤å™¨ä»¥åŠå¾®æœåŠ¡æ”¶åˆ°çš„è¯·æ±‚headerå«æ‰€ä¼ æ•°æ®ã€‚

> mutate() æ˜¯ Reactor æ¡†æ¶ä¸­ ServerWebExchange æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºæ„å»ºä¸€ä¸ªæ–°çš„ ServerWebExchange å®ä¾‹ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹å¯¹è±¡çš„çŠ¶æ€ã€‚

```java
// æ·»åŠ ç”¨æˆ·ä¿¡æ¯
String userInfo = userId.toString();
ServerWebExchange user = exchange.mutate().request(builder -> {
    builder.header("userInfo", userInfo);
}).build();

return chain.filter(user);
```

ç°åœ¨åç»­çš„è¯·æ±‚å¤´å°±åŒ…å«äº†ç”¨æˆ·æ•°æ®äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å®Œæˆå°†ç”¨æˆ·æ•°æ®å­˜è‡³`Threadlocal`æ–¹ä¾¿åœ¨ä¸šåŠ¡ä¸­è·å–ï¼Œä¸€èˆ¬è°ˆåˆ°å­˜å‚¨è¯·æ±‚å¤´æ•°æ®åˆ°tlä¸­å°±æ˜¯ç”¨mvcçš„**æ‹¦æˆªå™¨**äº†ï¼ˆaopä¹Ÿå¯ä»¥ï¼‰ï¼Œç”±äº**åŸºæœ¬æ‰€æœ‰å¾®æœåŠ¡éƒ½éœ€è¦å°†è¯·æ±‚å¤´ä¸­çš„æ•°æ®å­˜åˆ°tlä¸­**ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ª**å…¬å…±æ¨¡å—**ä¸­å®Œæˆå¯¹æ‹¦æˆªå™¨çš„ç¼–å†™å¹¶æ³¨å…¥åˆ°é…ç½®ä¸­ï¼š

```java
public class UserInfoInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String userInfo = request.getHeader("userInfo");
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¾å…¥çº¿ç¨‹å˜é‡
        if (StrUtil.isNotBlank(userInfo)){
            UserContext.setUser(Long.valueOf(userInfo));
        }
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        UserContext.removeUser();
    }
}
```

å®Œæˆæ‹¦æˆªå™¨çš„ç¼–å†™åï¼Œæˆ‘ä»¬å°†ä¹‹æ³¨å†Œåˆ°mvcconfigä¸­ï¼š

```java
@Configuration
@ConditionalOnClass(DispatcherServlet.class)
public class MvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new UserInfoInterceptor());
    }
}
```

**è¿™é‡Œéœ€è¦æ³¨æ„ï¼š**

1. æˆ‘ä»¬æ˜¯åœ¨**commonæ¨¡å—**ä¸­ç¼–å†™çš„`@Configuration`æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ**å…¶ä»–æ¨¡å—æ˜¯ä¸ä¼šæ‰«æè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„`@Component`æ–‡ä»¶çš„**ï¼

é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åšä¸€äº›é¢å¤–é…ç½®ï¼šæˆ‘ä»¬å¯ä»¥åœ¨commonæ¨¡å—çš„resourcesæ–‡ä»¶å¤¹ä¸‹çš„META-INFæ–‡ä»¶å¤¹å†…ç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶`spring.factories`ä»¥å®ç°SpringBootçš„è‡ªåŠ¨è£…é…ï¼š

```properties
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.hmall.common.config.MyBatisConfig,\
  com.hmall.common.config.JsonConfig,\
  com.hmall.common.config.MvcConfig
```

> `spring.factories`æ–‡ä»¶æ˜¯ Spring Boot ä¸­ç”¨äºè‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å‘Šè¯‰ Spring Boot åœ¨å¯åŠ¨æ—¶éœ€è¦åŠ è½½å“ªäº›è‡ªåŠ¨é…ç½®ç±»ã€‚
>
> - é€šå¸¸ä½äº META-INF/spring.factories è·¯å¾„ä¸‹ã€‚
> - Spring Boot å¯åŠ¨æ—¶ä¼šæ‰«æ**æ‰€æœ‰ä¾èµ–**ä¸­çš„ spring.factories æ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­å®šä¹‰çš„é…ç½®ç±»ã€‚
>
> org.springframework.boot.autoconfigure.EnableAutoConfiguration æ˜¯ Spring Boot è‡ªåŠ¨é…ç½®çš„å…¥å£é”®ã€‚
> åé¢åˆ—å‡ºçš„ç±»ï¼ˆå¦‚ MyBatisConfigã€JsonConfigã€MvcConfigï¼‰æ˜¯è‡ªå®šä¹‰çš„é…ç½®ç±»ï¼ŒSpring Boot ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½è¿™äº›ç±»ã€‚
> é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¼€å‘è€…å¯ä»¥å°†è‡ªå·±çš„é…ç½®ç±»æ³¨å†Œåˆ° Spring Boot çš„è‡ªåŠ¨é…ç½®æµç¨‹ä¸­ã€‚
> æ— éœ€æ‰‹åŠ¨åœ¨ä¸»ç±»ä¸Šä½¿ç”¨ @Import æˆ– @ComponentScan æ³¨è§£ï¼ŒSpring Boot ä¼šè‡ªåŠ¨å‘ç°å¹¶åº”ç”¨è¿™äº›é…ç½®ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬çš„configæ–‡ä»¶å°±æˆåŠŸé…ç½®åˆ°äº†æ‰€æœ‰å¾®æœåŠ¡æ¨¡å—ä¸­ã€‚

----

2. Gatewayæ¨¡å—ä¹Ÿå¼•å…¥äº†commonæ¨¡å—ï¼Œä½†ä»–æ˜¯åŸºäº**webflux**çš„ï¼Œ**æ²¡æœ‰webmvcå¯¼è‡´å¼•å…¥mvcConfigä¼šæŠ¥é”™**ï¼

é‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±ä¸å¸Œæœ›Gatewayæ¨¡å—åº”ç”¨mvcConfigé…ç½®äº†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦é’ˆå¯¹Gatewayæ¨¡å—å¯¹MvcConfigåšä¸€äº›é¢å¤–é…ç½®ï¼š

```java
@ConditionalOnClass(DispatcherServlet.class)
```

> `@ConditionalOnClass(DispatcherServlet.class)` æ˜¯ Spring Boot æä¾›çš„ä¸€ä¸ªæ¡ä»¶æ³¨è§£ï¼Œç”¨äºæ§åˆ¶é…ç½®ç±»æˆ– Bean çš„åŠ è½½æ¡ä»¶ã€‚å…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š
>
> æ¡ä»¶åˆ¤æ–­ï¼šåªæœ‰å½“ DispatcherServlet ç±»å­˜åœ¨äºå½“å‰é¡¹ç›®çš„ classpath ä¸­æ—¶ï¼Œè¢«è¯¥æ³¨è§£æ ‡è®°çš„é…ç½®ç±»ï¼ˆå¦‚ MvcConfigï¼‰æ‰ä¼šç”Ÿæ•ˆã€‚
> é¿å…é”™è¯¯ï¼šå¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰å¼•å…¥ Web ç›¸å…³ä¾èµ–ï¼ˆä¾‹å¦‚ spring-webmvcï¼‰ï¼Œåˆ™ DispatcherServlet ç±»ä¸ä¼šå­˜åœ¨ï¼Œæ­¤æ—¶ MvcConfig ä¸ä¼šè¢«åŠ è½½ï¼Œä»è€Œé¿å…å› ç¼ºå°‘ä¾èµ–å¯¼è‡´çš„å¯åŠ¨å¤±è´¥ã€‚

ä½†æ˜¯æˆ‘ä»¬è¯´Gatewayä¹Ÿå¼•å…¥äº†commonæ¨¡å—ï¼Œcommonæ¨¡å—è¦é…ç½®mvcé‚£è‚¯å®šæ˜¯å¸¦ä¸Šäº†mvcçš„ä¾èµ–çš„ï¼Œä¸ºä»€ä¹ˆè¯´Gatewayæ²¡æœ‰mvcçš„ä¾èµ–å‘¢ï¼Ÿ**å› ä¸ºcommonæ¨¡å—ä¸­çš„ä¾èµ–ä¸€èˆ¬éƒ½æ˜¯ä»…ç¼–è¯‘æ—¶å¼•å…¥ï¼ˆå†™ä»£ç ä¸æŠ¥é”™ï¼‰ï¼Œè¿è¡Œä¸å¼•å…¥çš„ï¼ˆå…¶ä»–æ¨¡å—éœ€è¦è‡ªè¡Œå¼•å…¥ç›¸å…³ä¾èµ–ï¼‰ï¼š**

```xml
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-webmvc</artifactId>
    <scope>provided</scope>
</dependency>
```

> `<scope>provided</scope>`ï¼šprovidedä½œç”¨åŸŸè¡¨ç¤ºä»…åœ¨ç¼–è¯‘æ—¶å¼•å…¥

è€ŒGatewayæ²¡æœ‰æ˜¾å¼å¼•å…¥mvcä¾èµ–ï¼Œé‚£ä¹ˆå…¶å®è¿è¡Œèµ·æ¥çš„æ—¶å€™æ˜¯æ²¡æœ‰mvcä¾èµ–çš„ï¼Œä¹Ÿå°±ä¸ä¼šé…ç½®mvcConfigäº†ã€‚



### Openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯

æˆ‘ä»¬å…ˆå‰å®Œæˆäº†å°†å‰ç«¯å‘æ¥çš„jwtåœ¨Gatewayè¿›è¡Œè§£æå¹¶å­˜å…¥è¯·æ±‚å¤´ï¼Œç„¶åå†åœ¨å¾®æœåŠ¡ä¸­å°†è¯·æ±‚å¤´ä¸­çš„è§£æå®Œæˆçš„æ•°æ®è£…é…åˆ°Threadlocalä¸­ã€‚ä½†æ˜¯è¿™åªæ˜¯Gatewayåˆ°å¾®æœåŠ¡çš„httpè¯·æ±‚å¤´ä¼šå¸¦ä¸Šç”¨æˆ·æ•°æ®ï¼Œå¾®æœåŠ¡ä¹‹é—´è¿˜ä¼šè¿›è¡ŒOpenfeignç›¸äº’è°ƒç”¨ï¼Œè¿™æ—¶å€™å¦‚æœä¸åšé¢å¤–é…ç½®ï¼ŒOpenfeignå‘é€çš„httpè¯·æ±‚å¤´æ˜¯ä¸ä¼šå¸¦ä¸Šéœ€è¦çš„ç”¨æˆ·ä¿¡æ¯çš„ã€‚

Openfeignå…¶å®å°±æä¾›äº†ä¸€ä¸ªæ‹¦æˆªå™¨æ¥å£`RequestInterceptor`ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆè¯·æ±‚å¤´ç­‰ä¿¡æ¯çš„å¤„ç†ï¼š

é¦–å…ˆåœ¨å…¬å…±Openfeign-apiæ¨¡å—ä¸­åŠ å…¥æ–°é…ç½®ï¼š

```java
public class DefaultFeignClient {
    @Bean
    public RequestInterceptor requestInterceptor() {
        return new RequestInterceptor() {
            @Override
            public void apply(RequestTemplate requestTemplate) {
                Long userId = UserContext.getUser();
                if (userId != null) {
                    requestTemplate.header("userInfo", userId.toString());
                }
            }
        };
    }
}
```

ç„¶ååœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š

```java
@MapperScan(basePackages = "com.hmall.item.mapper")
@SpringBootApplication
@EnableFeignClients(basePackages = "com.hmall.api.client", defaultConfiguration = DefaultFeignClient.class)
public class ItemServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }

}
```

é‚£ä¹ˆè¿™ä¸ªå¾®æœåŠ¡å®ä¾‹çš„ä¸šåŠ¡å¤„ç†çº¿ç¨‹å°±ä¼šåœ¨Openfeignå‘é€RPCè¯·æ±‚æ—¶**å°†Threadlocalä¸­çš„ç”¨æˆ·æ•°æ®å†™å…¥è¯·æ±‚å¤´**ï¼Œç„¶åå…¶ä»–å¾®æœåŠ¡å®ä¾‹çš„çº¿ç¨‹åœ¨å¤„ç†è¿™æ ·çš„httpè¯·æ±‚æ—¶ä¼š**ä½¿ç”¨æ‹¦æˆªå™¨å¯¹è¿™ä¸ªè¯·æ±‚è¿›è¡Œæˆªå–**ï¼Œ**å°†è¯·æ±‚å¤´ä¸­çš„æ•°æ®æ‹¿å‡ºå¹¶å†™å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†çº¿ç¨‹çš„Threadlocalä¸­**ã€‚












## EXï¼šJWTéªŒè¯

**ç”¨æˆ·ç™»å½• â†’ åç«¯ç”Ÿæˆä¸€ä¸ªåŠ å¯†å­—ç¬¦ä¸²ï¼ˆJWTï¼‰â†’ å‰ç«¯ä¿å­˜ â†’ æ¯æ¬¡è¯·æ±‚å¸¦ä¸Šå®ƒ â†’ åç«¯è§£å¯†éªŒè¯ â†’ çŸ¥é“æ˜¯è°åœ¨è®¿é—®**

å…¨ç¨‹**ä¸å­˜ Session**ï¼ˆä¸å­˜Redisï¼‰ï¼Œæ— çŠ¶æ€ï¼

| ç±»å                           | èŒè´£ï¼ˆä¸€å¥è¯è¯´æ¸…ï¼‰                                           |
| :----------------------------- | :----------------------------------------------------------- |
| **`JwtUtil`**                  | **JWT å·¥å…·ç®±**ï¼š â€¢ ç”Ÿæˆ Token â€¢ è§£æç”¨æˆ·å â€¢ éªŒè¯æ˜¯å¦è¿‡æœŸ/è¢«ç¯¡æ”¹ |
| **`CustomUserDetailsService`** | **ç”¨æˆ·åŠ è½½å™¨**ï¼š ä»æ•°æ®åº“æŸ¥ç”¨æˆ·ï¼ˆç”¨äºç™»å½•æ ¡éªŒ & Token éªŒè¯æ—¶æ¯”å¯¹ï¼‰ |
| **`AuthController`**           | **ç™»å½•å…¥å£**ï¼š æ¥æ”¶è´¦å·å¯†ç  â†’ è°ƒ Security æ ¡éªŒ â†’ æˆåŠŸå°±è°ƒ `JwtUtil` ç”Ÿæˆ Token è¿”å› |
| **`JwtRequestFilter`**         | **å®ˆé—¨å‘˜ï¼ˆå…³é”®ï¼ï¼‰**ï¼š æ¯ä¸ªè¯·æ±‚è¿›æ¥å…ˆçœ‹æœ‰æ²¡æœ‰ Token â†’ æœ‰å°±è§£æ â†’ éªŒè¯åˆæ³• â†’ æŠŠç”¨æˆ·èº«ä»½å¡è¿› Spring Security ä¸Šä¸‹æ–‡ |
| **`SecurityConfig`**           | **å®‰å…¨æ€»å¼€å…³**ï¼š â€¢ å…³æ‰ Sessionï¼ˆè®¾ä¸º STATELESSï¼‰ â€¢ æ”¾è¡Œ `/login` â€¢ æ³¨å†Œ `JwtRequestFilter` åˆ°è¿‡æ»¤å™¨é“¾ |

**å•ä½“é¡¹ç›®ä¸‹**æˆ‘ä»¬å°±åªéœ€è¦åœ¨æ‹¦æˆªå™¨ä¸­å®Œæˆjwtçš„è§£æå³å¯ã€‚

**å¾®æœåŠ¡ä¸­**æˆ‘ä»¬éœ€è¦åœ¨ç½‘å…³å®Œæˆç›¸åº”çš„æ“ä½œï¼š



## EXï¼šSpringä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®

 **å‰æï¼šé…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆYAMLï¼‰**

```yml
# application.yml
app:
  name: MySpringBootApp
  version: 1.0.0
  debug-mode: true
  timeout-ms: 5000

database:
  url: jdbc:mysql://localhost:3306/mydb
  username: root
  password: secret
  pool:
    max-active: 20
    min-idle: 5
```

------

### **æ–¹æ³•ä¸€ï¼šä½¿ç”¨** `@Value` **æ³¨è§£ï¼ˆç®€å•å±æ€§ï¼‰**

é€‚ç”¨äºè¯»å–**å•ä¸ªé…ç½®é¡¹**ã€‚

```java
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class AppConfig {

    @Value("${app.name}")
    private String appName;

    @Value("${app.timeout-ms}")
    private int timeoutMs;

    @Value("${database.url}")
    private String dbUrl;

    // æ³¨æ„ï¼šYAML ä¸­çš„è¿å­—ç¬¦ï¼ˆ-ï¼‰åœ¨ @Value ä¸­éœ€ç”¨åŸæ ·å†™
    @Value("${app.debug-mode}")
    private boolean debugMode;

    // getter...
}
```

> âš ï¸ æ³¨æ„ï¼š
>
> - å¦‚æœé…ç½®ä¸å­˜åœ¨ï¼Œå¯åŠ¨ä¼šæŠ¥é”™ï¼ˆé™¤éè®¾ç½®é»˜è®¤å€¼ï¼‰
> - é»˜è®¤å€¼å†™æ³•ï¼š`@Value("${app.name:DefaultName}")`

------

### **æ–¹æ³•äºŒï¼šä½¿ç”¨** `@ConfigurationProperties`**ï¼ˆæ¨èï¼å¯¹è±¡ç»‘å®šï¼‰**

é€‚ç”¨äº**ç»“æ„åŒ–é…ç½®**ï¼ˆå¦‚æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ï¼‰ï¼Œ**ç±»å‹å®‰å…¨ã€æ”¯æŒæ ¡éªŒã€å¯å¤ç”¨**ã€‚

#### **æ­¥éª¤ 1ï¼šåˆ›å»ºé…ç½®ç±»**

```java
@Component
@ConfigurationProperties(prefix = "database") // å¯¹åº” yml ä¸­çš„ database:
public class DatabaseProperties {

    @NotEmpty
    private String url;
    
    @NotEmpty
    private String username;
    
    private String password;

    private Pool pool = new Pool();

    // nested class for pool config
    public static class Pool {
        @Min(1)
        private int maxActive = 10;
        
        @Min(0)
        private int minIdle = 1;

        // getters & setters
        public int getMaxActive() { return maxActive; }
        public void setMaxActive(int maxActive) { this.maxActive = maxActive; }
        public int getMinIdle() { return minIdle; }
        public void setMinIdle(int minIdle) { this.minIdle = minIdle; }
    }

    // getters & setters for top-level fields
    public String getUrl() { return url; }
    public void setUrl(String url) { this.url = url; }
    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }
    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }
    public Pool getPool() { return pool; }
    public void setPool(Pool pool) { this.pool = pool; }
}
```

> æˆ–ä½¿ç”¨lombokçš„`@Data`

#### **æ­¥éª¤ 2ï¼šå¯ç”¨ ConfigurationPropertiesï¼ˆSpring Boot 2.2+ å¯çœç•¥ï¼‰**

> ä» Spring Boot 2.2 å¼€å§‹ï¼Œåªè¦ç±»ä¸Šæœ‰ `@Component`ï¼Œå°±è‡ªåŠ¨ç”Ÿæ•ˆã€‚
> å¦‚æœä½ ç”¨çš„æ˜¯è€ç‰ˆæœ¬ï¼Œæˆ–æƒ³é›†ä¸­ç®¡ç†ï¼Œå¯åœ¨ä¸»ç±»åŠ ï¼š
>
> ```java
> @EnableConfigurationProperties(DatabaseProperties.class)
> ```

#### **æ­¥éª¤ 3ï¼šä½¿ç”¨**

```java
@Service
public class UserService {
    
    // æ„é€ å™¨æ³¨å…¥ï¼Œå¯ä½¿ç”¨
    private final DatabaseProperties dbProps;

    public UserService(DatabaseProperties dbProps) {
        this.dbProps = dbProps;
    }

    public void connect() {
        System.out.println("Connecting to: " + dbProps.getUrl());
        System.out.println("Max active: " + dbProps.getPool().getMaxActive());
    }
}
```

> âœ… ä¼˜ç‚¹ï¼š
>
> - è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆString â†’ int, boolean ç­‰ï¼‰
> - æ”¯æŒåµŒå¥—å¯¹è±¡ï¼ˆå¦‚ `pool.max-active`ï¼‰
> - æ”¯æŒ JSR-303 æ ¡éªŒï¼ˆéœ€å¼•å…¥ `spring-boot-starter-validation`ï¼‰
> - IDE æ”¯æŒï¼ˆå¦‚ IntelliJ èƒ½è‡ªåŠ¨æç¤ºé…ç½®ï¼‰

------

### **æ–¹æ³•ä¸‰ï¼šä½¿ç”¨** `@PropertySource`**ï¼ˆåŠ è½½è‡ªå®šä¹‰ YAML æ–‡ä»¶ï¼‰**

é»˜è®¤ Spring Boot åªåŠ è½½ `application.yml`ã€‚å¦‚æœä½ æƒ³åŠ è½½é¢å¤–çš„é…ç½®æ–‡ä»¶ï¼š

```
@Configuration
@PropertySource("classpath:custom-config.yml")
// âŒ æ³¨æ„ï¼š@PropertySource é»˜è®¤ä¸æ”¯æŒ YAMLï¼
```

> âš ï¸ é—®é¢˜ï¼š`@PropertySource` **åŸç”Ÿåªæ”¯æŒ `.properties`**ï¼Œä¸æ”¯æŒ YAMLï¼

 **è§£å†³æ–¹æ¡ˆï¼šæ”¹ç”¨** `.properties`**ï¼Œæˆ–é€šè¿‡** `Environment` **æ‰‹åŠ¨åŠ è½½ï¼ˆä¸æ¨èï¼‰**

âœ… **æ¨èåšæ³•**ï¼šæŠŠæ‰€æœ‰é…ç½®æ”¾åœ¨ `application.yml`ï¼Œæˆ–ä½¿ç”¨ **Profile å¤šç¯å¢ƒé…ç½®**ï¼ˆå¦‚ `application-dev.yml`ï¼‰ã€‚

------

### **æ–¹æ³•å››ï¼šé€šè¿‡** `Environment` **æ¥å£ï¼ˆåŠ¨æ€è·å–ï¼‰**

é€‚ç”¨äºå·¥å…·ç±»æˆ–æ— æ³•æ³¨å…¥çš„åœºæ™¯ã€‚

```java
@Component
public class ConfigUtil {

    private final Environment env;

    public ConfigUtil(Environment env) {
        this.env = env;
    }

    public String getAppName() {
        return env.getProperty("app.name", "DefaultApp"); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤å€¼
    }

    public Integer getTimeout() {
        return env.getProperty("app.timeout-ms", Integer.class, 3000);
    }
}
```

> âœ… ä¼˜ç‚¹ï¼šçµæ´»ï¼Œæ”¯æŒé»˜è®¤å€¼å’Œç±»å‹è½¬æ¢
> âŒ ç¼ºç‚¹ï¼šæ²¡æœ‰ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå®¹æ˜“æ‹¼é”™ key

| åœºæ™¯                                              | æ¨èæ–¹å¼                                |
| :------------------------------------------------ | :-------------------------------------- |
| è¯»å– 1~2 ä¸ªç®€å•é…ç½®                               | `@Value`                                |
| è¯»å–ä¸€ç»„ç»“æ„åŒ–é…ç½®ï¼ˆå¦‚æ•°æ®åº“ã€Redisã€ç¬¬ä¸‰æ–¹ APIï¼‰ | `@ConfigurationProperties` âœ…ï¼ˆé¦–é€‰ï¼‰    |
| åŠ¨æ€è·å– or å·¥å…·ç±»                                | `Environment`                           |
| åŠ è½½é application çš„é…ç½®æ–‡ä»¶                     | åˆå¹¶åˆ° `application.yml` æˆ–ä½¿ç”¨ Profile |
