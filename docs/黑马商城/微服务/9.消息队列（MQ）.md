---
title: æ¶ˆæ¯é˜Ÿåˆ—
date: 2026-2-11
---

**æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆMessage Queueï¼Œç®€ç§° MQï¼‰æ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¹¿æ³›ä½¿ç”¨çš„ä¸­é—´ä»¶æŠ€æœ¯ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯**è§£è€¦ã€å¼‚æ­¥å¤„ç†å’Œå‰Šå³°å¡«è°·**ã€‚ä»¥ä¸‹æ˜¯éœ€è¦æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»è¦åŸå› ï¼š

| **ä½œç”¨**                | **è¯´æ˜**                                                     | **å…¸å‹åº”ç”¨åœºæ™¯**                          |
| :---------------------- | :----------------------------------------------------------- | :---------------------------------------- |
| **ç³»ç»Ÿè§£è€¦**            | ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…æ— éœ€ç›´æ¥é€šä¿¡ï¼Œé™ä½æœåŠ¡é—´ä¾èµ–                   | è®¢å•æœåŠ¡ â†’ åº“å­˜ã€ç‰©æµã€é€šçŸ¥ç­‰å¤šä¸ªä¸‹æ¸¸æœåŠ¡ |
| **å¼‚æ­¥å¤„ç†**            | å°†è€—æ—¶æ“ä½œè½¬ä¸ºåå°ä»»åŠ¡ï¼Œæå‡å“åº”é€Ÿåº¦å’Œååé‡                 | ç”¨æˆ·æ³¨å†Œåå¼‚æ­¥å‘é€é‚®ä»¶ã€åˆå§‹åŒ–æ•°æ®        |
| **æµé‡å‰Šå³°ï¼ˆç¼“å†²ï¼‰**    | é«˜å¹¶å‘è¯·æ±‚æš‚å­˜äºé˜Ÿåˆ—ï¼Œåç«¯æŒ‰èƒ½åŠ›æ¶ˆè´¹ï¼Œé˜²æ­¢ç³»ç»Ÿå´©æºƒ           | ç§’æ€ã€æŠ¢è´­ã€å¤§ä¿ƒç­‰çªå‘æµé‡åœºæ™¯            |
| **æœ€ç»ˆä¸€è‡´æ€§**          | é€šè¿‡å¯é æ¶ˆæ¯å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…å¼ºä¸€è‡´æ€§å¸¦æ¥çš„å¤æ‚æ€§ | è·¨è´¦æˆ·è½¬è´¦ã€è®¢å•æ”¯ä»˜åæ›´æ–°åº“å­˜            |
| **äº‹ä»¶é©±åŠ¨ & æ—¥å¿—æ”¶é›†** | æ”¯æŒåŸºäºäº‹ä»¶çš„æ¶æ„ï¼Œä¾¿äºæ‰©å±•ï¼›é›†ä¸­æ”¶é›†æ—¥å¿—æˆ–è¡Œä¸ºæ•°æ®ç”¨äºåˆ†æ | ç”¨æˆ·è¡Œä¸ºè¿½è¸ªã€ç³»ç»Ÿç›‘æ§ã€å¤§æ•°æ®åˆ†æ        |

> ğŸ’¡ **é€‚ç”¨æ¡ä»¶**ï¼šå½“ç³»ç»Ÿå­˜åœ¨**é«˜è€¦åˆã€åŒæ­¥é˜»å¡ã€æµé‡çªåˆºæˆ–éœ€å¼‚æ­¥/äº‹ä»¶é©±åŠ¨**ç­‰é—®é¢˜æ—¶ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å¯æ˜¾è‘—æå‡ç¨³å®šæ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

å‡ ç§MQçš„å¯¹æ¯”ï¼š

| ç‰¹æ€§ / äº§å“      | **RabbitMQ**                             | **Apache Kafka**                         | **Apache RocketMQ**                  | **Apache Pulsar**                        |
| :--------------- | :--------------------------------------- | :--------------------------------------- | :----------------------------------- | :--------------------------------------- |
| **å¼€å‘è¯­è¨€**     | Erlang                                   | Scala / Java                             | Java                                 | Java (Broker), C++ (BookKeeper)          |
| **æ¶ˆæ¯æ¨¡å‹**     | AMQPï¼ˆæ”¯æŒå¤šç§åè®®ï¼šSTOMPã€MQTT ç­‰ï¼‰     | å‘å¸ƒ-è®¢é˜…ï¼ˆåŸºäºæ—¥å¿—çš„æµå¼æ¨¡å‹ï¼‰          | å‘å¸ƒ-è®¢é˜… + ç‚¹å¯¹ç‚¹                   | ç»Ÿä¸€æ”¯æŒ Queue å’Œ Streamï¼ˆåˆ†å±‚æ¶æ„ï¼‰     |
| **ååé‡**       | ä¸­ç­‰ï¼ˆä¸‡çº§ QPSï¼‰                         | æé«˜ï¼ˆç™¾ä¸‡çº§ QPSï¼‰                       | é«˜ï¼ˆåä¸‡~ç™¾ä¸‡çº§ QPSï¼‰                | é«˜ï¼ˆæ¥è¿‘ Kafkaï¼Œæ”¯æŒå¤šç§Ÿæˆ·ï¼‰             |
| **å»¶è¿Ÿ**         | ä½ï¼ˆæ¯«ç§’çº§ï¼‰                             | ä¸­ï¼ˆé€šå¸¸å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ï¼‰               | ä½ï¼ˆæ¯«ç§’çº§ï¼‰                         | ä½ï¼ˆæ¯«ç§’çº§ï¼‰                             |
| **æŒä¹…åŒ–**       | æ”¯æŒï¼ˆå¯é…ç½®ï¼‰                           | å¼ºæŒä¹…åŒ–ï¼ˆå†™ç£ç›˜ + åˆ†æ®µæ—¥å¿—ï¼‰            | å¼ºæŒä¹…åŒ–ï¼ˆCommitLog + ConsumeQueueï¼‰ | å¼ºæŒä¹…åŒ–ï¼ˆåŸºäº BookKeeperï¼Œåˆ†å±‚å­˜å‚¨ï¼‰    |
| **å¯é æ€§**       | é«˜ï¼ˆæ”¯æŒ ACKã€æŒä¹…é˜Ÿåˆ—ã€é•œåƒé˜Ÿåˆ—ï¼‰       | é«˜ï¼ˆå‰¯æœ¬æœºåˆ¶ï¼Œä½†æ—©æœŸç‰ˆæœ¬æœ‰æ•°æ®ä¸¢å¤±é£é™©ï¼‰ | é«˜ï¼ˆåŒæ­¥/å¼‚æ­¥åˆ·ç›˜ï¼Œä¸»ä»æ¶æ„ï¼‰        | æé«˜ï¼ˆè®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»ï¼Œè‡ªåŠ¨æ•…éšœæ¢å¤ï¼‰     |
| **äº‹åŠ¡æ”¯æŒ**     | ä¸æ”¯æŒåŸç”Ÿäº‹åŠ¡ï¼ˆå¯é€šè¿‡æ’ä»¶æˆ–åº”ç”¨å±‚å®ç°ï¼‰ | ä»…æ”¯æŒå¹‚ç­‰å’Œ Exactly-Onceï¼ˆ0.11+ï¼‰       | âœ… æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯                 | æ”¯æŒï¼ˆé€šè¿‡ Pulsar Functions æˆ–å¤–éƒ¨åè°ƒï¼‰ |
| **é¡ºåºæ¶ˆæ¯**     | ä¸å¤©ç„¶æ”¯æŒï¼ˆéœ€å•é˜Ÿåˆ—å•æ¶ˆè´¹è€…æ¨¡æ‹Ÿï¼‰       | âœ… åˆ†åŒºå†…ä¸¥æ ¼æœ‰åº                         | âœ… å…¨å±€/åˆ†åŒºé¡ºåºæ¶ˆæ¯                  | âœ… åˆ†åŒºå†…æœ‰åº                             |
| **æ‰©å±•æ€§**       | ä¸€èˆ¬ï¼ˆé›†ç¾¤æ‰©å±•è¾ƒå¤æ‚ï¼‰                   | é«˜ï¼ˆæ°´å¹³æ‰©å±•æ–¹ä¾¿ï¼‰                       | é«˜ï¼ˆæ”¯æŒ NameServer åŠ¨æ€å‘ç°ï¼‰       | æé«˜ï¼ˆæ— çŠ¶æ€ Brokerï¼Œå­˜å‚¨ç‹¬ç«‹æ‰©å±•ï¼‰      |
| **è¿ç»´å¤æ‚åº¦**   | ä¸­ç­‰                                     | ä¸­ç­‰ï¼ˆä¾èµ– ZooKeeperï¼‰                   | ä¸­ç­‰                                 | è¾ƒé«˜ï¼ˆä¾èµ– BookKeeperï¼Œç»„ä»¶è¾ƒå¤šï¼‰        |
| **ç¤¾åŒº & ç”Ÿæ€**  | æˆç†Ÿï¼Œæ–‡æ¡£ä¸°å¯Œï¼Œæ’ä»¶å¤š                   | éå¸¸æ´»è·ƒï¼Œå¤§æ•°æ®ç”Ÿæ€é›†æˆå¥½ï¼ˆå¦‚ Flinkï¼‰   | é˜¿é‡Œç³»å¼ºå¤§ï¼Œå›½å†…ç”Ÿæ€å¥½               | æ–°å…´ï¼Œäº‘åŸç”Ÿå‹å¥½ï¼Œå¢é•¿è¿…é€Ÿ               |
| **å…¸å‹ä½¿ç”¨åœºæ™¯** | ä¼ä¸šåº”ç”¨ã€ä»»åŠ¡é˜Ÿåˆ—ã€ä¸­å°è§„æ¨¡å¼‚æ­¥è§£è€¦     | æ—¥å¿—æ”¶é›†ã€æµå¤„ç†ã€å¤§æ•°æ®ç®¡é“             | ç”µå•†äº¤æ˜“ã€é‡‘èæ”¯ä»˜ã€é«˜å¯é äº‹åŠ¡åœºæ™¯   | å¤šç§Ÿæˆ·ã€æ··åˆè´Ÿè½½ï¼ˆé˜Ÿåˆ—+æµï¼‰ã€äº‘åŸç”Ÿæ¶æ„  |

ç®€è¦æ€»ç»“ï¼š

| **éœ€æ±‚åœºæ™¯**                     | **æ¨è MQ**  |
| :------------------------------- | :----------- |
| éœ€è¦çµæ´»åè®®ã€å¼ºè·¯ç”±ã€ä½å»¶è¿Ÿ     | **RabbitMQ** |
| é«˜ååã€æ—¥å¿—/äº‹ä»¶æµã€å¤§æ•°æ®å¤„ç†  | **Kafka**    |
| é‡‘èçº§äº‹åŠ¡ã€é¡ºåºæ¶ˆæ¯ã€å›½äº§å¯æ§   | **RocketMQ** |
| äº‘åŸç”Ÿã€å¤šç§Ÿæˆ·ã€ç»Ÿä¸€é˜Ÿåˆ—ä¸æµå¤„ç† | **Pulsar**   |



### RabbitMQ

#### å®‰è£…ä¸éƒ¨ç½²

å®˜ç½‘ï¼š[RabbitMQ: One broker to queue them all | RabbitMQ](https://www.rabbitmq.com/)

æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨dockerè¿è¡Œå®¹å™¨æ¥å®Œæˆéƒ¨ç½²ï¼š[rabbitmq - Official Image | Docker Hub](https://hub.docker.com/_/rabbitmq)

```Shell
docker run \
 -e RABBITMQ_DEFAULT_USER=itheima \
 -e RABBITMQ_DEFAULT_PASS=123321 \
 -v mq-plugins:/plugins \				# è¿™é‡Œæ˜¯æŒ‚è½½åˆ°æ•°æ®å·ä¸Š
 --name mq \
 --hostname mq \
 -p 15672:15672 \
 -p 5672:5672 \
 --network hm-net\
 -d \
 rabbitmq:3.8-management
```

> æ— æ³•ç›´è¿dockerå¯¼è‡´pullä¸ä¸‹æ¥ï¼Œè€ƒè™‘ä½¿ç”¨ç½‘ä¸Šæä¾›çš„taråŒ…ï¼Œç„¶å
>
> ```bash
> docker load -i [taråŒ…åç§°]
> ```

å¯ä»¥çœ‹åˆ°åœ¨å®‰è£…å‘½ä»¤ä¸­æœ‰ä¸¤ä¸ªæ˜ å°„çš„ç«¯å£ï¼š

- 15672ï¼šRabbitMQæä¾›çš„ç®¡ç†æ§åˆ¶å°çš„ç«¯å£
- 5672ï¼šRabbitMQçš„æ¶ˆæ¯å‘é€å¤„ç†æ¥å£

ç„¶åè®¿é—®15672ç«¯å£å³å¯è®¿é—®æ§åˆ¶å°ç•Œé¢ï¼š[RabbitMQ Management](http://192.168.0.200:15672/)ï¼Œè¾“å…¥è®¾ç½®çš„è´¦å·å¯†ç å³å¯è¿›å…¥é¡µé¢ã€‚



#### æ•´ä½“æ¶æ„

```mermaid
graph TD
    subgraph RabbitMQ_Server
        direction LR
        subgraph VirtualHost
            direction TB
            Exchange1((Exchange 1))
            Queue1([Queue 1])
            Queue2([Queue 2])
            Exchange2((Exchange 2))
            Queue3([Queue 3])
            Exchange1 -->|Routing Key| Queue1
            Exchange1 -->|Routing Key| Queue2
            Exchange2 -->|Routing Key| Queue2
            Exchange2 -->|Routing Key| Queue3
        end
    end
    Publisher -->|Publish Message| Exchange1
    Publisher -->|Publish Message| Exchange2
    Queue1 -->|Consume Message| Consumer1
    Queue2 -->|Consume Message| Consumer2
    Queue3 -->|Consume Message| Consumer3

    classDef exchange fill:#f96,stroke:#333,stroke-width:2px;
    classDef queue fill:#bbf,stroke:#333,stroke-width:2px;
    classDef publisher fill:#9f6,stroke:#333,stroke-width:2px;
    classDef consumer fill:#6bf,stroke:#333,stroke-width:2px;

    class Exchange1,Exchange2 exchange;
    class Queue1,Queue2,Queue3 queue;
    class Publisher publisher;
    class Consumer1,Consumer2,Consumer3 consumer;
```

> ç”Ÿäº§è€…â€”â€”>äº¤æ¢æœºâ€”â€”>é˜Ÿåˆ—â€”â€”>æ¶ˆè´¹è€…ï¼Œ**ç”Ÿäº§è€…ä¸ä¼šç›´æ¥å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—è€Œæ˜¯ç”±äº¤æ¢æœºè½¬æ¥**ï¼Œå¯ä»¥ç®€å•å°†äº¤æ¢æœºç†è§£ä¸º**å‘é€ç­–ç•¥**ï¼ŒæŒ‡å®šå‘é€æ¶ˆæ¯çš„é˜Ÿåˆ—èŒƒå›´ï¼ˆå’Œè¿™ä¸ªäº¤æ¢æœºç»‘å®šçš„é˜Ÿåˆ—ï¼‰ä»¥åŠå£ä»¤ï¼ˆæ ¹æ®RoutingKeyé€šè¿‡ç»‘å®šBingingKeyé€‰æ‹©é˜Ÿåˆ—ï¼‰

| ç»„ä»¶                      | è¯´æ˜                                                         |
| ------------------------- | ------------------------------------------------------------ |
| 1. **Producer**ï¼ˆç”Ÿäº§è€…ï¼‰ | æ¶ˆæ¯çš„å‘é€æ–¹ï¼Œé€šè¿‡Clientå°†æ¶ˆæ¯å‘å¸ƒåˆ° RabbitMQ çš„ Exchangeï¼ˆäº¤æ¢æœºï¼‰ï¼Œä¸ç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ã€‚ |
| 2. **Consumer**ï¼ˆæ¶ˆè´¹è€…ï¼‰ | æ¶ˆæ¯çš„æ¥æ”¶æ–¹ï¼Œé€šè¿‡Clientä» Queueï¼ˆé˜Ÿåˆ—ï¼‰ä¸­æ‹‰å–æˆ–è®¢é˜…æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹ï¼ˆè½®è¯¢æˆ–å…¬å¹³åˆ†å‘ï¼‰ã€‚ |
| 3. Broker                 | RabbitMQ æœåŠ¡å®ä¾‹æœ¬èº«ï¼Œè´Ÿè´£æ¥æ”¶ã€è·¯ç”±ã€å­˜å‚¨å’ŒæŠ•é€’æ¶ˆæ¯ã€‚ä¸€ä¸ª Broker å¯åŒ…å«å¤šä¸ª Virtual Hostã€‚ |
| 4. Virtual Hostï¼ˆvhostï¼‰  | è™šæ‹Ÿä¸»æœºï¼Œç”¨äºé€»è¾‘éš”ç¦»ä¸åŒåº”ç”¨æˆ–ç§Ÿæˆ·ã€‚æ¯ä¸ª vhost æ‹¥æœ‰ç‹¬ç«‹çš„ Exchangeã€Queueã€Binding å’Œæƒé™ä½“ç³»ï¼Œç±»ä¼¼â€œå‘½åç©ºé—´â€ï¼ˆ**ä¸€ä¸ªMQä¸€èˆ¬ä¸€ä¸ªé¡¹ç›®ç”¨ä¸å®Œï¼Œå¯å¤ç”¨äºå¤šä¸ªé¡¹ç›®/å›¢é˜Ÿï¼Œè¿™æ—¶å€™å°±ç”¨è¿™ä¸ªâ€œnamespaceâ€ä½œä¸ºæœ€é«˜éš”ç¦»ç­‰çº§åŒºåˆ†ä¸€ä¸‹ç©ºé—´**ï¼‰ |
| 5. **Exchange**ï¼ˆäº¤æ¢æœºï¼‰ | æ¶ˆæ¯çš„è·¯ç”±ä¸­å¿ƒã€‚æ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®ç±»å‹ + è·¯ç”±è§„åˆ™å°†æ¶ˆæ¯åˆ†å‘åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚å¸¸è§ç±»å‹ï¼š  - `Direct`ï¼š**ç²¾ç¡®åŒ¹é… Routing Key**  - `Fanout`ï¼š**å¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—**  - `Topic`ï¼š**é€šé…ç¬¦åŒ¹é…**ï¼ˆå¦‚ `*.error`ï¼‰  - `Headers`ï¼š**åŸºäºæ¶ˆæ¯å¤´å±æ€§åŒ¹é…**ï¼ˆè¾ƒå°‘ç”¨ï¼‰ |
| 6. **Queue**ï¼ˆé˜Ÿåˆ—ï¼‰      | æ¶ˆæ¯çš„å­˜å‚¨å®¹å™¨ã€‚æ¶ˆæ¯åœ¨è¢«æ¶ˆè´¹å‰æŒä¹…åŒ–åœ¨æ­¤ï¼ˆå¯é…ç½®å†…å­˜æˆ–ç£ç›˜ï¼‰ã€‚æ¯ä¸ªé˜Ÿåˆ—å¯ç»‘å®šå¤šä¸ª Exchangeã€‚ |
| 7. **Binding**ï¼ˆç»‘å®šï¼‰    | å®šä¹‰ Exchange ä¸ Queue ä¹‹é—´çš„å…³è”è§„åˆ™ï¼Œé€šå¸¸åŒ…å« Routing Key æˆ–åŒ¹é…æ¨¡å¼ã€‚ |
| 8. Connection & Channel   | - Connectionï¼šå®¢æˆ·ç«¯ï¼ˆProducer/Consumerï¼‰ä¸ Broker ä¹‹é—´çš„ TCP é•¿è¿æ¥ã€‚  - Channelï¼šè½»é‡çº§è™šæ‹Ÿè¿æ¥ï¼Œå¤ç”¨åŒä¸€ä¸ª TCP è¿æ¥ï¼Œç”¨äºå¹¶å‘æ“ä½œï¼ˆå¦‚åŒæ—¶å£°æ˜å¤šä¸ªé˜Ÿåˆ—ï¼‰ã€‚ |
| 9. Messageï¼ˆæ¶ˆæ¯ï¼‰        | ç”± Payloadï¼ˆæ•°æ®ä½“ï¼‰ + Propertiesï¼ˆå…ƒæ•°æ®ï¼Œå¦‚ routing keyã€priorityã€TTL ç­‰ï¼‰ ç»„æˆã€‚ |

----

**ç®€è¦æµç¨‹ï¼š**

1. **ç”Ÿäº§è€…** å»ºç«‹ **Connection**ï¼Œåˆ›å»º **Channel**ï¼›
2. é€šè¿‡ Channel å°† **Message** å‘é€åˆ°æŒ‡å®šçš„ **Exchange**ï¼Œå¹¶é™„å¸¦ **Routing Key**ï¼›
3. **Exchange** æ ¹æ®ç±»å‹å’Œ **Binding è§„åˆ™**ï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª **Queue**ï¼›
4. **æ¶ˆè´¹è€…** å»ºç«‹ Connection/Channelï¼Œç›‘å¬ç›®æ ‡ Queueï¼›
5. æ¶ˆè´¹è€…ä» Queue ä¸­è·å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆåå‘é€ **ACK**ï¼›
6. Broker æ”¶åˆ° ACK åï¼Œä» Queue ä¸­åˆ é™¤è¯¥æ¶ˆæ¯ï¼ˆè‹¥æœª ACKï¼Œå¯èƒ½é‡æ–°å…¥é˜Ÿæˆ–è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼‰ã€‚

> âœ… **å…³é”®ç‰¹æ€§æ”¯æŒ**ï¼š
>
> - **æŒä¹…åŒ–**ï¼šExchangeã€Queueã€Message å¯è®¾ä¸ºæŒä¹…åŒ–ï¼Œé˜²æ­¢ Broker é‡å¯ä¸¢å¤±ã€‚
> - **ACK æœºåˆ¶**ï¼šç¡®ä¿æ¶ˆæ¯è¢«æˆåŠŸå¤„ç†ã€‚
> - **æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰**ï¼šå¤„ç†å¤±è´¥/è¿‡æœŸæ¶ˆæ¯ã€‚
> - **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šVIP ç”¨æˆ·æ¶ˆæ¯ä¼˜å…ˆå¤„ç†ã€‚
> - **é›†ç¾¤ä¸é«˜å¯ç”¨**ï¼šæ”¯æŒæ™®é€šé›†ç¾¤ã€é•œåƒé˜Ÿåˆ—ã€Quorum é˜Ÿåˆ—ã€‚

----

**éƒ¨ç½²ç±»å‹ï¼š**

| æ¨¡å¼                          | è¯´æ˜                                                         |
| :---------------------------- | :----------------------------------------------------------- |
| **å•æœºæ¨¡å¼**                  | å¼€å‘/æµ‹è¯•ä½¿ç”¨ï¼Œæ— é«˜å¯ç”¨ã€‚                                    |
| **æ™®é€šé›†ç¾¤**                  | å¤šèŠ‚ç‚¹å…±äº«å…ƒæ•°æ®ï¼ˆExchange/Bindingï¼‰ï¼Œä½† Queue æ•°æ®åªå­˜åœ¨äºä¸€ä¸ªèŠ‚ç‚¹ã€‚ |
| **é•œåƒé˜Ÿåˆ—é›†ç¾¤**              | Queue æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ­¥ï¼ˆä¸»ä»å¤åˆ¶ï¼‰ï¼Œå®ç°é«˜å¯ç”¨ï¼ˆç‰ºç‰²ååï¼‰ã€‚ |
| **Quorum é˜Ÿåˆ—ï¼ˆæ¨èæ–°é¡¹ç›®ï¼‰** | åŸºäº Raft åè®®ï¼Œå¼ºä¸€è‡´æ€§ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæ›¿ä»£é•œåƒé˜Ÿåˆ—ã€‚       |



#### ç®€è¦ç†è§£

 **ç”Ÿäº§è€…ï¼ˆProducerï¼‰è§†è§’ï¼š**

> â€œæˆ‘åªç®¡æŠŠæ¶ˆæ¯å‘ç»™ã€Œäº¤æ¢æœºã€ï¼Œä¸ç”¨çŸ¥é“è°ä¼šæ”¶åˆ°ã€‚â€

1. åˆ›å»ºä¸€æ¡æ¶ˆæ¯
2. å‘ç»™æŒ‡å®šçš„ **Exchangeï¼ˆäº¤æ¢æœºï¼‰**ï¼Œå¹¶é™„ä¸Šä¸€ä¸ª **Routing Key**ï¼ˆè·¯ç”±å…³é”®å­—ï¼‰
3. å®Œäº‹ï¼ä¸å…³å¿ƒæ¶ˆæ¯å»å“ªã€æœ‰æ²¡æœ‰äººæ”¶

------

**æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰è§†è§’ï¼š**

> â€œæˆ‘åªç®¡ä»ã€Œé˜Ÿåˆ—ã€é‡Œæ‹¿æ¶ˆæ¯ï¼Œä¸ç”¨çŸ¥é“æ˜¯è°å‘çš„ã€‚â€

1. å‘Šè¯‰ RabbitMQï¼šâ€œæˆ‘è¦ç›‘å¬æŸä¸ª **Queueï¼ˆé˜Ÿåˆ—ï¼‰**â€
2. ä¸€æ—¦é˜Ÿåˆ—æœ‰æ¶ˆæ¯ï¼Œå°±å–å‡ºæ¥å¤„ç†
3. å¤„ç†å®Œå‘Šè¯‰ RabbitMQï¼šâ€œæ”¶åˆ°äº†ï¼â€ï¼ˆACKï¼‰
4. å®Œäº‹ï¼ä¸å…³å¿ƒæ¶ˆæ¯ä»å“ªæ¥ã€è°å‘çš„

------

 **ğŸ”— ä¸­é—´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆRabbitMQ è´Ÿè´£ï¼‰**

- Exchange æ ¹æ® **Routing Key + ç»‘å®šè§„åˆ™ï¼ˆBindingï¼‰**ï¼ŒæŠŠæ¶ˆæ¯è‡ªåŠ¨æŠ•é€’åˆ°å¯¹åº”çš„ Queue
- ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªé˜Ÿåˆ—æ”¶åˆ°ï¼ˆæ¯”å¦‚å¹¿æ’­ï¼‰ï¼Œä¹Ÿå¯ä»¥åªè¿›ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæ¯”å¦‚ç‚¹å¯¹ç‚¹ï¼‰

------

 **âœ… ä¸€å¥è¯æ€»ç»“ï¼š**

> **ç”Ÿäº§è€… â†’ å‘ç»™äº¤æ¢æœº**ï¼Œ**æ¶ˆè´¹è€… â† ä»é˜Ÿåˆ—å–**ï¼Œä¸­é—´è·¯ç”±ç”± RabbitMQ è‡ªåŠ¨æå®šï¼ŒåŒæ–¹å®Œå…¨è§£è€¦ï¼



### é…ç½®ç›¸å…³

#### é…ç½®é˜Ÿåˆ—ä»¥åŠäº¤æ¢æœº

åœ¨RabbitMQæä¾›çš„å¯è§†åŒ–webé¡µé¢ï¼š[RabbitMQ Management](http://192.168.0.200:15672/)ï¼Œæˆ‘ä»¬å¯ä»¥æ¥åˆ°`Queues`æ ‡ç­¾é¡µï¼Œåœ¨ä¸‹æ–¹çš„é˜Ÿåˆ—ç®¡ç†åˆ†é¡µç•Œé¢æˆ‘ä»¬åªéœ€è¦ç‚¹ç‚¹ç‚¹å°±å¯ä»¥å®Œæˆé˜Ÿåˆ—çš„ç›¸å…³é…ç½®äº†ã€‚

ç„¶åæˆ‘ä»¬æ¥åˆ°`Exchanges`æ ‡ç­¾é¡µï¼Œåœ¨è¿™é‡Œçš„ç®¡ç†ç•Œé¢æˆ‘ä»¬åŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡ç‚¹ç‚¹ç‚¹å®ç°å¯¹äº¤æ¢æœºçš„ç®¡ç†ï¼Œæˆ‘ä»¬å…ˆå‰æåˆ°**æ¶ˆæ¯**è¿›å…¥brokeråå»åˆ°ç”Ÿäº§è€…æŒ‡å®šçš„`vhost`ç„¶åå°±æ˜¯`Exchanges`äº†ï¼Œä½†æ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬çš„æ¶ˆæ¯è¦æ€ä¹ˆå»åˆ°**æ¶ˆè´¹è€…**èƒ½å¤Ÿ**è®¢é˜…è·å–**çš„**`Queues`**å‘¢ï¼Ÿ

RabbitMQçš„æ–¹æ¡ˆæ˜¯æä¾›äº†**`Exchanges`ä¸`Queues`ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼š`Bindings`**ï¼Œé€šè¿‡è¿™ä¸ªç»‘å®šï¼Œæˆ‘ä»¬å°†`Exchanges`ä¸`Queues`è”ç³»èµ·æ¥ï¼Œä»¥å`Exchanges`åªè¦æ”¶åˆ°æ¶ˆæ¯å°±æ ¹æ®ç”Ÿäº§è€…é™„å¸¦çš„`Routing Key`å°†æ¶ˆæ¯äº¤ç»™æŒ‡å®šçš„`Queues`äº†ã€‚

è€Œæƒ³è¦**å®ç°ä¸€ä¸ª`Bindings`**ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨`Exchange`æ ‡ç­¾é¡µç‚¹å¼€éœ€è¦è®¾ç½®çš„é‚£ä¸ª`Exchange`ï¼Œç„¶åå†ç‚¹å¼€ä¸‹æ–¹çš„`Bindings`ï¼Œé…ç½®å¥½`Binding`æŒ‡å®šçš„`Queue`å’Œ`Routing Key`ä»¥åŠç›¸å…³å‚æ•°å³å¯å®Œæˆé…ç½®ã€‚



#### é…ç½®æ•°æ®éš”ç¦»

ä¹‹å‰æˆ‘ä»¬æåˆ°ä¸€èˆ¬ä¸€ä¸ªMQä¼šç”¨äºå¤šä¸ªé¡¹ç›®ï¼Œè¿™æ—¶å€™å°±éœ€è¦æˆ‘ä»¬å»é…ç½®ä¸€ä¸ªè™šæ‹Ÿä¸»æœºvhostæ¥åŒºåˆ†ä¸åŒé¡¹ç›®çš„ç©ºé—´ç¯å¢ƒï¼Œæƒ³è¦é…ç½®ä¸åŒçš„vhostï¼Œæˆ‘ä»¬åªéœ€è¦æ¥åˆ°å¯è§†åŒ–webç•Œé¢ï¼Œç‚¹å‡»æœ€å³ä¾§çš„`Admin`æ ‡ç­¾é¡µï¼Œç„¶åå°±å¯ä»¥åœ¨è¿™ä¸ªé¡µé¢å®Œæˆé…ç½®äº†ã€‚

åœ¨RabbitMQä¸­ï¼Œä¸ºäº†å®ç°æƒé™ç®¡ç†ä»¥åŠåŠŸèƒ½åŒºåˆ†ï¼Œä¸“é—¨é…å¤‡äº†ä¸€ä¸ªèº«ä»½`User`ï¼Œæ¯ä¸ªUseréƒ½è¢«æŒ‡å®šäº†ï¼š

- èƒ½å¦è®¿é—®æŸä¸ª **Virtual Host**
- èƒ½å¦ **è¯»ï¼ˆæ¶ˆè´¹ï¼‰** é˜Ÿåˆ—
- èƒ½å¦ **å†™ï¼ˆå‘å¸ƒï¼‰** åˆ°äº¤æ¢æœº
- èƒ½å¦ **é…ç½®ï¼ˆå£°æ˜/åˆ é™¤ï¼‰** Exchange æˆ– Queue

> **User æ˜¯è®¿é—® RabbitMQ çš„â€œé€šè¡Œè¯â€ï¼Œç”¨æ¥æ§åˆ¶â€œè°å¯ä»¥åšä»€ä¹ˆâ€**ï¼Œå¯ä»¥ç†è§£ä¸ºOSSçš„ä»¤ç‰Œã€‚

æ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ª vhost ä¸Šéƒ½æœ‰ä¸‰ä¸ªæƒé™ä½ï¼š

| æƒé™ç±»å‹      | ä½œç”¨                                     | ç¤ºä¾‹                        |
| :------------ | :--------------------------------------- | :-------------------------- |
| **Configure** | æ˜¯å¦èƒ½å£°æ˜/åˆ é™¤ Exchangeã€Queueã€Binding | å£°æ˜ `order.queue`          |
| **Write**     | æ˜¯å¦èƒ½å‘ Exchange **å‘é€**æ¶ˆæ¯           | å‘å¸ƒæ¶ˆæ¯åˆ° `order.exchange` |
| **Read**      | æ˜¯å¦èƒ½ä» Queue **æ¶ˆè´¹**æ¶ˆæ¯              | ä» `order.queue` æ‹‰å–æ¶ˆæ¯   |

> ğŸ’¡ é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQ åªæœ‰ä¸€ä¸ªç”¨æˆ·ï¼š`guest` / `guest`ï¼Œ**ä½†è¯¥ç”¨æˆ·åªèƒ½ä» localhost ç™»å½•**ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»åˆ›å»ºæ–°ç”¨æˆ·ï¼

é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æƒ³è¦å»ä¸ºä¸€ä¸ªé¡¹ç›®é…ç½®ä¸€ä¸ª`Virtual Host`ï¼Œä½¿å¾—ä»–çš„`User`èƒ½å¤Ÿè®¿é—®è¿™ä¸ªç©ºé—´é‡Œé¢çš„äº¤æ¢æœº`Exchange`ï¼Œæˆ‘ä»¬åªéœ€è¦æ¥åˆ°MQçš„å¯è§†åŒ–webç•Œé¢ï¼š

1. åœ¨`User`æ ‡ç­¾é¡µä¸ºè¿™ä¸ª**é¡¹ç›®**åˆ›å»ºä¸€ä¸ª`Virtual Host`ï¼ˆè¿™æ—¶å·²ç”Ÿæˆäº†é»˜è®¤çš„`Exchange`äº¤æ¢æœºï¼‰
2. ä¸ºè®¡åˆ’çš„å‡ ä¸ªä¸šåŠ¡é…ç½®å¯¹åº”çš„`User`ï¼Œå°†è‡ªå·±çš„`Virtual Host`çš„ç›¸åº”è®¿é—®accessèµ‹äºˆè¿™äº›ç”¨æˆ·
3. åœ¨`Queues`æ ‡ç­¾é¡µé…ç½®å¯¹åº”çš„ä¸šåŠ¡`Queue`ï¼Œé…ç½®å¥½å…¶çš„`Virtual Host`ï¼ˆ`Bindings`ä¼šè‡ªåŠ¨ç»‘å®šåˆ°é»˜è®¤çš„defaultäº¤æ¢æœºï¼‰
4. åœ¨`Exchange`æ ‡ç­¾é¡µå®Œæˆç›¸åº”äº¤æ¢æœºçš„åˆ›å»ºï¼Œ`Bindings`é…ç½®ä¸æŒ‡å®š`Queue`çš„ç»‘å®šå…³ç³»

ç„¶åç”Ÿäº§è€…å°±å¯ä»¥å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœºï¼›æ¶ˆè´¹è€…å°±å¯ä»¥è®¢é˜…å¯¹åº”çš„é˜Ÿåˆ—

> å«Œå…¶ä»–é¡¹ç›®çš„`Virtual Host`ç›¸å…³å†…å®¹å¤ªå¤šå¯ä»¥åœ¨å³ä¸Šè§’é€‰æ‹©ä»…å±•ç¤ºæŸä¸€`Virtual Host`çš„å†…å®¹



### Java Client

#### å¼•å…¥ä¾èµ–

```xml
        <!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>
```

#### é…ç½®YML

åœ¨applicationä¸­è®¾ç½®å¥½clientçš„ç”¨æˆ·ä¿¡æ¯ï¼š

```yml
spring:
  rabbitmq:
    host: 192.168.0.200 # ä½ çš„è™šæ‹ŸæœºIP
    port: 5672 # ç«¯å£
    virtual-host: /hmall # è™šæ‹Ÿä¸»æœº
    username: hmall # ç”¨æˆ·å
    password: 123 # å¯†ç 
```

> ä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªé¡¹ç›®åªä¼šä½¿ç”¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œæˆ‘ä»¬ä¸ºä¸åŒçš„å¾®æœåŠ¡é…ç½®æŒ‡å®šçš„ç”¨æˆ·å³å¯



#### ç”Ÿäº§è€…å‘é€æ¶ˆæ¯

```java
@SpringBootTest
class PublisherApplicationTest {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    public void testMain() {
        String queueName = "simple.queue";
        String message = "Hello World!";
        rabbitTemplate.convertAndSend(queueName, message);
    }
}
```

> **ç”Ÿäº§è€…ä¸åº”è¯¥å‘åˆ°äº¤æ¢æœºå—ï¼Ÿä¸ºä»€ä¹ˆæŒ‡å®šé˜Ÿåˆ—åå°±å¯ä»¥ç›´æ¥å‘é€æ¶ˆæ¯äº†ï¼Ÿ**
>
> å½“ä½ **ç›´æ¥æŒ‡å®šé˜Ÿåˆ—å**å‘é€æ¶ˆæ¯æ—¶ï¼Œ`RabbitTemplate` ä¼šè‡ªåŠ¨ä½¿ç”¨ RabbitMQ å†…ç½®çš„ã€Œ**é»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰**ã€ï¼Œå¹¶å°† routing key è®¾ä¸ºé˜Ÿåˆ—åã€‚è¿™æ˜¯åˆæ³•ä¸”å¸¸ç”¨çš„åšæ³•ã€‚
>
> **é»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰**ä¼šåœ¨åˆ›å»ºå®Œæˆä¸€ä¸ªè™šæ‹Ÿä¸»æœºæ—¶ä¹Ÿä¸€åŒç”Ÿæˆï¼Œå…¶å±äºè¯¥è™šæ‹Ÿä¸»æœºï¼Œ**RabbitMQ çš„é»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰ä¼šè‡ªåŠ¨ç»‘å®šåˆ°æ¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆQueueï¼‰**ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹æ˜¯**éšå¼çš„ã€ä¸å¯è§çš„ã€æ— æ³•åˆ é™¤æˆ–ä¿®æ”¹çš„**ã€‚
>
> åº•å±‚å®é™…ç­‰ä»·äºï¼š
>
> ```java
> rabbitTemplate.convertAndSend("", "simple.queue", "Hello!");
> //            				   â†‘äº¤æ¢æœº   â†‘routing key
> ```
>
> - äº¤æ¢æœºï¼š`""`ï¼ˆé»˜è®¤ direct äº¤æ¢æœºï¼‰
> - Routing Keyï¼š`"simple.queue"`
> - æ¶ˆæ¯è¢«è·¯ç”±åˆ°åä¸º `simple.queue` çš„é˜Ÿåˆ—
>
> âœ… è¿™å®Œå…¨ç¬¦åˆ direct äº¤æ¢æœºçš„åŒ¹é…è§„åˆ™ï¼ˆç²¾ç¡®åŒ¹é… routing keyï¼‰ã€‚
>
> è¿™ç§æ–¹å¼èƒ½æˆåŠŸï¼Œ**å¿…é¡»æ»¡è¶³**ï¼š
>
> 1. é˜Ÿåˆ— `simple.queue`å·²ç»å­˜åœ¨ï¼ˆRabbitMQ ä¸ä¼šè‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—ï¼ï¼‰
>
>    - å¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œæ¶ˆæ¯ä¼šè¢«**é™é»˜ä¸¢å¼ƒ**ï¼ˆå› ä¸ºé»˜è®¤äº¤æ¢æœºæ— æ³•è·¯ç”±ï¼‰
>    
> 2. ä½ ç¡®å®æƒ³å®ç° **â€œç›´æ¥å‘åˆ°æŸä¸ªé˜Ÿåˆ—â€** çš„ç®€å•æ¨¡å¼ï¼ˆæ—  **fanoutå¹¿æ’­**/**topicé€šé…ç¬¦åŒ¹é…** ç­‰å¤æ‚è·¯ç”±ï¼‰



#### æ¶ˆè´¹è€…è®¢é˜…é˜Ÿåˆ—

```java
@Component
@Slf4j
public class MQListener {
    
    @RabbitListener(queues = "simple.queue")
    public void listen(String message) {
        log.info("æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š{}", message);
    }
}
```

åœ¨å®Œæˆä¾èµ–å¯¼å…¥åï¼Œæˆ‘ä»¬åªéœ€è¦ä¿è¯è¿æ¥é…ç½®æ­£ç¡®ï¼Œå°±å¯ä»¥è®©è¿™ä¸ªBeanå®ä¾‹èƒ½å¤Ÿç›‘å¬åˆ°æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œå®é™…ä¸Šä¸€ä¸ªæ–¹æ³•å¯ä»¥ç›‘å¬å¤šæ¡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¼ å…¥`List<String>`å³å¯ï¼‰ã€‚



#### æ¶ˆè´¹è€…è´Ÿè½½å‡è¡¡

åœ¨å®é™…ç”Ÿäº§ä¸­æˆ‘ä»¬ä¼šä¸ºä¸€ä¸ªé˜Ÿåˆ—é…å¤‡å¤šä¸ªæ¶ˆè´¹è€…æ¥å®Œæˆå¤šä¸ªç”Ÿäº§è€…å‘å¸ƒçš„ä»»åŠ¡ï¼Œè€Œå°±åƒNacosé€‰æ‹©å¾®æœåŠ¡å®ä¾‹ä¼šé€šè¿‡LoadBalancerè¿›è¡Œ**è´Ÿè½½å‡è¡¡**ä¸€æ ·ï¼Œç›‘å¬**åŒä¸€é˜Ÿåˆ—**çš„æ¶ˆè´¹è€…ä¹Ÿä¼šè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯**è½®è¯¢**ï¼Œä¹Ÿå³æ¯ä¸ªæ¶ˆè´¹è€…**è½®æµ**å–å‡ºä¸€ä¸ªæ¶ˆæ¯å¹¶**å®Œæˆä¸šåŠ¡ä»¥å**ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…å–æ¶ˆæ¯æ“ä½œã€‚ä½†æ˜¯å®é™…ç¯å¢ƒä¸­ï¼Œå¹¶éæ‰€æœ‰æ¶ˆè´¹è€…æœåŠ¡çš„æ€§èƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™å°±ä¼šå¯¼è‡´æœ‰äº›æ€§èƒ½å¥½çš„æ¶ˆè´¹è€…å¿…é¡»ç­‰å¾…å…¶ä»–æ¶ˆè´¹æœåŠ¡å®ä¾‹å®Œæˆä»»åŠ¡åæ‰è½®å¾—åˆ°è‡ªå·±ï¼Œä½¿å¾—ä»–ä»¬çš„æ€§èƒ½è¢«**æµªè´¹**äº†ã€‚

é’ˆå¯¹è¿™ä¸€ç§æƒ…å†µï¼ŒRabbitMQå…¶å®ä¹Ÿæä¾›äº†ä¸€ç§è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼š**èƒ½è€…å¤šåŠ³**ï¼šæ¯ä¸ªæ¶ˆè´¹è€…æœåŠ¡æ¯æ¬¡åªè·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆå°±ä¼šè·å–ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚æƒ³è¦é…ç½®è¿™æ ·ä¸€ç§æ¨¡å¼ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ°é…ç½®æ–‡ä»¶applicationä¸­å»ä¿®æ”¹æ¨¡å¼ï¼š

```YAML
spring:
  rabbitmq:
    listener:
      simple:
        prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯
```

è¿™æ ·å°±å¯ä»¥è®©æ€§èƒ½æ›´ä½³çš„æ¶ˆè´¹è€…å®ä¾‹å»å°½å¯èƒ½çš„å®Œæˆä»»åŠ¡äº†ã€‚

å®é™…ä¸Šï¼ŒRabbitMQ **æ€»æ˜¯æŒ‰é¡ºåºä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºæ¶ˆæ¯ï¼Œå¹¶ä¾æ¬¡å°è¯•åˆ†å‘ç»™æ¶ˆè´¹è€…** â€”â€” è¿™ä¸ªè¿‡ç¨‹**æœ¬èº«æ˜¯è½®è¯¢å¼çš„**ã€‚

ä½†å…³é”®åœ¨äºï¼š**æ˜¯å¦å…è®¸æŠŠæ¶ˆæ¯å‘ç»™æŸä¸ªæ¶ˆè´¹è€…ï¼Ÿ**

- **å¦‚æœæ²¡æœ‰ prefetch é™åˆ¶**ï¼š
  RabbitMQ ä¼šä¸€å£æ°”æŠŠæ‰€æœ‰æ¶ˆæ¯æŒ‰è½®è¯¢é¡ºåºæ¨ç»™æ¶ˆè´¹è€…ï¼ˆæ¯”å¦‚ C1ã€C2ã€C1ã€C2...ï¼‰ï¼Œä½†å› ä¸ºç½‘ç»œ/ç¼“å†²åŒºåŸå› ï¼Œå¾€å¾€ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…æ‹¿èµ°å¤§éƒ¨åˆ†ã€‚
- **å¦‚æœè®¾ç½®äº† `prefetch = 1`**ï¼š
  RabbitMQ ä»ç„¶æŒ‰è½®è¯¢é¡ºåºå°è¯•æ´¾å‘ï¼Œä½†**åªæœ‰å½“æ¶ˆè´¹è€…æœªç¡®è®¤æ¶ˆæ¯æ•° < 1 æ—¶ï¼Œæ‰çœŸæ­£å‘é€**ã€‚
  â†’ å¦‚æœ C1 è¿˜æ²¡ ACKï¼Œå³ä½¿è½®åˆ°å®ƒï¼Œä¹Ÿä¸å‘ï¼›è½¬è€Œå‘ç»™ C2ï¼ˆå¦‚æœ C2 ç©ºé—²ï¼‰ã€‚

âœ… æ‰€ä»¥ï¼š**åº•å±‚ä»æ˜¯è½®è¯¢å°è¯•ï¼Œä½†å®é™…æ´¾å‘å— prefetch + ACK çŠ¶æ€æ§åˆ¶**ã€‚

> **RabbitMQä¸€ä¸ªé˜Ÿåˆ—çš„å¤šä¸ªæ¶ˆè´¹è€…é»˜è®¤é‡‡ç”¨ã€Œè½®è¯¢åˆ†å‘ã€ï¼ˆRound-Robinï¼‰ + ã€Œè‡ªåŠ¨ ACKã€æˆ–ã€Œæ‰‹åŠ¨ ACKã€ä¸‹çš„ã€Œå…¬å¹³åˆ†å‘ã€ï¼ˆFair Dispatchï¼‰**
>
> **æƒ…å†µ 1ï¼šè‡ªåŠ¨ ACK æ¨¡å¼ï¼ˆautoAck = trueï¼‰**
>
> - RabbitMQ é‡‡ç”¨ç®€å•çš„è½®è¯¢ï¼ˆRound-Robinï¼‰ï¼š
>   - æ¶ˆæ¯ 1 â†’ Consumer A
>   - æ¶ˆæ¯ 2 â†’ Consumer B
>   - æ¶ˆæ¯ 3 â†’ Consumer A
>   - ...
> - âŒ **é—®é¢˜**ï¼šå¦‚æœ Consumer A å¤„ç†æ…¢ï¼ŒConsumer B å¤„ç†å¿«ï¼Œä¼šå¯¼è‡´ A å †ç§¯ã€B ç©ºé—² â€”â€” **ä¸å…¬å¹³ï¼**
>
> **æƒ…å†µ 2ï¼šæ‰‹åŠ¨ ACK æ¨¡å¼ï¼ˆautoAck = falseï¼‰ + è®¾ç½® prefetchï¼ˆæ¨èï¼ï¼‰**
>
> - RabbitMQ é‡‡ç”¨åŸºäº prefetch çš„å…¬å¹³åˆ†å‘ï¼ˆFair Dispatchï¼‰ï¼š
>   - åªæœ‰å½“æ¶ˆè´¹è€…**æœªç¡®è®¤çš„æ¶ˆæ¯æ•° < prefetch count** æ—¶ï¼Œæ‰ç»™å®ƒå‘æ–°æ¶ˆæ¯
>   - å¤„ç†å¿«çš„æ¶ˆè´¹è€…ä¼šæ‹¿åˆ°æ›´å¤šæ¶ˆæ¯ï¼Œå¤„ç†æ…¢çš„åˆ™å°‘æ‹¿
>   - âœ… å®ç°**åŠ¨æ€è´Ÿè½½å‡è¡¡**
>
> ğŸ“Œ **ç»“è®º**ï¼š
> **çœŸæ­£çš„â€œè´Ÿè½½å‡è¡¡â€ä¾èµ–äº `manual ACK + prefetch`ï¼Œè€Œä¸æ˜¯ç®€å•çš„è½®è¯¢ï¼**



### ä¸‰ç§å‘é€ç±»å‹

#### Fanoutäº¤æ¢æœºå¹¿æ’­

å…ˆå‰æˆ‘ä»¬å®Œæˆäº†ç”Ÿäº§è€…å¯¹å•é˜Ÿåˆ—çš„æ¶ˆæ¯ä¼ é€’ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å¸Œæœ›å°†æ¶ˆæ¯**åŒæ—¶**ä¼ é€’ç»™å¤šä¸ªé˜Ÿåˆ—æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ ä¸€ä¸ª`List<String>`å‚æ•°è¿›å»ç›´æ¥è®©é»˜è®¤äº¤æ¢æœºè¿›è¡Œå¹¿æ’­å—ï¼Ÿç­”æ¡ˆæ˜¯**ä¸è¡Œ**ï¼

> **é»˜è®¤äº¤æ¢æœºæ˜¯ `direct` ç±»å‹ï¼Œä¸”æ¯ä¸ªé˜Ÿåˆ—åªèƒ½é€šè¿‡ã€Œè‡ªå·±çš„åå­—ã€ä½œä¸º routing key è¢«å•ç‹¬è®¿é—® â€”â€” å®ƒæ ¹æœ¬ä¸æ”¯æŒå¹¿æ’­è¯­ä¹‰ã€‚**

é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å»è‡ªåˆ¶äº¤æ¢æœºï¼Œå¹¶å°†éœ€è¦ä¼ é€’æ¶ˆæ¯çš„é˜Ÿåˆ—ä¸ä¹‹ç»‘å®šï¼Œç„¶åå†åœ¨clientå°†ä¿¡æ¯å‘é€ç»™ä»–ä»¥å®Œæˆå¹¿æ’­ï¼š

```java
@Test
public void testMain() {
    String exchangename = "hmall.fanout";
    String message = "H5165";
    rabbitTemplate.convertAndSend(exchangename, "", message);
}
```

> **åœ¨ Fanout Exchange ä¸­ï¼Œ`routing key` å®Œå…¨è¢«å¿½ç•¥ â€”â€” æ— è®ºä½ å‘ä»€ä¹ˆ routing keyï¼ˆåŒ…æ‹¬ç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œæ¶ˆæ¯éƒ½ä¼šå¹¿æ’­ç»™æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ã€‚**

`hmall.fanout`äº¤æ¢æœºç»‘å®šäº†`fanout.queue1`ä»¥åŠ`fanout.queue2`ï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™`hmall.fanout`äº¤æ¢æœºå³å¯å°†æ¶ˆæ¯ä¼ é€’ç»™ä¸¤ä¸ªé˜Ÿåˆ—ã€‚

```java
@RabbitListener(queues = "fanout.queue1")
public void listen2(String message) {
    log.info("1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š{}", message);
}

@RabbitListener(queues = "fanout.queue2")
public void listen3(String message) {
    log.info("2æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š{}", message);
}
```

æ¶ˆè´¹è€…åªéœ€è¦æ­£å¸¸ç›‘å¬å³å¯ã€‚



#### Directå®šå‘å‘é€

æˆ‘ä»¬è¯´å¯¹äºç»‘å®šçš„é˜Ÿåˆ—æˆ‘ä»¬**ä¸å¸Œæœ›è¿›è¡Œæ— è„‘å¹¿æ’­**ï¼Œæˆ‘ä»¬è¦æŒ‘ç€æ¥ï¼Œæœ‰çš„é˜Ÿåˆ—æˆ‘ä»¬è¦å‘ï¼Œæœ‰çš„é˜Ÿåˆ—æˆ‘ä»¬ä¸å‘ï¼Œé‚£è¯¥æ€ä¹ˆæï¼ŸRabbitMQæä¾›çš„æ–¹æ¡ˆæ˜¯ç»™`Bindings`åŠ ä¸Šå±æ€§`Routing Key`ï¼Œå€˜è‹¥è¿™ä¸ª`Routing Key`ç¬¦åˆè¦æ±‚é‚£å°±å‘ã€‚

> æ³¨æ„ä¸€ä¸ªäº¤æ¢æœºå’Œä¸€ä¸ªé˜Ÿåˆ—ä¹‹é—´å¯ä»¥**å¤šæ¬¡ç»‘å®š**ï¼Œ**ç»‘å®šå¤šç§**`Routing Key`ï¼Œæ€»ä¹‹å°±æ˜¯å¾ˆçµæ´»

å¦‚æœæˆ‘ä»¬å¯¹äº`Routing Key`çš„è¦æ±‚æ˜¯**å®Œå…¨ä¸€è‡´**ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨RabbitMQæä¾›çš„**Direct**ç±»å‹äº¤æ¢æœºï¼Œä»–å°±ä¼šå¯¹è‡ªå·±ç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—é€šè¿‡**å†…éƒ¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾**ç¬¦åˆè¦æ±‚çš„`Binding`å¹¶ç»™å…¶æ‰€å¯¹åº”çš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼š

å‡†å¤‡ä¸€ä¸ªäº¤æ¢æœºhmall.directï¼Œå°†ä¹‹ä¸é˜Ÿåˆ—direct.queue1å’Œdirect.queue2ç»‘å®šï¼Œè§„åˆ™ï¼š

| To              | Routing key |
| :-------------- | :---------- |
| [direct.queue1] | 123         |
| [direct.queue1] | 5           |
| [direct.queue2] | 321         |
| [direct.queue2] | 5           |

```java
@Test
public void testMain() {
    String exchangename = "hmall.direct";
    String message = "H5165";
    rabbitTemplate.convertAndSend(exchangename, "123", message);
}
```

> rabbitTemplate.convertAndSendçš„å‚æ•°ä¸º
>
> - äº¤æ¢æœºname
> - Routing Key
> - æ¶ˆæ¯Obj

```java
@RabbitListener(queues = "direct.queue1")
public void listen4(String message) {
    log.info("1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š{}", message);
}

@RabbitListener(queues = "direct.queue2")
public void listen5(String message) {
    log.info("2æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š{}", message);
}
```

å½“ä½¿ç”¨5ä½œä¸ºRouting Keyæ—¶å‘ç°ä¸¤ä¸ªç»‘å®šçš„é˜Ÿåˆ—éƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œä½¿ç”¨123æˆ–321å°±ä¼šå‘ç°åªæœ‰ä¸€ä¸ªæ”¶åˆ°äº†æ¶ˆæ¯ã€‚



#### Topicè¯é¢˜é€šé…å‘é€

æˆ‘ä»¬è¯´RoutingKeyç›´æ¥å®Œå…¨ç›¸ç­‰è¿˜æ˜¯å¤ªç²—æš´äº†ï¼Œæ˜¯å¦å¯ä»¥é€šé…ç¬¦æ¥åŒ¹é…RoutingKeyå®ç°æŒ‡å®šé˜Ÿåˆ—çš„ç»‘å®šå‘¢ï¼Ÿå¯ä»¥çš„xdï¼ŒRabbitMQå°±æä¾›äº†Topicç±»å‹çš„äº¤æ¢æœºæ¥æŒ‡å®šé€šé…è§„åˆ™RoutingKeyï¼š

- `#`ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯
- `*`ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯

RoutingKeyä¸¾ä¾‹ï¼š

- `item.#`ï¼šèƒ½å¤ŸåŒ¹é…`item.spu.insert` æˆ–è€… `item.spu`
- `item.*`ï¼šåªèƒ½åŒ¹é…`item.spu`

å®Œæˆäº¤æ¢æœºä»¥åŠé˜Ÿåˆ—çš„åˆ›å»ºä»¥åŠç»‘å®šåï¼Œåœ¨Clientçš„ä½¿ç”¨ä¸Šå’Œå‰ä¸¤ç§æ–¹å¼æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚



#### ç®€å•æ€»ç»“

**ç”Ÿäº§è€…ï¼š**å¯¹äºåªå¸Œæœ›**ç®€å•çš„**å‘é€åˆ°**ä¸€ä¸ªé˜Ÿåˆ—**çš„ç”Ÿäº§è€…ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡è™šæ‹Ÿä¸»æœºç”Ÿæˆæ—¶çš„**é»˜è®¤äº¤æ¢æœº**ç›´æ¥å‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ï¼Œclientä¸­ä¹Ÿä¸éœ€è¦æŒ‡å®šExchangeï¼Œåªéœ€è¦è¾“å…¥routing keyï¼ˆå³é˜Ÿåˆ—nameï¼‰ä»¥åŠæ¶ˆæ¯å†…å®¹æ¥å£ã€‚

> **é»˜è®¤äº¤æ¢æœºæ˜¯ `direct` ç±»å‹ï¼Œä¸”æ¯ä¸ªé˜Ÿåˆ—åªèƒ½é€šè¿‡ã€Œè‡ªå·±çš„åå­—ã€ä½œä¸º routing key è¢«å•ç‹¬è®¿é—® â€”â€” å®ƒæ ¹æœ¬ä¸æ”¯æŒå¹¿æ’­è¯­ä¹‰ã€‚**åŸæ–‡è§£é‡Šï¼š
>
> **Default exchange**
>
> The default exchange is implicitly bound to **every** queue, with a **routing key equal to the queue name**. It is not possible to explicitly bind to, or unbind from the default exchange. It also cannot be deleted.

å¦‚æœå¸Œæœ›**å¤æ‚**å‘é€ï¼Œæ¯”å¦‚è¿›è¡Œè™šæ‹Ÿä¸»æœºå†…å…¨å¹¿æ’­æˆ–è€…æŒ‡å®šå¤šæ¡é˜Ÿåˆ—ä¼ é€’æ¶ˆæ¯ï¼Œé‚£å°±éœ€è¦å»è‡ªå®šä¹‰äº¤æ¢æœºå¹¶ç»‘å®šé‚£å‡ æ¡é˜Ÿåˆ—ï¼Œç„¶åç”¨clientå°†æ¶ˆæ¯ä¼ é€’ç»™è¿™ä¸ªExchangeä»¥å®Œæˆæ¶ˆæ¯å‘é€ï¼ŒRabbitMQæä¾›çš„å‡ ç§äº¤æ¢æœºç±»å‹ï¼š

| äº¤æ¢æœºç±»å‹     | è‹±æ–‡å    | è·¯ç”±è§„åˆ™                                        | å…¸å‹ç”¨é€”                                           |
| :------------- | :-------- | :---------------------------------------------- | :------------------------------------------------- |
| **ç›´è¿äº¤æ¢æœº** | `Direct`  | **ç²¾ç¡®åŒ¹é…** routing key                        | ç‚¹å¯¹ç‚¹ä»»åŠ¡ã€æŒ‰ç±»å‹åˆ†å‘ï¼ˆå¦‚è®¢å•åˆ›å»º/å–æ¶ˆï¼‰          |
| **æ‰‡å‡ºäº¤æ¢æœº** | `Fanout`  | **å¿½ç•¥ routing keyï¼Œå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—**        | å¹¿æ’­é€šçŸ¥ï¼ˆçŸ­ä¿¡ã€é‚®ä»¶ã€æ—¥å¿—ï¼‰                       |
| **ä¸»é¢˜äº¤æ¢æœº** | `Topic`   | **é€šé…ç¬¦æ¨¡ç³ŠåŒ¹é…** routing key                  | å¤šç»´åº¦åˆ†ç±»ï¼ˆå¦‚ `log.error.api`ã€`stock.usd.nyse`ï¼‰ |
| **å¤´äº¤æ¢æœº**   | `Headers` | **åŸºäºæ¶ˆæ¯ headers å±æ€§åŒ¹é…**ï¼ˆé routing keyï¼‰ | å¤æ‚æ¡ä»¶è·¯ç”±ï¼ˆæå°‘ä½¿ç”¨ï¼‰                           |

> å…¶å®å¯ä»¥å°†äº¤æ¢æœºçœ‹ä½œä¸€ç§ç»™é˜Ÿåˆ—ä¼ é€’æ¶ˆæ¯çš„**ç­–ç•¥**

å¯¹äºJavaçš„Clientï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨`rabbitTemplate.convertAndSend()`å»å‘é€ç»™**äº¤æ¢æœº**å¹¶å¸¦ä¸Š**RoutingKey**å’Œ**æ¶ˆæ¯Obj**å³å¯ã€‚

**æ¶ˆè´¹è€…ï¼š**åªç®¡ç›‘å¬è‡ªå·±è´Ÿè´£æ¶ˆè´¹çš„é˜Ÿåˆ—å³å¯ï¼š

```java
@RabbitListener(queues = "{é˜Ÿåˆ—name}")
public void listen4({è®¾ç½®çš„å¯¹åº”æ¶ˆæ¯Objç±»å‹} message) {
    // å¯¹åº”ä¸šåŠ¡
}
```



### ä»£ç å£°æ˜é˜Ÿåˆ—åŠäº¤æ¢æœº

äººå·¥åˆ°å¯è§†åŒ–webç•Œé¢ä¸­å»è¿›è¡Œæ“ä½œè¿˜æ˜¯å¤ªæ…¢å¤ªlowäº†ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥é€šè¿‡amqpæä¾›çš„æ¥å£å®ç°äº¤æ¢æœºä»¥åŠé˜Ÿåˆ—çš„ç”Ÿæˆï¼Œè¿˜å¯ä»¥ç®¡ç†ä»–ä»¬ä¹‹é—´çš„è¿æ¥ä»¥åŠé…ç½®è§„åˆ™RoutingKeyï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦åœ¨æ¶ˆè´¹è€…æœåŠ¡å¯åŠ¨æ—¶ç”Ÿæˆå³å¯ã€‚

#### åŸºäºBeanå£°æ˜

åºŸè¯ä¸å¤šè¯´ï¼Œè§ä»£ç ï¼š

```java
@Configuration
public class FanoutConfig {

    @Bean
    public FanoutExchange fanoutExchange() {
        return new FanoutExchange("fanout.exchange");
    }

    @Bean
    public Queue fanoutQueue1() {
        return new Queue("fanout.queue1");
    }

    @Bean
    public Binding fanoutBinding1(Queue fanoutQueue1, FanoutExchange fanoutExchange) {
        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);
    }

}
```

> `@Bean`æ³¨è§£å¿…é¡»åœ¨`@Configuration`ç±»ä¸­æ‰ä¼šè¢«æ‰«æ

å¯ä»¥çœ‹åˆ°ç”šè‡³è¿**Binding**ä¹Ÿæ˜¯ä½œä¸º**Beanå®ä¾‹**è¢«å£°æ˜å‡ºæ¥çš„ã€‚

----

å¦‚æœæ˜¯**Direct**ç±»å‹ï¼š

```java
@Bean
public DirectExchange directExchange() {
    return new DirectExchange("direct.exchange");
}

@Bean
public Queue directQueue1() {
    return new Queue("direct.queue1");
}

@Bean
public Binding directBinding1(Queue directQueue1, DirectExchange directExchange) {
    return BindingBuilder.bind(directQueue1).to(directExchange).with("123");
}
```

ç»‘å®šæ—¶ä½¿ç”¨**with**æŒ‡å®š**RoutingKey**å³å¯ã€‚

----

ç”Ÿæˆç»‘å®šæ—¶ä½¿ç”¨äº†Binding**Builder**è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå…¶å®åœ¨äº¤æ¢æœºä»¥åŠé˜Ÿåˆ—ä¸Šä¹Ÿå¯ä»¥å¦‚æ­¤ï¼š

```java
@Bean
public FanoutExchange fanoutExchange() {
    return ExchangeBuilder.fanoutExchange("fanout.exchange").durable(true).build();
}

@Bean
public Queue fanoutQueue1() {
    return QueueBuilder.durable("fanout.queue1").build();
}
```



#### åŸºäºæ³¨è§£å£°æ˜

ä¸Šé¢çš„Beanå£°æ˜é˜Ÿåˆ—äº¤æ¢æœºä»¥åŠç»‘å®šè¿˜è¦é¢å¤–æä¸€ä¸ªConfigurationï¼Œæœ‰ç‚¹éº»çƒ¦ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç›‘å¬ç±»ä¸­ç›´æ¥ä¸€æ­¥åˆ°ä½ï¼š

```java
@RabbitListener(bindings = @QueueBinding(
        value = @Queue(name = "direct.queue1"),
        exchange = @Exchange(name = "hmall.direct", type = ExchangeTypes.DIRECT),
        key = {"red", "blue"}
))
public void listenDirectQueue1(String msg){
    System.out.println("æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
}

@RabbitListener(bindings = @QueueBinding(
        value = @Queue(name = "direct.queue2"),
        exchange = @Exchange(name = "hmall.direct", type = ExchangeTypes.DIRECT),
        key = {"red", "yellow"}
))
public void listenDirectQueue2(String msg){
    System.out.println("æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
}
```

> ç±»å‹é»˜è®¤ä¸ºDIRECT

ä¹Ÿå¯ä»¥ä½¿ç”¨TOPICï¼š

```Java
@RabbitListener(bindings = @QueueBinding(
    value = @Queue(name = "topic.queue1"),
    exchange = @Exchange(name = "hmall.topic", type = ExchangeTypes.TOPIC),
    key = "china.#"
))
public void listenTopicQueue1(String msg){
    System.out.println("æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
}

@RabbitListener(bindings = @QueueBinding(
    value = @Queue(name = "topic.queue2"),
    exchange = @Exchange(name = "hmall.topic", type = ExchangeTypes.TOPIC),
    key = "#.news"
))
public void listenTopicQueue2(String msg){
    System.out.println("æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
}
```

FANOUTä¹Ÿæ˜¯åŒç†ï¼ˆä¸”ä¸éœ€è¦keyï¼‰ï¼Œåªéœ€æ ¹æ®äº¤æ¢æœºç±»å‹è¿›è¡Œtypeçš„ä¿®æ”¹å³å¯ã€‚



### æ¶ˆæ¯å†…å®¹åºåˆ—åŒ–

ç”Ÿäº§è€…ä½¿ç”¨convertAndSendå‘é€æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬å‘ç°æ¶ˆæ¯å†…å®¹æ˜¯Objectï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸æ‡‚é‚£å¯ä»¥ä½¿ç”¨Stringä»¥åŠIntegerç­‰ç±»å‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªå®šçš„æ•°æ®ç»“æ„æ¥ä¼ è¾“æ•°æ®ï¼Œè¿™æ—¶å€™å°±éœ€è¦åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–äº†ã€‚åŸç‰ˆä½¿ç”¨çš„æ˜¯**`SimpleMessageConverter`**ï¼Œè¿™ç©æ„åŸºäºJDKè‡ªå·±å®ç°çš„åºåˆ—åŒ–å®ç°ï¼ŒJDKè‡ªå¸¦çš„åºåˆ—åŒ–å¸¦æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š

- æ•°æ®ä½“ç§¯è¿‡å¤§
- æœ‰å®‰å…¨æ¼æ´
- å¯è¯»æ€§å·®

é‚£ä¹ˆæˆ‘ä»¬å°±å¾—æ¢ä¸€ä¸ªåºåˆ—åŒ–å™¨ï¼šJackson2JsonMessageConverterï¼Œé¦–å…ˆå¼•å…¥jacksonçš„ä¾èµ–ï¼š

```XML
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
    <version>2.9.10</version>
</dependency>
```

ç„¶ååœ¨ä¸€ä¸ª`@Configuration`ç±»ä¸­æ³¨å…¥ä¸€ä¸ªBeanå³å¯å®Œæˆåºåˆ—åŒ–å™¨çš„é…ç½®ï¼š

```Java
@Bean
public MessageConverter messageConverter(){
    // 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨
    Jackson2JsonMessageConverter jackson2JsonMessageConverter = new Jackson2JsonMessageConverter();
    // 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯
    jackson2JsonMessageConverter.setCreateMessageIds(true);
    return jackson2JsonMessageConverter;
}
```

> åœ¨ `spring-boot-starter-amqp` ä¸­ï¼Œé»˜è®¤ä½¿ç”¨ï¼š
>
> - **`SimpleMessageConverter`**ï¼ˆæ—§ç‰ˆï¼‰æˆ–
> - **`Jackson2JsonMessageConverter`**ï¼ˆæ¨èï¼ŒSpring Boot 2.0+ è‡ªåŠ¨é…ç½®ï¼‰
>
> ä¹Ÿå³åªè¦ä½¿ç”¨äº†2.0+çš„`spring-boot-starter-web`å°±è‡ªåŠ¨é…ç½®Jacksonäº†ã€‚



### MQçš„åº”ç”¨åœºæ™¯

é¦–å…ˆæ˜¯**ä¸é€‚åˆ**çš„åœºæ™¯ï¼š

| åœºæ™¯                           | åŸå›                          |
| :----------------------------- | :--------------------------- |
| å¼ºä¸€è‡´æ€§è¦æ±‚ï¼ˆå¦‚é“¶è¡Œæ ¸å¿ƒäº¤æ˜“ï¼‰ | MQ é€šå¸¸åªä¿è¯æœ€ç»ˆä¸€è‡´        |
| è¶…ä½å»¶è¿Ÿè¦æ±‚ï¼ˆ<1msï¼‰           | ç½‘ç»œ + æŒä¹…åŒ–å¸¦æ¥é¢å¤–å¼€é”€    |
| ç®€å•å•ä½“åº”ç”¨                   | å¼•å…¥ MQ å¢åŠ å¤æ‚åº¦ï¼Œå¾—ä¸å¿å¤± |

**è¿™æ ·çš„åœºæ™¯å°½é‡é¿å…ä½¿ç”¨MQ**å¹³ç™½æ— æ•…å¢åŠ å¤æ‚åº¦ï¼

MQçš„æ ¸å¿ƒæ˜¯**å¼‚æ­¥**ï¼Œå°†æœ¬æ¬¡ä¸šåŠ¡é€»è¾‘ä¸­**ä¸æ˜¯å¿…é¡»ç«‹åˆ»å®Œæˆå¹¶è¿”å›çš„æ“ä½œ**äº¤ç»™æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰åé¢å†è¯´ï¼Œä¹Ÿå³**ä¸é˜»å¡å½“å‰çº¿ç¨‹**ã€‚
ç¬¦åˆè¿™ä¸€è¦æ±‚çš„ä¸šåŠ¡æ“ä½œéƒ½å¯ä»¥è€ƒè™‘ä½¿ç”¨MQè¿›è¡Œä¼˜åŒ–ï¼š

| **åœºæ™¯éœ€æ±‚**      | **æ ¸å¿ƒç›®çš„**         | **å…¸å‹ç¤ºä¾‹**                                        |
| :---------------- | :------------------- | :-------------------------------------------------- |
| **ç³»ç»Ÿè§£è€¦**      | æ¶ˆé™¤æœåŠ¡é—´å¼ºä¾èµ–     | ç”¨æˆ·æ³¨å†Œ â†’ é‚®ä»¶æœåŠ¡ã€ç§¯åˆ†æœåŠ¡ã€æ—¥å¿—æœåŠ¡å„è‡ªç‹¬ç«‹æ¶ˆè´¹ |
| **å¼‚æ­¥å¤„ç†**      | æå‡å“åº”é€Ÿåº¦ä¸ååé‡ | ä¸‹å•åç«‹å³è¿”å›ï¼Œåå°å¼‚æ­¥æ‰£åº“å­˜ã€å‘é€šçŸ¥              |
| **æµé‡å‰Šå³°**      | æŠµå¾¡çªå‘é«˜å¹¶å‘       | ç§’æ€è¯·æ±‚å…ˆå…¥é˜Ÿï¼Œè®¢å•æœåŠ¡åŒ€é€Ÿå¤„ç†                    |
| **æœ€ç»ˆä¸€è‡´æ€§**    | è·¨æœåŠ¡æ•°æ®ä¸€è‡´       | æ”¯ä»˜æˆåŠŸ â†’ å‘æ¶ˆæ¯ â†’ åº“å­˜æœåŠ¡æ‰£å‡ï¼ˆå¤±è´¥å¯é‡è¯•ï¼‰      |
| **äº‹ä»¶å¹¿æ’­**      | ä¸€å¯¹å¤šé€šçŸ¥           | é…ç½®æ›´æ–°äº‹ä»¶ â†’ æ‰€æœ‰å¾®æœåŠ¡ç›‘å¬å¹¶åˆ·æ–°ç¼“å­˜             |
| **ä»»åŠ¡é˜Ÿåˆ—**      | åå°æ‰§è¡Œè€—æ—¶ä½œä¸š     | è§†é¢‘ä¸Šä¼  â†’ å…¥é˜Ÿ â†’ è½¬ç æœåŠ¡å¼‚æ­¥å¤„ç†                  |
| **æ—¥å¿—/æ•°æ®ç®¡é“** | é«˜ååæ•°æ®æ”¶é›†       | åº”ç”¨æ—¥å¿— â†’ MQ â†’ ELK æˆ– Flink å®æ—¶åˆ†æ               |

æ³¨æ„ä»¥ä¸‹å¸¸è¸©çš„å‘ï¼š

| é£é™©         | è§£å†³æ–¹æ¡ˆ                                                     |
| :----------- | :----------------------------------------------------------- |
| **æ¶ˆæ¯ä¸¢å¤±** | - æ¶ˆæ¯æŒä¹…åŒ– - ç”Ÿäº§è€…ç¡®è®¤ï¼ˆPublisher Confirmï¼‰ - æ¶ˆè´¹è€…æ‰‹åŠ¨ ACK |
| **é‡å¤æ¶ˆè´¹** | - æ¶ˆè´¹è€…å®ç°**å¹‚ç­‰æ€§**ï¼ˆå¦‚ç”¨è®¢å•IDå»é‡ï¼‰                     |
| **é¡ºåºé”™ä¹±** | - å•é˜Ÿåˆ—å•æ¶ˆè´¹è€…ä¿åº - æˆ–ç”¨ RocketMQ/Kafka åˆ†åŒºä¿åº          |
| **è°ƒè¯•å›°éš¾** | - å®Œå–„æ—¥å¿—è¿½è¸ªï¼ˆTraceID é€ä¼ ï¼‰ - ä½¿ç”¨æ¶ˆæ¯è½¨è¿¹å·¥å…·            |
| **è¿‡åº¦å¼‚æ­¥** | - ä¸è¦æ‰€æœ‰æ“ä½œéƒ½å¼‚æ­¥ï¼æ ¸å¿ƒæ­¥éª¤ï¼ˆå¦‚æ‰£æ¬¾ï¼‰ä»éœ€åŒæ­¥æ ¡éªŒ         |

æœ€åè™½ç„¶æˆ‘ä»¬å¯ä»¥åœ¨æ¶ˆè´¹è€…æœåŠ¡ä¸­è¿›è¡ŒäºŒæ¬¡æ ¡éªŒï¼Œä½†è¿˜æ˜¯å°½é‡é¿å…å‡ºç°**è¿‡æ—©æäº¤å¼‚æ­¥æ“ä½œ**ï¼Œç»“æœåé¢å½“å‰çº¿ç¨‹ä¸šåŠ¡**å‡ºé”™å¯¼è‡´éœ€è¦å›æ»š**çš„æƒ…å†µå‡ºç°ï¼Œè€ƒè™‘å°†å¼‚æ­¥æ“ä½œçš„æäº¤æ”¾åˆ°**å®Œå…¨æ ¡éªŒçš„åé¢**ï¼

> **â€œåªæœ‰å½“æœ¬åœ°ä¸šåŠ¡é€»è¾‘ï¼ˆåŒ…æ‹¬æ•°æ®åº“äº‹åŠ¡ï¼‰å®Œå…¨æˆåŠŸæäº¤åï¼Œæ‰å‘é€å¼‚æ­¥æ¶ˆæ¯ã€‚â€**
> **ç»ä¸èƒ½åœ¨äº‹åŠ¡æäº¤å‰å‘æ¶ˆæ¯ï¼Œå¦åˆ™ä¼šå¯¼è‡´ã€Œæ•°æ®ä¸ä¸€è‡´ã€ã€‚**



### ç”Ÿäº§è€…å¯é æ€§

æœ‰æ—¶**ç”Ÿäº§è€…å‘é€æ¶ˆæ¯**ä¼šå‡ºç°æ„å¤–ï¼ŒRabbitMQæä¾›äº†ä¸€äº›å¤„ç†æ–¹æ¡ˆï¼š

#### ç”Ÿäº§è€…é‡è¯•

æœ‰æ—¶å€™ç”Ÿäº§è€…ä¼šå’ŒMQæ–­è¿ï¼Œè¿™æ—¶å€™å°±éœ€è¦**è‡ªåŠ¨é‡è¿**ï¼Œè€Œä¸”ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¹Ÿä¼šå‡ºç°æ— æ³•åˆ°è¾¾çš„æƒ…å†µï¼Œè¿™æ—¶å€™ä¹Ÿéœ€è¦**æ¶ˆæ¯é‡è¯•**ï¼š

```YAML
spring:
  rabbitmq:
    connection-timeout: 1s # è®¾ç½®MQçš„è¿æ¥è¶…æ—¶æ—¶é—´
    template:
      retry:
        enabled: true # å¼€å¯è¶…æ—¶é‡è¯•æœºåˆ¶
        initial-interval: 1000ms # å¤±è´¥åçš„åˆå§‹ç­‰å¾…æ—¶é—´
        multiplier: 1 # å¤±è´¥åä¸‹æ¬¡çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = initial-interval * multiplier
        max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
```

å°±æ˜¯**æ¶ˆæ¯æ²¡å‘æˆåŠŸå°±é‡è¯•**

> ä»¥ä¸Šä¸ºé»˜è®¤é…ç½®ï¼Œå¦‚æœ‰éœ€æ±‚å¯ä»¥å£°æ˜ä¿®æ”¹



#### ç”Ÿäº§è€…ç¡®è®¤

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªè¦ç”Ÿäº§è€…ä¸MQä¹‹é—´çš„ç½‘è·¯è¿æ¥é¡ºç•…ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºç°å‘é€æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ— éœ€è€ƒè™‘è¿™ç§é—®é¢˜ã€‚
ä¸è¿‡ï¼Œåœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šå‡ºç°æ¶ˆæ¯å‘é€åˆ°MQä¹‹åä¸¢å¤±çš„ç°è±¡ï¼Œæ¯”å¦‚ï¼š

- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°`Exchange`
- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„`Exchange`åï¼Œæœªæ‰¾åˆ°åˆé€‚çš„`Queue`ï¼Œå› æ­¤æ— æ³•è·¯ç”±ï¼ˆ**è·¯ç”±å¤±è´¥**ï¼‰
- MQå†…éƒ¨å¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿäº†å¼‚å¸¸

é’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼ŒRabbitMQæä¾›äº†ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬`Publisher Confirm`å’Œ`Publisher Return`ä¸¤ç§ã€‚åœ¨å¼€å¯ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQåï¼ŒMQä¼šæ ¹æ®æ¶ˆæ¯å¤„ç†çš„æƒ…å†µè¿”å›ä¸åŒçš„**å›æ‰§**ã€‚

- å½“æ¶ˆæ¯æŠ•é€’åˆ°MQï¼Œä½†æ˜¯**è·¯ç”±å¤±è´¥**æ—¶ï¼Œé€šè¿‡**Publisher Return**è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ—¶è¿”å›ackçš„ç¡®è®¤ä¿¡æ¯ï¼Œä»£è¡¨æŠ•é€’æˆåŠŸ
- ä¸´æ—¶æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜ŸæˆåŠŸï¼Œè¿”å›ACKï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ
- æŒä¹…æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜Ÿå®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›ACK ï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ
- å…¶å®ƒæƒ…å†µéƒ½ä¼šè¿”å›NACKï¼Œå‘ŠçŸ¥æŠ•é€’å¤±è´¥

> å…¶ä¸­`ack`å’Œ`nack`å±äº**Publisher Confirm**æœºåˆ¶ï¼Œ`ack`æ˜¯æŠ•é€’æˆåŠŸï¼›`nack`æ˜¯æŠ•é€’å¤±è´¥ã€‚
> è€Œ`return`åˆ™å±äº**Publisher Return**æœºåˆ¶ã€‚
>
> æ³¨æ„ï¼**`Return` å’Œ `Confirm` å¯ä»¥åŒæ—¶å‘ç”Ÿ**ï¼Œå®ƒä»¬è§£å†³çš„æ˜¯**ä¸åŒé˜¶æ®µçš„é—®é¢˜**ã€‚

è¦æƒ³å¼€å¯ç”Ÿäº§è€…ç¡®è®¤ï¼Œåªéœ€è¦åˆ°ymlé…ç½®æ–‡ä»¶ä¸­ï¼š

```YAML
spring:
  rabbitmq:
    publisher-confirm-type: correlated # å¼€å¯publisher confirmæœºåˆ¶ï¼Œå¹¶è®¾ç½®confirmç±»å‹
    publisher-returns: true # å¼€å¯publisher returnæœºåˆ¶
```

è¿™é‡Œ`publisher-confirm-type`æœ‰ä¸‰ç§æ¨¡å¼å¯é€‰ï¼š

- `none`ï¼šå…³é—­confirmæœºåˆ¶
- `simple`ï¼šåŒæ­¥é˜»å¡ç­‰å¾…MQçš„å›æ‰§
- `correlated`ï¼šMQå¼‚æ­¥å›è°ƒè¿”å›å›æ‰§

åŒæ—¶amqpä¹Ÿæä¾›äº†return callbackçš„è®°å½•æ¥å£å¸®åŠ©æˆ‘ä»¬è®°å½•æ—¥å¿—ï¼š

```java
@Slf4j
@AllArgsConstructor
@Configuration
public class MqConfig {
    private final RabbitTemplate rabbitTemplate;

    @PostConstruct
    public void init(){
        rabbitTemplate.setReturnsCallback(new RabbitTemplate.ReturnsCallback() {
            @Override
            public void returnedMessage(ReturnedMessage returned) {
                log.error("è§¦å‘return callback,");
                log.debug("exchange: {}", returned.getExchange());
                log.debug("routingKey: {}", returned.getRoutingKey());
                log.debug("message: {}", returned.getMessage());
                log.debug("replyCode: {}", returned.getReplyCode());
                log.debug("replyText: {}", returned.getReplyText());
            }
        });
    }
}
```

è¿™æ ·Clientå°±ä¼šåœ¨æ¥æ”¶åˆ°return callbackæ—¶å°†å­¦ä¹ å†…å®¹è®°å½•åˆ°logä¸­ã€‚

åŒæ ·çš„ï¼Œä¹Ÿç»™confirmå‡†å¤‡äº†å°è£…å¥½çš„å¯¹è±¡ä»¥ä¾›æˆ‘ä»¬æŸ¥çœ‹ackï¼š

```Java
@Test
void testPublisherConfirm() {
    // 1.åˆ›å»ºCorrelationData
    CorrelationData cd = new CorrelationData();
    // 2.ç»™Futureæ·»åŠ ConfirmCallback
    cd.getFuture().addCallback(new ListenableFutureCallback<CorrelationData.Confirm>() {
        @Override
        public void onFailure(Throwable ex) {
            // 2.1.Futureå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¤„ç†é€»è¾‘ï¼ŒåŸºæœ¬ä¸ä¼šè§¦å‘
            log.error("send message fail", ex);
        }
        @Override
        public void onSuccess(CorrelationData.Confirm result) {
            // 2.2.Futureæ¥æ”¶åˆ°å›æ‰§çš„å¤„ç†é€»è¾‘ï¼Œå‚æ•°ä¸­çš„resultå°±æ˜¯å›æ‰§å†…å®¹
            if(result.isAck()){ // result.isAck()ï¼Œbooleanç±»å‹ï¼Œtrueä»£è¡¨ackå›æ‰§ï¼Œfalse ä»£è¡¨ nackå›æ‰§
                log.debug("å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ”¶åˆ° ack!");
            }else{ // result.getReason()ï¼ŒStringç±»å‹ï¼Œè¿”å›nackæ—¶çš„å¼‚å¸¸æè¿°
                log.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæ”¶åˆ° nack, reason : {}", result.getReason());
            }
        }
    });
    // 3.å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("hmall.direct", "q", "hello", cd);
}
```

> å°±æ˜¯å¯¹å¼‚æ­¥çš„é˜»å¡è·å–ç»“æœï¼Œç±»ä¼¼jsçš„Promiseï¼š
>
> | æ¦‚å¿µ               | Javaï¼ˆSpring / RabbitMQï¼‰                                   | JavaScript / é€šç”¨å¹¶å‘æ¨¡å‹        | ä½œç”¨                   |
> | :----------------- | :---------------------------------------------------------- | :------------------------------- | :--------------------- |
> | **å¼‚æ­¥æ“ä½œå‘èµ·è€…** | `rabbitTemplate.convertAndSend(..., correlationData)`       | `fetch(url)` / `someAsyncTask()` | å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡       |
> | **ç»“æœå ä½ç¬¦**     | `CorrelationData.getFuture()` â†’ `ListenableFuture<Confirm>` | `Promise`                        | ä»£è¡¨â€œå°†æ¥ä¼šæœ‰ä¸€ä¸ªç»“æœâ€ |
> | **ç»“æœå›è°ƒ**       | `addCallback(onSuccess, onFailure)`                         | `.then().catch()` æˆ– `await`     | å¤„ç†æˆåŠŸæˆ–å¤±è´¥         |



### MQå¯é æ€§

æœ‰æ—¶MQæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œä½†è¿˜æ˜¯ä¼šå‡ºç°ä¸€äº›æ„å¤–å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼ŒRabbitMQä¹Ÿæä¾›äº†å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼š

#### æ•°æ®æŒä¹…åŒ–

ä¸ºäº†æå‡æ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹MQçš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜å­˜å‚¨çš„ä¸´æ—¶æ•°æ®ï¼Œé‡å¯åå°±ä¼šæ¶ˆå¤±ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œå¿…é¡»é…ç½®æ•°æ®æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ï¼š

- äº¤æ¢æœºæŒä¹…åŒ–
- é˜Ÿåˆ—æŒä¹…åŒ–
- æ¶ˆæ¯æŒä¹…åŒ–

å®é™…ä¸Šåœ¨æˆ‘ä»¬åˆ›å»ºäº¤æ¢æœºï¼Œé˜Ÿåˆ—çš„æ—¶å€™é»˜è®¤éƒ½ä¼šé…ç½®æŒä¹…åŒ–ï¼Œå› æ­¤ä¸å¿…å¤ªè¿‡åœ¨æ„ã€‚



#### Lazy Queue

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQä¼šå°†æ¥æ”¶åˆ°çš„ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ä»¥é™ä½æ¶ˆæ¯æ”¶å‘çš„å»¶è¿Ÿã€‚ä½†åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œæ¯”å¦‚ï¼š

- æ¶ˆè´¹è€…å®•æœºæˆ–å‡ºç°ç½‘ç»œæ•…éšœ
- æ¶ˆæ¯å‘é€é‡æ¿€å¢ï¼Œè¶…è¿‡äº†æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦
- æ¶ˆè´¹è€…å¤„ç†ä¸šåŠ¡å‘ç”Ÿé˜»å¡

æŒä¹…åŒ–çš„æ—¶å€™è¿˜éœ€è¦ç£ç›˜IOï¼Œè¿™æ—¶ä¼šå ç”¨ä¸€ç‚¹èµ„æºå¯¼è‡´å¤„ç†èƒ½åŠ›ä¸‹é™ï¼ŒRabbitMQæä¾›äº†**æƒ°æ€§é˜Ÿåˆ—**çš„è§£å†³æ–¹æ¡ˆï¼š

- æ¥æ”¶åˆ°æ¶ˆæ¯å**ç›´æ¥å­˜å…¥ç£ç›˜**è€Œéå†…å­˜
- æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼š**ä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜**ï¼ˆä¹Ÿå°±æ˜¯æ‡’åŠ è½½ï¼Œä¼š**éƒ¨åˆ†ç¼“å­˜ä¸€äº›æ¶ˆæ¯åœ¨å†…å­˜**ï¼‰
- æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨

> è€Œåœ¨3.12ç‰ˆæœ¬ä¹‹åï¼ŒLazyQueueå·²ç»æˆä¸ºæ‰€æœ‰é˜Ÿåˆ—çš„é»˜è®¤æ ¼å¼ã€‚å› æ­¤å®˜æ–¹æ¨èå‡çº§MQä¸º3.12ç‰ˆæœ¬æˆ–è€…æ‰€æœ‰é˜Ÿåˆ—éƒ½è®¾ç½®ä¸ºLazyQueueæ¨¡å¼ã€‚
>
> æ—§ç‰ˆæœ¬æƒ³è¦è®¾ç½®æƒ°æ€§é˜Ÿåˆ—æœ‰ä¸¤ç§æ–¹å¼ï¼š
>
> - å¯è§†åŒ–webç•Œé¢åˆ›å»ºé˜Ÿåˆ—çš„æ—¶å€™å¯ä»¥æŒ‡å®šArgumentä¸­å¸¦ä¸ŠLazy Mode
> - ä»£ç ä¸­å£°æ˜ï¼š
>
> ```Java
> @Bean
> public Queue lazyQueue(){
>     return QueueBuilder
>             .durable("lazy.queue")
>             .lazy() // å¼€å¯Lazyæ¨¡å¼
>             .build();
> }
> ```
>
> æˆ–è€…æ˜¯æ³¨è§£å¼ï¼š
>
> ```Java
> @RabbitListener(queuesToDeclare = @Queue(
>         name = "lazy.queue",
>         durable = "true",
>         arguments = @Argument(name = "x-queue-mode", value = "lazy")
> ))
> public void listenLazyQueue(String msg){
>     log.info("æ¥æ”¶åˆ° lazy.queueçš„æ¶ˆæ¯ï¼š{}", msg);
> }
> ```



### æ¶ˆè´¹è€…å¯é æ€§

ä¸ºäº†é¿å…æ¶ˆæ¯åœ¨æ¶ˆè´¹è€…å±‚é¢å‘ç”Ÿä¸¢å¤±çš„é—®é¢˜ï¼ŒRabbitMQä¹Ÿæä¾›äº†ä¸€å¥—å¤„ç†æ–¹æ¡ˆ:

#### æ¶ˆè´¹è€…ç¡®è®¤

ä¸ºäº†ç¡®è®¤æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸå¤„ç†æ¶ˆæ¯ï¼ŒRabbitMQæä¾›äº†æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ï¼ˆ**Consumer Acknowledgement**ï¼‰ã€‚å³ï¼šå½“æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ç»“æŸåï¼Œåº”è¯¥å‘RabbitMQå‘é€ä¸€ä¸ªå›æ‰§ï¼Œå‘ŠçŸ¥RabbitMQè‡ªå·±æ¶ˆæ¯å¤„ç†çŠ¶æ€ã€‚å›æ‰§æœ‰ä¸‰ç§å¯é€‰å€¼ï¼š

| å›æ‰§       | æ–¹æ³•                                     | ä½œç”¨                     | æ˜¯å¦åˆ é™¤æ¶ˆæ¯ | æ˜¯å¦é‡å…¥é˜Ÿ                |
| :--------- | :--------------------------------------- | :----------------------- | :----------- | :------------------------ |
| **ACK**    | `channel.basicAck(tag, false)`           | æˆåŠŸå¤„ç†                 | âœ… åˆ é™¤       | âŒ                         |
| **NACK**   | `channel.basicNack(tag, false, requeue)` | å¤„ç†å¤±è´¥                 | âŒ ä¸åˆ        | âœ… `requeue=true` æ—¶é‡å…¥é˜Ÿ |
| **Reject** | `channel.basicReject(tag, requeue)`      | æ‹’ç»æ¶ˆæ¯ï¼ˆé€šå¸¸æ ¼å¼é”™è¯¯ï¼‰ | âŒ ä¸åˆ        | âœ… `requeue=true` æ—¶é‡å…¥   |

> æ¶ˆè´¹è€…ä»é˜Ÿåˆ—è·å–åˆ°æ¶ˆæ¯åä¸ä¼šç›´æ¥é€šçŸ¥MQåˆ é™¤è¯¥æ¶ˆæ¯ï¼Œå¾…å®Œæˆè·å–ä»¥åŠä¸šåŠ¡å¤„ç†åå†æ‰‹åŠ¨ackå†ä¼šå®Œæˆåˆ é™¤

amqpä¸­æä¾›äº†å‡ ç§ackç¡®è®¤å¤„ç†æœºåˆ¶ï¼š

| æ¨¡å¼       | é…ç½®                             | è¡Œä¸º                                       | å¯é æ€§ | é€‚ç”¨åœºæ™¯          |
| :--------- | :------------------------------- | :----------------------------------------- | :----- | :---------------- |
| **none**   | `acknowledge-mode: none`         | æ¶ˆæ¯ä¸€æŠ•é€’å°±åˆ é™¤                           | âŒ æä½ | æµ‹è¯•/æ—¥å¿—ï¼ˆå¯ä¸¢ï¼‰ |
| **auto**   | `acknowledge-mode: auto`ï¼ˆé»˜è®¤ï¼‰ | æ— å¼‚å¸¸ â†’ è‡ªåŠ¨ ACKï¼›æœ‰å¼‚å¸¸ â†’ NACKï¼ˆé‡å…¥é˜Ÿï¼‰ | âš ï¸ ä¸­ç­‰ | ç®€å•ä¸šåŠ¡          |
| **manual** | `acknowledge-mode: manual`       | **å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ `basicAck/Nack/Reject`**    | âœ… é«˜   | **ç”Ÿäº§ç¯å¢ƒæ¨è**  |

> ğŸ“Œ **å¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `manual` æ¨¡å¼**ï¼Œå®Œå…¨æŒæ§æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸã€‚

æƒ³è¦å»ä¿®æ”¹æ¨¡å¼ä¹Ÿå¾ˆç®€å•ï¼Œä»…éœ€åˆ°ymlé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼š

```YAML
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: manual # æ‰‹åŠ¨å¤„ç†ï¼Œé…åˆæ‰‹åŠ¨æäº¤ä½¿ç”¨
```

æ‰‹åŠ¨æ¨¡å¼éœ€è¦è‡ªå·±è°ƒç”¨æ¥å£è¿”å›å›æ‰§ï¼š

```java
@RabbitListener(queues = "order.queue")
public void listen(Message message, Channel channel) throws IOException {
    long deliveryTag = message.getMessageProperties().getDeliveryTag();
    
    try {
        // 1. ä¸šåŠ¡å¤„ç†ï¼ˆå¦‚æ‰£åº“å­˜ã€å‘é€šçŸ¥ï¼‰
        processOrder(message);
        
        // 2. æˆåŠŸ â†’ æ‰‹åŠ¨ ACK
        channel.basicAck(deliveryTag, false);
        
    } catch (BusinessException e) {
        // 3. ä¸šåŠ¡å¼‚å¸¸ â†’ æ‹’ç»å¹¶é‡å…¥é˜Ÿï¼ˆå¯é‡è¯•ï¼‰
        channel.basicNack(deliveryTag, false, true);
        
    } catch (Exception e) {
        // 4. ä¸¥é‡å¼‚å¸¸ â†’ æ‹’ç»ä¸”ä¸é‡å…¥é˜Ÿï¼ˆè¿›æ­»ä¿¡é˜Ÿåˆ—ï¼‰
        channel.basicNack(deliveryTag, false, false);
    }
}
```

> å¦‚æ— æ€§èƒ½éœ€æ±‚ï¼Œå°½é‡åœ¨**å®Œæˆæ‰€æœ‰ä¸šåŠ¡å**å†æ‰‹åŠ¨ackæ‰æ¶ˆæ¯



#### æ¶ˆè´¹è€…é‡è¯•

å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ¶ˆè´¹è€…å†æ¬¡æ‰§è¡Œä¾ç„¶å‡ºé”™ï¼Œæ¶ˆæ¯ä¼šå†æ¬¡requeueåˆ°é˜Ÿåˆ—ï¼Œå†æ¬¡æŠ•é€’ï¼Œç›´åˆ°æ¶ˆæ¯å¤„ç†æˆåŠŸä¸ºæ­¢ã€‚

æç«¯æƒ…å†µå°±æ˜¯æ¶ˆè´¹è€…ä¸€ç›´æ— æ³•æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆæ¶ˆæ¯requeueå°±ä¼šæ— é™å¾ªç¯ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ã€‚ä¸ºäº†åº”å¯¹ä¸Šè¿°æƒ…å†µSpringåˆæä¾›äº†æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼šåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶åˆ©ç”¨æœ¬åœ°é‡è¯•ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„requeueåˆ°mqé˜Ÿåˆ—ã€‚

```YAML
spring:
  rabbitmq:
    listener:
      simple:
        retry:
          enabled: true # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•
          initial-interval: 1000ms # åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’
          multiplier: 1 # å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval
          max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
          stateless: true # trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse
```

> **ä¸ºä»€ä¹ˆé˜Ÿåˆ—å‘é€æ¶ˆæ¯çš„é‡è¯•è®¾ç½®æ˜¯åœ¨æ¶ˆè´¹è€…é…ç½®çš„ï¼Ÿå‡å¦‚å‡ ä¸ªæ¶ˆè´¹è€…é‡è¯•é…ç½®ä¸ä¸€æ ·ä¼šæ€ä¹ˆæ ·ï¼Ÿ**
>
> **è¿™ä¸ª `retry` é…ç½®ç¡®å®æ˜¯â€œæ¶ˆè´¹è€…æœ¬åœ°çš„é‡è¯•â€ï¼Œä¸æ˜¯â€œé˜Ÿåˆ—â€çš„å±æ€§ï¼Œä¹Ÿä¸æ˜¯â€œç”Ÿäº§è€…â€çš„è¡Œä¸ºã€‚**
> å®ƒæ§åˆ¶çš„æ˜¯ï¼š**å½“æŸä¸ªæ¶ˆè´¹è€…å®ä¾‹åœ¨å¤„ç†æ¶ˆæ¯æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ˜¯å¦åœ¨æœ¬æœºé‡è¯•ï¼Œä»¥åŠé‡è¯•å‡ æ¬¡ã€‚**
>
> - **å®ƒå±äºæ¶ˆè´¹è€…åº”ç”¨çš„é…ç½®**
> - **ä¸åŒæ¶ˆè´¹è€…å¯ä»¥æœ‰ä¸åŒçš„é‡è¯•ç­–ç•¥**
> - **RabbitMQ é˜Ÿåˆ—æœ¬èº«å®Œå…¨ä¸çŸ¥é“è¿™ä¸ªé…ç½®çš„å­˜åœ¨**
>
> **`spring.rabbitmq.listener.simple.retry` æ˜¯â€œæ¶ˆè´¹è€…å¯¹è‡ªå·±è¯´ï¼šæˆ‘å†è¯•å‡ æ¬¡â€ï¼Œè€Œä¸æ˜¯â€œé˜Ÿåˆ—è¦æ±‚æ‰€æœ‰æ¶ˆè´¹è€…é‡è¯•â€ã€‚**

åœ¨é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åæ¶ˆæ¯å°±ä¼šä¸¢å¤±ï¼Œè¿™æ—¶å€™éœ€è¦æ—¥å¿—è®°å½•ä¹‹ç±»çš„æˆ‘ä»¬å°±éœ€è¦åˆ°amqpæä¾›çš„æ¥å£ä¸­è¿›è¡Œæ“ä½œï¼ŒSpringå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°è€—å°½åçš„æ¶ˆæ¯å¤„ç†ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç”±`MessageRecovery`æ¥å£æ¥å®šä¹‰çš„ï¼Œå®ƒæœ‰3ä¸ªä¸åŒå®ç°ï¼š

-  `RejectAndDontRequeueRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥`reject`ï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚**é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼** 
-  `ImmediateRequeueMessageRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œè¿”å›`nack`ï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ 
-  `RepublishMessageRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº 

æ¯”è¾ƒä¼˜é›…çš„ä¸€ç§å¤„ç†æ–¹æ¡ˆæ˜¯`RepublishMessageRecoverer`ï¼Œå¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼ˆ**æ­»ä¿¡é˜Ÿåˆ—**ï¼‰ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚

æƒ³è¦ä½¿ç”¨è¿™ä¸ª`RepublishMessageRecoverer`ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé…ç½®ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ**æ­»ä¿¡é˜Ÿåˆ—**ï¼‰ä¸“é—¨ç”¨äºå­˜å‚¨è¿™äº›å¤±è´¥æ¶ˆæ¯ï¼Œè€Œè¦é…ç½®è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è¦æ±‚æˆ‘ä»¬ä¸€å®šå¾—å…ˆæä¸ªdirectçš„äº¤æ¢æœºï¼ˆ**æ­»ä¿¡äº¤æ¢æœº**ï¼‰ï¼Œå› ä¸º`RepublishMessageRecoverer`åªæ¥å—äº¤æ¢æœºå’Œ`RoutingKey`ä½œä¸ºä¼ å…¥å‚æ•°ï¼š

```Java
@Configuration
@ConditionalOnProperty(name = "spring.rabbitmq.listener.simple.retry.enabled", havingValue = "true")
public class ErrorMessageConfig {
    @Bean
    public DirectExchange errorMessageExchange(){
        return new DirectExchange("error.direct");
    }
    @Bean
    public Queue errorQueue(){
        return new Queue("error.queue", true);
    }
    @Bean
    public Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange){
        return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with("error");
    }
	// é…ç½®é‡è¯•å¤±è´¥å¤„ç†å™¨
    @Bean
    public MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate){
        return new RepublishMessageRecoverer(rabbitTemplate, "error.direct", "error");
    }
}
```

> âŒ **æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰ä¸èƒ½ç›´æ¥ä½¿ç”¨ RabbitMQ çš„ã€Œé»˜è®¤äº¤æ¢æœºï¼ˆDefault Exchangeï¼‰ã€è¿›è¡Œç»‘å®šã€‚**
> âœ… **å¿…é¡»æ˜¾å¼å£°æ˜ä¸€ä¸ªäº¤æ¢æœºï¼ˆå¦‚ `DirectExchange`ã€`TopicExchange` ç­‰ï¼‰å¹¶ç»‘å®šåˆ° DLQã€‚**



#### æ¶ˆæ¯å¹‚ç­‰æ€§

ç†è§£**æ¶ˆæ¯å¹‚ç­‰æ€§**ï¼Œå…³é”®åœ¨äºæŠ“ä½ä¸€å¥è¯ï¼š

> **â€œåŒä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹å¤šæ¬¡ï¼Œå¯¹ç³»ç»Ÿäº§ç”Ÿçš„æœ€ç»ˆç»“æœä¸åªæ¶ˆè´¹ä¸€æ¬¡å®Œå…¨ç›¸åŒã€‚â€**

å®ƒä¸æ˜¯ MQ çš„åŠŸèƒ½ï¼Œè€Œæ˜¯**æ¶ˆè´¹è€…ä¸šåŠ¡é€»è¾‘å¿…é¡»å…·å¤‡çš„æ€§è´¨**ï¼Œç”¨æ¥åº”å¯¹**æ¶ˆæ¯é‡å¤æŠ•é€’**è¿™ä¸€åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¸¸æ€ã€‚

åœ¨ RabbitMQã€Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œ**æ¶ˆæ¯é‡å¤æ˜¯ä¸å¯é¿å…çš„**ï¼Œå¸¸è§åŸå› åŒ…æ‹¬ï¼š

| åœºæ™¯                            | è¯´æ˜                                                         |
| :------------------------------ | :----------------------------------------------------------- |
| **æ¶ˆè´¹è€…å¤„ç†æˆåŠŸï¼Œä½† ACK ä¸¢å¤±** | æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯ â†’ ç½‘ç»œé—ªæ–­ â†’ ACK æœªé€è¾¾ Broker â†’ Broker é‡å‘ |
| **æ¶ˆè´¹è€…å¤„ç†ä¸­å®•æœº**            | æ¶ˆæ¯å·²å–å‡ºä½†æœª ACK â†’ æ¶ˆè´¹è€…æŒ‚æ‰ â†’ Broker é‡æ–°æŠ•é€’            |
| **ç”Ÿäº§è€…é‡è¯•**                  | ç”Ÿäº§è€…æœªæ”¶åˆ° confirm â†’ é‡å‘ â†’ å®é™… Broker å·²æ¥æ”¶ï¼ˆå¯¼è‡´é‡å¤ï¼‰ |
| **MQ è‡ªèº«é‡è¯•æœºåˆ¶**             | å¦‚ RabbitMQ çš„ `requeue=true` å¯¼è‡´æ¶ˆæ¯é‡å›é˜Ÿåˆ—               |

> ğŸ“Œ **ç»“è®ºï¼šä»»ä½•åŸºäºâ€œè‡³å°‘ä¸€æ¬¡â€ï¼ˆAt-Least-Onceï¼‰è¯­ä¹‰çš„ MQï¼Œéƒ½å¯èƒ½äº§ç”Ÿé‡å¤æ¶ˆæ¯ã€‚**

è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®æˆ‘ä»¬å°±æ˜¯æƒ³è¦ä¸šåŠ¡ä¸ä¼šå› ä¸º**æ„å¤–çš„å¤šæ¬¡æ‰§è¡Œ**å¯¼è‡´é”™è¯¯çš„å‘ç”Ÿï¼ˆä¹Ÿå³æ¶ˆæ¯å¹‚ç­‰æ€§ï¼‰ï¼Œæˆ–è€…è‡³å°‘é¿å…å‡ºç°è¿™ç§**æ„å¤–çš„å¤šæ¬¡æ‰§è¡Œ**ï¼Œå¸¸è§çš„å®ç°æ–¹å¼ï¼š

| æ–¹æ³•                        | é€‚ç”¨åœºæ™¯       | åŸç†                                            |
| :-------------------------- | :------------- | :---------------------------------------------- |
| **1. å”¯ä¸€ä¸šåŠ¡ ID + å»é‡è¡¨** | è®¢å•åˆ›å»ºã€æ”¯ä»˜ | æ•°æ®åº“å”¯ä¸€ç´¢å¼• / Redis SETNX                    |
| **2. çŠ¶æ€æœºæ ¡éªŒ**           | è®¢å•çŠ¶æ€æµè½¬   | åªå…è®¸â€œå¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜â€ï¼Œé‡å¤â€œå·²æ”¯ä»˜â€æ¶ˆæ¯è¢«å¿½ç•¥ |
| **3. ä¹è§‚é”CAPï¼ˆç‰ˆæœ¬å·ï¼‰**  | æ›´æ–°æ“ä½œ       | `UPDATE ... WHERE version = oldVersion`         |
| **4. Token æœºåˆ¶**           | å‰ç«¯é˜²é‡æäº¤   | æäº¤æ—¶æºå¸¦ tokenï¼ŒæœåŠ¡ç«¯æ ¡éªŒåå¤±æ•ˆ              |

> **â€œMQ ä¸ä¿è¯ä¸é‡å¤ï¼Œä½ å¿…é¡»ä¿è¯ä¸æ€•é‡å¤ã€‚â€**



### å»¶è¿Ÿæ¶ˆæ¯

#### æ­»ä¿¡äº¤æ¢æœº

ä¸€æ¡æ¶ˆæ¯åœ¨ä»¥ä¸‹ **ä»»æ„ä¸€ç§æƒ…å†µ** ä¸‹ä¼šå˜æˆâ€œ**æ­»ä¿¡**â€ï¼š

| è§¦å‘æ¡ä»¶                                             | è¯´æ˜                                                         |
| :--------------------------------------------------- | :----------------------------------------------------------- |
| **1. æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆReject / Nackï¼‰ä¸” `requeue=false`** | æ¶ˆè´¹è€…æ˜ç¡®è¡¨ç¤ºâ€œæˆ‘ä¸å¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œä¹Ÿä¸è¦å®ƒé‡å›é˜Ÿåˆ—â€ï¼ˆé‡è¯•å¤±è´¥ï¼‰ |
| **2. æ¶ˆæ¯ TTLï¼ˆTime-To-Liveï¼‰è¿‡æœŸ**                  | æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å­˜æ´»æ—¶é—´è¶…è¿‡è®¾å®šå€¼ï¼ˆå¦‚ 10 ç§’æœªè¢«æ¶ˆè´¹ï¼‰           |
| **3. é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼ˆx-max-lengthï¼‰**              | é˜Ÿåˆ—æ»¡äº†ï¼Œæ–°æ¶ˆæ¯è¿›æ¥ä¼šæŒ¤æ‰é˜Ÿé¦–æ¶ˆæ¯ â†’ è¢«æŒ¤æ‰çš„æ¶ˆæ¯å˜æ­»ä¿¡      |

> ğŸ“Œ æ³¨æ„ï¼š**åªæœ‰é…ç½®äº†æ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰çš„é˜Ÿåˆ—ï¼Œæ‰ä¼šå°†æ­»ä¿¡è½¬å‘ï¼›å¦åˆ™ç›´æ¥ä¸¢å¼ƒï¼**

æ­»ä¿¡æµç¨‹ï¼š

```mermaid
graph LR
A[ç”Ÿäº§è€…] -->|å‘é€æ¶ˆæ¯| B(ä¸šåŠ¡é˜Ÿåˆ—: order.queue)
B -->|æ­£å¸¸æ¶ˆè´¹| C[æ¶ˆè´¹è€…]
B -->|æ¶ˆæ¯å˜æ­»ä¿¡| D[æ­»ä¿¡äº¤æ¢æœº: dlx]
D -->|è·¯ç”±| E[æ­»ä¿¡é˜Ÿåˆ—: dlq.order]
E --> F[ç›‘æ§/é‡è¯•/äººå·¥å¤„ç†]
```

è¦æƒ³åœ¨ä»£ç ä¸­å¤„ç†æ­»ä¿¡ï¼Œåªéœ€è¦å‡†å¤‡å¥½æ­»ä¿¡äº¤æ¢æœºä»¥åŠæ­»ä¿¡é˜Ÿåˆ—ï¼Œç„¶åå°†éœ€è¦å¤„ç†æ­»ä¿¡çš„é˜Ÿåˆ—ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šå³å¯ï¼š

```java
@Configuration
public class DirectConfig {

    @Bean
    public DirectExchange dlxExchange() {   // åˆ›å»ºæ­»ä¿¡äº¤æ¢æœº
        return ExchangeBuilder.
                directExchange("dlx.direct").
                build();
    }
    
    @Bean
    public Queue dlxQueue() {   // åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—
        return QueueBuilder.
                durable("dlx.queue").
                build();
    }
    
    @Bean
    public Binding bindingDlxQueue() {  // ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—
        return BindingBuilder.
                bind(dlxQueue()).
                to(dlxExchange()).
                with("dlx");
    }

    @Bean
    public DirectExchange directExchange() {
        return ExchangeBuilder.
                directExchange("hmall.direct").
                build();
    }

    @Bean
    public Queue directQueue() {    // åˆ›å»ºé˜Ÿåˆ—ï¼Œç»‘å®šæ­»ä¿¡äº¤æ¢æœº
        return QueueBuilder.
                durable("direct.queue").
                deadLetterExchange("dlx.direct").			// ç»‘å®šæ­»ä¿¡äº¤æ¢æœº
                deadLetterRoutingKey("dlx").				// å£°æ˜RoutingKeyå¯¼å‘æŒ‡å®šçš„æ­»ä¿¡é˜Ÿåˆ—
                build();
    }
    
    @Bean
    public Binding bindingDirectQueue() {
        return BindingBuilder.
                bind(directQueue()).
                to(directExchange()).
                with("red");
    }
}
```

é€šè¿‡`deadLetterExchange`å°±å¯ä»¥å°†è‡ªåˆ¶çš„é˜Ÿåˆ—å’Œæ­»ä¿¡äº¤æ¢æœºç»‘å®šäº†ã€‚

è€Œæƒ³è¦å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±åªéœ€è¦åœ¨ä¸€ä¸ªè®¾ç½®äº†ttlçš„æ­£å¸¸é˜Ÿåˆ—ï¼ˆ**ä½†æ˜¯æ²¡äººç›‘å¬å¯¼è‡´å¿…å®šè¿‡æœŸ**ï¼‰ï¼Œttlåˆ°æœŸåè§¦å‘æ­»ä¿¡æœºåˆ¶ï¼Œå°†æ¶ˆæ¯å‘ç»™æ­»ä¿¡äº¤æ¢æœºï¼Œäº¤æ¢æœºæ ¹æ®RoutingKeyå‘ç»™æŒ‡å®šçš„æ­»ä¿¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ­»ä¿¡é˜Ÿåˆ—æ˜¯æœ‰æ¶ˆè´¹è€…ç›‘å¬å¤„ç†çš„ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦å°†æ— äººç›‘å¬çš„é˜Ÿåˆ—åŠ ä¸ªttlå³å¯å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼š

```java
@Bean
public Queue directQueue() {    					// åˆ›å»ºæ— äººç›‘å¬çš„ttlé˜Ÿåˆ—
    return QueueBuilder.
            durable("direct.queue").
            deadLetterExchange("dlx.direct").		// ç»‘å®šæ­»ä¿¡äº¤æ¢æœº
            deadLetterRoutingKey("dlx").			// è®¾ç½®RoutingKey
            ttl(10000).								// è®¾ç½®å»¶è¿Ÿæ—¶é—´ttl
            build();
}
```

> æ™®é€šçš„é˜Ÿåˆ—å¯ä»¥ç»‘å®šå¤šä¸ªäº¤æ¢æœºï¼Œé‚£**å¯ä»¥ç»‘å®šå¤šä¸ªæ­»ä¿¡äº¤æ¢æœºå—ï¼Ÿ**
>
> **ä¸å¯ä»¥ã€‚ä¸€ä¸ª RabbitMQ é˜Ÿåˆ—åªèƒ½ç»‘å®šä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰ã€‚**
>
> | å‚æ•°                        | ç±»å‹       | è¯´æ˜                                                         |
> | :-------------------------- | :--------- | :----------------------------------------------------------- |
> | `x-dead-letter-exchange`    | **String** | æ­»ä¿¡ç›®æ ‡äº¤æ¢æœºåç§°ï¼ˆåªèƒ½ä¸€ä¸ªï¼‰                               |
> | `x-dead-letter-routing-key` | String     | è½¬å‘æ­»ä¿¡æ—¶ä½¿ç”¨çš„ routing keyï¼ˆå¯é€‰ï¼Œé»˜è®¤ç”¨åŸæ¶ˆæ¯çš„ routing keyï¼‰ |
>
> ğŸ“Œ ä½ æ— æ³•ä¸ºä¸€ä¸ªé˜Ÿåˆ—è®¾ç½®å¤šä¸ª `x-dead-letter-exchange`ã€‚
>
> **é‚£å¦‚æœæˆ‘æƒ³æŠŠæ­»ä¿¡è·¯ç”±åˆ°å¤šä¸ªåœ°æ–¹æ€ä¹ˆåŠï¼Ÿ**
>
> è™½ç„¶**ä¸€ä¸ªé˜Ÿåˆ—åªèƒ½æœ‰ä¸€ä¸ª DLX**ï¼Œä½†ä½ å¯ä»¥é€šè¿‡å°†æ­»ä¿¡äº¤æ¢æœºè®¾ç½®ä¸º**fanout**æˆ–è€…å‡†å¤‡**å¤šä¸ªRoutingKeyç›¸åŒçš„æ­»ä¿¡é˜Ÿåˆ—çš„Direct**æ¥å®ç°**å°†æ­»ä¿¡å‘é€ç»™å¤šä¸ªé˜Ÿåˆ—**ã€‚
>
> äº¤æ¢æœºåªæ˜¯å‘é€ç»™é˜Ÿåˆ—çš„**ç­–ç•¥**ï¼Œæœ€ç»ˆæˆ‘ä»¬è¿˜æ˜¯è¦å‘ç»™å¹²å®äº‹çš„**é˜Ÿåˆ—**



#### å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶

åŸºäºæ­»ä¿¡é˜Ÿåˆ—è™½ç„¶å¯ä»¥å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†æ˜¯å¤ªéº»çƒ¦äº†ã€‚å› æ­¤RabbitMQç¤¾åŒºæä¾›äº†ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶æ¥å®ç°ç›¸åŒçš„æ•ˆæœï¼Œå…¶å…è®¸æ¶ˆæ¯è¢«æš‚æ—¶å­˜å‚¨åœ¨äº¤æ¢æœºä¸­ï¼Œå»¶æ—¶æŠ•é€’åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼š

å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼š[Scheduling Messages with RabbitMQ | RabbitMQ](https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq)

ä¸‹è½½åœ°å€ï¼š[rabbitmq/rabbitmq-delayed-message-exchange: Delayed Messaging for RabbitMQ](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange)

> å·²ç»**archived**äº†

ä½¿ç”¨dockeréƒ¨ç½²ï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹æŒ‚è½½çš„æ•°æ®å·ï¼š

```Shell
docker volume inspect mq-plugins
```

```JSON
[
    {
        "CreatedAt": "2024-06-19T09:22:59+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/mq-plugins/_data",
        "Name": "mq-plugins",
        "Options": null,
        "Scope": "local"
    }
]
```

```bash
cd /var/lib/docker/volumes/mq-plugins/_data
```

ç„¶åå°†æ’ä»¶æ–‡ä»¶ä¼ åˆ°æ•°æ®å·ä¸­ï¼Œå¹¶å®‰è£…æ’ä»¶ï¼š

```bash
docker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange
```

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ç”¨ä»£ç åˆ›å»ºå‡ ä¸ªäº¤æ¢æœºä»¥åŠé˜Ÿåˆ—äº†ï¼š

**æ³¨è§£ä¸€æ­¥åˆ°ä½ï¼š**

```Java
@RabbitListener(bindings = @QueueBinding(
        value = @Queue(name = "delay.queue", durable = "true"),
        exchange = @Exchange(name = "delay.direct", delayed = "true"),
        key = "delay"
))
public void listenDelayMessage(String msg){
    log.info("æ¥æ”¶åˆ°delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š{}", msg);
}
```

**Beanå£°æ˜ï¼š**

```java
@Slf4j
@Configuration
public class DelayExchangeConfig {

    @Bean
    public DirectExchange delayExchange(){
        return ExchangeBuilder
                .directExchange("delay.direct") // æŒ‡å®šäº¤æ¢æœºç±»å‹å’Œåç§°
                .delayed() // è®¾ç½®delayçš„å±æ€§ä¸ºtrue
                .durable(true) // æŒä¹…åŒ–
                .build();
    }

    @Bean
    public Queue delayedQueue(){
        return new Queue("delay.queue");
    }
    
    @Bean
    public Binding delayQueueBinding(){
        return BindingBuilder.bind(delayedQueue()).to(delayExchange()).with("delay");
    }
}
```

åç»­å‘é€æ¶ˆæ¯æ—¶æ³¨æ„å¸¦ä¸Šttlï¼š

```Java
@Test
void testPublisherDelayMessage() {
    // 1.åˆ›å»ºæ¶ˆæ¯
    String message = "hello, delayed message";
    // 2.å‘é€æ¶ˆæ¯ï¼Œåˆ©ç”¨æ¶ˆæ¯åç½®å¤„ç†å™¨æ·»åŠ æ¶ˆæ¯å¤´
    rabbitTemplate.convertAndSend("delay.direct", "delay", message, new MessagePostProcessor() {
        @Override
        public Message postProcessMessage(Message message) throws AmqpException {
            // æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯å±æ€§
            message.getMessageProperties().setDelay(5000);
            return message;
        }
    });
}
```

> å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“è¡¨ï¼ŒåŒæ—¶ä½¿ç”¨Elang TimersåŠŸèƒ½å®ç°è®¡æ—¶ã€‚å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å †ç§¯çš„å»¶è¿Ÿæ¶ˆæ¯éå¸¸å¤šï¼Œä¼šå¸¦æ¥è¾ƒå¤§çš„CPUå¼€é”€ï¼ŒåŒæ—¶å»¶è¿Ÿæ¶ˆæ¯çš„æ—¶é—´ä¼šå­˜åœ¨è¯¯å·®ã€‚
>
> å› æ­¤ï¼Œ**ä¸å»ºè®®è®¾ç½®å»¶è¿Ÿæ—¶é—´è¿‡é•¿çš„å»¶è¿Ÿæ¶ˆæ¯**ã€‚
