---
title: ElasticSearch
date: 2026-2-12
---

Elasticsearchï¼ˆç®€ç§° ESï¼‰æ˜¯ä¸€ç§åˆ†å¸ƒå¼ã€å¯æ‰©å±•ã€å®æ—¶çš„æœç´¢ä¸åˆ†æå¼•æ“ï¼ŒåŸºäº Apache Lucene æ„å»ºã€‚å®ƒä¹‹æ‰€ä»¥è¢«å¹¿æ³›é‡‡ç”¨ï¼Œæ˜¯å› ä¸ºåœ¨ç°ä»£åº”ç”¨ä¸­ï¼Œä¼ ç»Ÿçš„æ•°æ®åº“ï¼ˆå¦‚å…³ç³»å‹æ•°æ®åº“ï¼‰åœ¨å¤„ç†**å…¨æ–‡æœç´¢**ã€**é«˜å¹¶å‘æŸ¥è¯¢**ã€**å¤§è§„æ¨¡æ•°æ®åˆ†æ**ç­‰åœºæ™¯æ—¶å­˜åœ¨æ˜æ˜¾å±€é™ã€‚

| éœ€æ±‚/ç—›ç‚¹            | ä¼ ç»Ÿæ•°æ®åº“çš„å±€é™                   | Elasticsearch çš„ä¼˜åŠ¿                         |
| :------------------- | :--------------------------------- | :------------------------------------------- |
| **å…¨æ–‡æœç´¢**         | ä¸æ”¯æŒåˆ†è¯ã€**æ¨¡ç³Š**åŒ¹é…å¼±ã€æ€§èƒ½å·® | æ”¯æŒåˆ†è¯ã€é«˜äº®ã€ç›¸å…³æ€§æ’åºã€æ¯«ç§’çº§å“åº”       |
| **å¤§æ•°æ®é‡**æŸ¥è¯¢     | æŸ¥è¯¢æ…¢ï¼Œéš¾ä»¥æ‰©å±•                   | åˆ†å¸ƒå¼æ¶æ„ï¼Œæ°´å¹³æ‰©å±•ï¼ŒTB çº§æ•°æ®å¿«é€Ÿæ£€ç´¢      |
| **å®æ—¶æ€§**è¦æ±‚       | å†™å…¥åæ— æ³•ç«‹å³æŸ¥è¯¢                 | è¿‘å®æ—¶ç´¢å¼•ï¼ˆé»˜è®¤1ç§’å†…å¯æŸ¥ï¼‰                  |
| **éç»“æ„åŒ–**æ•°æ®å¤„ç† | éš¾ä»¥å­˜å‚¨å’ŒæŸ¥è¯¢æ—¥å¿—ã€æ–‡æœ¬ç­‰         | åŸç”Ÿæ”¯æŒ JSONã€æ–‡æœ¬ã€æ—¥å¿—ç­‰åŠ/éç»“æ„åŒ–æ•°æ®   |
| **æ•°æ®åˆ†æä¸èšåˆ**   | èšåˆå¤æ‚ã€æ€§èƒ½ä½                   | å¼ºå¤§çš„èšåˆåŠŸèƒ½ï¼Œæ”¯æŒå¤šç»´å®æ—¶åˆ†æ             |
| é«˜å¯ç”¨ä¸å®¹é”™         | éœ€é¢å¤–é…ç½®ä¸»ä»ã€å¤‡ä»½               | è‡ªåŠ¨åˆ†ç‰‡+å‰¯æœ¬ï¼ŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ¢å¤              |
| ç”Ÿæ€é›†æˆ             | æ—¥å¿—ã€ç›‘æ§éœ€è‡ªå»ºç³»ç»Ÿ               | ä¸ Logstashã€Kibanaã€Beats ç­‰æ— ç¼é›†æˆï¼ˆELKï¼‰ |

> âœ… **ä¸€å¥è¯æ€»ç»“**ï¼šå½“ä½ çš„åº”ç”¨éœ€è¦â€œå¿«ã€å‡†ã€å…¨â€çš„æœç´¢æˆ–å®æ—¶åˆ†æèƒ½åŠ›æ—¶ï¼ŒElasticsearch æ˜¯ç†æƒ³é€‰æ‹©ã€‚

**ä¸»è¦åº”ç”¨åœºæ™¯ï¼š**

| åœºæ™¯         | è¯´æ˜                              |
| :----------- | :-------------------------------- |
| ç”µå•†æœç´¢     | å•†å“å…³é”®è¯æœç´¢ã€ç­›é€‰ã€æ’åºã€æ¨è  |
| æ—¥å¿—åˆ†æ     | æ”¶é›†æœåŠ¡å™¨/åº”ç”¨æ—¥å¿—ï¼Œå¿«é€Ÿæ’æŸ¥é—®é¢˜ |
| ä¼ä¸šçŸ¥è¯†åº“   | å¿«é€Ÿæ£€ç´¢æ–‡æ¡£ã€é‚®ä»¶ã€FAQ           |
| ç›‘æ§å‘Šè­¦     | å®æ—¶åˆ†ææŒ‡æ ‡ï¼Œè§¦å‘å¼‚å¸¸å‘Šè­¦        |
| åœ°ç†ä½ç½®æœåŠ¡ | æŸ¥æ‰¾é™„è¿‘é—¨åº—ã€è·¯çº¿è§„åˆ’            |

å®˜æ–¹è¯´æ˜æ–‡æ¡£ï¼š[å’Œ Elasticsearch äº¤äº’ | Elasticsearch: æƒå¨æŒ‡å— | Elastic](https://www.elastic.co/guide/cn/elasticsearch/guide/current/_talking_to_elasticsearch.html)

**ELKç»„åˆï¼š**

| ç»„ä»¶  | å…¨ç§°              | ä½œç”¨                                                         |
| :---- | :---------------- | :----------------------------------------------------------- |
| **E** | **Elasticsearch** | åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ï¼Œç”¨äº**å­˜å‚¨**ã€**ç´¢å¼•**å’Œå¿«é€Ÿ**æŸ¥è¯¢**æ—¥å¿—æ•°æ® |
| **L** | **Logstash**      | **æ•°æ®æ”¶é›†**ã€å¤„ç†å’Œä¼ è¾“ç®¡é“ï¼Œæ”¯æŒä»å¤šç§æ¥æºé‡‡é›†ã€è¿‡æ»¤ã€è½¬æ¢å¹¶å‘é€åˆ° Elasticsearch |
| **K** | **Kibana**        | **å¯è§†åŒ–ç•Œé¢**ï¼Œç”¨äºæŸ¥è¯¢ã€åˆ†æã€å±•ç¤º Elasticsearch ä¸­çš„æ•°æ®ï¼ˆå¦‚å›¾è¡¨ã€ä»ªè¡¨ç›˜ï¼‰ |

> è¿‘å¹´æ¥ï¼Œ**Beats**ï¼ˆè½»é‡çº§æ•°æ®é‡‡é›†å™¨ï¼‰å¸¸è¢«åŠ å…¥ï¼Œå½¢æˆ **ELK + Beats** æˆ–ç§°ä¸º **Elastic Stack**ã€‚



## é…ç½®ä¸å®‰è£…

ç”¨dockerå®‰è£…éƒ¨ç½²å°±éå¸¸ç®€å•ï¼š

```Bash
docker run -d \
  --name es \
  -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
  -e "discovery.type=single-node" \
  -v es-data:/usr/share/elasticsearch/data \
  -v es-plugins:/usr/share/elasticsearch/plugins \
  --privileged \
  --network hm-net \
  -p 9200:9200 \
  -p 9300:9300 \
  elasticsearch:7.12.1
```

> è¢«å¢™å°±å»æ‰¾taråŒ…èµ„æºä½¿ç”¨ï¼š
>
> ```bash
> docker load -i [taråŒ…åç§°]
> ```
>
> æ¥å®ç°é•œåƒè·å–

kibanaä¹Ÿæ˜¯åŒç†ï¼š

```Bash
docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es:9200 \
--network=hm-net \
-p 5601:5601  \
kibana:7.12.1
```

> æ³¨æ„å‚æ•°ELASTICSEARCH_HOSTSé‡Œä¹‹æ‰€ä»¥å¯ä»¥ç›´æ¥å†™esä½œä¸ºipæ˜¯å› ä¸ºåœ¨åŒä¸€ç½‘æ¡¥ä¸­ï¼Œå¯ä»¥ç›´æ¥å†™dockerçš„**å®¹å™¨åç§°**

æˆ‘ä»¬å¯ä»¥åŸºäºkibanaå‘é€**httpè¯·æ±‚**æ¥å®ç°å¯¹esçš„æ“ä½œ



## ç®€è¦è®¤è¯†ES

| æœºåˆ¶              | ä½œç”¨              | å…³é”®ç‰¹ç‚¹                                 |
| :---------------- | :---------------- | :--------------------------------------- |
| **å€’æ’ç´¢å¼•**      | æ”¯æŒå…¨æ–‡æœç´¢      | è¯é¡¹ â†’ æ–‡æ¡£æ˜ å°„ï¼Œæ¯«ç§’çº§æ£€ç´¢              |
| **åˆ†ç‰‡ä¸å‰¯æœ¬**    | æ°´å¹³æ‰©å±• + é«˜å¯ç”¨ | æ•°æ®è‡ªåŠ¨åˆ†å¸ƒï¼Œå¹¶è¡ŒæŸ¥è¯¢ï¼Œæ•…éšœå®¹é”™         |
| **è¿‘å®æ—¶ï¼ˆNRTï¼‰** | å¿«é€Ÿå¯è§å†™å…¥æ•°æ®  | é»˜è®¤ 1 ç§’å¯æœï¼Œå¹³è¡¡æ€§èƒ½ä¸å®æ—¶æ€§          |
| **åˆ†å¸ƒå¼åè°ƒ**    | é›†ç¾¤ä¸€è‡´æ€§ç®¡ç†    | è‡ªåŠ¨ä¸»èŠ‚ç‚¹é€‰ä¸¾ï¼Œé˜²è„‘è£‚ï¼ˆ7.0+ åŸºäº Raftï¼‰ |
| **ç›¸å…³æ€§è¯„åˆ†**    | æ™ºèƒ½æ’åºç»“æœ      | é»˜è®¤ BM25 ç®—æ³•ï¼ŒæŒ‰ `_score` æ’åº         |

### åŸºç¡€æ¦‚å¿µ

esä¸­æ•°æ®ä»¥æ–‡æ¡£ä¸ºä¸€ä¸ªåŸºç¡€å­˜å‚¨å•ä½ï¼ˆç±»ä¼¼æ•°æ®è¡Œï¼‰ï¼Œå­˜å‚¨å½¢å¼æ˜¯jsonï¼š

```json
{
  "id": 1,
  "title": "å¤§ä»½",
  "price": 100
}
```

**å¯¹æ¯”å…³ç³»å‹æ•°æ®åº“çš„æ•°æ®è¡Œè®°å½•ï¼š**

| MySQLï¼ˆå…³ç³»å‹æ•°æ®åº“ï¼‰ | Elasticsearchï¼ˆæ–‡æ¡£æœç´¢å¼•æ“ï¼‰       | è¯´æ˜                                                         |
| :-------------------- | :---------------------------------- | :----------------------------------------------------------- |
| **Tableï¼ˆè¡¨ï¼‰**       | **Indexï¼ˆç´¢å¼•ï¼‰**                   | ç´¢å¼•æ˜¯**æ–‡æ¡£çš„é›†åˆ**ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„â€œè¡¨â€ã€‚ä¾‹å¦‚ï¼š`products` ç´¢å¼•ã€‚ |
| **Rowï¼ˆè¡Œï¼‰**         | **Documentï¼ˆæ–‡æ¡£ï¼‰**                | æ¯æ¡æ•°æ®æ˜¯ä¸€ä¸ª JSON æ–‡æ¡£ï¼Œç›¸å½“äºä¸€è¡Œè®°å½•ã€‚å¦‚ `{ "id": 2, "title": "åä¸ºæ‰‹æœº", "price": 4999 }`ã€‚ |
| **Columnï¼ˆåˆ—ï¼‰**      | **Fieldï¼ˆå­—æ®µï¼‰**                   | æ–‡æ¡£ä¸­çš„é”®å€¼å¯¹ï¼Œå¦‚ `title`ã€`price`ï¼Œå¯¹åº”æ•°æ®åº“çš„åˆ—ã€‚        |
| **Schemaï¼ˆè¡¨ç»“æ„ï¼‰**  | **Mappingï¼ˆæ˜ å°„ï¼‰**                 | å®šä¹‰å­—æ®µçš„æ•°æ®ç±»å‹ï¼ˆå¦‚ textã€keywordã€dateï¼‰ï¼Œæ§åˆ¶å¦‚ä½•å­˜å‚¨å’Œæœç´¢ã€‚ç±»ä¼¼äºæ•°æ®åº“çš„ schemaã€‚ |
| **SQLï¼ˆæŸ¥è¯¢è¯­è¨€ï¼‰**   | **DSLï¼ˆDomain Specific Languageï¼‰** | Elasticsearch ä½¿ç”¨åŸºäº JSON çš„ DSL æŸ¥è¯¢è¯­æ³•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå…¨æ–‡æ£€ç´¢ã€èšåˆåˆ†æç­‰ã€‚ |

mappingæ˜ å°„ï¼š

```json
PUT /products
{
  "mappings": {
    "properties": {
      "id": { "type": "integer" },
      "title": { "type": "text", "analyzer": "ik_max_word" },
      "price": { "type": "integer" }
    }
  }
}
```

è¡¥å……ï¼š

| æ¦‚å¿µ              | è¯¦ç»†è§£é‡Š                                                     |
| :---------------- | :----------------------------------------------------------- |
| **JSON æ–‡æ¡£**     | ES ä¸­æ‰€æœ‰æ•°æ®ä»¥ JSON æ ¼å¼å­˜å‚¨ï¼Œæ”¯æŒåµŒå¥—ç»“æ„ã€æ•°ç»„ç­‰å¤æ‚ç±»å‹ã€‚ |
| **åŠ¨æ€æ˜ å°„**      | é»˜è®¤æƒ…å†µä¸‹ï¼ŒES ä¼šè‡ªåŠ¨æ¨æ–­å­—æ®µç±»å‹ï¼ˆå¦‚ string â†’ text/keywordï¼‰ï¼Œä¹Ÿå¯æ‰‹åŠ¨å®šä¹‰ mappingã€‚ |
| **æ— ä¸¥æ ¼ Schema** | å¯æ’å…¥ä¸åŒç»“æ„çš„æ–‡æ¡£åˆ°åŒä¸€ä¸ªç´¢å¼•ï¼ˆä½†å»ºè®®ç»Ÿä¸€ç»“æ„ï¼‰ã€‚         |
| **åˆ†ç‰‡ä¸å‰¯æœ¬**    | ES æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸€ä¸ªç´¢å¼•å¯æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå¹¶è®¾ç½®å‰¯æœ¬ï¼ˆreplicaï¼‰ä¿è¯é«˜å¯ç”¨ã€‚ |



### å€’æ’ç´¢å¼•

**å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰** æ˜¯æœç´¢å¼•æ“ï¼ˆå¦‚ Elasticsearchã€Luceneï¼‰å’Œä¿¡æ¯æ£€ç´¢ç³»ç»Ÿä¸­æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š**æ ¹æ®å…³é”®è¯å¿«é€Ÿæ‰¾åˆ°åŒ…å«è¯¥è¯çš„æ–‡æ¡£**ã€‚

ä¼ ç»Ÿæ•°æ®åº“æ¯”å¦‚mysqlçš„InnoDBåœ¨è¿›è¡Œè¯¸å¦‚æ¨¡ç³ŠæŸ¥æ‰¾çš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯**å…¨è¡¨æ‰«æ**ï¼Œä¸€æ—¦è¡¨ä¸­æ•°æ®é‡è¿‡å¤§æŸ¥è¯¢é€Ÿåº¦å°±ä¼šéå¸¸æ…¢ï¼ˆä¸ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µä¸‹ï¼‰ï¼Œä¸ºä»€ä¹ˆä¼šéœ€è¦å…¨è¡¨æ‰«æï¼Ÿ

> æ¯ä¸€è¡Œæ•°æ®æˆ‘ä»¬ç§°ä¸º**æ–‡æ¡£doc**ï¼ŒæŒ‰è¯­ä¹‰åˆ‡åˆ†çš„æ•°æ®ç§°ä¹‹ä¸º**è¯æ¡term**

- **æ­£æ’ç´¢å¼•ï¼ˆä¼ ç»Ÿæ•°æ®åº“ï¼‰**ï¼š
  `æ–‡æ¡£ID â†’ å†…å®¹`
  ä¾‹å¦‚ï¼šDoc1 â†’ â€œè‹¹æœ é¦™è•‰ æ©™å­â€

â€‹	è¿™æ—¶å€™æˆ‘ä»¬æ— æ³•ä»æœç´¢å†…å®¹**ç›´æ¥å¯¼å‘**æŸä¸ªå«è¯¥å†…å®¹çš„æ•°æ®é¡¹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¿…é¡»**ä¸€ä¸ªä¸€ä¸ª**æå–æ•°æ®é¡¹ï¼Œè¿›è¡Œæ¯”è¾ƒçœ‹æ˜¯å¦å«æœç´¢å†…å®¹ã€‚

- **å€’æ’ç´¢å¼•ï¼ˆæœç´¢å¼•æ“ï¼‰**ï¼š
  `å…³é”®è¯ â†’ åŒ…å«è¯¥è¯çš„æ–‡æ¡£åˆ—è¡¨`
  ä¾‹å¦‚ï¼š
  - â€œè‹¹æœâ€ â†’ [Doc1, Doc3]
  - â€œé¦™è•‰â€ â†’ [Doc1, Doc2]

> âœ… è¿™å°±æ˜¯â€œå€’æ’â€â€”â€”æŠŠå¸¸è§„çš„â€œæ–‡æ¡£æ‰¾è¯â€åè¿‡æ¥å˜æˆâ€œè¯æ‰¾æ–‡æ¡£â€ã€‚

ä¹Ÿå³eså¯¹æ•°æ®çš„ç´¢å¼•ä¸ä»…ä»…æ˜¯å¯¹æ•°æ®çš„æ’åºï¼Œè¿˜**å¯¹æŸä¸€é¡¹æ•°æ®å†…éƒ¨çš„è¯æ¡åšäº†ä¸€ä¸ªç»Ÿè®¡ç´¢å¼•**ï¼Œè¿™æ ·çš„åº”ç”¨åœºæ™¯ï¼š

| åœºæ™¯     | ä¼ ç»Ÿæ–¹å¼ï¼ˆå¦‚ SQL LIKEï¼‰  | å€’æ’ç´¢å¼•                         |
| :------- | :----------------------- | :------------------------------- |
| å…¨æ–‡æœç´¢ | å…¨è¡¨æ‰«æï¼ŒO(N) æ…¢        | ç›´æ¥æŸ¥è¯å…¸ï¼ŒO(1) å¿«              |
| å¤§æ•°æ®é‡ | æ€§èƒ½æ€¥å‰§ä¸‹é™             | åˆ†å¸ƒå¼+å‹ç¼©ï¼Œè½»æ¾åº”å¯¹ TB çº§      |
| é«˜çº§åŠŸèƒ½ | ä¸æ”¯æŒåˆ†è¯ã€é«˜äº®ã€ç›¸å…³æ€§ | æ”¯æŒåˆ†è¯ã€çŸ­è¯­åŒ¹é…ã€è¯„åˆ†ã€é«˜äº®ç­‰ |



### IKåˆ†è¯å™¨

å…ˆå‰æˆ‘ä»¬æåˆ°äº†esé€šè¿‡ç»™æŸä¸€åˆ—æ•°æ®è¿›è¡Œ**å…³é”®è¯ç»Ÿè®¡ç´¢å¼•**ï¼Œç”¨è¿™ç§æ–¹å¼æ¥å®ç°äº†**å…³é”®è¯å¿«é€ŸåŒ¹é…**çš„æœç´¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆæ‹†åˆ†æ•°æ®ï¼Œåˆ†å‡ºç²¾ç¡®çš„å…³é”®è¯å‘¢ï¼Ÿ

**IK åˆ†è¯å™¨ï¼ˆIK Analyzerï¼‰** æ˜¯ Elasticsearch ä¸­æœ€å¸¸ç”¨çš„ **ä¸­æ–‡åˆ†è¯æ’ä»¶**ï¼Œä¸“ä¸ºä¸­æ–‡æ–‡æœ¬è®¾è®¡ï¼Œæ”¯æŒ**ç»†ç²’åº¦åˆ‡åˆ†ï¼ˆik_max_wordï¼‰** å’Œ **æ™ºèƒ½ç²—ç²’åº¦åˆ‡åˆ†ï¼ˆik_smartï¼‰** ä¸¤ç§æ¨¡å¼ã€‚

Elasticsearch é»˜è®¤ä½¿ç”¨ **Standard Analyzer**ï¼Œå®ƒæŒ‰ç©ºæ ¼å’Œæ ‡ç‚¹åˆ‡åˆ†ï¼Œå¯¹ä¸­æ–‡æ•ˆæœæå·®ï¼š

- è¾“å…¥ï¼š`"ä¸­åäººæ°‘å…±å’Œå›½æˆç«‹75å‘¨å¹´"`
- Standard åˆ†è¯ç»“æœï¼š`["ä¸­åäººæ°‘å…±å’Œå›½æˆç«‹75å‘¨å¹´"]`ï¼ˆæ•´ä¸ªå¥å­å½“ä¸€ä¸ªè¯ï¼ï¼‰

è€Œ IK èƒ½æ­£ç¡®åˆ‡åˆ†ä¸ºï¼š

- `ik_smart` â†’ `["ä¸­åäººæ°‘å…±å’Œå›½", "æˆç«‹", "75", "å‘¨å¹´"]`
- `ik_max_word` â†’ æ›´ç»†ï¼Œå¦‚ `["ä¸­å", "åäºº", "äººæ°‘", "å…±å’Œå›½", "æˆç«‹", "75", "å‘¨å¹´", ...]`

> âœ… ä¸­æ–‡æ²¡æœ‰å¤©ç„¶åˆ†éš”ç¬¦ï¼Œå¿…é¡»ä¾èµ–ä¸“ä¸šåˆ†è¯å™¨ï¼ŒIK å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚

| æ¨¡å¼              | ç‰¹ç‚¹                           | é€‚ç”¨åœºæ™¯                     |
| :---------------- | :----------------------------- | :--------------------------- |
| **`ik_smart`**    | **æœ€å°‘åˆ‡åˆ†**ï¼Œè¯­ä¹‰å®Œæ•´ï¼Œè¯æ•°å°‘ | æœç´¢ï¼ˆé¿å…è¿‡åº¦æ‹†åˆ†å¯¼è‡´å™ªå£°ï¼‰ |
| **`ik_max_word`** | **æœ€ç»†åˆ‡åˆ†**ï¼Œç©·å°½æ‰€æœ‰å¯èƒ½è¯   | ç´¢å¼•ï¼ˆæé«˜å¬å›ç‡ï¼‰           |

**å®‰è£…IKåˆ†è¯å™¨ï¼š**

**æ–¹å¼ä¸€ï¼šåœ¨çº¿å®‰è£…ï¼š**

```Shell
docker exec -it es ./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip
```

ç„¶åé‡å¯å³å¯ï¼š

```Shell
docker restart es
```

**æ–¹å¼äºŒï¼šç¦»çº¿å®‰è£…ï¼š**

å…ˆå‰æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªæ•°æ®å·`es-plugins`è®©dockerå¸®æˆ‘ä»¬ä¸“é—¨ç»´æŠ¤åœ¨esçš„æ’ä»¶æ–‡ä»¶å¤¹ï¼š

```Shell
docker volume inspect es-plugins
```

```json

[
    {
        "CreatedAt": "2026-02-12T16:55:08+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/es-plugins/_data",
        "Name": "es-plugins",
        "Options": null,
        "Scope": "local"
    }
]

```

æ¥åˆ°æ•°æ®å·æ–‡ä»¶å¤¹ï¼š

```bash
cd /var/lib/docker/volumes/es-plugins/_data
```

å°†ç¦»çº¿è·å–åˆ°çš„IKåˆ†è¯å™¨æ–‡ä»¶ä¼ å…¥å…¶ä¸­ï¼Œç„¶åé‡å¯åŠ è½½æ’ä»¶ï¼š

> esæ’ä»¶ä¸‹è½½åœ°å€ï¼š[Index of: analysis-ik/stable/](https://release.infinilabs.com/analysis-ik/stable/)ï¼ˆè®°å¾—å¯¹ç…§ç‰ˆæœ¬ï¼‰

```bash
docker restart es
```

----

ç„¶åæˆ‘ä»¬ç®€å•å°è¯•ä¸€ä¸‹ï¼Œæ‰“å¼€kibanaçš„devç•Œé¢ï¼š[Dev Tools - Elastic](http://192.168.0.200:5601/app/dev_tools#/console)ï¼Œè¾“å…¥æµ‹è¯•æ ·ä¾‹ï¼š

```cmd
POST /_analyze
{
  "analyzer": "standard",
  "text": "é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ javaå¤ªæ£’äº†"
}
```

ç„¶åä¼šå‘ç°standardçº§åˆ«çš„åˆ†è¯å™¨å…¨éƒ¨å­—ç¬¦éƒ½è¢«åˆ†å¼€äº†ï¼Œè¿™æ˜¾ç„¶å¤ªä¸€èˆ¬ï¼Œæˆ‘ä»¬æ¢æˆik_smartï¼š

```cmd
POST /_analyze
{
  "analyzer": "standard",
  "text": "é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ javaå¤ªæ£’äº†"
}
```

å¾—åˆ°ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "é»‘é©¬",
      "start_offset" : 0,
      "end_offset" : 2,
      "type" : "CN_WORD",
      "position" : 0
    },
    {
      "token" : "ç¨‹åºå‘˜",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "å­¦ä¹ ",
      "start_offset" : 5,
      "end_offset" : 7,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "java",
      "start_offset" : 7,
      "end_offset" : 11,
      "type" : "ENGLISH",
      "position" : 3
    },
    {
      "token" : "å¤ªæ£’äº†",
      "start_offset" : 11,
      "end_offset" : 14,
      "type" : "CN_WORD",
      "position" : 4
    }
  ]
}

```

ä½†æ˜¯åªæ˜¯å°†ä¸€ä¸ªå¥å­ç›´æ¥å‡ åˆ€åˆ‡å®Œä¹Ÿä¸å¤ªè¡Œï¼Œå¯¹äºä¸€ä¸ªè¯å…¶å®å¯ä»¥å†åšç²¾ç»†åŒ–ï¼Œæ¯”å¦‚â€ç¨‹åºå‘˜â€œè¿˜å¯ä»¥å†åˆ†å‡ºâ€œç¨‹åºâ€æ¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥é€‰æ‹©`ik_max_word`çº§åˆ«çš„ï¼š

```cmd
POST /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ javaå¤ªæ£’äº†"
}
```

å¾—åˆ°ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "é»‘é©¬",
      "start_offset" : 0,
      "end_offset" : 2,
      "type" : "CN_WORD",
      "position" : 0
    },
    {
      "token" : "ç¨‹åºå‘˜",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "ç¨‹åº",
      "start_offset" : 2,
      "end_offset" : 4,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "å‘˜",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 3
    },
    {
      "token" : "å­¦ä¹ ",
      "start_offset" : 5,
      "end_offset" : 7,
      "type" : "CN_WORD",
      "position" : 4
    },
    {
      "token" : "java",
      "start_offset" : 7,
      "end_offset" : 11,
      "type" : "ENGLISH",
      "position" : 5
    },
    {
      "token" : "å¤ªæ£’äº†",
      "start_offset" : 11,
      "end_offset" : 14,
      "type" : "CN_WORD",
      "position" : 6
    },
    {
      "token" : "å¤ªæ£’",
      "start_offset" : 11,
      "end_offset" : 13,
      "type" : "CN_WORD",
      "position" : 7
    },
    {
      "token" : "äº†",
      "start_offset" : 13,
      "end_offset" : 14,
      "type" : "CN_CHAR",
      "position" : 8
    }
  ]
}
```

æœ‰æ—¶å€™ä¸‰ç§åˆ†è¯æ¨¡å¼éƒ½æ˜¯ä¸å¤Ÿç”¨çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–çš„æ‰©å±•è¯å…¸ï¼Œæ‰“å¼€æˆ‘ä»¬çš„**ikæ’ä»¶æ–‡ä»¶å¤¹**ï¼Œæ‰¾åˆ°**config**ç›®å½•çš„`IKAnalyzer.cfg.xml`æ–‡ä»¶è¿›è¡Œé…ç½®ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>IK Analyzer æ‰©å±•é…ç½®</comment>
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•å­—å…¸ -->
	<entry key="ext_dict"></entry>
	 <!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•åœæ­¢è¯å­—å…¸-->
	<entry key="ext_stopwords"></entry>
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è¿œç¨‹æ‰©å±•å­—å…¸ -->
	<!-- <entry key="remote_ext_dict">words_location</entry> -->
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è¿œç¨‹æ‰©å±•åœæ­¢è¯å­—å…¸-->
	<!-- <entry key="remote_ext_stopwords">words_location</entry> -->
</properties>
```

æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªé¢å¤–æ‰©å±•è¯æ±‡å­—å…¸`ext.dic`ï¼š

```
æŒ–æ˜æœº
å¤§è¨è¾¾
å•Šå‘é¡ºä¸°
```

åªéœ€**æŒ‰è¡Œè¾“å…¥**æ‰€éœ€è¦çš„è¯æ±‡å³å¯ã€‚

ç„¶åé…ç½®åˆ°cfgçš„xmlæ–‡ä»¶ä¸­ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>IK Analyzer æ‰©å±•é…ç½®</comment>
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•å­—å…¸ -->
	<entry key="ext_dict">ext.dic</entry>
	 <!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•åœæ­¢è¯å­—å…¸-->
	<entry key="ext_stopwords"></entry>
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è¿œç¨‹æ‰©å±•å­—å…¸ -->
	<!-- <entry key="remote_ext_dict">words_location</entry> -->
	<!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è¿œç¨‹æ‰©å±•åœæ­¢è¯å­—å…¸-->
	<!-- <entry key="remote_ext_stopwords">words_location</entry> -->
</properties>
```

ç„¶åé‡å¯åŠ è½½é…ç½®å³å¯ã€‚



## æ•°æ®æ“ä½œ

### Mappingæ˜ å°„

å…ˆå‰æˆ‘ä»¬æåˆ°å°†åŒä¸€ç±»ï¼ˆå­—æ®µåï¼Œç±»å‹ä¸€è‡´ï¼‰çš„æ–‡æ¡£ï¼ˆjsonæ•°æ®ï¼‰å½’ä¸ºåŒä¸€ä¸ªç´¢å¼•ï¼ˆåº“ï¼‰ï¼Œè¿™ç§å½’ä¸ºåŒä¸€ç´¢å¼•çš„åˆ¤æ–­å°±æ˜¯æ˜ å°„Mappingï¼š

**Mappingï¼ˆæ˜ å°„ï¼‰** æ˜¯ Elasticsearch ä¸­å®šä¹‰**ç´¢å¼•ä¸­æ–‡æ¡£ç»“æ„å’Œå­—æ®µæ•°æ®ç±»å‹**çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç›¸å½“äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ **è¡¨ç»“æ„ï¼ˆSchemaï¼‰**ã€‚å®ƒå†³å®šäº†ï¼š

- å­—æ®µä»¥ä»€ä¹ˆç±»å‹å­˜å‚¨ï¼ˆæ–‡æœ¬ï¼Ÿæ•°å­—ï¼Ÿæ—¥æœŸï¼Ÿåœ°ç†ä½ç½®ï¼Ÿï¼‰
- å­—æ®µæ˜¯å¦å¯è¢«æœç´¢ã€æ’åºæˆ–èšåˆ
- ä½¿ç”¨å“ªç§åˆ†è¯å™¨ï¼ˆå¦‚ `ik_max_word`ã€`standard`ï¼‰
- æ˜¯å¦å¯ç”¨å€’æ’ç´¢å¼•ã€æ˜¯å¦å­˜å‚¨åŸå§‹å€¼ç­‰

åŸºæœ¬æ•°æ®ç±»å‹ï¼š

| ç±»å‹                                        | ç”¨é€”                             | ç‰¹ç‚¹                                              |
| :------------------------------------------ | :------------------------------- | :------------------------------------------------ |
| **`text`**                                  | å…¨æ–‡æœç´¢ï¼ˆå¦‚æ–‡ç« å†…å®¹ã€å•†å“æè¿°ï¼‰ | **ä¼šè¢«åˆ†è¯**ï¼Œ**ä¸å¯ç”¨äºæ’åº/èšåˆ**               |
| **`keyword`**                               | ç²¾ç¡®å€¼ï¼ˆå¦‚æ ‡ç­¾ã€çŠ¶æ€ã€IDï¼‰       | **ä¸åˆ†è¯**ï¼Œ**å¯ç”¨äºæ’åºã€èšåˆã€ç²¾ç¡®åŒ¹é…**        |
| **`integer` / `long` / `float` / `double`** | æ•°å€¼                             | æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€èšåˆè®¡ç®—                            |
| **`date`**                                  | æ—¥æœŸæ—¶é—´                         | å¯æŒ‡å®šæ ¼å¼ï¼ˆå¦‚ `"yyyy-MM-dd"`ï¼‰ï¼Œæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| **`boolean`**                               | å¸ƒå°”å€¼                           | `true` / `false`                                  |
| **`geo_point`**                             | åœ°ç†ä½ç½®                         | æ”¯æŒâ€œé™„è¿‘æœç´¢â€ã€åœ°ç†è·ç¦»èšåˆ                      |
| **`nested`**                                | åµŒå¥—å¯¹è±¡æ•°ç»„                     | è§£å†³å¯¹è±¡æ•°ç»„çš„â€œæ‰å¹³åŒ–â€é—®é¢˜                        |
| **`object`**                                | æ™®é€šå¯¹è±¡ï¼ˆé»˜è®¤ï¼‰                 | å†…éƒ¨å­—æ®µå¯ç‹¬ç«‹æŸ¥è¯¢                                |

> ğŸ’¡ **`text` vs `keyword` æ˜¯æœ€å¸¸æ··æ·†çš„ç‚¹ï¼**
>
> - æƒ³æœâ€œæ‰‹æœºâ€ â†’ ç”¨ `text`
> - æƒ³æŒ‰â€œå“ç‰Œ=åä¸ºâ€ç­›é€‰æˆ–ç»Ÿè®¡ â†’ ç”¨ `keyword`

ä¸¾ä¸ªåˆ›å»ºæ˜ å°„çš„ä¾‹å­ï¼š

```json
PUT /my_index
{
  "mappings": {
    "properties": {
      "title": { 
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "category": { 
        "type": "keyword" 
      },
      "price": { 
        "type": "float" 
      },
      "publish_date": { 
        "type": "date",
        "format": "yyyy-MM-dd"
      }
    }
  }
}
```

> mysqlä¹‹ç±»çš„ä¼ ç»Ÿæ•°æ®åº“å®šä¹‰å®Œäº†ä¸€ä¸ª**è¡¨çš„ç»“æ„scheme**ï¼Œä¹Ÿå³åˆ›å»ºå®Œæˆäº†ä¸€ä¸ª**è¡¨**ï¼š
> è¿™é‡Œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå®Œæˆå®šä¹‰ä¸€ä¸ª**ç´¢å¼•çš„æ˜ å°„Mapping**å³åˆ›å»ºäº†ä¸€ä¸ª**ç´¢å¼•ï¼ˆåº“ï¼‰**ï¼Œåå­—æ˜¯my_index
>
> | æ“ä½œ         | MySQL                                         | Elasticsearch                                                |
> | :----------- | :-------------------------------------------- | :----------------------------------------------------------- |
> | åˆ›å»ºè¡¨ç»“æ„   | `CREATE TABLE t (id INT, name VARCHAR(100));` | `PUT /t { "mappings": { "properties": { "id": { "type": "integer" }, "name": { "type": "text" } } } }` |
> | åªå»ºåº“ä¸å»ºè¡¨ | `CREATE DATABASE db;`                         | `PUT /index`ï¼ˆæ—  mappingï¼Œç›¸å½“äºâ€œç©ºè¡¨â€ï¼‰                     |
>
> æ‰€ä»¥ï¼š**å®šä¹‰ mapping å°±åƒ `CREATE TABLE`ï¼Œå®ƒéšå«äº†â€œåˆ›å»ºå­˜å‚¨ç»“æ„â€è¿™ä¸€æ­¥ã€‚**

ç±»ä¼¼jsonï¼Œå­˜å‚¨å•å…ƒæ–‡æ¡£ä¹Ÿå¯ä»¥æœ‰å­å­—æ®µï¼š

```json
"title": {
  "type": "text",
  "analyzer": "ik_max_word",
  "fields": {
    "keyword": { 
      "type": "keyword" 
    }
  }
}
```

ç”šè‡³è¿˜å¯ä»¥æ ¹æ®å­å­—æ®µçš„å±æ€§è¿›è¡Œæœç´¢ï¼š

- æœç´¢ç”¨ï¼š`title`ï¼ˆåˆ†è¯å…¨æ–‡æœï¼‰
- èšåˆç”¨ï¼š`title.keyword`ï¼ˆç²¾ç¡®å€¼ï¼‰



### ç´¢å¼•åº“æ“ä½œ

| **æ“ä½œ**     | **API**                    | **è¯´æ˜**                               |
| ------------ | -------------------------- | -------------------------------------- |
| **åˆ›å»ºç´¢å¼•** | `PUT /index_name`          | **åˆ›å»ºæ–°ç´¢å¼•ï¼Œå¯å¸¦ mapping**           |
| æŸ¥çœ‹ç´¢å¼•     | `GET /index_name`          | **æŸ¥çœ‹ç´¢å¼•æ˜¯å¦å­˜åœ¨åŠçŠ¶æ€**             |
| **æŸ¥çœ‹æ˜ å°„** | `GET /index_name/_mapping` | **æŸ¥çœ‹å­—æ®µç»“æ„**                       |
| åˆ é™¤ç´¢å¼•     | `DELETE /index_name`       | **åˆ é™¤æ•´ä¸ªç´¢å¼•ï¼ˆä¸å¯é€†ï¼‰**             |
| **æ›´æ–°æ˜ å°„** | `PUT /index_name/_mapping` | **åªèƒ½æ–°å¢å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å·²æœ‰å­—æ®µç±»å‹** |
| **æ’å…¥æ–‡æ¡£** | `POST /index_name/_doc/1`  | **å†™å…¥ä¸€æ¡æ•°æ®**                       |
| æŸ¥è¯¢æ–‡æ¡£     | `GET /index_name/_doc/1`   | **è·å–æŒ‡å®šæ–‡æ¡£**                       |
| æ‰¹é‡æ“ä½œ     | `POST /_bulk`              | **æ‰¹é‡æ’å…¥/æ›´æ–°/åˆ é™¤æ–‡æ¡£**             |

> æ¥å£ä»¥RESTfulé£æ ¼è®¾è®¡CRUDï¼š
>
> å¢ï¼šPOST
> åˆ ï¼šDELETE
> æ”¹/å¢ï¼šPUT
> æŸ¥ï¼šGET

**ç¤ºä¾‹ï¼š**

```json
PUT /ç´¢å¼•åº“åç§°
{
  "mappings": {
    "properties": {
      "å­—æ®µå": {
        "type": "text",
        "analyzer": "ik_smart"
      },
      "å­—æ®µå2": {
        "type": "keyword",
        "index": "false"
      },
      "å­—æ®µå3": {
        "properties": {
          "å­å­—æ®µ": {
            "type": "keyword"
          }
        }
      },
      // å…¶ä»–å­—æ®µ...  
    }
  }
}
```



### æ–‡æ¡£æ“ä½œ

| **æ“ä½œ**             | **API**                                                      | **è¯´æ˜**                                                     |
| :------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **æ’å…¥æ–‡æ¡£**         | `POST /index_name/_doc`                                      | è‡ªåŠ¨ç”Ÿæˆ `_id`ï¼Œæ’å…¥æ–°æ–‡æ¡£ï¼ˆè‹¥ id å†²çªåˆ™æŠ¥é”™ï¼‰               |
| **æŒ‡å®š ID æ’å…¥**     | `PUT /index_name/_doc/123`                                   | ä½¿ç”¨æŒ‡å®š ID æ’å…¥æ–‡æ¡£ï¼›è‹¥å·²å­˜åœ¨åˆ™**å…¨é‡è¦†ç›–**                 |
| **æ›´æ–°æ–‡æ¡£**         | `POST /index_name/_update/123`                               | **å±€éƒ¨æ›´æ–°**ï¼ˆåªæ”¹éƒ¨åˆ†å­—æ®µï¼‰ï¼Œéœ€ä¼  `{"doc": {...}}`          |
| **æŸ¥è¯¢æ–‡æ¡£**         | `GET /index_name/_doc/123`                                   | æ ¹æ® `_id` è·å–å®Œæ•´æ–‡æ¡£ï¼ˆå« `_source` å’Œå…ƒæ•°æ®ï¼‰             |
| **åˆ é™¤æ–‡æ¡£**         | `DELETE /index_name/_doc/123`                                | æ ¹æ® `_id` åˆ é™¤æŒ‡å®šæ–‡æ¡£ï¼ˆè½¯åˆ é™¤ï¼Œå¯è¢« refresh æ¸…ç†ï¼‰         |
| **æ‰¹é‡æ“ä½œ**         | `POST /_bulk`                                                | ä¸€æ¬¡è¯·æ±‚æ‰§è¡Œå¤šæ¡æ“ä½œï¼ˆindex/create/update/deleteï¼‰ï¼Œæå‡å†™å…¥æ•ˆç‡ |
| **æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨** | `HEAD /index_name/_doc/123`                                  | ä»…è¿”å› HTTP çŠ¶æ€ç ï¼ˆ200 å­˜åœ¨ï¼Œ404 ä¸å­˜åœ¨ï¼‰ï¼Œä¸è¿”å› body      |
| **æ›¿æ¢æ–‡æ¡£ï¼ˆå¼ºåˆ¶ï¼‰** | `PUT /index_name/_doc/123?version=5`                         | åŸºäºç‰ˆæœ¬å·çš„**ä¹è§‚é”æ›´æ–°**ï¼Œé˜²æ­¢å¹¶å‘è¦†ç›–                     |
| **è·å–å¤šä¸ªæ–‡æ¡£**     | `POST /_mget`                                                | æ‰¹é‡æŒ‰ ID è·å–å¤šä¸ªæ–‡æ¡£ï¼ˆæ”¯æŒè·¨ç´¢å¼•ï¼‰                         |
| **è„šæœ¬æ›´æ–°**         | `POST /index_name/_update/123` `{ "script": "ctx._source.counter += 1" }` | ä½¿ç”¨ Painless è„šæœ¬åŠ¨æ€ä¿®æ”¹å­—æ®µå€¼                             |

> è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºesçš„æ’åºå¹¶ä¸æ˜¯åªæœ‰**å€’åºçš„è¯æ¡ç´¢å¼•**çš„ï¼Œåƒä¼ ç»Ÿæ•°æ®åº“çš„**idé¡ºåºæ’åº**ä¹Ÿæ˜¯æœ‰çš„

**æ’å…¥ç¤ºä¾‹ï¼š**

```json
POST /products/_doc
{
  "title": "åä¸º Mate 60 Pro æ™ºèƒ½æ‰‹æœº",
  "category": "æ‰‹æœº",
  "price": 6999.0,
  "in_stock": true,
  "created_at": "2024-08-20 10:30:00"
}
```

**å®šå‘æ’å…¥ç¤ºä¾‹ï¼š**ï¼ˆæŒ‡å®šäº†IDæ—¶ï¼š**POST**ä¸ºè½»é‡ä¿®æ”¹æœªå†™æ˜ä¸æ”¹ï¼›**PUT**ä¸ºå…¨é‡ä¿®æ”¹ï¼‰

```json
PUT /products/_doc/1001
{
  "title": "å°ç±³ 14 Ultra ç›¸æœºæ‰‹æœº",
  "category": "æ‰‹æœº",
  "price": 5999.0,
  "in_stock": true,
  "created_at": "2024-08-21"
}
```



### æ‰¹é‡æ“ä½œ

**æ‰¹é‡å¤„ç†ï¼ˆBulk APIï¼‰** æ˜¯ Elasticsearch ä¸­**é«˜æ•ˆå†™å…¥ã€æ›´æ–°æˆ–åˆ é™¤å¤§é‡æ–‡æ¡£çš„æ ¸å¿ƒæœºåˆ¶**ã€‚å®ƒé€šè¿‡**å•æ¬¡ HTTP è¯·æ±‚**å®Œæˆå¤šä¸ªæ“ä½œï¼Œæå¤§æå‡ååé‡ã€é™ä½ç½‘ç»œå¼€é”€ï¼Œæ˜¯æ—¥å¿—å¯¼å…¥ã€æ•°æ®è¿ç§»ã€åˆå§‹åŒ–ç­‰åœºæ™¯çš„é¦–é€‰æ–¹å¼ã€‚

| æ–¹å¼          | æ¯æ¬¡è¯·æ±‚æ“ä½œæ•°         | ç½‘ç»œå¼€é”€           | æ€§èƒ½                     |
| :------------ | :--------------------- | :----------------- | :----------------------- |
| å•æ¡æ’å…¥      | 1 æ¡                   | é«˜ï¼ˆN æ¬¡è¯·æ±‚ï¼‰     | ä½                       |
| **Bulk æ‰¹é‡** | **å¤šæ¡ï¼ˆå¦‚ 1000 æ¡ï¼‰** | **ä½ï¼ˆ1 æ¬¡è¯·æ±‚ï¼‰** | **é«˜ï¼ˆæå‡ 10~100 å€ï¼‰** |

> | æ‰¹å¤„ç†æ“ä½œ               | Redis Pipeline                 | **Elasticsearch Bulk API**          |
> | :----------------------- | :----------------------------- | ----------------------------------- |
> | **æœ¬è´¨**                 | **ç½‘ç»œè¯·æ±‚ä¼˜åŒ–æŠ€æœ¯**           | **æ‰¹é‡æ–‡æ¡£æ“ä½œåè®®**                |
> | **ç›®çš„**                 | å‡å°‘ç½‘ç»œå¾€è¿”ï¼ˆRTTï¼‰ï¼Œæå‡åå  | ä¸€æ¬¡è¯·æ±‚å¤„ç†å¤šä¸ªå†™å…¥/æ›´æ–°/åˆ é™¤æ“ä½œ  |
> | **æ˜¯å¦æ”¹å˜æ•°æ®å¤„ç†é€»è¾‘** | âŒ å¦ï¼ˆåªæ˜¯æ‰“åŒ…å‘é€å‘½ä»¤ï¼‰       | âœ… æ˜¯ï¼ˆES å†…éƒ¨ä¼šæ‰¹é‡ç´¢å¼•ã€åˆå¹¶æ®µç­‰ï¼‰ |
> | **ç±»æ¯”**                 | æŠŠ 100 æ¡çŸ­ä¿¡åˆå¹¶æˆ 1 æ¬¡å‘å‡ºå» | æŠŠ 100 ä¸ªåŒ…è£¹äº¤ç»™å¿«é€’å…¬å¸ç»Ÿä¸€å¤„ç†   |
>
> ğŸ” **å…±åŒç‚¹**ï¼šéƒ½é€šè¿‡â€œ**å‡å°‘è¯·æ±‚æ¬¡æ•°**â€æ¥æå‡æ€§èƒ½ã€‚
> âš ï¸ **å…³é”®åŒºåˆ«**ï¼šRedis Pipeline **ä¸æ”¹å˜å‘½ä»¤è¯­ä¹‰**ï¼Œè€Œ ES Bulk **æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ API åè®®**ã€‚

ä¸»è¦æ“ä½œï¼š

| æ“ä½œ     | è¯´æ˜                                            | æ˜¯å¦éœ€è¦æ•°æ®è¡Œ |
| :------- | :---------------------------------------------- | :------------- |
| `index`  | æ’å…¥æˆ–**å…¨é‡æ›¿æ¢**æ–‡æ¡£                          | âœ… éœ€è¦         |
| `create` | ä»…å½“æ–‡æ¡£ä¸å­˜åœ¨æ—¶æ’å…¥ï¼ˆç±»ä¼¼ PUT with version=0ï¼‰ | âœ… éœ€è¦         |
| `update` | **å±€éƒ¨æ›´æ–°**æ–‡æ¡£ï¼ˆéœ€ `doc` æˆ– `script`ï¼‰        | âœ… éœ€è¦         |
| `delete` | åˆ é™¤æ–‡æ¡£                                        | âŒ ä¸éœ€è¦       |

ç¤ºä¾‹ï¼š

```json
POST _bulk
{ "index" : { "_index" : "test", "_id" : "1" } }
{ "field1" : "value1" }
{ "delete" : { "_index" : "test", "_id" : "2" } }
{ "create" : { "_index" : "test", "_id" : "3" } }
{ "field1" : "value3" }
{ "update" : {"_id" : "1", "_index" : "test"} }
{ "doc" : {"field2" : "value2"} }
```



## JavaRestClient

### å®‰è£…ä¸é…ç½®

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/installation.html

> æ³¨æ„ç‰ˆæœ¬å¯¹åº”è¯´æ˜ï¼š[Java | Java](https://www.elastic.co/docs/reference/elasticsearch/clients/java)ï¼Œ8.0å¼€å§‹å°±ç”¨ä¸äº†**RestHighLevelClient**äº†ï¼Œæ”¹ç”¨æ¨èçš„JavaApiï¼š
>
> | å®¢æˆ·ç«¯                         | å…¨ç§° / åæ ‡                                                  | çŠ¶æ€                                                         | æ¨å‡ºæ—¶é—´                |
> | :----------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :---------------------- |
> | **RestHighLevelClient (RHLC)** | `org.elasticsearch.client:elasticsearch-rest-high-level-client` | âŒ **å·²åºŸå¼ƒï¼ˆDeprecatedï¼‰** è‡ª ES 7.15 èµ·æ ‡è®°åºŸå¼ƒ **ES 8.0+ å®Œå…¨ç§»é™¤** | 2018 å¹´ï¼ˆES 6.0 å¼•å…¥ï¼‰  |
> | **Java API Client**            | `co.elastic.clients:elasticsearch-java`                      | âœ… **å®˜æ–¹æ¨èæ–°å®¢æˆ·ç«¯** ä¸“ä¸º ES 7.16+ / 8.x+ è®¾è®¡             | 2021 å¹´ï¼ˆES 7.16 é¦–å‘ï¼‰ |
>
> ğŸ’¡ **Elastic å®˜æ–¹æ˜ç¡®è¡¨ç¤ºï¼šRHLC å·²æ­»ï¼Œæ–°é¡¹ç›®å¿…é¡»ç”¨ `elasticsearch-java`ã€‚**

å…¶å®SpringBootä¾èµ–ç®¡ç†å†…éƒ¨ç»´æŠ¤äº†å¾ˆå¤šç¬¬ä¸‰æ–¹æ•°æ®åº“çš„clientç‰ˆæœ¬ï¼ˆRedisï¼ŒMysqlï¼ŒMongoDBç­‰ç­‰ï¼‰ï¼Œåªè¦æˆ‘ä»¬å¼•å…¥/ç»§æ‰¿äº†SpringBootDependencieså°±å¯ä»¥ä¸ç”¨å£°æ˜ç‰ˆæœ¬ç›´æ¥å¼•ç”¨å¯¹åº”çš„clientã€‚

> `spring-boot-starter-parent`ç»§æ‰¿`spring-boot-dependencies`ï¼Œå¯åœ¨dependenciesçš„pomæ–‡ä»¶é‡ŒæŸ¥çœ‹å½“å‰ç‰ˆæœ¬å…³ç³»

æ³¨æ„**esçš„client**çš„ç‰ˆæœ¬å’Œ**es**çš„ç‰ˆæœ¬æ˜¯**å®Œå…¨ä¸€è‡´**çš„ï¼Œæˆ‘ä»¬åˆ°dependencyé‡Œçœ‹åˆ°2.7.12ç‰ˆæœ¬SpringBootçš„esClienté»˜è®¤ç‰ˆæœ¬æ˜¯ï¼š

```xml
<elasticsearch.version>7.17.10</elasticsearch.version>
```

è¿™æ—¶å€™æˆ‘ä»¬å°±è¦æ‰‹åŠ¨è°ƒæ•´ä¸€ä¸‹äº†ï¼Œåªéœ€è¦åˆ°**çˆ¶pom**ä¸­ä¿®æ”¹ä¸€ä¸‹è®¾ç½®ï¼š

```xml
<elasticsearch.version>7.12.1</elasticsearch.version>
```

å³å¯å®Œæˆç‰ˆæœ¬è¦†ç›–ã€‚

> æ³¨æ„**ä¸è¦ç›´æ¥åœ¨å­é¡¹ç›®çš„pomçš„dependencyä¸­ä¿®æ”¹version**ï¼Œä¼šè¢«dependencyManagementè¦†ç›–ï¼š
>
> ```xml
> <dependencies>
>   <dependency>
>     <groupId>org.elasticsearch.client</groupId>
>     <artifactId>elasticsearch-rest-high-level-client</artifactId>
>     <version>7.17.18</version> <!-- âš ï¸ è¿™è¡Œä¼šè¢«å¿½ç•¥ï¼ -->
>   </dependency>
> </dependencies>
> ```
>
> å°½é‡åœ¨çˆ¶pomçš„propertiesä¸­ä¿®æ”¹ï¼š
>
> ```XML
> <!-- è¿™é‡Œæ˜¯çˆ¶pom -->  
> <properties>
>       <maven.compiler.source>11</maven.compiler.source>
>       <maven.compiler.target>11</maven.compiler.target>
>       <elasticsearch.version>7.12.1</elasticsearch.version>
> </properties>
> ```
>
> IDEAå¯ä»¥åœ¨å³ä¾§mavenç®¡ç†å™¨æ£€æŸ¥å­é¡¹ç›®çš„ä¾èµ–é¡¹ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®

ç„¶åæˆ‘ä»¬å°±å¯ä»¥é…ç½®esClientçš„Beanå®ä¾‹äº†ï¼š

```yml
elasticsearch:
  host: localhost
  port: 9200
  scheme: http
  # å¦‚æœå¯ç”¨äº†å®‰å…¨è®¤è¯ï¼ˆå¦‚ xpackï¼‰
  username: elastic
  password: your-password
```

> âš ï¸ Spring Boot 2.x **ä¸ä¼šè‡ªåŠ¨åˆ›å»º `RestHighLevelClient` Bean**ï¼ä½ éœ€è¦æ‰‹åŠ¨é…ç½®ã€‚

```java
@Configuration
public class ElasticsearchConfig {

    @Value("${elasticsearch.host}")
    private String host;

    @Value("${elasticsearch.port}")
    private int port;

    @Value("${elasticsearch.scheme:http}")
    private String scheme;

    @Value("${elasticsearch.username:#{null}}")
    private String username;

    @Value("${elasticsearch.password:#{null}}")
    private String password;

    @Bean(destroyMethod = "close")
    public RestHighLevelClient restHighLevelClient() {
        HttpHost httpHost = new HttpHost(host, port, scheme);

        RestClientBuilder builder = RestClient.builder(httpHost);

        // å¦‚æœé…ç½®äº†ç”¨æˆ·åå’Œå¯†ç ï¼Œæ·»åŠ  Basic è®¤è¯
        if (username != null && password != null) {
            BasicCredentialsProvider credentialsProvider = new BasicCredentialsProvider();
            credentialsProvider.setCredentials(
                AuthScope.ANY,
                new UsernamePasswordCredentials(username, password)
            );
            builder.setHttpClientConfigCallback(httpClientBuilder ->
                httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider)
            );
        }

        return new RestHighLevelClient(builder);
    }
}
```

ç„¶åå°±å¯ä»¥æ³¨å…¥ä½¿ç”¨äº†ã€‚

> æ–°ç‰ˆæœ¬ï¼š
>
> ```yml
> elasticsearch:
>   uris: http://localhost:9200
>   username: elastic
>   password: your-password
>   # æˆ–ä½¿ç”¨ API Keyï¼ˆES 8 æ¨èï¼‰
>   # api-key: your-api-key-here
> ```
>
> æ³¨æ„ï¼š**Spring Boot ä¸ä¼šè‡ªåŠ¨è¯»å–è¿™äº›é…ç½®æ¥åˆ›å»ºå®¢æˆ·ç«¯**ï¼ä½ éœ€è¦è‡ªå·±å†™ `@Configuration`ã€‚
>
> ```java
> @Configuration
> public class ElasticsearchConfig {
> 
>     @Value("${elasticsearch.uris}")
>     private String esUris; // æ ¼å¼: http://host:port
> 
>     @Value("${elasticsearch.username:#{null}}")
>     private String username;
> 
>     @Value("${elasticsearch.password:#{null}}")
>     private String password;
> 
>     @Bean
>     public ElasticsearchClient elasticsearchClient() {
>         // 1. è§£æ URI
>         String[] hostPort = esUris.replace("http://", "").split(":");
>         String host = hostPort[0];
>         int port = Integer.parseInt(hostPort[1]);
> 
>         // 2. é…ç½®è®¤è¯ï¼ˆå¯é€‰ï¼‰
>         BasicCredentialsProvider credentialsProvider = new BasicCredentialsProvider();
>         if (username != null && password != null) {
>             credentialsProvider.setCredentials(
>                 AuthScope.ANY,
>                 new UsernamePasswordCredentials(username, password)
>             );
>         }
> 
>         // 3. åˆ›å»º RestClient
>         RestClient restClient = RestClient.builder(new HttpHost(host, port))
>             .setHttpClientConfigCallback(httpClientBuilder ->
>                 httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider)
>             )
>             .build();
> 
>         // 4. åˆ›å»º Transport
>         ElasticsearchTransport transport = new RestClientTransport(
>             restClient,
>             new JacksonJsonpMapper()
>         );
> 
>         // 5. åˆ›å»ºå¹¶è¿”å› Client
>         return new ElasticsearchClient(transport);
>     }
> 
>     // å¯é€‰ï¼šæ³¨å†Œ RestClient ç”¨äºå…³é—­èµ„æº
>     @Bean(destroyMethod = "close")
>     public RestClient restClient() {
>         String[] hostPort = esUris.replace("http://", "").split(":");
>         String host = hostPort[0];
>         int port = Integer.parseInt(hostPort[1]);
> 
>         BasicCredentialsProvider credentialsProvider = new BasicCredentialsProvider();
>         if (username != null && password != null) {
>             credentialsProvider.setCredentials(
>                 AuthScope.ANY,
>                 new UsernamePasswordCredentials(username, password)
>             );
>         }
> 
>         return RestClient.builder(new HttpHost(host, port))
>             .setHttpClientConfigCallback(httpClientBuilder ->
>                 httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider)
>             )
>             .build();
>     }
> }
> ```



### ç´¢å¼•åº“æ“ä½œï¼ˆè¡¨ï¼‰

#### åˆ›å»ºç´¢å¼•

```java
public void createIndexWithRHLC(RestHighLevelClient client) throws IOException {
    CreateIndexRequest request = new CreateIndexRequest("products");
    // è®¾ç½®æ˜ å°„
    request.mapping("{ \"properties\": { \"title\": { \"type\": \"text\" } } }", XContentType.JSON);
    
    CreateIndexResponse response = client.indices().create(request, RequestOptions.DEFAULT);
    boolean acknowledged = response.isAcknowledged();
    System.out.println("Index creation acknowledged: " + acknowledged);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void createIndexWithNewClient(ElasticsearchClient client) throws Exception {
>     CreateIndexResponse response = client.indices().create(c -> c
>         .index("products")
>         .mappings(m -> m
>             .properties("title", p -> p.text(t -> t))
>         )
>     );
>     boolean acknowledged = response.acknowledged();
>     System.out.println("Index creation acknowledged: " + acknowledged);
> }
> ```



#### åˆ é™¤ç´¢å¼•

```java
public void deleteIndexWithRHLC(RestHighLevelClient client) throws IOException {
    DeleteIndexRequest request = new DeleteIndexRequest("products");
    DeleteIndexResponse response = client.indices().delete(request, RequestOptions.DEFAULT);
    boolean acknowledged = response.isAcknowledged();
    System.out.println("Index deletion acknowledged: " + acknowledged);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void deleteIndexWithNewClient(ElasticsearchClient client) throws Exception {
>     DeleteIndexResponse response = client.indices().delete(d -> d.index("products"));
>     boolean acknowledged = response.acknowledged();
>     System.out.println("Index deletion acknowledged: " + acknowledged);
> }
> ```



#### åˆ¤æ–­ç´¢å¼•

```java
public void checkIndexExistsWithRHLC(RestHighLevelClient client) throws IOException {
    GetIndexRequest request = new GetIndexRequest("products");
    boolean exists = client.indices().exists(request, RequestOptions.DEFAULT);
    System.out.println("Index exists: " + exists);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void checkIndexExistsWithNewClient(ElasticsearchClient client) throws Exception {
>     ExistsResponse response = client.indices().exists(e -> e.index("products"));
>     boolean exists = response.value();
>     System.out.println("Index exists: " + exists);
> }
> ```



#### è·å–ç´¢å¼•æ˜ å°„

```java
public void getIndexMappingWithRHLC(RestHighLevelClient client) throws IOException {
    GetMappingsRequest request = new GetMappingsRequest();
    request.indices("products");
    GetMappingsResponse response = client.indices().getMapping(request, RequestOptions.DEFAULT);
    
    MappingMetadata mappingMetadata = response.mappings().get("products");
    Map<String, Object> mapping = mappingMetadata.getSourceAsMap();
    System.out.println("Index mapping: " + mapping);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void getIndexMappingWithNewClient(ElasticsearchClient client) throws Exception {
>     GetMappingResponse response = client.indices().getMapping(g -> g.index("products"));
>     TypeMapping mapping = response.result().get("products");
>     System.out.println("Index mapping: " + mapping.properties());
> }
> ```



#### æ›´æ–°ç´¢å¼•æ˜ å°„

```java
public void updateIndexMappingWithRHLC(RestHighLevelClient client) throws IOException {
    PutMappingRequest request = new PutMappingRequest("products");
    request.source("{ \"properties\": { \"price\": { \"type\": \"float\" } } }", XContentType.JSON);
    PutMappingResponse response = client.indices().putMapping(request, RequestOptions.DEFAULT);
    boolean acknowledged = response.isAcknowledged();
    System.out.println("Mapping update acknowledged: " + acknowledged);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void updateIndexMappingWithNewClient(ElasticsearchClient client) throws Exception {
>     PutMappingResponse response = client.indices().putMapping(p -> p
>         .index("products")
>         .properties("price", prop -> prop.float32(f -> f))
>     );
>     boolean acknowledged = response.acknowledged();
>     System.out.println("Mapping update acknowledged: " + acknowledged);
> }
> ```



#### è·å–ç´¢å¼•è®¾ç½®

```java
public void getIndexSettingsWithRHLC(RestHighLevelClient client) throws IOException {
    GetSettingsRequest request = new GetSettingsRequest();
    request.indices("products");
    GetSettingsResponse response = client.indices().getSettings(request, RequestOptions.DEFAULT);
    
    String replicas = response.getIndexToSettings().get("products").getSettings().getAsMap().get("index.number_of_replicas");
    System.out.println("Number of replicas: " + replicas);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> public void getIndexSettingsWithNewClient(ElasticsearchClient client) throws Exception {
>     GetIndexSettingsResponse response = client.indices().getSettings(g -> g.index("products"));
>     IndexState settings = response.get("products");
>     String replicas = settings.settings().numberOfReplicas();
>     System.out.println("Number of replicas: " + replicas);
> }
> ```

- **RestHighLevelClientï¼ˆæ—§ï¼‰**ï¼š
  - éœ€è¦æ‰‹åŠ¨æ„å»º JSON å­—ç¬¦ä¸²ï¼Œå®¹æ˜“å‡ºé”™ã€‚
  - æ“ä½œè¿”å›çš„ç»“æœéœ€è¦æ‰‹åŠ¨è§£æä¸º `Map` æˆ–å…¶ä»–ç±»å‹ã€‚
  - å¯¹å­—æ®µåå’Œç±»å‹æ²¡æœ‰ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚
- **Java API Clientï¼ˆæ–°ï¼‰**ï¼š
  - ä½¿ç”¨ DSL æ„å»ºå™¨é£æ ¼ï¼Œä»£ç æ›´ç®€æ´ã€æ˜“è¯»ã€‚
  - å¼ºç±»å‹æ”¯æŒï¼Œå­—æ®µåå’Œç±»å‹åœ¨ç¼–è¯‘æ—¶å¯ä»¥æ£€æŸ¥ã€‚
  - ç›´æ¥è®¿é—®å¯¹è±¡å±æ€§ï¼Œå‡å°‘æ‰‹åŠ¨è§£æçš„å¤æ‚æ€§ã€‚

> å…¶å®è¿˜æ˜¯RESTfulè®¾è®¡



### æ–‡æ¡£æ“ä½œï¼ˆrowï¼‰

#### æ’å…¥æ–‡æ¡£

```java
String json = objectMapper.writeValueAsString(product);

IndexRequest request = new IndexRequest("products")
    .id("1001")		// éå¿…é¡»
    .source(json, XContentType.JSON);

client.index(request, RequestOptions.DEFAULT);
```

> æ–°ç‰ˆï¼š
>
> ```java
> // ç›´æ¥ä¼ å…¥ POJOï¼Œè‡ªåŠ¨åºåˆ—åŒ–
> IndexResponse response = client.index(i -> i
>     .index("products")
>     .id("1001")	// éå¿…é¡»
>     .document(product)  // â† å¼ºç±»å‹ï¼Œæ— éœ€æ‰‹åŠ¨è½¬ JSON
> );
> ```



#### åˆ é™¤æ–‡æ¡£

```java
DeleteRequest request = new DeleteRequest("products", "1001");
DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);

boolean found = response.getResult() == DocWriteResponse.Result.DELETED;
```

> æ–°ç‰ˆï¼š
>
> ```java
> DeleteResponse response = client.delete(d -> d
>     .index("products")
>     .id("1001")
> );
> 
> boolean found = response.result() == DeleteResult.Deleted;
> ```



#### æ›´æ–°æ–‡æ¡£

```java
Map<String, Object> updates = new HashMap<>();
updates.put("price", 5999.0);
updates.put("in_stock", true);

UpdateRequest request = new UpdateRequest("products", "1001")
    .doc(updates);

client.update(request, RequestOptions.DEFAULT);
```

> æ–°ç‰ˆï¼š
>
> ```java
> // æ–¹å¼1ï¼šä½¿ç”¨éƒ¨åˆ†æ–‡æ¡£ï¼ˆPartial Documentï¼‰
> Product updateDoc = new Product();
> updateDoc.setPrice(5999.0);
> updateDoc.setInStock(true);
> 
> client.update(u -> u
>     .index("products")
>     .id("1001")
>     .doc(updateDoc),  // â† å¼ºç±»å‹å±€éƒ¨æ›´æ–°
>     Product.class
> );
> 
> // æ–¹å¼2ï¼šä½¿ç”¨è„šæœ¬ï¼ˆScriptï¼‰
> client.update(u -> u
>     .index("products")
>     .id("1001")
>     .script(s -> s
>         .source("ctx._source.price += params.increase")
>         .params("increase", JsonData.of(100))
>     ),
>     Product.class
> );
> ```



#### æŸ¥è¯¢æ–‡æ¡£

```java
SearchRequest request = new SearchRequest("products");
SearchSourceBuilder builder = new SearchSourceBuilder();
builder.query(QueryBuilders.matchQuery("title", "æ‰‹æœº"));
builder.size(10);
request.source(builder);

SearchResponse response = client.search(request, RequestOptions.DEFAULT);

List<Product> results = new ArrayList<>();
for (SearchHit hit : response.getHits()) {
    Product p = objectMapper.readValue(hit.getSourceAsString(), Product.class);
    results.add(p);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> SearchResponse<Product> response = client.search(s -> s
>     .index("products")
>     .query(q -> q.match(m -> m.field("title").query("æ‰‹æœº")))
>     .size(10),
>     Product.class  // â† è‡ªåŠ¨ååºåˆ—åŒ–æ¯æ¡ç»“æœ
> );
> 
> List<Product> results = response.hits().hits().stream()
>     .map(Hit::source)
>     .collect(Collectors.toList());
> ```



#### æ‰¹é‡æ’å…¥

```java
BulkRequest bulkRequest = new BulkRequest();

for (Product p : products) {
    String json = objectMapper.writeValueAsString(p);
    bulkRequest.add(new IndexRequest("products")
        .id(p.getId())
        .source(json, XContentType.JSON));
}

BulkResponse bulkResponse = client.bulk(bulkRequest, RequestOptions.DEFAULT);
```

> æ–°ç‰ˆï¼š
>
> ```java
> List<BulkOperation> operations = products.stream()
>     .map(p -> BulkOperation.of(o -> o
>         .index(idx -> idx
>             .index("products")
>             .id(p.getId())
>             .document(p)  // â† ç›´æ¥ä¼  POJO
>         )
>     )).collect(Collectors.toList());
>    
> BulkResponse response = client.bulk(b -> b
>  .operations(operations)
>    );
> ```

> æ–°ç‰ˆæœ¬è‡ªåŠ¨jacksonåºåˆ—åŒ–ï¼Œåªè¦å¯¼å…¥å¯¹åº”çš„jacksonåŒ…å³å¯



## DSLæŸ¥è¯¢

æˆ‘ä»¬å…ˆå‰å®Œæˆäº†å¯¹äºæŸ¥è¯¢æ•°æ®çš„å‡†å¤‡ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹äº«å—esçš„**é«˜é€Ÿå…³é”®è¯æ£€ç´¢**äº†ï¼Œä¹‹å‰æˆ‘ä»¬ä¸¾çš„ä¾‹å­ä¸€èˆ¬éƒ½æ˜¯å•è¯æ¡æŸ¥è¯¢ï¼Œå¯å®é™…ç”Ÿäº§ç¯å¢ƒæ˜¯ä¸ä¼šåªæœ‰ä¸€ä¸ªå…³é”®è¯çš„æŸ¥è¯¢ä¹Ÿä¸ä¼šåªæœ‰å…³é”®è¯åŒ¹é…çš„ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¤åˆæŸ¥è¯¢äº†ï¼š

DSL æ˜¯ Elasticsearch æä¾›çš„ä¸€ç§ **åŸºäº JSON çš„æŸ¥è¯¢è¯­è¨€**ï¼Œç”¨äºè¡¨è¾¾å¤æ‚çš„æœç´¢ã€è¿‡æ»¤ã€èšåˆç­‰æ“ä½œã€‚å®ƒæ¯”ç®€å•çš„ URI æŸ¥è¯¢å¼ºå¤§å¾—å¤šã€‚

| DSL ç±»å‹           | ç®€è¦è¯´æ˜                                             | å…¸å‹ä½¿ç”¨åœºæ™¯                                                 |
| :----------------- | :--------------------------------------------------- | :----------------------------------------------------------- |
| **match**          | å…¨æ–‡æ£€ç´¢ï¼Œä¼šå¯¹æŸ¥è¯¢æ–‡æœ¬è¿›è¡Œåˆ†è¯ååŒ¹é…                 | æœç´¢å•†å“æ ‡é¢˜ã€æ–‡ç« å†…å®¹ç­‰å¯åˆ†è¯å­—æ®µï¼ˆå¦‚ `"æ‰‹æœº"` åŒ¹é… `"æ™ºèƒ½æ‰‹æœº"`ï¼‰ |
| **match_phrase**   | çŸ­è¯­åŒ¹é…ï¼Œè¦æ±‚è¯è¯­æŒ‰é¡ºåºä¸”ç´§é‚»å‡ºç°                   | ç²¾ç¡®æœç´¢çŸ­è¯­ï¼Œå¦‚ `"åä¸ºæ‰‹æœº"` ä¸åŒ¹é… `"æ‰‹æœºåä¸º"`            |
| **term**           | ç²¾ç¡®å€¼åŒ¹é…ï¼ˆä¸åˆ†è¯ï¼‰ï¼Œç”¨äº keywordã€æ•°å­—ã€å¸ƒå°”ç­‰å­—æ®µ | æŒ‰åˆ†ç±»ã€çŠ¶æ€ã€ID ç²¾ç¡®è¿‡æ»¤ï¼Œå¦‚ `category.keyword = "Electronics"` |
| **terms**          | å¤šå€¼ç²¾ç¡®åŒ¹é…ï¼ˆIN æŸ¥è¯¢ï¼‰                              | æŸ¥æ‰¾å¤šä¸ªåˆ†ç±»æˆ–çŠ¶æ€ï¼Œå¦‚ `status IN ["published", "draft"]`    |
| **range**          | èŒƒå›´æŸ¥è¯¢ï¼ˆæ•°å€¼ã€æ—¥æœŸã€å­—ç¬¦ä¸²ï¼‰                       | ä»·æ ¼åŒºé—´ï¼ˆ1000~5000ï¼‰ã€ä¸Šæ¶æ—¶é—´ï¼ˆæœ€è¿‘30å¤©ï¼‰ã€è¯„åˆ†ï¼ˆâ‰¥4.5ï¼‰    |
| **exists**         | åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆé null ä¸”éç©ºï¼‰                   | è¿‡æ»¤æœ‰å›¾ç‰‡çš„å•†å“ï¼ˆ`image_url exists`ï¼‰                       |
| **bool**           | ç»„åˆå¤šä¸ªæŸ¥è¯¢ï¼Œæ”¯æŒ must / should / must_not / filter | å¤æ‚æ¡ä»¶ï¼šå¿…é¡»åŒ…å«å…³é”®è¯ + ä»·æ ¼åœ¨èŒƒå›´å†… + æ’é™¤ä¸‹æ¶å•†å“       |
| **wildcard**       | é€šé…ç¬¦åŒ¹é…ï¼ˆ`*`, `?`ï¼‰ï¼Œä¸åˆ†ææ–‡æœ¬                   | SKU æ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚ `"IPH*"` åŒ¹é… `"IPH15-256G"`                |
| **prefix**         | å‰ç¼€åŒ¹é…                                             | è‡ªåŠ¨è¡¥å…¨ã€å“ç‰Œç­›é€‰ï¼ˆå¦‚ `"App"` åŒ¹é… `"Apple"`ï¼‰              |
| **regexp**         | æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…                                       | é«˜çº§æ¨¡å¼åŒ¹é…ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œæ€§èƒ½ä½ï¼‰                             |
| **ids**            | æ ¹æ®æ–‡æ¡£ ID åˆ—è¡¨æŸ¥è¯¢                                 | æ‰¹é‡è·å–ç‰¹å®š ID çš„æ–‡æ¡£                                       |
| **nested**         | æŸ¥è¯¢åµŒå¥—å¯¹è±¡ï¼ˆnested ç±»å‹å­—æ®µï¼‰                      | å•†å“æœ‰å¤šä¸ªè§„æ ¼ï¼ˆé¢œè‰²ã€å°ºå¯¸ï¼‰ï¼Œéœ€åŒæ—¶åŒ¹é…                     |
| **geo_distance**   | åœ°ç†ä½ç½®è·ç¦»æŸ¥è¯¢                                     | â€œé™„è¿‘ 5 å…¬é‡Œçš„é—¨åº—â€                                          |
| **function_score** | è‡ªå®šä¹‰è¯„åˆ†é€»è¾‘ï¼ˆç»“åˆå…¶ä»–æŸ¥è¯¢ï¼‰                       | æŒ‰çƒ­åº¦+ç›¸å…³æ€§ç»¼åˆæ’åºï¼Œå¦‚â€œé”€é‡è¶Šé«˜æ’åè¶Šé å‰â€                |

> - å…¨æ–‡ vs ç²¾ç¡®ï¼š
>   - `match` ç³»åˆ—ç”¨äº **text å­—æ®µ**ï¼ˆä¼šåˆ†è¯ï¼‰
>   - `term`/`terms` ç”¨äº **keyword / æ•°å­— / æ—¥æœŸ**ï¼ˆç²¾ç¡®å€¼ï¼‰
> - filter vs queryï¼š
>   - `bool` ä¸­çš„ `filter` å­å¥ **ä¸è®¡ç®—ç›¸å…³æ€§å¾—åˆ†**ï¼Œæ›´å¿«ï¼Œé€‚åˆçº¯è¿‡æ»¤
>   - `must`/`should` ä¼šè®¡ç®—å¾—åˆ†ï¼Œç”¨äºç›¸å…³æ€§æ’åº
> - æ€§èƒ½æç¤ºï¼š
>   - é¿å…åœ¨é«˜åŸºæ•°å­—æ®µä¸Šç”¨ `wildcard`/`regexp`
>   - `term` æŸ¥è¯¢æ¯” `match` æ›´å¿«ï¼ˆæ— åˆ†è¯å¼€é”€ï¼‰



### å…¨æ–‡åŒ¹é…

```java
SearchSourceBuilder builder = new SearchSourceBuilder();
builder.query(matchQuery("title", "æ‰‹æœº"));

// æˆ–æ‰‹åŠ¨æ„é€ ï¼ˆä¸æ¨èï¼‰
Map<String, Object> query = Map.of("match", 
    Map.of("title", "æ‰‹æœº")
);
```

> æ–°ç‰ˆï¼š
>
> ```java
> SearchResponse<Product> response = client.search(s -> s
>     .index("products")
>     .query(q -> q
>         .match(m -> m.field("title").query("æ‰‹æœº"))
>     ),
>     Product.class
> );
> ```



### èŒƒå›´æŸ¥è¯¢

```java
RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("price")
    .gte(1000)
    .lte(5000);
```

> æ–°ç‰ˆï¼š
>
> ```java
> .range(r -> r
>     .field("price")
>     .gte(JsonData.of(1000))
>     .lte(JsonData.of(5000))
> )
> ```



### ç²¾ç¡®åŒ¹é…

```java
TermQueryBuilder termQuery = QueryBuilders.termQuery("category.keyword", "Electronics");
```

> æ–°ç‰ˆï¼š
>
> ```java
> .query(q -> q
>     .term(t -> t.field("category.keyword").value("Electronics"))
> )
> ```
>
> åªç”¨äºkeyword



### ç»„åˆæŸ¥è¯¢

```java
BoolQueryBuilder boolQuery = QueryBuilders.boolQuery()
    .must(QueryBuilders.matchQuery("title", "æ‰‹æœº"))
    .filter(QueryBuilders.rangeQuery("price").gte(1000).lte(5000));

SearchSourceBuilder builder = new SearchSourceBuilder();
builder.query(boolQuery);
```

> æ–°ç‰ˆï¼š
>
> ```java
> client.search(s -> s
>     .index("products")
>     .query(q -> q
>         .bool(b -> b
>             .must(m -> m.match(mm -> mm.field("title").query("æ‰‹æœº")))
>             .filter(f -> f.range(r -> r.field("price").gte(1000).lte(5000)))
>         )
>     ),
>     Product.class
> );
> ```

> - mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€
> - shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€
> - must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**ï¼Œç±»ä¼¼â€œéâ€
> - filterï¼šå¿…é¡»åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**



### æ’åºä¸åˆ†é¡µ

ä¸€æåˆ°æœç´¢å°±ç¦»ä¸å¼€**åˆ†é¡µ**ï¼Œesæä¾›äº†ä¸€ç§ç®€å•åˆ†é¡µ`from`+`size`ï¼ˆfromä»0å¼€å§‹ï¼‰ï¼š

> å’Œsqlçš„`limit`+`offset`åŸºæœ¬ä¸€è‡´ï¼Œè®¾ç½®ä¸€ä¸ªåç§»é‡ï¼Œè·å–åç§»é‡ä¹‹åçš„å‡ ä¸ªæ•°æ®ï¼ˆå³è·³è¿‡offset/fromä¸ªæ•°æ®ï¼Œæ‹¿limit/sizeä¸ªæ•°æ®ï¼‰

```java
SearchRequest request = new SearchRequest("products");
SearchSourceBuilder builder = new SearchSourceBuilder();

// åˆ†é¡µï¼šç¬¬2é¡µï¼Œæ¯é¡µ10æ¡ï¼ˆfrom = (page-1)*sizeï¼‰
builder.from(10);   // è·³è¿‡å‰10æ¡
builder.size(10);   // è¿”å›10æ¡

// æ’åºï¼šæŒ‰ price å‡åºï¼Œ_score é™åº
builder.sort("price", SortOrder.ASC);
builder.sort("_score", SortOrder.DESC);

request.source(builder);
SearchResponse response = client.search(request, RequestOptions.DEFAULT);
```

> æ–°ç‰ˆï¼š
>
> ```java
> int page = 2;
> int size = 10;
> 
> SearchResponse<Product> response = client.search(s -> s
>     .index("products")
>     .from((page - 1) * size)
>     .size(size)
>     .sort(s1 -> s1.field(f -> f.field("price").order(SortOrder.Asc)))
>     .sort(s2 -> s2.score().order(SortOrder.Desc)),
>     Product.class
> );
> ```

åœ¨ä¸šåŠ¡ä¸­æˆ‘ä»¬éå¸¸å®¹æ˜“è§åˆ°éœ€è¦**æ’åº**çš„åœºæ™¯ï¼Œesçš„æœç´¢å½“ç„¶ä¹Ÿæä¾›äº†æ’åºçš„åŠŸèƒ½`sort`ï¼Œåœ¨clientä¸­æŒ‡æ˜éœ€è¦æ’åºçš„**å­—æ®µ**ä»¥åŠ**å‡åºè¿˜æ˜¯å€’åº**å³å¯ï¼š

```java
builder.sort(new FieldSortBuilder("category.keyword").order(SortOrder.ASC));
builder.sort(new FieldSortBuilder("price").order(SortOrder.DESC));
```

> æ–°ç‰ˆï¼š
>
> ```java
> .sort(s1 -> s1.field(f -> f.field("category.keyword").order(SortOrder.Asc)))
> .sort(s2 -> s2.field(f -> f.field("price").order(SortOrder.Desc)))
> ```
>
> ğŸ’¡ æ–°å®¢æˆ·ç«¯æ¯ä¸ª `.sort()` è°ƒç”¨ç‹¬ç«‹ï¼Œç»“æ„æ›´æ¸…æ™°ã€‚



### æ·±åº¦åˆ†é¡µ

ä¸€èˆ¬éƒ½åˆ†é¡µäº†æˆ‘ä»¬å¿…ç„¶ä¼šè¿›è¡ŒæŸç§ç¨‹åº¦çš„æ’åºï¼Œ**æˆ‘ä»¬ä¼šç»´æŠ¤ä¸€ä¸ªç»“æ„ä½“ï¼ˆæœ€å°/å¤§å †ï¼‰å­˜å‚¨éå†æ¯”è¾ƒæ‰€å¾—ç»“æœæ¥å®ç°åˆ†é¡µæ’åº**ã€‚è€Œä¸”esçš„æ•°æ®è¿˜æ˜¯åˆ†å¸ƒå¼å­˜å‚¨çš„ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¼šä»æ‰€æœ‰èŠ‚ç‚¹æ±‡æ€»æ•°æ®ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¦‚æœæˆ‘ä»¬è¿›è¡Œäº†ä¸€ä¸ªæ·±åº¦åˆ†é¡µç”¨çš„è¿˜æ˜¯from sizeï¼Œä¼šå¯¹æ‰€æœ‰èŠ‚ç‚¹éƒ½è¿›è¡Œä¸€æ¬¡éå¸¸å¤¸å¼ çš„ **Top-K æŸ¥è¯¢**ï¼Œæ¶ˆè€—çš„èµ„æºéå¸¸å¤šã€‚

> ä¸¾ä¸ªç®€å•ä¾‹å­ç†è§£ä¸€ä¸‹åˆ†é¡µæ’åºï¼šå‡è®¾æˆ‘ä»¬è¦æŒ‰ `price` å‡åºå–å‰ 10 æ¡ï¼ˆ`size=10`ï¼‰ã€‚
>
>  **å…³é”®æŠ€æœ¯ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆæœ€å°å †/å¤§é¡¶å †ï¼‰**
>
> Lucene åœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
>
>  **æ­¥éª¤ 1ï¼šéå†æ‰€æœ‰æ–‡æ¡£ï¼ˆé€šè¿‡ Doc Valuesï¼‰**
>
> - ä¸æ˜¯â€œå…¨æ’åºâ€ï¼Œè€Œæ˜¯**é€ä¸ªæ£€æŸ¥æ–‡æ¡£çš„ `price` å€¼**
> - ç»´æŠ¤ä¸€ä¸ª **å¤§å°ä¸º K=10 çš„æœ€å°å †ï¼ˆMin-Heapï¼‰**
>
>  **æ­¥éª¤ 2ï¼šåŠ¨æ€æ›´æ–°å †**
>
> - åˆå§‹ï¼šå †ä¸ºç©º
> - çœ‹åˆ° doc1 (price=2999) â†’ åŠ å…¥å †
> - çœ‹åˆ° doc2 (price=5999) â†’ åŠ å…¥å †ï¼ˆå †æœªæ»¡ï¼‰
> - ...
> - å †æ»¡ 10 ä¸ªåï¼š
>   - å¦‚æœæ–°æ–‡æ¡£ price < å †é¡¶ï¼ˆå½“å‰æœ€å¤§å€¼ï¼‰ï¼Œåˆ™ **å¼¹å‡ºå †é¡¶ï¼Œæ’å…¥æ–°æ–‡æ¡£**ï¼ˆ**æ’å…¥**è¿™ä¸ªè¿‡ç¨‹çš„å¤æ‚åº¦å–å†³äºæ­¤æ—¶**å †å¤§å°**ï¼‰
>   - å¦åˆ™è·³è¿‡
>
>  **æ­¥éª¤ 3ï¼šéå†ç»“æŸï¼Œå †ä¸­å°±æ˜¯ Top-10 æœ€å°å€¼**
>
> ğŸ’¡ è¿™ä¸ªè¿‡ç¨‹ **æ—¶é—´å¤æ‚åº¦ O(N log K)**ï¼Œç©ºé—´å¤æ‚åº¦ O(K)ï¼Œè¿œä¼˜äº O(N log N) å…¨æ’åºï¼
>
> å‡è®¾åˆ†ç‰‡æœ‰ 100 ä¸‡æ–‡æ¡£ï¼Œæ±‚ `price` æœ€å°çš„ 10 ä¸ªï¼š
>
> | æ–¹æ³•         | æ“ä½œ                                | å†…å­˜        | é€Ÿåº¦   |
> | :----------- | :---------------------------------- | :---------- | :----- |
> | **å…¨æ’åº**   | å¯¹ 100 ä¸‡æ¡æŒ‰ price æ’åºï¼Œå–å‰10    | å­˜ 100 ä¸‡æ¡ | æ…¢     |
> | **Top-K å †** | éå† 100 ä¸‡æ¬¡ï¼Œåªç»´æŠ¤ 10 ä¸ªå…ƒç´ çš„å † | å­˜ 10 æ¡    | **å¿«** |
>
> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ **å–å‰10æ¡éå¸¸å¿«** â€”â€” å®ƒæ ¹æœ¬æ²¡æ’åºå…¨éƒ¨æ•°æ®ï¼åªæ˜¯éå†äº†ä¸€éè€Œå·²ï¼
>
> é‚£ä¸ºä»€ä¹ˆæ·±åº¦åˆ†é¡µè€—æ—¶å‘¢ï¼Ÿä¸Šé¢æˆ‘ä»¬è®¨è®ºæ—¶æ²¡æœ‰åŠ å…¥from/offsetåç§»é‡ï¼Œåªä½¿ç”¨äº†limit/sizeå–çš„æ•°é‡ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨å †æ’åºæ—¶æ‰€è¦ç»´æŠ¤çš„**å †çš„å¤§å°å…¶å®å°±æ˜¯from/offset+limit/size**ï¼å‡å¦‚å †çš„å¤§å°ä¸€æ—¦è¿‡å¤§å°±ä¼šå¯¼è‡´æ¯æ¬¡æ’å…¥æ–°å€¼éœ€è¦æ›´å¤šçš„æ—¶é—´ç»´æŠ¤å †ï¼Œè€Œä¸”å ç”¨å†…å­˜è¿˜å¤šï¼Œä»è€Œä½¿å¾—æ•ˆç‡éå¸¸å·®ã€‚

é‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆæå®šè¿™ä¸ªæ·±åº¦åˆ†é¡µå‘¢ï¼Ÿesç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ï¼š**search_after**

> **ä¸è·³è¿‡æ•°æ®ï¼Œè€Œæ˜¯â€œè®°ä½ä¸Šä¸€é¡µæœ€åä¸€æ¡çš„ä½ç½®â€ï¼Œä»é‚£é‡Œç»§ç»­å¾€ä¸‹è¯»ã€‚**
> è®°å½•æœ€åä¸€æ¡çš„**sortå€¼**ï¼Œä¸‹ä¸€æ¬¡éå†ä»**sortå€¼**å¼€å§‹å–å¤§/å°çš„å³å¯ï¼Œåœ¨éå†æ‰€æœ‰æ•°æ®æ—¶ç”¨sortå€¼åˆ¤æ–­**è¿™æ¡æ•°æ®æ˜¯å¦å·²ç»è¢«å‰é¢çš„åˆ†é¡µæ’åºæŸ¥è¿‡äº†**ï¼Œç”¨è¿‡äº†é‚£ç›´æ¥ä¸€æ¡**if**æ’é™¤æ‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬**æ— éœ€ç»´æŠ¤from/offsetåç§»é‡å¤§å°çš„å †**ï¼Œ**åªéœ€ç»´æŠ¤size/limitå¤§å°çš„å †**

è¿™ç±»ä¼¼äºï¼š

- æ•°æ®åº“çš„ **æ¸¸æ ‡åˆ†é¡µï¼ˆCursor-based Paginationï¼‰**
- æ–‡ä»¶è¯»å–çš„ **æ–‡ä»¶æŒ‡é’ˆï¼ˆFile Pointerï¼‰**

âœ… ä¼˜åŠ¿ï¼š

- **æ— æ€§èƒ½è¡°å‡**ï¼šæ— è®ºç¿»åˆ°ç¬¬ 1 é¡µè¿˜æ˜¯ç¬¬ 100 ä¸‡é¡µï¼Œæ¯æ¬¡åªæŸ¥ `size` æ¡
- **æ— ç¡¬é™åˆ¶**ï¼šå¯æ— é™æ»šåŠ¨
- **å®æ—¶æ€§å¥½**ï¼šåŸºäºæœ€æ–°ç´¢å¼•çŠ¶æ€ï¼ˆé™¤éé…åˆ PITï¼‰

**å®ç°åŸç†ï¼š**

**å‰ææ¡ä»¶**

1. **å¿…é¡»æŒ‡å®šæ’åºå­—æ®µï¼ˆ`sort`ï¼‰**
2. **æ’åºå­—æ®µç»„åˆå¿…é¡»èƒ½å”¯ä¸€æ ‡è¯†æ–‡æ¡£**ï¼ˆé€šå¸¸åŠ  `_id` æˆ–ä¸šåŠ¡å”¯ä¸€ IDï¼‰

**æµç¨‹**

1. **ç¬¬ä¸€é¡µæŸ¥è¯¢**ï¼šæ­£å¸¸æŸ¥ï¼Œè®°å½•æœ€åä¸€æ¡çš„ `sort` å€¼
2. **ç¬¬äºŒé¡µæŸ¥è¯¢**ï¼šæŠŠä¸Šä¸€é¡µæœ€åä¸€æ¡çš„ `sort` å€¼ä¼ ç»™ `search_after`
3. **ES å®šä½**ï¼šåœ¨æ’åºåºåˆ—ä¸­ï¼Œä»è¯¥ `sort` å€¼**ä¹‹å**å¼€å§‹å– `size` æ¡

> ğŸ“Œ `search_after` çš„å€¼ = ä¸Šä¸€ä¸ªæ–‡æ¡£çš„ `sort` å­—æ®µæ•°ç»„

8.0çš„clientè°ƒç”¨**search_after**ï¼š

```java
// ç¬¬ä¸€é¡µ
SearchResponse<Log> firstPage = client.search(s -> s
    .index("logs")
    .size(10)
    .sort(s1 -> s1.field(f -> f.field("@timestamp").order(SortOrder.Asc)))
    .sort(s2 -> s2.field(f -> f.field("_id").order(SortOrder.Asc))),
    Log.class
);

// è·å–æœ€åä¸€æ¡çš„ sort å€¼ï¼ˆç”¨äºä¸‹ä¸€é¡µï¼‰
List<FieldValue> lastSort = firstPage.hits().hits()
    .get(firstPage.hits().hits().size() - 1)
    .sort();

// ç¬¬äºŒé¡µ
SearchResponse<Log> secondPage = client.search(s -> s
    .index("logs")
    .size(10)
    .sort(s1 -> s1.field(f -> f.field("@timestamp").order(SortOrder.Asc)))
    .sort(s2 -> s2.field(f -> f.field("_id").order(SortOrder.Asc)))
    .searchAfter(lastSort),  // â† å…³é”®ï¼
    Log.class
);
```

> ç¼ºç‚¹ï¼š**åªèƒ½æŒ‰é¡ºåºæ¥**



### é«˜äº®æ˜¾ç¤º

è®©æœç´¢ç»“æœä¸­åŒ¹é…å…³é”®è¯çš„éƒ¨åˆ†**é«˜äº®æ˜¾ç¤º**ï¼ˆå¦‚ `<em>æ‰‹æœº</em>`ï¼‰ï¼Œæå¤§æå‡ç”¨æˆ·ä½“éªŒã€‚

```java
SearchRequest request = new SearchRequest("products");
SearchSourceBuilder builder = new SearchSourceBuilder();

builder.query(QueryBuilders.matchQuery("title", "æ‰‹æœº"));
HighlightBuilder highlightBuilder = new HighlightBuilder();
highlightBuilder.field("title")
    .preTags("<strong>")
    .postTags("</strong>")
    .fragmentSize(150)
    .numOfFragments(1);
builder.highlighter(highlightBuilder);

request.source(builder);
SearchResponse response = client.search(request, RequestOptions.DEFAULT);

// è§£æé«˜äº®
for (SearchHit hit : response.getHits()) {
    HighlightField titleField = hit.getHighlightFields().get("title");
    if (titleField != null) {
        String highlighted = titleField.getFragments()[0].toString();
    }
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> SearchResponse<Product> response = client.search(s -> s
>     .index("products")
>     .query(q -> q.match(m -> m.field("title").query("æ‰‹æœº")))
>     .highlight(h -> h
>         .fields("title", hf -> hf
>             .preTags("<strong>")
>             .postTags("</strong>")
>             .fragmentSize(150)
>             .numberOfFragments(1)
>         )
>     ),
>     Product.class
> );
> 
> // è·å–é«˜äº®ç»“æœ
> for (Hit<Product> hit : response.hits().hits()) {
>     List<String> highlights = hit.highlight().get("title");
>     if (highlights != null && !highlights.isEmpty()) {
>         String highlightedTitle = highlights.get(0);
>         System.out.println(highlightedTitle); // å¦‚: æ™ºèƒ½<strong>æ‰‹æœº</strong> Pro
>     }
> }
> ```



## æ•°æ®èšåˆ

 **Elasticsearch çš„èšåˆï¼ˆAggregationï¼‰** â€”â€” å®ƒæ˜¯ ES é™¤æœç´¢å¤–æœ€å¼ºå¤§çš„åŠŸèƒ½ï¼Œç”¨äº**å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ã€ç»Ÿè®¡ã€åˆ†æ**ï¼Œç±»ä¼¼ SQL ä¸­çš„ `GROUP BY` + èšåˆå‡½æ•°ï¼Œä½†èƒ½åŠ›è¿œè¶…ä¼ ç»Ÿæ•°æ®åº“ã€‚

èšåˆ = **å¯¹ä¸€ç»„æ–‡æ¡£è¿›è¡Œè®¡ç®—ï¼Œè¿”å›æŒ‡æ ‡æˆ–åˆ†ç»„ç»“æœ**ã€‚

å¸¸è§ç”¨é€”ï¼š

- å•†å“æŒ‰åˆ†ç±»ç»Ÿè®¡æ•°é‡ï¼ˆ`terms`ï¼‰
- è®¡ç®—å¹³å‡ä»·æ ¼ï¼ˆ`avg`ï¼‰
- æŒ‰æ—¥æœŸèŒƒå›´ç»Ÿè®¡è®¢å•é‡ï¼ˆ`date_histogram`ï¼‰
- æ‰¾å‡ºæœ€è´µ/æœ€ä¾¿å®œçš„å•†å“ï¼ˆ`min`/`max`ï¼‰
- åœ°ç†ä½ç½®çƒ­åŠ›å›¾ï¼ˆ`geo_hash`ï¼‰

> ğŸ’¡ èšåˆåœ¨ `_search` è¯·æ±‚ä¸­é€šè¿‡ `aggs` æˆ– `aggregations` å­—æ®µå®šä¹‰ã€‚

ä¸‰ç§èšåˆç±»å‹ï¼š

| ç±»å‹                 | ä½œç”¨                        | å¸¸è§å­ç±»å‹                                            |
| :------------------- | :-------------------------- | :---------------------------------------------------- |
| **Metricï¼ˆæŒ‡æ ‡ï¼‰**   | è®¡ç®—å•ä¸ªæ•°å€¼æŒ‡æ ‡            | `avg`, `sum`, `min`, `max`, `cardinality`ï¼ˆå»é‡è®¡æ•°ï¼‰ |
| **Bucketï¼ˆæ¡¶ï¼‰**     | å°†æ–‡æ¡£åˆ†ç»„ï¼ˆç±»ä¼¼ GROUP BYï¼‰ | `terms`, `range`, `date_histogram`, `filter`          |
| **Pipelineï¼ˆç®¡é“ï¼‰** | å¯¹å…¶ä»–èšåˆçš„ç»“æœå†è®¡ç®—      | `derivative`ï¼ˆæ±‚å¯¼ï¼‰, `cumulative_sum`                |

> å¤§å¤šæ•°åœºæ™¯ç”¨ **Metric + Bucket ç»„åˆ**ã€‚

å¸¸ç”¨çš„èšåˆç±»å‹ï¼š

| èšåˆç±»å‹         | ç”¨é€”         | ç±»æ¯” SQL                                |
| :--------------- | :----------- | :-------------------------------------- |
| `terms`          | æŒ‰å­—æ®µå€¼åˆ†ç»„ | `GROUP BY category`                     |
| `avg`/`sum`      | æ•°å€¼ç»Ÿè®¡     | `AVG(price)`                            |
| `date_histogram` | æŒ‰æ—¶é—´åˆ†ç»„   | `GROUP BY DATE(order_date)`             |
| `range`          | åŒºé—´åˆ†ç»„     | `CASE WHEN price < 1000 THEN 'low' ...` |



### æŒ‡æ ‡èšåˆMetric

```java
// 1. æ„å»ºæœç´¢è¯·æ±‚
SearchRequest searchRequest = new SearchRequest("products");

// 2. æ„å»ºæŸ¥è¯¢æºï¼ˆsourceï¼‰
SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
sourceBuilder.size(0); // ä¸è¿”å›åŸå§‹æ–‡æ¡£

// 3. æ·»åŠ  Metric èšåˆï¼ˆä½¿ç”¨ AggregationBuilders å·¥å…·ç±»ï¼‰
AvgAggregationBuilder avgPrice = AggregationBuilders.avg("avg_price").field("price");
MaxAggregationBuilder maxPrice = AggregationBuilders.max("max_price").field("price");
MinAggregationBuilder minPrice = AggregationBuilders.min("min_price").field("price");
CardinalityAggregationBuilder distinctProducts = AggregationBuilders.cardinality("distinct_products")
    .field("product_id.keyword"); // æ³¨æ„ï¼štext å­—æ®µéœ€ç”¨ .keyword

// å°†èšåˆæ·»åŠ åˆ° source
sourceBuilder.aggregation(avgPrice);
sourceBuilder.aggregation(maxPrice);
sourceBuilder.aggregation(minPrice);
sourceBuilder.aggregation(distinctProducts);

// è®¾ç½®æŸ¥è¯¢æº
searchRequest.source(sourceBuilder);

// 4. æ‰§è¡ŒæŸ¥è¯¢
SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);

// 5. è§£æèšåˆç»“æœï¼ˆéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ï¼‰
Aggregations aggregations = searchResponse.getAggregations();

// è·å– avg èšåˆç»“æœ â†’ å¿…é¡» cast ä¸º ParsedAvg
ParsedAvg avgAgg = aggregations.get("avg_price");
double avgPriceValue = avgAgg.getValue(); // å¯èƒ½ä¸º Double.NaNï¼Œå»ºè®®åˆ¤ç©º

// è·å– max
ParsedMax maxAgg = aggregations.get("max_price");
double maxPriceValue = maxAgg.getValue();

// è·å– min
ParsedMin minAgg = aggregations.get("min_price");
double minPriceValue = minAgg.getValue();

// è·å– cardinalityï¼ˆå»é‡è®¡æ•°ï¼‰
ParsedCardinality cardAgg = aggregations.get("distinct_products");
long distinctCount = cardAgg.getValue();
```

> æ–°ç‰ˆï¼š
>
> ```java
> // æ‰§è¡ŒèšåˆæŸ¥è¯¢ï¼ˆä¸è¿”å›åŸå§‹æ–‡æ¡£ï¼‰
> SearchResponse<Void> response = client.search(s -> s
>     .index("products")               // æŒ‡å®šç´¢å¼•
>     .size(0)                         // ä¸éœ€è¦è¿”å›åŒ¹é…çš„æ–‡æ¡£ï¼Œåªå…³å¿ƒèšåˆç»“æœ
>     .aggregations("avg_price", a -> a
>         .avg(av -> av.field("price"))   // å®šä¹‰ avg èšåˆï¼šè®¡ç®— price çš„å¹³å‡å€¼
>     )
>     .aggregations("max_price", a -> a
>         .max(m -> m.field("price"))     // å®šä¹‰ max èšåˆï¼šprice æœ€å¤§å€¼
>     )
>     .aggregations("min_price", a -> a
>         .min(m -> m.field("price"))     // å®šä¹‰ min èšåˆï¼šprice æœ€å°å€¼
>     )
>     .aggregations("distinct_products", a -> a
>         .cardinality(c -> c.field("product_id.keyword")) // å»é‡è®¡æ•°ï¼ˆè¿‘ä¼¼ï¼‰
>     ),
>     Void.class  // å› ä¸º size=0ï¼Œæ— éœ€ååºåˆ—åŒ– _sourceï¼Œç”¨ Void æé«˜æ€§èƒ½
> );
> 
> // è·å–èšåˆç»“æœï¼ˆå¼ºç±»å‹ï¼Œæ— éœ€å¼ºåˆ¶è½¬æ¢ï¼‰
> Aggregate avgAgg = response.aggregations().get("avg_price");
> double avgPrice = avgAgg.avg().value();  // å¯èƒ½ä¸º nullï¼Œå®é™…ä½¿ç”¨å»ºè®®åˆ¤ç©º
> 
> Aggregate maxAgg = response.aggregations().get("max_price");
> double maxPrice = maxAgg.max().value();
> 
> Aggregate minAgg = response.aggregations().get("min_price");
> double minPrice = minAgg.min().value();
> 
> Aggregate cardAgg = response.aggregations().get("distinct_products");
> long distinctCount = cardAgg.cardinality().value();
> ```
>
> - **`size(0)`**ï¼šé¿å…è¿”å›åŸå§‹æ–‡æ¡£ï¼ŒèŠ‚çœç½‘ç»œå’Œå†…å­˜å¼€é”€ã€‚
> - **`Void.class`**ï¼šå› ä¸ºä¸å…³å¿ƒ `_source`ï¼Œä½¿ç”¨ `Void` æå‡æ€§èƒ½ã€‚
> - **å¼ºç±»å‹è®¿é—®**ï¼šå¦‚ `agg.avg().value()`ï¼Œç¼–è¯‘æœŸå®‰å…¨ï¼ŒIDE è‡ªåŠ¨è¡¥å…¨ã€‚
> - å­—æ®µè¦æ±‚ï¼š
>   - `price` å¿…é¡»æ˜¯ `number` ç±»å‹ï¼ˆå¦‚ `float`ã€`integer`ï¼‰
>   - `product_id` éœ€ç”¨ `.keyword`ï¼ˆå› ä¸º `text` æ— æ³•å»é‡è®¡æ•°ï¼‰
> - **`cardinality` æ˜¯è¿‘ä¼¼å€¼**ï¼šåŸºäº HyperLogLog++ ç®—æ³•ï¼Œé€‚åˆå¤§æ•°æ®é‡å»é‡ã€‚



### æ¡¶èšåˆBucket

```java
// 1. æ„å»ºè¯·æ±‚
SearchRequest request = new SearchRequest("products");
SearchSourceBuilder builder = new SearchSourceBuilder();
builder.size(0);

// 2. æ„å»ºæ¡¶èšåˆ + å­èšåˆ
TermsAggregationBuilder termsAgg = AggregationBuilders.terms("by_category")
    .field("category.keyword")
    .size(10);

AvgAggregationBuilder avgAgg = AggregationBuilders.avg("avg_price")
    .field("price");

termsAgg.subAggregation(avgAgg); // â† å…³é”®ï¼šç”¨ subAggregation æ·»åŠ å­èšåˆ
builder.aggregation(termsAgg);

request.source(builder);

// 3. æ‰§è¡Œ
SearchResponse response = client.search(request, RequestOptions.DEFAULT);

// 4. è§£æç»“æœï¼ˆéœ€å¤šæ¬¡å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ï¼‰
Aggregations aggs = response.getAggregations();
ParsedTerms byCategory = aggs.get("by_category"); // â† å¿…é¡»çŸ¥é“è¿”å›çš„æ˜¯ ParsedTerms

for (ParsedBucket bucket : byCategory.getBuckets()) {
    String category = bucket.getKeyAsString();     // åˆ†ç»„ key
    long docCount = bucket.getDocCount();          // æ–‡æ¡£æ•°

    // è·å–å­èšåˆ â†’ å†æ¬¡ castï¼
    ParsedAvg avgPriceAgg = bucket.getAggregations().get("avg_price");
    double avgPrice = avgPriceAgg.getValue();

    System.out.println(category + ": " + docCount + " items, avg price = " + avgPrice);
}
```

> æ–°ç‰ˆï¼š
>
> ```java
> // æ‰§è¡Œå¸¦æ¡¶èšåˆçš„æŸ¥è¯¢
> SearchResponse<Void> response = client.search(s -> s
>     .index("products")
>     .size(0)
>     .aggregations("by_category", a -> a                    // èšåˆåç§°: by_category
>         .terms(t -> t                                      // æ¡¶èšåˆç±»å‹: terms
>             .field("category.keyword")                     // åˆ†ç»„å­—æ®µ
>             .size(10)                                      // è¿”å› top 10 ä¸ªåˆ†ç±»
>         )
>         .aggregations("avg_price", ag -> ag                // å­èšåˆ: avg_price
>             .avg(av -> av.field("price"))                  // è®¡ç®— price å¹³å‡å€¼
>         )
>     ),
>     Void.class
> );
> 
> // è§£æç»“æœï¼ˆå¼ºç±»å‹ï¼Œæ— éœ€ castï¼‰
> TermsAggregate categories = response.aggregations()
>     .get("by_category")
>     .sterms(); // sterm() è¡¨ç¤º standard termsï¼ˆé compositeï¼‰
> 
> for (TermsBucket bucket : categories.buckets().array()) {
>     String category = bucket.key();       // åˆ†ç»„ keyï¼ˆå¦‚ "Electronics"ï¼‰
>     long docCount = bucket.docCount();    // è¯¥åˆ†ç±»ä¸‹çš„æ–‡æ¡£æ•°
>     double avgPrice = bucket
>         .aggregations()
>         .get("avg_price")
>         .avg()
>         .value();                         // å­èšåˆç»“æœ
> 
>     System.out.println(category + ": " + docCount + " items, avg price = " + avgPrice);
> }
> ```

