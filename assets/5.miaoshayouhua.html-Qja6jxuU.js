import{_ as s,c as a,e as p,o as t}from"./app-DI6YVXtA.js";const e={};function o(l,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<p>在我们的现在所制定的业务中，是<strong>同步</strong>完成请求<strong>一条龙</strong>的，这就会造成一定的延迟。</p><p>为了让业务的返回更加迅速，我们可以尝试<strong>异步</strong>完成<strong>数据库的修改</strong>，而在提交这个异步操作之前，我们只需要校验所需的几个条件是否满足即可，比如优惠券下单的：<strong>库存超卖</strong>，<strong>一人一单</strong>锁。对于这两个的校验，<strong>后者</strong>我们使用<strong>分布式锁</strong>的方式实现了并发的阻塞，<strong>前者</strong>我们也可以将库存数据放到redis中，借助redis的<strong>单线程</strong>保证数据安全：</p><p>库存：</p><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody><tr><td>stock:vid:7</td><td>100</td></tr></tbody></table><p>有些优惠券是限制<strong>一人一个</strong>的，那么我们也可以redis的<strong>set</strong>集合来完成权限的查询，只需将已使用过的用户id放入对应优惠券的对应set集合即可：</p><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody><tr><td>order:vid:7</td><td>1,5,9</td></tr></tbody></table><p>好的，现在我们就只需要对库存以及一人一单的权限做校验并得到最终的<strong>订单id</strong>，然后减扣redis库存并将所需信息传给<strong>阻塞队列</strong>，让其他线程去异步完成数据库的相应操作即可！</p><p>这也就是对请求反应速率的优化方案——<strong>异步处理请求</strong>了，而在这种情况下，数据库的压力也会暴增，我们同样需要一种方式来实现数据压力的缓解，也即准备一个<strong>阻塞队列</strong>来作为缓冲区，使用固定的线程池/单线程获取其中数据来完成对数据库的操作。</p><blockquote><p>实际架构中常常提到的<strong>消息队列MQ</strong>是指在<strong>微服务架构</strong>下，作为多个服务之间相互调用的协调<strong>中间件</strong>，作为一个<strong>缓冲区</strong>会针对各个服务的负载情况进行调节。当然，两者都是起到了一个<strong>缓冲区</strong>，<strong>异步执行传入操作以不阻塞主线程</strong>的作用，但是阻塞队列倾向于作为一个缓冲区<strong>专门</strong>完成某一项任务，如这里的数据库操作（新建一个线程池/线程执行相应操作，不阻塞主线程）；而后者更倾向于协调<strong>多个服务</strong>之间的<strong>相互调用</strong>。</p></blockquote><h3 id="基于redis实现秒杀" tabindex="-1"><a class="header-anchor" href="#基于redis实现秒杀"><span>基于redis实现秒杀</span></a></h3><p>我们需要一些redis判断操作，比如判断库存，一人一单的问题，这些操作的数据准确性要求比较高，先前是使用了<strong>锁</strong>的方式来确保数据在并发下准确，而现在我们改为使用redis来判断后，就完全可以将所有操作写为lua脚本，redis执行lua就具有原子性以及互斥性了（单线程）</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment">-- 库存 key</span></span>
<span class="line"><span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">&quot;seckill:stock:&quot;</span> <span class="token operator">..</span> voucherId</span>
<span class="line"><span class="token comment">-- 订单 key</span></span>
<span class="line"><span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">&quot;seckill:order:&quot;</span> <span class="token operator">..</span> voucherId</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 判断库存是否充足</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- 库存不足</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 判断用户是否重复下单</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;sismember&quot;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- 用户重复下单</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">2</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 扣减库存</span></span>
<span class="line">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;incr&quot;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- 将用户记录到 set 集合中</span></span>
<span class="line">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;sadd&quot;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成这样的一个<strong>检验+修改</strong>的脚本以后，我们就可以通过判断执行完lua脚本得到的返回值来确定是否写入数据库了</p><p><strong>假如</strong>我们真的<strong>本地</strong>搓一个队列来完成对应的数据库操作的话（实际部署不会自己搓队列来充当完成异步操作的缓冲区的），我们可以这么干：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 秒杀优惠券</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">voucherId</span> 优惠券id</span>
<span class="line"> * <span class="token keyword">@return</span> 订单id</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 执行lua</span></span>
<span class="line">    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;请勿重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token class-name">Long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">VoucherOrder</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中script设置:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">SECKILL_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于<strong>阻塞队列</strong>，我们可以这样设计：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 秒杀订单队列</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 秒杀订单线程</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">SECKILL_ORDER_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 秒杀订单初始化</span></span>
<span class="line"><span class="token annotation punctuation">@PostConstruct</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">SECKILL_ORDER_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 秒杀订单处理线程</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 获取队列中的订单信息</span></span>
<span class="line">                <span class="token class-name">VoucherOrder</span> order <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 创建订单</span></span>
<span class="line">                <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Long</span> userId <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 创建锁对象</span></span>
<span class="line">    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 获取锁</span></span>
<span class="line">    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 判断是否获取锁成功</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;不允许重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 创建订单</span></span>
<span class="line">        self<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到我们使用<code>BlockingQueue</code>阻塞队列存储voucher信息，并配备了一个线程（在类加载完成时装载循环执行任务），其会循环尝试获取队列中的信息并完成写入以及修改操作（注意如果使用self自注入以解决代理绕过导致的事务失效的话，需要把createVoucherOrder放到interface接口里）</p><p>**当然实际业务中是不会进行如上操作的！以上仅做样例展示！**为什么这么说呢？</p><p>实际上我们可以一眼就发现以上操作将所有的阻塞操作都放到<strong>本地的jvm</strong>中执行，假如并发量比较大，那么就会非常鸡肋！不仅会存在<strong>爆栈</strong>的问题，还有可能会<strong>内存泄漏</strong>，而且对<strong>异常</strong>的处理也非常草率。</p><p>那么，我们要用什么成熟的组件来实现这么一个异步的阻塞队列呢？</p><hr><h3 id="消息队列" tabindex="-1"><a class="header-anchor" href="#消息队列"><span>消息队列</span></a></h3><p>消息队列（Message Queue，简称 <strong>MQ</strong>）是现代分布式系统中实现<strong>异步通信、解耦、流量削峰、可靠传递</strong>的核心中间件。它像一个“<strong>缓冲区</strong>”或“邮局”，让生产者和消费者无需直接通信，就能安全、高效地交换数据。</p><div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid" data-title="mermaid"><pre><code><span class="line"><span class="token keyword">graph</span> LR</span>
<span class="line">    A<span class="token text string">[用户注册]</span> <span class="token arrow operator">--&gt;</span> B<span class="token text string">[写入数据库]</span></span>
<span class="line">    B <span class="token arrow operator">--&gt;</span> C<span class="token text string">[发送消息到MQ]</span></span>
<span class="line">    C <span class="token arrow operator">--&gt;</span> D<span class="token text string">[返回成功]</span></span>
<span class="line">    C <span class="token arrow operator">--&gt;</span> E<span class="token text string">[邮件服务]</span></span>
<span class="line">    C <span class="token arrow operator">--&gt;</span> F<span class="token text string">[短信服务]</span></span>
<span class="line">    C <span class="token arrow operator">--&gt;</span> G<span class="token text string">[日志服务]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>问题</strong>：用户注册后要发邮件、短信、写日志……若同步执行，响应慢。</li><li><strong>解决</strong>：注册成功后，只写 DB + 发消息到 MQ，立即返回。其他操作由消费者异步完成。</li><li><strong>效果</strong>：<strong>响应时间从秒级降到毫秒级</strong>，用户体验提升。</li></ul><p>同时还可以实现<strong>应用解耦</strong></p><ul><li><strong>问题</strong>：订单系统直接调用库存、积分、通知服务 → 耦合高，任一服务故障导致订单失败。</li><li><strong>解决</strong>：订单系统只发消息到 MQ，各服务自行订阅。</li><li><strong>效果</strong>：<strong>服务独立演进，故障隔离</strong>。</li></ul><p>也可以实现<strong>流量削峰</strong></p><ul><li><strong>问题</strong>：秒杀活动瞬间百万请求，压垮数据库。</li><li><strong>解决</strong>：请求先入 MQ，后端按自身处理能力匀速消费。</li><li><strong>效果</strong>：<strong>系统不崩溃，请求不丢失</strong>（类似“水龙头”控制流速）。</li></ul><h4 id="核心机制与问题" tabindex="-1"><a class="header-anchor" href="#核心机制与问题"><span><strong>核心机制与问题</strong></span></a></h4><p><strong>🔐 1.</strong> <strong>消息可靠性（如何不丢消息？）</strong></p><ul><li><strong>生产者</strong>：开启 <strong>Confirm 机制</strong>（RabbitMQ）或 <strong>事务/幂等</strong>（Kafka）</li><li><strong>Broker</strong>：消息<strong>持久化到磁盘</strong>（非仅内存）</li><li><strong>消费者</strong>：<strong>手动 ACK</strong>，处理成功后再确认（避免自动 ACK 导致丢失）</li></ul><p><strong>🔁 2.</strong> <strong>消息重复（如何幂等？）</strong></p><ul><li><p>原因：网络超时重试、消费者重启等</p></li><li><p>解决方案：</p><ul><li>数据库唯一索引（如订单号）</li><li>Redis 记录已处理 ID（带过期时间）</li><li>业务状态机（如“待支付”→“已支付”）</li></ul></li></ul><p><strong>🔄 3.</strong> <strong>顺序消费</strong></p><ul><li>Kafka/RocketMQ 支持 <strong>单分区（Partition/Queue）内有序</strong></li><li>实现：相同 key 的消息路由到同一分区（如 <code>orderId % 分区数</code>）</li></ul><p><strong>🗑️ 4.</strong> <strong>死信队列（DLQ）</strong></p><ul><li>消息多次消费失败后，转入 DLQ 供人工排查</li><li>避免阻塞正常队列</li></ul>`,41)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/docs/heimadianping/yewusheji/5.miaoshayouhua.html","title":"秒杀优化","lang":"en-US","frontmatter":{"title":"秒杀优化","date":"2025-1-15"},"headers":[{"level":3,"title":"基于redis实现秒杀","slug":"基于redis实现秒杀","link":"#基于redis实现秒杀","children":[]},{"level":3,"title":"消息队列","slug":"消息队列","link":"#消息队列","children":[]}],"git":{"createdTime":1771155821000,"updatedTime":1771155821000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马点评/业务设计/5.秒杀优化.md"}');export{i as comp,u as data};
