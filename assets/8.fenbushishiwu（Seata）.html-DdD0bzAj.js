import{ar as p,as as i,ax as e,au as n,av as a,aw as l,ay as o,at as c}from"./app-DXmPnZac.js";const r={},d={href:"https://sca.aliyun.com/docs/2023/user-guide/seata/quick-start/",target:"_blank",rel:"noopener noreferrer"},u={href:"https://seata.apache.org/zh-cn/docs/ops/deploy-by-docker/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://sca.aliyun.com/docs/2023/user-guide/seata/quick-start/",target:"_blank",rel:"noopener noreferrer"};function m(v,s){const t=o("ExternalLinkIcon");return c(),i("div",null,[s[7]||(s[7]=e(`<p>分布式事务之所以“需要”，是因为在<strong>现代分布式系统架构</strong>（如微服务、云原生、多数据库部署）中，<strong>单个业务操作往往涉及多个独立的数据存储或服务节点</strong>。如果这些操作不能作为一个<strong>整体成功或失败</strong>，就会导致<strong>数据不一致</strong>，破坏业务的正确性和可靠性。</p><p>它要保证 <strong>“分布式环境下的 ACID”</strong>，尤其是：</p><ul><li><strong>原子性（Atomicity）</strong>：所有参与方要么全部提交，要么全部回滚；</li><li><strong>一致性（Consistency）</strong>：系统从一个合法状态转移到另一个合法状态；</li><li>（隔离性和持久性在分布式下较难完全保证，常做妥协）</li></ul><table><thead><tr><th style="text-align:left;">方案</th><th style="text-align:left;">原理</th><th style="text-align:left;">适用场景</th><th style="text-align:left;">特点</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>2PC（两阶段提交）</strong></td><td style="text-align:left;">协调者统一决策提交/回滚</td><td style="text-align:left;">强一致性要求高（如金融）</td><td style="text-align:left;">性能差、阻塞、单点故障</td></tr><tr><td style="text-align:left;"><strong>TCC（Try-Confirm-Cancel）</strong></td><td style="text-align:left;">业务层面实现补偿</td><td style="text-align:left;">高并发、可自定义补偿逻辑</td><td style="text-align:left;">开发复杂，但灵活高效</td></tr><tr><td style="text-align:left;"><strong>Saga 模式</strong></td><td style="text-align:left;">一长串本地事务 + 补偿回滚</td><td style="text-align:left;">长流程业务（如订单履约）</td><td style="text-align:left;">最终一致性，适合异步</td></tr><tr><td style="text-align:left;"><strong>消息队列（可靠消息）</strong></td><td style="text-align:left;">通过 MQ 保证操作最终执行</td><td style="text-align:left;">异步解耦场景（如发通知）</td><td style="text-align:left;">最终一致性，简单易用</td></tr><tr><td style="text-align:left;"><strong>Seata（AT模式）</strong></td><td style="text-align:left;">自动记录 undo log 实现回滚</td><td style="text-align:left;">Spring Cloud 微服务</td><td style="text-align:left;">对业务侵入小，但性能有损耗</td></tr></tbody></table><blockquote><p>✅ 实际系统中，<strong>很少追求强一致性</strong>，更多采用 <strong>“最终一致性” + 补偿机制</strong> 来平衡可用性与一致性（符合 CAP 定理）。</p></blockquote><h2 id="seata" tabindex="-1"><a class="header-anchor" href="#seata"><span>Seata</span></a></h2><p>Seata（<strong>Simple Extensible Autonomous Transaction Architecture</strong>）是阿里巴巴开源的一款 <strong>高性能、易用的分布式事务解决方案</strong>，现已成为 Apache 软件基金会的顶级项目（孵化中），广泛应用于微服务架构下的数据一致性保障场景。</p><p>Seata 采用 <strong>中心协调 + 分布式代理</strong> 架构，包含三个关键组件：</p><table><thead><tr><th style="text-align:left;">角色</th><th style="text-align:left;">全称</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>TC</strong></td><td style="text-align:left;">Transaction Coordinator（事务协调器）</td><td style="text-align:left;">全局事务的<strong>管理者</strong>，负责全局事务的 begin/commit/rollback 决策，并协调各分支事务。</td></tr><tr><td style="text-align:left;"><strong>TM</strong></td><td style="text-align:left;">Transaction Manager（事务管理器）</td><td style="text-align:left;">全局事务的<strong>发起者和终结者</strong>，通常位于主业务服务中，通过 <code>@GlobalTransactional</code> 注解开启全局事务。</td></tr><tr><td style="text-align:left;"><strong>RM</strong></td><td style="text-align:left;">Resource Manager（资源管理器）</td><td style="text-align:left;">分支事务的<strong>参与者</strong>，嵌入在各个微服务中，负责向 TC 注册分支事务，并上报本地事务状态。</td></tr></tbody></table><p>Seata 支持的几种主要事务模式：</p><table><thead><tr><th>事务模式</th><th>全称 / 类型</th><th>侵入性</th><th>一致性</th><th>性能</th><th>隔离性</th><th>适用场景</th><th>核心机制</th></tr></thead><tbody><tr><td>AT</td><td>Auto Transaction（自动事务）</td><td>⭐ 低（仅需注解 + undo_log 表）</td><td>最终一致（支持回滚）</td><td>⭐⭐⭐ 高（本地提交快）</td><td>弱（依赖全局锁）</td><td>普通业务（如订单+库存）</td><td>自动生成 undo log，自动回滚</td></tr><tr><td>TCC</td><td>Try-Confirm-Cancel</td><td>⭐⭐⭐ 高（需手写 try/confirm/cancel）</td><td>强一致</td><td>⭐⭐⭐⭐ 很高（无数据库回滚开销）</td><td>强（由业务控制）</td><td>高并发、资金类（如支付、转账）</td><td>业务级资源预留与确认</td></tr><tr><td>Saga</td><td>Long-running Transaction</td><td>⭐⭐ 中（需写补偿方法）</td><td>最终一致</td><td>⭐⭐⭐ 高（异步执行）</td><td>无（可能脏读）</td><td>长流程、异步任务（如审批、履约）</td><td>正向执行 + 反向补偿</td></tr><tr><td>XA</td><td>XA Protocol（标准 2PC）</td><td>⭐ 低（数据库原生支持）</td><td>强一致</td><td>⭐ 低（全程锁定资源）</td><td>强</td><td>传统金融系统（兼容老架构）</td><td>数据库层两阶段提交</td></tr></tbody></table><h2 id="部署tc服务" tabindex="-1"><a class="header-anchor" href="#部署tc服务"><span>部署TC服务</span></a></h2><p>我们可以简单理解<strong>TC服务</strong>为seata的<strong>单独服务</strong>用于<strong>处理所有的全局事务的server</strong>，TM以及RM为seata的<strong>client</strong>，作为依赖在service模块中部署，当发生调用的时候就会将信息传输到TC这个<strong>server</strong>中。那么作为额外的服务，TC需要我们去<strong>单独部署</strong>：</p><p>首先和配置nacos一样，我们需要为他准备一个数据库：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 脚本位置：seata/script/server/db/mysql.sql</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> seata<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">USE</span> seata<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 执行 mysql.sql 中的建表语句（global_table, branch_table, lock_table）</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15)),n("blockquote",null,[n("p",null,[s[1]||(s[1]=a("参考：",-1)),n("a",d,[s[0]||(s[0]=a("快速开始-阿里云Spring Cloud Alibaba官网",-1)),l(t)])])]),s[8]||(s[8]=e(`<p>然后准备好配置文件application.yml：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7099</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">logging</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>logback<span class="token punctuation">-</span>spring.xml</span>
<span class="line">  <span class="token key atrule">file</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>user.home<span class="token punctuation">}</span>/logs/seata</span>
<span class="line">  <span class="token comment"># extend:</span></span>
<span class="line">  <span class="token comment">#   logstash-appender:</span></span>
<span class="line">  <span class="token comment">#     destination: 127.0.0.1:4560</span></span>
<span class="line">  <span class="token comment">#   kafka-appender:</span></span>
<span class="line">  <span class="token comment">#     bootstrap-servers: 127.0.0.1:9092</span></span>
<span class="line">  <span class="token comment">#     topic: logback_to_logstash</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">console</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">user</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> file</span>
<span class="line">    <span class="token comment"># nacos:</span></span>
<span class="line">    <span class="token comment">#   server-addr: nacos:8848</span></span>
<span class="line">    <span class="token comment">#   group : &quot;DEFAULT_GROUP&quot;</span></span>
<span class="line">    <span class="token comment">#   namespace: &quot;&quot;</span></span>
<span class="line">    <span class="token comment">#   dataId: &quot;seataServer.properties&quot;</span></span>
<span class="line">    <span class="token comment">#   username: &quot;nacos&quot;</span></span>
<span class="line">    <span class="token comment">#   password: &quot;nacos&quot;</span></span>
<span class="line">  <span class="token key atrule">registry</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">      <span class="token key atrule">group</span> <span class="token punctuation">:</span> <span class="token string">&quot;DEFAULT_GROUP&quot;</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span></span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">&quot;nacos&quot;</span></span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">&quot;nacos&quot;</span></span>
<span class="line"><span class="token comment">#  server:</span></span>
<span class="line"><span class="token comment">#    service-port: 8091 #If not configured, the default is &#39;\${server.port} + 1000&#39;</span></span>
<span class="line">  <span class="token key atrule">security</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</span>
<span class="line">    <span class="token key atrule">tokenValidityInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span></span>
<span class="line">    <span class="token key atrule">ignore</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">urls</span><span class="token punctuation">:</span> /<span class="token punctuation">,</span>/<span class="token important">**/*.css</span><span class="token punctuation">,</span>/<span class="token important">**/*.js</span><span class="token punctuation">,</span>/<span class="token important">**/*.html</span><span class="token punctuation">,</span>/<span class="token important">**/*.map</span><span class="token punctuation">,</span>/<span class="token important">**/*.svg</span><span class="token punctuation">,</span>/<span class="token important">**/*.png</span><span class="token punctuation">,</span>/<span class="token important">**/*.ico</span><span class="token punctuation">,</span>/console<span class="token punctuation">-</span>fe/public/<span class="token important">**</span><span class="token punctuation">,</span>/api/v1/auth/login</span>
<span class="line">  <span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># service-port: 8091 #If not configured, the default is &#39;\${server.port} + 1000&#39;</span></span>
<span class="line">    <span class="token key atrule">max-commit-retry-timeout</span><span class="token punctuation">:</span> <span class="token number">-1</span></span>
<span class="line">    <span class="token key atrule">max-rollback-retry-timeout</span><span class="token punctuation">:</span> <span class="token number">-1</span></span>
<span class="line">    <span class="token key atrule">rollback-retry-timeout-unlock-enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">    <span class="token key atrule">enable-check-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">enable-parallel-request-handle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">retry-dead-threshold</span><span class="token punctuation">:</span> <span class="token number">130000</span></span>
<span class="line">    <span class="token key atrule">xaer-nota-retry-timeout</span><span class="token punctuation">:</span> <span class="token number">60000</span></span>
<span class="line">    <span class="token key atrule">enableParallelRequestHandle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">recovery</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">committing-retry-period</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">async-committing-retry-period</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">rollbacking-retry-period</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">timeout-retry-period</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">    <span class="token key atrule">undo</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">log-save-days</span><span class="token punctuation">:</span> <span class="token number">7</span></span>
<span class="line">      <span class="token key atrule">log-delete-period</span><span class="token punctuation">:</span> <span class="token number">86400000</span></span>
<span class="line">    <span class="token key atrule">session</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">branch-async-queue-size</span><span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token comment">#branch async remove queue size</span></span>
<span class="line">      <span class="token key atrule">enable-branch-async-remove</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#enable to asynchronous remove branchSession</span></span>
<span class="line">  <span class="token key atrule">store</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: file 、 db 、 redis</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> db</span>
<span class="line">    <span class="token key atrule">session</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">mode</span><span class="token punctuation">:</span> db</span>
<span class="line">    <span class="token key atrule">lock</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">mode</span><span class="token punctuation">:</span> db</span>
<span class="line">    <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">datasource</span><span class="token punctuation">:</span> druid</span>
<span class="line">      <span class="token key atrule">db-type</span><span class="token punctuation">:</span> mysql</span>
<span class="line">      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</span>
<span class="line">      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql<span class="token punctuation">:</span>3306/seata<span class="token punctuation">?</span>rewriteBatchedStatements=true<span class="token important">&amp;serverTimezone=UTC</span></span>
<span class="line">      <span class="token key atrule">user</span><span class="token punctuation">:</span> root</span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span></span>
<span class="line">      <span class="token key atrule">min-conn</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">      <span class="token key atrule">max-conn</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">      <span class="token key atrule">global-table</span><span class="token punctuation">:</span> global_table</span>
<span class="line">      <span class="token key atrule">branch-table</span><span class="token punctuation">:</span> branch_table</span>
<span class="line">      <span class="token key atrule">lock-table</span><span class="token punctuation">:</span> lock_table</span>
<span class="line">      <span class="token key atrule">distributed-lock-table</span><span class="token punctuation">:</span> distributed_lock</span>
<span class="line">      <span class="token key atrule">query-limit</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">5000</span></span>
<span class="line">    <span class="token comment"># redis:</span></span>
<span class="line">    <span class="token comment">#   mode: single</span></span>
<span class="line">    <span class="token comment">#   database: 0</span></span>
<span class="line">    <span class="token comment">#   min-conn: 10</span></span>
<span class="line">    <span class="token comment">#   max-conn: 100</span></span>
<span class="line">    <span class="token comment">#   password:</span></span>
<span class="line">    <span class="token comment">#   max-total: 100</span></span>
<span class="line">    <span class="token comment">#   query-limit: 1000</span></span>
<span class="line">    <span class="token comment">#   single:</span></span>
<span class="line">    <span class="token comment">#     host: 192.168.150.101</span></span>
<span class="line">    <span class="token comment">#     port: 6379</span></span>
<span class="line">  <span class="token key atrule">metrics</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">    <span class="token key atrule">registry-type</span><span class="token punctuation">:</span> compact</span>
<span class="line">    <span class="token key atrule">exporter-list</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">    <span class="token key atrule">exporter-prometheus-port</span><span class="token punctuation">:</span> <span class="token number">9898</span></span>
<span class="line">  <span class="token key atrule">transport</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">rpc-tc-request-timeout</span><span class="token punctuation">:</span> <span class="token number">15000</span></span>
<span class="line">    <span class="token key atrule">enable-tc-server-batch-send-response</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">    <span class="token key atrule">shutdown</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">wait</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">    <span class="token key atrule">thread-factory</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">boss-thread-prefix</span><span class="token punctuation">:</span> NettyBoss</span>
<span class="line">      <span class="token key atrule">worker-thread-prefix</span><span class="token punctuation">:</span> NettyServerNIOWorker</span>
<span class="line">      <span class="token key atrule">boss-thread-size</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意这里对于nacos以及mysql的ip直接使用名称就行的原因是他们都被部署到了docker中，而且共享一个网桥，所以可以直接使用docker容器名称，如非docker部署需要指明ip端口</p></blockquote>`,3)),n("p",null,[s[3]||(s[3]=a("然后准备一个seata的docker镜像：",-1)),n("a",u,[s[2]||(s[2]=a("Docker部署 | Apache Seata",-1)),l(t)]),s[4]||(s[4]=a("（或者网络可以直连docker直接运行命令）",-1))]),s[9]||(s[9]=e(`<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> seata <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-p</span> <span class="token number">8099</span>:8099 <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-p</span> <span class="token number">7099</span>:7099 <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-e</span> <span class="token assign-left variable">SEATA_IP</span><span class="token operator">=</span><span class="token number">192.168</span>.0.200 <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-v</span> ./seata:/seata-server/resources <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">--network</span> hm-net <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-d</span> <span class="token punctuation">\\</span></span>
<span class="line">seataio/seata-server:1.5.2 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>运行失败检查nacos，mysql网桥是否为所设置的那个：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> network <span class="token function">ls</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> inspect <span class="token punctuation">[</span>容器名<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>inspect的最后一项network查看所在网络区间</p><p>注意mysql以及nacos必须在seata同一网桥（hm-net）中，假如不在这个网桥中，就需要手动添加：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> network connect <span class="token punctuation">[</span>网络名<span class="token punctuation">]</span> <span class="token punctuation">[</span>容器名<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></blockquote><p>成功连接我们就可以在nacos中看到连接实例了，访问seata：http://192.168.0.200:7099/</p><h2 id="微服务调用seata" tabindex="-1"><a class="header-anchor" href="#微服务调用seata"><span>微服务调用seata</span></a></h2><h3 id="引入依赖" tabindex="-1"><a class="header-anchor" href="#引入依赖"><span>引入依赖</span></a></h3><div class="language-XML line-numbers-mode" data-highlighter="prismjs" data-ext="XML" data-title="XML"><pre><code><span class="line">&lt;!--统一配置管理--&gt;</span>
<span class="line">  &lt;dependency&gt;</span>
<span class="line">      &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span>
<span class="line">      &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span>
<span class="line">  &lt;/dependency&gt;</span>
<span class="line">  &lt;!--读取bootstrap文件--&gt;</span>
<span class="line">  &lt;dependency&gt;</span>
<span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span>
<span class="line">      &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;</span>
<span class="line">  &lt;/dependency&gt;</span>
<span class="line">  &lt;!--seata--&gt;</span>
<span class="line">  &lt;dependency&gt;</span>
<span class="line">      &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span>
<span class="line">      &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;</span>
<span class="line">  &lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>父项目pom已做好依赖管理</p></blockquote><h3 id="修改配置" tabindex="-1"><a class="header-anchor" href="#修改配置"><span>修改配置</span></a></h3><p>准备一个yml配置文件：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">registry</span><span class="token punctuation">:</span> <span class="token comment"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos <span class="token comment"># 注册中心类型 nacos</span></span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.200<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span> <span class="token comment"># namespace，默认为空</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP <span class="token comment"># 分组，默认是DEFAULT_GROUP</span></span>
<span class="line">      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server <span class="token comment"># seata服务名称</span></span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> hmall <span class="token comment"># 事务组名称</span></span>
<span class="line">  <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">vgroup-mapping</span><span class="token punctuation">:</span> <span class="token comment"># 事务组与tc集群的映射关系</span></span>
<span class="line">      <span class="token key atrule">hmall</span><span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里因为基本所有的service服务都需要连接到seata，所以我们可以考虑将这个yml放到nacos中，service服务直接在bootstrap中引入指定配置文件。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> cart<span class="token punctuation">-</span>service <span class="token comment"># 服务名称</span></span>
<span class="line">  <span class="token key atrule">profiles</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.200<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span></span>
<span class="line">      <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># 文件后缀名</span></span>
<span class="line">        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span> <span class="token comment"># 共享配置</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>jdbc.yml <span class="token comment"># 共享mybatis配置</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>log.yml <span class="token comment"># 共享日志配置</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>swagger.yml <span class="token comment"># 共享日志配置</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>seata.yml <span class="token comment"># seata配置</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并配置好application文件：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">okhttp</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启OKHttp连接池支持</span></span>
<span class="line"><span class="token key atrule">hm</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">swagger</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">title</span><span class="token punctuation">:</span> 购物车服务接口文档</span>
<span class="line">    <span class="token key atrule">package</span><span class="token punctuation">:</span> com.hmall.cart.controller</span>
<span class="line">  <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">database</span><span class="token punctuation">:</span> hm<span class="token punctuation">-</span>cart</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">transport</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8090</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后就可以启动服务连接到seata的TC服务了，接下来我们就可以使用<code>@GlobalTransactional</code>来接入分布式事务了。</p><h2 id="xa模式" tabindex="-1"><a class="header-anchor" href="#xa模式"><span>XA模式</span></a></h2><p>XA 模式是 Seata 提供的一种<strong>基于数据库原生 XA 协议的分布式事务解决方案</strong>，它实现了经典的 <strong>两阶段提交（2PC, Two-Phase Commit）</strong>，能够提供<strong>强一致性</strong>保证。虽然在现代高并发微服务架构中使用较少（因性能和锁竞争问题），但在<strong>对数据一致性要求极高的传统金融、支付等场景</strong>中仍有重要价值。</p><p>实际就是<strong>多个事务共进退</strong>，TM为发起的事务，RM为所涉及到的事务，一回滚则全部回滚。</p><blockquote><p>✅ XA 协议的核心：<strong>让多个数据库像一个数据库一样支持 ACID 事务</strong>。</p></blockquote><p>Seata 的 XA 模式<strong>直接利用数据库自身的 XA 能力</strong>，不依赖 undo log 或业务补偿，流程如下：</p><h3 id="流程概要-2pc" tabindex="-1"><a class="header-anchor" href="#流程概要-2pc"><span>流程概要（2PC）</span></a></h3><p><strong>第一阶段：Prepare（准备）</strong></p><ol><li>TM（主服务）向 TC 发起全局事务；</li><li>各 RM（微服务）执行本地 SQL，并调用数据库的 <code>XA START</code> / <code>XA END</code> / <code>XA PREPARE</code>；</li><li>数据库将事务日志写入 redo/undo 日志，<strong>但不提交</strong>，进入“prepared”状态；</li><li>RM 向 TC 报告 prepare 成功。</li></ol><p><strong>第二阶段：Commit / Rollback（提交或回滚）</strong></p><ul><li><strong>如果所有 RM prepare 成功</strong> → TC 发送 <code>XA COMMIT</code> → 各数据库真正提交；</li><li><strong>任一 RM prepare 失败</strong> → TC 发送 <code>XA ROLLBACK</code> → 各数据库回滚。</li></ul><blockquote><p>⚠️ 注意：在 Seata XA 模式中，<strong>TM 直接与数据库交互</strong>（通过 JDBC XADataSource），TC 只负责协调决策。</p></blockquote><h3 id="对比at模式" tabindex="-1"><a class="header-anchor" href="#对比at模式"><span>对比AT模式</span></a></h3><table><thead><tr><th style="text-align:left;">特性</th><th style="text-align:left;">XA 模式</th><th style="text-align:left;">AT 模式</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>一致性</strong></td><td style="text-align:left;">✅ 强一致（ACID）</td><td style="text-align:left;">最终一致（可能短暂不一致）</td></tr><tr><td style="text-align:left;"><strong>隔离性</strong></td><td style="text-align:left;">✅ 强（数据库级锁）</td><td style="text-align:left;">弱（需全局锁防脏写）</td></tr><tr><td style="text-align:left;"><strong>性能</strong></td><td style="text-align:left;">❌ 低（全程持有 DB 锁，阻塞时间长）</td><td style="text-align:left;">✅ 高（第一阶段就释放本地锁）</td></tr><tr><td style="text-align:left;"><strong>侵入性</strong></td><td style="text-align:left;">低（只需配置 XA 数据源）</td><td style="text-align:left;">低（需 undo_log 表）</td></tr><tr><td style="text-align:left;"><strong>数据库支持</strong></td><td style="text-align:left;">需数据库支持 XA（MySQL 5.7+、Oracle、DB2 等）</td><td style="text-align:left;">仅需普通 JDBC + 主键</td></tr><tr><td style="text-align:left;"><strong>适用场景</strong></td><td style="text-align:left;">金融核心系统、强一致性要求</td><td style="text-align:left;">普通电商、互联网业务</td></tr></tbody></table><h3 id="配置与使用" tabindex="-1"><a class="header-anchor" href="#配置与使用"><span>配置与使用</span></a></h3><p><strong>配置：</strong></p><p>在完成了seata的配置与部署后，我们只需要在yml配置文件中指定模式：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">data-source-proxy-mode</span><span class="token punctuation">:</span> XA</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>即可完成对XA模式的指定</p><blockquote><p>注意相关服务都需要指定模式为XA，所以还是推荐将配置放到nacos中统一配置</p></blockquote><p><strong>使用：</strong></p><p>想要使用XA模式也很简单，我们只需要在<strong>全局事务的入口service方法</strong>注明注解<code>@GlobalTransactional</code>：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token annotation punctuation">@GlobalTransactional</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderFormDTO</span> orderFormDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后保证<strong>所涉及的所有service方法</strong>都有<code>@Transactional</code>保证事务记录存在即可完成全局事务的使用。</p><p>那么现在当我们在全局事务中的任意一个事务（全局事务发起者TM/分支事务RM）发生了错误，抛出了异常时，所有的事务都会进行回滚。</p><h2 id="at模式" tabindex="-1"><a class="header-anchor" href="#at模式"><span>AT模式</span></a></h2><p>Seata 的 <strong>AT 模式（Auto Transaction Mode）</strong> 是其最常用、对业务侵入性最低的分布式事务解决方案。它通过<strong>自动拦截和解析 SQL</strong>，在不修改业务代码的前提下，实现<strong>分布式场景下的自动回滚与提交</strong>，让开发者“像使用本地事务一样”处理跨服务数据一致性。</p><p>AT 模式将传统 2PC 的<strong>同步阻塞</strong>优化为：</p><ul><li><strong>第一阶段</strong>：本地事务直接提交（高性能）；</li><li><strong>第二阶段</strong>：仅在需要回滚时，通过 <strong>undo log</strong> 执行反向 SQL。</li></ul><blockquote><p>✅ 目标：<strong>在保证最终一致性的前提下，最大化系统吞吐量</strong>。</p></blockquote><h3 id="流程概要" tabindex="-1"><a class="header-anchor" href="#流程概要"><span>流程概要</span></a></h3><p><strong>1.第一阶段：本地提交 + 生成 undo log</strong></p><p>当执行一条 SQL（如 <code>UPDATE account SET balance = balance - 100 WHERE id = 1</code>）时，Seata 的 JDBC 代理会：</p><p><strong>（1）解析 SQL，生成before image和after image</strong></p><ul><li><strong>before image</strong>：执行前的数据快照（<code>id=1, balance=500</code>）</li><li><strong>after image</strong>：执行后的数据快照（<code>id=1, balance=400</code>）</li></ul><p><strong>（2）将 undo log 写入业务数据库的</strong> <code>undo_log</code> <strong>表</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> undo_log <span class="token punctuation">(</span>branch_id<span class="token punctuation">,</span> xid<span class="token punctuation">,</span> context<span class="token punctuation">,</span> rollback_info<span class="token punctuation">,</span> log_status<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">VALUES</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&#39;branch-123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&#39;xid-abc&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&#39;{&quot;serializer&quot;:&quot;jackson&quot;}&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&#39;{</span>
<span class="line">    &quot;tableName&quot;: &quot;account&quot;,</span>
<span class="line">    &quot;beforeImage&quot;: {&quot;rows&quot;: [{&quot;fields&quot;: [{&quot;name&quot;:&quot;id&quot;,&quot;value&quot;:1}, {&quot;name&quot;:&quot;balance&quot;,&quot;value&quot;:500}]}]},</span>
<span class="line">    &quot;afterImage&quot;:  {&quot;rows&quot;: [{&quot;fields&quot;: [{&quot;name&quot;:&quot;id&quot;,&quot;value&quot;:1}, {&quot;name&quot;:&quot;balance&quot;,&quot;value&quot;:400}]}]}</span>
<span class="line">  }&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>（3）本地事务提交（业务数据 + undo_log 原子提交）</strong></p><blockquote><p>✅ 优点：<strong>第一阶段就释放数据库行锁</strong>，避免长时间持有锁导致性能瓶颈。</p></blockquote><hr><p><strong>2.第二阶段：提交 or 回滚</strong></p><p><strong>✅ 全局提交（Commit）</strong></p><ul><li>TC 通知各 RM <strong>异步删除对应的 undo_log</strong>；</li><li>无额外数据库操作，<strong>性能极高</strong>。</li></ul><p><strong>❌ 全局回滚（Rollback）</strong></p><ul><li><p>TC 通知 RM 执行回滚；</p></li><li><p>RM 读取 <code>undo_log</code> 中的 <strong>before image</strong>；</p></li><li><p>构造反向 SQL 并执行：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance <span class="token operator">=</span> <span class="token number">500</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>验证 <strong>after image 是否匹配当前数据</strong>（防止脏写），若不匹配则回滚失败（需人工介入）。</p></li></ul><blockquote><p>🔒 <strong>全局锁机制</strong>：在第一阶段注册分支事务时，Seata 会向 TC 申请<strong>全局行锁</strong>（如 <code>account:1</code>），防止其他全局事务并发修改同一行，避免回滚时数据不一致。</p></blockquote><h3 id="使用要求" tabindex="-1"><a class="header-anchor" href="#使用要求"><span>使用要求</span></a></h3><table><thead><tr><th style="text-align:left;">要求</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>1. 业务表必须有主键</strong></td><td style="text-align:left;">Seata 通过主键定位行进行回滚</td></tr><tr><td style="text-align:left;"><strong>2. 必须创建 <code>undo_log</code> 表</strong></td><td style="text-align:left;">每个参与 AT 事务的数据库都要有</td></tr><tr><td style="text-align:left;"><strong>3. SQL 需满足限制</strong></td><td style="text-align:left;">不支持： - 无 WHERE 的 UPDATE/DELETE - 多表 JOIN 更新 - <code>INSERT INTO ... SELECT</code> - 子查询等复杂语句</td></tr><tr><td style="text-align:left;"><strong>4. 使用 Seata 数据源代理</strong></td><td style="text-align:left;">Spring Boot 中自动集成，无需手动包装</td></tr></tbody></table><h3 id="对比xa模式" tabindex="-1"><a class="header-anchor" href="#对比xa模式"><span>对比XA模式</span></a></h3><table><thead><tr><th style="text-align:left;">维度</th><th style="text-align:left;"><strong>XA 模式</strong></th><th style="text-align:left;"><strong>AT 模式</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>一致性级别</strong></td><td style="text-align:left;">✅ <strong>强一致</strong>（事务结束即一致）</td><td style="text-align:left;">⚠️ <strong>最终一致</strong>（回滚时可能短暂不一致）</td></tr><tr><td style="text-align:left;"><strong>锁持有时间</strong></td><td style="text-align:left;">🔒 <strong>全程持有 DB 行锁</strong>（直到 commit/rollback）</td><td style="text-align:left;">🔓 <strong>第一阶段结束后立即释放本地锁</strong></td></tr><tr><td style="text-align:left;"><strong>提交模型</strong></td><td style="text-align:left;">标准 <strong>同步两阶段提交（2PC）</strong></td><td style="text-align:left;"><strong>一阶段提交 + 二阶段异步回滚</strong></td></tr><tr><td style="text-align:left;"><strong>性能</strong></td><td style="text-align:left;">❌ 低（高并发下易阻塞、死锁）</td><td style="text-align:left;">✅ 高（本地快速提交，无长时间锁）</td></tr><tr><td style="text-align:left;"><strong>实现依赖</strong></td><td style="text-align:left;">依赖数据库原生 <strong>XA 协议支持</strong></td><td style="text-align:left;">依赖 Seata <strong>SQL 解析 + undo log</strong></td></tr><tr><td style="text-align:left;"><strong>数据回滚方式</strong></td><td style="text-align:left;">数据库原生 XA ROLLBACK</td><td style="text-align:left;">Seata 构造反向 SQL 执行回滚</td></tr><tr><td style="text-align:left;"><strong>隔离性</strong></td><td style="text-align:left;">✅ 强（由数据库保证）</td><td style="text-align:left;">⚠️ 弱（需 Seata 全局锁防脏写）</td></tr><tr><td style="text-align:left;"><strong>典型场景</strong></td><td style="text-align:left;">银行转账、金融核心系统</td><td style="text-align:left;">电商下单、普通微服务</td></tr></tbody></table><h3 id="配置与使用-1" tabindex="-1"><a class="header-anchor" href="#配置与使用-1"><span>配置与使用</span></a></h3><p>首先需要在数据库中准备好一张undolog表：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span></span>
<span class="line"><span class="token punctuation">(</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span>     <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>context<span class="token punctuation">\`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>rollback_info<span class="token punctuation">\`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_status<span class="token punctuation">\`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_modified<span class="token punctuation">\`</span></span>  <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>ux_undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span></span>
<span class="line">  <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COMMENT</span> <span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,67)),n("p",null,[s[6]||(s[6]=a("参考：",-1)),n("a",k,[s[5]||(s[5]=a("快速开始-阿里云Spring Cloud Alibaba官网",-1)),l(t)])]),s[10]||(s[10]=e(`<blockquote><p>注意版本</p></blockquote><p>然后我们修改配置文件：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">data-source-proxy-mode</span><span class="token punctuation">:</span> AT</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事实上默认即是AT模式，不填也会启用AT模式</p><h2 id="选xa还是at" tabindex="-1"><a class="header-anchor" href="#选xa还是at"><span>选XA还是AT？</span></a></h2><table><thead><tr><th style="text-align:left;">你的需求</th><th style="text-align:left;">推荐模式</th></tr></thead><tbody><tr><td style="text-align:left;">“钱不能错一分” + 并发不高</td><td style="text-align:left;">✅ <strong>XA 模式</strong></td></tr><tr><td style="text-align:left;">“用户体验要快” + 可接受短暂不一致</td><td style="text-align:left;">✅ <strong>AT 模式</strong></td></tr><tr><td style="text-align:left;">系统基于 MySQL/Oracle 且支持 XA</td><td style="text-align:left;">XA 可选</td></tr><tr><td style="text-align:left;">系统是互联网高并发业务</td><td style="text-align:left;">❌ 避免 XA，选 AT/TCC</td></tr></tbody></table><p>追求性能，不需要强一致性（不需要保证时时刻刻都一致）：选择<strong>AT</strong></p><p>追求一致性，性能要求不高：选择<strong>XA</strong></p><p>XA：全锁住！都对了再提交！错了一个我就全局事务回滚！</p><p>AT：自己的事务锁了就行，先提交再说，错了一个我用记录的undolog覆盖实现全局事务回滚。</p>`,10))])}const b=p(r,[["render",m]]),y=JSON.parse('{"path":"/docs/heimashangcheng/weifuwu/8.fenbushishiwu（Seata）.html","title":"分布式事务","lang":"en-US","frontmatter":{"title":"分布式事务","date":"2026-2-10"},"headers":[{"level":2,"title":"Seata","slug":"seata","link":"#seata","children":[]},{"level":2,"title":"部署TC服务","slug":"部署tc服务","link":"#部署tc服务","children":[]},{"level":2,"title":"微服务调用seata","slug":"微服务调用seata","link":"#微服务调用seata","children":[{"level":3,"title":"引入依赖","slug":"引入依赖","link":"#引入依赖","children":[]},{"level":3,"title":"修改配置","slug":"修改配置","link":"#修改配置","children":[]}]},{"level":2,"title":"XA模式","slug":"xa模式","link":"#xa模式","children":[{"level":3,"title":"流程概要（2PC）","slug":"流程概要-2pc","link":"#流程概要-2pc","children":[]},{"level":3,"title":"对比AT模式","slug":"对比at模式","link":"#对比at模式","children":[]},{"level":3,"title":"配置与使用","slug":"配置与使用","link":"#配置与使用","children":[]}]},{"level":2,"title":"AT模式","slug":"at模式","link":"#at模式","children":[{"level":3,"title":"流程概要","slug":"流程概要","link":"#流程概要","children":[]},{"level":3,"title":"使用要求","slug":"使用要求","link":"#使用要求","children":[]},{"level":3,"title":"对比XA模式","slug":"对比xa模式","link":"#对比xa模式","children":[]},{"level":3,"title":"配置与使用","slug":"配置与使用-1","link":"#配置与使用-1","children":[]}]},{"level":2,"title":"选XA还是AT？","slug":"选xa还是at","link":"#选xa还是at","children":[]}],"git":{"createdTime":1771338216000,"updatedTime":1771338216000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马商城/微服务/8.分布式事务（Seata）.md"}');export{b as comp,y as data};
