import{ar as o,as as c,au as s,av as a,aw as e,ax as p,ay as l,at as r}from"./app-BEAZiIq9.js";const d={},u={href:"https://v2.vuepress.vuejs.org/zh/reference/plugin-api.html",target:"_blank",rel:"noopener noreferrer"};function k(m,n){const t=l("MermaidDiagram"),i=l("ExternalLinkIcon");return r(),c("div",null,[n[2]||(n[2]=s("p",null,[a("reco 风格没有实现 mermaid 渲染，直接使用 "),s("strong",null,"mdenhance"),a(" 又会发现 vuepress 版本对不上，那我们就自己手搓一个吧✋️")],-1)),n[3]||(n[3]=s("h2",{id:"vuepress-的渲染逻辑",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#vuepress-的渲染逻辑"},[s("span",null,"VuePress 的渲染逻辑")])],-1)),n[4]||(n[4]=s("p",null,"首先我们要了解一下 VuePress 的渲染逻辑：",-1)),e(t,{code:"flowchart%20LR%0A%20%20%20%20subgraph%20Step1%5B%22%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9AMarkdown%20%E8%A7%A3%E6%9E%90%22%5D%0A%20%20%20%20%20%20%20%20MD%5B%22%F0%9F%93%84%20Markdown%3Cbr%2F%3E(.md%20%E6%96%87%E4%BB%B6)%22%5D%0A%20%20%20%20%20%20%20%20MD_IT%5B%22%E2%9A%99%EF%B8%8F%20markdown-it%3Cbr%2F%3E%E8%A7%A3%E6%9E%90%E6%B8%B2%E6%9F%93%22%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20Step2%5B%22%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9AVue%20%E7%BC%96%E8%AF%91%22%5D%0A%20%20%20%20%20%20%20%20VUE%5B%22%F0%9F%93%A6%20Vue%20SFC%3Cbr%2F%3E(.vue%20%E7%BB%84%E4%BB%B6)%22%5D%0A%20%20%20%20%20%20%20%20VUE_COMPILER%5B%22%F0%9F%94%A7%20vue-compiler%3Cbr%2F%3E%E7%BC%96%E8%AF%91%E7%BB%84%E4%BB%B6%22%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20subgraph%20Step3%5B%22%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%9D%99%E6%80%81%E6%9E%84%E5%BB%BA%22%5D%0A%20%20%20%20%20%20%20%20HTML%5B%22%F0%9F%8C%90%20%E9%9D%99%E6%80%81%20HTML%3Cbr%2F%3E(%2Fdist%20%E7%9B%AE%E5%BD%95)%22%5D%0A%20%20%20%20%20%20%20%20VITE%5B%22%F0%9F%9A%80%20Vite%2FSSG%3Cbr%2F%3E%E6%89%93%E5%8C%85%E6%9E%84%E5%BB%BA%22%5D%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20MD%20--%3E%20MD_IT%0A%20%20%20%20MD_IT%20--%3E%20VUE%0A%20%20%20%20VUE%20--%3E%20VUE_COMPILER%0A%20%20%20%20VUE_COMPILER%20--%3E%20HTML%0A%20%20%20%20HTML%20--%3E%20VITE%0A%20%20%20%20%0A%20%20%20%20style%20Step1%20fill%3A%23e1f5fe%2Cstroke%3A%23039be5%2Cstroke-width%3A2px%0A%20%20%20%20style%20Step2%20fill%3A%23fff3e0%2Cstroke%3A%23fb8c00%2Cstroke-width%3A2px%0A%20%20%20%20style%20Step3%20fill%3A%23e8f5e9%2Cstroke%3A%2343a047%2Cstroke-width%3A2px%0A%20%20%20%20style%20MD%20fill%3A%23ffffff%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A%20%20%20%20style%20VUE%20fill%3A%23ffffff%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A%20%20%20%20style%20HTML%20fill%3A%23ffffff%2Cstroke%3A%23333%2Cstroke-width%3A1px%0A"}),n[5]||(n[5]=p('<p>也就是说我们可以简单理解为 <strong>md 文件 → vue → 静态 web</strong> 这样的渲染过程。</p><p>在这个流程中，我们有两个关键切入点：</p><ol><li><strong>Markdown 解析阶段</strong>：通过 <code>extendsMarkdown</code> 拦截 fence 代码块</li><li><strong>Vue 客户端增强阶段</strong>：通过 <code>clientConfigFile</code> 注册全局组件</li></ol><h2 id="两种方案" tabindex="-1"><a class="header-anchor" href="#两种方案"><span>两种方案</span></a></h2><p>VuePress 其实为插件制作提供了很多接口，针对 Mermaid 渲染主要有两种方案：</p><table><thead><tr><th>方案</th><th>渲染时机</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>构建时渲染</strong></td><td><code>extendsMarkdown</code> 中直接mermaid.render()生成 SVG，在第一阶段就完成svg图的生成</td><td>SSR 友好、SEO 好、无闪烁</td><td>构建慢、主题切换困难</td></tr><tr><td><strong>运行时渲染</strong></td><td>第一阶段拦截完成后做成一个<strong>Component</strong>组件，第二阶段利用客户端组件enhance vue挂载这个的Component并调用mermaid.render()完成渲染</td><td>构建快、支持动态特性</td><td>有 FOUC、需客户端 JS</td></tr></tbody></table>',6)),s("blockquote",null,[s("p",null,[n[1]||(n[1]=a("vuepress的接口说明文档：",-1)),s("a",u,[n[0]||(n[0]=a("插件 API | VuePress",-1)),e(i)])])]),n[6]||(n[6]=p(`<p>考虑到我们的需求（文档站、主题可能切换、构建速度），<strong>选择运行时渲染方案</strong>更合适。</p><h2 id="插件实现" tabindex="-1"><a class="header-anchor" href="#插件实现"><span>插件实现</span></a></h2><h3 id="安装依赖" tabindex="-1"><a class="header-anchor" href="#安装依赖"><span><strong>安装依赖</strong></span></a></h3><p>首先需要安装 <code>mermaid</code> 包：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># npm</span></span>
<span class="line"><span class="token function">npm</span> <span class="token function">install</span> mermaid</span>
<span class="line"></span>
<span class="line"><span class="token comment"># pnpm</span></span>
<span class="line"><span class="token function">pnpm</span> <span class="token function">add</span> mermaid</span>
<span class="line"></span>
<span class="line"><span class="token comment"># yarn</span></span>
<span class="line"><span class="token function">yarn</span> <span class="token function">add</span> mermaid</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装完成可以到package.json查看是否已经完成安装：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;mermaid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^11.12.2&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    ......</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="目录结构" tabindex="-1"><a class="header-anchor" href="#目录结构"><span>目录结构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">.vuepress/</span>
<span class="line">├── plugins/</span>
<span class="line">│   ├── mermaid.ts          # 插件主文件（Node 端）</span>
<span class="line">│   └── mermaid.client.ts   # 客户端增强文件（Browser 端）</span>
<span class="line">└── config.ts               # VuePress 配置文件</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="插件主文件" tabindex="-1"><a class="header-anchor" href="#插件主文件"><span>插件主文件</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// .vuepress/plugins/mermaid.ts</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vuepress/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vuepress/utils&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> mermaidPlugin<span class="token operator">:</span> Plugin <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  name<span class="token operator">:</span> <span class="token string">&#39;mermaid-plugin&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 扩展 Markdown 渲染规则</span></span>
<span class="line">  <span class="token function-variable function">extendsMarkdown</span><span class="token operator">:</span> <span class="token punctuation">(</span>md<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> defaultFence <span class="token operator">=</span> md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>fence</span>
<span class="line">    </span>
<span class="line">    md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">fence</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">[</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">]</span> <span class="token operator">=</span> args</span>
<span class="line">      <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// 检查代码块的语言标识是否为 &#39;mermaid&#39;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>info<span class="token operator">?.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;mermaid&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;MermaidDiagram code=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; /&gt;</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> defaultFence<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 指定客户端配置文件路径</span></span>
<span class="line">  clientConfigFile<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./mermaid.client.ts&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> mermaidPlugin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关键点说明：</strong></p><ul><li><code>extendsMarkdown</code>：在 Markdown 解析阶段拦截 \`\`\`\`mermaid\` 代码块</li><li><code>encodeURIComponent</code>：对代码内容进行编码，防止特殊字符破坏 HTML 属性</li><li><code>clientConfigFile</code>：指向客户端增强文件，用于注册全局组件</li></ul><h3 id="客户端增强文件" tabindex="-1"><a class="header-anchor" href="#客户端增强文件"><span>客户端增强文件</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// .vuepress/plugins/mermaid.client.ts</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineClientConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vuepress/client&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> h<span class="token punctuation">,</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span></span>
<span class="line"><span class="token keyword">import</span> mermaid <span class="token keyword">from</span> <span class="token string">&#39;mermaid&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 初始化 mermaid 配置</span></span>
<span class="line">mermaid<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  startOnLoad<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token comment">// 不自动渲染，手动控制</span></span>
<span class="line">  theme<span class="token operator">:</span> <span class="token string">&#39;default&#39;</span><span class="token punctuation">,</span>        <span class="token comment">// 默认主题</span></span>
<span class="line">  securityLevel<span class="token operator">:</span> <span class="token string">&#39;loose&#39;</span>   <span class="token comment">// 宽松模式（注意安全风险）</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义 MermaidDiagram 组件</span></span>
<span class="line"><span class="token keyword">const</span> MermaidDiagram <span class="token operator">=</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> decoded <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">mermaid-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> svg <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> mermaid<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> decoded<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> svg</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Mermaid render error:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&#39;&lt;pre style=&quot;color:red&quot;&gt;Mermaid 图表渲染失败&lt;/pre&gt;&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;mermaid-diagram&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      style<span class="token operator">:</span> <span class="token punctuation">{</span> textAlign<span class="token operator">:</span> <span class="token string">&#39;center&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册全局组件</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;MermaidDiagram&#39;</span><span class="token punctuation">,</span> MermaidDiagram<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关键点说明：</strong></p><ul><li><code>startOnLoad: false</code>：禁用自动渲染，避免与手动渲染冲突</li><li><strong>唯一 ID 生成</strong>：增加了 <code>Math.random()</code> 确保快速连续渲染时 ID 不冲突</li><li><strong>错误处理</strong>：渲染失败时显示友好提示，不影响页面其他内容</li><li><code>defineClientConfig</code>：VuePress 2.x 的客户端配置标准方式</li></ul><h3 id="配置文件集成" tabindex="-1"><a class="header-anchor" href="#配置文件集成"><span>配置文件集成</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// .vuepress/config.ts</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineUserConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vuepress&quot;</span></span>
<span class="line"><span class="token keyword">import</span> recoTheme <span class="token keyword">from</span> <span class="token string">&quot;vuepress-theme-reco&quot;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> viteBundler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vuepress/bundler-vite&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> mermaidPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./plugins/mermaid&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineUserConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  title<span class="token operator">:</span> <span class="token string">&quot;SaltFishGC\`s Blog&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  bundler<span class="token operator">:</span> <span class="token function">viteBundler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  plugins<span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    mermaidPlugin</span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  theme<span class="token operator">:</span> <span class="token function">recoTheme</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// reco 主题配置...</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="使用示例" tabindex="-1"><a class="header-anchor" href="#使用示例"><span>使用示例</span></a></h2><p>在 Markdown 文件中直接使用：</p><div class="language-markdown line-numbers-mode" data-highlighter="prismjs" data-ext="md" data-title="md"><pre><code><span class="line"><span class="token code"><span class="token punctuation">\`\`\`</span><span class="token code-language">mermaid</span></span>
<span class="line"><span class="token code-block language-mermaid">graph TD</span>
<span class="line">    A[开始] --&gt; B{条件判断}</span>
<span class="line">    B --&gt;|是 | C[执行操作]</span>
<span class="line">    B --&gt;|否 | D[结束]</span>
<span class="line">    C --&gt; D</span></span>
<span class="line"><span class="token punctuation">\`\`\`</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>渲染效果：</p>`,23)),e(t,{code:"graph%20TD%0A%20%20%20%20A%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%7B%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%20%7C%20C%5B%E6%89%A7%E8%A1%8C%E6%93%8D%E4%BD%9C%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%20%7C%20D%5B%E7%BB%93%E6%9D%9F%5D%0A%20%20%20%20C%20--%3E%20D%0A"}),n[7]||(n[7]=p(`<h3 id="更多图表类型" tabindex="-1"><a class="header-anchor" href="#更多图表类型"><span>更多图表类型</span></a></h3><p><strong>序列图：</strong></p><div class="language-markdown line-numbers-mode" data-highlighter="prismjs" data-ext="md" data-title="md"><pre><code><span class="line"><span class="token code"><span class="token punctuation">\`\`\`</span><span class="token code-language">mermaid</span></span>
<span class="line"><span class="token code-block language-mermaid">sequenceDiagram</span>
<span class="line">    Alice-&gt;&gt;John: Hello John, how are you?</span>
<span class="line">    John--&gt;&gt;Alice: Great!</span></span>
<span class="line"><span class="token punctuation">\`\`\`</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>类图：</strong></p><div class="language-markdown line-numbers-mode" data-highlighter="prismjs" data-ext="md" data-title="md"><pre><code><span class="line"><span class="token code"><span class="token punctuation">\`\`\`</span><span class="token code-language">mermaid</span></span>
<span class="line"><span class="token code-block language-mermaid">classDiagram</span>
<span class="line">    Animal &lt;|-- Duck</span>
<span class="line">    Animal &lt;|-- Fish</span>
<span class="line">    Animal: +int age</span>
<span class="line">    Animal: +String gender</span></span>
<span class="line"><span class="token punctuation">\`\`\`</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="样式定制" tabindex="-1"><a class="header-anchor" href="#样式定制"><span>样式定制</span></a></h2><p>如果想让图表适配 reco 主题的深色模式，可以添加 CSS 变量：</p><div class="language-css line-numbers-mode" data-highlighter="prismjs" data-ext="css" data-title="css"><pre><code><span class="line"><span class="token comment">/* .vuepress/styles/index.css */</span></span>
<span class="line"><span class="token selector">.mermaid-diagram</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">margin</span><span class="token punctuation">:</span> 1.5rem 0<span class="token punctuation">;</span></span>
<span class="line">  <span class="token property">padding</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span></span>
<span class="line">  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--code-bg-color<span class="token punctuation">,</span> #f6f8fa<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* 深色模式适配 */</span></span>
<span class="line"><span class="token selector">[data-theme=&quot;dark&quot;] .mermaid-diagram</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">background</span><span class="token punctuation">:</span> #2d2d2d<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配合 mermaid 主题切换：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 在 mermaid.client.ts 中监听主题变化</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useDarkMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vuepress/client&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> isDark <span class="token operator">=</span> <span class="token function">useDarkMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>isDark<span class="token punctuation">,</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  mermaid<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    theme<span class="token operator">:</span> val <span class="token operator">?</span> <span class="token string">&#39;dark&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;default&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token comment">// 重新渲染所有图表...</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span>注意事项</span></a></h2><table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>ID 冲突</strong></td><td>使用 <code>Date.now() + Math.random()</code> 生成唯一 ID</td></tr><tr><td><strong>SSR 警告</strong></td><td>确保 mermaid 只在 <code>mounted</code> 中调用（客户端）</td></tr><tr><td><strong>构建报错</strong></td><td>检查 mermaid 是否正确安装 <code>npm install mermaid</code></td></tr><tr><td><strong>样式不继承</strong></td><td>通过 CSS 变量或全局样式覆盖</td></tr><tr><td><strong>主题切换</strong></td><td>监听主题变化后重新调用 <code>mermaid.render()</code></td></tr></tbody></table><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>这个插件的核心思路是：</p><ol><li><strong>Markdown 阶段</strong>：拦截 <code>mermaid</code> 代码块，替换为自定义组件标签</li><li><strong>客户端阶段</strong>：注册全局组件，在 <code>mounted</code> 钩子中调用 mermaid 渲染</li><li><strong>运行时渲染</strong>：平衡了构建速度和动态特性需求</li></ol><p>相比直接使用现成插件，手搓的好处是：</p><ul><li>✅ 完全控制渲染逻辑</li><li>✅ 适配特定主题风格</li><li>✅ 无版本兼容问题</li><li>✅ 代码精简，无冗余依赖</li></ul>`,17))])}const b=o(d,[["render",k]]),g=JSON.parse('{"path":"/blogs/230220.html","title":"自制mermaid渲染插件","lang":"en-US","frontmatter":{"title":"自制mermaid渲染插件","date":"2026/2/20","tags":["博客"],"categories":["blog"]},"headers":[{"level":2,"title":"VuePress 的渲染逻辑","slug":"vuepress-的渲染逻辑","link":"#vuepress-的渲染逻辑","children":[]},{"level":2,"title":"两种方案","slug":"两种方案","link":"#两种方案","children":[]},{"level":2,"title":"插件实现","slug":"插件实现","link":"#插件实现","children":[{"level":3,"title":"安装依赖","slug":"安装依赖","link":"#安装依赖","children":[]},{"level":3,"title":"目录结构","slug":"目录结构","link":"#目录结构","children":[]},{"level":3,"title":"插件主文件","slug":"插件主文件","link":"#插件主文件","children":[]},{"level":3,"title":"客户端增强文件","slug":"客户端增强文件","link":"#客户端增强文件","children":[]},{"level":3,"title":"配置文件集成","slug":"配置文件集成","link":"#配置文件集成","children":[]}]},{"level":2,"title":"使用示例","slug":"使用示例","link":"#使用示例","children":[{"level":3,"title":"更多图表类型","slug":"更多图表类型","link":"#更多图表类型","children":[]}]},{"level":2,"title":"样式定制","slug":"样式定制","link":"#样式定制","children":[]},{"level":2,"title":"注意事项","slug":"注意事项","link":"#注意事项","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1771565155000,"updatedTime":1771565155000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"blogs/230220.md"}');export{b as comp,g as data};
