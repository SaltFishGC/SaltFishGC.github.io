import{ar as t,as as e,ax as p,aw as a,ay as l,at as o}from"./app-DXmPnZac.js";const c={};function i(u,s){const n=l("MermaidDiagram");return o(),e("div",null,[s[0]||(s[0]=p(`<h2 id="✅-session-vs-token-jwt-核心区别" tabindex="-1"><a class="header-anchor" href="#✅-session-vs-token-jwt-核心区别"><span>✅ Session vs Token（JWT）核心区别</span></a></h2><table><thead><tr><th>对比项</th><th>Session（基于服务器状态）</th><th>Token（如 JWT，无状态）</th></tr></thead><tbody><tr><td><strong>存储位置</strong></td><td>服务端（内存/Redis/DB） + 客户端 Cookie（存 sessionId）</td><td>完全由客户端存储（如 localStorage、Cookie）</td></tr><tr><td><strong>是否需要服务端存储</strong></td><td>✅ 需要（保存用户会话数据）</td><td>❌ 不需要（Token 自包含用户信息）</td></tr><tr><td><strong>扩展性（分布式）</strong></td><td>差（需共享 Session，如 Redis）</td><td>极好（无状态，天然支持水平扩展）</td></tr><tr><td><strong>安全性</strong></td><td>依赖 Cookie，易受 CSRF 攻击（需防跨站请求伪造）</td><td>依赖 Header，不受 CSRF 影响，但需防 XSS（避免 JS 窃取）</td></tr><tr><td><strong>性能</strong></td><td>每次请求需查 Session（如 Redis），有 IO 开销</td><td>无需查库，直接解析 Token（但需验签）</td></tr><tr><td><strong>适用场景</strong></td><td>传统 Web 应用（如后台管理系统）</td><td>前后端分离、App、微服务、API 网关</td></tr></tbody></table><p>简单来讲：</p><p>session在cookie中，只有一个sessionid，传到后端再在redis中查用户信息</p><p>token在header中，包含用户全部信息，解密后无需根据id查用户信息即可获取用户信息</p><p>当然如果是自行设计的当然怎么样都行。</p><p>注意一般来说token还有加密解密这一步的额外开销需要考虑进去。</p><p>总结session的最大优势：自动化，SpringBoot已帮我们封装好了一系列对象，我们只需要给前端分配一个sessionid，后面前端就会自动在cookie里带上sessionid，然后我们只管给session set，get，del即可完成对用户登录所需信息的快速缓存。</p><h2 id="session在springboot中的使用" tabindex="-1"><a class="header-anchor" href="#session在springboot中的使用"><span>session在SpringBoot中的使用</span></a></h2><blockquote><p>token:自行设置在header中，返回时自行装入响应体</p><p>session:同样设置在header中，返回时sessionId自动装入响应体</p><p>后端使用getSession()自动生成一个session时也会生成一个id，在传回前端时也会在header的Set-Cookie字段带上这个id，前端会在响应头收到：</p><p>Set-Cookie: JSESSIONID=abc123xyz; Path=/; HttpOnly</p><p>这个JSESSIONID就是sessionId，后续浏览器会自动发送cookie：Cookie: JSESSIONID=abc123xyz 之后后端就可以根据这个id查询session内容了</p></blockquote><p>和先前做过的token类似，我们都是将这个玩意塞到header里面去，但是相对于我们自行设置的token且需要从请求体HttpServletRequest 自行获取header的相关参数（键值对形式存储），java专门有这么一个封装类帮助我们快速从cookie中获取session：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 存入 Session</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动创建</span></span>
<span class="line">        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 如果不使用redis，则会存储到tomcat的容器中，也即内存中，以本次生成的sessionid为key</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 从 Session 获取</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/profile&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不自动创建</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;未登录&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;当前用户: &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 注销（清除 Session）</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            session<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 销毁整个 Session</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;已退出&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还有可以使用注解注解读出：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/welcome&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">welcome</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SessionAttribute</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;欢迎 &quot;</span> <span class="token operator">+</span> user <span class="token operator">:</span> <span class="token string">&quot;请先登录&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然用注解的方式是无法set session的值的</p><p>相关安全配置：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">servlet</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">session</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">1800</span> <span class="token comment"># 30分钟（单位：秒），默认30分钟</span></span>
<span class="line">      <span class="token key atrule">cookie</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> JSESSIONID</span>
<span class="line">        <span class="token key atrule">http-only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 防 XSS 攻击</span></span>
<span class="line">        <span class="token key atrule">secure</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>     <span class="token comment"># true 表示仅 HTTPS 传输（生产环境建议开）</span></span>
<span class="line">        <span class="token key atrule">same-site</span><span class="token punctuation">:</span> strict <span class="token comment"># 防 CSRF（现代浏览器支持）</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="session与redis" tabindex="-1"><a class="header-anchor" href="#session与redis"><span>session与redis</span></a></h2><p>SpringBoot提供的session的便利不仅只有上述内容，还有对于redis的快速注解：</p><p><strong>步骤 1：添加依赖（Maven）</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>步骤 2：配置 Redis</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost</span>
<span class="line">    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">  <span class="token key atrule">session</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">store-type</span><span class="token punctuation">:</span> redis</span>
<span class="line">    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 1800s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>步骤 3：启用 Spring Session</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableRedisHttpSession</span> <span class="token comment">// 关键注解！</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ 效果：</p><ul><li>所有 Session 数据自动存入 Redis；</li><li>多个服务实例共享同一份 Session；</li><li>客户端 Cookie 仍为 <code>JSESSIONID</code>，但值对应 Redis 中的 key。</li><li>存储的形式默认为hash，key是JSESSIONID</li></ul></blockquote><h2 id="利用session拦截请求进行鉴权验证以及threadlocal" tabindex="-1"><a class="header-anchor" href="#利用session拦截请求进行鉴权验证以及threadlocal"><span>利用session拦截请求进行鉴权验证以及threadlocal</span></a></h2><p>常见的方式有aop以及拦截器，当然过滤器也行，这里使用拦截器：</p><p>在鉴权时，我们需要从session的存储容器中取出信息，看有没有这个session，拿到信息后再做其他的验证。在很多的业务中，我们实际上都需要这个session中的内容，如果我们在鉴权时只是对其进行验证就有点浪费了，拦截器取一次，业务取一次甚至多次，我说这不好。那我们应该怎么做到让aop/拦截器中获取到的session信息与业务处理共享呢？</p><p>我们都知道对于一个request的处理是从tomcat中取出一个线程进行操作，其实这个线程就提供了一个方式让我们不必去重复获取session，那就是threadlocal：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserHolder</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserDTO</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里封装了一个专门用于存储一个用户信息的类（当然如果你需要list类型的就用<code>ThreadLocal&lt;List&lt;UserDTO&gt;&gt;</code>），这样我们就可以在一个线程里面复用这个UserDTO了（注意一个线程中对应的threadlocal唯一，比如这里的tl就是唯一的一个ThreadLocal实例，当然也可以在这个对外开放的ThreadLocal工具接口类中多搞几个ThreadLocal，他们之间在一个线程内是不会相互影响的，但是占用一定的内存资源，并且记得最后结束时删除几个ThreadLocal内需要刷新的数据）</p><p>需要注意的是<code>ThreadLocal&lt;T&gt;</code>仅允许我们存一个类型T的一个对象且<strong>不会初始化</strong>，如需存储map，list之类的别忘了先创建好实例对象：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用时需要先初始化</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须先创建Map实例</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">putValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>拦截器：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后再mvc中注册：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 添加登录拦截器</span></span>
<span class="line">    registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/query&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/query/*&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/like&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/liked&quot;</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="转换为redis的缓存" tabindex="-1"><a class="header-anchor" href="#转换为redis的缓存"><span>转换为redis的缓存</span></a></h2><p>之前一直用session作为cache，这会导致tomcat的serlvet容器被占用空间，我说这不好，我们考虑使用redis作为替代品来专门做cache。其实用sessionid也没毛病，只要用先前提到的SpringBoot提供的session-redis来实现存储容器的转换即可，但是这里出于对后续的维护的可观性的考虑（redis的key从原来的sessionid换为自行定义）。我们自行去设置token等信息：</p><p>每次登录时获取token，根据用户数据生成一个hash对象存储信息，以tokenid为key：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">.</span><span class="token function">setIgnoreNullValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> fieldValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">,</span> userMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后将token返回给前端，每次前端发送request都需要在header带上token（key值自拟）。然后我们就可以在拦截器中获取这个用户的token并存储到threadlocal中：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">//        HttpSession session = request.getSession();</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> token<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>userMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>userMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 刷新token有效期</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_TTL</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再对一些需要token的接口做拦截：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">//        HttpSession session = request.getSession();</span></span>
<span class="line">        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>userDTO <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当发现token过期时，就会通过这个专门的拦截器拦截请求，最后，设置mvc：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 添加登录拦截器</span></span>
<span class="line">    registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/query&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/query/*&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/like&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">&quot;/blog/liked&quot;</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里其实只要注意注册的顺序就可以保证拦截器的执行顺序了，如果有自定义需求，我们也可以通过相识设置order的参数来实现对执行顺序的管理。</p><h2 id="利用session结合手机号短信验证登录" tabindex="-1"><a class="header-anchor" href="#利用session结合手机号短信验证登录"><span>利用session结合手机号短信验证登录</span></a></h2>`,50)),a(n,{code:"graph%20TD%0A%20%20%20%20A%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%5B%E6%8F%90%E4%BA%A4%E6%89%8B%E6%9C%BA%E5%8F%B7%5D%0A%20%20%20%20B%20--%3E%20C%7B%E6%A0%A1%E9%AA%8C%E6%89%8B%E6%9C%BA%E5%8F%B7%7D%0A%20%20%20%20C%20--%20%E4%B8%8D%E7%AC%A6%E5%90%88%20--%3E%20B%0A%20%20%20%20C%20--%20%E7%AC%A6%E5%90%88%20--%3E%20D%5B%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81%5D%0A%20%20%20%20D%20--%3E%20E%5B%E4%BF%9D%E5%AD%98%E9%AA%8C%E8%AF%81%E7%A0%81%E5%88%B0%20session%5D%0A%20%20%20%20E%20--%3E%20F%5B%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%5D%0A%20%20%20%20F%20--%3E%20G%5B%E7%BB%93%E6%9D%9F%5D%0A"}),a(n,{code:"graph%20TD%0A%20%20%20%20H%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20I%5B%E6%8F%90%E4%BA%A4%E6%89%8B%E6%9C%BA%E5%8F%B7%E5%92%8C%E9%AA%8C%E8%AF%81%E7%A0%81%5D%0A%20%20%20%20I%20--%3E%20J%7B%E6%A0%A1%E9%AA%8C%E9%AA%8C%E8%AF%81%E7%A0%81%7D%0A%20%20%20%20J%20--%20%E4%B8%8D%E4%B8%80%E8%87%B4%20--%3E%20I%0A%20%20%20%20J%20--%20%E4%B8%80%E8%87%B4%20--%3E%20K%5B%E6%A0%B9%E6%8D%AE%E6%89%8B%E6%9C%BA%E5%8F%B7%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%5D%0A%20%20%20%20K%20--%3E%20L%7B%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%7D%0A%20%20%20%20L%20--%20%E4%B8%8D%E5%AD%98%E5%9C%A8%20--%3E%20M%5B%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7%5D%0A%20%20%20%20M%20--%3E%20N%5B%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%5D%0A%20%20%20%20N%20--%3E%20O%5B%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E5%88%B0%20session%5D%0A%20%20%20%20L%20--%20%E5%AD%98%E5%9C%A8%20--%3E%20O%0A%20%20%20%20O%20--%3E%20P%5B%E7%BB%93%E6%9D%9F%5D%0A"}),a(n,{code:"graph%20TD%0A%20%20%20%20Q%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20R%5B%E8%AF%B7%E6%B1%82%E5%B9%B6%E6%90%BA%E5%B8%A6%20cookie%5D%0A%20%20%20%20R%20--%3E%20S%5B%E4%BB%8E%20session%20%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%5D%0A%20%20%20%20S%20--%3E%20T%7B%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%7D%0A%20%20%20%20T%20--%20%E6%9C%89%20--%3E%20U%5B%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E5%88%B0%20ThreadLocal%5D%0A%20%20%20%20U%20--%3E%20V%5B%E6%94%BE%E8%A1%8C%5D%0A%20%20%20%20T%20--%20%E6%B2%A1%E6%9C%89%20--%3E%20W%5B%E6%8B%A6%E6%88%AA%5D%0A%20%20%20%20V%20--%3E%20X%5B%E7%BB%93%E6%9D%9F%5D%0A%20%20%20%20W%20--%3E%20X%0A"}),a(n,{code:"sequenceDiagram%0A%20%20%20%20participant%20%E7%94%A8%E6%88%B7%0A%20%20%20%20participant%20%E5%89%8D%E7%AB%AF%0A%20%20%20%20participant%20%E5%90%8E%E7%AB%AF%0A%0A%20%20%20%20%E7%94%A8%E6%88%B7-%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E8%BE%93%E5%85%A5%E6%89%8B%E6%9C%BA%E5%8F%B7%0A%20%20%20%20%E5%89%8D%E7%AB%AF-%3E%3E%E5%90%8E%E7%AB%AF%3A%20POST%20%2Fcode%20(%E6%89%8B%E6%9C%BA%E5%8F%B7)%0A%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3E%E5%90%8E%E7%AB%AF%3A%20%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81%0A%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3ERedis%2FSession%3A%20%E4%BF%9D%E5%AD%98%E9%AA%8C%E8%AF%81%E7%A0%81%0A%20%20%20%20%E5%90%8E%E7%AB%AF--%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E5%8F%91%E9%80%81%E6%88%90%E5%8A%9F%0A%20%20%20%20%E5%89%8D%E7%AB%AF-%3E%3E%E7%94%A8%E6%88%B7%3A%20%E6%98%BE%E7%A4%BA%E2%80%9C%E5%B7%B2%E5%8F%91%E9%80%81%E2%80%9D%0A%0A%20%20%20%20%E7%94%A8%E6%88%B7-%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81%E7%A0%81%0A%20%20%20%20%E5%89%8D%E7%AB%AF-%3E%3E%E5%90%8E%E7%AB%AF%3A%20POST%20%2Flogin%20(%E6%89%8B%E6%9C%BA%E5%8F%B7%2B%E9%AA%8C%E8%AF%81%E7%A0%81)%0A%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3ERedis%2FSession%3A%20%E9%AA%8C%E8%AF%81%E7%A0%81%E6%A0%A1%E9%AA%8C%0A%20%20%20%20alt%20%E9%AA%8C%E8%AF%81%E6%88%90%E5%8A%9F%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3EDB%3A%20%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%0A%20%20%20%20%20%20%20%20alt%20%E7%94%A8%E6%88%B7%E4%B8%8D%E5%AD%98%E5%9C%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3EDB%3A%20%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3ESession%3A%20%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF--%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%0A%20%20%20%20%20%20%20%20%E5%89%8D%E7%AB%AF-%3E%3E%E7%94%A8%E6%88%B7%3A%20%E8%B7%B3%E8%BD%AC%E9%A6%96%E9%A1%B5%0A%20%20%20%20else%20%E9%AA%8C%E8%AF%81%E5%A4%B1%E8%B4%A5%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF--%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%0A%20%20%20%20end%0A%0A%20%20%20%20%E7%94%A8%E6%88%B7-%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E8%AE%BF%E9%97%AE%E5%8F%97%E4%BF%9D%E6%8A%A4%E6%8E%A5%E5%8F%A3%0A%20%20%20%20%E5%89%8D%E7%AB%AF-%3E%3E%E5%90%8E%E7%AB%AF%3A%20%E8%AF%B7%E6%B1%82%20%2B%20Cookie%0A%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3ESession%3A%20%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%0A%20%20%20%20alt%20%E5%AD%98%E5%9C%A8%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF-%3E%3EThreadLocal%3A%20%E8%AE%BE%E7%BD%AE%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF--%3E%3E%E5%89%8D%E7%AB%AF%3A%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%0A%20%20%20%20else%20%E4%B8%8D%E5%AD%98%E5%9C%A8%0A%20%20%20%20%20%20%20%20%E5%90%8E%E7%AB%AF--%3E%3E%E5%89%8D%E7%AB%AF%3A%20401%20%E6%9C%AA%E7%99%BB%E5%BD%95%0A%20%20%20%20end%0A"}),s[1]||(s[1]=p(`<h2 id="mybatisplus中iservice" tabindex="-1"><a class="header-anchor" href="#mybatisplus中iservice"><span>mybatisplus中IService</span></a></h2><p>除了熟悉的注入并查询单表：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>我们还可以直接使用mybatisplus的IService提供的query()直接查：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// one()是因为返回的是list，需要去取第一个</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>同样对于单表insert：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>我们也可以直接：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="stringredistemplate的使用注意事项" tabindex="-1"><a class="header-anchor" href="#stringredistemplate的使用注意事项"><span>stringRedisTemplate的使用注意事项</span></a></h2><p>获取数据时是全部都为String的，可以自行转换类型，但是插入数据的时候就需要注意了，比如从里面entries出来全部hash时，对应的字段值均为String可以类型强制转换，但是putall的时候一定要将所有的字段转换为String类型：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">.</span><span class="token function">setIgnoreNullValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> fieldValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">,</span> userMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然我们也可以找出来哪些字段不是String类型的，强制转换完重新put进去即可：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        userMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> userDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div>`,14))])}const r=t(c,[["render",i]]),d=JSON.parse('{"path":"/docs/heimadianping/yewusheji/1.duanxindenglu.html","title":"短信登录（session）","lang":"en-US","frontmatter":{"title":"短信登录（session）","date":"2025-12-22T00:00:00.000Z"},"headers":[{"level":2,"title":"✅ Session vs Token（JWT）核心区别","slug":"✅-session-vs-token-jwt-核心区别","link":"#✅-session-vs-token-jwt-核心区别","children":[]},{"level":2,"title":"session在SpringBoot中的使用","slug":"session在springboot中的使用","link":"#session在springboot中的使用","children":[]},{"level":2,"title":"session与redis","slug":"session与redis","link":"#session与redis","children":[]},{"level":2,"title":"利用session拦截请求进行鉴权验证以及threadlocal","slug":"利用session拦截请求进行鉴权验证以及threadlocal","link":"#利用session拦截请求进行鉴权验证以及threadlocal","children":[]},{"level":2,"title":"转换为redis的缓存","slug":"转换为redis的缓存","link":"#转换为redis的缓存","children":[]},{"level":2,"title":"利用session结合手机号短信验证登录","slug":"利用session结合手机号短信验证登录","link":"#利用session结合手机号短信验证登录","children":[]},{"level":2,"title":"mybatisplus中IService","slug":"mybatisplus中iservice","link":"#mybatisplus中iservice","children":[]},{"level":2,"title":"stringRedisTemplate的使用注意事项","slug":"stringredistemplate的使用注意事项","link":"#stringredistemplate的使用注意事项","children":[]}],"git":{"createdTime":1771338216000,"updatedTime":1771338216000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马点评/业务设计/1.短信登录.md"}');export{r as comp,d as data};
