import{ar as e,as as t,ax as s,aw as l,ay as p,at as i}from"./app-DXmPnZac.js";const c={};function o(d,n){const a=p("MermaidDiagram");return i(),t("div",null,[n[0]||(n[0]=s("<p>åœ¨æˆ‘ä»¬å…ˆå‰å­¦ä¹ çš„ç¼“å­˜ç»“æ„ä¸­ï¼Œæˆ‘ä»¬æ˜¯<strong>åœ¨åç«¯æœåŠ¡å™¨ä¸­å®Œæˆå¯¹ç¼“å­˜å±‚çš„è°ƒç”¨</strong>ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼šå‡å¦‚Springçš„<strong>tomcatè¾¾åˆ°ä¸Šé™</strong>äº†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´åé¢çš„ç¼“å­˜ä»¥åŠæ•°æ®åº“çš„ä¼˜åŒ–å¾—ä¸åˆ°å‘æŒ¥ï¼Œé™åˆ¶äº†é¡¹ç›®æ•´ä½“çš„æ€§èƒ½ã€‚</p><p>å› æ­¤ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå¯¹åç«¯æœåŠ¡ä¹ŸåšæŠ—å¹¶å‘ä»¥åŠæ€§èƒ½çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚é€šè¿‡Redissionç­‰æ–¹å¼æ„å»º<strong>åˆ†å¸ƒå¼åç«¯</strong>ï¼Œå°†æœåŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªå­æœåŠ¡ä»è€Œæ„å»º<strong>å¾®æœåŠ¡</strong>ã€‚</p><p>ä½†æŠ›å¼€åç«¯è‡ªå·±ï¼Œæˆ‘ä»¬å…¶å®è¿˜å¯ä»¥å‘å‰çœ‹ï¼Œåœ¨æ›´å‰é¢çš„<strong>nginx</strong>åå‘ä»£ç†å°±åŠ å…¥æ•°æ®ç¼“å­˜ï¼Œ<strong>æå‰å¤„ç†æ‰ä¸€äº›ç®€å•çš„è¯·æ±‚</strong>ï¼Œä»è€Œè¾¾åˆ°æ›´å¥½çš„é«˜å¹¶å‘æ€§èƒ½ã€‚ç”šè‡³æˆ‘ä»¬è¿˜å¯ä»¥å°†ä¸€äº›æ•°æ®ç›´æ¥ç¼“å­˜åœ¨å‰ç«¯æœ¬åœ°å¦‚æµè§ˆå™¨çš„storageç­‰ï¼Œå½“ç”¨æˆ·éœ€è¦æ—¶ç›´æ¥ä»æœ¬åœ°è·å–ã€‚</p>",3)),l(a,{code:"graph%20LR%0A%20%20%20%20A%5B%E7%94%A8%E6%88%B7%5D%20--%3E%20B%5B%E6%B5%8F%E8%A7%88%E5%99%A8%3Cbr%3E%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20B%20--%3E%20C%5BNGINX%3Cbr%3E%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20C%20--%20%E7%BC%93%E5%AD%98%E6%9C%AA%E5%91%BD%E4%B8%AD%20--%3E%20D%5BRedis%3Cbr%3E%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20D%20--%20%E7%BC%93%E5%AD%98%E6%9C%AA%E5%91%BD%E4%B8%AD%20--%3E%20E%5Btomcat%E8%BF%9B%E7%A8%8B%E7%BC%93%E5%AD%98%5D%0A%20%20%20%20E%20--%20%E7%BC%93%E5%AD%98%E6%9C%AA%E5%91%BD%E4%B8%AD%20--%3E%20F%5B%E6%95%B0%E6%8D%AE%E5%BA%93%5D%0A%0A%20%20%20%20classDef%20client%20fill%3A%23e6f7ff%2Cstroke%3A%230066cc%2Cstroke-width%3A2px%3B%0A%20%20%20%20classDef%20nginx%20fill%3A%23d4f5b8%2Cstroke%3A%233c9c00%2Cstroke-width%3A2px%3B%0A%20%20%20%20classDef%20redis%20fill%3A%23f8d5d5%2Cstroke%3A%23cc0000%2Cstroke-width%3A2px%3B%0A%20%20%20%20classDef%20app%20fill%3A%23fffacd%2Cstroke%3A%23cc7a00%2Cstroke-width%3A2px%3B%0A%20%20%20%20classDef%20db%20fill%3A%23d0d0d0%2Cstroke%3A%23333%2Cstroke-width%3A2px%3B%0A%0A%20%20%20%20class%20B%20client%3B%0A%20%20%20%20class%20C%20nginx%3B%0A%20%20%20%20class%20D%20redis%3B%0A%20%20%20%20class%20E%20app%3B%0A%20%20%20%20class%20F%20db%3B%0A"}),n[1]||(n[1]=s(`<blockquote><p>Redisä¸ºä»€ä¹ˆä¼štomcatå‰é¢ï¼Ÿä¸åº”è¯¥äº¤ç”±tomcatçš„ä¸šåŠ¡å¤„ç†è°ƒç”¨å—ï¼Ÿ å…¶å®Nginxä¹Ÿå¯ä»¥åšä¸€äº›ä¸šåŠ¡å¤„ç†ï¼Œæˆ‘ä»¬åœ¨å®ŒæˆNginxçš„é›†ç¾¤æ­å»ºåï¼Œä¹Ÿå¯ä»¥å°†ä¸€å®šçš„ä¸šåŠ¡äº¤ç”±Nginxå¤„ç†ã€‚</p></blockquote><p>æˆ‘ä»¬é€šè¿‡è¿™æ ·çš„å¤šçº§ç¼“å­˜æ¥ä¿è¯æ•°æ®å‹åŠ›çš„ç¼“è§£ã€‚</p><p>å…¶ä¸­<strong>nginx</strong>ï¼Œredisï¼Œtomcatéƒ½å¯ä»¥åšæˆ<strong>é›†ç¾¤</strong>çš„æ–¹å¼æ¥å®ç°æ›´åŠ å¼ºå¤§çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹å®ç°åœ¨è¿™ä¸ªå¤šçº§ç¼“å­˜é“¾è·¯ä¸Šå®ç°å„ä¸ªæ¨¡å—äº†</p><blockquote><p>å¯»å¸¸ä¸šåŠ¡è¿˜æ˜¯æ¨èrediså’Œæ•°æ®åº“å¤Ÿç”¨å°±è¡Œï¼Œå¯¹äºå¤šçº§ç¼“å­˜çš„ç»´æŠ¤ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ˜¯ä¸ªå¤§å·¥ç¨‹ï¼Œæ¯å¼€å‘ä¸€ä¸ªä¸šåŠ¡éƒ½è¦è€ƒè™‘åˆ°</p><p>å½“ç„¶ç®€å•çš„è¿˜æ˜¯å¯ä»¥æ”¾åˆ°nginxé‡Œé¢çš„</p></blockquote><h2 id="jvmè¿›ç¨‹ç¼“å­˜-caffeine" tabindex="-1"><a class="header-anchor" href="#jvmè¿›ç¨‹ç¼“å­˜-caffeine"><span>JVMè¿›ç¨‹ç¼“å­˜(Caffeine )</span></a></h2><p>â€œJVM è¿›ç¨‹æœ¬åœ°ç¼“å­˜â€é€šå¸¸æ˜¯æŒ‡<strong>è¿è¡Œåœ¨å•ä¸ª JVM è¿›ç¨‹å†…éƒ¨ã€ä»…å¯¹è¯¥è¿›ç¨‹å¯è§çš„ç¼“å­˜æœºåˆ¶</strong>ï¼Œå®ƒä¸æ¶‰åŠè·¨è¿›ç¨‹æˆ–åˆ†å¸ƒå¼å…±äº«ï¼ˆå¦‚ Redisã€Memcachedï¼‰ï¼Œè€Œæ˜¯åˆ©ç”¨ JVM å †å†…å­˜ï¼ˆæˆ–å †å¤–å†…å­˜ï¼‰æ¥å­˜å‚¨ä¸´æ—¶æ•°æ®ï¼Œä»¥åŠ é€Ÿåº”ç”¨é€»è¾‘ã€å‡å°‘é‡å¤è®¡ç®—æˆ– IO å¼€é”€ã€‚</p><p>è¿™ç±»ç¼“å­˜å¹¿æ³›åº”ç”¨äº Java åº”ç”¨ä¸­ï¼Œæ˜¯<strong>åº”ç”¨å±‚ç¼“å­˜</strong>çš„ä¸€ç§å½¢å¼ï¼Œä½†å› å…¶ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨åŸŸé™å®šåœ¨å•ä¸ª JVM è¿›ç¨‹å†…ï¼Œå¸¸è¢«ç§°ä¸º <strong>â€œæœ¬åœ°ç¼“å­˜â€ï¼ˆLocal Cacheï¼‰</strong> æˆ– <strong>â€œè¿›ç¨‹å†…ç¼“å­˜â€ï¼ˆIn-Process Cacheï¼‰</strong>ã€‚</p><blockquote><p><strong>ç›¸æ¯”åˆ†å¸ƒå¼ç¼“å­˜</strong>å¦‚Redisç­‰ï¼Œæ²¡æœ‰é€šä¿¡å¼€é”€ï¼Œä½†æ˜¯æ— æ³•æ”¯æŒ<strong>å¤šæœºä¹‹é—´çš„é€šä¿¡</strong>ï¼Œéœ€è¦è‡ªå·±å®ç°ï¼Œè€Œä¸”å¯é æ€§æ¯”è¾ƒå·®ï¼Œå®•æœºäº†å°±æ²¡äº†ã€‚</p></blockquote><p>æˆ‘ä»¬çš„Javaæœ€å¥½çš„ç‰¹æ€§å°±æ˜¯å°è£…å¥½ä¸”ç”Ÿæ€å¥½ï¼Œå½“æˆ‘ä»¬æƒ³åˆ°æŸä¸€æ–¹é¢æ—¶ï¼Œå»æ‰¾æ‰¾æ˜¯å¦æœ‰å‰äººåšè¿‡å¾€å¾€éƒ½èƒ½å¤Ÿè·å¾—ä¸€ä¸ªå·²ç»å¤§è‡´å®Œæˆçš„æ¡†æ¶ï¼Œè€Œå¯¹äºæˆ‘ä»¬ç°åœ¨è¦å®Œæˆçš„è¿›ç¨‹ç¼“å­˜ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰è¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œé‚£å°±æ˜¯<strong>Caffeine</strong>ï¼š</p><blockquote><p>ä½¿ç”¨è°¨æ…ï¼Œcrudéƒ½è¦å¸¦ä¸Šå¯¹äºè¿™ä¸€éƒ¨åˆ†çš„æ•°æ®æ›´æ–°ï¼Œåç»­ç»´æŠ¤ä¹Ÿå¥½ï¼Œèµ„æºå¼€é”€ä¹Ÿå¥½ï¼Œéƒ½éœ€è¦æå‰å‡†å¤‡å¥½ <strong>å•æœº</strong>ä¸‹ç”¨çš„å¤šï¼Œå¤šæœºå°¤å…¶æ˜¯åˆ†å¸ƒå¼ä¸‹ç»´æŠ¤éº»çƒ¦ï¼ŒåŸºæœ¬ä¸ç”¨</p></blockquote><table><thead><tr><th style="text-align:left;">ç‰¹æ€§</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;">âœ… <strong>é«˜æ€§èƒ½</strong></td><td style="text-align:left;">åŸºäº <strong>Window TinyLFU</strong> æ·˜æ±°ç®—æ³•ï¼Œåœ¨å‘½ä¸­ç‡å’Œå†…å­˜æ•ˆç‡ä¸Šä¼˜äº LRU/LFUã€‚</td></tr><tr><td style="text-align:left;">âœ… <strong>çº¿ç¨‹å®‰å…¨</strong></td><td style="text-align:left;">æ‰€æœ‰æ“ä½œå¤©ç„¶çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€é¢å¤–åŒæ­¥ã€‚</td></tr><tr><td style="text-align:left;">âœ… <strong>è‡ªåŠ¨åŠ è½½/åˆ·æ–°</strong></td><td style="text-align:left;">æ”¯æŒ <code>get(key, mappingFunction)</code> è‡ªåŠ¨åŠ è½½ï¼Œä»¥åŠåŸºäºæ—¶é—´çš„å¼‚æ­¥åˆ·æ–°ã€‚</td></tr><tr><td style="text-align:left;">âœ… <strong>çµæ´»çš„è¿‡æœŸç­–ç•¥</strong></td><td style="text-align:left;">æ”¯æŒåŸºäºå†™å…¥æ—¶é—´ï¼ˆTTLï¼‰ã€è®¿é—®æ—¶é—´ï¼ˆTTIï¼‰ã€å¼±/è½¯å¼•ç”¨ç­‰ã€‚</td></tr><tr><td style="text-align:left;">âœ… <strong>å¼‚æ­¥ API</strong></td><td style="text-align:left;">æä¾› <code>AsyncLoadingCache</code>ï¼Œæ”¯æŒéé˜»å¡å¼ç¼“å­˜æ“ä½œã€‚</td></tr><tr><td style="text-align:left;">âœ… <strong>ç»Ÿè®¡ç›‘æ§</strong></td><td style="text-align:left;">å†…ç½®å‘½ä¸­ç‡ã€åŠ è½½æ¬¡æ•°ã€å¹³å‡åŠ è½½æ—¶é—´ç­‰æŒ‡æ ‡ï¼Œä¾¿äºå¯è§‚æµ‹æ€§ã€‚</td></tr></tbody></table><p><strong>Mavené…ç½®ï¼š</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.ben-manes.caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- æ¨èä½¿ç”¨æœ€æ–°ç‰ˆ --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¯¦ç»†è§jdkç‰ˆæœ¬å¯¹åº”è¡¨</p></blockquote><p><strong>ç¤ºä¾‹ï¼š</strong></p><p>æ‰‹åŠ¨åŠ è½½ç¼“å­˜ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Caffeine</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>               <span class="token comment">// æœ€å¤šç¼“å­˜ 1000 é¡¹</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span> <span class="token comment">// å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">String</span> value <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è‹¥ä¸å­˜åœ¨è¿”å› null</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡ªåŠ¨åŠ è½½ç¼“å­˜ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">LoadingCache</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token function">loadUserFromDatabase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è‡ªåŠ¨åŠ è½½å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">User</span> user <span class="token operator">=</span> userCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è‹¥ç¼“å­˜æ— ï¼Œåˆ™è°ƒç”¨ loadUserFromDatabase</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¼‚æ­¥æäº¤ç¼“å­˜ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">AsyncLoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> asyncCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">buildAsync</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">loadUserFromDB</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> asyncCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">User</span> user <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æˆ–é€šè¿‡ thenApply å¤„ç†</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">é…ç½®æ–¹æ³•</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>maximumSize(long)</code></td><td style="text-align:left;">è®¾ç½®ç¼“å­˜æœ€å¤§æ¡ç›®æ•°ï¼ˆåŸºäºæƒé‡å¯é… <code>maximumWeight</code>ï¼‰</td></tr><tr><td style="text-align:left;"><code>expireAfterAccess(duration)</code></td><td style="text-align:left;">æœ€åä¸€æ¬¡è¯»/å†™åå¤šä¹…è¿‡æœŸï¼ˆTTIï¼‰</td></tr><tr><td style="text-align:left;"><code>expireAfterWrite(duration)</code></td><td style="text-align:left;">å†™å…¥åå¤šä¹…è¿‡æœŸï¼ˆTTLï¼‰</td></tr><tr><td style="text-align:left;"><code>refreshAfterWrite(duration)</code></td><td style="text-align:left;">å†™å…¥åå¤šä¹…<strong>å¼‚æ­¥åˆ·æ–°</strong>ï¼ˆä¸ä¼šé˜»å¡è¯»ï¼‰</td></tr><tr><td style="text-align:left;"><code>weakKeys()</code> / <code>weakValues()</code></td><td style="text-align:left;">ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆGC å¯å›æ”¶ï¼‰</td></tr><tr><td style="text-align:left;"><code>softValues()</code></td><td style="text-align:left;">ä½¿ç”¨è½¯å¼•ç”¨ï¼ˆå†…å­˜ä¸è¶³æ—¶å›æ”¶ï¼‰âš ï¸ ä¸æ¨èï¼Œè¡Œä¸ºä¸å¯æ§</td></tr><tr><td style="text-align:left;"><code>recordStats()</code></td><td style="text-align:left;">å¯ç”¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¯é€šè¿‡ <code>cache.stats()</code> æŸ¥çœ‹ï¼‰</td></tr></tbody></table><blockquote><p>ğŸ’¡ æ³¨æ„ï¼š<code>expireAfterWrite</code> å’Œ <code>refreshAfterWrite</code> å¯åŒæ—¶ä½¿ç”¨ã€‚</p><ul><li>è¿‡æœŸåä¸‹æ¬¡è®¿é—®ä¼šè§¦å‘åŠ è½½ï¼›</li><li>åˆ·æ–°åˆ™æ˜¯åœ¨åå°å¼‚æ­¥æ›´æ–°ï¼Œæ—§å€¼ä»å¯è¯»ã€‚</li></ul></blockquote><p><strong>é¡¹ç›®ä¸­åˆ©ç”¨Beanæ³¨å…¥å®ç°å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®ä¸€è‡´ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token annotation punctuation">@EnableCaching</span> <span class="token comment">// å¯ç”¨ Spring Cacheï¼ˆå¯é€‰ï¼Œå¦‚æœä½ ä¹Ÿç”¨ @Cacheableï¼‰</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * åˆ›å»ºå…¨å±€ UserInfo ç¼“å­˜ Bean</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">userInfoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span>                          <span class="token comment">// æœ€å¤šç¼“å­˜ 1 ä¸‡ä¸ªç”¨æˆ·</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span>       <span class="token comment">// å†™å…¥å 10 åˆ†é’Ÿè¿‡æœŸ</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">recordStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token comment">// å¯ç”¨ç»Ÿè®¡ï¼ˆç”¨äºç›‘æ§ï¼‰</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">loadUserInfoFromSource</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// è‡ªåŠ¨åŠ è½½å‡½æ•°</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * æ¨¡æ‹Ÿä»æ•°æ®åº“/è¿œç¨‹æœåŠ¡åŠ è½½ UserInfo</span>
<span class="line">     * å®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºä½ çš„ UserService æˆ– FeignClient è°ƒç”¨</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> <span class="token function">loadUserInfoFromSource</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// TODO: æ›¿æ¢ä¸ºçœŸå®é€»è¾‘ï¼Œä¾‹å¦‚ï¼š</span></span>
<span class="line">        <span class="token comment">// return userService.getUserById(userId);</span></span>
<span class="line">        <span class="token comment">// å¦‚æœæŸ¥ä¸åˆ°ï¼Œå¯æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› nullï¼ˆCaffeine ä¸ä¼šç¼“å­˜ nullï¼‰</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;invalid&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;User not found: &quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">&quot;Name-&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> userId <span class="token operator">+</span> <span class="token string">&quot;@example.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨Serviceä¸­ä½¿ç”¨ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> userInfoCache<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯è¿™æ ·åšå¸¸å¸¸ä¼šé‡åˆ°æ³¨å…¥å¤±è´¥çš„é—®é¢˜ï¼š<strong>å­˜åœ¨å¤šä¸ª</strong> <code>LoadingCache&lt;...&gt;</code> <strong>Beanï¼Œæ³¨å…¥æ—¶ç±»å‹å†²çª</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">userInfoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">productCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶æ³›å‹ä¸åŒï¼Œä½†<strong>Java æ³›å‹åœ¨è¿è¡Œæ—¶ä¼šè¢«æ“¦é™¤</strong>ï¼ŒSpring çœ‹åˆ°çš„éƒ½æ˜¯ <code>LoadingCache</code>ï¼Œå¯èƒ½æ— æ³•åŒºåˆ†ã€‚</p><p>âœ… <strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ <strong><code>@Qualifier</code></strong> æŒ‡å®š Bean åç§°</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// å®šä¹‰æ—¶ï¼ˆBean åç§°ä¸ºæ–¹æ³•å &quot;userInfoCache&quot;ï¼‰</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">userInfoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å…¥æ—¶</span></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;userInfoCache&quot;</span><span class="token punctuation">)</span> <span class="token comment">// æ˜¾å¼æŒ‡å®š</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> cache<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ’¡ æ›´ä¼˜é›…çš„æ–¹å¼ï¼š<strong>å°è£…ä¸ºè‡ªå®šä¹‰ç±»å‹</strong>ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// è‡ªå®šä¹‰ç¼“å­˜ç±»å‹ï¼Œç»§æ‰¿æˆ–åŒ…è£…</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoCache</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> cache<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserInfoCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">loadUser</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserInfo</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        cache<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> <span class="token function">loadUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åæ³¨æ„å¤šä¸ªæœåŠ¡ï¼ˆçº¿ç¨‹ä¹‹é—´é€šè¿‡Beanæ³¨å…¥ä¿è¯ä¸€è‡´ï¼‰ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ<strong>ä¸è¦å°†å¯èƒ½ä¼šåœ¨å¤šæœºé›†ç¾¤ä¸­äº§ç”Ÿå˜åŒ–çš„æ•°æ®æ”¾åˆ°jvmçº¿ç¨‹ç¼“å­˜é‡Œï¼<strong>è¿˜æ˜¯æ¨èåœ¨</strong>å•æœºåç«¯æœåŠ¡é¡¹ç›®ä¸­ä½¿ç”¨</strong>ï¼Œå¤šæœºé¡¹ç›®ä¸‹è°¨æ…ä½¿ç”¨ï¼</p><h2 id="luaç®€å•è®¤è¯†" tabindex="-1"><a class="header-anchor" href="#luaç®€å•è®¤è¯†"><span>luaç®€å•è®¤è¯†</span></a></h2><h3 id="æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„"><span>æ•°æ®ç»“æ„</span></a></h3><table><thead><tr><th style="text-align:left;">ç±»å‹</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;"><code>nil</code></td><td style="text-align:left;"><code>x = nil</code></td><td style="text-align:left;">è¡¨ç¤ºâ€œç©ºâ€æˆ–â€œæœªåˆå§‹åŒ–â€</td></tr><tr><td style="text-align:left;"><code>boolean</code></td><td style="text-align:left;"><code>true</code>, <code>false</code></td><td style="text-align:left;">å¸ƒå°”å€¼</td></tr><tr><td style="text-align:left;"><code>number</code></td><td style="text-align:left;"><code>3.14</code>, <code>-42</code></td><td style="text-align:left;"><strong>ç»Ÿä¸€ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°</strong>ï¼ˆæ²¡æœ‰æ•´å‹/æµ®ç‚¹ä¹‹åˆ†ï¼‰</td></tr><tr><td style="text-align:left;"><code>string</code></td><td style="text-align:left;"><code>&quot;hello&quot;</code>, <code>&#39;world&#39;</code></td><td style="text-align:left;">ä¸å¯å˜å­—ç¬¦ä¸²ï¼Œæ”¯æŒå¤šè¡Œ <code>[[...]]</code></td></tr><tr><td style="text-align:left;"><code>function</code></td><td style="text-align:left;"><code>function() end</code></td><td style="text-align:left;">ä¸€ç­‰å…¬æ°‘ï¼Œå¯èµ‹å€¼ã€ä¼ å‚</td></tr><tr><td style="text-align:left;"><code>table</code></td><td style="text-align:left;"><code>{}</code></td><td style="text-align:left;"><strong>å”¯ä¸€å¤åˆæ•°æ®ç»“æ„ï¼ä¸‡èƒ½ï¼</strong></td></tr><tr><td style="text-align:left;"><code>thread</code></td><td style="text-align:left;">â€”â€”</td><td style="text-align:left;">åç¨‹ï¼ˆcoroutineï¼‰ï¼Œä¸æ˜¯ OS çº¿ç¨‹</td></tr><tr><td style="text-align:left;"><code>userdata</code></td><td style="text-align:left;">â€”â€”</td><td style="text-align:left;">ç”¨äº C æ‰©å±•ï¼Œå­˜å‚¨ C æŒ‡é’ˆ</td></tr></tbody></table><blockquote><p>ğŸ” ç”¨ <code>type(x)</code> æŸ¥çœ‹å˜é‡ç±»å‹ï¼š</p></blockquote><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">--&gt; number</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">--&gt; string</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">--&gt; table</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡ä¸éœ€è¦æå‰å£°æ˜ç±»å‹ï¼Œèµ‹å€¼å³å®šä¹‰ï¼š</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">x <span class="token operator">=</span> <span class="token number">10</span>          <span class="token comment">-- numberï¼ˆæ•°å­—ï¼‰</span></span>
<span class="line">name <span class="token operator">=</span> <span class="token string">&quot;Lua&quot;</span>    <span class="token comment">-- stringï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span>
<span class="line">ok <span class="token operator">=</span> <span class="token keyword">true</span>       <span class="token comment">-- booleanï¼ˆå¸ƒå°”ï¼‰</span></span>
<span class="line">nothing <span class="token operator">=</span> <span class="token keyword">nil</span>   <span class="token comment">-- nilï¼ˆè¡¨ç¤ºâ€œæ— â€æˆ–â€œæœªå®šä¹‰â€ï¼‰</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… æ‰€æœ‰å˜é‡é»˜è®¤æ˜¯ <strong>å…¨å±€å˜é‡</strong>ï¼ âŒ è¿™å®¹æ˜“é€ æˆæ±¡æŸ“ï¼Œ<strong>å¼ºçƒˆå»ºè®®ç”¨ <code>local</code> å£°æ˜å±€éƒ¨å˜é‡</strong>ï¼š</p></blockquote><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> age <span class="token operator">=</span> <span class="token number">25</span>   <span class="token comment">-- æ¨èï¼ä½œç”¨åŸŸä»…é™å½“å‰å—</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„-table-è¡¨" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ•°æ®ç»“æ„-table-è¡¨"><span><strong>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šTableï¼ˆè¡¨ï¼‰</strong></span></a></h3><blockquote><p>ğŸ’¡ <strong>Table æ˜¯ Lua ä¸­å”¯ä¸€çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒèƒ½æ¨¡æ‹Ÿå‡ ä¹æ‰€æœ‰ä½ éœ€è¦çš„ç»“æ„ï¼</strong></p></blockquote><p><strong>1.</strong> <em><strong>*æœ¬è´¨ï¼šå…³è”æ•°ç»„ï¼ˆå“ˆå¸Œè¡¨ + æ•°ç»„æ··åˆï¼‰*</strong></em></p><ul><li>é”®ï¼ˆkeyï¼‰å¯ä»¥æ˜¯ <strong>é™¤ <code>nil</code> å’Œ <code>NaN</code> å¤–çš„ä»»æ„ç±»å‹</strong>ï¼ˆåŒ…æ‹¬å‡½æ•°ã€è¡¨ï¼‰ï¼›</li><li>å€¼ï¼ˆvalueï¼‰å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼›</li><li>è‡ªåŠ¨æ‰©å®¹ï¼Œæ— éœ€é¢„å®šä¹‰å¤§å°ã€‚</li></ul><hr><p><strong>2.</strong> <em><strong>*ä¸¤ç§å¸¸è§ç”¨æ³•*</strong></em></p><p><strong>âœ… (1) å½“ä½œ</strong> <em><strong>*æ•°ç»„ï¼ˆArrayï¼‰*</strong></em></p><ul><li>ä½¿ç”¨<strong>æ­£æ•´æ•°ç´¢å¼•</strong>ï¼ˆæ³¨æ„ï¼š<strong>ä» 1 å¼€å§‹ï¼ä¸æ˜¯ 0</strong>ï¼‰</li></ul><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> fruits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;banana&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cherry&quot;</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>fruits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">--&gt; &quot;apple&quot;</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>fruits<span class="token punctuation">)</span>   <span class="token comment">--&gt; 3ï¼ˆè·å–æ•°ç»„é•¿åº¦ï¼‰</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>âœ… (2) å½“ä½œ</strong> <em><strong>*å­—å…¸ / å¯¹è±¡ï¼ˆDictionary / Mapï¼‰*</strong></em></p><ul><li>ä½¿ç”¨å­—ç¬¦ä¸²æˆ–å…¶ä»–ç±»å‹ä½œä¸º key</li></ul><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> person <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    name <span class="token operator">=</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    is_admin <span class="token operator">=</span> <span class="token keyword">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span>      <span class="token comment">--&gt; &quot;Alice&quot;</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>person<span class="token punctuation">[</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">--&gt; 30</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>âœ… (3) æ··åˆä½¿ç”¨ï¼ˆå®Œå…¨åˆæ³•ï¼ï¼‰</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> mixed <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;first&quot;</span><span class="token punctuation">,</span>           <span class="token comment">-- [1] = &quot;first&quot;</span></span>
<span class="line">    key <span class="token operator">=</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span>     <span class="token comment">-- [&quot;key&quot;] = &quot;value&quot;</span></span>
<span class="line">    <span class="token number">42</span><span class="token punctuation">,</span>                <span class="token comment">-- [2] = 42</span></span>
<span class="line">    <span class="token punctuation">{</span>nested <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">}</span>    <span class="token comment">-- [3] = {nested=true}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>3.</strong> <em><strong>*Table æ˜¯å¼•ç”¨ç±»å‹*</strong></em></p><ul><li>èµ‹å€¼æ˜¯<strong>å¤åˆ¶å¼•ç”¨</strong>ï¼Œä¸æ˜¯æ·±æ‹·è´ï¼š</li></ul><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">local</span> b <span class="token operator">=</span> a</span>
<span class="line">b<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">99</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token comment">--&gt; 99ï¼ˆa å’Œ b æŒ‡å‘åŒä¸€ä¸ªè¡¨ï¼ï¼‰</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>4.</strong> <em><strong>*Table å¯ä»¥å½“â€œå¯¹è±¡â€ç”¨ï¼ˆæ¨¡æ‹Ÿ OOPï¼‰*</strong></em></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- å®šä¹‰â€œç±»â€</span></span>
<span class="line"><span class="token keyword">local</span> Dog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> Dog<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">local</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>name <span class="token operator">=</span> name<span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setmetatable</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> self<span class="token punctuation">)</span></span>
<span class="line">    self<span class="token punctuation">.</span>__index <span class="token operator">=</span> self</span>
<span class="line">    <span class="token keyword">return</span> obj</span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> Dog<span class="token punctuation">:</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name <span class="token operator">..</span> <span class="token string">&quot; says woof!&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ä½¿ç”¨</span></span>
<span class="line"><span class="token keyword">local</span> my_dog <span class="token operator">=</span> Dog<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;Buddy&quot;</span><span class="token punctuation">)</span></span>
<span class="line">my_dog<span class="token punctuation">:</span><span class="token function">bark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--&gt; &quot;Buddy says woof!&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="å…¶ä»–-ä¼ª-æ•°æ®ç»“æ„-éƒ½åŸºäº-table-å®ç°" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–-ä¼ª-æ•°æ®ç»“æ„-éƒ½åŸºäº-table-å®ç°"><span><strong>å…¶ä»–â€œä¼ªâ€æ•°æ®ç»“æ„ï¼ˆéƒ½åŸºäº Table å®ç°ï¼‰</strong></span></a></h3><table><thead><tr><th style="text-align:left;">éœ€æ±‚</th><th style="text-align:left;">Lua å®ç°æ–¹å¼</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>åˆ—è¡¨ / æ ˆ / é˜Ÿåˆ—</strong></td><td style="text-align:left;">ç”¨æ•°ç»„å¼ table + <code>table.insert()</code> / <code>table.remove()</code></td></tr><tr><td style="text-align:left;"><strong>é›†åˆï¼ˆSetï¼‰</strong></td><td style="text-align:left;">ç”¨å­—å…¸å¼ tableï¼Œå€¼è®¾ä¸º <code>true</code>ï¼š <code>set = {apple=true, banana=true}</code></td></tr><tr><td style="text-align:left;"><strong>æ¨¡å—ï¼ˆModuleï¼‰</strong></td><td style="text-align:left;">è¿”å›ä¸€ä¸ª tableï¼š <code>return { func1 = ..., func2 = ... }</code></td></tr></tbody></table><h3 id="å¾ªç¯éå†" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯éå†"><span>å¾ªç¯éå†</span></a></h3><table><thead><tr><th style="text-align:left;">è¿­ä»£æ–¹å¼</th><th style="text-align:left;">ç”¨é€”</th><th style="text-align:left;">æ˜¯å¦æœ‰åº</th><th style="text-align:left;">èƒ½å¦è·³è¿‡ nil</th><th style="text-align:left;">å…¸å‹åœºæ™¯</th></tr></thead><tbody><tr><td style="text-align:left;"><code>for i = 1, #t</code></td><td style="text-align:left;">æ•°ç»„éå†</td><td style="text-align:left;">âœ… æœ‰åº</td><td style="text-align:left;">âŒ é‡ nil ä¸åœï¼ˆä½† <code>#t</code> å¯èƒ½ä¸å‡†ï¼‰</td><td style="text-align:left;">ç¡®å®šæ˜¯è¿ç»­æ•°ç»„</td></tr><tr><td style="text-align:left;"><code>ipairs(t)</code></td><td style="text-align:left;">æ•°ç»„éå†</td><td style="text-align:left;">âœ… æœ‰åº</td><td style="text-align:left;">âœ… é‡ nil åœæ­¢</td><td style="text-align:left;">å®‰å…¨éå†æ•°ç»„</td></tr><tr><td style="text-align:left;"><code>pairs(t)</code></td><td style="text-align:left;">å­—å…¸/æ··åˆè¡¨</td><td style="text-align:left;">âŒ æ— åº</td><td style="text-align:left;">âœ… è·³è¿‡ nil</td><td style="text-align:left;">éå†æ‰€æœ‰å­—æ®µ</td></tr></tbody></table><blockquote><p>ğŸ’¡ <strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>å¦‚æœæ˜¯<strong>çº¯æ•°ç»„</strong> â†’ ç”¨ <code>ipairs</code></li><li>å¦‚æœæ˜¯<strong>å¯¹è±¡/å­—å…¸</strong> â†’ ç”¨ <code>pairs</code></li><li>å¦‚æœéœ€è¦<strong>ä¸¥æ ¼æŒ‰ç´¢å¼• 1ï½n</strong> ä¸”çŸ¥é“é•¿åº¦ â†’ ç”¨æ•°å€¼ for</li></ul></blockquote><p><strong>æ•°ç»„ï¼š</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> fruits <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;banana&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cherry&quot;</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>fruits <span class="token keyword">do</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> fruits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"><span class="token comment">-- è¾“å‡º:</span></span>
<span class="line"><span class="token comment">-- 1    apple</span></span>
<span class="line"><span class="token comment">-- 2    banana</span></span>
<span class="line"><span class="token comment">-- 3    cherry</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ•°ç»„ï¼ˆé‡åˆ°nilå°±åœï¼‰ï¼š</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> colors <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"><span class="token comment">-- è¾“å‡º:</span></span>
<span class="line"><span class="token comment">-- 1    red</span></span>
<span class="line"><span class="token comment">-- 2    green</span></span>
<span class="line"><span class="token comment">-- 3    blue</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å­—å…¸ï¼š</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> person <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    name <span class="token operator">=</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    city <span class="token operator">=</span> <span class="token string">&quot;Beijing&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"><span class="token comment">-- å¯èƒ½è¾“å‡ºï¼ˆé¡ºåºä¸å®šï¼‰:</span></span>
<span class="line"><span class="token comment">-- name    Alice</span></span>
<span class="line"><span class="token comment">-- age     30</span></span>
<span class="line"><span class="token comment">-- city    Beijing</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‡½æ•°ä¸æ¡ä»¶" tabindex="-1"><a class="header-anchor" href="#å‡½æ•°ä¸æ¡ä»¶"><span>å‡½æ•°ä¸æ¡ä»¶</span></a></h3><table><thead><tr><th style="text-align:left;">ç‰¹æ€§</th><th style="text-align:left;">Lua å†™æ³•</th><th style="text-align:left;">å…³é”®ç‚¹</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>å‡½æ•°å®šä¹‰</strong></td><td style="text-align:left;"><code>function name(...) ... end</code></td><td style="text-align:left;">æ”¯æŒå¤šè¿”å›å€¼ã€å¯å˜å‚æ•°</td></tr><tr><td style="text-align:left;"><strong>åŒ¿åå‡½æ•°</strong></td><td style="text-align:left;"><code>function(...) ... end</code></td><td style="text-align:left;">å¯èµ‹å€¼ã€ä¼ å‚</td></tr><tr><td style="text-align:left;"><strong>æ¡ä»¶åˆ¤æ–­</strong></td><td style="text-align:left;"><code>if ... elseif ... else ... end</code></td><td style="text-align:left;">åªæœ‰ <code>false</code>/<code>nil</code> ä¸ºå‡</td></tr><tr><td style="text-align:left;"><strong>æ²¡æœ‰ switch</strong></td><td style="text-align:left;">ç”¨ <code>if-elseif</code> æˆ–è¡¨åˆ†å‘</td><td style="text-align:left;">è¡¨åˆ†å‘æ€§èƒ½é«˜ã€å¯æ‰©å±•</td></tr></tbody></table><p><strong>å‡½æ•°ï¼š</strong>ï¼ˆå•å˜é‡ä¼ çš„æ˜¯è™šå‚<strong>å‡ºæ¥ä¸å˜</strong>ï¼Œtableä¼ å¼•ç”¨<strong>å‡ºæ¥ä¼šå˜</strong>ï¼‰</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">function</span> å‡½æ•°å<span class="token punctuation">(</span>å‚æ•°<span class="token number">1</span><span class="token punctuation">,</span> å‚æ•°<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">-- å‡½æ•°ä½“</span></span>
<span class="line">    <span class="token keyword">return</span> è¿”å›å€¼  <span class="token comment">-- å¯é€‰ï¼Œå¯è¿”å›å¤šä¸ªå€¼</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ¡ä»¶ï¼š</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">if</span> æ¡ä»¶<span class="token number">1</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- æ¡ä»¶1ä¸ºçœŸæ—¶æ‰§è¡Œ</span></span>
<span class="line"><span class="token keyword">elseif</span> æ¡ä»¶<span class="token number">2</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- æ¡ä»¶2ä¸ºçœŸæ—¶æ‰§è¡Œ</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token comment">-- éƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œ</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… <strong>åªæœ‰ <code>false</code> å’Œ <code>nil</code> æ˜¯â€œå‡â€ï¼Œå…¶ä»–ä¸€åˆ‡ï¼ˆåŒ…æ‹¬ 0ã€ç©ºå­—ç¬¦ä¸² &quot;&quot;ï¼‰éƒ½æ˜¯â€œçœŸâ€ï¼</strong></p></blockquote><p>é€»è¾‘è¿ç®—ç¬¦ï¼š</p><table><thead><tr><th style="text-align:left;">è¿ç®—ç¬¦</th><th style="text-align:left;">è¡Œä¸º</th><th style="text-align:left;">è¿”å›å€¼</th></tr></thead><tbody><tr><td style="text-align:left;"><code>not x</code></td><td style="text-align:left;">å–å</td><td style="text-align:left;"><strong>æ€»æ˜¯ <code>true</code>/<code>false</code></strong></td></tr><tr><td style="text-align:left;"><code>a and b</code></td><td style="text-align:left;">çŸ­è·¯ä¸</td><td style="text-align:left;"><code>a</code>ï¼ˆè‹¥ a ä¸ºå‡ï¼‰ï¼Œå¦åˆ™ <code>b</code></td></tr><tr><td style="text-align:left;"><code>a or b</code></td><td style="text-align:left;">çŸ­è·¯æˆ–</td><td style="text-align:left;"><code>a</code>ï¼ˆè‹¥ a ä¸ºçœŸï¼‰ï¼Œå¦åˆ™ <code>b</code></td></tr></tbody></table><h2 id="openresty" tabindex="-1"><a class="header-anchor" href="#openresty"><span>OpenResty</span></a></h2><p><strong>OpenResty</strong> æ˜¯ä¸€ä¸ªåŸºäº <strong>Nginx + Lua</strong> çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œè®©ä½ èƒ½ç”¨ <strong>Lua è„šæœ¬ç›´æ¥åœ¨ Nginx å†…éƒ¨ç¼–å†™ä¸šåŠ¡é€»è¾‘</strong>ï¼Œå®ç°è¶…é«˜æ€§èƒ½çš„åŠ¨æ€ç½‘å…³ã€API æœåŠ¡ã€åå‘ä»£ç†ç­‰ã€‚</p><h3 id="å®‰è£…ä¸é…ç½®" tabindex="-1"><a class="header-anchor" href="#å®‰è£…ä¸é…ç½®"><span>å®‰è£…ä¸é…ç½®</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># æ·»åŠ å®˜æ–¹æºï¼ˆUbuntu/Debianï¼‰</span></span>
<span class="line"><span class="token function">wget</span> <span class="token parameter variable">-O</span> - https://openresty.org/package/pubkey.gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/openresty.gpg</span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;deb [signed-by=/usr/share/keyrings/openresty.gpg] http://openresty.org/package/debian  $ (lsb_release -sc) openresty&quot;</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/openresty.list</span>
<span class="line"></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt</span> update</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openresty</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®‰è£…openrestyçš„maven/npm</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt</span> openresty-opm</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>confé…ç½®æ ·ä¾‹ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token comment"># /usr/local/openresty/nginx/conf/nginx.conf</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token directive"><span class="token keyword">error_log</span> logs/error.log warn</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token directive"><span class="token keyword">pid</span> logs/nginx.pid</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span>  <span class="token comment"># Linux é«˜æ€§èƒ½ç½‘ç»œæ¨¡å‹</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">include</span>       mime.types</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">log_format</span> main <span class="token string">&#39; $ remote_addr -  $ remote_user [ $ time_local] &#39;</span></span>
<span class="line">                    <span class="token string">&#39;&quot; $ request&quot;  $ status  $ body_bytes_sent &#39;</span></span>
<span class="line">                    <span class="token string">&#39;&quot; $ http_referer&quot; &quot; $ http_user_agent&quot; &#39;</span></span>
<span class="line">                    <span class="token string">&#39;rt= $ request_time uct=&quot; $ upstream_connect_time&quot; &#39;</span></span>
<span class="line">                    <span class="token string">&#39;uht=&quot; $ upstream_header_time&quot; urt=&quot; $ upstream_response_time&quot;&#39;</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">access_log</span> logs/access.log main</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token comment"># å…¨å±€å…±äº«å†…å­˜å­—å…¸ï¼ˆç”¨äºé™æµã€ç¼“å­˜ï¼‰</span></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">lua_shared_dict</span> rate_limit_store <span class="token number">10m</span></span><span class="token punctuation">;</span>   <span class="token comment"># é™æµè®¡æ•°å™¨</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">lua_shared_dict</span> user_cache <span class="token number">50m</span></span><span class="token punctuation">;</span>         <span class="token comment"># ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token comment"># åç«¯æœåŠ¡ upstreamï¼ˆå¸¦å¥åº·æ£€æŸ¥ï¼‰</span></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">upstream</span> backend_servers</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server</span> backend1:8080 max_fails=2 fail_timeout=10s</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server</span> backend2:8080 max_fails=2 fail_timeout=10s</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server</span> backend3:8080 max_fails=2 fail_timeout=10s</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span>  <span class="token comment"># é•¿è¿æ¥æ± </span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token comment"># å…¨å±€ Lua åŒ…è·¯å¾„</span></span>
<span class="line">    <span class="token comment"># ========================</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">lua_package_path</span> <span class="token string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server_name</span> api.example.com</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token comment"># å…¨å±€é™æµï¼šæ¯ IP æ¯ç§’ 100 è¯·æ±‚</span></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">access_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">            local limit_req = require &quot;resty.limit.req&quot;</span>
<span class="line">            local lim, err = limit_req.new(&quot;rate_limit_store&quot;, 100, 1) -- 100 req/sec</span>
<span class="line">            if not lim then</span>
<span class="line">                ngx.log(ngx.ERR, &quot;failed to instantiate a limit_req object: &quot;, err)</span>
<span class="line">                return ngx.exit(500)</span>
<span class="line">            end</span>
<span class="line"></span>
<span class="line">            local key = ngx.var.binary_remote_addr</span>
<span class="line">            local delay, err = lim:incoming(key, true)</span>
<span class="line">            if not delay then</span>
<span class="line">                if err == &quot;rejected&quot; then</span>
<span class="line">                    ngx.log(ngx.WARN, &quot;rate limit rejected for &quot;, key)</span>
<span class="line">                    return ngx.exit(429)</span>
<span class="line">                end</span>
<span class="line">                ngx.log(ngx.ERR, &quot;failed to limit req: &quot;, err)</span>
<span class="line">                return ngx.exit(500)</span>
<span class="line">            end</span>
<span class="line"></span>
<span class="line">            if delay &gt; 0 then</span>
<span class="line">                ngx.sleep(delay)  -- å¹³æ»‘é™æµï¼ˆå¯é€‰ï¼‰</span>
<span class="line">            end</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token comment"># JWT é‰´æƒï¼ˆå‡è®¾ Authorization: Bearer &lt;token&gt;ï¼‰</span></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">access_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">                local cjson = require &quot;cjson.safe&quot;</span>
<span class="line">                local jwt = require &quot;resty.jwt&quot;</span>
<span class="line"></span>
<span class="line">                local auth_header = ngx.req.get_headers()[&quot;Authorization&quot;]</span>
<span class="line">                if not auth_header or not string.find(auth_header, &quot;Bearer &quot;) then</span>
<span class="line">                    ngx.status = 401</span>
<span class="line">                    ngx.say(&#39;<span class="token punctuation">{</span>&quot;error&quot;: &quot;Missing or invalid Authorization header&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">                    return ngx.exit(401)</span>
<span class="line">                end</span>
<span class="line"></span>
<span class="line">                local token = string.sub(auth_header, 8)  -- remove &quot;Bearer &quot;</span>
<span class="line">                local verified = jwt:verify(&quot;your-secret-key&quot;, token)</span>
<span class="line"></span>
<span class="line">                if not verified.verified then</span>
<span class="line">                    ngx.status = 401</span>
<span class="line">                    ngx.say(&#39;<span class="token punctuation">{</span>&quot;error&quot;: &quot;Invalid token&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">                    return ngx.exit(401)</span>
<span class="line">                end</span>
<span class="line"></span>
<span class="line">                -- å¯é€‰ï¼šå°†ç”¨æˆ· ID æ³¨å…¥è¯·æ±‚å¤´ç»™åç«¯</span>
<span class="line">                local payload = verified.payload</span>
<span class="line">                if payload and payload.user_id then</span>
<span class="line">                    ngx.req.set_header(&quot;X-User-ID&quot;, payload.user_id)</span>
<span class="line">                end</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment"># ========================</span></span>
<span class="line">            <span class="token comment"># ä»£ç†åˆ°åç«¯</span></span>
<span class="line">            <span class="token comment"># ========================</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">location</span> ï½ ^/api/(.*) $</span>  <span class="token punctuation">{</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend_servers/ $ <span class="token number">1</span> $ is_args $ args</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_set_header</span> Host  $ host</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP  $ remote_addr</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For  $ proxy_add_x_forwarded_for</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token comment"># å¥åº·æ£€æŸ¥æ¥å£ï¼ˆä¾›å¤–éƒ¨ LB ä½¿ç”¨ï¼‰</span></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /health</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">default_type</span> <span class="token string">&#39;text/plain&#39;</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">                ngx.say(&quot;OK&quot;)</span>
<span class="line">                ngx.exit(200)</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token comment"># é”™è¯¯é¡µé¢ç»Ÿä¸€å¤„ç†</span></span>
<span class="line">        <span class="token comment"># ========================</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">404</span> /404.json</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> = /404.json</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">default_type</span> application/json</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">                ngx.say(&#39;<span class="token punctuation">{</span>&quot;code&quot;:404,&quot;message&quot;:&quot;Not Found&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /5xx.json</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> = /5xx.json</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">internal</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">default_type</span> application/json</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">                ngx.say(&#39;<span class="token punctuation">{</span>&quot;code&quot;:500,&quot;message&quot;:&quot;Internal Server Error&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¯·æ±‚è§£ææµç¨‹" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚è§£ææµç¨‹"><span>è¯·æ±‚è§£ææµç¨‹</span></a></h3><p><strong>Nginx åœ¨æ”¶åˆ° HTTP è¯·æ±‚åï¼Œä¼šè‡ªåŠ¨è§£æè¯·æ±‚è¡Œä¸­çš„ URIï¼ˆè·¯å¾„ï¼‰ï¼Œç„¶åé€ä¸ªåŒ¹é… <code>server</code> å—ä¸­çš„ <code>location</code> æŒ‡ä»¤ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„ä¸€ä¸ªæ¥å¤„ç†è¯¥è¯·æ±‚ã€‚</strong></p><p><strong>ç¬¬ä¸€æ­¥ï¼šæ¥æ”¶è¯·æ±‚</strong></p><p>å®¢æˆ·ç«¯å‘é€ï¼š</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/api/user/123?debug=true</span> <span class="token http-version property">HTTP/1.1</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">example.com</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Nginx è§£æå‡ºï¼š</p><ul><li><strong>Host</strong>: <code>example.com</code></li><li><strong>URIï¼ˆè·¯å¾„ï¼‰</strong>: <code>/api/user/123</code></li><li><strong>Query String</strong>: <code>?debug=true</code></li></ul><hr><p><strong>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©</strong> <code>server</code> <strong>å—ï¼ˆåŸºäº</strong> <code>Host</code> <strong>å’Œç«¯å£ï¼‰</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server_name</span> example.com</span><span class="token punctuation">;</span>  <span class="token comment"># â† åŒ¹é… Host å¤´</span></span>
<span class="line">    ...</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… åªæœ‰ <code>server_name</code> åŒ¹é…çš„ <code>server</code> å—æ‰ä¼šè¢«é€‰ä¸­ã€‚</p></blockquote><hr><p><strong>ç¬¬ä¸‰æ­¥ï¼šåœ¨é€‰ä¸­çš„</strong> <code>server</code> <strong>ä¸­åŒ¹é…</strong> <code>location</code></p><p>Nginx æ‹¿åˆ° URI <code>/api/user/123</code>ï¼Œå¼€å§‹<strong>æŒ‰è§„åˆ™åŒ¹é… <code>location</code></strong>ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment"># æ‰€æœ‰è¯·æ±‚éƒ½åŒ¹é…ï¼ˆå‰ç¼€åŒ¹é…ï¼‰</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment"># æ›´ç²¾ç¡®ï¼šä»¥ /api/ å¼€å¤´çš„è¯·æ±‚</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> = /health</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment"># ç²¾ç¡®åŒ¹é… /health</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> ï½ /user/(\\d+)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment"># æ­£åˆ™åŒ¹é…ï¼Œæ•è·æ•°å­—</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ¯ Nginx ä¼šé€‰æ‹©<strong>æœ€åŒ¹é…</strong>çš„ <code>location</code>ï¼ˆéµå¾ªä¼˜å…ˆçº§è§„åˆ™ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚</p></blockquote><table><thead><tr><th style="text-align:left;">ç±»å‹</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;"><strong><code>=</code> ç²¾ç¡®åŒ¹é…</strong></td><td style="text-align:left;"><code>location = /status</code></td><td style="text-align:left;">å®Œå…¨ç›¸ç­‰æ‰åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰</td></tr><tr><td style="text-align:left;"><strong><code>^ï½</code> å‰ç¼€åŒ¹é…ï¼ˆç¦æ­¢æ­£åˆ™ï¼‰</strong></td><td style="text-align:left;"><code>location ^ï½ /static/</code></td><td style="text-align:left;">åŒ¹é…å‰ç¼€ï¼Œä¸”ä¸å†æ£€æŸ¥æ­£åˆ™</td></tr><tr><td style="text-align:left;"><strong><code>ï½</code> / <code>ï½\\*</code> æ­£åˆ™åŒ¹é…</strong></td><td style="text-align:left;"><code>location ï½ /user/(\\d+)</code></td><td style="text-align:left;"><code>ï½</code> åŒºåˆ†å¤§å°å†™ï¼Œ<code>ï½*</code> ä¸åŒºåˆ†</td></tr><tr><td style="text-align:left;"><strong>æ™®é€šå‰ç¼€åŒ¹é…</strong></td><td style="text-align:left;"><code>location /api/</code></td><td style="text-align:left;">æœ€é•¿å‰ç¼€åŒ¹é…ï¼ˆå¦‚ <code>/api/v2</code> æ¯” <code>/api</code> æ›´ä¼˜ï¼‰</td></tr></tbody></table><blockquote><p>âœ… <strong>ä¸€æ—¦åŒ¹é…æˆåŠŸï¼ŒNginx å°±åœ¨è¿™ä¸ª <code>location</code> å—ä¸­æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå¦‚ <code>proxy_pass</code>, <code>content_by_lua_block</code>ï¼‰</strong>ã€‚</p></blockquote><h3 id="è·å–è¯·æ±‚å‚æ•°" tabindex="-1"><a class="header-anchor" href="#è·å–è¯·æ±‚å‚æ•°"><span>è·å–è¯·æ±‚å‚æ•°</span></a></h3><p><strong>1. è·¯å¾„å ä½ç¬¦ï¼ˆPath Parametersï¼‰</strong></p><blockquote><p>@PathVariable</p></blockquote><table><thead><tr><th style="text-align:left;">å‚æ•°æ ¼å¼</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä»£ç </th></tr></thead><tbody><tr><td style="text-align:left;">è·¯å¾„å ä½ç¬¦</td><td style="text-align:left;"><code>/item/1001</code></td><td style="text-align:left;"><code>location ï½ /item/(\\d+) { ... }</code></td></tr></tbody></table><ul><li>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ•è·è·¯å¾„ä¸­çš„æ•°å­—ï¼›</li><li>åŒ¹é…åˆ°çš„å†…å®¹ä¼šè‡ªåŠ¨å­˜å…¥ <code>ngx.var[1]</code>, <code>ngx.var[2]</code>...ï¼›</li><li>å¯ä»¥ç”¨ <code>ngx.var[1]</code> è·å–ç¬¬ä¸€ä¸ªæ‹¬å·å†…çš„å€¼ã€‚</li></ul><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token comment"># ä½¿ç”¨å‘½åæ•è·ï¼ˆå¯è¯»æ€§æ›´å¼ºï¼‰</span></span>
<span class="line"><span class="token directive"><span class="token keyword">location</span> ï½ ^/item/(?&lt;id&gt;\\d+) $</span>  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">content_by_lua_file</span> lua/item.lua</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Lua æ–‡ä»¶ä¸­ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">local id = ngx.var.id  -- ç›´æ¥ç”¨åå­—è·å–</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>ğŸ’¡ <strong>ä¼˜åŠ¿</strong>ï¼šé¿å… <code>ngx.var[1]</code> çš„â€œé»‘ç›’â€æ„Ÿï¼Œæ›´æ˜“ç»´æŠ¤ã€‚</p></blockquote><p><strong>ğŸ”¹ 2. è¯·æ±‚å¤´ï¼ˆHeadersï¼‰</strong></p><table><thead><tr><th style="text-align:left;">å‚æ•°</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä»£ç </th></tr></thead><tbody><tr><td style="text-align:left;">è¯·æ±‚å¤´</td><td style="text-align:left;"><code>id: 1001</code></td><td style="text-align:left;"><code>local headers = ngx.req.get_headers()</code></td></tr></tbody></table><ul><li><code>ngx.req.get_headers()</code> è¿”å›ä¸€ä¸ª tableï¼Œé”®ä¸º header åï¼ˆå°å†™ï¼‰ï¼›</li><li>å¤šå€¼ headerï¼ˆå¦‚å¤šä¸ª <code>Set-Cookie</code>ï¼‰ä¼šè¿”å›æ•°ç»„ã€‚</li></ul><p><strong>ğŸ§© ç¤ºä¾‹ï¼š</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">local headers = ngx.req.get_headers()</span>
<span class="line">local auth_token = headers[&quot;authorization&quot;]</span>
<span class="line">local user_agent = headers[&quot;user-agent&quot;]</span>
<span class="line"></span>
<span class="line">-- å¦‚æœæœ‰å¤šä¸ª Cookie</span>
<span class="line">local cookies = headers[&quot;cookie&quot;]</span>
<span class="line">if type(cookies) == &quot;table&quot; then</span>
<span class="line">    for _, c in ipairs(cookies) do</span>
<span class="line">        print(c)</span>
<span class="line">    end</span>
<span class="line">end</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>ğŸ”¹ 3. GET è¯·æ±‚å‚æ•°ï¼ˆQuery Stringï¼‰</strong></p><blockquote><p>RequestParam</p></blockquote><table><thead><tr><th style="text-align:left;">å‚æ•°</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä»£ç </th></tr></thead><tbody><tr><td style="text-align:left;">GET å‚æ•°</td><td style="text-align:left;"><code>?id=1001</code></td><td style="text-align:left;"><code>local getParams = ngx.req.get_uri_args()</code></td></tr></tbody></table><ul><li><code>ngx.req.get_uri_args()</code> æ˜¯æ ‡å‡†æ–¹æ³•ï¼›</li><li>è¿”å›å€¼æ˜¯ tableï¼Œkey æ˜¯å‚æ•°åï¼Œvalue æ˜¯å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„ï¼›</li><li>è‡ªåŠ¨è§£ç  URL ç¼–ç ï¼ˆå¦‚ <code>%20</code> â†’ ç©ºæ ¼ï¼‰ã€‚</li></ul><p><strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">local args = ngx.req.get_uri_args()</span>
<span class="line"></span>
<span class="line">-- å•ä¸ªå€¼</span>
<span class="line">local id = args.id</span>
<span class="line"></span>
<span class="line">-- å¤šä¸ªåŒåå‚æ•°</span>
<span class="line">local tags = args.tag</span>
<span class="line">if type(tags) == &quot;table&quot; then</span>
<span class="line">    for i, v in ipairs(tags) do</span>
<span class="line">        print(&quot;Tag &quot;, i, &quot;: &quot;, v)</span>
<span class="line">    end</span>
<span class="line">else</span>
<span class="line">    print(&quot;Tag: &quot;, tags)</span>
<span class="line">end</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âŒ ä¸è¦ç›´æ¥ç”¨ <code>ngx.var.arg_id</code>ï¼Œå®ƒåªèƒ½å–ç¬¬ä¸€ä¸ªå€¼ä¸”ä¸æ”¯æŒå¤æ‚åœºæ™¯ã€‚</p></blockquote><hr><p><strong>ğŸ”¹ 4. POST è¡¨å•å‚æ•°ï¼ˆForm Dataï¼‰</strong></p><blockquote><p>RequestBody</p></blockquote><table><thead><tr><th style="text-align:left;">å‚æ•°</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä»£ç </th></tr></thead><tbody><tr><td style="text-align:left;">POST è¡¨å•</td><td style="text-align:left;"><code>id=1001</code></td><td style="text-align:left;"><code>ngx.req.read_body(); local postParams = ngx.req.get_post_args()</code></td></tr></tbody></table><ul><li>å¿…é¡»å…ˆè°ƒç”¨ <code>ngx.req.read_body()</code> è¯»å– bodyï¼›</li><li><code>get_post_args()</code> è§£æ <code>application/x-www-form-urlencoded</code>ï¼›</li><li>è¿”å›å€¼æ˜¯ tableï¼Œä¸ <code>get_uri_args()</code> ç±»ä¼¼ã€‚</li></ul><p><strong>âš ï¸ æ³¨æ„ï¼š</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">ngx.req.read_body()  -- å¿…é¡»æ”¾åœ¨å‰é¢ï¼</span>
<span class="line"></span>
<span class="line">local post_args = ngx.req.get_post_args(1000)  -- æœ€å¤šè§£æ 1000 ä¸ªå‚æ•°</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âŒ å¦‚æœæ²¡è°ƒç”¨ <code>read_body()</code>ï¼Œä¼šæŠ¥é”™æˆ–è¿”å›ç©ºã€‚</p></blockquote><hr><p><strong>ğŸ”¹ 5. JSON å‚æ•°</strong></p><table><thead><tr><th style="text-align:left;">å‚æ•°</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä»£ç </th></tr></thead><tbody><tr><td style="text-align:left;">JSON Body</td><td style="text-align:left;"><code>{&quot;id&quot;: 1001}</code></td><td style="text-align:left;"><code>ngx.req.read_body(); local jsonBody = ngx.req.get_body_data()</code></td></tr></tbody></table><ul><li><code>ngx.req.get_body_data()</code> è¿”å›åŸå§‹ body å­—ç¬¦ä¸²ï¼ˆstring ç±»å‹ï¼‰ï¼›</li><li>éœ€è¦æ‰‹åŠ¨ç”¨ <code>cjson</code> è§£æã€‚</li></ul><p><strong>âœ… å®Œæ•´ç¤ºä¾‹ï¼š</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">ngx.req.read_body()</span>
<span class="line">local body_data = ngx.req.get_body_data()</span>
<span class="line"></span>
<span class="line">if not body_data then</span>
<span class="line">    return ngx.exit(400)</span>
<span class="line">end</span>
<span class="line"></span>
<span class="line">local cjson = require &quot;cjson.safe&quot;</span>
<span class="line">local json_data, err = cjson.decode(body_data)</span>
<span class="line"></span>
<span class="line">if not json_data then</span>
<span class="line">    ngx.log(ngx.ERR, &quot;Invalid JSON: &quot;, err)</span>
<span class="line">    return ngx.exit(400)</span>
<span class="line">end</span>
<span class="line"></span>
<span class="line">local id = json_data.id</span>
<span class="line">ngx.say(&quot;ID: &quot;, id)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âš ï¸ <code>get_body_data()</code> ä»…é€‚ç”¨äºå° bodyï¼›å¤§æ–‡ä»¶ä¼šä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œéœ€ç”¨ <code>ngx.req.get_body_file()</code>ã€‚</p></blockquote><h3 id="ç›´æ¥å“åº”" tabindex="-1"><a class="header-anchor" href="#ç›´æ¥å“åº”"><span>ç›´æ¥å“åº”</span></a></h3><p>åœ¨ OpenResty ä¸­ï¼Œé€šè¿‡ <code>content_by_lua_block</code>ï¼ˆæˆ– <code>content_by_lua_file</code>ï¼‰å¯ä»¥ç›´æ¥ç”Ÿæˆ HTTP å“åº”ï¼Œ<strong>æ— éœ€ä»£ç†åˆ°åç«¯æœåŠ¡</strong>ã€‚è¿™æ˜¯æ„å»º API ç½‘å…³ã€å¥åº·æ£€æŸ¥ã€Mock æœåŠ¡ç­‰åœºæ™¯çš„æ ¸å¿ƒèƒ½åŠ›ã€‚</p><p><strong>1.</strong> <strong>è¾“å‡ºå†…å®¹ï¼š<code>ngx.say()</code> <code>ngx.print()</code></strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    ngx.say(&quot;Hello&quot;)        -- è¾“å‡º + æ¢è¡Œ</span>
<span class="line">    ngx.print(&quot;World&quot;)      -- è¾“å‡ºï¼ˆæ— æ¢è¡Œï¼‰</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">-- å“åº”ä½“: &quot;Hello\\nWorld&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ’¡ <code>ngx.say()</code> = <code>ngx.print(str, &quot;\\n&quot;)</code></p></blockquote><hr><p><strong>2.</strong> <strong>è®¾ç½®çŠ¶æ€ç ï¼š<code>ngx.exit(code)</code></strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    if not valid_user then</span>
<span class="line">        ngx.status = 403</span>
<span class="line">        ngx.say(&#39;<span class="token punctuation">{</span>&quot;error&quot;: &quot;Forbidden&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">        ngx.exit(403)  -- ç»ˆæ­¢æ‰§è¡Œ</span>
<span class="line">    end</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âš ï¸ <code>ngx.exit()</code> ä¼š<strong>ç«‹å³ç»ˆæ­¢å½“å‰è¯·æ±‚å¤„ç†</strong>ï¼Œåç»­ä»£ç ä¸æ‰§è¡Œã€‚</p></blockquote><hr><p><strong>3.</strong> <strong>è®¾ç½®å“åº”å¤´ï¼š<code>ngx.header[&quot;Header-Name&quot;]</code></strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    ngx.header[&quot;Content-Type&quot;] = &quot;application/json&quot;</span>
<span class="line">    ngx.header[&quot;Cache-Control&quot;] = &quot;no-cache&quot;</span>
<span class="line">    ngx.say(&#39;<span class="token punctuation">{</span>&quot;status&quot;: &quot;ok&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… å¯ä»¥è®¾ç½®å¤šä¸ªåŒå headerï¼ˆå¦‚ <code>Set-Cookie</code>ï¼‰ï¼š</p></blockquote><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">ngx.header[&quot;Set-Cookie&quot;]</span> =</span> <span class="token punctuation">{</span>&quot;session=abc&quot;, &quot;lang=en&quot;<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>4.</strong> <strong>è¿”å› JSONï¼ˆæ¨èç”¨ <code>cjson</code>ï¼‰</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">local</span> cjson = require <span class="token string">&quot;cjson&quot;</span></span>
<span class="line">    ngx.header[<span class="token string">&quot;Content-Type&quot;</span>] = <span class="token string">&quot;application/json&quot;</span></span>
<span class="line"></span>
<span class="line">    local data =</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">id</span> = 123,</span>
<span class="line">        name = <span class="token string">&quot;Alice&quot;</span>,</span>
<span class="line">        tags =</span> <span class="token punctuation">{</span>&quot;lua&quot;, &quot;openresty&quot;<span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    ngx.say(cjson.encode(data))</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">-- å“åº”: <span class="token punctuation">{</span>&quot;id&quot;:123,&quot;name&quot;:&quot;Alice&quot;,&quot;tags&quot;:[&quot;lua&quot;,&quot;openresty&quot;]<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ”’ å®‰å…¨å»ºè®®ï¼šç”¨ <code>cjson.safe</code> é¿å…å´©æºƒï¼š</p></blockquote><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">local cjson = require &quot;cjson.safe&quot;</span>
<span class="line">local json_str = cjson.encode(data)</span>
<span class="line">if not json_str then</span>
<span class="line">    ngx.status = 500</span>
<span class="line">    ngx.say(&#39;<span class="token punctuation">{</span>&quot;error&quot;: &quot;JSON encode failed&quot;<span class="token punctuation">}</span>&#39;)</span>
<span class="line">    ngx.exit(500)</span>
<span class="line">end</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>5.</strong> <strong>è¿”å› HTML / XML / è‡ªå®šä¹‰æ ¼å¼</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    ngx.header[&quot;Content-Type&quot;] = &quot;text/html<span class="token punctuation">;</span> charset=utf-8&quot;</span>
<span class="line">    ngx.say(&quot;&lt;h1&gt;Welcome to OpenResty!&lt;/h1&gt;&quot;)</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>6.</strong> <strong>é‡å®šå‘ï¼š301 / 302</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    ngx.header[&quot;Location&quot;] = &quot;https://example.com/new-path&quot;</span>
<span class="line">    ngx.exit(302)  -- æˆ– 301</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>7.</strong> <strong>ä¸‹è½½æ–‡ä»¶ï¼ˆè®¾ç½® Content-Dispositionï¼‰</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">{</span></span>
<span class="line">    local filename = &quot;report.pdf&quot;</span>
<span class="line">    ngx.header[&quot;Content-Type&quot;] = &quot;application/pdf&quot;</span>
<span class="line">    ngx.header[&quot;Content-Disposition&quot;] = &#39;attachment<span class="token punctuation">;</span> filename=&quot;&#39; .. filename .. &#39;&quot;&#39;</span>
<span class="line"></span>
<span class="line">    -- ä»æ–‡ä»¶è¯»å–ï¼ˆå°æ–‡ä»¶ï¼‰</span>
<span class="line">    local file = io.open(&quot;/path/to/report.pdf&quot;, &quot;rb&quot;)</span>
<span class="line">    if file then</span>
<span class="line">        ngx.print(file:read(&quot;*a&quot;))</span>
<span class="line">        file:close()</span>
<span class="line">    else</span>
<span class="line">        ngx.exit(404)</span>
<span class="line">    end</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âš ï¸ å¤§æ–‡ä»¶å»ºè®®ç”¨ <code>ngx.req.socket()</code> æµå¼å‘é€ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚</p></blockquote><p><strong>8. é¢å¤–é…ç½®luaè„šæœ¬æ–‡ä»¶content_by_lua_file</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">content_by_lua_file</span> /path/to/lua/user.lua</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>luaè„šæœ¬ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line">-- /usr/local/openresty/nginx/lua/user.lua</span>
<span class="line"></span>
<span class="line">-- è·å–è¯·æ±‚å‚æ•°</span>
<span class="line"><span class="token directive"><span class="token keyword">local</span> args = ngx.req.get_uri_args()</span>
<span class="line">local user_id = args.id</span>
<span class="line"></span>
<span class="line">-- å‚æ•°æ ¡éªŒ</span>
<span class="line">if not user_id then</span>
<span class="line">    ngx.status = <span class="token number">400</span></span>
<span class="line">    ngx.header[<span class="token string">&quot;Content-Type&quot;</span>] = <span class="token string">&quot;application/json&quot;</span></span>
<span class="line">    ngx.say(<span class="token string">&#39;{&quot;error&quot;: &quot;Missing id parameter&quot;}&#39;</span>)</span>
<span class="line">    return ngx.exit(400)</span>
<span class="line">end</span>
<span class="line"></span>
<span class="line">-- æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘</span>
<span class="line">local user =</span> <span class="token punctuation">{</span></span>
<span class="line">    id = tonumber(user_id),</span>
<span class="line">    name = &quot;Alice&quot;,</span>
<span class="line">    email = &quot;alice@example.com&quot;</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">-- è¿”å› JSON</span>
<span class="line">local cjson = require &quot;cjson&quot;</span>
<span class="line">ngx.header[&quot;Content-Type&quot;] = &quot;application/json&quot;</span>
<span class="line">ngx.say(cjson.encode(user))</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">ç‰¹æ€§</th><th style="text-align:left;"><code>content_by_lua_block</code></th><th style="text-align:left;"><code>content_by_lua_file</code></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>ä»£ç å¤ç”¨</strong></td><td style="text-align:left;">âŒ éš¾ä»¥å¤ç”¨</td><td style="text-align:left;">âœ… å¯è¢«å¤šä¸ª location å¼•ç”¨</td></tr><tr><td style="text-align:left;"><strong>è¯­æ³•é«˜äº®/è°ƒè¯•</strong></td><td style="text-align:left;">âŒ å­—ç¬¦ä¸²å†…åµŒï¼Œæ—  IDE æ”¯æŒ</td><td style="text-align:left;">âœ… æ ‡å‡† <code>.lua</code> æ–‡ä»¶ï¼Œæ”¯æŒ LSP</td></tr><tr><td style="text-align:left;"><strong>çƒ­æ›´æ–°</strong></td><td style="text-align:left;">âš ï¸ éœ€ reload Nginx</td><td style="text-align:left;">âœ… <strong>é»˜è®¤ç¼“å­˜ï¼Œéœ€å…³é—­æ‰èƒ½çƒ­æ›´æ–°</strong></td></tr><tr><td style="text-align:left;"><strong>å¤æ‚é€»è¾‘</strong></td><td style="text-align:left;">âŒ éš¾ä»¥ç»´æŠ¤</td><td style="text-align:left;">âœ… å¯åˆ†æ¨¡å—ã€å†™å‡½æ•°</td></tr><tr><td style="text-align:left;"><strong>ç‰ˆæœ¬æ§åˆ¶</strong></td><td style="text-align:left;">âŒ æ··åœ¨é…ç½®ä¸­</td><td style="text-align:left;">âœ… ç‹¬ç«‹æ–‡ä»¶ï¼ŒGit å‹å¥½</td></tr></tbody></table><p>è¿˜å¯ä»¥é€šè¿‡å…¨å±€é…ç½®luaè„šæœ¬åšä¸€äº›é€šç”¨çš„å‡½æ•°åŠ è½½åˆ°confæ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">lua_package_path</span> <span class="token string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿™æ ·libä¸‹çš„æ‰€æœ‰æ–‡ä»¶å°±ä¼šè¢«åŠ è½½åˆ°confæ–‡ä»¶ä¸­ï¼ˆç±»æ¯”jsçš„importï¼‰</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- å°è£…å‡½æ•°ï¼šå‘é€ HTTP GET è¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ä½“</span></span>
<span class="line"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">-- ä½¿ç”¨ ngx.location.capture å‘èµ·å†…éƒ¨è¯·æ±‚</span></span>
<span class="line">    <span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>  <span class="token comment">-- è¯·æ±‚æ–¹æ³•ï¼šGET</span></span>
<span class="line">        args <span class="token operator">=</span> params           <span class="token comment">-- æŸ¥è¯¢å‚æ•°ï¼ˆå¦‚ ?id=123ï¼‰</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">-- æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span></span>
<span class="line">        <span class="token comment">-- è®°å½•é”™è¯¯æ—¥å¿—</span></span>
<span class="line">        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;http not found, path: &quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">&quot;, args: &quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span></span>
<span class="line">        ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>  <span class="token comment">-- è¿”å› 404 é”™è¯¯</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">-- è¿”å›å“åº”ä½“ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰</span></span>
<span class="line">    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>body</span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- å°†å‡½æ•°å¯¼å‡ºä¸ºæ¨¡å—ï¼Œä¾›å…¶ä»–æ–‡ä»¶ä½¿ç”¨ å°±åƒjsçš„exportä¸€æ ·</span></span>
<span class="line"><span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    read_http <span class="token operator">=</span> read_http</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> _M</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä»£ç†é…ç½®" tabindex="-1"><a class="header-anchor" href="#ä»£ç†é…ç½®"><span>ä»£ç†é…ç½®</span></a></h3><p>å…ˆæ¥çœ‹çœ‹éœ€è¦ä»£ç†çš„è¯·æ±‚å¤„ç†æµç¨‹ï¼š</p><p><strong>ç¬¬ 1 æ­¥ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚</strong></p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/item/1001?debug=true</span> <span class="token http-version property">HTTP/1.1</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">api.example.com</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer xxx</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>ç¬¬ 2 æ­¥ï¼šNginx é€‰æ‹© <code>server</code> å—</strong></p><p>æ ¹æ® <code>Host: api.example.com</code> å’Œç›‘å¬ç«¯å£ï¼ˆå¦‚ 80ï¼‰ï¼ŒåŒ¹é…åˆ°å¯¹åº”çš„ <code>server</code>ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server_name</span> api.example.com</span><span class="token punctuation">;</span>  // â† åŒ¹é…æˆåŠŸ</span>
<span class="line">    ...</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>ç¬¬ 3 æ­¥ï¼šNginx åŒ¹é…</strong> <code>location</code></p><p>åœ¨ <code>server</code> å—ä¸­ï¼ŒæŸ¥æ‰¾èƒ½åŒ¹é… URI <code>/item/1001</code> çš„ <code>location</code>ã€‚</p><p>ä½ é…ç½®äº†ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">location</span> /item/</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend-service:8080</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… <strong>åŒ¹é…è§„åˆ™</strong>ï¼š <code>location /item/</code> æ˜¯<strong>å‰ç¼€åŒ¹é…</strong>ï¼Œåªè¦ URI ä»¥ <code>/item/</code> å¼€å¤´å°±å‘½ä¸­ï¼ˆåŒ…æ‹¬ <code>/item/1001</code>ã€<code>/item/list</code> ç­‰ï¼‰ã€‚</p></blockquote><hr><p><strong>ç¬¬ 4 æ­¥ï¼šNginx æ„é€ è½¬å‘è¯·æ±‚</strong></p><p>Nginx é»˜è®¤ä¼š<strong>ä¿ç•™åŸå§‹ URI å’Œ Query String</strong>ï¼Œå‘åç«¯å‘èµ·æ–°è¯·æ±‚ï¼š</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/item/1001?debug=true</span> <span class="token http-version property">HTTP/1.1</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">backend-service:8080          // â† æ³¨æ„ï¼šHost å˜äº†ï¼</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer xxx</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">X-Real-IP</span><span class="token punctuation">:</span> <span class="token header-value">203.0.113.10             // â† å¦‚æœä½ è®¾ç½®äº†</span></span></span>
<span class="line">...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ğŸ”‘ å…³é”®ç‚¹ï¼š <strong><code>proxy_pass</code> åé¢å¦‚æœ</strong> <strong>ä¸å¸¦ URI è·¯å¾„</strong>ï¼ˆå³åªå†™ <code>http://backend</code>ï¼‰ï¼ŒNginx ä¼š<strong>åŸæ ·è½¬å‘åŸå§‹ URI</strong>ã€‚</p></blockquote><hr><p><strong>ç¬¬ 5 æ­¥ï¼šåç«¯å¤„ç†å¹¶è¿”å›å“åº”</strong></p><p>åç«¯æ”¶åˆ°è¯·æ±‚ï¼Œå¤„ç† <code>/item/1001</code>ï¼Œè¿”å›ï¼š</p><div class="language-http line-numbers-mode" data-highlighter="prismjs" data-ext="http" data-title="http"><pre><code><span class="line"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span></span>
<span class="line"><span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span></span>
<span class="line"><span class="token application-json"></span>
<span class="line"><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1001</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;Book&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p><strong>ç¬¬ 6 æ­¥ï¼šNginx å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯</strong></p><p>Nginx æŠŠåç«¯çš„å“åº”<strong>åŸæ ·ï¼ˆæˆ–ç¨ä½œä¿®æ”¹ï¼‰è¿”å›ç»™å®¢æˆ·ç«¯</strong>ï¼Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p><p><strong>é‚£ä¹ˆå‡å¦‚æˆ‘çš„åç«¯æ˜¯é›†ç¾¤å‘¢ï¼Ÿæˆ‘è¦æ€ä¹ˆé…ç½®proxy_passï¼Ÿ</strong></p><p>é¦–å…ˆé…ç½®å¥½é›†ç¾¤çš„ipä»¥åŠç«¯å£ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token comment"># åœ¨ http {} å—ä¸­å®šä¹‰ï¼ˆé€šå¸¸æ”¾åœ¨ nginx.conf çš„ http æ®µï¼‰</span></span>
<span class="line"><span class="token directive"><span class="token keyword">upstream</span> item_backend</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 192.168.1.10:8080</span><span class="token punctuation">;</span>   <span class="token comment"># åç«¯èŠ‚ç‚¹1</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 192.168.1.11:8080</span><span class="token punctuation">;</span>   <span class="token comment"># åç«¯èŠ‚ç‚¹2</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> 192.168.1.12:8080</span><span class="token punctuation">;</span>   <span class="token comment"># åç«¯èŠ‚ç‚¹3</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éšååœ¨locationæ¥å£ä½¿ç”¨proxy_passè°ƒç”¨ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server_name</span> api.example.com</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /item/</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_pass</span> http://item_backend</span><span class="token punctuation">;</span>  <span class="token comment"># â† å¼•ç”¨ upstream åç§°</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host  $ host</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP  $ remote_addr</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For  $ proxy_add_x_forwarded_for</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¸åšé¢å¤–è®¾ç½®çš„è¯ï¼Œnginxé»˜è®¤ä½¿ç”¨<strong>è½®è¯¢</strong>çš„æ–¹å¼æ¥è´Ÿè½½å‡è¡¡è¯·æ±‚å¤„ç†ï¼š</p><table><thead><tr><th style="text-align:left;">ç®—æ³•</th><th style="text-align:left;">é…ç½®æ–¹å¼</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>è½®è¯¢ï¼ˆé»˜è®¤ï¼‰</strong></td><td style="text-align:left;">ä¸å†™ä»»ä½•æŒ‡ä»¤</td><td style="text-align:left;">è¯·æ±‚ä¾æ¬¡åˆ†å‘</td></tr><tr><td style="text-align:left;"><strong>åŠ æƒè½®è¯¢</strong></td><td style="text-align:left;"><code>weight=5</code></td><td style="text-align:left;">æƒé‡é«˜çš„æœºå™¨æ¥æ”¶æ›´å¤šè¯·æ±‚</td></tr><tr><td style="text-align:left;"><strong>IP Hash</strong></td><td style="text-align:left;"><code>ip_hash;</code></td><td style="text-align:left;">åŒä¸€å®¢æˆ·ç«¯å§‹ç»ˆè®¿é—®åŒä¸€å°ï¼ˆé€‚åˆ session ä¿æŒï¼‰</td></tr><tr><td style="text-align:left;"><strong>æœ€å°‘è¿æ¥</strong></td><td style="text-align:left;"><code>least_conn;</code></td><td style="text-align:left;">è½¬å‘ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„èŠ‚ç‚¹</td></tr></tbody></table><p><strong>ç¤ºä¾‹ï¼šåŠ æƒ + æœ€å°‘è¿æ¥</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">upstream</span> item_backend</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> backend1:8080 weight=5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> backend2:8080 weight=3</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> backend3:8080 weight=2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¤ºä¾‹ï¼šuri_hash</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">upstream</span> image_backend</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment"># åŸºäº URI å“ˆå¸Œï¼Œç¡®ä¿ç›¸åŒè¯·æ±‚æ€»ç”±åŒä¸€å°æœºå™¨å¤„ç†</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">hash</span>  $ uri</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> img1:8080 max_fails=2</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> img2:8080 max_fails=2</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> img3:8080 max_fails=2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">å˜é‡</th><th style="text-align:left;">ç¤ºä¾‹è¯·æ±‚</th><th style="text-align:left;">å€¼</th></tr></thead><tbody><tr><td style="text-align:left;"><code> $ uri</code></td><td style="text-align:left;"><code>GET /item/1001?debug=true</code></td><td style="text-align:left;"><code>/item/1001</code></td></tr><tr><td style="text-align:left;"><code> $ request_uri</code></td><td style="text-align:left;"><code>GET /item/1001?debug=true</code></td><td style="text-align:left;"><code>/item/1001?debug=true</code></td></tr></tbody></table><blockquote><p>åŒæ—¶è¿˜å¯ä»¥é…ä¸Šé•¿è¿æ¥é¿å…æ¯æ¬¡éƒ½å»ºç«‹tcpè¿æ¥ï¼Œé™ä½åç«¯å‹åŠ›ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">upstream</span> item_backend</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> backend1:8080</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span> backend2:8080</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span>  <span class="token comment"># ä¿æŒ 32 ä¸ªç©ºé—²é•¿è¿æ¥</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">location</span> /item/</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_pass</span> http://item_backend</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ğŸ”¥ <strong>å¼ºçƒˆå»ºè®®å¼€å¯ <code>keepalive</code></strong>ï¼Œå¯æ˜¾è‘—é™ä½åç«¯å‹åŠ›ã€‚</p><p>å†é…ä¸Šè¶…æ—¶æ–­è¿ï¼š</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">location</span> /item/</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_pass</span> http://item_backend</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># è¿æ¥è¶…æ—¶</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">3s</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># å‘é€è¯·æ±‚è¶…æ—¶</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># æ¥æ”¶å“åº”è¶…æ—¶</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># ç¼“å†²åŒºå¤§å°ï¼ˆé˜²å¤§å“åº”æ‹–å®å†…å­˜ï¼‰</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">proxy_buffers</span> <span class="token number">8</span> <span class="token number">4k</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="openrestyçš„redisæ¨¡å—" tabindex="-1"><a class="header-anchor" href="#openrestyçš„redisæ¨¡å—"><span>openrestyçš„redisæ¨¡å—</span></a></h3><p>luaä¸­è°ƒç”¨ï¼š</p><p><strong>æ­¥éª¤ 1ï¼šåˆ›å»º Redis å¯¹è±¡</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> redis <span class="token operator">=</span> require <span class="token string">&quot;resty.redis&quot;</span></span>
<span class="line"><span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 2ï¼šè®¾ç½®è¶…æ—¶ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">red<span class="token punctuation">:</span><span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment">-- 1ç§’è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 3ï¼šè¿æ¥ Redis</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;Redis connect failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 4ï¼šæ‰§è¡Œå‘½ä»¤</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- SET</span></span>
<span class="line"><span class="token keyword">local</span> res<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user:1001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">not</span> res <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;SET failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- GET</span></span>
<span class="line"><span class="token keyword">local</span> value<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user:1001&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> err <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;GET failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;Value: &quot;</span><span class="token punctuation">,</span> value <span class="token keyword">or</span> <span class="token string">&quot;nil&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 5ï¼šé‡Šæ”¾è¿æ¥ï¼ˆå…³é”®ï¼ï¼‰</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- æ–¹å¼1ï¼šæ”¾å›è¿æ¥æ± ï¼ˆæ¨èï¼‰</span></span>
<span class="line"><span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment">-- 10ç§’ç©ºé—²è¶…æ—¶ï¼Œæœ€å¤š100ä¸ªè¿æ¥</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;set_keepalive failed: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ–¹å¼2ï¼šæ˜¾å¼å…³é—­ï¼ˆä¸æ¨èï¼Œæµªè´¹æ€§èƒ½ï¼‰</span></span>
<span class="line"><span class="token comment">-- red:close()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… <strong>å¿…é¡»è°ƒç”¨ <code>set_keepalive()</code></strong>ï¼Œå¦åˆ™æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ–°å»º TCP è¿æ¥ï¼Œå¯¼è‡´æ€§èƒ½æš´è·Œï¼ï¼ˆä¸€èˆ¬ä¼šä¸€ç›´è¿æ¥è¿™ä¸ªRedisæœåŠ¡ï¼‰</p></blockquote><h3 id="openrestyçš„æœ¬åœ°ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#openrestyçš„æœ¬åœ°ç¼“å­˜"><span>openrestyçš„æœ¬åœ°ç¼“å­˜</span></a></h3><p><strong>æ­¥éª¤ 1ï¼šåœ¨</strong> <code>nginx.conf</code> <strong>ä¸­å®šä¹‰å…±äº«å†…å­˜åŒº</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment"># å®šä¹‰ä¸€ä¸ª 100MB çš„å…±äº«å†…å­˜å­—å…¸ï¼Œåä¸º &#39;my_cache&#39;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">lua_shared_dict</span> my_cache <span class="token number">100m</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /item/</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">content_by_lua_file</span> lua/item.lua</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ­¥éª¤ 2ï¼šåœ¨ Lua è„šæœ¬ä¸­ä½¿ç”¨ç¼“å­˜</strong></p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- lua/item.lua</span></span>
<span class="line"><span class="token keyword">local</span> cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>my_cache  <span class="token comment">-- è·å–å…±äº«å­—å…¸</span></span>
<span class="line"><span class="token keyword">local</span> user_id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">.</span>arg_id</span>
<span class="line"><span class="token keyword">local</span> cache_key <span class="token operator">=</span> <span class="token string">&quot;item:&quot;</span> <span class="token operator">..</span> user_id</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 1. å°è¯•ä»ç¼“å­˜è¯»å–</span></span>
<span class="line"><span class="token keyword">local</span> value<span class="token punctuation">,</span> flags <span class="token operator">=</span> cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> value <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">&quot;X-Cache&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;HIT&quot;</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 2. ç¼“å­˜æœªå‘½ä¸­ï¼šè°ƒç”¨åç«¯ï¼ˆæˆ–æ•°æ®åº“ï¼‰</span></span>
<span class="line"><span class="token keyword">local</span> cjson <span class="token operator">=</span> require <span class="token string">&quot;cjson&quot;</span></span>
<span class="line"><span class="token keyword">local</span> item_data <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    id <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    name <span class="token operator">=</span> <span class="token string">&quot;Sample Item&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    price <span class="token operator">=</span> <span class="token number">99.9</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">local</span> json_str <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>item_data<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 3. å†™å…¥ç¼“å­˜ï¼ˆè¿‡æœŸæ—¶é—´ 300 ç§’ï¼‰</span></span>
<span class="line"><span class="token keyword">local</span> success<span class="token punctuation">,</span> err <span class="token operator">=</span> cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>cache_key<span class="token punctuation">,</span> json_str<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">not</span> success <span class="token keyword">then</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;Failed to set cache: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">ngx<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">&quot;X-Cache&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;MISS&quot;</span></span>
<span class="line">ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>json_str<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>å¾®ç§’çº§è¯»å†™</strong>ï¼ˆæ¯”ç£ç›˜å¿« 1000 å€+ï¼‰ï¼›</li><li><strong>æ”¯æŒ TTLï¼ˆè¿‡æœŸæ—¶é—´ï¼‰</strong>ï¼›</li><li><strong>åŸå­æ“ä½œ</strong>ï¼ˆ<code>incr</code>, <code>add</code>, <code>replace</code>ï¼‰ï¼›</li><li><strong>æ‰€æœ‰ worker è¿›ç¨‹å…±äº«</strong>ï¼ˆè·¨è¿›ç¨‹ç¼“å­˜ï¼‰ã€‚</li></ul><h2 id="ç¼“å­˜åŒæ­¥-canal" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜åŒæ­¥-canal"><span>ç¼“å­˜åŒæ­¥ï¼ˆCanalï¼‰</span></a></h2><p>å¸¸è§çš„å¤„ç†ç¼“å­˜æ•°æ®ä¸€è‡´æ€§çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><p><strong>æœ‰æ•ˆæ—¶é—´</strong>ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ°æ—¶åˆ é™¤ï¼Œå†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ï¼ˆRedisçš„ttlï¼Œttlå†…ä¼šè¯»åˆ°è„æ•°æ®ï¼‰</p><p><strong>åŒæ­¥åŒå†™</strong>ï¼šæ•°æ®åº“æ›´æ–°æ—¶æ›´æ–°æ‰€æœ‰ç¼“å­˜ï¼ˆä¸šåŠ¡å†…éƒ¨å¤„ç†ï¼Œç»´æŠ¤æˆæœ¬å¤§ï¼‰</p><p><strong>å¼‚æ­¥é€šçŸ¥</strong>ï¼šæ•°æ®åº“æ›´æ–°æ—¶å‘é€äº‹ä»¶ï¼Œæ‰€æœ‰æœåŠ¡æ¥æ”¶åˆ°åæ›´æ–°ç¼“å­˜ï¼ˆMQï¼Œæ—¶æ•ˆæ€§æœ‰è¦æ±‚ï¼‰</p><h3 id="canalç›‘å¬æ•°æ®åº“" tabindex="-1"><a class="header-anchor" href="#canalç›‘å¬æ•°æ®åº“"><span>canalç›‘å¬æ•°æ®åº“</span></a></h3><p>å¦‚æœé‡‡ç”¨å¼‚æ­¥é€šçŸ¥çš„æ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•æ¯”å¦‚ä¸šåŠ¡ä¿®æ”¹æ•°æ®åº“ï¼Œå®Œæˆåå¼‚æ­¥MQä¿®æ”¹ç¼“å­˜ï¼Œè¿™æ ·çš„æ“ä½œè¦æ±‚æˆ‘ä»¬å‡†å¤‡å¥½ä¸€ä¸ªMQå¹¶è®¾ç½®å¥½ä¸€ä¸ªæ¶ˆè´¹è€…æ—¶åˆ»å‡†å¤‡å®Œæˆç¼“å­˜ä¿®æ”¹ä»»åŠ¡ï¼ŒåŒæ—¶è¿˜éœ€è¦æ•°æ®åº“éƒ¨åˆ†ä¸šåŠ¡æ˜¾å¼è°ƒç”¨æ·»åŠ æ¶ˆæ¯çš„æ¥å£ï¼Œå°†æ¶ˆæ¯å­˜å…¥MQã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥å°è¯•ä¸€ç§æ–°çš„æ–¹å¼ï¼šå‡†å¤‡ä¸€ä¸ªæœåŠ¡æ¥ç›‘å¬æ•°æ®åº“çš„ä¿®æ”¹ï¼Œå½“å‘ç”Ÿäº†å…³é”®ä¿¡æ¯çš„ä¿®æ”¹ç­‰æ“ä½œï¼Œå°±ä¼šè§¦å‘äº‹ä»¶ï¼Œå¼€å§‹ä¿®æ”¹ç¼“å­˜ã€‚è€Œè¿™ä¸ªæœåŠ¡ï¼Œå°±æ˜¯canalï¼š</p><blockquote><p>ç›¸æ¯”MQå¼‚æ­¥é€šçŸ¥ï¼Œè¿™ç§ç›‘å¬çš„æ–¹å¼ä»£ç è€¦åˆåº¦æ›´å°ä¸€ç‚¹ï¼Œä½†æ˜¯åç»­ç»´æŠ¤èµ·æ¥å¤æ‚åº¦æ›´å¤§</p></blockquote><p>Canal æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾<strong>åŸºäº MySQL æ•°æ®åº“å¢é‡æ—¥å¿—ï¼ˆbinlogï¼‰è§£æ</strong>çš„ç»„ä»¶ï¼Œä¸»è¦ç”¨äº<strong>å®æ—¶æ•è·æ•°æ®åº“å˜æ›´</strong>ï¼ˆCDC, Change Data Captureï¼‰ï¼Œå¹¶å°†è¿™äº›å˜æ›´ä»¥äº‹ä»¶æµçš„å½¢å¼æä¾›ç»™ä¸‹æ¸¸ç³»ç»Ÿä½¿ç”¨ã€‚</p><p><strong>ä¸»è¦æœºåˆ¶</strong></p><p>MySQL æœ¬èº«æ”¯æŒä¸»ä»å¤åˆ¶ï¼Œå…¶æœºåˆ¶æ˜¯ï¼š</p><ul><li>ä¸»åº“å°†æ•°æ®å˜æ›´å†™å…¥ <strong>Binary Logï¼ˆbinlogï¼‰</strong></li><li>ä»åº“é€šè¿‡ I/O çº¿ç¨‹è¿æ¥ä¸»åº“ï¼Œæ‹‰å– binlog å¹¶é‡æ”¾ï¼ˆreplayï¼‰</li></ul><p><strong>Canal æ­£æ˜¯æ¨¡æ‹Ÿäº† MySQL çš„ä»åº“è¡Œä¸º</strong>ï¼š</p><ul><li>å®ƒ<strong>ä¼ªè£…</strong>æˆä¸€ä¸ª MySQL slave</li><li>å‘ MySQL master å‘é€ dump åè®®è¯·æ±‚</li><li>MySQL master å°† binlog æ¨é€ç»™ Canal</li><li>Canal è§£æ binlog å†…å®¹ï¼ˆå¦‚ insert / update / deleteï¼‰</li><li>å°†ç»“æ„åŒ–çš„å˜æ›´æ•°æ®æš´éœ²ç»™å®¢æˆ·ç«¯ï¼ˆå¦‚ Kafkaã€RocketMQã€åº”ç”¨ç¨‹åºç­‰ï¼‰</li></ul><blockquote><p>å‰æï¼šMySQL å¿…é¡»å¼€å¯ binlogï¼Œå¹¶è®¾ç½®ä¸º <code>ROW</code> æ ¼å¼ï¼ˆæ¨è <code>binlog_format=ROW</code>ï¼‰</p></blockquote><p><strong>ä¸»è¦ç»„æˆ</strong></p><ol><li>Canal Server <ul><li>è´Ÿè´£è¿æ¥ MySQLã€æ‹‰å–å¹¶è§£æ binlog</li><li>ç®¡ç†å®ä¾‹ï¼ˆinstanceï¼‰ï¼Œæ¯ä¸ª instance å¯¹åº”ä¸€ä¸ªæ•°æ®åº“æˆ–ä¸€ç»„è¡¨</li><li>æ”¯æŒ HAï¼ˆé«˜å¯ç”¨ï¼‰éƒ¨ç½²ï¼Œé€šå¸¸é…åˆ ZooKeeper å®ç°</li></ul></li><li>Canal Clientï¼ˆAdapterï¼‰ <ul><li>æ¶ˆè´¹ Canal Server æä¾›çš„å˜æ›´æ•°æ®</li><li>å¯ä»¥æ˜¯è‡ªå®šä¹‰ Java åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…ç½®çš„é€‚é…å™¨ï¼ˆå¦‚å†™å…¥ Kafkaã€Elasticsearchã€HBase ç­‰ï¼‰</li></ul></li><li>Canal Adminï¼ˆå¯é€‰ï¼‰ <ul><li>Web ç®¡ç†ç•Œé¢ï¼Œç”¨äºé…ç½®å’Œç›‘æ§ Canal å®ä¾‹ï¼ˆä» Canal 1.1.4 å¼€å§‹æä¾›ï¼‰</li></ul></li></ol><p><strong>åº”ç”¨åœºæ™¯</strong></p><table><thead><tr><th style="text-align:left;">åœºæ™¯</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>æ•°æ®åŒæ­¥</strong></td><td style="text-align:left;"><strong>MySQL</strong> â†’ <strong>Elasticsearch</strong> / <strong>HBase</strong> / <strong>Redis</strong>ï¼Œå®ç°å¼‚æ„æ•°æ®æºåŒæ­¥</td></tr><tr><td style="text-align:left;"><strong>ç¼“å­˜æ›´æ–°</strong></td><td style="text-align:left;">DB å˜æ›´åè‡ªåŠ¨å¤±æ•ˆæˆ–æ›´æ–°ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰</td></tr><tr><td style="text-align:left;"><strong>ä¸šåŠ¡è§£è€¦</strong></td><td style="text-align:left;">è®¢å•åˆ›å»ºã€ç”¨æˆ·æ³¨å†Œç­‰äº‹ä»¶é€šè¿‡ Canal æ•è·ï¼Œè§¦å‘ä¸‹æ¸¸å¾®æœåŠ¡</td></tr><tr><td style="text-align:left;"><strong>å®¡è®¡ä¸æ—¥å¿—</strong></td><td style="text-align:left;">è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´ç”¨äºåˆè§„æˆ–åˆ†æ</td></tr><tr><td style="text-align:left;"><strong>å®æ—¶æ•°ä»“</strong></td><td style="text-align:left;">å°†ä¸šåŠ¡åº“å˜æ›´å®æ—¶å¯¼å…¥æ•°æ®æ¹–æˆ– OLAP ç³»ç»Ÿï¼ˆå¦‚ Dorisã€ClickHouseï¼‰</td></tr></tbody></table><h3 id="å®‰è£…é…ç½®canal" tabindex="-1"><a class="header-anchor" href="#å®‰è£…é…ç½®canal"><span>å®‰è£…é…ç½®canal</span></a></h3><p>ç”±äºcanalè¦æ±‚å¼€å¯mysqlçš„ä¸»ä»é›†ç¾¤é…ç½®ï¼Œæˆ‘ä»¬åœ¨å¼€å¯canalå‰éœ€è¦å…ˆå¼€å¯mysqlçš„ä¸»ä»é›†ç¾¤é…ç½®ï¼š</p><p><strong>1. MySQL é…ç½®ï¼ˆå¿…é¡»ï¼‰</strong></p><p>ç¡®ä¿ä½ çš„ MySQL æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š</p><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre><code><span class="line"><span class="token comment"># my.cnf æˆ– /etc/mysql/mysql.conf.d/mysqld.cnf</span></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token comment"># å¼€å¯ binlog</span></span>
<span class="line"><span class="token key attr-name">log-bin</span><span class="token punctuation">=</span><span class="token value attr-value">mysql-bin</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¼€å¯binlogçš„æ•°æ®åº“åç§°</span></span>
<span class="line"><span class="token key attr-name">binlog-do-db</span><span class="token punctuation">=</span><span class="token value attr-value">yourDBname</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># binlog æ ¼å¼å¿…é¡»ä¸º ROW</span></span>
<span class="line"><span class="token key attr-name">binlog-format</span><span class="token punctuation">=</span><span class="token value attr-value">ROW</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># server-id ä¸èƒ½ä¸º 0ï¼Œä¸”æ¯ä¸ª MySQL å®ä¾‹å”¯ä¸€</span></span>
<span class="line"><span class="token key attr-name">server-id</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ï¼ˆå¯é€‰ï¼‰è®¾ç½® binlog è¿‡æœŸæ—¶é—´ï¼Œé¿å…ç£ç›˜çˆ†æ»¡</span></span>
<span class="line"><span class="token key attr-name">expire_logs_days</span><span class="token punctuation">=</span><span class="token value attr-value">7</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ä¿®æ”¹åé‡å¯ MySQLï¼š<code>sudo systemctl restart mysql</code></p></blockquote><p><strong>2. åˆ›å»º Canal ä¸“ç”¨è´¦å·ï¼ˆæ¨èï¼‰</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- åˆ›å»ºç”¨æˆ·ï¼ˆIP æ ¹æ® Canal Server æ‰€åœ¨æœºå™¨è°ƒæ•´ï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> canal<span class="token variable">@&#39;%&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;canal123&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æˆäºˆå¤åˆ¶æƒé™ï¼ˆå…³é”®ï¼ï¼‰</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;canal&#39;</span><span class="token variable">@&#39;%&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ·æ–°æƒé™</span></span>
<span class="line">FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ³¨æ„ï¼š<code>REPLICATION SLAVE</code> å’Œ <code>REPLICATION CLIENT</code> æ˜¯ Canal æ¨¡æ‹Ÿä»åº“æ‰€å¿…éœ€çš„ã€‚</p></blockquote><p>æ¥ä¸‹æ¥å®Œæˆcanalçš„é…ç½®ï¼š</p><p><strong>å…¨å±€é…ç½®ï¼š</strong> <code>conf/canal.properties</code></p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># ç›‘å¬ç«¯å£ï¼ˆå®¢æˆ·ç«¯è¿æ¥ç”¨ï¼‰</span></span>
<span class="line"><span class="token key attr-name">canal.port</span> <span class="token punctuation">=</span> <span class="token value attr-value">11111</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ˜¯å¦å¼€å¯ TCP æ¨¡å¼ï¼ˆé»˜è®¤ trueï¼‰</span></span>
<span class="line"><span class="token key attr-name">canal.tcp.mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®ä¾‹åˆ—è¡¨ï¼ˆé»˜è®¤ exampleï¼‰</span></span>
<span class="line"><span class="token key attr-name">canal.destinations</span> <span class="token punctuation">=</span> <span class="token value attr-value">example</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># HA é…ç½®ï¼ˆå•æœºå¯å¿½ç•¥ï¼‰</span></span>
<span class="line"><span class="token comment"># canal.zkServers = </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®ä¾‹é…ç½®ï¼š</strong><code>conf/example/instance.properties</code></p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># MySQL ä¸»åº“åœ°å€</span></span>
<span class="line"><span class="token key attr-name">canal.instance.master.address</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:3306</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># MySQL è´¦å·å¯†ç ï¼ˆå‰é¢åˆ›å»ºçš„ï¼‰</span></span>
<span class="line"><span class="token key attr-name">canal.instance.dbUsername</span><span class="token punctuation">=</span><span class="token value attr-value">canal</span></span>
<span class="line"><span class="token key attr-name">canal.instance.dbPassword</span><span class="token punctuation">=</span><span class="token value attr-value">canal123</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ•°æ®åº“è¡¨è¿‡æ»¤ï¼ˆæ­£åˆ™ï¼‰</span></span>
<span class="line"><span class="token comment"># ç¤ºä¾‹ï¼šåªç›‘å¬ test åº“çš„ user è¡¨</span></span>
<span class="line"><span class="token comment"># canal.instance.filter.regex=test\\\\.user</span></span>
<span class="line"><span class="token comment"># é»˜è®¤ç›‘å¬æ‰€æœ‰åº“è¡¨ï¼š</span></span>
<span class="line"><span class="token key attr-name">canal.instance.filter.regex</span><span class="token punctuation">=</span><span class="token value attr-value">.*\\\\..*</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># binlog æ–‡ä»¶åï¼ˆå¯é€‰ï¼Œé¦–æ¬¡å¯åŠ¨å¯ä¸å¡«ï¼Œè‡ªåŠ¨ä»æœ€æ–°ä½ç‚¹å¼€å§‹ï¼‰</span></span>
<span class="line"><span class="token comment"># canal.instance.master.journal.name=</span></span>
<span class="line"><span class="token comment"># canal.instance.master.position=</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å­—ç¬¦é›†</span></span>
<span class="line"><span class="token key attr-name">canal.instance.connectionCharset</span> <span class="token punctuation">=</span> <span class="token value attr-value">UTF-8</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ˜¯å¦å¯ç”¨ TSDBï¼ˆè¡¨ç»“æ„ç¼“å­˜ï¼Œå»ºè®®å¼€å¯ï¼‰</span></span>
<span class="line"><span class="token key attr-name">canal.instance.tsdb.enable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååªè¦<code>sh bin/startup.sh</code>å¯åŠ¨å³å¯ç›‘å¬å¯¹åº”æ•°æ®åº“ã€‚</p><h3 id="canalå®¢æˆ·ç«¯é…ç½®" tabindex="-1"><a class="header-anchor" href="#canalå®¢æˆ·ç«¯é…ç½®"><span>canalå®¢æˆ·ç«¯é…ç½®</span></a></h3><p>pomå¼•å…¥ä¾èµ–ï¼š</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>top.javatool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>canal-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ymlé…ç½®ï¼š</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">canal</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">destination</span><span class="token punctuation">:</span> example                 <span class="token comment"># å¯¹åº” canal server çš„ instance åç§°</span></span>
<span class="line">  <span class="token key atrule">server</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">11111</span>             <span class="token comment"># canal server åœ°å€</span></span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> canal                     <span class="token comment"># é»˜è®¤ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> canal                     <span class="token comment"># é»˜è®¤å¯†ç ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token key atrule">batchSize</span><span class="token punctuation">:</span> <span class="token number">1000</span>                     <span class="token comment"># æ¯æ¬¡è·å–æ¶ˆæ¯çš„æœ€å¤§æ•°é‡</span></span>
<span class="line">  <span class="token key atrule">flatMessage</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>                   <span class="token comment"># æ˜¯å¦ä½¿ç”¨æ‰å¹³åŒ–æ¶ˆæ¯æ ¼å¼ï¼ˆæ¨è trueï¼‰</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®¢æˆ·ç«¯çš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯çš„ä½¿ç”¨"><span>å®¢æˆ·ç«¯çš„ä½¿ç”¨</span></a></h3><p><strong>æ–¹å¼1ï¼šç›‘å¬ç‰¹å®šè¡¨</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@CanalEventListener</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserTableListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@InsertEvent</span><span class="token punctuation">(</span>destination <span class="token operator">=</span> <span class="token string">&quot;example&quot;</span><span class="token punctuation">,</span> database <span class="token operator">=</span> <span class="token string">&quot;mydb&quot;</span><span class="token punctuation">,</span> table <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserInsert</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;User inserted: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@UpdateEvent</span><span class="token punctuation">(</span>destination <span class="token operator">=</span> <span class="token string">&quot;example&quot;</span><span class="token punctuation">,</span> database <span class="token operator">=</span> <span class="token string">&quot;mydb&quot;</span><span class="token punctuation">,</span> table <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserUpdate</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;User updated: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@DeleteEvent</span><span class="token punctuation">(</span>destination <span class="token operator">=</span> <span class="token string">&quot;example&quot;</span><span class="token punctuation">,</span> database <span class="token operator">=</span> <span class="token string">&quot;mydb&quot;</span><span class="token punctuation">,</span> table <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUserDelete</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;User deleted: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ³¨æ„ï¼š<code>@InsertEvent</code>ã€<code>@UpdateEvent</code> ç­‰æ˜¯ <code>canal-spring-boot-starter</code> æä¾›çš„ä¾¿æ·æ³¨è§£ã€‚</p></blockquote><p>å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åœ¨<strong>ç±»</strong>ä¸ŠæŒ‡å®šå¯¹åº”è¡¨ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token annotation punctuation">@CanalTable</span><span class="token punctuation">(</span><span class="token string">&quot;tb_item&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemHandler</span> <span class="token keyword">implements</span> <span class="token class-name">EntryHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–°å¢å•†å“ï¼š&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å°†æ•°æ®å†™å…¥ Redis</span></span>
<span class="line">        <span class="token comment">// redisTemplate.opsForValue().set(&quot;item:&quot; + item.getId(), item);</span></span>
<span class="line">        <span class="token comment">// æ¸…ç†æœ¬åœ°ç¼“å­˜</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Item</span> before<span class="token punctuation">,</span> <span class="token class-name">Item</span> after<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ›´æ–°å•†å“ï¼šæ—§å€¼=&quot;</span> <span class="token operator">+</span> before <span class="token operator">+</span> <span class="token string">&quot;, æ–°å€¼=&quot;</span> <span class="token operator">+</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ›´æ–° Redis æ•°æ®</span></span>
<span class="line">        <span class="token comment">// redisTemplate.opsForValue().set(&quot;item:&quot; + after.getId(), after);</span></span>
<span class="line">        <span class="token comment">// æ¸…ç†æœ¬åœ°ç¼“å­˜</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åˆ é™¤å•†å“ï¼š&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// åˆ é™¤ Redis æ•°æ®</span></span>
<span class="line">        <span class="token comment">// redisTemplate.delete(&quot;item:&quot; + item.getId());</span></span>
<span class="line">        <span class="token comment">// æ¸…ç†æœ¬åœ°ç¼“å­˜</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">æ³¨è§£</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>@CanalTable(&quot;tb_item&quot;)</code></td><td style="text-align:left;">æŒ‡å®šç›‘å¬çš„æ•°æ®åº“è¡¨åï¼ˆå¿…é¡»ä¸ MySQL è¡¨åä¸€è‡´ï¼‰</td></tr><tr><td style="text-align:left;"><code>@Component</code></td><td style="text-align:left;">Spring ç®¡ç†è¯¥ Beanï¼Œè‡ªåŠ¨æ³¨å†Œåˆ° Canal ç›‘å¬å™¨</td></tr><tr><td style="text-align:left;"><code>implements EntryHandler&lt;Item&gt;</code></td><td style="text-align:left;">å®ç°å¢åˆ æ”¹ä¸‰ä¸ªæ–¹æ³•ï¼Œæ¥æ”¶å®ä½“å¯¹è±¡</td></tr></tbody></table><p>å…¶ä¸­å¯¹äºEntityæœ‰ä¸€äº›è¦æ±‚ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;tb_item&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@Transient</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> stock<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@Transient</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sold<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">æ³¨è§£</th><th style="text-align:left;">ä½œç”¨</th><th style="text-align:left;">æ˜¯å¦å¿…é¡»</th></tr></thead><tbody><tr><td style="text-align:left;"><code>@TableName(&quot;tb_item&quot;)</code></td><td style="text-align:left;">æŒ‡å®šç›‘å¬çš„è¡¨å</td><td style="text-align:left;">æ˜¯ï¼ˆå¿…é¡»ï¼‰</td></tr><tr><td style="text-align:left;"><code>@Id</code> / <code>@TableId(type = IdType.AUTO)</code></td><td style="text-align:left;">æ ‡è®°ä¸»é”®å­—æ®µ</td><td style="text-align:left;">æ˜¯ï¼ˆå»ºè®®ï¼‰</td></tr><tr><td style="text-align:left;"><code>@Column(name = &quot;xxx&quot;)</code></td><td style="text-align:left;">æ˜ å°„æ•°æ®åº“åˆ—å</td><td style="text-align:left;">éå¿…éœ€ï¼Œä½†å­—æ®µåä¸åŒåˆ™å¿…é¡»</td></tr><tr><td style="text-align:left;"><code>@Transient</code> / <code>@TableField(exist = false)</code></td><td style="text-align:left;">æ ‡è®°éæ•°æ®åº“å­—æ®µ</td><td style="text-align:left;">å¯é€‰</td></tr></tbody></table><p><strong>æ–¹å¼2ï¼šä½¿ç”¨</strong> <code>@CanalEventListener</code> <strong>æ³¨è§£</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BinlogListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@CanalEventListener</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleUpdate</span><span class="token punctuation">(</span><span class="token class-name">Entry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¤„ç†æ‰€æœ‰ DML äº‹ä»¶ï¼ˆINSERT/UPDATE/DELETEï¼‰</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">ROWDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">RowChange</span> rowChange<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                row <span class="token operator">=</span> <span class="token class-name">RowChange</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getStoreValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidProtocolBufferException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData <span class="token operator">:</span> rowChange<span class="token punctuation">.</span><span class="token function">getRowDatasList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">switch</span> <span class="token punctuation">(</span>rowChange<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                        <span class="token function">handleInsert</span><span class="token punctuation">(</span>rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token constant">UPDATE</span><span class="token operator">:</span></span>
<span class="line">                        <span class="token function">handleUpdate</span><span class="token punctuation">(</span>rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token constant">DELETE</span><span class="token operator">:</span></span>
<span class="line">                        <span class="token function">handleDelete</span><span class="token punctuation">(</span>rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleInsert</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleUpdate</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleDelete</span><span class="token punctuation">(</span><span class="token class-name">RowData</span> rowData<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DELETE: &quot;</span> <span class="token operator">+</span> rowData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,295))])}const r=e(c,[["render",o]]),k=JSON.parse('{"path":"/docs/heimadianping/gaojipian/2.duojihuancun.html","title":"å¤šçº§ç¼“å­˜","lang":"en-US","frontmatter":{"title":"å¤šçº§ç¼“å­˜","date":"2026-1-26"},"headers":[{"level":2,"title":"JVMè¿›ç¨‹ç¼“å­˜(Caffeine )","slug":"jvmè¿›ç¨‹ç¼“å­˜-caffeine","link":"#jvmè¿›ç¨‹ç¼“å­˜-caffeine","children":[]},{"level":2,"title":"luaç®€å•è®¤è¯†","slug":"luaç®€å•è®¤è¯†","link":"#luaç®€å•è®¤è¯†","children":[{"level":3,"title":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","link":"#æ•°æ®ç»“æ„","children":[]},{"level":3,"title":"æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šTableï¼ˆè¡¨ï¼‰","slug":"æ ¸å¿ƒæ•°æ®ç»“æ„-table-è¡¨","link":"#æ ¸å¿ƒæ•°æ®ç»“æ„-table-è¡¨","children":[]},{"level":3,"title":"å…¶ä»–â€œä¼ªâ€æ•°æ®ç»“æ„ï¼ˆéƒ½åŸºäº Table å®ç°ï¼‰","slug":"å…¶ä»–-ä¼ª-æ•°æ®ç»“æ„-éƒ½åŸºäº-table-å®ç°","link":"#å…¶ä»–-ä¼ª-æ•°æ®ç»“æ„-éƒ½åŸºäº-table-å®ç°","children":[]},{"level":3,"title":"å¾ªç¯éå†","slug":"å¾ªç¯éå†","link":"#å¾ªç¯éå†","children":[]},{"level":3,"title":"å‡½æ•°ä¸æ¡ä»¶","slug":"å‡½æ•°ä¸æ¡ä»¶","link":"#å‡½æ•°ä¸æ¡ä»¶","children":[]}]},{"level":2,"title":"OpenResty","slug":"openresty","link":"#openresty","children":[{"level":3,"title":"å®‰è£…ä¸é…ç½®","slug":"å®‰è£…ä¸é…ç½®","link":"#å®‰è£…ä¸é…ç½®","children":[]},{"level":3,"title":"è¯·æ±‚è§£ææµç¨‹","slug":"è¯·æ±‚è§£ææµç¨‹","link":"#è¯·æ±‚è§£ææµç¨‹","children":[]},{"level":3,"title":"è·å–è¯·æ±‚å‚æ•°","slug":"è·å–è¯·æ±‚å‚æ•°","link":"#è·å–è¯·æ±‚å‚æ•°","children":[]},{"level":3,"title":"ç›´æ¥å“åº”","slug":"ç›´æ¥å“åº”","link":"#ç›´æ¥å“åº”","children":[]},{"level":3,"title":"ä»£ç†é…ç½®","slug":"ä»£ç†é…ç½®","link":"#ä»£ç†é…ç½®","children":[]},{"level":3,"title":"openrestyçš„redisæ¨¡å—","slug":"openrestyçš„redisæ¨¡å—","link":"#openrestyçš„redisæ¨¡å—","children":[]},{"level":3,"title":"openrestyçš„æœ¬åœ°ç¼“å­˜","slug":"openrestyçš„æœ¬åœ°ç¼“å­˜","link":"#openrestyçš„æœ¬åœ°ç¼“å­˜","children":[]}]},{"level":2,"title":"ç¼“å­˜åŒæ­¥ï¼ˆCanalï¼‰","slug":"ç¼“å­˜åŒæ­¥-canal","link":"#ç¼“å­˜åŒæ­¥-canal","children":[{"level":3,"title":"canalç›‘å¬æ•°æ®åº“","slug":"canalç›‘å¬æ•°æ®åº“","link":"#canalç›‘å¬æ•°æ®åº“","children":[]},{"level":3,"title":"å®‰è£…é…ç½®canal","slug":"å®‰è£…é…ç½®canal","link":"#å®‰è£…é…ç½®canal","children":[]},{"level":3,"title":"canalå®¢æˆ·ç«¯é…ç½®","slug":"canalå®¢æˆ·ç«¯é…ç½®","link":"#canalå®¢æˆ·ç«¯é…ç½®","children":[]},{"level":3,"title":"å®¢æˆ·ç«¯çš„ä½¿ç”¨","slug":"å®¢æˆ·ç«¯çš„ä½¿ç”¨","link":"#å®¢æˆ·ç«¯çš„ä½¿ç”¨","children":[]}]}],"git":{"createdTime":1771338216000,"updatedTime":1771338216000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/é»‘é©¬ç‚¹è¯„/é«˜çº§ç¯‡/2.å¤šçº§ç¼“å­˜.md"}');export{r as comp,k as data};
