import{_ as n,c as e,e as a,o as t}from"./app-Cm4IjFjh.js";const l={};function i(d,s){return t(),e("div",null,[...s[0]||(s[0]=[a(`<h2 id="自定义镜像" tabindex="-1"><a class="header-anchor" href="#自定义镜像"><span>自定义镜像</span></a></h2><p><strong>自定义镜像（Custom Image）</strong> 是指开发者基于官方或基础镜像，<strong>添加自己的应用程序、配置、依赖或脚本</strong>后构建出的新 Docker 镜像。它不再是通用的基础环境（如 <code>nginx</code>、<code>python</code>），而是<strong>包含你特定业务逻辑的可运行单元</strong>。</p><blockquote><p>✅ 举例：</p><ul><li>官方镜像：<code>python:3.11</code></li><li>自定义镜像：<code>my-company/user-service:v1</code>（内含你的 Python 代码、requirements、启动命令）</li></ul></blockquote><h3 id="为什么需要自定义镜像" tabindex="-1"><a class="header-anchor" href="#为什么需要自定义镜像"><span><strong>为什么需要自定义镜像？</strong></span></a></h3><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>应用打包</strong></td><td style="text-align:left;">将代码 + 依赖 + 运行时打包成一个独立单元</td></tr><tr><td style="text-align:left;"><strong>环境一致性</strong></td><td style="text-align:left;">开发、测试、生产使用完全相同的镜像</td></tr><tr><td style="text-align:left;"><strong>快速部署</strong></td><td style="text-align:left;">无需在每台机器上安装依赖，直接 <code>docker run</code></td></tr><tr><td style="text-align:left;"><strong>版本管理</strong></td><td style="text-align:left;">通过 Tag 管理不同版本（如 <code>v1.0</code>, <code>v2.1</code>）</td></tr></tbody></table><hr><h3 id="如何自制自定义镜像-——-核心工具-dockerfile" tabindex="-1"><a class="header-anchor" href="#如何自制自定义镜像-——-核心工具-dockerfile"><span><strong>如何自制自定义镜像？—— 核心工具：</strong><code>Dockerfile</code></span></a></h3><p>制作自定义镜像的标准方式是编写 <strong><code>Dockerfile</code></strong> —— 一个文本文件，包含一系列指令，描述如何构建镜像。</p><h2 id="dockerfile" tabindex="-1"><a class="header-anchor" href="#dockerfile"><span>Dockerfile</span></a></h2><p><code>Dockerfile</code> 是一个<strong>纯文本文件</strong>，包含一系列指令（Instructions），用于<strong>自动化构建 Docker 镜像</strong>。它定义了镜像的完整构建过程：从基础镜像开始，逐步添加文件、安装依赖、设置环境，最终形成一个可运行的应用容器镜像。</p><blockquote><p>✅ <strong>核心价值</strong>：</p><ul><li>实现<strong>构建过程可重复、可审计、可版本控制</strong></li><li>确保“开发-测试-生产”环境完全一致</li><li>是 CI/CD 流水线中构建镜像的标准方式</li></ul></blockquote><hr><h3 id="基本语法与规则" tabindex="-1"><a class="header-anchor" href="#基本语法与规则"><span>基本语法与规则</span></a></h3><h4 id="_1-指令格式" tabindex="-1"><a class="header-anchor" href="#_1-指令格式"><span>1. 指令格式</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># 注释以 # 开头</span></span>
<span class="line">INSTRUCTION arguments</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>指令<strong>不区分大小写</strong>，但<strong>约定全部大写</strong>（如 <code>FROM</code>, <code>RUN</code>）</li><li>每条指令<strong>创建一个镜像层（Layer）</strong></li><li>指令按<strong>从上到下顺序执行</strong></li></ul><h4 id="_2-构建上下文-build-context" tabindex="-1"><a class="header-anchor" href="#_2-构建上下文-build-context"><span>2. 构建上下文（Build Context）</span></a></h4><ul><li>执行 <code>docker build .</code> 时，<code>.</code> 表示<strong>构建上下文目录</strong></li><li>Docker 会将该目录<strong>所有文件上传到 Docker 引擎</strong>（即使某些文件未被使用）</li><li><code>COPY</code> / <code>ADD</code> 只能复制上下文内的文件（不能 <code>../outside/file</code>）</li></ul><blockquote><p>⚠️ <strong>重要</strong>：敏感文件（如 <code>.env</code>, <code>id_rsa</code>）应通过 <code>.dockerignore</code> 排除！</p></blockquote><h4 id="_3-dockerignore-文件" tabindex="-1"><a class="header-anchor" href="#_3-dockerignore-文件"><span>3. <code>.dockerignore</code> 文件</span></a></h4><p>作用类似 <code>.gitignore</code>，避免无关或敏感文件被上传：</p><div class="language-gitignore line-numbers-mode" data-highlighter="prismjs" data-ext="gitignore" data-title="gitignore"><pre><code><span class="line"><span class="token entry string">.git</span></span>
<span class="line"><span class="token entry string">node_modules</span></span>
<span class="line"><span class="token entry string"><span class="token operator">*</span>.log</span></span>
<span class="line"><span class="token entry string">.env</span></span>
<span class="line"><span class="token entry string">Dockerfile</span></span>
<span class="line"><span class="token entry string">README.md</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="示例" tabindex="-1"><a class="header-anchor" href="#示例"><span>示例</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># 使用明确版本的基础镜像（slim 减小体积）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> python:3.11-slim <span class="token keyword">AS</span> builder</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置工作目录</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装系统依赖（用于编译 Python 包）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    apt-get install -y --no-install-recommends <span class="token operator">\\</span></span>
<span class="line">        gcc <span class="token operator">\\</span></span>
<span class="line">        libpq-dev &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 复制依赖文件（利用层缓存：依赖不变则跳过安装）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> requirements.txt .</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装 Python 依赖（使用国内源加速）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ===== 运行阶段（多阶段构建）=====</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> python:3.11-slim</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建非 root 用户（安全加固）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --disabled-password --gecos <span class="token string">&#39;&#39;</span> appuser &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    mkdir -p /app &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    chown -R appuser:appuser /app</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 切换到非 root 用户</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">USER</span> appuser</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置工作目录</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从 builder 阶段复制已安装的依赖</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 复制应用代码</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">appuser:appuser</span></span> . .</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 声明端口（文档作用）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置环境变量</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> FLASK_ENV=production</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 健康检查</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span> <span class="token property">--start-period</span><span class="token punctuation">=</span><span class="token string">5s</span> <span class="token property">--retries</span><span class="token punctuation">=</span><span class="token string">3</span></span> <span class="token operator">\\</span></span>
<span class="line">  <span class="token keyword">CMD</span> curl -f http://localhost:5000/ || exit 1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动命令</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;--host=0.0.0.0&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="核心指令详解" tabindex="-1"><a class="header-anchor" href="#核心指令详解"><span>核心指令详解</span></a></h3><table><thead><tr><th style="text-align:left;">指令</th><th style="text-align:left;">示例</th><th style="text-align:left;">作用</th><th style="text-align:left;">关键说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong><code>FROM</code></strong></td><td style="text-align:left;"><code>FROM python:3.11-slim</code> <code>FROM node:18-alpine AS builder</code></td><td style="text-align:left;">指定基础镜像</td><td style="text-align:left;">必须是第一条非注释指令；支持多阶段构建别名（<code>AS</code>）</td></tr><tr><td style="text-align:left;"><strong><code>WORKDIR</code></strong></td><td style="text-align:left;"><code>WORKDIR /app</code></td><td style="text-align:left;">设置后续指令的工作目录</td><td style="text-align:left;">自动创建目录；可多次使用</td></tr><tr><td style="text-align:left;"><strong><code>COPY</code></strong></td><td style="text-align:left;"><code>COPY . /app</code> <code>COPY requirements.txt .</code></td><td style="text-align:left;">从构建上下文复制文件到镜像</td><td style="text-align:left;"><strong>推荐</strong>用于本地文件；保留权限</td></tr><tr><td style="text-align:left;"><strong><code>ADD</code></strong></td><td style="text-align:left;"><code>ADD app.tar.gz /app/</code> <code>ADD https://x.com/file.zip /tmp/</code></td><td style="text-align:left;">复制并自动解压/下载</td><td style="text-align:left;"><strong>谨慎使用</strong>；仅当需要自动解压或远程 URL 时用</td></tr><tr><td style="text-align:left;"><strong><code>RUN</code></strong></td><td style="text-align:left;"><code>RUN apt-get update &amp;&amp; apt-get install -y curl</code></td><td style="text-align:left;">构建时执行命令</td><td style="text-align:left;">每条创建新层；<strong>合并命令+清理缓存</strong>减小体积</td></tr><tr><td style="text-align:left;"><strong><code>CMD</code></strong></td><td style="text-align:left;"><code>CMD [&quot;python&quot;, &quot;app.py&quot;]</code></td><td style="text-align:left;">容器启动默认命令</td><td style="text-align:left;">可被 <code>docker run</code> 覆盖；<strong>exec 形式（数组）推荐</strong></td></tr><tr><td style="text-align:left;"><strong><code>ENTRYPOINT</code></strong></td><td style="text-align:left;"><code>ENTRYPOINT [&quot;./start.sh&quot;]</code></td><td style="text-align:left;">容器主命令（不易覆盖）</td><td style="text-align:left;">与 <code>CMD</code> 组合：<code>ENTRYPOINT</code> 固定，<code>CMD</code> 提供默认参数</td></tr><tr><td style="text-align:left;"><strong><code>EXPOSE</code></strong></td><td style="text-align:left;"><code>EXPOSE 80 443</code></td><td style="text-align:left;">声明容器监听端口</td><td style="text-align:left;"><strong>仅文档作用</strong>；实际映射需 <code>docker run -p</code></td></tr><tr><td style="text-align:left;"><strong><code>ENV</code></strong></td><td style="text-align:left;"><code>ENV NODE_ENV=production</code> <code>ENV PATH=&quot;/opt/bin: $ PATH&quot;</code></td><td style="text-align:left;">设置环境变量</td><td style="text-align:left;">在构建和运行时均生效；可通过 <code>-e</code> 覆盖</td></tr><tr><td style="text-align:left;"><strong><code>VOLUME</code></strong></td><td style="text-align:left;"><code>VOLUME [&quot;/data&quot;]</code></td><td style="text-align:left;">声明持久化挂载点</td><td style="text-align:left;">运行时若未挂载，自动创建匿名卷</td></tr><tr><td style="text-align:left;"><strong><code>USER</code></strong></td><td style="text-align:left;"><code>USER appuser</code></td><td style="text-align:left;">切换运行用户</td><td style="text-align:left;"><strong>安全最佳实践</strong>：避免 root 权限</td></tr><tr><td style="text-align:left;"><strong><code>HEALTHCHECK</code></strong></td><td style="text-align:left;"><code>HEALTHCHECK CMD curl -f http://localhost/</code></td><td style="text-align:left;">定义健康检查命令</td><td style="text-align:left;">容器状态显示为 <code>healthy</code>/<code>unhealthy</code></td></tr><tr><td style="text-align:left;"><strong><code>LABEL</code></strong></td><td style="text-align:left;"><code>LABEL maintainer=&quot;dev@example.com&quot;</code></td><td style="text-align:left;">添加镜像元数据</td><td style="text-align:left;">用于描述作者、版本等信息</td></tr><tr><td style="text-align:left;"><strong><code>ARG</code></strong></td><td style="text-align:left;"><code>ARG VERSION=1.0</code> <code>RUN echo $ VERSION</code></td><td style="text-align:left;">定义构建参数</td><td style="text-align:left;">通过 <code>--build-arg</code> 传值；<strong>不在最终镜像中保留</strong></td></tr></tbody></table><h4 id="from-——-指定基础镜像-必须是第一条非注释指令" tabindex="-1"><a class="header-anchor" href="#from-——-指定基础镜像-必须是第一条非注释指令"><span><code>FROM</code> —— 指定基础镜像（必须是第一条非注释指令）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:22.04</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">AS</span> builder  # 支持多阶段构建别名</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ <strong>最佳实践</strong>：</p><ul><li>使用<strong>具体标签</strong>（如 <code>python:3.11-slim</code>），避免 <code>latest</code></li><li>优先选择 <strong><code>-slim</code> 或 <code>alpine</code></strong> 版本以减小体积</li></ul></blockquote><h4 id="workdir-——-设置工作目录" tabindex="-1"><a class="header-anchor" href="#workdir-——-设置工作目录"><span><code>WORKDIR</code> —— 设置工作目录</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app    # 后续 COPY、RUN、CMD 的默认路径</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>若目录不存在，会自动创建</li><li>可多次使用，后续指令基于最新 <code>WORKDIR</code></li></ul><h4 id="copy-——-复制文件-目录-推荐" tabindex="-1"><a class="header-anchor" href="#copy-——-复制文件-目录-推荐"><span><code>COPY</code> —— 复制文件/目录（推荐）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . /app                # 复制上下文所有文件到 /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> requirements.txt .    # 复制单个文件到当前 WORKDIR</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>仅支持本地文件</strong>（不能是 URL）</li><li><strong>保留文件权限和元数据</strong></li></ul><h4 id="add-——-复制并自动解压-谨慎使用" tabindex="-1"><a class="header-anchor" href="#add-——-复制并自动解压-谨慎使用"><span><code>ADD</code> —— 复制并自动解压（谨慎使用）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ADD</span> https://example.com/app.tar.gz /app/   # 支持 URL</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> app.tar.gz /app/                       # 自动解压 .tar.gz</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>⚠️ <strong>官方建议</strong>： <strong>优先用 <code>COPY</code></strong>，仅在需要自动解压或下载远程文件时用 <code>ADD</code></p></blockquote><h4 id="run-——-执行命令-构建时" tabindex="-1"><a class="header-anchor" href="#run-——-执行命令-构建时"><span><code>RUN</code> —— 执行命令（构建时）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y curl vim</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip install -r requirements.txt</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>每条 <code>RUN</code> 创建一个新层</p></li><li><p>✅ 合并命令减少层数（用 <code>&amp;&amp;</code>连接）：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    apt-get install -y --no-install-recommends <span class="token operator">\\</span></span>
<span class="line">        curl <span class="token operator">\\</span></span>
<span class="line">        vim &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="cmd-——-容器启动默认命令-可被覆盖" tabindex="-1"><a class="header-anchor" href="#cmd-——-容器启动默认命令-可被覆盖"><span><code>CMD</code> —— 容器启动默认命令（可被覆盖）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;python&quot;</span>, <span class="token string">&quot;app.py&quot;</span>]           # exec 形式（推荐）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> python app.py                  # shell 形式（不推荐）</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>一个 Dockerfile <strong>只能有一个 <code>CMD</code></strong>（多个则最后一个生效）</li><li><code>docker run image command</code> 会<strong>覆盖</strong> <code>CMD</code></li></ul><h4 id="entrypoint-——-容器主命令-不易被覆盖" tabindex="-1"><a class="header-anchor" href="#entrypoint-——-容器主命令-不易被覆盖"><span><code>ENTRYPOINT</code> —— 容器主命令（不易被覆盖）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;./start.sh&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>与 <code>CMD</code> 组合使用：<code>ENTRYPOINT</code> 定义固定命令，<code>CMD</code> 提供默认参数</li><li><code>docker run image arg1 arg2</code> → 会传递给 <code>ENTRYPOINT</code></li></ul><blockquote><p>🔄 <strong><code>CMD</code> vs <code>ENTRYPOINT</code></strong>：</p><table><thead><tr><th>场景</th><th>推荐</th></tr></thead><tbody><tr><td>应用直接启动（如 Nginx）</td><td><code>ENTRYPOINT [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</code></td></tr><tr><td>提供默认参数，允许用户覆盖</td><td><code>CMD [&quot;--help&quot;]</code></td></tr></tbody></table></blockquote><h4 id="expose-——-声明端口-文档作用" tabindex="-1"><a class="header-anchor" href="#expose-——-声明端口-文档作用"><span><code>EXPOSE</code> —— 声明端口（文档作用）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 80 443</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><strong>不实际发布端口</strong>！仅作为文档提示</li><li>实际端口映射需 <code>docker run -p</code></li></ul><h4 id="env-——-设置环境变量" tabindex="-1"><a class="header-anchor" href="#env-——-设置环境变量"><span><code>ENV</code> —— 设置环境变量</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV=production</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> PATH=<span class="token string">&quot;/usr/local/node/bin:$PATH&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>变量在后续 <code>RUN</code> 和容器运行时均可用</li><li>可通过 <code>docker run -e</code> 覆盖</li></ul><h4 id="volume-——-声明挂载点" tabindex="-1"><a class="header-anchor" href="#volume-——-声明挂载点"><span><code>VOLUME</code> —— 声明挂载点</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">VOLUME</span> [<span class="token string">&quot;/data&quot;</span>, <span class="token string">&quot;/var/log&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>告知用户哪些目录应持久化</li><li>运行时若未挂载，Docker 会自动创建匿名卷</li></ul><hr><h3 id="多阶段构建-multi-stage-build" tabindex="-1"><a class="header-anchor" href="#多阶段构建-multi-stage-build"><span>多阶段构建（Multi-stage Build）</span></a></h3><p>用于<strong>大幅减小最终镜像体积</strong>，尤其适用于编译型语言（Go、Java、C++）。</p><h4 id="示例-go-应用" tabindex="-1"><a class="header-anchor" href="#示例-go-应用"><span>示例：Go 应用</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token comment"># 第一阶段：构建</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> golang:1.22 <span class="token keyword">AS</span> builder</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> CGO_ENABLED=0 GOOS=linux go build -o main .</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 第二阶段：运行</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> alpine:latest</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apk --no-cache add ca-certificates</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /root/</span></span>
<span class="line"><span class="token comment"># 仅从 builder 阶段复制二进制文件</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/main .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;./main&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ <strong>优势</strong>：</p><ul><li>最终镜像不含 Go 编译器（从 800MB+ 降至 10MB）</li><li>构建依赖与运行时完全隔离</li></ul></blockquote><hr><h3 id="构建与验证流程" tabindex="-1"><a class="header-anchor" href="#构建与验证流程"><span>构建与验证流程</span></a></h3><h4 id="_1-构建镜像" tabindex="-1"><a class="header-anchor" href="#_1-构建镜像"><span>1. 构建镜像</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 在 Dockerfile 所在目录执行</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> my-app:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 指定 Dockerfile 路径（非默认名称）</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> ./deploy/Dockerfile.prod <span class="token parameter variable">-t</span> my-app:prod <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-查看构建历史" tabindex="-1"><a class="header-anchor" href="#_2-查看构建历史"><span>2. 查看构建历史</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">history</span> my-app:v1  <span class="token comment"># 查看各层大小和指令</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-测试运行" tabindex="-1"><a class="header-anchor" href="#_3-测试运行"><span>3. 测试运行</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 <span class="token parameter variable">--name</span> test-app my-app:v1</span>
<span class="line"><span class="token function">curl</span> http://localhost:8080</span>
<span class="line"><span class="token function">docker</span> logs test-app</span>
<span class="line"><span class="token function">docker</span> stop test-app <span class="token operator">&amp;&amp;</span> <span class="token function">docker</span> <span class="token function">rm</span> test-app</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-推送镜像-可选" tabindex="-1"><a class="header-anchor" href="#_4-推送镜像-可选"><span>4. 推送镜像（可选）</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> tag my-app:v1 registry.example.com/my-app:v1</span>
<span class="line"><span class="token function">docker</span> push registry.example.com/my-app:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="最佳实践与常见陷阱" tabindex="-1"><a class="header-anchor" href="#最佳实践与常见陷阱"><span>最佳实践与常见陷阱</span></a></h3><h4 id="✅-推荐做法" tabindex="-1"><a class="header-anchor" href="#✅-推荐做法"><span>✅ 推荐做法</span></a></h4><table><thead><tr><th>实践</th><th>说明</th></tr></thead><tbody><tr><td><strong>使用 <code>.dockerignore</code></strong></td><td>避免上传无用文件，加速构建</td></tr><tr><td><strong>固定基础镜像版本</strong></td><td><code>FROM python:3.11-slim</code> 而非 <code>python</code></td></tr><tr><td><strong>合并 RUN 指令</strong></td><td>减少镜像层数，清理缓存（如 <code>rm -rf /var/lib/apt/lists/*</code>）</td></tr><tr><td><strong>非 root 用户运行</strong></td><td><code>RUN adduser appuser &amp;&amp; chown -R appuser /app</code> + <code>USER appuser</code></td></tr><tr><td><strong>优先 COPY 而非 ADD</strong></td><td>明确控制文件来源</td></tr><tr><td><strong>使用多阶段构建</strong></td><td>分离构建环境与运行环境</td></tr></tbody></table><h4 id="❌-常见错误" tabindex="-1"><a class="header-anchor" href="#❌-常见错误"><span>❌ 常见错误</span></a></h4><table><thead><tr><th>错误</th><th>后果</th><th>修复</th></tr></thead><tbody><tr><td>在 <code>RUN</code> 中使用 <code>apt-get upgrade</code></td><td>镜像不可复现</td><td>避免升级系统包</td></tr><tr><td>敏感信息写入 Dockerfile</td><td>密码泄露</td><td>用 <code>--secret</code> 或构建参数</td></tr><tr><td>未清理包管理缓存</td><td>镜像体积膨胀</td><td><code>RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*</code></td></tr><tr><td><code>COPY</code> 大目录过早</td><td>层缓存失效频繁</td><td>将 <code>COPY . .</code> 放在最后</td></tr></tbody></table><hr><h3 id="高级技巧" tabindex="-1"><a class="header-anchor" href="#高级技巧"><span>高级技巧</span></a></h3><h4 id="_1-构建参数-arg" tabindex="-1"><a class="header-anchor" href="#_1-构建参数-arg"><span>1. 构建参数（<code>ARG</code>）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">ARG</span> VERSION=1.0</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> APP_VERSION=<span class="token variable">$VERSION</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> app-<span class="token variable">$VERSION</span>.jar app.jar</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构建时传参：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build --build-arg <span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token number">2.1</span> <span class="token parameter variable">-t</span> my-app <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_2-健康检查-healthcheck" tabindex="-1"><a class="header-anchor" href="#_2-健康检查-healthcheck"><span>2. 健康检查（HEALTHCHECK）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span> <span class="token property">--start-period</span><span class="token punctuation">=</span><span class="token string">5s</span> <span class="token property">--retries</span><span class="token punctuation">=</span><span class="token string">3</span></span> <span class="token operator">\\</span></span>
<span class="line">  <span class="token keyword">CMD</span> curl -f http://localhost/ || exit 1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>容器启动后定期检查服务是否健康</li><li><code>docker ps</code> 会显示状态（healthy/unhealthy）</li></ul><h4 id="_3-元数据标签-label" tabindex="-1"><a class="header-anchor" href="#_3-元数据标签-label"><span>3. 元数据标签（LABEL）</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> maintainer=<span class="token string">&quot;dev@example.com&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> version=<span class="token string">&quot;1.0&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> description=<span class="token string">&quot;My Custom App&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看标签：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> inspect my-app <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">&#39;{{json .Config.Labels}}&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="build使用dockerfile自制镜像" tabindex="-1"><a class="header-anchor" href="#build使用dockerfile自制镜像"><span>build使用Dockerfile自制镜像</span></a></h2><p><code>docker build</code> 是 Docker 中用于<strong>根据 Dockerfile 构建自定义镜像</strong>的核心命令。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token environment constant">PATH</span> <span class="token operator">|</span> URL <span class="token operator">|</span> -</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>最常用形式：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> 镜像名:标签 构建上下文路径</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>-t</code>：指定生成的镜像名称和标签（Tag），可省略标签，默认为 <code>latest</code></li><li><strong>最后的 <code>.</code></strong>：表示<strong>构建上下文（Build Context）</strong> 为当前目录</li></ul><blockquote><p>📌 <strong>重要概念</strong>： <strong>构建上下文 ≠ Dockerfile 所在目录</strong> 它是 Docker 上传到构建引擎的整个文件集合，<code>COPY</code>/<code>ADD</code> 只能访问其中的文件。</p><p>Docker 在构建镜像时，会将<strong>整个构建上下文目录</strong>上传到 Docker 引擎。 而 <code>Dockerfile</code> 要么：</p><ol><li><strong>默认位于构建上下文根目录下</strong>（文件名必须是 <code>Dockerfile</code>），或</li><li><strong>通过 <code>-f</code> 参数显式指定路径</strong>（该路径必须在构建上下文内）：</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> deploy/Dockerfile.prod <span class="token parameter variable">-t</span> my-app <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>⚠️ <strong>关键限制</strong>： <strong><code>Dockerfile</code> 不能位于构建上下文目录之外！</strong> 因为 Docker 不允许访问上下文以外的文件（安全设计）。</p></blockquote><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">命令示例</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>指定不同名称的 Dockerfile</strong></td><td style="text-align:left;"><code>docker build -f ./deploy/Dockerfile.prod -t app:prod .</code></td><td style="text-align:left;"><code>-f</code> 指定 Dockerfile 路径</td></tr><tr><td style="text-align:left;"><strong>不使用缓存（强制重新构建）</strong></td><td style="text-align:left;"><code>docker build --no-cache -t app .</code></td><td style="text-align:left;">忽略所有层缓存</td></tr><tr><td style="text-align:left;"><strong>只输出镜像 ID（静默模式）</strong></td><td style="text-align:left;"><code>docker build -q -t app .</code></td><td style="text-align:left;"><code>-q</code> = quiet，适合脚本</td></tr><tr><td style="text-align:left;"><strong>传递构建参数</strong></td><td style="text-align:left;"><code>docker build --build-arg VERSION=2.1 -t app .</code></td><td style="text-align:left;">需在 Dockerfile 中用 <code>ARG VERSION</code> 接收</td></tr><tr><td style="text-align:left;"><strong>指定平台（如 Apple Silicon 构建 Linux/amd64）</strong></td><td style="text-align:left;"><code>docker build --platform linux/amd64 -t app .</code></td><td style="text-align:left;">跨平台构建</td></tr></tbody></table>`,103)])])}const c=n(l,[["render",i]]),r=JSON.parse('{"path":"/docs/heimashangcheng/Docker/2.zidingyirongqi.html","title":"自制容器","lang":"en-US","frontmatter":{"title":"自制容器","date":"2026-1-31"},"headers":[{"level":2,"title":"自定义镜像","slug":"自定义镜像","link":"#自定义镜像","children":[{"level":3,"title":"为什么需要自定义镜像？","slug":"为什么需要自定义镜像","link":"#为什么需要自定义镜像","children":[]},{"level":3,"title":"如何自制自定义镜像？—— 核心工具：Dockerfile","slug":"如何自制自定义镜像-——-核心工具-dockerfile","link":"#如何自制自定义镜像-——-核心工具-dockerfile","children":[]}]},{"level":2,"title":"Dockerfile","slug":"dockerfile","link":"#dockerfile","children":[{"level":3,"title":"基本语法与规则","slug":"基本语法与规则","link":"#基本语法与规则","children":[]},{"level":3,"title":"示例","slug":"示例","link":"#示例","children":[]},{"level":3,"title":"核心指令详解","slug":"核心指令详解","link":"#核心指令详解","children":[]},{"level":3,"title":"多阶段构建（Multi-stage Build）","slug":"多阶段构建-multi-stage-build","link":"#多阶段构建-multi-stage-build","children":[]},{"level":3,"title":"构建与验证流程","slug":"构建与验证流程","link":"#构建与验证流程","children":[]},{"level":3,"title":"最佳实践与常见陷阱","slug":"最佳实践与常见陷阱","link":"#最佳实践与常见陷阱","children":[]},{"level":3,"title":"高级技巧","slug":"高级技巧","link":"#高级技巧","children":[]}]},{"level":2,"title":"build使用Dockerfile自制镜像","slug":"build使用dockerfile自制镜像","link":"#build使用dockerfile自制镜像","children":[]}],"git":{"createdTime":1771237270000,"updatedTime":1771237270000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马商城/Docker/2.自定义容器.md"}');export{c as comp,r as data};
