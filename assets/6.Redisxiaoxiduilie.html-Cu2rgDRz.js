import{ar as l,as as o,ax as e,aw as t,au as s,av as p,ay as c,at as i}from"./app-DXmPnZac.js";const u={};function r(d,n){const a=c("MermaidDiagram");return i(),o("div",null,[n[0]||(n[0]=e('<h2 id="消息队列" tabindex="-1"><a class="header-anchor" href="#消息队列"><span>消息队列</span></a></h2><p>针对我们先前提到的一些问题，比如<strong>异步</strong>提交任务的队列中，怎么去记录<strong>异常信息</strong>，假如后续需要去获取异步操作（两路并行执行）的<strong>结果</strong>。那该怎么办？</p><p>那么我们就可以去考虑使用<strong>消息队列</strong>了：</p><p><strong>消息队列</strong>（Message Queue）是一种<strong>异步通信机制</strong>，用于在分布式系统中实现<strong>生产者</strong>与<strong>消费者</strong>之间的解耦。它通过一个中间层（消息代理缓冲区）<strong>存储</strong>和<strong>转发</strong>消息，确保数据的可靠传递。</p><table><thead><tr><th style="text-align:left;">角色</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>生产者（Producer）</strong></td><td style="text-align:left;">负责创建并发送消息到消息队列。例如：订单服务在用户下单后发送“订单创建”事件。</td></tr><tr><td style="text-align:left;"><strong>消息队列（Message Queue / Broker）</strong></td><td style="text-align:left;">存储、管理消息的中间件，也称为<strong>消息代理</strong>（Message Broker）。负责接收来自生产者的消息，并按规则分发给消费者。</td></tr><tr><td style="text-align:left;"><strong>消费者（Consumer）</strong></td><td style="text-align:left;">从消息队列中获取消息并进行处理。例如：库存服务监听“订单创建”事件，扣减库存。</td></tr></tbody></table>',5)),t(a,{code:"graph%20LR%0A%20%20%20%20A%5B%E7%94%9F%E4%BA%A7%E8%80%85%3Cbr%3EProducer%5D%20--%3E%20B%5B%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%3Cbr%3EMessage%20Queue%5D%0A%20%20%20%20B%20--%3E%20C%5B%E6%B6%88%E8%B4%B9%E8%80%85%3Cbr%3EConsumer%5D%0A%0A%20%20%20%20style%20A%20fill%3A%234285f5%2Cstroke%3A%23333%2Cstroke-width%3A2px%0A%20%20%20%20style%20B%20fill%3A%23f8d7da%2Cstroke%3A%23dc3545%2Cstroke-width%3A2px%0A%20%20%20%20style%20C%20fill%3A%2328a745%2Cstroke%3A%23333%2Cstroke-width%3A2px%0A%0A%20%20%20%20linkStyle%20default%20stroke%3A%23333%2Cstroke-width%3A2px%0A"}),n[1]||(n[1]=e('<p>在微服务架构下，我们会使用一些成熟的组件：</p><table><thead><tr><th style="text-align:left;">产品</th><th style="text-align:left;">特点</th><th style="text-align:left;">典型用途</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>RabbitMQ</strong></td><td style="text-align:left;">可靠、灵活路由</td><td style="text-align:left;">企业级应用、任务调度</td></tr><tr><td style="text-align:left;"><strong>Kafka</strong></td><td style="text-align:left;">高吞吐、日志流</td><td style="text-align:left;">日志收集、大数据管道</td></tr><tr><td style="text-align:left;"><strong>RocketMQ</strong></td><td style="text-align:left;">高性能、金融级</td><td style="text-align:left;">电商、支付、交易系统</td></tr><tr><td style="text-align:left;"><strong>Pulsar</strong></td><td style="text-align:left;">多租户、云原生</td><td style="text-align:left;">云计算、微服务</td></tr></tbody></table><blockquote><p>真到了微服务层级，Redis提供的Redis Stream是不够用的，还是使用成熟的MQ中间件更合适（链路追踪等方面做的好得多）这里看看就行</p></blockquote><p>Redis的三种消息队列：</p><table><thead><tr><th style="text-align:left;">模型</th><th style="text-align:left;">是否持久化</th><th style="text-align:left;">是否支持消费者组</th><th style="text-align:left;">是否支持 ACK</th><th style="text-align:left;">适用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Pub/Sub</strong></td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">实时通知、广播事件</td></tr><tr><td style="text-align:left;"><strong>LIST</strong></td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">简单任务分发（允许丢失）</td></tr><tr><td style="text-align:left;"><strong>STREAM</strong></td><td style="text-align:left;">✅ 是</td><td style="text-align:left;">✅ 是</td><td style="text-align:left;">✅ 是</td><td style="text-align:left;">可靠消息队列、事件溯源</td></tr></tbody></table><h2 id="list类型的redis消息队列" tabindex="-1"><a class="header-anchor" href="#list类型的redis消息队列"><span>List类型的Redis消息队列</span></a></h2><p>List类型消息队列就是基于Redis本身提供的List<strong>双向链表</strong>实现的一个消息队列，结合Lpush以及Rpop（或者倒过来）来实现消息队列的，这里为了保证阻塞效果（阻塞/循环等待数据并提取交给消费者），会使用BRpop（<strong>阻塞</strong>泵出，当有数据时泵出，无数据时<strong>阻塞等待</strong>）获取数据/操作消息。</p><p>这样的队列支持单对单/多的消息传递，同时消息丢失无法避免（内存汰换，业务失败消息丢失）</p>',8)),t(a,{code:"graph%20LR%0A%20%20%20%20P%5B%E7%94%9F%E4%BA%A7%E8%80%85%5D%20--%3E%7CLPUSH%7C%20L(%E5%88%97%E8%A1%A8)%0A%20%20%20%20R1%5B%E6%B6%88%E8%B4%B9%E8%80%851%5D%20--%3E%7CRPOP%7C%20L%0A%20%20%20%20R2%5B%E6%B6%88%E8%B4%B9%E8%80%852%5D%20--%3E%7CRPOP%7C%20L%0A"}),n[2]||(n[2]=s("h2",{id:"pubsub类型的redis消息队列",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#pubsub类型的redis消息队列"},[s("span",null,"PubSub类型的Redis消息队列")])],-1)),n[3]||(n[3]=s("p",null,[p("这种类型的消息队列支持消费者订阅一个或多个channel，当生产者向channel发送消息，所有订阅了该channel的消费者都能获取到消息。Redission的"),s("strong",null,"RTopic"),p("就是基于该消息队列实现的，这种消息队列适用于"),s("strong",null,"广播"),p("的场景。")],-1)),n[4]||(n[4]=s("p",null,"当然，也还是无法实现消息丢失的问题。",-1)),t(a,{code:"graph%20LR%0A%20%20%20%20P%5B%E7%94%9F%E4%BA%A7%E8%80%85%5D%20--%3E%7C%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF%7C%20C1(%E9%A2%91%E9%81%93)%0A%20%20%20%20C1%20--%3E%7C%E8%AE%A2%E9%98%85%E5%B9%B6%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%7CR1%5B%E6%B6%88%E8%B4%B9%E8%80%851%5D%0A%20%20%20%20C1%20--%3E%7C%E8%AE%A2%E9%98%85%E5%B9%B6%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%7CR2%5B%E6%B6%88%E8%B4%B9%E8%80%852%5D%0A"}),n[5]||(n[5]=s("h2",{id:"stream类型的redis消息队列",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#stream类型的redis消息队列"},[s("span",null,"Stream类型的Redis消息队列")])],-1)),n[6]||(n[6]=s("p",null,"Redis中的这种消息队列是作为数据类型的，也即其可以被持久化，会将消息存储到Redis中。同时也是Redis专门为消息队列设计的一种数据类型，相比前面两个类型，其更加完整，提供了诸多MQ的基础功能，如是否阻塞等待，等待时间等。",-1)),n[7]||(n[7]=s("p",null,"stream存储生产者提供的消息（stream内的消息不会删除），多个消费者组共享消息（订阅该stream），组内将该消息分流到一个消费者（xreadgroup）将数据放到pending-list（组内共享，每组一个）中，消费者完成后xack确认已完成并从pending-list中删除该消息",-1)),t(a,{code:"graph%20LR%0A%20%20%20%20P%5B%E7%94%9F%E4%BA%A7%E8%80%85%5D%20--%3E%7CXADD%7C%20S(%E6%B5%81)%0A%20%20%20%20CG1(%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%841)%20--%3E%7CXREADGROUP%7C%20S%0A%20%20%20%20CG1%20--%3E%7C%E7%A1%AE%E8%AE%A4%E5%A4%84%E7%90%86%7C%20P%0A%20%20%20%20CG2(%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%842)%20--%3E%7CXREADGROUP%7C%20S%0A%20%20%20%20CG2%20--%3E%7C%E7%A1%AE%E8%AE%A4%E5%A4%84%E7%90%86%7C%20P%0A"}),n[8]||(n[8]=e(`<table><thead><tr><th style="text-align:left;">特性</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>持久化存储</strong></td><td style="text-align:left;">消息写入内存 + 可选持久化到磁盘（AOF/RDB），<strong>不会因客户端离线丢失</strong></td></tr><tr><td style="text-align:left;"><strong>消息 ID 自动生成</strong></td><td style="text-align:left;">每条消息有唯一 ID（如 <code>1678901234567-0</code>），支持按 ID 范围查询</td></tr><tr><td style="text-align:left;"><strong>消费者组（Consumer Groups）</strong></td><td style="text-align:left;">类似 Kafka：多个消费者分组协作消费，<strong>每条消息只被组内一个消费者处理</strong></td></tr><tr><td style="text-align:left;"><strong>ACK 机制</strong></td><td style="text-align:left;">消费者处理成功后需手动确认（<code>XACK</code>），失败可重试或进入死信队列</td></tr><tr><td style="text-align:left;"><strong>消息回溯</strong></td><td style="text-align:left;">可从任意 ID 开始读取历史消息（适合故障恢复、重放）</td></tr></tbody></table><p><strong>基本命令示例</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 1. 生产消息（自动分配ID）</span></span>
<span class="line">XADD mystream * event <span class="token string">&quot;user_login&quot;</span> user_id <span class="token number">1001</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 创建消费者组</span></span>
<span class="line">XGROUP CREATE mystream mygroup $</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 消费者读取消息（&gt; 表示只读新消息）</span></span>
<span class="line">XREADGROUP GROUP mygroup consumer1 COUNT <span class="token number">1</span> STREAMS mystream <span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 确认消息已处理</span></span>
<span class="line">XACK mystream mygroup <span class="token number">1678901234567</span>-0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与其他两种类型的区别：</p><table><thead><tr><th style="text-align:left;">模式</th><th style="text-align:left;">是否持久化</th><th style="text-align:left;">消费模型</th><th style="text-align:left;">ACK</th><th style="text-align:left;">适用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Pub/Sub</strong></td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">广播（所有订阅者）</td><td style="text-align:left;">❌</td><td style="text-align:left;">实时通知（允许丢失）</td></tr><tr><td style="text-align:left;"><strong>LIST</strong></td><td style="text-align:left;">❌ 否</td><td style="text-align:left;">点对点（竞争消费）</td><td style="text-align:left;">❌</td><td style="text-align:left;">简单任务队列</td></tr><tr><td style="text-align:left;"><strong>Stream</strong></td><td style="text-align:left;">✅ 是</td><td style="text-align:left;">消费者组 + 单播</td><td style="text-align:left;">✅</td><td style="text-align:left;"><strong>可靠消息队列、事件溯源</strong></td></tr></tbody></table><p>对于非消费组读<strong>XREAD</strong>，有几个特性：</p><ul><li>消息可回溯（消息不会删除）</li><li>一个消息可被多个消费者读取（非破坏式读取）</li><li>可以阻塞读取（比BLPOP更加完整完善）</li></ul><p>但是存在消息漏读的可能，所以Redis就提供了另外一种方式来防止这种情况的出现。</p><h2 id="redis-stream的消费者组" tabindex="-1"><a class="header-anchor" href="#redis-stream的消费者组"><span>Redis Stream的消费者组</span></a></h2><p><strong>消息分流</strong>：多个消费者分组协作消费，<strong>每条消息只被组内一个消费者处理</strong>，也即消息会分流给组内不同消费者（当然需要被多个消费者共同获取的话，加多个消费者组即可）。</p><p><strong>消息标识</strong>：<strong>消息不会被删除</strong>，消费的记录是通过组内维护一个<strong>标识</strong>来决定下一次读取的消息。</p><p><strong>消息确认</strong>：消费者在获取到消息后，消息处于pending状态，并存入pending-list中，处理完成后需要获取xack以标记为已处理，并从pending-list中删除（宕机时消息状态会被持久化到本地中而非直接丢失）</p><h3 id="从消费者组读取消息-xreadgroup" tabindex="-1"><a class="header-anchor" href="#从消费者组读取消息-xreadgroup"><span><strong>从消费者组读取消息：</strong><code>XREADGROUP</code></span></a></h3><p><strong>命令格式：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">XREADGROUP GROUP group consumer <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span> <span class="token punctuation">[</span>BLOCK milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NOACK<span class="token punctuation">]</span> STREAMS key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> ID <span class="token punctuation">[</span>ID <span class="token punctuation">..</span>.<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>参数详解：</strong></p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><code>group</code></td><td style="text-align:left;">消费组名称</td></tr><tr><td style="text-align:left;"><code>consumer</code></td><td style="text-align:left;">消费者名称，若不存在会自动创建</td></tr><tr><td style="text-align:left;"><code>COUNT count</code></td><td style="text-align:left;">最多返回的消息数量，默认为 1</td></tr><tr><td style="text-align:left;"><code>BLOCK milliseconds</code></td><td style="text-align:left;">当无新消息时阻塞等待的时间（毫秒），如 <code>BLOCK 1000</code> 表示最多等 1 秒；设为 <code>0</code> 则无限等待</td></tr><tr><td style="text-align:left;"><code>NOACK</code></td><td style="text-align:left;">如果设置，获取消息后不会标记为“已确认”，适用于无需手动 ACK 的场景（一般不用，以防万一）</td></tr><tr><td style="text-align:left;"><code>STREAMS key ...</code></td><td style="text-align:left;">要读取的 Stream 名称列表</td></tr><tr><td style="text-align:left;"><code>ID</code></td><td style="text-align:left;">从哪个消息 ID 开始读取</td></tr></tbody></table><table><thead><tr><th style="text-align:left;">ID 值</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;"><code>&quot;&gt;&quot;</code></td><td style="text-align:left;">从下一个未被消费的消息开始（推荐用于正常消费）</td></tr><tr><td style="text-align:left;"><code>&quot;0&quot;</code></td><td style="text-align:left;">从 pending-list 中第一个<strong>未确认</strong>的消息开始（常用于重试）</td></tr><tr><td style="text-align:left;"><code>&quot;1642738912000-0&quot;</code></td><td style="text-align:left;">指定某个具体的 ID 开始读取</td></tr></tbody></table><blockquote><p>💡 使用 <code>&quot;&gt;&quot;</code> 是最常见的方式，表示“给我下一条还没消费的消息”。</p></blockquote><p>读取后消息被放入组内pending-list。</p><h3 id="xack确认消息已处理" tabindex="-1"><a class="header-anchor" href="#xack确认消息已处理"><span>XACK确认消息已处理</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">XACK mystream mygroup <span class="token operator">&lt;</span>message_id<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>将指定消息从 pending list 中移除，表示已成功处理</li><li>若不 ACK，则消息会一直留在 pending list，可用于监控未完成任务</li></ul><h3 id="从pending-list中获取未确认消息" tabindex="-1"><a class="header-anchor" href="#从pending-list中获取未确认消息"><span>从pending-list中获取未确认消息</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">XPENDING mystream mygroup</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>显示当前组中所有未确认的消息</li><li>可查看哪些消费者卡住了、哪些消息需要重试</li></ul><p>后续的业务需要用到stream的消息队列的话，流程就是：</p><ol><li>生产者xadd消息到stream</li><li>消费者xreadgroup读取消息（&gt;读取最新<strong>未接收</strong>消息），消息放入组内pending-list，尝试完成相应操作</li><li>消费者xack确认消息已经完成，组内pending-list删除该消息</li><li>消费者再次读取消息（0读取<strong>未完成</strong>消息），尝试完成</li></ol><blockquote><p>MQ一般用于处理异步<strong>无需返回值</strong>业务，所以RedisStream本身不提供生产者结果获取，需要<strong>自行设计</strong>，如消费者将结果再次存入Redis的一条新的流或是String中，生产者阻塞/轮询读取存入结果。</p></blockquote><h2 id="在业务中使用stream实现异步执行" tabindex="-1"><a class="header-anchor" href="#在业务中使用stream实现异步执行"><span>在业务中使用Stream实现异步执行</span></a></h2><p>首先我们需要将消息存入消息队列，那么我们可以利用先前完成的lua脚本，在其中加入xadd完成将消息存入队列的操作：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">local</span> orderId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment">-- 库存 key</span></span>
<span class="line"><span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">&quot;seckill:stock:&quot;</span> <span class="token operator">..</span> voucherId</span>
<span class="line"><span class="token comment">-- 订单 key</span></span>
<span class="line"><span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">&quot;seckill:order:&quot;</span> <span class="token operator">..</span> voucherId</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 判断库存是否充足</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- 库存不足</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 判断用户是否重复下单</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;sismember&quot;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token comment">-- 用户重复下单</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">2</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 扣减库存</span></span>
<span class="line">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;incr&quot;</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- 将用户记录到 set 集合中</span></span>
<span class="line">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;sadd&quot;</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- 发送消息</span></span>
<span class="line">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;xadd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token string">&quot;voucherId&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在将lua放入业务中执行：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 秒杀优惠券</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">voucherId</span> 优惠券id</span>
<span class="line"> * <span class="token keyword">@return</span> 订单id</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 执行lua</span></span>
<span class="line">    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 创建订单</span></span>
<span class="line">    <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;请勿重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们在lua中完成校验并将消息放入消息队列中，那么这时候就已经完成redis层的操作了，就可以直接返回结果了。</p><p>之后就只要<strong>异步</strong>完成数据库的修改，也即将传入消息队列的数据写入数据库并完成更新即可！</p><p>而现在，我们需要一个线程去循环等待redis中消息队列的消息并执行：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 秒杀订单线程</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">SECKILL_ORDER_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 秒杀订单初始化</span></span>
<span class="line"><span class="token annotation punctuation">@PostConstruct</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">SECKILL_ORDER_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应消息队列循环处理方法：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 秒杀订单处理线程</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 获取消息队列中的订单信息 对应命令为 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> read <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">                        <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                        <span class="token comment">// 消费者组</span></span>
<span class="line">                        <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 数量</span></span>
<span class="line">                        <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">// 消费的队列</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 判断是否获取到消息</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> read<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// 成功，创建订单</span></span>
<span class="line">                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> read<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MapRecord是键值对: key : Map（map嵌套map）</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">VoucherOrder</span> order <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// ack确认 对应命令为 XACK stream.orders g1 id</span></span>
<span class="line">                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 处理pending-list中的订单</span></span>
<span class="line">                <span class="token function">handlePendingOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理pending-list中的订单</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 获取消息队列中的订单信息 对应命令为 XREADGROUP GROUP g1 c1 COUNT 1 STREAMS stream.orders 0</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> read <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">                        <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                      <span class="token comment">// 消费者组</span></span>
<span class="line">                        <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                             <span class="token comment">// 数量</span></span>
<span class="line">                        <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">// 消费的队列</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 判断是否获取到消息</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> read<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">// 无异常，则返回</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">// 成功，创建订单</span></span>
<span class="line">                <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> read<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MapRecord是键值对: S : Map（map嵌套map）</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// ack确认 对应命令为 XACK stream.orders g1 id</span></span>
<span class="line">                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span>record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理pending-list订单异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到我们就是使用这个线程来<strong>循环read</strong> Redis中的对应消息队列的数据，倘若存在数据则<strong>获取数据</strong>，消息存入<strong>pending-list</strong>并完成数据库<strong>相关操作</strong>，如果中途发生<strong>异常</strong>导致消息处理失败，就会去处理挂起的消息（<strong>pending-list</strong>中的消息），在完成相应操作后会去<strong>ack</strong>消息，将之从pending-list中取出，确认已完成。</p><p>后续如果需要去更进一步，那就需要考虑加入线程池等方面了，那么这时候对于异常的处理，以及阻塞的安排（对pending-list中消息的处理可能存在竞争）就需要额外设计了。</p><hr><h2 id="为什么在微服务中使用rabbitmq等mq-而不是直接使用redis提供的mq" tabindex="-1"><a class="header-anchor" href="#为什么在微服务中使用rabbitmq等mq-而不是直接使用redis提供的mq"><span>为什么在微服务中使用RabbitMQ等MQ，而不是直接使用Redis提供的MQ？</span></a></h2><p><strong>Redis 不是为高可靠、持久化、复杂路由的消息传递而设计的；它是一个内存数据库，消息能力只是“附带功能”。</strong> 而 RabbitMQ/Kafka 是<strong>专为消息传递场景打造的中间件</strong>，在可靠性、一致性、扩展性、运维等方面远胜 Redis。</p><table><thead><tr><th style="text-align:left;">维度</th><th style="text-align:left;"><strong>Redis（作为 MQ）</strong></th><th style="text-align:left;"><strong>RabbitMQ / Kafka（专业 MQ）</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>1. 消息可靠性</strong></td><td style="text-align:left;">❌ 弱 • <code>LIST</code>/<code>PUBSUB</code> 默认<strong>不持久化</strong> • 即使开启 AOF/RDB，仍可能丢消息（如宕机时缓冲区未刷盘）</td><td style="text-align:left;">✅ 强 • 消息默认<strong>持久化到磁盘</strong> • 支持 <strong>生产者确认（Confirm） + 消费者手动 ACK</strong> • 可配置同步刷盘（如 RocketMQ）</td></tr><tr><td style="text-align:left;"><strong>2. 消息堆积能力</strong></td><td style="text-align:left;">❌ 差 • 所有数据在内存中 → 堆积大量消息会<strong>耗尽内存</strong> • 需手动管理内存淘汰策略（如 LRU）</td><td style="text-align:left;">✅ 强 • 消息存储在<strong>磁盘</strong>，可堆积 TB 级数据 • 内存仅作缓存，不影响稳定性</td></tr><tr><td style="text-align:left;"><strong>3. 消费模型</strong></td><td style="text-align:left;">⚠️ 有限 • <code>LIST</code>：点对点，但无 ACK 机制 → 消费失败即丢失 • <code>PUB/SUB</code>：广播，但<strong>不支持持久订阅</strong>（客户端断开即丢消息） • <code>Streams</code>：较新，支持消费者组，但生态弱</td><td style="text-align:left;">✅ 完善 • 支持 <strong>点对点 + 发布/订阅</strong> • <strong>消费者组（Consumer Group）</strong> • <strong>死信队列（DLQ）</strong> • <strong>延迟队列、优先级队列</strong>等高级特性</td></tr><tr><td style="text-align:left;"><strong>4. 消息顺序</strong></td><td style="text-align:left;">⚠️ 仅单流有序 • <code>LIST</code> 或 <code>Stream</code> 单 key 内有序，但无法跨 key 保证</td><td style="text-align:left;">✅ 可控 • Kafka：分区（Partition）内严格有序 • RabbitMQ：单队列有序（需单消费者）</td></tr><tr><td style="text-align:left;"><strong>5. 运维与监控</strong></td><td style="text-align:left;">❌ 弱 • 无内置消息追踪、积压监控 • 需自行开发管理界面</td><td style="text-align:left;">✅ 强 • 提供 Web UI（如 RabbitMQ Management） • 集成 Prometheus/Grafana 监控 • 支持消息轨迹、重试、回溯</td></tr><tr><td style="text-align:left;"><strong>6. 协议与生态</strong></td><td style="text-align:left;">❌ 封闭 • 仅支持 Redis 协议 • 客户端需处理底层命令（如 <code>XREADGROUP</code>）</td><td style="text-align:left;">✅ 开放 • 标准协议（AMQP、MQTT、Kafka 协议） • 丰富客户端库（Java/Python/Go/Node.js 等） • 与 Spring Cloud Stream、Flink、Spark 等无缝集成</td></tr><tr><td style="text-align:left;"><strong>7. 高可用 &amp; 扩展</strong></td><td style="text-align:left;">⚠️ 依赖 Redis 集群 • 主从复制延迟可能导致消息不一致 • 扩容需重新分片（复杂）</td><td style="text-align:left;">✅ 原生支持 • RabbitMQ：镜像队列 / Quorum Queue • Kafka：副本机制 + 自动 Leader 选举 • 水平扩展简单</td></tr></tbody></table><p><strong>场景：订单创建后发送邮件</strong></p><ul><li>用 Redis LIST： <ul><li>订单服务 <code>LPUSH order_queue {orderId}</code></li><li>邮件服务 <code>BRPOP order_queue</code></li><li><strong>风险</strong>：邮件服务处理中宕机 → 消息永久丢失（无 ACK）</li></ul></li><li>用 RabbitMQ： <ul><li>订单服务发送消息到 <code>order.created</code> 队列</li><li>邮件服务消费后<strong>手动 ACK</strong></li><li>失败时自动重回队列或进入 DLQ → <strong>消息不丢</strong></li></ul></li></ul><p><strong>场景：高并发日志收集</strong></p><ul><li><strong>Redis</strong>：内存迅速耗尽，触发淘汰策略 → 日志<strong>丢失</strong></li><li><strong>Kafka</strong>：写入磁盘，可堆积数 TB 数据，消费者按需拉取</li></ul><p><strong>Redis 适合做 MQ 的场景（少数）</strong></p><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>轻量级任务队列</strong></td><td style="text-align:left;">如后台图片压缩、缓存预热，允许少量丢失</td></tr><tr><td style="text-align:left;"><strong>实时通知（非关键）</strong></td><td style="text-align:left;">如在线用户状态广播（用 PUB/SUB）</td></tr><tr><td style="text-align:left;"><strong>已有 Redis，不想引入新组件</strong></td><td style="text-align:left;">快速原型验证（PoC），但<strong>不建议用于生产核心链路</strong></td></tr></tbody></table><p>简单一句总结，Redis毕竟还是专门用于做<strong>缓存</strong>的内存数据库，Redis Streams只能算是添头，面对高并发场景还是选择专门的MQ更好。</p><h2 id="什么场景使用rpc-什么场景使用mq-区别在哪" tabindex="-1"><a class="header-anchor" href="#什么场景使用rpc-什么场景使用mq-区别在哪"><span>什么场景使用RPC？什么场景使用MQ？区别在哪？</span></a></h2><p>RPC（远程过程调用）和 MQ（消息队列）都是服务间通信的手段，但它们的<strong>适用场景、设计理念和系统影响截然不同</strong>。</p><blockquote><p><strong>✅ 一句话总结区别</strong><strong>RPC 是“同步调用”，追求</strong>即时响应**； MQ 是“异步通信”，追求<strong>解耦与可靠传递</strong>。**</p></blockquote><blockquote><p>💡 <strong>黄金法则</strong>：</p><ul><li><strong>要结果 → 用 RPC</strong></li><li><strong>发事件 → 用 MQ</strong></li></ul></blockquote><p><strong>一、RPC（Remote Procedure Call）—— 同步、强依赖</strong></p><p><strong>🔧 典型代表</strong></p><ul><li>gRPC、Dubbo、Spring Cloud OpenFeign、Thrift</li></ul><p><strong>🎯 核心特点</strong></p><table><thead><tr><th style="text-align:left;">特性</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>同步阻塞</strong></td><td style="text-align:left;">调用方等待被调用方返回结果（如 HTTP 请求）</td></tr><tr><td style="text-align:left;"><strong>实时性高</strong></td><td style="text-align:left;">适合需要立即得到结果的场景</td></tr><tr><td style="text-align:left;"><strong>强耦合</strong></td><td style="text-align:left;">调用方必须知道被调用方的地址、接口、协议</td></tr><tr><td style="text-align:left;"><strong>失败即中断</strong></td><td style="text-align:left;">被调用方宕机 → 调用方直接报错</td></tr></tbody></table><p><strong>✅ 适用场景（用 RPC）</strong></p><ol><li>需要立即返回结果 <ul><li>用户登录：调用认证服务验证密码 → 立即返回 token</li><li>查询商品详情：前端请求 → 聚合服务调用商品、库存、评价服务 → 拼装后返回</li></ul></li><li>事务性强的操作 <ul><li>支付前检查余额（必须同步确认）</li></ul></li><li>低延迟要求 <ul><li>实时风控、实时推荐</li></ul></li></ol><p><strong>❌ 不适用场景</strong></p><ul><li>被调用方处理慢（如生成报表）</li><li>被调用方不稳定（会导致调用方雪崩）</li><li>不关心结果（如发通知）</li></ul><hr><p><strong>二、MQ（Message Queue）—— 异步、弱依赖</strong></p><p><strong>🔧 典型代表</strong></p><ul><li>RabbitMQ、Kafka、RocketMQ</li></ul><p><strong>🎯 核心特点</strong></p><table><thead><tr><th style="text-align:left;">特性</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>异步非阻塞</strong></td><td style="text-align:left;">发完消息就返回，不等消费者处理</td></tr><tr><td style="text-align:left;"><strong>解耦</strong></td><td style="text-align:left;">生产者不知道消费者是否存在</td></tr><tr><td style="text-align:left;"><strong>削峰填谷</strong></td><td style="text-align:left;">高峰期消息堆积，消费者按能力消费</td></tr><tr><td style="text-align:left;"><strong>最终一致性</strong></td><td style="text-align:left;">不保证实时，但保证最终会处理</td></tr></tbody></table><p><strong>✅ 适用场景（用 MQ）</strong></p><ol><li>不需要立即响应 <ul><li>用户注册 → 发欢迎邮件/短信（用户不关心是否成功）</li></ul></li><li>流量削峰 <ul><li>秒杀下单 → 先入队列，订单服务匀速处理</li></ul></li><li>广播通知 <ul><li>商品价格变更 → 通知搜索、推荐、缓存服务更新</li></ul></li><li>跨系统集成 <ul><li>订单系统 → 财务系统（不同团队、不同技术栈）</li></ul></li><li>日志/监控数据收集 <ul><li>应用埋点 → Kafka → Flink 实时分析</li></ul></li></ol><p><strong>❌ 不适用场景</strong></p><ul><li>需要返回计算结果（如“计算用户积分”）</li><li>强一致性要求（如银行转账）</li></ul><hr><p><strong>三、对比表格：RPC vs MQ</strong></p><table><thead><tr><th style="text-align:left;">维度</th><th style="text-align:left;"><strong>RPC</strong></th><th style="text-align:left;"><strong>MQ</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>通信模式</strong></td><td style="text-align:left;">同步（请求-响应）</td><td style="text-align:left;">异步（发布-订阅 / 点对点）</td></tr><tr><td style="text-align:left;"><strong>耦合度</strong></td><td style="text-align:left;">高（需知道对方接口）</td><td style="text-align:left;">低（只需约定消息格式）</td></tr><tr><td style="text-align:left;"><strong>可靠性</strong></td><td style="text-align:left;">依赖网络和对方可用性</td><td style="text-align:left;">消息持久化，可重试，不丢</td></tr><tr><td style="text-align:left;"><strong>延迟</strong></td><td style="text-align:left;">低（ms 级）</td><td style="text-align:left;">较高（可能秒级，取决于消费速度）</td></tr><tr><td style="text-align:left;"><strong>吞吐量</strong></td><td style="text-align:left;">受限于被调用方处理能力</td><td style="text-align:left;">高（生产快，消费可慢）</td></tr><tr><td style="text-align:left;"><strong>错误处理</strong></td><td style="text-align:left;">直接抛异常</td><td style="text-align:left;">可重试、死信队列、人工干预</td></tr><tr><td style="text-align:left;"><strong>典型协议</strong></td><td style="text-align:left;">HTTP/2, TCP, Dubbo 协议</td><td style="text-align:left;">AMQP, Kafka 协议, 自定义</td></tr><tr><td style="text-align:left;"><strong>系统复杂度</strong></td><td style="text-align:left;">低（像本地调用）</td><td style="text-align:left;">高（需管理消息格式、幂等、积压）</td></tr></tbody></table><p><strong>✅ 总结</strong></p><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">推荐</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>查数据、做决策、强一致性</strong></td><td style="text-align:left;">✅ RPC</td></tr><tr><td style="text-align:left;"><strong>发通知、记日志、削峰、广播</strong></td><td style="text-align:left;">✅ MQ</td></tr><tr><td style="text-align:left;"><strong>核心交易链路</strong></td><td style="text-align:left;">RPC（同步校验） + MQ（异步后续）</td></tr><tr><td style="text-align:left;"><strong>跨团队/跨语言系统集成</strong></td><td style="text-align:left;">优先 MQ（解耦）</td></tr></tbody></table>`,81)),t(a,{code:"graph%20TD%0A%20%20%20%20A%5B%E9%9C%80%E8%A6%81%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E6%9C%8D%E5%8A%A1%EF%BC%9F%5D%20--%3E%20B%7B%E9%9C%80%E8%A6%81%E7%AB%8B%E5%8D%B3%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E5%90%97%EF%BC%9F%7D%0A%20%20%20%20B%20--%3E%7C%E6%98%AF%7C%20C%5B%E7%94%A8%20RPC%5D%0A%20%20%20%20B%20--%3E%7C%E5%90%A6%7C%20D%7B%E6%93%8D%E4%BD%9C%E6%98%AF%E5%90%A6%E5%85%B3%E9%94%AE%EF%BC%9F%3Cbr%3E%EF%BC%88%E5%A4%B1%E8%B4%A5%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%9A%E5%8A%A1%E4%B8%AD%E6%96%AD%EF%BC%89%7D%0A%20%20%20%20D%20--%3E%7C%E6%98%AF%7C%20E%5B%E8%80%83%E8%99%91%20RPC%20%2B%20%E9%87%8D%E8%AF%95%20%E6%88%96%20Saga%20%E4%BA%8B%E5%8A%A1%5D%0A%20%20%20%20D%20--%3E%7C%E5%90%A6%7C%20F%5B%E7%94%A8%20MQ%5D%0A"}),n[9]||(n[9]=e(`<h2 id="新开线程内调用bean对象的动态代理-其的增强会生效吗" tabindex="-1"><a class="header-anchor" href="#新开线程内调用bean对象的动态代理-其的增强会生效吗"><span>新开线程内调用Bean对象的动态代理，其的增强会生效吗？</span></a></h2><p>是可以的，但是比如<code>@Transactional</code>就是可以在<strong>线程内部</strong>正常开启的，但是由于和外部线程不是一个上下文，事务是无法传播到外部合成一个的。</p><h2 id="stringredistemplate的opsforstream的相关操作" tabindex="-1"><a class="header-anchor" href="#stringredistemplate的opsforstream的相关操作"><span>StringRedisTemplate的opsForStream的相关操作</span></a></h2><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 获取消息队列中的订单信息 对应命令为 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> read <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">                        <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                      	<span class="token comment">// 消费者组</span></span>
<span class="line">                        <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 数量</span></span>
<span class="line">                        <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token comment">// 消费的队列</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">功能</th><th style="text-align:left;">方法</th></tr></thead><tbody><tr><td style="text-align:left;">写入消息</td><td style="text-align:left;"><code>add(StreamRecords)</code></td></tr><tr><td style="text-align:left;">消费者组读取</td><td style="text-align:left;"><code>read(Consumer, StreamReadOptions, StreamOffset...)</code></td></tr><tr><td style="text-align:left;">普通读取</td><td style="text-align:left;"><code>read(StreamReadOptions, StreamOffset...)</code></td></tr><tr><td style="text-align:left;">确认消息</td><td style="text-align:left;"><code>acknowledge(String group, Record)</code></td></tr><tr><td style="text-align:left;">查看 Pending</td><td style="text-align:left;"><code>pending(String key, String group)</code></td></tr><tr><td style="text-align:left;">转移消息</td><td style="text-align:left;"><code>claim(...)</code></td></tr><tr><td style="text-align:left;">创建组</td><td style="text-align:left;"><code>createGroup(...)</code></td></tr><tr><td style="text-align:left;">删除消息</td><td style="text-align:left;"><code>delete(...)</code></td></tr><tr><td style="text-align:left;">裁剪 Stream</td><td style="text-align:left;"><code>trim(...)</code></td></tr></tbody></table><h3 id="_1-写入消息-xadd" tabindex="-1"><a class="header-anchor" href="#_1-写入消息-xadd"><span><strong>1.</strong> <strong>写入消息（XADD）</strong></span></a></h3><p><strong>方法：</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> id <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">StreamRecords</span><span class="token punctuation">.</span><span class="token function">newRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">ofObject</span><span class="token punctuation">(</span>orderMap<span class="token punctuation">)</span>           <span class="token comment">// 消息内容（Map&lt;String, ?&gt;）</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">withStreamKey</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>更精细控制：</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> id <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">StreamRecords</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">ofEntries</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;99.9&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ 支持指定 ID（如 <code>&quot;*&quot;</code> 自动生成）、设置 <code>MAXLEN</code> 自动裁剪：</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">streamOps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">StreamRecords</span><span class="token punctuation">.</span><span class="token function">newRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">ofObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">withStreamKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">withMaxLen</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment">// XADD ... MAXLEN ～ 1000</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-读取消息-xread-xreadgroup" tabindex="-1"><a class="header-anchor" href="#_2-读取消息-xread-xreadgroup"><span><strong>2.</strong> <strong>读取消息（XREAD / XREADGROUP）</strong></span></a></h3><p><strong>(1) 普通读取（无消费者组）</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">fromStart</span><span class="token punctuation">(</span><span class="token string">&quot;mystream&quot;</span><span class="token punctuation">)</span>   <span class="token comment">// 从开头读</span></span>
<span class="line">    <span class="token comment">// 或 StreamOffset.latest(&quot;mystream&quot;)  // 从最新</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>(2)</strong> <strong>消费者组读取</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> read <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token comment">// 消费者组 g1，消费者 c1</span></span>
<span class="line">    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 相当于 &quot;&gt;&quot;</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>🔍 <code>ReadOffset.lastConsumed()</code> 对应 Redis 的 <code>&quot;&gt;&quot;</code>，表示“读取下一个未消费的消息”。</p></blockquote><p><strong>(3) 从 Pending List 重试（对应 ID = &quot;0&quot;）</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pending <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 从 pending 开始</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-确认消息-xack" tabindex="-1"><a class="header-anchor" href="#_3-确认消息-xack"><span><strong>3.</strong> <strong>确认消息（XACK）</strong></span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Long</span> ackCount <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span>     <span class="token comment">// Stream key</span></span>
<span class="line">    <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span>                <span class="token comment">// 消费者组</span></span>
<span class="line">    <span class="token string">&quot;1642738912000-0&quot;</span>    <span class="token comment">// 消息 ID（可传多个）</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 或从 Record 中直接 ACK</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>read<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> read<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    streamOps<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动提取 key + id</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>✅ 推荐使用 <code>acknowledge(group, record)</code>，更安全。</p></blockquote><hr><h3 id="_4-查看-pending-信息-xpending" tabindex="-1"><a class="header-anchor" href="#_4-查看-pending-信息-xpending"><span><strong>4.</strong> <strong>查看 Pending 信息（XPENDING）</strong></span></a></h3><p><strong>(1) 获取组级别统计</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">PendingMessagesSummary</span> pendingSummary <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">pending</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;g1&quot;</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Total pending: &quot;</span> <span class="token operator">+</span> pendingSummary<span class="token punctuation">.</span><span class="token function">getTotalPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Earliest ID: &quot;</span> <span class="token operator">+</span> pendingSummary<span class="token punctuation">.</span><span class="token function">getEarliestMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>(2) 获取具体 Pending 消息详情（含消费者、重试次数）</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PendingMessages</span><span class="token punctuation">&gt;</span></span> pendingDetails <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">pending</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 可指定消费者</span></span>
<span class="line">    <span class="token class-name">Range</span><span class="token punctuation">.</span><span class="token function">unbounded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// ID 范围，如 Range.closed(&quot;0&quot;, &quot;+&quot;)</span></span>
<span class="line">    <span class="token number">10</span>                          <span class="token comment">// 最多返回条数</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>返回的 <code>PendingMessages</code> 包含：</p><ul><li><code>getId()</code></li><li><code>getConsumerName()</code></li><li><code>getElapsedTimeSinceLastDelivery()</code>（毫秒）</li><li><code>getDeliveryCount()</code></li></ul></blockquote><hr><h3 id="_5-转移消息所有权-xclaim" tabindex="-1"><a class="header-anchor" href="#_5-转移消息所有权-xclaim"><span><strong>5.</strong> <strong>转移消息所有权（XCLAIM）</strong></span></a></h3><p>用于将长时间未处理的 Pending 消息转移给其他消费者（实现“死信处理”）：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> claimed <span class="token operator">=</span> streamOps<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;new-consumer&quot;</span><span class="token punctuation">,</span>             <span class="token comment">// 新消费者</span></span>
<span class="line">    <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// min-idle-time：至少空闲 5 分钟才转移</span></span>
<span class="line">    <span class="token string">&quot;1642738912000-0&quot;</span>           <span class="token comment">// 消息 ID</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>⚠️ 通常配合 <code>XPENDING</code> 使用：先查出高 <code>deliveryCount</code> 的消息，再 <code>XCLAIM</code> 转移。</p></blockquote><hr><h3 id="_6-创建-删除消费者组-xgroup-create-destroy" tabindex="-1"><a class="header-anchor" href="#_6-创建-删除消费者组-xgroup-create-destroy"><span><strong>6.</strong> <strong>创建/删除消费者组（XGROUP CREATE / DESTROY）</strong></span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 创建消费者组（从最新开始）</span></span>
<span class="line">streamOps<span class="token punctuation">.</span><span class="token function">createGroup</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 从开头创建</span></span>
<span class="line">streamOps<span class="token punctuation">.</span><span class="token function">createGroup</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 删除消费者组</span></span>
<span class="line">streamOps<span class="token punctuation">.</span><span class="token function">destroyGroup</span><span class="token punctuation">(</span><span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>💡 如果组已存在，<code>createGroup</code> 会抛异常。可先用 <code>XINFO GROUPS</code> 检查（但 Spring Data Redis 未直接暴露）。</p></blockquote><hr><h3 id="_7-其他实用操作" tabindex="-1"><a class="header-anchor" href="#_7-其他实用操作"><span><strong>7.</strong> <strong>其他实用操作</strong></span></a></h3><table><thead><tr><th style="text-align:left;">操作</th><th style="text-align:left;">方法</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>删除消息</strong></td><td style="text-align:left;"><code>streamOps.delete(&quot;stream.orders&quot;, &quot;id1&quot;, &quot;id2&quot;)</code></td><td style="text-align:left;">对应 <code>XDEL</code></td></tr><tr><td style="text-align:left;"><strong>裁剪 Stream</strong></td><td style="text-align:left;"><code>streamOps.trim(&quot;stream.orders&quot;, 1000)</code></td><td style="text-align:left;">保留最近 1000 条（<code>XTRIM MAXLEN ～ 1000</code>）</td></tr><tr><td style="text-align:left;"><strong>获取长度</strong></td><td style="text-align:left;"><code>streamOps.size(&quot;stream.orders&quot;)</code></td><td style="text-align:left;">对应 <code>XLEN</code></td></tr><tr><td style="text-align:left;"><strong>读取范围</strong></td><td style="text-align:left;"><code>streamOps.range(&quot;stream.orders&quot;, Range.unbounded())</code></td><td style="text-align:left;">对应 <code>XRANGE</code></td></tr></tbody></table>`,44))])}const g=l(u,[["render",r]]),m=JSON.parse('{"path":"/docs/heimadianping/yewusheji/6.Redisxiaoxiduilie.html","title":"Redis消息队列","lang":"en-US","frontmatter":{"title":"Redis消息队列","date":"2025-1-18"},"headers":[{"level":2,"title":"消息队列","slug":"消息队列","link":"#消息队列","children":[]},{"level":2,"title":"List类型的Redis消息队列","slug":"list类型的redis消息队列","link":"#list类型的redis消息队列","children":[]},{"level":2,"title":"PubSub类型的Redis消息队列","slug":"pubsub类型的redis消息队列","link":"#pubsub类型的redis消息队列","children":[]},{"level":2,"title":"Stream类型的Redis消息队列","slug":"stream类型的redis消息队列","link":"#stream类型的redis消息队列","children":[]},{"level":2,"title":"Redis Stream的消费者组","slug":"redis-stream的消费者组","link":"#redis-stream的消费者组","children":[{"level":3,"title":"从消费者组读取消息：XREADGROUP","slug":"从消费者组读取消息-xreadgroup","link":"#从消费者组读取消息-xreadgroup","children":[]},{"level":3,"title":"XACK确认消息已处理","slug":"xack确认消息已处理","link":"#xack确认消息已处理","children":[]},{"level":3,"title":"从pending-list中获取未确认消息","slug":"从pending-list中获取未确认消息","link":"#从pending-list中获取未确认消息","children":[]}]},{"level":2,"title":"在业务中使用Stream实现异步执行","slug":"在业务中使用stream实现异步执行","link":"#在业务中使用stream实现异步执行","children":[]},{"level":2,"title":"为什么在微服务中使用RabbitMQ等MQ，而不是直接使用Redis提供的MQ？","slug":"为什么在微服务中使用rabbitmq等mq-而不是直接使用redis提供的mq","link":"#为什么在微服务中使用rabbitmq等mq-而不是直接使用redis提供的mq","children":[]},{"level":2,"title":"什么场景使用RPC？什么场景使用MQ？区别在哪？","slug":"什么场景使用rpc-什么场景使用mq-区别在哪","link":"#什么场景使用rpc-什么场景使用mq-区别在哪","children":[]},{"level":2,"title":"新开线程内调用Bean对象的动态代理，其的增强会生效吗？","slug":"新开线程内调用bean对象的动态代理-其的增强会生效吗","link":"#新开线程内调用bean对象的动态代理-其的增强会生效吗","children":[]},{"level":2,"title":"StringRedisTemplate的opsForStream的相关操作","slug":"stringredistemplate的opsforstream的相关操作","link":"#stringredistemplate的opsforstream的相关操作","children":[{"level":3,"title":"1. 写入消息（XADD）","slug":"_1-写入消息-xadd","link":"#_1-写入消息-xadd","children":[]},{"level":3,"title":"2. 读取消息（XREAD / XREADGROUP）","slug":"_2-读取消息-xread-xreadgroup","link":"#_2-读取消息-xread-xreadgroup","children":[]},{"level":3,"title":"3. 确认消息（XACK）","slug":"_3-确认消息-xack","link":"#_3-确认消息-xack","children":[]},{"level":3,"title":"4. 查看 Pending 信息（XPENDING）","slug":"_4-查看-pending-信息-xpending","link":"#_4-查看-pending-信息-xpending","children":[]},{"level":3,"title":"5. 转移消息所有权（XCLAIM）","slug":"_5-转移消息所有权-xclaim","link":"#_5-转移消息所有权-xclaim","children":[]},{"level":3,"title":"6. 创建/删除消费者组（XGROUP CREATE / DESTROY）","slug":"_6-创建-删除消费者组-xgroup-create-destroy","link":"#_6-创建-删除消费者组-xgroup-create-destroy","children":[]},{"level":3,"title":"7. 其他实用操作","slug":"_7-其他实用操作","link":"#_7-其他实用操作","children":[]}]}],"git":{"createdTime":1771338216000,"updatedTime":1771338216000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马点评/业务设计/6.Redis消息队列.md"}');export{g as comp,m as data};
