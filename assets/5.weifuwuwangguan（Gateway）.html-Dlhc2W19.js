import{_ as p,c as l,e as s,a,b as e,d as i,r as c,o}from"./app-Cm4IjFjh.js";const u={},r={href:"https://docs.spring.io/spring-cloud-gateway/docs/3.1.9/reference/html/",target:"_blank",rel:"noopener noreferrer"};function d(k,n){const t=c("ExternalLinkIcon");return o(),l("div",null,[n[2]||(n[2]=s(`<p>ä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´æ—…ç¨‹ï¼š <strong>Client â†’ Nginxï¼ˆåå‘ä»£ç†ï¼‰ â†’ Gatewayï¼ˆè·¯ç”±+è¿‡æ»¤ï¼‰ â†’ Nacosï¼ˆæœåŠ¡å‘ç°ï¼‰ â†’ LoadBalancerï¼ˆé€‰å®ä¾‹ï¼‰ â†’ ç›®æ ‡æœåŠ¡ â†’ ï¼ˆå¯èƒ½åµŒå¥—è°ƒç”¨ï¼‰ â†’ å“åº”åŸè·¯è¿”å›</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[Client]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[Nginx åå‘ä»£ç†]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[Spring Cloud Gateway] â†â†’ [Nacos (æ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ)]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[LoadBalancer é€‰æ‹©å®ä¾‹]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[ç›®æ ‡å¾®æœåŠ¡ï¼ˆå¦‚ order-serviceï¼‰]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[å¯èƒ½è°ƒç”¨å…¶ä»–å¾®æœåŠ¡ï¼ˆé€šè¿‡ OpenFeignï¼‰]</span>
<span class="line">   â”‚</span>
<span class="line">   â–¼</span>
<span class="line">[è¿”å›å“åº” â†’ Gateway â†’ Client]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ¶‰åŠçš„ç»„ä»¶ï¼š</p><table><thead><tr><th style="text-align:left;">ç»„ä»¶</th><th style="text-align:left;">è§’è‰²</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Nacos</strong></td><td style="text-align:left;">æœåŠ¡æ³¨å†Œå‘ç° + é…ç½®ä¸­å¿ƒï¼ˆåŠ¨æ€æ›´æ–°è·¯ç”±ï¼‰</td></tr><tr><td style="text-align:left;"><strong>OpenFeign</strong></td><td style="text-align:left;">æœåŠ¡é—´å£°æ˜å¼è°ƒç”¨</td></tr><tr><td style="text-align:left;"><strong>Spring Cloud Gateway</strong></td><td style="text-align:left;">API ç½‘å…³ï¼Œè·¯ç”± + è¿‡æ»¤ + åè®®è½¬æ¢</td></tr><tr><td style="text-align:left;"><strong>Spring Cloud LoadBalancer</strong></td><td style="text-align:left;">æ›¿ä»£ Ribbonï¼Œå®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡</td></tr><tr><td style="text-align:left;"><strong>Seata</strong></td><td style="text-align:left;">åˆ†å¸ƒå¼äº‹åŠ¡</td></tr><tr><td style="text-align:left;"><strong>Resilience4j / Sentinel</strong></td><td style="text-align:left;">ç†”æ–­ã€é™çº§ã€é™æµ</td></tr><tr><td style="text-align:left;"><strong>Sleuth + Zipkin</strong></td><td style="text-align:left;">åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª</td></tr></tbody></table></blockquote><h2 id="springcloud-gateway" tabindex="-1"><a class="header-anchor" href="#springcloud-gateway"><span>Springcloud Gateway</span></a></h2>`,4)),a("p",null,[n[1]||(n[1]=e("è¯´æ˜æ–‡æ¡£ï¼š",-1)),a("a",r,[n[0]||(n[0]=e("Spring Cloud Gateway",-1)),i(t)])]),n[3]||(n[3]=s(`<p><strong>Spring Cloud Gateway</strong> æ˜¯ Spring Cloud å®˜æ–¹æ¨å‡ºçš„<strong>æ–°ä¸€ä»£ API ç½‘å…³</strong>ï¼Œç”¨äºæ›¿ä»£ Netflix Zuulï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼‰ã€‚å®ƒåŸºäº <strong>Project Reactor + WebFlux + Netty</strong> æ„å»ºï¼Œæ˜¯ä¸€ä¸ª<strong>é«˜æ€§èƒ½ã€å“åº”å¼ã€éé˜»å¡</strong>çš„ç½‘å…³æ¡†æ¶ã€‚</p><blockquote><p>ğŸ¯ <strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼šä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ç»Ÿä¸€å…¥å£ï¼Œå®ç° <strong>è·¯ç”±è½¬å‘ã€å®‰å…¨æ§åˆ¶ã€æµé‡æ²»ç†ã€å¯è§‚æµ‹æ€§</strong> ç­‰èƒ½åŠ›ã€‚</p></blockquote><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹ç—›ç‚¹ï¼š</p><ul><li>æ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹åœ°å€ï¼Œå®¢æˆ·ç«¯éœ€è®°ä½å¤šä¸ª URL</li><li>è·¨åŸŸã€è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰é€»è¾‘é‡å¤ç¼–å†™</li><li>æœåŠ¡åŠ¨æ€æ‰©ç¼©å®¹ï¼ŒIP ä¸å›ºå®š</li><li>å¤–éƒ¨ç›´æ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼Œå­˜åœ¨å®‰å…¨é£é™©</li></ul><p>âœ… <strong>ç½‘å…³çš„ä½œç”¨</strong>ï¼š</p><ul><li><strong>ç»Ÿä¸€å…¥å£</strong>ï¼šæ‰€æœ‰è¯·æ±‚å…ˆç»è¿‡ç½‘å…³</li><li><strong>éšè—å†…éƒ¨ç»†èŠ‚</strong>ï¼šå®¢æˆ·ç«¯åªä¸ç½‘å…³äº¤äº’</li><li><strong>æ¨ªåˆ‡å…³æ³¨ç‚¹é›†ä¸­å¤„ç†</strong>ï¼šè®¤è¯ã€é™æµã€æ—¥å¿—ã€ç›‘æ§ç­‰</li></ul><h3 id="å…³é”®å†…å®¹" tabindex="-1"><a class="header-anchor" href="#å…³é”®å†…å®¹"><span>å…³é”®å†…å®¹</span></a></h3><h4 id="_1-route-è·¯ç”±" tabindex="-1"><a class="header-anchor" href="#_1-route-è·¯ç”±"><span><strong>1.Routeï¼ˆè·¯ç”±ï¼‰</strong></span></a></h4><ul><li><p>ç½‘å…³çš„åŸºæœ¬æ„å»ºå—</p></li><li><p>åŒ…å«ï¼šIDã€ç›®æ ‡ URIã€æ–­è¨€é›†åˆã€è¿‡æ»¤å™¨é›†åˆ</p></li><li><p>ç¤ºä¾‹ï¼š</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># å”¯ä¸€è§„åˆ™idï¼Œè‡ªå®šä¹‰å³å¯</span></span>
<span class="line">    <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service <span class="token comment"># ç›®æ ‡å¾®æœåŠ¡å®ä¾‹åç§°ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡</span></span>
<span class="line">    <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># æ–­è¨€ï¼Œä¼šæˆªå–ä»¥ä¸‹è·¯å¾„å‘ç»™è§„åˆ™æŒ‡å®šçš„å¾®æœåŠ¡å®ä¾‹</span></span>
<span class="line">      <span class="token punctuation">-</span> Path=/api/user/<span class="token important">**</span></span>
<span class="line">    <span class="token key atrule">filters</span><span class="token punctuation">:</span> <span class="token comment"># è¿‡æ»¤å™¨ï¼Œå¯å¯¹ä¼ å…¥è·¯å¾„ä½œé‡å†™ç­‰æ“ä½œï¼Œå¤„ç†å®Œæˆåå‘é€ç»™æŒ‡å®šå®ä¾‹</span></span>
<span class="line">      <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>idéšæ„å³å¯ã€‚</p><p>è¿™é‡Œuriçš„ <code>user-service</code> <strong>å°±æ˜¯ Nacosï¼ˆæˆ–å…¶ä»–æ³¨å†Œä¸­å¿ƒï¼‰ä¸­æ³¨å†Œçš„æœåŠ¡åç§°</strong>ï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡å¾®æœåŠ¡åœ¨ <code>application.yml</code> ä¸­é…ç½®çš„ï¼š</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line"> <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service   <span class="token comment"># â† è¿™ä¸ªåå­—ï¼</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>lb</code> æ˜¯ <strong>LoadBalancer</strong> çš„ç¼©å†™</p></li><li><p>å®ƒå‘Šè¯‰ Spring Cloud Gatewayï¼š</p><p>â€œä¸è¦ç›´æ¥è¿æ¥ä¸€ä¸ªå›ºå®š IPï¼Œè€Œæ˜¯å»æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰æŸ¥æ‰¾åä¸º <code>user-service</code> çš„æ‰€æœ‰å®ä¾‹ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªæ¥è½¬å‘è¯·æ±‚ã€‚â€</p></li></ul><p><strong>æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</strong></p><ol><li><p>Gateway æ”¶åˆ°è¯·æ±‚ï¼š<code>GET /api/user/123</code></p></li><li><p>åŒ¹é…åˆ°è·¯ç”± <code>Path=/api/user/**</code></p></li><li><p>çœ‹åˆ° <code>uri: lb://user-service</code></p></li><li><p>å‘ Nacos æŸ¥è¯¢ï¼šæœ‰å“ªäº›å®ä¾‹æ³¨å†Œäº† <code>spring.application.name = user-service </code></p><ul><li>Nacos è¿”å›ï¼š<code>[192.168.1.10:8080, 192.168.1.11:8080]</code></li></ul></li><li><p>Gateway ä½¿ç”¨ <strong>Spring Cloud LoadBalancer</strong>ï¼ˆé»˜è®¤è½®è¯¢ï¼‰é€‰æ‹©ä¸€ä¸ªå®ä¾‹ï¼Œæ¯”å¦‚ <code>192.168.1.10:8080</code></p></li><li><p>è½¬å‘è¯·æ±‚åˆ°ï¼š<code>http://192.168.1.10:8080/user/123</code>ï¼ˆæ³¨æ„è·¯å¾„å·²è¢« <code>StripPrefix=1</code> å»æ‰ <code>/api</code>ï¼‰</p></li></ol></blockquote><h4 id="_2-predicate-æ–­è¨€" tabindex="-1"><a class="header-anchor" href="#_2-predicate-æ–­è¨€"><span><strong>2.Predicateï¼ˆæ–­è¨€ï¼‰</strong></span></a></h4><ul><li>å†³å®šè¯·æ±‚æ˜¯å¦åŒ¹é…æŸæ¡è·¯ç”±</li><li>å†…ç½®å¤šç§æ–­è¨€ï¼š <ul><li><code>Path=/api/**</code></li><li><code>Method=GET</code></li><li><code>Header=X-Token, \\d+</code></li><li><code>Query=username, abc</code></li><li><code>Host=*.example.com</code></li><li><code>After=2026-01-01T00:00:00Z</code></li></ul></li></ul><h4 id="_3-filter-è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#_3-filter-è¿‡æ»¤å™¨"><span><strong>3.Filterï¼ˆè¿‡æ»¤å™¨ï¼‰</strong></span></a></h4><ul><li>åœ¨è¯·æ±‚è½¬å‘å‰åæ‰§è¡Œé€»è¾‘</li><li>åˆ†ä¸¤ç±»ï¼š <ul><li><strong>GatewayFilter</strong>ï¼šä½œç”¨äºå•ä¸ªè·¯ç”±</li><li><strong>GlobalFilter</strong>ï¼šä½œç”¨äºæ‰€æœ‰è·¯ç”±</li></ul></li></ul><p><strong>å¸¸è§è¿‡æ»¤å™¨ï¼š</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>AddRequestHeader</code></td><td style="text-align:left;">æ·»åŠ è¯·æ±‚å¤´</td></tr><tr><td style="text-align:left;"><code>StripPrefix</code></td><td style="text-align:left;">å»æ‰è·¯å¾„å‰ç¼€</td></tr><tr><td style="text-align:left;"><code>RewritePath</code></td><td style="text-align:left;">é‡å†™è·¯å¾„</td></tr><tr><td style="text-align:left;"><code>RequestRateLimiter</code></td><td style="text-align:left;">é™æµï¼ˆéœ€ Redisï¼‰</td></tr><tr><td style="text-align:left;"><code>TokenRelay</code></td><td style="text-align:left;">é€ä¼  OAuth2 Token</td></tr></tbody></table><h3 id="å¼•å…¥ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#å¼•å…¥ä¾èµ–"><span>å¼•å…¥ä¾èµ–</span></a></h3><p>å¼•å…¥Gatewayï¼Œnacosä»¥åŠloadbalancerï¼š</p><div class="language-XML line-numbers-mode" data-highlighter="prismjs" data-ext="XML" data-title="XML"><pre><code><span class="line">    &lt;dependencies&gt;</span>
<span class="line">        &lt;!--common--&gt;</span>
<span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;com.heima&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;hm-common&lt;/artifactId&gt;</span>
<span class="line">            &lt;version&gt;1.0.0&lt;/version&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line">        &lt;!--ç½‘å…³--&gt;</span>
<span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line">        &lt;!--nacos discovery--&gt;</span>
<span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line">        &lt;!--è´Ÿè½½å‡è¡¡--&gt;</span>
<span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line">    &lt;/dependencies&gt;</span>
<span class="line">    &lt;build&gt;</span>
<span class="line">        &lt;finalName&gt;\${project.artifactId}&lt;/finalName&gt;</span>
<span class="line">        &lt;plugins&gt;</span>
<span class="line">            &lt;plugin&gt;</span>
<span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span>
<span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span>
<span class="line">            &lt;/plugin&gt;</span>
<span class="line">        &lt;/plugins&gt;</span>
<span class="line">    &lt;/build&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é…ç½®" tabindex="-1"><a class="header-anchor" href="#é…ç½®"><span>é…ç½®</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.200<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> item <span class="token comment"># è·¯ç”±è§„åˆ™idï¼Œè‡ªå®šä¹‰ï¼Œå”¯ä¸€</span></span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//item<span class="token punctuation">-</span>service <span class="token comment"># è·¯ç”±çš„ç›®æ ‡æœåŠ¡ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—è¡¨</span></span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è§„åˆ™ï¼Œç¬¦åˆåˆ™è·¯ç”±åˆ°ç›®æ ‡æœåŠ¡</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/items/<span class="token important">**</span><span class="token punctuation">,</span>/search/<span class="token important">**</span> <span class="token comment"># è¿™é‡Œæ˜¯ä»¥è¯·æ±‚è·¯å¾„ä½œä¸ºåˆ¤æ–­è§„åˆ™</span></span>
<span class="line">              </span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cart</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cart<span class="token punctuation">-</span>service</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/carts/<span class="token important">**</span></span>
<span class="line">              </span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/users/<span class="token important">**</span><span class="token punctuation">,</span>/addresses/<span class="token important">**</span></span>
<span class="line">              </span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> trade</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//trade<span class="token punctuation">-</span>service</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/orders/<span class="token important">**</span></span>
<span class="line">              </span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> pay</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//pay<span class="token punctuation">-</span>service</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/pay<span class="token punctuation">-</span>orders/<span class="token important">**</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è·¯ç”±å±æ€§" tabindex="-1"><a class="header-anchor" href="#è·¯ç”±å±æ€§"><span>è·¯ç”±å±æ€§</span></a></h2><h3 id="æ–­è¨€predicate" tabindex="-1"><a class="header-anchor" href="#æ–­è¨€predicate"><span>æ–­è¨€Predicate</span></a></h3><table><thead><tr><th>Predicate åç§°</th><th>YAML é…ç½®ç¤ºä¾‹</th><th>åŠŸèƒ½è¯´æ˜</th><th>åŒ¹é…æ¡ä»¶</th><th>æ³¨æ„äº‹é¡¹</th></tr></thead><tbody><tr><td>Path</td><td><code>- Path=/api/user/</code></td><td>åŒ¹é…è¯·æ±‚è·¯å¾„</td><td>Ant é£æ ¼è·¯å¾„ï¼š â€¢ <code>*</code>ï¼šå•å±‚ â€¢ \`\`ï¼šå¤šå±‚</td><td>æœ€å¸¸ç”¨ï¼›æ”¯æŒè·¯å¾„å˜é‡ï¼ˆå¦‚ <code>/api/{id}</code>ï¼‰</td></tr><tr><td>Method</td><td><code>- Method=GET,POST</code></td><td>åŒ¹é… HTTP æ–¹æ³•</td><td><code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code> ç­‰</td><td>å¤šä¸ªæ–¹æ³•ç”¨é€—å·åˆ†éš”</td></tr><tr><td>Header</td><td><code>- Header=X-Token</code> <code>- Header=X-Token, \\d+</code></td><td>åŒ¹é…è¯·æ±‚å¤´</td><td>å­˜åœ¨æŸ Headerï¼Œæˆ–å€¼ç¬¦åˆæ­£åˆ™</td><td>æ­£åˆ™éœ€è½¬ä¹‰ï¼ˆå¦‚ <code>\\d+</code>ï¼‰ï¼›Header åä¸åŒºåˆ†å¤§å°å†™</td></tr><tr><td>Query</td><td><code>- Query=username</code> <code>- Query=username, [a-z]+</code></td><td>åŒ¹é… URL æŸ¥è¯¢å‚æ•°</td><td>å­˜åœ¨æŸå‚æ•°ï¼Œæˆ–å€¼ç¬¦åˆæ­£åˆ™</td><td>å‚æ•°å/å€¼å‡æ”¯æŒæ­£åˆ™</td></tr><tr><td>Host</td><td><code>- Host=*.example.com</code></td><td>åŒ¹é… Host å¤´</td><td>åŸŸåé€šé…ç¬¦åŒ¹é…</td><td>ç”¨äºå¤šåŸŸåè·¯ç”±ï¼ˆå¦‚ mobile/api/adminï¼‰</td></tr><tr><td>Cookie</td><td><code>- Cookie=username, [a-z0-9]+</code></td><td>åŒ¹é… Cookie</td><td>Cookie åå­˜åœ¨ï¼Œä¸”å€¼ç¬¦åˆæ­£åˆ™</td><td>å®‰å…¨æ€§è¾ƒä½ï¼Œæ…ç”¨äºæ•æ„Ÿé€»è¾‘</td></tr><tr><td>RemoteAddr</td><td><code>- RemoteAddr=192.168.1.0/24</code></td><td>åŒ¹é…å®¢æˆ·ç«¯ IP</td><td>CIDR æ ¼å¼ IP æ®µ</td><td>è‹¥å‰ç½® Nginxï¼Œéœ€ç¡®ä¿ä¼ é€’çœŸå® IPï¼ˆ<code>X-Forwarded-For</code>ï¼‰</td></tr><tr><td>Before</td><td><code>- Before=2026-06-01T00:00:00+08:00[Asia/Shanghai]</code></td><td>åœ¨æŒ‡å®šæ—¶é—´å‰åŒ¹é…</td><td>æ—¶é—´æˆ³ï¼ˆISO 8601ï¼‰</td><td>ç”¨äºå®šæ—¶å¼€å…³ã€ç°åº¦é¢„çƒ­</td></tr><tr><td>After</td><td><code>- After=2026-02-01T00:00:00+08:00</code></td><td>åœ¨æŒ‡å®šæ—¶é—´ååŒ¹é…</td><td>åŒä¸Š</td><td>å¸¸ä¸ <code>Before</code> é…åˆåšæ—¶é—´æ®µæ§åˆ¶</td></tr><tr><td>Between</td><td><code>- Between=2026-02-01T00:00:00+08:00, 2026-02-28T23:59:59+08:00</code></td><td>åœ¨ä¸¤ä¸ªæ—¶é—´ä¹‹é—´åŒ¹é…</td><td>èµ·æ­¢æ—¶é—´</td><td>ç­‰ä»·äº <code>After &amp;&amp; Before</code></td></tr><tr><td>Weight</td><td><code>- Weight=group1, 30</code></td><td>æŒ‰æƒé‡åˆ†é…æµé‡</td><td>æƒé‡å€¼ï¼ˆæ•´æ•°ï¼‰</td><td>ç”¨äºé‡‘ä¸é›€å‘å¸ƒï¼›åŒ group å†…æŒ‰æ¯”ä¾‹åˆ†æµ</td></tr><tr><td>ReadBody</td><td>ï¼ˆä»… Java é…ç½®ï¼‰</td><td>è¯»å–è¯·æ±‚ä½“å†…å®¹åŒ¹é…</td><td>è‡ªå®šä¹‰ Body åˆ¤æ–­é€»è¾‘</td><td>âš ï¸ æ¶ˆè€—è¾“å…¥æµï¼Œå½±å“æ€§èƒ½ï¼›YAML ä¸æ”¯æŒ</td></tr><tr><td>CloudFoundryRouteService</td><td>ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰</td><td>CF å¹³å°è·¯ç”±æœåŠ¡</td><td>ç‰¹å®š Header åŒ¹é…</td><td>ä¸€èˆ¬ä¸ç”¨</td></tr></tbody></table><h3 id="è¿‡æ»¤å™¨filter" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨filter"><span>è¿‡æ»¤å™¨filter</span></a></h3><p><strong>å¤§è‡´ç±»å‹ï¼š</strong></p><p><strong>GatewayFilterï¼ˆå±€éƒ¨è¿‡æ»¤å™¨ï¼‰</strong></p><ul><li><p><strong>ä½œç”¨èŒƒå›´</strong>ï¼šä»…å¯¹<strong>å•ä¸ªè·¯ç”±</strong>ç”Ÿæ•ˆ</p></li><li><p><strong>é…ç½®æ–¹å¼</strong>ï¼šåœ¨ <code>routes</code> ä¸‹çš„ <code>filters</code> ä¸­å£°æ˜</p></li><li><p>ç¤ºä¾‹ï¼š</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service</span>
<span class="line">    <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>service</span>
<span class="line">    <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> Path=/api/user/<span class="token important">**</span></span>
<span class="line">    <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> StripPrefix=1          <span class="token comment"># â† å±€éƒ¨è¿‡æ»¤å™¨</span></span>
<span class="line">      <span class="token punctuation">-</span> AddRequestHeader=X<span class="token punctuation">-</span>Source<span class="token punctuation">,</span> gateway</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>GlobalFilterï¼ˆå…¨å±€è¿‡æ»¤å™¨ï¼‰</strong></p><ul><li><p><strong>ä½œç”¨èŒƒå›´</strong>ï¼šå¯¹<strong>æ‰€æœ‰è·¯ç”±</strong>ç”Ÿæ•ˆ</p></li><li><p><strong>é…ç½®æ–¹å¼</strong>ï¼šé€šè¿‡ <code>@Component</code> æ³¨å†Œ Bean</p></li><li><p>ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å…¨å±€é‰´æƒé€»è¾‘</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>ğŸ”‘ <strong>å…³é”®åŒºåˆ«</strong>ï¼š</p><ul><li><code>GatewayFilter</code> éœ€æ˜¾å¼é…ç½®åˆ°è·¯ç”±</li><li><code>GlobalFilter</code> è‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰è¯·æ±‚</li></ul></blockquote><hr><p><strong>å…·ä½“ç±»å‹ï¼š</strong></p><p><strong>1.è·¯å¾„é‡å†™ç±»</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>StripPrefix</code></td><td style="text-align:left;"><code>- StripPrefix=1</code></td><td style="text-align:left;">å»æ‰è·¯å¾„å‰ N æ®µ <code>/api/user/123</code> â†’ <code>/user/123</code></td></tr><tr><td style="text-align:left;"><code>RewritePath</code></td><td style="text-align:left;"><code>- RewritePath=/api/(?&lt;segment&gt;.*), /$\\{segment}</code></td><td style="text-align:left;">æ­£åˆ™é‡å†™è·¯å¾„</td></tr></tbody></table><p><strong>2.Header æ“ä½œç±»</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>AddRequestHeader</code></td><td style="text-align:left;"><code>- AddRequestHeader=X-Source, gateway</code></td><td style="text-align:left;">æ·»åŠ è¯·æ±‚å¤´</td></tr><tr><td style="text-align:left;"><code>RemoveRequestHeader</code></td><td style="text-align:left;"><code>- RemoveRequestHeader=Secret</code></td><td style="text-align:left;">åˆ é™¤æ•æ„Ÿå¤´</td></tr><tr><td style="text-align:left;"><code>SetPath</code></td><td style="text-align:left;"><code>- SetPath=/new/{id}</code></td><td style="text-align:left;">åŠ¨æ€è®¾ç½®è·¯å¾„ï¼ˆæ”¯æŒå˜é‡ï¼‰</td></tr></tbody></table><p><strong>3.é™æµç±»</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;"><code>RequestRateLimiter</code></td><td style="text-align:left;">è§ä¸‹æ–‡</td><td style="text-align:left;">åŸºäº Redis çš„ä»¤ç‰Œæ¡¶é™æµ</td></tr></tbody></table><p><strong>é™æµé…ç½®ç¤ºä¾‹ï¼š</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter</span>
<span class="line">    <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token comment"># æ¯ç§’ç”Ÿæˆ 10 ä¸ªä»¤ç‰Œ</span></span>
<span class="line">      <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">20</span>    <span class="token comment"># æ¡¶å®¹é‡ 20</span></span>
<span class="line">      <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@userKeyResolver}&quot;</span>     <span class="token comment"># æŒ‰ç”¨æˆ·é™æµ</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">userKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> </span>
<span class="line">        <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;X-User-ID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4.ç†”æ–­ç±»</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ç¤ºä¾‹</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>CircuitBreaker</code></td><td style="text-align:left;"><code>- name: CircuitBreaker</code> <code> args:</code> <code> name: orderServiceCB</code> <code> fallbackUri: forward:/fallback/order</code></td><td style="text-align:left;">é›†æˆ Resilience4j/Sentinelï¼Œå¤±è´¥æ—¶è·³è½¬å…œåº•æ¥å£</td></tr></tbody></table><p><strong>5.å…¶ä»–å®ç”¨è¿‡æ»¤å™¨</strong></p><table><thead><tr><th style="text-align:left;">è¿‡æ»¤å™¨</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><code>PreserveHostHeader</code></td><td style="text-align:left;">ä¿ç•™åŸå§‹ Host å¤´ï¼ˆé»˜è®¤ä¼šè¢«æ›¿æ¢ä¸ºç›®æ ‡æœåŠ¡ Hostï¼‰</td></tr><tr><td style="text-align:left;"><code>Retry</code></td><td style="text-align:left;">è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚ï¼ˆå¯é…ç½®æ¬¡æ•°ã€å¼‚å¸¸ç±»å‹ï¼‰</td></tr><tr><td style="text-align:left;"><code>DedupeResponseHeader</code></td><td style="text-align:left;">å»é™¤é‡å¤å“åº”å¤´ï¼ˆå¦‚å¤šä¸ªæœåŠ¡éƒ½åŠ äº† CORS å¤´ï¼‰</td></tr></tbody></table><h2 id="ç½‘ç»œç™»å½•æ ¡éªŒ" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œç™»å½•æ ¡éªŒ"><span>ç½‘ç»œç™»å½•æ ¡éªŒ</span></a></h2><h3 id="gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹"><span>Gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Client</span>
<span class="line">   â†“</span>
<span class="line">[HttpServer] (Netty)</span>
<span class="line">   â†“</span>
<span class="line">[Gateway Handler Mapping] â†’ è·¯ç”±æ˜ å°„ï¼ŒåŒ¹é… Routeï¼ˆæ–­è¨€ï¼‰ï¼Œå¹¶é€šè¿‡WebHandlerå°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„è·¯ç”±è¿‡æ»¤å™¨ç»„</span>
<span class="line">   â†“</span>
<span class="line">[Filter Chain]</span>
<span class="line">   â”œâ”€â”€ GlobalFilter 1 (pre)</span>
<span class="line">   â”œâ”€â”€ GlobalFilter 2 (pre)</span>
<span class="line">   â”œâ”€â”€ RouteFilter A (pre)</span>
<span class="line">   â”œâ”€â”€ RouteFilter B (pre)</span>
<span class="line">   â†“</span>
<span class="line">[Proxy Request to Target Service]  â† NettyRoutingFilterï¼ˆæ ¸å¿ƒè½¬å‘å™¨ï¼Œå°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„å¾®æœåŠ¡å®ä¾‹ï¼‰</span>
<span class="line">   â†“</span>
<span class="line">   â”œâ”€â”€ RouteFilter A (post)</span>
<span class="line">   â”œâ”€â”€ RouteFilter A (post)</span>
<span class="line">   â”œâ”€â”€ GlobalFilter 2 (post)</span>
<span class="line">   â””â”€â”€ GlobalFilter 1 (post)</span>
<span class="line">   â†“</span>
<span class="line">[Write Response to Client]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Requestæ‰“åˆ°ç½‘å…³åæ ¹æ®<strong>æ–­è¨€</strong>åˆ†é…åˆ°æŒ‡å®šçš„<strong>è¿‡æ»¤å™¨ç»„</strong>ï¼Œå®Œæˆè¿‡æ»¤å™¨ä¸­çš„<strong>pre</strong>æ“ä½œåï¼Œäº¤ç»™NettyRoutingFilteræ ¹æ®Nacosè·å–åˆ°çš„å¾®æœåŠ¡å®ä¾‹é€šè¿‡loadBalanceè´Ÿè½½å‡è¡¡åˆ°å‡ ä¸ªå®ä¾‹ä¸­ï¼Œ<strong>å“åº”ç»“æœä¼ å›ç½‘å…³</strong>ï¼Œå®Œæˆè¿‡æ»¤å™¨çš„<strong>post</strong>æ“ä½œï¼Œåœ¨ä¼ å›nginx/å‰ç«¯ã€‚</p><p>æˆ‘ä»¬å¦‚æœéœ€è¦<strong>éªŒè¯ç”¨æˆ·ä¿¡æ¯</strong>ï¼Œå°±éœ€è¦åœ¨Gatewayçš„<strong>è¿‡æ»¤å™¨ç»„</strong>ä¸­å®‰æ’ä¸€ä¸ªè¿‡æ»¤å™¨çš„<strong>pre</strong>éƒ¨åˆ†å®ŒæˆéªŒè¯æ“ä½œã€‚</p><h3 id="è‡ªå®šä¹‰globalfilter" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰globalfilter"><span>è‡ªå®šä¹‰GlobalFilter</span></a></h3><p>å…¨å±€è¿‡æ»¤ï¼Œ<strong>æ‰€æœ‰è·¯ç”±éƒ½ä¼šè¢«å¤„ç†</strong>ï¼Œå£°æ˜åè‡ªåŠ¨ç”Ÿæ•ˆï¼Œåªéœ€å®ç°<code>GlobalFilter</code>å³å¯ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span>		<span class="token comment">// @Componentå£°æ˜å¹¶å®ç°GlobalFilterå³æ³¨å†Œå®Œæˆå…¨å±€è¿‡æ»¤å™¨</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è·å–è¯·æ±‚å¤´</span></span>
<span class="line">        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ”¾è¡Œ</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ä¼ ç»™è¿‡æ»¤å™¨çš„<strong>è¯·æ±‚ä¸Šä¸‹æ–‡ServerWebExchange</strong>æ‹¿åˆ°äº†è¯·æ±‚ServerHttpRequestï¼Œç„¶åå®Œæˆç›¸å…³æ“ä½œåå°±å¯ä»¥<code>return chain.filter(exchange);</code>äº¤ç»™ä¸‹ä¸€ä½è¿‡æ»¤å™¨äº†ã€‚</p><h3 id="è‡ªå®šä¹‰gatewayfilter" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰gatewayfilter"><span>è‡ªå®šä¹‰GatewayFilter</span></a></h3><p>åªåœ¨è·¯ç”±é…ç½®ä¸­å£°æ˜æ—¶ä½œç”¨äºè¯¥è·¯ç”±ï¼Œ<strong>éœ€è¦åœ¨è·¯ç”±ä¸­å£°æ˜</strong>ã€‚</p><p>ç»§æ‰¿<code>AbstractGatewayFilterFactory&lt;Config&gt;</code>åé‡å†™<code>apply</code>æ–¹æ³•ï¼šreturnä¸€ä¸ªé‡å†™äº†<code>filter</code>æ–¹æ³•çš„è¿‡æ»¤å™¨ã€‚</p><p>æœ€ååœ¨ymlä¸­é…ç½®å¥½å¯¹åº”çš„è·¯ç”±routeå³å¯ã€‚</p><div class="language-Java line-numbers-mode" data-highlighter="prismjs" data-ext="Java" data-title="Java"><pre><code><span class="line">@Component</span>
<span class="line">public class PrintAnyGatewayFilterFactory // çˆ¶ç±»æ³›å‹æ˜¯å†…éƒ¨ç±»çš„Configç±»å‹ï¼Œæ³¨æ„åç¼€å¿…é¡»æ˜¯GatewayFilterFactory</span>
<span class="line">                extends AbstractGatewayFilterFactory&lt;PrintAnyGatewayFilterFactory.Config&gt; {</span>
<span class="line"></span>
<span class="line">    @Override</span>
<span class="line">    public GatewayFilter apply(Config config) {</span>
<span class="line">        // OrderedGatewayFilteræ˜¯GatewayFilterçš„å­ç±»ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</span>
<span class="line">        // - GatewayFilterï¼šè¿‡æ»¤å™¨</span>
<span class="line">        // - int orderå€¼ï¼šå€¼è¶Šå°ï¼Œè¿‡æ»¤å™¨æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜</span>
<span class="line">        return new OrderedGatewayFilter(new GatewayFilter() {</span>
<span class="line">            @Override</span>
<span class="line">            public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {</span>
<span class="line">                // è·å–configå€¼</span>
<span class="line">                String a = config.getA();</span>
<span class="line">                String b = config.getB();</span>
<span class="line">                String c = config.getC();</span>
<span class="line">                // ç¼–å†™è¿‡æ»¤å™¨é€»è¾‘</span>
<span class="line">                System.out.println(&quot;a = &quot; + a);</span>
<span class="line">                System.out.println(&quot;b = &quot; + b);</span>
<span class="line">                System.out.println(&quot;c = &quot; + c);</span>
<span class="line">                // æ”¾è¡Œ</span>
<span class="line">                return chain.filter(exchange);</span>
<span class="line">            }</span>
<span class="line">        }, 100); // ä¼˜å…ˆçº§</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    // è‡ªå®šä¹‰é…ç½®å±æ€§ï¼Œæˆå‘˜å˜é‡åç§°å¾ˆé‡è¦ï¼Œä¸‹é¢ä¼šç”¨åˆ°</span>
<span class="line">    @Data</span>
<span class="line">    static class Config{</span>
<span class="line">        private String a;</span>
<span class="line">        private String b;</span>
<span class="line">        private String c;</span>
<span class="line">    }</span>
<span class="line">    // å°†å˜é‡åç§°ä¾æ¬¡è¿”å›ï¼Œé¡ºåºå¾ˆé‡è¦ï¼Œå°†æ¥è¯»å–å‚æ•°æ—¶éœ€è¦æŒ‰é¡ºåºè·å–</span>
<span class="line">    @Override</span>
<span class="line">    public List&lt;String&gt; shortcutFieldOrder() {</span>
<span class="line">        return List.of(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);</span>
<span class="line">    }</span>
<span class="line">    // è¿”å›å½“å‰é…ç½®ç±»çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨çš„Config</span>
<span class="line">    @Override</span>
<span class="line">    public Class&lt;Config&gt; getConfigClass() {</span>
<span class="line">        return Config.class;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>æ³¨æ„</strong>ï¼šè¯¥ç±»çš„åç§°ä¸€å®šè¦ä»¥<code>GatewayFilterFactory</code>ä¸ºåç¼€ï¼</p></blockquote><p>ç„¶åå°±å¯ä»¥æ³¨å†Œåˆ°ymlä¸­äº†ï¼š</p><div class="language-YAML line-numbers-mode" data-highlighter="prismjs" data-ext="YAML" data-title="YAML"><pre><code><span class="line">spring:</span>
<span class="line">  cloud:</span>
<span class="line">    gateway:</span>
<span class="line">      default-filters:</span>
<span class="line">            - PrintAny=1,2,3 # æ³¨æ„ï¼Œè¿™é‡Œå¤šä¸ªå‚æ•°ä»¥&quot;,&quot;éš”å¼€ï¼Œå°†æ¥ä¼šæŒ‰ç…§shortcutFieldOrder()æ–¹æ³•è¿”å›çš„å‚æ•°é¡ºåºä¾æ¬¡å¤åˆ¶</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶æŒ‡æ˜äº†å‚æ•°å­—æ®µåä¹‹åï¼Œå‚æ•°å¯ä»¥ç›´æ¥ä¸€å¯¹ä¸€èµ‹å€¼ï¼š</p><div class="language-YAML line-numbers-mode" data-highlighter="prismjs" data-ext="YAML" data-title="YAML"><pre><code><span class="line">spring:</span>
<span class="line">  cloud:</span>
<span class="line">    gateway:</span>
<span class="line">      default-filters:</span>
<span class="line">            - name: PrintAny</span>
<span class="line">              args: # æ‰‹åŠ¨æŒ‡å®šå‚æ•°åï¼Œæ— éœ€æŒ‰ç…§å‚æ•°é¡ºåº</span>
<span class="line">                a: 1</span>
<span class="line">                b: 2</span>
<span class="line">                c: 3</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°ç™»å½•æ ¡éªŒ" tabindex="-1"><a class="header-anchor" href="#å®ç°ç™»å½•æ ¡éªŒ"><span>å®ç°ç™»å½•æ ¡éªŒ</span></a></h3><p>ä¸€èˆ¬ç›´æ¥ä½¿ç”¨<code>GlobalFilter</code>å³å¯ï¼Œåé¢å†excludeæ‰ä¸€äº›ä¸éœ€è¦çš„uriè·¯å¾„å°±è¡Œï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token annotation punctuation">@RequiredArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è®°å½•ä¸éœ€è¦éªŒè¯çš„uriè·¯å¾„</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthProperties</span> authProperties<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// jwtç§˜é’¥ç”Ÿæˆä»¥åŠè§£æå™¨</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtTool</span> jwtTool<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AntPathMatcher</span> antPathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è¿‡æ»¤</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExcludePath</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä¸éœ€è¦è¿‡æ»¤</span></span>
<span class="line">            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// å–å‡ºè¯·æ±‚å¤´</span></span>
<span class="line">        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// è·å–</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä¸å­˜åœ¨</span></span>
<span class="line">            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// è§£æ</span></span>
<span class="line">        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            userId <span class="token operator">=</span> jwtTool<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnauthorizedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// è§£æå¤±è´¥ï¼Œæ‹¦æˆª</span></span>
<span class="line">            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * åˆ¤æ–­æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">path</span> è¯·æ±‚è·¯å¾„</span>
<span class="line">     * <span class="token keyword">@return</span> æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isExcludePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> excludePath <span class="token operator">:</span> authProperties<span class="token punctuation">.</span><span class="token function">getExcludePaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>excludePath<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆäº†ç”¨æˆ·ä¿¡æ¯çš„éªŒè¯åï¼Œæˆ‘ä»¬éœ€è¦å°†è§£æå‡ºæ¥çš„ä¿¡æ¯<strong>ä¼ ç»™åç»­çš„å¾®æœåŠ¡</strong>ï¼Œå¯ä»¥è€ƒè™‘å°†æ•°æ®å­˜å‚¨åˆ°Requestçš„headerä¸­ï¼Œåœ¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡<code>ServerWebExchange</code>ä¸­è°ƒç”¨<code>mutate()</code>æ–¹æ³•ç”Ÿæˆä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ï¼Œå…¶çš„è¯·æ±‚å¤´åŒ…å«ç”¨æˆ·æ•°æ®ï¼Œå°†è¿™ä¸ªä¸Šä¸‹æ–‡ä¼ ç»™è¿‡æ»¤å™¨é“¾ï¼Œä½¿å¾—ä¸‹æ¸¸è¿‡æ»¤å™¨ä»¥åŠå¾®æœåŠ¡æ”¶åˆ°çš„è¯·æ±‚headerå«æ‰€ä¼ æ•°æ®ã€‚</p><blockquote><p>mutate() æ˜¯ Reactor æ¡†æ¶ä¸­ ServerWebExchange æä¾›çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºæ„å»ºä¸€ä¸ªæ–°çš„ ServerWebExchange å®ä¾‹ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹å¯¹è±¡çš„çŠ¶æ€ã€‚</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// æ·»åŠ ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line"><span class="token class-name">String</span> userInfo <span class="token operator">=</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">ServerWebExchange</span> user <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>builder <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    builder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;userInfo&quot;</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨åç»­çš„è¯·æ±‚å¤´å°±åŒ…å«äº†ç”¨æˆ·æ•°æ®äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å®Œæˆå°†ç”¨æˆ·æ•°æ®å­˜è‡³<code>Threadlocal</code>æ–¹ä¾¿åœ¨ä¸šåŠ¡ä¸­è·å–ï¼Œä¸€èˆ¬è°ˆåˆ°å­˜å‚¨è¯·æ±‚å¤´æ•°æ®åˆ°tlä¸­å°±æ˜¯ç”¨mvcçš„<strong>æ‹¦æˆªå™¨</strong>äº†ï¼ˆaopä¹Ÿå¯ä»¥ï¼‰ï¼Œç”±äº<strong>åŸºæœ¬æ‰€æœ‰å¾®æœåŠ¡éƒ½éœ€è¦å°†è¯·æ±‚å¤´ä¸­çš„æ•°æ®å­˜åˆ°tlä¸­</strong>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ª<strong>å…¬å…±æ¨¡å—</strong>ä¸­å®Œæˆå¯¹æ‹¦æˆªå™¨çš„ç¼–å†™å¹¶æ³¨å…¥åˆ°é…ç½®ä¸­ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> userInfo <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;userInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¾å…¥çº¿ç¨‹å˜é‡</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆæ‹¦æˆªå™¨çš„ç¼–å†™åï¼Œæˆ‘ä»¬å°†ä¹‹æ³¨å†Œåˆ°mvcconfigä¸­ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserInfoInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„ï¼š</strong></p><ol><li>æˆ‘ä»¬æ˜¯åœ¨<strong>commonæ¨¡å—</strong>ä¸­ç¼–å†™çš„<code>@Configuration</code>æ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>å…¶ä»–æ¨¡å—æ˜¯ä¸ä¼šæ‰«æè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„<code>@Component</code>æ–‡ä»¶çš„</strong>ï¼</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åšä¸€äº›é¢å¤–é…ç½®ï¼šæˆ‘ä»¬å¯ä»¥åœ¨commonæ¨¡å—çš„resourcesæ–‡ä»¶å¤¹ä¸‹çš„META-INFæ–‡ä»¶å¤¹å†…ç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶<code>spring.factories</code>ä»¥å®ç°SpringBootçš„è‡ªåŠ¨è£…é…ï¼š</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="token punctuation">=</span><span class="token value attr-value">\\</span>
<span class="line">  com.hmall.common.config.MyBatisConfig,\\</span>
<span class="line">  com.hmall.common.config.JsonConfig,\\</span>
<span class="line">  com.hmall.common.config.MvcConfig</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>spring.factories</code>æ–‡ä»¶æ˜¯ Spring Boot ä¸­ç”¨äºè‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å‘Šè¯‰ Spring Boot åœ¨å¯åŠ¨æ—¶éœ€è¦åŠ è½½å“ªäº›è‡ªåŠ¨é…ç½®ç±»ã€‚</p><ul><li>é€šå¸¸ä½äº META-INF/spring.factories è·¯å¾„ä¸‹ã€‚</li><li>Spring Boot å¯åŠ¨æ—¶ä¼šæ‰«æ<strong>æ‰€æœ‰ä¾èµ–</strong>ä¸­çš„ spring.factories æ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­å®šä¹‰çš„é…ç½®ç±»ã€‚</li></ul><p>org.springframework.boot.autoconfigure.EnableAutoConfiguration æ˜¯ Spring Boot è‡ªåŠ¨é…ç½®çš„å…¥å£é”®ã€‚ åé¢åˆ—å‡ºçš„ç±»ï¼ˆå¦‚ MyBatisConfigã€JsonConfigã€MvcConfigï¼‰æ˜¯è‡ªå®šä¹‰çš„é…ç½®ç±»ï¼ŒSpring Boot ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½è¿™äº›ç±»ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¼€å‘è€…å¯ä»¥å°†è‡ªå·±çš„é…ç½®ç±»æ³¨å†Œåˆ° Spring Boot çš„è‡ªåŠ¨é…ç½®æµç¨‹ä¸­ã€‚ æ— éœ€æ‰‹åŠ¨åœ¨ä¸»ç±»ä¸Šä½¿ç”¨ @Import æˆ– @ComponentScan æ³¨è§£ï¼ŒSpring Boot ä¼šè‡ªåŠ¨å‘ç°å¹¶åº”ç”¨è¿™äº›é…ç½®ã€‚</p></blockquote><p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„configæ–‡ä»¶å°±æˆåŠŸé…ç½®åˆ°äº†æ‰€æœ‰å¾®æœåŠ¡æ¨¡å—ä¸­ã€‚</p><hr><ol start="2"><li>Gatewayæ¨¡å—ä¹Ÿå¼•å…¥äº†commonæ¨¡å—ï¼Œä½†ä»–æ˜¯åŸºäº<strong>webflux</strong>çš„ï¼Œ<strong>æ²¡æœ‰webmvcå¯¼è‡´å¼•å…¥mvcConfigä¼šæŠ¥é”™</strong>ï¼</li></ol><p>é‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±ä¸å¸Œæœ›Gatewayæ¨¡å—åº”ç”¨mvcConfigé…ç½®äº†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦é’ˆå¯¹Gatewayæ¨¡å—å¯¹MvcConfigåšä¸€äº›é¢å¤–é…ç½®ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p><code>@ConditionalOnClass(DispatcherServlet.class)</code> æ˜¯ Spring Boot æä¾›çš„ä¸€ä¸ªæ¡ä»¶æ³¨è§£ï¼Œç”¨äºæ§åˆ¶é…ç½®ç±»æˆ– Bean çš„åŠ è½½æ¡ä»¶ã€‚å…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š</p><p>æ¡ä»¶åˆ¤æ–­ï¼šåªæœ‰å½“ DispatcherServlet ç±»å­˜åœ¨äºå½“å‰é¡¹ç›®çš„ classpath ä¸­æ—¶ï¼Œè¢«è¯¥æ³¨è§£æ ‡è®°çš„é…ç½®ç±»ï¼ˆå¦‚ MvcConfigï¼‰æ‰ä¼šç”Ÿæ•ˆã€‚ é¿å…é”™è¯¯ï¼šå¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰å¼•å…¥ Web ç›¸å…³ä¾èµ–ï¼ˆä¾‹å¦‚ spring-webmvcï¼‰ï¼Œåˆ™ DispatcherServlet ç±»ä¸ä¼šå­˜åœ¨ï¼Œæ­¤æ—¶ MvcConfig ä¸ä¼šè¢«åŠ è½½ï¼Œä»è€Œé¿å…å› ç¼ºå°‘ä¾èµ–å¯¼è‡´çš„å¯åŠ¨å¤±è´¥ã€‚</p></blockquote><p>ä½†æ˜¯æˆ‘ä»¬è¯´Gatewayä¹Ÿå¼•å…¥äº†commonæ¨¡å—ï¼Œcommonæ¨¡å—è¦é…ç½®mvcé‚£è‚¯å®šæ˜¯å¸¦ä¸Šäº†mvcçš„ä¾èµ–çš„ï¼Œä¸ºä»€ä¹ˆè¯´Gatewayæ²¡æœ‰mvcçš„ä¾èµ–å‘¢ï¼Ÿ<strong>å› ä¸ºcommonæ¨¡å—ä¸­çš„ä¾èµ–ä¸€èˆ¬éƒ½æ˜¯ä»…ç¼–è¯‘æ—¶å¼•å…¥ï¼ˆå†™ä»£ç ä¸æŠ¥é”™ï¼‰ï¼Œè¿è¡Œä¸å¼•å…¥çš„ï¼ˆå…¶ä»–æ¨¡å—éœ€è¦è‡ªè¡Œå¼•å…¥ç›¸å…³ä¾èµ–ï¼‰ï¼š</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>&lt;scope&gt;provided&lt;/scope&gt;</code>ï¼šprovidedä½œç”¨åŸŸè¡¨ç¤ºä»…åœ¨ç¼–è¯‘æ—¶å¼•å…¥</p></blockquote><p>è€ŒGatewayæ²¡æœ‰æ˜¾å¼å¼•å…¥mvcä¾èµ–ï¼Œé‚£ä¹ˆå…¶å®è¿è¡Œèµ·æ¥çš„æ—¶å€™æ˜¯æ²¡æœ‰mvcä¾èµ–çš„ï¼Œä¹Ÿå°±ä¸ä¼šé…ç½®mvcConfigäº†ã€‚</p><h3 id="openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯"><span>Openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯</span></a></h3><p>æˆ‘ä»¬å…ˆå‰å®Œæˆäº†å°†å‰ç«¯å‘æ¥çš„jwtåœ¨Gatewayè¿›è¡Œè§£æå¹¶å­˜å…¥è¯·æ±‚å¤´ï¼Œç„¶åå†åœ¨å¾®æœåŠ¡ä¸­å°†è¯·æ±‚å¤´ä¸­çš„è§£æå®Œæˆçš„æ•°æ®è£…é…åˆ°Threadlocalä¸­ã€‚ä½†æ˜¯è¿™åªæ˜¯Gatewayåˆ°å¾®æœåŠ¡çš„httpè¯·æ±‚å¤´ä¼šå¸¦ä¸Šç”¨æˆ·æ•°æ®ï¼Œå¾®æœåŠ¡ä¹‹é—´è¿˜ä¼šè¿›è¡ŒOpenfeignç›¸äº’è°ƒç”¨ï¼Œè¿™æ—¶å€™å¦‚æœä¸åšé¢å¤–é…ç½®ï¼ŒOpenfeignå‘é€çš„httpè¯·æ±‚å¤´æ˜¯ä¸ä¼šå¸¦ä¸Šéœ€è¦çš„ç”¨æˆ·ä¿¡æ¯çš„ã€‚</p><p>Openfeignå…¶å®å°±æä¾›äº†ä¸€ä¸ªæ‹¦æˆªå™¨æ¥å£<code>RequestInterceptor</code>ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆè¯·æ±‚å¤´ç­‰ä¿¡æ¯çš„å¤„ç†ï¼š</p><p>é¦–å…ˆåœ¨å…¬å…±Openfeign-apiæ¨¡å—ä¸­åŠ å…¥æ–°é…ç½®ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFeignClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserContext</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;userInfo&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.hmall.item.mapper&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.hmall.api.client&quot;</span><span class="token punctuation">,</span> defaultConfiguration <span class="token operator">=</span> <span class="token class-name">DefaultFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemServiceApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ItemServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆè¿™ä¸ªå¾®æœåŠ¡å®ä¾‹çš„ä¸šåŠ¡å¤„ç†çº¿ç¨‹å°±ä¼šåœ¨Openfeignå‘é€RPCè¯·æ±‚æ—¶<strong>å°†Threadlocalä¸­çš„ç”¨æˆ·æ•°æ®å†™å…¥è¯·æ±‚å¤´</strong>ï¼Œç„¶åå…¶ä»–å¾®æœåŠ¡å®ä¾‹çš„çº¿ç¨‹åœ¨å¤„ç†è¿™æ ·çš„httpè¯·æ±‚æ—¶ä¼š<strong>ä½¿ç”¨æ‹¦æˆªå™¨å¯¹è¿™ä¸ªè¯·æ±‚è¿›è¡Œæˆªå–</strong>ï¼Œ<strong>å°†è¯·æ±‚å¤´ä¸­çš„æ•°æ®æ‹¿å‡ºå¹¶å†™å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†çº¿ç¨‹çš„Threadlocalä¸­</strong>ã€‚</p><h2 id="ex-jwtéªŒè¯" tabindex="-1"><a class="header-anchor" href="#ex-jwtéªŒè¯"><span>EXï¼šJWTéªŒè¯</span></a></h2><p><strong>ç”¨æˆ·ç™»å½• â†’ åç«¯ç”Ÿæˆä¸€ä¸ªåŠ å¯†å­—ç¬¦ä¸²ï¼ˆJWTï¼‰â†’ å‰ç«¯ä¿å­˜ â†’ æ¯æ¬¡è¯·æ±‚å¸¦ä¸Šå®ƒ â†’ åç«¯è§£å¯†éªŒè¯ â†’ çŸ¥é“æ˜¯è°åœ¨è®¿é—®</strong></p><p>å…¨ç¨‹<strong>ä¸å­˜ Session</strong>ï¼ˆä¸å­˜Redisï¼‰ï¼Œæ— çŠ¶æ€ï¼</p><table><thead><tr><th style="text-align:left;">ç±»å</th><th style="text-align:left;">èŒè´£ï¼ˆä¸€å¥è¯è¯´æ¸…ï¼‰</th></tr></thead><tbody><tr><td style="text-align:left;"><strong><code>JwtUtil</code></strong></td><td style="text-align:left;"><strong>JWT å·¥å…·ç®±</strong>ï¼š â€¢ ç”Ÿæˆ Token â€¢ è§£æç”¨æˆ·å â€¢ éªŒè¯æ˜¯å¦è¿‡æœŸ/è¢«ç¯¡æ”¹</td></tr><tr><td style="text-align:left;"><strong><code>CustomUserDetailsService</code></strong></td><td style="text-align:left;"><strong>ç”¨æˆ·åŠ è½½å™¨</strong>ï¼š ä»æ•°æ®åº“æŸ¥ç”¨æˆ·ï¼ˆç”¨äºç™»å½•æ ¡éªŒ &amp; Token éªŒè¯æ—¶æ¯”å¯¹ï¼‰</td></tr><tr><td style="text-align:left;"><strong><code>AuthController</code></strong></td><td style="text-align:left;"><strong>ç™»å½•å…¥å£</strong>ï¼š æ¥æ”¶è´¦å·å¯†ç  â†’ è°ƒ Security æ ¡éªŒ â†’ æˆåŠŸå°±è°ƒ <code>JwtUtil</code> ç”Ÿæˆ Token è¿”å›</td></tr><tr><td style="text-align:left;"><strong><code>JwtRequestFilter</code></strong></td><td style="text-align:left;"><strong>å®ˆé—¨å‘˜ï¼ˆå…³é”®ï¼ï¼‰</strong>ï¼š æ¯ä¸ªè¯·æ±‚è¿›æ¥å…ˆçœ‹æœ‰æ²¡æœ‰ Token â†’ æœ‰å°±è§£æ â†’ éªŒè¯åˆæ³• â†’ æŠŠç”¨æˆ·èº«ä»½å¡è¿› Spring Security ä¸Šä¸‹æ–‡</td></tr><tr><td style="text-align:left;"><strong><code>SecurityConfig</code></strong></td><td style="text-align:left;"><strong>å®‰å…¨æ€»å¼€å…³</strong>ï¼š â€¢ å…³æ‰ Sessionï¼ˆè®¾ä¸º STATELESSï¼‰ â€¢ æ”¾è¡Œ <code>/login</code> â€¢ æ³¨å†Œ <code>JwtRequestFilter</code> åˆ°è¿‡æ»¤å™¨é“¾</td></tr></tbody></table><p><strong>å•ä½“é¡¹ç›®ä¸‹</strong>æˆ‘ä»¬å°±åªéœ€è¦åœ¨æ‹¦æˆªå™¨ä¸­å®Œæˆjwtçš„è§£æå³å¯ã€‚</p><p><strong>å¾®æœåŠ¡ä¸­</strong>æˆ‘ä»¬éœ€è¦åœ¨ç½‘å…³å®Œæˆç›¸åº”çš„æ“ä½œï¼š</p><h2 id="ex-springä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®" tabindex="-1"><a class="header-anchor" href="#ex-springä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®"><span>EXï¼šSpringä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®</span></a></h2><p><strong>å‰æï¼šé…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆYAMLï¼‰</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># application.yml</span></span>
<span class="line"><span class="token key atrule">app</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> MySpringBootApp</span>
<span class="line">  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0</span>
<span class="line">  <span class="token key atrule">debug-mode</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">timeout-ms</span><span class="token punctuation">:</span> <span class="token number">5000</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">database</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/mydb</span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> root</span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> secret</span>
<span class="line">  <span class="token key atrule">pool</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span></span>
<span class="line">    <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="æ–¹æ³•ä¸€-ä½¿ç”¨-value-æ³¨è§£-ç®€å•å±æ€§" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•ä¸€-ä½¿ç”¨-value-æ³¨è§£-ç®€å•å±æ€§"><span><strong>æ–¹æ³•ä¸€ï¼šä½¿ç”¨</strong> <code>@Value</code> <strong>æ³¨è§£ï¼ˆç®€å•å±æ€§ï¼‰</strong></span></a></h3><p>é€‚ç”¨äºè¯»å–<strong>å•ä¸ªé…ç½®é¡¹</strong>ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${app.name}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> appName<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${app.timeout-ms}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${database.url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> dbUrl<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ³¨æ„ï¼šYAML ä¸­çš„è¿å­—ç¬¦ï¼ˆ-ï¼‰åœ¨ @Value ä¸­éœ€ç”¨åŸæ ·å†™</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${app.debug-mode}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> debugMode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// getter...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âš ï¸ æ³¨æ„ï¼š</p><ul><li>å¦‚æœé…ç½®ä¸å­˜åœ¨ï¼Œå¯åŠ¨ä¼šæŠ¥é”™ï¼ˆé™¤éè®¾ç½®é»˜è®¤å€¼ï¼‰</li><li>é»˜è®¤å€¼å†™æ³•ï¼š<code>@Value(&quot;\${app.name:DefaultName}&quot;)</code></li></ul></blockquote><hr><h3 id="æ–¹æ³•äºŒ-ä½¿ç”¨-configurationproperties-æ¨è-å¯¹è±¡ç»‘å®š" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•äºŒ-ä½¿ç”¨-configurationproperties-æ¨è-å¯¹è±¡ç»‘å®š"><span><strong>æ–¹æ³•äºŒï¼šä½¿ç”¨</strong> <code>@ConfigurationProperties</code><strong>ï¼ˆæ¨èï¼å¯¹è±¡ç»‘å®šï¼‰</strong></span></a></h3><p>é€‚ç”¨äº<strong>ç»“æ„åŒ–é…ç½®</strong>ï¼ˆå¦‚æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ï¼‰ï¼Œ<strong>ç±»å‹å®‰å…¨ã€æ”¯æŒæ ¡éªŒã€å¯å¤ç”¨</strong>ã€‚</p><h4 id="æ­¥éª¤-1-åˆ›å»ºé…ç½®ç±»" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-1-åˆ›å»ºé…ç½®ç±»"><span><strong>æ­¥éª¤ 1ï¼šåˆ›å»ºé…ç½®ç±»</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;database&quot;</span><span class="token punctuation">)</span> <span class="token comment">// å¯¹åº” yml ä¸­çš„ database:</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseProperties</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@NotEmpty</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@NotEmpty</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Pool</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// nested class for pool config</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Pool</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token keyword">int</span> maxActive <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// getters &amp; setters</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> maxActive<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxActive</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxActive <span class="token operator">=</span> maxActive<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> minIdle<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token keyword">int</span> minIdle<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minIdle <span class="token operator">=</span> minIdle<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// getters &amp; setters for top-level fields</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> url<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> username<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> password<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Pool</span> <span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> pool<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPool</span><span class="token punctuation">(</span><span class="token class-name">Pool</span> pool<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> pool<span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æˆ–ä½¿ç”¨lombokçš„<code>@Data</code></p></blockquote><h4 id="æ­¥éª¤-2-å¯ç”¨-configurationproperties-spring-boot-2-2-å¯çœç•¥" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-2-å¯ç”¨-configurationproperties-spring-boot-2-2-å¯çœç•¥"><span><strong>æ­¥éª¤ 2ï¼šå¯ç”¨ ConfigurationPropertiesï¼ˆSpring Boot 2.2+ å¯çœç•¥ï¼‰</strong></span></a></h4><blockquote><p>ä» Spring Boot 2.2 å¼€å§‹ï¼Œåªè¦ç±»ä¸Šæœ‰ <code>@Component</code>ï¼Œå°±è‡ªåŠ¨ç”Ÿæ•ˆã€‚ å¦‚æœä½ ç”¨çš„æ˜¯è€ç‰ˆæœ¬ï¼Œæˆ–æƒ³é›†ä¸­ç®¡ç†ï¼Œå¯åœ¨ä¸»ç±»åŠ ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">DatabaseProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></blockquote><h4 id="æ­¥éª¤-3-ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-3-ä½¿ç”¨"><span><strong>æ­¥éª¤ 3ï¼šä½¿ç”¨</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ„é€ å™¨æ³¨å…¥ï¼Œå¯ä½¿ç”¨</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabaseProperties</span> dbProps<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token class-name">DatabaseProperties</span> dbProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>dbProps <span class="token operator">=</span> dbProps<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Connecting to: &quot;</span> <span class="token operator">+</span> dbProps<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Max active: &quot;</span> <span class="token operator">+</span> dbProps<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… ä¼˜ç‚¹ï¼š</p><ul><li>è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆString â†’ int, boolean ç­‰ï¼‰</li><li>æ”¯æŒåµŒå¥—å¯¹è±¡ï¼ˆå¦‚ <code>pool.max-active</code>ï¼‰</li><li>æ”¯æŒ JSR-303 æ ¡éªŒï¼ˆéœ€å¼•å…¥ <code>spring-boot-starter-validation</code>ï¼‰</li><li>IDE æ”¯æŒï¼ˆå¦‚ IntelliJ èƒ½è‡ªåŠ¨æç¤ºé…ç½®ï¼‰</li></ul></blockquote><hr><h3 id="æ–¹æ³•ä¸‰-ä½¿ç”¨-propertysource-åŠ è½½è‡ªå®šä¹‰-yaml-æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•ä¸‰-ä½¿ç”¨-propertysource-åŠ è½½è‡ªå®šä¹‰-yaml-æ–‡ä»¶"><span><strong>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨</strong> <code>@PropertySource</code><strong>ï¼ˆåŠ è½½è‡ªå®šä¹‰ YAML æ–‡ä»¶ï¼‰</strong></span></a></h3><p>é»˜è®¤ Spring Boot åªåŠ è½½ <code>application.yml</code>ã€‚å¦‚æœä½ æƒ³åŠ è½½é¢å¤–çš„é…ç½®æ–‡ä»¶ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@Configuration</span>
<span class="line">@PropertySource(&quot;classpath:custom-config.yml&quot;)</span>
<span class="line">// âŒ æ³¨æ„ï¼š@PropertySource é»˜è®¤ä¸æ”¯æŒ YAMLï¼</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âš ï¸ é—®é¢˜ï¼š<code>@PropertySource</code> <strong>åŸç”Ÿåªæ”¯æŒ <code>.properties</code></strong>ï¼Œä¸æ”¯æŒ YAMLï¼</p></blockquote><p><strong>è§£å†³æ–¹æ¡ˆï¼šæ”¹ç”¨</strong> <code>.properties</code><strong>ï¼Œæˆ–é€šè¿‡</strong> <code>Environment</code> <strong>æ‰‹åŠ¨åŠ è½½ï¼ˆä¸æ¨èï¼‰</strong></p><p>âœ… <strong>æ¨èåšæ³•</strong>ï¼šæŠŠæ‰€æœ‰é…ç½®æ”¾åœ¨ <code>application.yml</code>ï¼Œæˆ–ä½¿ç”¨ <strong>Profile å¤šç¯å¢ƒé…ç½®</strong>ï¼ˆå¦‚ <code>application-dev.yml</code>ï¼‰ã€‚</p><hr><h3 id="æ–¹æ³•å››-é€šè¿‡-environment-æ¥å£-åŠ¨æ€è·å–" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•å››-é€šè¿‡-environment-æ¥å£-åŠ¨æ€è·å–"><span><strong>æ–¹æ³•å››ï¼šé€šè¿‡</strong> <code>Environment</code> <strong>æ¥å£ï¼ˆåŠ¨æ€è·å–ï¼‰</strong></span></a></h3><p>é€‚ç”¨äºå·¥å…·ç±»æˆ–æ— æ³•æ³¨å…¥çš„åœºæ™¯ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigUtil</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Environment</span> env<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ConfigUtil</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> env<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;app.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;DefaultApp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤å€¼</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;app.timeout-ms&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>âœ… ä¼˜ç‚¹ï¼šçµæ´»ï¼Œæ”¯æŒé»˜è®¤å€¼å’Œç±»å‹è½¬æ¢ âŒ ç¼ºç‚¹ï¼šæ²¡æœ‰ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå®¹æ˜“æ‹¼é”™ key</p></blockquote><table><thead><tr><th style="text-align:left;">åœºæ™¯</th><th style="text-align:left;">æ¨èæ–¹å¼</th></tr></thead><tbody><tr><td style="text-align:left;">è¯»å– 1~2 ä¸ªç®€å•é…ç½®</td><td style="text-align:left;"><code>@Value</code></td></tr><tr><td style="text-align:left;">è¯»å–ä¸€ç»„ç»“æ„åŒ–é…ç½®ï¼ˆå¦‚æ•°æ®åº“ã€Redisã€ç¬¬ä¸‰æ–¹ APIï¼‰</td><td style="text-align:left;"><code>@ConfigurationProperties</code> âœ…ï¼ˆé¦–é€‰ï¼‰</td></tr><tr><td style="text-align:left;">åŠ¨æ€è·å– or å·¥å…·ç±»</td><td style="text-align:left;"><code>Environment</code></td></tr><tr><td style="text-align:left;">åŠ è½½é application çš„é…ç½®æ–‡ä»¶</td><td style="text-align:left;">åˆå¹¶åˆ° <code>application.yml</code> æˆ–ä½¿ç”¨ Profile</td></tr></tbody></table>`,136))])}const m=p(u,[["render",d]]),g=JSON.parse('{"path":"/docs/heimashangcheng/weifuwu/5.weifuwuwangguanï¼ˆGatewayï¼‰.html","title":"å¾®æœåŠ¡ç½‘å…³","lang":"en-US","frontmatter":{"title":"å¾®æœåŠ¡ç½‘å…³","date":"2026-2-3"},"headers":[{"level":2,"title":"Springcloud Gateway","slug":"springcloud-gateway","link":"#springcloud-gateway","children":[{"level":3,"title":"å…³é”®å†…å®¹","slug":"å…³é”®å†…å®¹","link":"#å…³é”®å†…å®¹","children":[]},{"level":3,"title":"å¼•å…¥ä¾èµ–","slug":"å¼•å…¥ä¾èµ–","link":"#å¼•å…¥ä¾èµ–","children":[]},{"level":3,"title":"é…ç½®","slug":"é…ç½®","link":"#é…ç½®","children":[]}]},{"level":2,"title":"è·¯ç”±å±æ€§","slug":"è·¯ç”±å±æ€§","link":"#è·¯ç”±å±æ€§","children":[{"level":3,"title":"æ–­è¨€Predicate","slug":"æ–­è¨€predicate","link":"#æ–­è¨€predicate","children":[]},{"level":3,"title":"è¿‡æ»¤å™¨filter","slug":"è¿‡æ»¤å™¨filter","link":"#è¿‡æ»¤å™¨filter","children":[]}]},{"level":2,"title":"ç½‘ç»œç™»å½•æ ¡éªŒ","slug":"ç½‘ç»œç™»å½•æ ¡éªŒ","link":"#ç½‘ç»œç™»å½•æ ¡éªŒ","children":[{"level":3,"title":"Gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹","slug":"gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹","link":"#gatewayéƒ¨åˆ†è¯·æ±‚å¤„ç†æµç¨‹","children":[]},{"level":3,"title":"è‡ªå®šä¹‰GlobalFilter","slug":"è‡ªå®šä¹‰globalfilter","link":"#è‡ªå®šä¹‰globalfilter","children":[]},{"level":3,"title":"è‡ªå®šä¹‰GatewayFilter","slug":"è‡ªå®šä¹‰gatewayfilter","link":"#è‡ªå®šä¹‰gatewayfilter","children":[]},{"level":3,"title":"å®ç°ç™»å½•æ ¡éªŒ","slug":"å®ç°ç™»å½•æ ¡éªŒ","link":"#å®ç°ç™»å½•æ ¡éªŒ","children":[]},{"level":3,"title":"Openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯","slug":"openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯","link":"#openfeignè¯·æ±‚å¸¦ä¸Šç”¨æˆ·ä¿¡æ¯","children":[]}]},{"level":2,"title":"EXï¼šJWTéªŒè¯","slug":"ex-jwtéªŒè¯","link":"#ex-jwtéªŒè¯","children":[]},{"level":2,"title":"EXï¼šSpringä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®","slug":"ex-springä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®","link":"#ex-springä»é…ç½®æ–‡ä»¶ä¸­è·å–æ•°æ®","children":[{"level":3,"title":"æ–¹æ³•ä¸€ï¼šä½¿ç”¨ @Value æ³¨è§£ï¼ˆç®€å•å±æ€§ï¼‰","slug":"æ–¹æ³•ä¸€-ä½¿ç”¨-value-æ³¨è§£-ç®€å•å±æ€§","link":"#æ–¹æ³•ä¸€-ä½¿ç”¨-value-æ³¨è§£-ç®€å•å±æ€§","children":[]},{"level":3,"title":"æ–¹æ³•äºŒï¼šä½¿ç”¨ @ConfigurationPropertiesï¼ˆæ¨èï¼å¯¹è±¡ç»‘å®šï¼‰","slug":"æ–¹æ³•äºŒ-ä½¿ç”¨-configurationproperties-æ¨è-å¯¹è±¡ç»‘å®š","link":"#æ–¹æ³•äºŒ-ä½¿ç”¨-configurationproperties-æ¨è-å¯¹è±¡ç»‘å®š","children":[]},{"level":3,"title":"æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ @PropertySourceï¼ˆåŠ è½½è‡ªå®šä¹‰ YAML æ–‡ä»¶ï¼‰","slug":"æ–¹æ³•ä¸‰-ä½¿ç”¨-propertysource-åŠ è½½è‡ªå®šä¹‰-yaml-æ–‡ä»¶","link":"#æ–¹æ³•ä¸‰-ä½¿ç”¨-propertysource-åŠ è½½è‡ªå®šä¹‰-yaml-æ–‡ä»¶","children":[]},{"level":3,"title":"æ–¹æ³•å››ï¼šé€šè¿‡ Environment æ¥å£ï¼ˆåŠ¨æ€è·å–ï¼‰","slug":"æ–¹æ³•å››-é€šè¿‡-environment-æ¥å£-åŠ¨æ€è·å–","link":"#æ–¹æ³•å››-é€šè¿‡-environment-æ¥å£-åŠ¨æ€è·å–","children":[]}]}],"git":{"createdTime":1771237270000,"updatedTime":1771237270000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/é»‘é©¬å•†åŸ/å¾®æœåŠ¡/5.å¾®æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰.md"}');export{m as comp,g as data};
