import{ar as o,as as l,ax as t,au as a,av as s,aw as e,ay as c,at as i}from"./app-DXmPnZac.js";const u={},r={href:"https://www.elastic.co/guide/cn/elasticsearch/guide/current/_talking_to_elasticsearch.html",target:"_blank",rel:"noopener noreferrer"},d={href:"https://release.infinilabs.com/analysis-ik/stable/",target:"_blank",rel:"noopener noreferrer"},k={href:"http://192.168.0.200:5601/app/dev_tools#/console",target:"_blank",rel:"noopener noreferrer"},v={href:"https://www.elastic.co/docs/reference/elasticsearch/clients/java",target:"_blank",rel:"noopener noreferrer"};function g(m,n){const p=c("ExternalLinkIcon");return i(),l("div",null,[n[14]||(n[14]=t('<p>Elasticsearch（简称 ES）是一种分布式、可扩展、实时的搜索与分析引擎，基于 Apache Lucene 构建。它之所以被广泛采用，是因为在现代应用中，传统的数据库（如关系型数据库）在处理<strong>全文搜索</strong>、<strong>高并发查询</strong>、<strong>大规模数据分析</strong>等场景时存在明显局限。</p><table><thead><tr><th style="text-align:left;">需求/痛点</th><th style="text-align:left;">传统数据库的局限</th><th style="text-align:left;">Elasticsearch 的优势</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>全文搜索</strong></td><td style="text-align:left;">不支持分词、<strong>模糊</strong>匹配弱、性能差</td><td style="text-align:left;">支持分词、高亮、相关性排序、毫秒级响应</td></tr><tr><td style="text-align:left;"><strong>大数据量</strong>查询</td><td style="text-align:left;">查询慢，难以扩展</td><td style="text-align:left;">分布式架构，水平扩展，TB 级数据快速检索</td></tr><tr><td style="text-align:left;"><strong>实时性</strong>要求</td><td style="text-align:left;">写入后无法立即查询</td><td style="text-align:left;">近实时索引（默认1秒内可查）</td></tr><tr><td style="text-align:left;"><strong>非结构化</strong>数据处理</td><td style="text-align:left;">难以存储和查询日志、文本等</td><td style="text-align:left;">原生支持 JSON、文本、日志等半/非结构化数据</td></tr><tr><td style="text-align:left;"><strong>数据分析与聚合</strong></td><td style="text-align:left;">聚合复杂、性能低</td><td style="text-align:left;">强大的聚合功能，支持多维实时分析</td></tr><tr><td style="text-align:left;">高可用与容错</td><td style="text-align:left;">需额外配置主从、备份</td><td style="text-align:left;">自动分片+副本，节点故障自动恢复</td></tr><tr><td style="text-align:left;">生态集成</td><td style="text-align:left;">日志、监控需自建系统</td><td style="text-align:left;">与 Logstash、Kibana、Beats 等无缝集成（ELK）</td></tr></tbody></table><blockquote><p>✅ <strong>一句话总结</strong>：当你的应用需要“快、准、全”的搜索或实时分析能力时，Elasticsearch 是理想选择。</p></blockquote><p><strong>主要应用场景：</strong></p><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">电商搜索</td><td style="text-align:left;">商品关键词搜索、筛选、排序、推荐</td></tr><tr><td style="text-align:left;">日志分析</td><td style="text-align:left;">收集服务器/应用日志，快速排查问题</td></tr><tr><td style="text-align:left;">企业知识库</td><td style="text-align:left;">快速检索文档、邮件、FAQ</td></tr><tr><td style="text-align:left;">监控告警</td><td style="text-align:left;">实时分析指标，触发异常告警</td></tr><tr><td style="text-align:left;">地理位置服务</td><td style="text-align:left;">查找附近门店、路线规划</td></tr></tbody></table>',5)),a("p",null,[n[1]||(n[1]=s("官方说明文档：",-1)),a("a",r,[n[0]||(n[0]=s("和 Elasticsearch 交互 | Elasticsearch: 权威指南 | Elastic",-1)),e(p)])]),n[15]||(n[15]=t(`<p><strong>ELK组合：</strong></p><table><thead><tr><th style="text-align:left;">组件</th><th style="text-align:left;">全称</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>E</strong></td><td style="text-align:left;"><strong>Elasticsearch</strong></td><td style="text-align:left;">分布式搜索和分析引擎，用于<strong>存储</strong>、<strong>索引</strong>和快速<strong>查询</strong>日志数据</td></tr><tr><td style="text-align:left;"><strong>L</strong></td><td style="text-align:left;"><strong>Logstash</strong></td><td style="text-align:left;"><strong>数据收集</strong>、处理和传输管道，支持从多种来源采集、过滤、转换并发送到 Elasticsearch</td></tr><tr><td style="text-align:left;"><strong>K</strong></td><td style="text-align:left;"><strong>Kibana</strong></td><td style="text-align:left;"><strong>可视化界面</strong>，用于查询、分析、展示 Elasticsearch 中的数据（如图表、仪表盘）</td></tr></tbody></table><blockquote><p>近年来，<strong>Beats</strong>（轻量级数据采集器）常被加入，形成 <strong>ELK + Beats</strong> 或称为 <strong>Elastic Stack</strong>。</p></blockquote><h2 id="配置与安装" tabindex="-1"><a class="header-anchor" href="#配置与安装"><span>配置与安装</span></a></h2><p>用docker安装部署就非常简单：</p><div class="language-Bash line-numbers-mode" data-highlighter="prismjs" data-ext="Bash" data-title="Bash"><pre><code><span class="line">docker run -d \\</span>
<span class="line">  --name es \\</span>
<span class="line">  -e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot; \\</span>
<span class="line">  -e &quot;discovery.type=single-node&quot; \\</span>
<span class="line">  -v es-data:/usr/share/elasticsearch/data \\</span>
<span class="line">  -v es-plugins:/usr/share/elasticsearch/plugins \\</span>
<span class="line">  --privileged \\</span>
<span class="line">  --network hm-net \\</span>
<span class="line">  -p 9200:9200 \\</span>
<span class="line">  -p 9300:9300 \\</span>
<span class="line">  elasticsearch:7.12.1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>被墙就去找tar包资源使用：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> load <span class="token parameter variable">-i</span> <span class="token punctuation">[</span>tar包名称<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>来实现镜像获取</p></blockquote><p>kibana也是同理：</p><div class="language-Bash line-numbers-mode" data-highlighter="prismjs" data-ext="Bash" data-title="Bash"><pre><code><span class="line">docker run -d \\</span>
<span class="line">--name kibana \\</span>
<span class="line">-e ELASTICSEARCH_HOSTS=http://es:9200 \\</span>
<span class="line">--network=hm-net \\</span>
<span class="line">-p 5601:5601  \\</span>
<span class="line">kibana:7.12.1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意参数ELASTICSEARCH_HOSTS里之所以可以直接写es作为ip是因为在同一网桥中，可以直接写docker的<strong>容器名称</strong></p></blockquote><p>我们可以基于kibana发送<strong>http请求</strong>来实现对es的操作</p><h2 id="简要认识es" tabindex="-1"><a class="header-anchor" href="#简要认识es"><span>简要认识ES</span></a></h2><table><thead><tr><th style="text-align:left;">机制</th><th style="text-align:left;">作用</th><th style="text-align:left;">关键特点</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>倒排索引</strong></td><td style="text-align:left;">支持全文搜索</td><td style="text-align:left;">词项 → 文档映射，毫秒级检索</td></tr><tr><td style="text-align:left;"><strong>分片与副本</strong></td><td style="text-align:left;">水平扩展 + 高可用</td><td style="text-align:left;">数据自动分布，并行查询，故障容错</td></tr><tr><td style="text-align:left;"><strong>近实时（NRT）</strong></td><td style="text-align:left;">快速可见写入数据</td><td style="text-align:left;">默认 1 秒可搜，平衡性能与实时性</td></tr><tr><td style="text-align:left;"><strong>分布式协调</strong></td><td style="text-align:left;">集群一致性管理</td><td style="text-align:left;">自动主节点选举，防脑裂（7.0+ 基于 Raft）</td></tr><tr><td style="text-align:left;"><strong>相关性评分</strong></td><td style="text-align:left;">智能排序结果</td><td style="text-align:left;">默认 BM25 算法，按 <code>_score</code> 排序</td></tr></tbody></table><h3 id="基础概念" tabindex="-1"><a class="header-anchor" href="#基础概念"><span>基础概念</span></a></h3><p>es中数据以文档为一个基础存储单位（类似数据行），存储形式是json：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;大份&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">100</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>对比关系型数据库的数据行记录：</strong></p><table><thead><tr><th style="text-align:left;">MySQL（关系型数据库）</th><th style="text-align:left;">Elasticsearch（文档搜索引擎）</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Table（表）</strong></td><td style="text-align:left;"><strong>Index（索引）</strong></td><td style="text-align:left;">索引是<strong>文档的集合</strong>，类似数据库中的“表”。例如：<code>products</code> 索引。</td></tr><tr><td style="text-align:left;"><strong>Row（行）</strong></td><td style="text-align:left;"><strong>Document（文档）</strong></td><td style="text-align:left;">每条数据是一个 JSON 文档，相当于一行记录。如 <code>{ &quot;id&quot;: 2, &quot;title&quot;: &quot;华为手机&quot;, &quot;price&quot;: 4999 }</code>。</td></tr><tr><td style="text-align:left;"><strong>Column（列）</strong></td><td style="text-align:left;"><strong>Field（字段）</strong></td><td style="text-align:left;">文档中的键值对，如 <code>title</code>、<code>price</code>，对应数据库的列。</td></tr><tr><td style="text-align:left;"><strong>Schema（表结构）</strong></td><td style="text-align:left;"><strong>Mapping（映射）</strong></td><td style="text-align:left;">定义字段的数据类型（如 text、keyword、date），控制如何存储和搜索。类似于数据库的 schema。</td></tr><tr><td style="text-align:left;"><strong>SQL（查询语言）</strong></td><td style="text-align:left;"><strong>DSL（Domain Specific Language）</strong></td><td style="text-align:left;">Elasticsearch 使用基于 JSON 的 DSL 查询语法，功能强大，支持全文检索、聚合分析等。</td></tr></tbody></table><p>mapping映射：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT /products</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>补充：</p><table><thead><tr><th style="text-align:left;">概念</th><th style="text-align:left;">详细解释</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>JSON 文档</strong></td><td style="text-align:left;">ES 中所有数据以 JSON 格式存储，支持嵌套结构、数组等复杂类型。</td></tr><tr><td style="text-align:left;"><strong>动态映射</strong></td><td style="text-align:left;">默认情况下，ES 会自动推断字段类型（如 string → text/keyword），也可手动定义 mapping。</td></tr><tr><td style="text-align:left;"><strong>无严格 Schema</strong></td><td style="text-align:left;">可插入不同结构的文档到同一个索引（但建议统一结构）。</td></tr><tr><td style="text-align:left;"><strong>分片与副本</strong></td><td style="text-align:left;">ES 支持水平扩展，一个索引可拆分为多个分片（shard），并设置副本（replica）保证高可用。</td></tr></tbody></table><h3 id="倒排索引" tabindex="-1"><a class="header-anchor" href="#倒排索引"><span>倒排索引</span></a></h3><p><strong>倒排索引（Inverted Index）</strong> 是搜索引擎（如 Elasticsearch、Lucene）和信息检索系统中最核心的数据结构。它的设计目标是：<strong>根据关键词快速找到包含该词的文档</strong>。</p><p>传统数据库比如mysql的InnoDB在进行诸如模糊查找的时候一般都是<strong>全表扫描</strong>，一旦表中数据量过大查询速度就会非常慢（不使用索引的情况下），为什么会需要全表扫描？</p><blockquote><p>每一行数据我们称为<strong>文档doc</strong>，按语义切分的数据称之为<strong>词条term</strong></p></blockquote><ul><li><strong>正排索引（传统数据库）</strong>： <code>文档ID → 内容</code> 例如：Doc1 → “苹果 香蕉 橙子”</li></ul><p>​ 这时候我们无法从搜索内容<strong>直接导向</strong>某个含该内容的数据项，这时候我们就必须<strong>一个一个</strong>提取数据项，进行比较看是否含搜索内容。</p><ul><li><strong>倒排索引（搜索引擎）</strong>： <code>关键词 → 包含该词的文档列表</code> 例如： <ul><li>“苹果” → [Doc1, Doc3]</li><li>“香蕉” → [Doc1, Doc2]</li></ul></li></ul><blockquote><p>✅ 这就是“倒排”——把常规的“文档找词”反过来变成“词找文档”。</p></blockquote><p>也即es对数据的索引不仅仅是对数据的排序，还<strong>对某一项数据内部的词条做了一个统计索引</strong>，这样的应用场景：</p><table><thead><tr><th style="text-align:left;">场景</th><th style="text-align:left;">传统方式（如 SQL LIKE）</th><th style="text-align:left;">倒排索引</th></tr></thead><tbody><tr><td style="text-align:left;">全文搜索</td><td style="text-align:left;">全表扫描，O(N) 慢</td><td style="text-align:left;">直接查词典，O(1) 快</td></tr><tr><td style="text-align:left;">大数据量</td><td style="text-align:left;">性能急剧下降</td><td style="text-align:left;">分布式+压缩，轻松应对 TB 级</td></tr><tr><td style="text-align:left;">高级功能</td><td style="text-align:left;">不支持分词、高亮、相关性</td><td style="text-align:left;">支持分词、短语匹配、评分、高亮等</td></tr></tbody></table><h3 id="ik分词器" tabindex="-1"><a class="header-anchor" href="#ik分词器"><span>IK分词器</span></a></h3><p>先前我们提到了es通过给某一列数据进行<strong>关键词统计索引</strong>，用这种方式来实现了<strong>关键词快速匹配</strong>的搜索，那么我们要怎么拆分数据，分出精确的关键词呢？</p><p><strong>IK 分词器（IK Analyzer）</strong> 是 Elasticsearch 中最常用的 <strong>中文分词插件</strong>，专为中文文本设计，支持<strong>细粒度切分（ik_max_word）</strong> 和 <strong>智能粗粒度切分（ik_smart）</strong> 两种模式。</p><p>Elasticsearch 默认使用 <strong>Standard Analyzer</strong>，它按空格和标点切分，对中文效果极差：</p><ul><li>输入：<code>&quot;中华人民共和国成立75周年&quot;</code></li><li>Standard 分词结果：<code>[&quot;中华人民共和国成立75周年&quot;]</code>（整个句子当一个词！）</li></ul><p>而 IK 能正确切分为：</p><ul><li><code>ik_smart</code> → <code>[&quot;中华人民共和国&quot;, &quot;成立&quot;, &quot;75&quot;, &quot;周年&quot;]</code></li><li><code>ik_max_word</code> → 更细，如 <code>[&quot;中华&quot;, &quot;华人&quot;, &quot;人民&quot;, &quot;共和国&quot;, &quot;成立&quot;, &quot;75&quot;, &quot;周年&quot;, ...]</code></li></ul><blockquote><p>✅ 中文没有天然分隔符，必须依赖专业分词器，IK 就是为此而生。</p></blockquote><table><thead><tr><th style="text-align:left;">模式</th><th style="text-align:left;">特点</th><th style="text-align:left;">适用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong><code>ik_smart</code></strong></td><td style="text-align:left;"><strong>最少切分</strong>，语义完整，词数少</td><td style="text-align:left;">搜索（避免过度拆分导致噪声）</td></tr><tr><td style="text-align:left;"><strong><code>ik_max_word</code></strong></td><td style="text-align:left;"><strong>最细切分</strong>，穷尽所有可能词</td><td style="text-align:left;">索引（提高召回率）</td></tr></tbody></table><p><strong>安装IK分词器：</strong></p><p><strong>方式一：在线安装：</strong></p><div class="language-Shell line-numbers-mode" data-highlighter="prismjs" data-ext="Shell" data-title="Shell"><pre><code><span class="line">docker exec -it es ./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>然后重启即可：</p><div class="language-Shell line-numbers-mode" data-highlighter="prismjs" data-ext="Shell" data-title="Shell"><pre><code><span class="line">docker restart es</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>方式二：离线安装：</strong></p><p>先前我们指定了一个数据卷<code>es-plugins</code>让docker帮我们专门维护在es的插件文件夹：</p><div class="language-Shell line-numbers-mode" data-highlighter="prismjs" data-ext="Shell" data-title="Shell"><pre><code><span class="line">docker volume inspect es-plugins</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"></span>
<span class="line"><span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;CreatedAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2026-02-12T16:55:08+08:00&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Driver&quot;</span><span class="token operator">:</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Labels&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Mountpoint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/var/lib/docker/volumes/es-plugins/_data&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es-plugins&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Options&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;local&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>来到数据卷文件夹：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token builtin class-name">cd</span> /var/lib/docker/volumes/es-plugins/_data</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>将离线获取到的IK分词器文件传入其中，然后重启加载插件：</p>`,53)),a("blockquote",null,[a("p",null,[n[3]||(n[3]=s("es插件下载地址：",-1)),a("a",d,[n[2]||(n[2]=s("Index of: analysis-ik/stable/",-1)),e(p)]),n[4]||(n[4]=s("（记得对照版本）",-1))])]),n[16]||(n[16]=t(`<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> restart es</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr>`,2)),a("p",null,[n[6]||(n[6]=s("然后我们简单尝试一下，打开kibana的dev界面：",-1)),a("a",k,[n[5]||(n[5]=s("Dev Tools - Elastic",-1)),e(p)]),n[7]||(n[7]=s("，输入测试样例：",-1))]),n[17]||(n[17]=t(`<div class="language-cmd line-numbers-mode" data-highlighter="prismjs" data-ext="cmd" data-title="cmd"><pre><code><span class="line">POST /_analyze</span>
<span class="line">{</span>
<span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span>
<span class="line">  &quot;text&quot;: &quot;黑马程序员学习java太棒了&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后会发现standard级别的分词器全部字符都被分开了，这显然太一般，我们换成ik_smart：</p><div class="language-cmd line-numbers-mode" data-highlighter="prismjs" data-ext="cmd" data-title="cmd"><pre><code><span class="line">POST /_analyze</span>
<span class="line">{</span>
<span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span>
<span class="line">  &quot;text&quot;: &quot;黑马程序员学习java太棒了&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>得到结果：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;黑马&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;程序员&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;学习&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ENGLISH&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">3</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;太棒了&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">4</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是只是将一个句子直接几刀切完也不太行，对于一个词其实可以再做精细化，比如”程序员“还可以再分出“程序”来，这时候我们可以选择<code>ik_max_word</code>级别的：</p><div class="language-cmd line-numbers-mode" data-highlighter="prismjs" data-ext="cmd" data-title="cmd"><pre><code><span class="line">POST /_analyze</span>
<span class="line">{</span>
<span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span>
<span class="line">  &quot;text&quot;: &quot;黑马程序员学习java太棒了&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>得到结果：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;黑马&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;程序员&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;程序&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;员&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">3</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;学习&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">4</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ENGLISH&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">5</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;太棒了&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">6</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;太棒&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">7</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;了&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">8</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有时候三种分词模式都是不够用的，我们还需要额外的扩展词典，打开我们的<strong>ik插件文件夹</strong>，找到<strong>config</strong>目录的<code>IKAnalyzer.cfg.xml</code>文件进行配置：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	 <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们准备一个额外扩展词汇字典<code>ext.dic</code>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">挖掘机</span>
<span class="line">大萨达</span>
<span class="line">啊发顺丰</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只需<strong>按行输入</strong>所需要的词汇即可。</p><p>然后配置到cfg的xml文件中：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ext.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	 <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span>
<span class="line">	<span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后重启加载配置即可。</p><h2 id="数据操作" tabindex="-1"><a class="header-anchor" href="#数据操作"><span>数据操作</span></a></h2><h3 id="mapping映射" tabindex="-1"><a class="header-anchor" href="#mapping映射"><span>Mapping映射</span></a></h3><p>先前我们提到将同一类（字段名，类型一致）的文档（json数据）归为同一个索引（库），这种归为同一索引的判断就是映射Mapping：</p><p><strong>Mapping（映射）</strong> 是 Elasticsearch 中定义<strong>索引中文档结构和字段数据类型</strong>的核心机制，相当于关系型数据库中的 <strong>表结构（Schema）</strong>。它决定了：</p><ul><li>字段以什么类型存储（文本？数字？日期？地理位置？）</li><li>字段是否可被搜索、排序或聚合</li><li>使用哪种分词器（如 <code>ik_max_word</code>、<code>standard</code>）</li><li>是否启用倒排索引、是否存储原始值等</li></ul><p>基本数据类型：</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">用途</th><th style="text-align:left;">特点</th></tr></thead><tbody><tr><td style="text-align:left;"><strong><code>text</code></strong></td><td style="text-align:left;">全文搜索（如文章内容、商品描述）</td><td style="text-align:left;"><strong>会被分词</strong>，<strong>不可用于排序/聚合</strong></td></tr><tr><td style="text-align:left;"><strong><code>keyword</code></strong></td><td style="text-align:left;">精确值（如标签、状态、ID）</td><td style="text-align:left;"><strong>不分词</strong>，<strong>可用于排序、聚合、精确匹配</strong></td></tr><tr><td style="text-align:left;"><strong><code>integer</code> / <code>long</code> / <code>float</code> / <code>double</code></strong></td><td style="text-align:left;">数值</td><td style="text-align:left;">支持范围查询、聚合计算</td></tr><tr><td style="text-align:left;"><strong><code>date</code></strong></td><td style="text-align:left;">日期时间</td><td style="text-align:left;">可指定格式（如 <code>&quot;yyyy-MM-dd&quot;</code>），支持时间范围查询</td></tr><tr><td style="text-align:left;"><strong><code>boolean</code></strong></td><td style="text-align:left;">布尔值</td><td style="text-align:left;"><code>true</code> / <code>false</code></td></tr><tr><td style="text-align:left;"><strong><code>geo_point</code></strong></td><td style="text-align:left;">地理位置</td><td style="text-align:left;">支持“附近搜索”、地理距离聚合</td></tr><tr><td style="text-align:left;"><strong><code>nested</code></strong></td><td style="text-align:left;">嵌套对象数组</td><td style="text-align:left;">解决对象数组的“扁平化”问题</td></tr><tr><td style="text-align:left;"><strong><code>object</code></strong></td><td style="text-align:left;">普通对象（默认）</td><td style="text-align:left;">内部字段可独立查询</td></tr></tbody></table><blockquote><p>💡 <strong><code>text</code> vs <code>keyword</code> 是最常混淆的点！</strong></p><ul><li>想搜“手机” → 用 <code>text</code></li><li>想按“品牌=华为”筛选或统计 → 用 <code>keyword</code></li></ul></blockquote><p>举个创建映射的例子：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT /my_index</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> </span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;float&quot;</span> </span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;publish_date&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>mysql之类的传统数据库定义完了一个<strong>表的结构scheme</strong>，也即创建完成了一个<strong>表</strong>： 这里也是一样的，完成定义一个<strong>索引的映射Mapping</strong>即创建了一个<strong>索引（库）</strong>，名字是my_index</p><table><thead><tr><th style="text-align:left;">操作</th><th style="text-align:left;">MySQL</th><th style="text-align:left;">Elasticsearch</th></tr></thead><tbody><tr><td style="text-align:left;">创建表结构</td><td style="text-align:left;"><code>CREATE TABLE t (id INT, name VARCHAR(100));</code></td><td style="text-align:left;"><code>PUT /t { &quot;mappings&quot;: { &quot;properties&quot;: { &quot;id&quot;: { &quot;type&quot;: &quot;integer&quot; }, &quot;name&quot;: { &quot;type&quot;: &quot;text&quot; } } } }</code></td></tr><tr><td style="text-align:left;">只建库不建表</td><td style="text-align:left;"><code>CREATE DATABASE db;</code></td><td style="text-align:left;"><code>PUT /index</code>（无 mapping，相当于“空表”）</td></tr></tbody></table><p>所以：<strong>定义 mapping 就像 <code>CREATE TABLE</code>，它隐含了“创建存储结构”这一步。</strong></p></blockquote><p>类似json，存储单元文档也可以有子字段：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;keyword&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>甚至还可以根据子字段的属性进行搜索：</p><ul><li>搜索用：<code>title</code>（分词全文搜）</li><li>聚合用：<code>title.keyword</code>（精确值）</li></ul><h3 id="索引库操作" tabindex="-1"><a class="header-anchor" href="#索引库操作"><span>索引库操作</span></a></h3><table><thead><tr><th><strong>操作</strong></th><th><strong>API</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>创建索引</strong></td><td><code>PUT /index_name</code></td><td><strong>创建新索引，可带 mapping</strong></td></tr><tr><td>查看索引</td><td><code>GET /index_name</code></td><td><strong>查看索引是否存在及状态</strong></td></tr><tr><td><strong>查看映射</strong></td><td><code>GET /index_name/_mapping</code></td><td><strong>查看字段结构</strong></td></tr><tr><td>删除索引</td><td><code>DELETE /index_name</code></td><td><strong>删除整个索引（不可逆）</strong></td></tr><tr><td><strong>更新映射</strong></td><td><code>PUT /index_name/_mapping</code></td><td><strong>只能新增字段，不能修改已有字段类型</strong></td></tr><tr><td><strong>插入文档</strong></td><td><code>POST /index_name/_doc/1</code></td><td><strong>写入一条数据</strong></td></tr><tr><td>查询文档</td><td><code>GET /index_name/_doc/1</code></td><td><strong>获取指定文档</strong></td></tr><tr><td>批量操作</td><td><code>POST /_bulk</code></td><td><strong>批量插入/更新/删除文档</strong></td></tr></tbody></table><blockquote><p>接口以RESTful风格设计CRUD：</p><p>增：POST 删：DELETE 改/增：PUT 查：GET</p></blockquote><p><strong>示例：</strong></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT /索引库名称</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;字段名&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;字段名2&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;false&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;字段名3&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;子字段&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token comment">// 其他字段...  </span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="文档操作" tabindex="-1"><a class="header-anchor" href="#文档操作"><span>文档操作</span></a></h3><table><thead><tr><th style="text-align:left;"><strong>操作</strong></th><th style="text-align:left;"><strong>API</strong></th><th style="text-align:left;"><strong>说明</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>插入文档</strong></td><td style="text-align:left;"><code>POST /index_name/_doc</code></td><td style="text-align:left;">自动生成 <code>_id</code>，插入新文档（若 id 冲突则报错）</td></tr><tr><td style="text-align:left;"><strong>指定 ID 插入</strong></td><td style="text-align:left;"><code>PUT /index_name/_doc/123</code></td><td style="text-align:left;">使用指定 ID 插入文档；若已存在则<strong>全量覆盖</strong></td></tr><tr><td style="text-align:left;"><strong>更新文档</strong></td><td style="text-align:left;"><code>POST /index_name/_update/123</code></td><td style="text-align:left;"><strong>局部更新</strong>（只改部分字段），需传 <code>{&quot;doc&quot;: {...}}</code></td></tr><tr><td style="text-align:left;"><strong>查询文档</strong></td><td style="text-align:left;"><code>GET /index_name/_doc/123</code></td><td style="text-align:left;">根据 <code>_id</code> 获取完整文档（含 <code>_source</code> 和元数据）</td></tr><tr><td style="text-align:left;"><strong>删除文档</strong></td><td style="text-align:left;"><code>DELETE /index_name/_doc/123</code></td><td style="text-align:left;">根据 <code>_id</code> 删除指定文档（软删除，可被 refresh 清理）</td></tr><tr><td style="text-align:left;"><strong>批量操作</strong></td><td style="text-align:left;"><code>POST /_bulk</code></td><td style="text-align:left;">一次请求执行多条操作（index/create/update/delete），提升写入效率</td></tr><tr><td style="text-align:left;"><strong>检查文档是否存在</strong></td><td style="text-align:left;"><code>HEAD /index_name/_doc/123</code></td><td style="text-align:left;">仅返回 HTTP 状态码（200 存在，404 不存在），不返回 body</td></tr><tr><td style="text-align:left;"><strong>替换文档（强制）</strong></td><td style="text-align:left;"><code>PUT /index_name/_doc/123?version=5</code></td><td style="text-align:left;">基于版本号的<strong>乐观锁更新</strong>，防止并发覆盖</td></tr><tr><td style="text-align:left;"><strong>获取多个文档</strong></td><td style="text-align:left;"><code>POST /_mget</code></td><td style="text-align:left;">批量按 ID 获取多个文档（支持跨索引）</td></tr><tr><td style="text-align:left;"><strong>脚本更新</strong></td><td style="text-align:left;"><code>POST /index_name/_update/123</code> <code>{ &quot;script&quot;: &quot;ctx._source.counter += 1&quot; }</code></td><td style="text-align:left;">使用 Painless 脚本动态修改字段值</td></tr></tbody></table><blockquote><p>这里我们可以看出es的排序并不是只有<strong>倒序的词条索引</strong>的，像传统数据库的<strong>id顺序排序</strong>也是有的</p></blockquote><p><strong>插入示例：</strong></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST /products/_doc</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为 Mate 60 Pro 智能手机&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">6999.0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;in_stock&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-08-20 10:30:00&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>定向插入示例：</strong>（指定了ID时：<strong>POST</strong>为轻量修改未写明不改；<strong>PUT</strong>为全量修改）</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT /products/_doc/<span class="token number">1001</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小米 14 Ultra 相机手机&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">5999.0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;in_stock&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2024-08-21&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="批量操作" tabindex="-1"><a class="header-anchor" href="#批量操作"><span>批量操作</span></a></h3><p><strong>批量处理（Bulk API）</strong> 是 Elasticsearch 中<strong>高效写入、更新或删除大量文档的核心机制</strong>。它通过<strong>单次 HTTP 请求</strong>完成多个操作，极大提升吞吐量、降低网络开销，是日志导入、数据迁移、初始化等场景的首选方式。</p><table><thead><tr><th style="text-align:left;">方式</th><th style="text-align:left;">每次请求操作数</th><th style="text-align:left;">网络开销</th><th style="text-align:left;">性能</th></tr></thead><tbody><tr><td style="text-align:left;">单条插入</td><td style="text-align:left;">1 条</td><td style="text-align:left;">高（N 次请求）</td><td style="text-align:left;">低</td></tr><tr><td style="text-align:left;"><strong>Bulk 批量</strong></td><td style="text-align:left;"><strong>多条（如 1000 条）</strong></td><td style="text-align:left;"><strong>低（1 次请求）</strong></td><td style="text-align:left;"><strong>高（提升 10~100 倍）</strong></td></tr></tbody></table><blockquote><table><thead><tr><th style="text-align:left;">批处理操作</th><th style="text-align:left;">Redis Pipeline</th><th><strong>Elasticsearch Bulk API</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>本质</strong></td><td style="text-align:left;"><strong>网络请求优化技术</strong></td><td><strong>批量文档操作协议</strong></td></tr><tr><td style="text-align:left;"><strong>目的</strong></td><td style="text-align:left;">减少网络往返（RTT），提升吞吐</td><td>一次请求处理多个写入/更新/删除操作</td></tr><tr><td style="text-align:left;"><strong>是否改变数据处理逻辑</strong></td><td style="text-align:left;">❌ 否（只是打包发送命令）</td><td>✅ 是（ES 内部会批量索引、合并段等）</td></tr><tr><td style="text-align:left;"><strong>类比</strong></td><td style="text-align:left;">把 100 条短信合并成 1 次发出去</td><td>把 100 个包裹交给快递公司统一处理</td></tr></tbody></table><p>🔁 <strong>共同点</strong>：都通过“<strong>减少请求次数</strong>”来提升性能。 ⚠️ <strong>关键区别</strong>：Redis Pipeline <strong>不改变命令语义</strong>，而 ES Bulk <strong>是一个独立的 API 协议</strong>。</p></blockquote><p>主要操作：</p><table><thead><tr><th style="text-align:left;">操作</th><th style="text-align:left;">说明</th><th style="text-align:left;">是否需要数据行</th></tr></thead><tbody><tr><td style="text-align:left;"><code>index</code></td><td style="text-align:left;">插入或<strong>全量替换</strong>文档</td><td style="text-align:left;">✅ 需要</td></tr><tr><td style="text-align:left;"><code>create</code></td><td style="text-align:left;">仅当文档不存在时插入（类似 PUT with version=0）</td><td style="text-align:left;">✅ 需要</td></tr><tr><td style="text-align:left;"><code>update</code></td><td style="text-align:left;"><strong>局部更新</strong>文档（需 <code>doc</code> 或 <code>script</code>）</td><td style="text-align:left;">✅ 需要</td></tr><tr><td style="text-align:left;"><code>delete</code></td><td style="text-align:left;">删除文档</td><td style="text-align:left;">❌ 不需要</td></tr></tbody></table><p>示例：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST _bulk</span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value1&quot;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;delete&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;field1&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value3&quot;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;update&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;doc&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;field2&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="javarestclient" tabindex="-1"><a class="header-anchor" href="#javarestclient"><span>JavaRestClient</span></a></h2><h3 id="安装与配置" tabindex="-1"><a class="header-anchor" href="#安装与配置"><span>安装与配置</span></a></h3><p>官方文档：https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/installation.html</p>`,55)),a("blockquote",null,[a("p",null,[n[9]||(n[9]=s("注意版本对应说明：",-1)),a("a",v,[n[8]||(n[8]=s("Java | Java",-1)),e(p)]),n[10]||(n[10]=s("，8.0开始就用不了",-1)),n[11]||(n[11]=a("strong",null,"RestHighLevelClient",-1)),n[12]||(n[12]=s("了，改用推荐的JavaApi：",-1))]),n[13]||(n[13]=t('<table><thead><tr><th style="text-align:left;">客户端</th><th style="text-align:left;">全称 / 坐标</th><th style="text-align:left;">状态</th><th style="text-align:left;">推出时间</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>RestHighLevelClient (RHLC)</strong></td><td style="text-align:left;"><code>org.elasticsearch.client:elasticsearch-rest-high-level-client</code></td><td style="text-align:left;">❌ <strong>已废弃（Deprecated）</strong> 自 ES 7.15 起标记废弃 <strong>ES 8.0+ 完全移除</strong></td><td style="text-align:left;">2018 年（ES 6.0 引入）</td></tr><tr><td style="text-align:left;"><strong>Java API Client</strong></td><td style="text-align:left;"><code>co.elastic.clients:elasticsearch-java</code></td><td style="text-align:left;">✅ <strong>官方推荐新客户端</strong> 专为 ES 7.16+ / 8.x+ 设计</td><td style="text-align:left;">2021 年（ES 7.16 首发）</td></tr></tbody></table><p>💡 <strong>Elastic 官方明确表示：RHLC 已死，新项目必须用 <code>elasticsearch-java</code>。</strong></p>',2))]),n[18]||(n[18]=t(`<p>其实SpringBoot依赖管理内部维护了很多第三方数据库的client版本（Redis，Mysql，MongoDB等等），只要我们引入/继承了SpringBootDependencies就可以不用声明版本直接引用对应的client。</p><blockquote><p><code>spring-boot-starter-parent</code>继承<code>spring-boot-dependencies</code>，可在dependencies的pom文件里查看当前版本关系</p></blockquote><p>注意<strong>es的client</strong>的版本和<strong>es</strong>的版本是<strong>完全一致</strong>的，我们到dependency里看到2.7.12版本SpringBoot的esClient默认版本是：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.17.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这时候我们就要手动调整一下了，只需要到<strong>父pom</strong>中修改一下设置：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>即可完成版本覆盖。</p><blockquote><p>注意<strong>不要直接在子项目的pom的dependency中修改version</strong>，会被dependencyManagement覆盖：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.17.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- ⚠️ 这行会被忽略！ --&gt;</span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尽量在父pom的properties中修改：</p><div class="language-XML line-numbers-mode" data-highlighter="prismjs" data-ext="XML" data-title="XML"><pre><code><span class="line">&lt;!-- 这里是父pom --&gt;  </span>
<span class="line">&lt;properties&gt;</span>
<span class="line">      &lt;maven.compiler.source&gt;11&lt;/maven.compiler.source&gt;</span>
<span class="line">      &lt;maven.compiler.target&gt;11&lt;/maven.compiler.target&gt;</span>
<span class="line">      &lt;elasticsearch.version&gt;7.12.1&lt;/elasticsearch.version&gt;</span>
<span class="line">&lt;/properties&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IDEA可以在右侧maven管理器检查子项目的依赖项版本是否正确</p></blockquote><p>然后我们就可以配置esClient的Bean实例了：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost</span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span></span>
<span class="line">  <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http</span>
<span class="line">  <span class="token comment"># 如果启用了安全认证（如 xpack）</span></span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> elastic</span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>password</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>⚠️ Spring Boot 2.x <strong>不会自动创建 <code>RestHighLevelClient</code> Bean</strong>！你需要手动配置。</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.host}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.port}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.scheme:http}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> scheme<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.username:#{null}}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.password:#{null}}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">restHighLevelClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpHost</span> httpHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">RestClientBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>httpHost<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 如果配置了用户名和密码，添加 Basic 认证</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">BasicCredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpClientBuilder <span class="token operator">-&gt;</span></span>
<span class="line">                httpClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后就可以注入使用了。</p><blockquote><p>新版本：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">uris</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9200</span></span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> elastic</span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>password</span>
<span class="line">  <span class="token comment"># 或使用 API Key（ES 8 推荐）</span></span>
<span class="line">  <span class="token comment"># api-key: your-api-key-here</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：<strong>Spring Boot 不会自动读取这些配置来创建客户端</strong>！你需要自己写 <code>@Configuration</code>。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.uris}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> esUris<span class="token punctuation">;</span> <span class="token comment">// 格式: http://host:port</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.username:#{null}}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.password:#{null}}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ElasticsearchClient</span> <span class="token function">elasticsearchClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. 解析 URI</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hostPort <span class="token operator">=</span> esUris<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;http://&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> host <span class="token operator">=</span> hostPort<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>hostPort<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 2. 配置认证（可选）</span></span>
<span class="line">        <span class="token class-name">BasicCredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 3. 创建 RestClient</span></span>
<span class="line">        <span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpClientBuilder <span class="token operator">-&gt;</span></span>
<span class="line">                httpClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 4. 创建 Transport</span></span>
<span class="line">        <span class="token class-name">ElasticsearchTransport</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestClientTransport</span><span class="token punctuation">(</span></span>
<span class="line">            restClient<span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token class-name">JacksonJsonpMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 5. 创建并返回 Client</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchClient</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 可选：注册 RestClient 用于关闭资源</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RestClient</span> <span class="token function">restClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hostPort <span class="token operator">=</span> esUris<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;http://&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> host <span class="token operator">=</span> hostPort<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>hostPort<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">BasicCredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>httpClientBuilder <span class="token operator">-&gt;</span></span>
<span class="line">                httpClientBuilder<span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="索引库操作-表" tabindex="-1"><a class="header-anchor" href="#索引库操作-表"><span>索引库操作（表）</span></a></h3><h4 id="创建索引" tabindex="-1"><a class="header-anchor" href="#创建索引"><span>创建索引</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndexWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 设置映射</span></span>
<span class="line">    request<span class="token punctuation">.</span><span class="token function">mapping</span><span class="token punctuation">(</span><span class="token string">&quot;{ \\&quot;properties\\&quot;: { \\&quot;title\\&quot;: { \\&quot;type\\&quot;: \\&quot;text\\&quot; } } }&quot;</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">CreateIndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index creation acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndexWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">CreateIndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">mappings</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> p <span class="token operator">-&gt;</span> p<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index creation acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="删除索引" tabindex="-1"><a class="header-anchor" href="#删除索引"><span>删除索引</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteIndexWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">DeleteIndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index deletion acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteIndexWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">DeleteIndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index deletion acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="判断索引" tabindex="-1"><a class="header-anchor" href="#判断索引"><span>判断索引</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkIndexExistsWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index exists: &quot;</span> <span class="token operator">+</span> exists<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkIndexExistsWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ExistsResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index exists: &quot;</span> <span class="token operator">+</span> exists<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="获取索引映射" tabindex="-1"><a class="header-anchor" href="#获取索引映射"><span>获取索引映射</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getIndexMappingWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">GetMappingsRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMappingsRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    request<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">GetMappingsResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapping</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">MappingMetadata</span> mappingMetadata <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mapping <span class="token operator">=</span> mappingMetadata<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index mapping: &quot;</span> <span class="token operator">+</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getIndexMappingWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">GetMappingResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapping</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">TypeMapping</span> mapping <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Index mapping: &quot;</span> <span class="token operator">+</span> mapping<span class="token punctuation">.</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="更新索引映射" tabindex="-1"><a class="header-anchor" href="#更新索引映射"><span>更新索引映射</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateIndexMappingWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">PutMappingRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutMappingRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">&quot;{ \\&quot;properties\\&quot;: { \\&quot;price\\&quot;: { \\&quot;type\\&quot;: \\&quot;float\\&quot; } } }&quot;</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">PutMappingResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mapping update acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateIndexMappingWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">PutMappingResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> p</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">properties</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> prop <span class="token operator">-&gt;</span> prop<span class="token punctuation">.</span><span class="token function">float32</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Mapping update acknowledged: &quot;</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="获取索引设置" tabindex="-1"><a class="header-anchor" href="#获取索引设置"><span>获取索引设置</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getIndexSettingsWithRHLC</span><span class="token punctuation">(</span><span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">GetSettingsRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetSettingsRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    request<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">GetSettingsResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token class-name">String</span> replicas <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getIndexToSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;index.number_of_replicas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Number of replicas: &quot;</span> <span class="token operator">+</span> replicas<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getIndexSettingsWithNewClient</span><span class="token punctuation">(</span><span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">GetIndexSettingsResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSettings</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">IndexState</span> settings <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> replicas <span class="token operator">=</span> settings<span class="token punctuation">.</span><span class="token function">settings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">numberOfReplicas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Number of replicas: &quot;</span> <span class="token operator">+</span> replicas<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><ul><li><strong>RestHighLevelClient（旧）</strong>： <ul><li>需要手动构建 JSON 字符串，容易出错。</li><li>操作返回的结果需要手动解析为 <code>Map</code> 或其他类型。</li><li>对字段名和类型没有编译时检查。</li></ul></li><li><strong>Java API Client（新）</strong>： <ul><li>使用 DSL 构建器风格，代码更简洁、易读。</li><li>强类型支持，字段名和类型在编译时可以检查。</li><li>直接访问对象属性，减少手动解析的复杂性。</li></ul></li></ul><blockquote><p>其实还是RESTful设计</p></blockquote><h3 id="文档操作-row" tabindex="-1"><a class="header-anchor" href="#文档操作-row"><span>文档操作（row）</span></a></h3><h4 id="插入文档" tabindex="-1"><a class="header-anchor" href="#插入文档"><span>插入文档</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span>		<span class="token comment">// 非必须</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 直接传入 POJO，自动序列化</span></span>
<span class="line"><span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span>	<span class="token comment">// 非必须</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>  <span class="token comment">// ← 强类型，无需手动转 JSON</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="删除文档" tabindex="-1"><a class="header-anchor" href="#删除文档"><span>删除文档</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">DeleteResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">boolean</span> found <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DocWriteResponse<span class="token punctuation">.</span>Result</span><span class="token punctuation">.</span><span class="token constant">DELETED</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">DeleteResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> d</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">boolean</span> found <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DeleteResult<span class="token punctuation">.</span>Deleted</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="更新文档" tabindex="-1"><a class="header-anchor" href="#更新文档"><span>更新文档</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> updates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">updates<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> <span class="token number">5999.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">updates<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;in_stock&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 方式1：使用部分文档（Partial Document）</span></span>
<span class="line"><span class="token class-name">Product</span> updateDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">updateDoc<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">5999.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">updateDoc<span class="token punctuation">.</span><span class="token function">setInStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>u <span class="token operator">-&gt;</span> u</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>updateDoc<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// ← 强类型局部更新</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 方式2：使用脚本（Script）</span></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>u <span class="token operator">-&gt;</span> u</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">script</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">&quot;ctx._source.price += params.increase&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">&quot;increase&quot;</span><span class="token punctuation">,</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="查询文档" tabindex="-1"><a class="header-anchor" href="#查询文档"><span>查询文档</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Product</span> p <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span>  <span class="token comment">// ← 自动反序列化每条结果</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token operator">::</span><span class="token function">source</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="批量插入" tabindex="-1"><a class="header-anchor" href="#批量插入"><span>批量插入</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Product</span> p <span class="token operator">:</span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">BulkResponse</span> bulkResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BulkOperation</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> products<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token class-name">BulkOperation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> o</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment">// ← 直接传 POJO</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   </span>
<span class="line"><span class="token class-name">BulkResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b</span>
<span class="line"> <span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>operations<span class="token punctuation">)</span></span>
<span class="line">   <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><blockquote><p>新版本自动jackson序列化，只要导入对应的jackson包即可</p></blockquote><h2 id="dsl查询" tabindex="-1"><a class="header-anchor" href="#dsl查询"><span>DSL查询</span></a></h2><p>我们先前完成了对于查询数据的准备，现在我们就可以开始享受es的<strong>高速关键词检索</strong>了，之前我们举的例子一般都是单词条查询，可实际生产环境是不会只有一个关键词的查询也不会只有关键词匹配的，这时候就需要复合查询了：</p><p>DSL 是 Elasticsearch 提供的一种 <strong>基于 JSON 的查询语言</strong>，用于表达复杂的搜索、过滤、聚合等操作。它比简单的 URI 查询强大得多。</p><table><thead><tr><th style="text-align:left;">DSL 类型</th><th style="text-align:left;">简要说明</th><th style="text-align:left;">典型使用场景</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>match</strong></td><td style="text-align:left;">全文检索，会对查询文本进行分词后匹配</td><td style="text-align:left;">搜索商品标题、文章内容等可分词字段（如 <code>&quot;手机&quot;</code> 匹配 <code>&quot;智能手机&quot;</code>）</td></tr><tr><td style="text-align:left;"><strong>match_phrase</strong></td><td style="text-align:left;">短语匹配，要求词语按顺序且紧邻出现</td><td style="text-align:left;">精确搜索短语，如 <code>&quot;华为手机&quot;</code> 不匹配 <code>&quot;手机华为&quot;</code></td></tr><tr><td style="text-align:left;"><strong>term</strong></td><td style="text-align:left;">精确值匹配（不分词），用于 keyword、数字、布尔等字段</td><td style="text-align:left;">按分类、状态、ID 精确过滤，如 <code>category.keyword = &quot;Electronics&quot;</code></td></tr><tr><td style="text-align:left;"><strong>terms</strong></td><td style="text-align:left;">多值精确匹配（IN 查询）</td><td style="text-align:left;">查找多个分类或状态，如 <code>status IN [&quot;published&quot;, &quot;draft&quot;]</code></td></tr><tr><td style="text-align:left;"><strong>range</strong></td><td style="text-align:left;">范围查询（数值、日期、字符串）</td><td style="text-align:left;">价格区间（1000~5000）、上架时间（最近30天）、评分（≥4.5）</td></tr><tr><td style="text-align:left;"><strong>exists</strong></td><td style="text-align:left;">判断字段是否存在（非 null 且非空）</td><td style="text-align:left;">过滤有图片的商品（<code>image_url exists</code>）</td></tr><tr><td style="text-align:left;"><strong>bool</strong></td><td style="text-align:left;">组合多个查询，支持 must / should / must_not / filter</td><td style="text-align:left;">复杂条件：必须包含关键词 + 价格在范围内 + 排除下架商品</td></tr><tr><td style="text-align:left;"><strong>wildcard</strong></td><td style="text-align:left;">通配符匹配（<code>*</code>, <code>?</code>），不分析文本</td><td style="text-align:left;">SKU 模糊匹配，如 <code>&quot;IPH*&quot;</code> 匹配 <code>&quot;IPH15-256G&quot;</code></td></tr><tr><td style="text-align:left;"><strong>prefix</strong></td><td style="text-align:left;">前缀匹配</td><td style="text-align:left;">自动补全、品牌筛选（如 <code>&quot;App&quot;</code> 匹配 <code>&quot;Apple&quot;</code>）</td></tr><tr><td style="text-align:left;"><strong>regexp</strong></td><td style="text-align:left;">正则表达式匹配</td><td style="text-align:left;">高级模式匹配（谨慎使用，性能低）</td></tr><tr><td style="text-align:left;"><strong>ids</strong></td><td style="text-align:left;">根据文档 ID 列表查询</td><td style="text-align:left;">批量获取特定 ID 的文档</td></tr><tr><td style="text-align:left;"><strong>nested</strong></td><td style="text-align:left;">查询嵌套对象（nested 类型字段）</td><td style="text-align:left;">商品有多个规格（颜色、尺寸），需同时匹配</td></tr><tr><td style="text-align:left;"><strong>geo_distance</strong></td><td style="text-align:left;">地理位置距离查询</td><td style="text-align:left;">“附近 5 公里的门店”</td></tr><tr><td style="text-align:left;"><strong>function_score</strong></td><td style="text-align:left;">自定义评分逻辑（结合其他查询）</td><td style="text-align:left;">按热度+相关性综合排序，如“销量越高排名越靠前”</td></tr></tbody></table><blockquote><ul><li>全文 vs 精确： <ul><li><code>match</code> 系列用于 <strong>text 字段</strong>（会分词）</li><li><code>term</code>/<code>terms</code> 用于 <strong>keyword / 数字 / 日期</strong>（精确值）</li></ul></li><li>filter vs query： <ul><li><code>bool</code> 中的 <code>filter</code> 子句 <strong>不计算相关性得分</strong>，更快，适合纯过滤</li><li><code>must</code>/<code>should</code> 会计算得分，用于相关性排序</li></ul></li><li>性能提示： <ul><li>避免在高基数字段上用 <code>wildcard</code>/<code>regexp</code></li><li><code>term</code> 查询比 <code>match</code> 更快（无分词开销）</li></ul></li></ul></blockquote><h3 id="全文匹配" tabindex="-1"><a class="header-anchor" href="#全文匹配"><span>全文匹配</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 或手动构造（不推荐）</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;match&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">    <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="范围查询" tabindex="-1"><a class="header-anchor" href="#范围查询"><span>范围查询</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">RangeQueryBuilder</span> rangeQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="精确匹配" tabindex="-1"><a class="header-anchor" href="#精确匹配"><span>精确匹配</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">TermQueryBuilder</span> termQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Electronics&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">term</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;Electronics&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只用于keyword</p></blockquote><h3 id="组合查询" tabindex="-1"><a class="header-anchor" href="#组合查询"><span>组合查询</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>mm <span class="token operator">-&gt;</span> mm<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><blockquote><ul><li>must：必须匹配每个子查询，类似“与”</li><li>should：选择性匹配子查询，类似“或”</li><li>must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li><li>filter：必须匹配，<strong>不参与算分</strong></li></ul></blockquote><h3 id="排序与分页" tabindex="-1"><a class="header-anchor" href="#排序与分页"><span>排序与分页</span></a></h3><p>一提到搜索就离不开<strong>分页</strong>，es提供了一种简单分页<code>from</code>+<code>size</code>（from从0开始）：</p><blockquote><p>和sql的<code>limit</code>+<code>offset</code>基本一致，设置一个偏移量，获取偏移量之后的几个数据（即跳过offset/from个数据，拿limit/size个数据）</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 分页：第2页，每页10条（from = (page-1)*size）</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 跳过前10条</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 返回10条</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 排序：按 price 升序，_score 降序</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">&quot;_score&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s1 <span class="token operator">-&gt;</span> s1<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s2 <span class="token operator">-&gt;</span> s2<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p>在业务中我们非常容易见到需要<strong>排序</strong>的场景，es的搜索当然也提供了排序的功能<code>sort</code>，在client中指明需要排序的<strong>字段</strong>以及<strong>升序还是倒序</strong>即可：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FieldSortBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FieldSortBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s1 <span class="token operator">-&gt;</span> s1<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s2 <span class="token operator">-&gt;</span> s2<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>💡 新客户端每个 <code>.sort()</code> 调用独立，结构更清晰。</p></blockquote><h3 id="深度分页" tabindex="-1"><a class="header-anchor" href="#深度分页"><span>深度分页</span></a></h3><p>一般都分页了我们必然会进行某种程度的排序，<strong>我们会维护一个结构体（最小/大堆）存储遍历比较所得结果来实现分页排序</strong>。而且es的数据还是分布式存储的，在集群环境下，会从所有节点汇总数据，那么这时候如果我们进行了一个深度分页用的还是from size，会对所有节点都进行一次非常夸张的 <strong>Top-K 查询</strong>，消耗的资源非常多。</p><blockquote><p>举个简单例子理解一下分页排序：假设我们要按 <code>price</code> 升序取前 10 条（<code>size=10</code>）。</p><p><strong>关键技术：优先级队列（最小堆/大顶堆）</strong></p><p>Lucene 在每个分片上执行以下步骤：</p><p><strong>步骤 1：遍历所有文档（通过 Doc Values）</strong></p><ul><li>不是“全排序”，而是<strong>逐个检查文档的 <code>price</code> 值</strong></li><li>维护一个 <strong>大小为 K=10 的最小堆（Min-Heap）</strong></li></ul><p><strong>步骤 2：动态更新堆</strong></p><ul><li>初始：堆为空</li><li>看到 doc1 (price=2999) → 加入堆</li><li>看到 doc2 (price=5999) → 加入堆（堆未满）</li><li>...</li><li>堆满 10 个后： <ul><li>如果新文档 price &lt; 堆顶（当前最大值），则 <strong>弹出堆顶，插入新文档</strong>（<strong>插入</strong>这个过程的复杂度取决于此时<strong>堆大小</strong>）</li><li>否则跳过</li></ul></li></ul><p><strong>步骤 3：遍历结束，堆中就是 Top-10 最小值</strong></p><p>💡 这个过程 <strong>时间复杂度 O(N log K)</strong>，空间复杂度 O(K)，远优于 O(N log N) 全排序！</p><p>假设分片有 100 万文档，求 <code>price</code> 最小的 10 个：</p><table><thead><tr><th style="text-align:left;">方法</th><th style="text-align:left;">操作</th><th style="text-align:left;">内存</th><th style="text-align:left;">速度</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>全排序</strong></td><td style="text-align:left;">对 100 万条按 price 排序，取前10</td><td style="text-align:left;">存 100 万条</td><td style="text-align:left;">慢</td></tr><tr><td style="text-align:left;"><strong>Top-K 堆</strong></td><td style="text-align:left;">遍历 100 万次，只维护 10 个元素的堆</td><td style="text-align:left;">存 10 条</td><td style="text-align:left;"><strong>快</strong></td></tr></tbody></table><p>这就是为什么 <strong>取前10条非常快</strong> —— 它根本没排序全部数据！只是遍历了一遍而已！</p><p>那为什么深度分页耗时呢？上面我们讨论时没有加入from/offset偏移量，只使用了limit/size取的数量，我们在使用堆排序时所要维护的<strong>堆的大小其实就是from/offset+limit/size</strong>！假如堆的大小一旦过大就会导致每次插入新值需要更多的时间维护堆，而且占用内存还多，从而使得效率非常差。</p></blockquote><p>那么我们要怎么搞定这个深度分页呢？es给出的方案是：<strong>search_after</strong></p><blockquote><p><strong>不跳过数据，而是“记住上一页最后一条的位置”，从那里继续往下读。</strong> 记录最后一条的<strong>sort值</strong>，下一次遍历从<strong>sort值</strong>开始取大/小的即可，在遍历所有数据时用sort值判断<strong>这条数据是否已经被前面的分页排序查过了</strong>，用过了那直接一条<strong>if</strong>排除掉，也就是说我们<strong>无需维护from/offset偏移量大小的堆</strong>，<strong>只需维护size/limit大小的堆</strong></p></blockquote><p>这类似于：</p><ul><li>数据库的 <strong>游标分页（Cursor-based Pagination）</strong></li><li>文件读取的 <strong>文件指针（File Pointer）</strong></li></ul><p>✅ 优势：</p><ul><li><strong>无性能衰减</strong>：无论翻到第 1 页还是第 100 万页，每次只查 <code>size</code> 条</li><li><strong>无硬限制</strong>：可无限滚动</li><li><strong>实时性好</strong>：基于最新索引状态（除非配合 PIT）</li></ul><p><strong>实现原理：</strong></p><p><strong>前提条件</strong></p><ol><li><strong>必须指定排序字段（<code>sort</code>）</strong></li><li><strong>排序字段组合必须能唯一标识文档</strong>（通常加 <code>_id</code> 或业务唯一 ID）</li></ol><p><strong>流程</strong></p><ol><li><strong>第一页查询</strong>：正常查，记录最后一条的 <code>sort</code> 值</li><li><strong>第二页查询</strong>：把上一页最后一条的 <code>sort</code> 值传给 <code>search_after</code></li><li><strong>ES 定位</strong>：在排序序列中，从该 <code>sort</code> 值<strong>之后</strong>开始取 <code>size</code> 条</li></ol><blockquote><p>📌 <code>search_after</code> 的值 = 上一个文档的 <code>sort</code> 字段数组</p></blockquote><p>8.0的client调用<strong>search_after</strong>：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 第一页</span></span>
<span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Log</span><span class="token punctuation">&gt;</span></span> firstPage <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;logs&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s1 <span class="token operator">-&gt;</span> s1<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;@timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s2 <span class="token operator">-&gt;</span> s2<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取最后一条的 sort 值（用于下一页）</span></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FieldValue</span><span class="token punctuation">&gt;</span></span> lastSort <span class="token operator">=</span> firstPage<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>firstPage<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 第二页</span></span>
<span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Log</span><span class="token punctuation">&gt;</span></span> secondPage <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;logs&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s1 <span class="token operator">-&gt;</span> s1<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;@timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s2 <span class="token operator">-&gt;</span> s2<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">searchAfter</span><span class="token punctuation">(</span>lastSort<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// ← 关键！</span></span>
<span class="line">    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>缺点：<strong>只能按顺序来</strong></p></blockquote><h3 id="高亮显示" tabindex="-1"><a class="header-anchor" href="#高亮显示"><span>高亮显示</span></a></h3><p>让搜索结果中匹配关键词的部分<strong>高亮显示</strong>（如 <code>&lt;em&gt;手机&lt;/em&gt;</code>），极大提升用户体验。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;strong&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/strong&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">fragmentSize</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">numOfFragments</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 解析高亮</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">HighlightField</span> titleField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>titleField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> highlighted <span class="token operator">=</span> titleField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&quot;手机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span>h <span class="token operator">-&gt;</span> h</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> hf <span class="token operator">-&gt;</span> hf</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;strong&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/strong&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">fragmentSize</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">numberOfFragments</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取高亮结果</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> hit <span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> highlights <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>highlights <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>highlights<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> highlightedTitle <span class="token operator">=</span> highlights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>highlightedTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如: 智能&lt;strong&gt;手机&lt;/strong&gt; Pro</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="数据聚合" tabindex="-1"><a class="header-anchor" href="#数据聚合"><span>数据聚合</span></a></h2><p><strong>Elasticsearch 的聚合（Aggregation）</strong> —— 它是 ES 除搜索外最强大的功能，用于<strong>对数据进行分组、统计、分析</strong>，类似 SQL 中的 <code>GROUP BY</code> + 聚合函数，但能力远超传统数据库。</p><p>聚合 = <strong>对一组文档进行计算，返回指标或分组结果</strong>。</p><p>常见用途：</p><ul><li>商品按分类统计数量（<code>terms</code>）</li><li>计算平均价格（<code>avg</code>）</li><li>按日期范围统计订单量（<code>date_histogram</code>）</li><li>找出最贵/最便宜的商品（<code>min</code>/<code>max</code>）</li><li>地理位置热力图（<code>geo_hash</code>）</li></ul><blockquote><p>💡 聚合在 <code>_search</code> 请求中通过 <code>aggs</code> 或 <code>aggregations</code> 字段定义。</p></blockquote><p>三种聚合类型：</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">作用</th><th style="text-align:left;">常见子类型</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Metric（指标）</strong></td><td style="text-align:left;">计算单个数值指标</td><td style="text-align:left;"><code>avg</code>, <code>sum</code>, <code>min</code>, <code>max</code>, <code>cardinality</code>（去重计数）</td></tr><tr><td style="text-align:left;"><strong>Bucket（桶）</strong></td><td style="text-align:left;">将文档分组（类似 GROUP BY）</td><td style="text-align:left;"><code>terms</code>, <code>range</code>, <code>date_histogram</code>, <code>filter</code></td></tr><tr><td style="text-align:left;"><strong>Pipeline（管道）</strong></td><td style="text-align:left;">对其他聚合的结果再计算</td><td style="text-align:left;"><code>derivative</code>（求导）, <code>cumulative_sum</code></td></tr></tbody></table><blockquote><p>大多数场景用 <strong>Metric + Bucket 组合</strong>。</p></blockquote><p>常用的聚合类型：</p><table><thead><tr><th style="text-align:left;">聚合类型</th><th style="text-align:left;">用途</th><th style="text-align:left;">类比 SQL</th></tr></thead><tbody><tr><td style="text-align:left;"><code>terms</code></td><td style="text-align:left;">按字段值分组</td><td style="text-align:left;"><code>GROUP BY category</code></td></tr><tr><td style="text-align:left;"><code>avg</code>/<code>sum</code></td><td style="text-align:left;">数值统计</td><td style="text-align:left;"><code>AVG(price)</code></td></tr><tr><td style="text-align:left;"><code>date_histogram</code></td><td style="text-align:left;">按时间分组</td><td style="text-align:left;"><code>GROUP BY DATE(order_date)</code></td></tr><tr><td style="text-align:left;"><code>range</code></td><td style="text-align:left;">区间分组</td><td style="text-align:left;"><code>CASE WHEN price &lt; 1000 THEN &#39;low&#39; ...</code></td></tr></tbody></table><h3 id="指标聚合metric" tabindex="-1"><a class="header-anchor" href="#指标聚合metric"><span>指标聚合Metric</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 1. 构建搜索请求</span></span>
<span class="line"><span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 构建查询源（source）</span></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">sourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不返回原始文档</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. 添加 Metric 聚合（使用 AggregationBuilders 工具类）</span></span>
<span class="line"><span class="token class-name">AvgAggregationBuilder</span> avgPrice <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">MaxAggregationBuilder</span> maxPrice <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">&quot;max_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">MinAggregationBuilder</span> minPrice <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">&quot;min_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">CardinalityAggregationBuilder</span> distinctProducts <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token string">&quot;distinct_products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;product_id.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意：text 字段需用 .keyword</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 将聚合添加到 source</span></span>
<span class="line">sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>avgPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>maxPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>minPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>distinctProducts<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 设置查询源</span></span>
<span class="line">searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. 执行查询</span></span>
<span class="line"><span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 5. 解析聚合结果（需要强制类型转换！）</span></span>
<span class="line"><span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取 avg 聚合结果 → 必须 cast 为 ParsedAvg</span></span>
<span class="line"><span class="token class-name">ParsedAvg</span> avgAgg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> avgPriceValue <span class="token operator">=</span> avgAgg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可能为 Double.NaN，建议判空</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取 max</span></span>
<span class="line"><span class="token class-name">ParsedMax</span> maxAgg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;max_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> maxPriceValue <span class="token operator">=</span> maxAgg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取 min</span></span>
<span class="line"><span class="token class-name">ParsedMin</span> minAgg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;min_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> minPriceValue <span class="token operator">=</span> minAgg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取 cardinality（去重计数）</span></span>
<span class="line"><span class="token class-name">ParsedCardinality</span> cardAgg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;distinct_products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">long</span> distinctCount <span class="token operator">=</span> cardAgg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 执行聚合查询（不返回原始文档）</span></span>
<span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>               <span class="token comment">// 指定索引</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                         <span class="token comment">// 不需要返回匹配的文档，只关心聚合结果</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>av <span class="token operator">-&gt;</span> av<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 定义 avg 聚合：计算 price 的平均值</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;max_price&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">// 定义 max 聚合：price 最大值</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;min_price&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">// 定义 min 聚合：price 最小值</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;distinct_products&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;product_id.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 去重计数（近似）</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Void</span><span class="token punctuation">.</span><span class="token keyword">class</span>  <span class="token comment">// 因为 size=0，无需反序列化 _source，用 Void 提高性能</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 获取聚合结果（强类型，无需强制转换）</span></span>
<span class="line"><span class="token class-name">Aggregate</span> avgAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> avgPrice <span class="token operator">=</span> avgAgg<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 可能为 null，实际使用建议判空</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Aggregate</span> maxAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;max_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> maxPrice <span class="token operator">=</span> maxAgg<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Aggregate</span> minAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;min_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">double</span> minPrice <span class="token operator">=</span> minAgg<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Aggregate</span> cardAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;distinct_products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">long</span> distinctCount <span class="token operator">=</span> cardAgg<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong><code>size(0)</code></strong>：避免返回原始文档，节省网络和内存开销。</li><li><strong><code>Void.class</code></strong>：因为不关心 <code>_source</code>，使用 <code>Void</code> 提升性能。</li><li><strong>强类型访问</strong>：如 <code>agg.avg().value()</code>，编译期安全，IDE 自动补全。</li><li>字段要求： <ul><li><code>price</code> 必须是 <code>number</code> 类型（如 <code>float</code>、<code>integer</code>）</li><li><code>product_id</code> 需用 <code>.keyword</code>（因为 <code>text</code> 无法去重计数）</li></ul></li><li><strong><code>cardinality</code> 是近似值</strong>：基于 HyperLogLog++ 算法，适合大数据量去重。</li></ul></blockquote><h3 id="桶聚合bucket" tabindex="-1"><a class="header-anchor" href="#桶聚合bucket"><span>桶聚合Bucket</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 1. 构建请求</span></span>
<span class="line"><span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 构建桶聚合 + 子聚合</span></span>
<span class="line"><span class="token class-name">TermsAggregationBuilder</span> termsAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;by_category&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">AvgAggregationBuilder</span> avgAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">termsAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>avgAgg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ← 关键：用 subAggregation 添加子聚合</span></span>
<span class="line">builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>termsAgg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. 执行</span></span>
<span class="line"><span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. 解析结果（需多次强制类型转换！）</span></span>
<span class="line"><span class="token class-name">Aggregations</span> aggs <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">ParsedTerms</span> byCategory <span class="token operator">=</span> aggs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;by_category&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ← 必须知道返回的是 ParsedTerms</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ParsedBucket</span> bucket <span class="token operator">:</span> byCategory<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> category <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 分组 key</span></span>
<span class="line">    <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 文档数</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取子聚合 → 再次 cast！</span></span>
<span class="line">    <span class="token class-name">ParsedAvg</span> avgPriceAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">double</span> avgPrice <span class="token operator">=</span> avgPriceAgg<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>category <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> docCount <span class="token operator">+</span> <span class="token string">&quot; items, avg price = &quot;</span> <span class="token operator">+</span> avgPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>新版：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 执行带桶聚合的查询</span></span>
<span class="line"><span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s</span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;by_category&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a                    <span class="token comment">// 聚合名称: by_category</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t                                      <span class="token comment">// 桶聚合类型: terms</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;category.keyword&quot;</span><span class="token punctuation">)</span>                     <span class="token comment">// 分组字段</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>                                      <span class="token comment">// 返回 top 10 个分类</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">,</span> ag <span class="token operator">-&gt;</span> ag                <span class="token comment">// 子聚合: avg_price</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span>av <span class="token operator">-&gt;</span> av<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                  <span class="token comment">// 计算 price 平均值</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Void</span><span class="token punctuation">.</span><span class="token keyword">class</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 解析结果（强类型，无需 cast）</span></span>
<span class="line"><span class="token class-name">TermsAggregate</span> categories <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;by_category&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">sterms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sterm() 表示 standard terms（非 composite）</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TermsBucket</span> bucket <span class="token operator">:</span> categories<span class="token punctuation">.</span><span class="token function">buckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> category <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 分组 key（如 &quot;Electronics&quot;）</span></span>
<span class="line">    <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">docCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 该分类下的文档数</span></span>
<span class="line">    <span class="token keyword">double</span> avgPrice <span class="token operator">=</span> bucket</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;avg_price&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 子聚合结果</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>category <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> docCount <span class="token operator">+</span> <span class="token string">&quot; items, avg price = &quot;</span> <span class="token operator">+</span> avgPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote>`,117))])}const q=o(u,[["render",g]]),h=JSON.parse('{"path":"/docs/heimashangcheng/weifuwu/10.ElasticSearch.html","title":"ElasticSearch","lang":"en-US","frontmatter":{"title":"ElasticSearch","date":"2026-2-12"},"headers":[{"level":2,"title":"配置与安装","slug":"配置与安装","link":"#配置与安装","children":[]},{"level":2,"title":"简要认识ES","slug":"简要认识es","link":"#简要认识es","children":[{"level":3,"title":"基础概念","slug":"基础概念","link":"#基础概念","children":[]},{"level":3,"title":"倒排索引","slug":"倒排索引","link":"#倒排索引","children":[]},{"level":3,"title":"IK分词器","slug":"ik分词器","link":"#ik分词器","children":[]}]},{"level":2,"title":"数据操作","slug":"数据操作","link":"#数据操作","children":[{"level":3,"title":"Mapping映射","slug":"mapping映射","link":"#mapping映射","children":[]},{"level":3,"title":"索引库操作","slug":"索引库操作","link":"#索引库操作","children":[]},{"level":3,"title":"文档操作","slug":"文档操作","link":"#文档操作","children":[]},{"level":3,"title":"批量操作","slug":"批量操作","link":"#批量操作","children":[]}]},{"level":2,"title":"JavaRestClient","slug":"javarestclient","link":"#javarestclient","children":[{"level":3,"title":"安装与配置","slug":"安装与配置","link":"#安装与配置","children":[]},{"level":3,"title":"索引库操作（表）","slug":"索引库操作-表","link":"#索引库操作-表","children":[]},{"level":3,"title":"文档操作（row）","slug":"文档操作-row","link":"#文档操作-row","children":[]}]},{"level":2,"title":"DSL查询","slug":"dsl查询","link":"#dsl查询","children":[{"level":3,"title":"全文匹配","slug":"全文匹配","link":"#全文匹配","children":[]},{"level":3,"title":"范围查询","slug":"范围查询","link":"#范围查询","children":[]},{"level":3,"title":"精确匹配","slug":"精确匹配","link":"#精确匹配","children":[]},{"level":3,"title":"组合查询","slug":"组合查询","link":"#组合查询","children":[]},{"level":3,"title":"排序与分页","slug":"排序与分页","link":"#排序与分页","children":[]},{"level":3,"title":"深度分页","slug":"深度分页","link":"#深度分页","children":[]},{"level":3,"title":"高亮显示","slug":"高亮显示","link":"#高亮显示","children":[]}]},{"level":2,"title":"数据聚合","slug":"数据聚合","link":"#数据聚合","children":[{"level":3,"title":"指标聚合Metric","slug":"指标聚合metric","link":"#指标聚合metric","children":[]},{"level":3,"title":"桶聚合Bucket","slug":"桶聚合bucket","link":"#桶聚合bucket","children":[]}]}],"git":{"createdTime":1771338216000,"updatedTime":1771338216000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/黑马商城/微服务/10.ElasticSearch.md"}');export{q as comp,h as data};
