import{_ as n,c as a,b as t,o as e}from"./app-CqA1IfE7.js";const p={};function l(o,s){return e(),a("div",null,[...s[0]||(s[0]=[t(`<p>使用mybatisplus版本：&lt;mybatis-plus.version&gt;3.5.14&lt;/mybatis-plus.version&gt;</p><p>版本不同可能导致各种各样的问题（如jdk不兼容mybatisplus和他的配件</p><p>mybatisplus不够用了，得搞点原生的mapper来做多表查询</p><p>将提供的一些牛逼版查询加入以实现多表联查，分页等功能</p><ol><li>将mapperxml导入，需要将与mybatisplus冲突的简单sql去除（根据完成的xml，让ai直接完成对ftl模版的编写）</li><li>将分页dto导入，载入手动分页（mybatisplus提供的分页也仅支持单表查询）</li></ol><p>修改这个主要是实现mybatisplus实现不了的<strong>多表查询</strong>，以及<strong>insertOrUpdate</strong>避免索引异常问题（mybatisplus只处理主键id冲突，且只能指定一个主键，多主键或者有其他unique索引无法处理）。</p><blockquote><p><strong>insertOrUpdate</strong>用<code>ON DUPLICATE KEY UPDATE</code>的方式来实现避免索引异常可以吗？</p><p>可以，但是这个操作会进行先加<strong>S锁</strong>再加<strong>X锁</strong>的操作，当我们对一行记录进行相同的DUPLICATE操作时，尝试获取X锁需要其他事务释放S锁，而这时两个事务都会等待对方释放S锁，这就会导致死锁。虽然可以超时异常抛出，但是在实际生产环境非常不推荐使用它！</p><p>除非你能<strong>确保</strong>操作的<strong>这一行数据</strong>是<strong>不会出现高并发</strong>的，而我们所写的脚手架是<strong>无法确保这一点</strong>的，所以不可以使用！</p><p>选择其他方案：</p><table><thead><tr><th>方案</th><th>是否推荐</th><th>适用场景</th></tr></thead><tbody><tr><td><code>ON DUPLICATE KEY UPDATE</code></td><td>❌（高并发下慎用）</td><td>低并发、可重试、简单场景</td></tr><tr><td><strong>INSERT + 异常捕获 + UPDATE</strong></td><td>✅ <strong>推荐</strong></td><td>通用脚手架、高并发系统</td></tr><tr><td><code>SELECT FOR UPDATE</code> + 判断</td><td>✅（特定场景）</td><td>强一致性、<strong>低并发</strong>关键操作</td></tr><tr><td>ODKU + 重试</td><td>⚠️ 可接受</td><td>具备重试机制、死锁容忍度高</td></tr></tbody></table><p><strong>INSERT + 异常捕获 + UPDATE 方案:</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token function">insertRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token function">updateRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意更新的条件构造器需要指定好索引的字段，相对来说复杂一些（多字段索引下不能只针对一个字段更新）</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">mapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">    <span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;columnName&quot;</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">    <span class="token function">eq</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><code>SELECT FOR UPDATE</code> + 判断 方案：</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> unique_key <span class="token operator">=</span> <span class="token string">&#39;xxx&#39;</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 应用层判断是否存在：</span></span>
<span class="line"><span class="token comment">--   if exists → UPDATE</span></span>
<span class="line"><span class="token comment">--   else      → INSERT</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意会加<strong>X锁</strong>，高并发下会带来性能损耗！</p></blockquote><p>需要完成的mapper复杂查询：</p><ol><li>全部模糊查询：根据输入非空内容对相应表做模糊查询，在service层写太难看了，写到mapper里面去</li><li>插入或更新：有些时候会有多个索引（双主键等），需要加入检查来实现insertOrUpdate</li><li>联表基础sql：自己表的简单查询即可，方便后续有需求时修改联表查询</li></ol><p>对redis的模版做优化</p>`,10)])])}const c=n(p,[["render",l]]),r=JSON.parse('{"path":"/docs/wx/houduanbufen/duidaimashengchengqideyouhua.html","title":"对代码生成器的优化","lang":"en-US","frontmatter":{"title":"对代码生成器的优化","date":"2025-11-28T00:00:00.000Z"},"headers":[],"git":{"createdTime":1768129846000,"updatedTime":1768129846000,"contributors":[{"name":"SaltFishGC","email":"130335482+SaltFishGC@users.noreply.github.com","commits":1}]},"filePathRelative":"docs/wx/后端部分/对代码生成器的优化.md"}');export{c as comp,r as data};
