---
title: è‡ªåˆ¶mermaidæ¸²æŸ“æ’ä»¶
date: 2026/2/20
tags:
 - åšå®¢
categories:
 - blog
---

reco é£æ ¼æ²¡æœ‰å®ç° mermaid æ¸²æŸ“ï¼Œç›´æ¥ä½¿ç”¨ **mdenhance** åˆä¼šå‘ç° vuepress ç‰ˆæœ¬å¯¹ä¸ä¸Šï¼Œé‚£æˆ‘ä»¬å°±è‡ªå·±æ‰‹æ“ä¸€ä¸ªå§âœ‹ï¸

## VuePress çš„æ¸²æŸ“é€»è¾‘

é¦–å…ˆæˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹ VuePress çš„æ¸²æŸ“é€»è¾‘ï¼š

```mermaid
flowchart LR
    subgraph Step1["ç¬¬ä¸€æ­¥ï¼šMarkdown è§£æ"]
        MD["ğŸ“„ Markdown<br/>(.md æ–‡ä»¶)"]
        MD_IT["âš™ï¸ markdown-it<br/>è§£ææ¸²æŸ“"]
    end
    
    subgraph Step2["ç¬¬äºŒæ­¥ï¼šVue ç¼–è¯‘"]
        VUE["ğŸ“¦ Vue SFC<br/>(.vue ç»„ä»¶)"]
        VUE_COMPILER["ğŸ”§ vue-compiler<br/>ç¼–è¯‘ç»„ä»¶"]
    end
    
    subgraph Step3["ç¬¬ä¸‰æ­¥ï¼šé™æ€æ„å»º"]
        HTML["ğŸŒ é™æ€ HTML<br/>(/dist ç›®å½•)"]
        VITE["ğŸš€ Vite/SSG<br/>æ‰“åŒ…æ„å»º"]
    end
    
    MD --> MD_IT
    MD_IT --> VUE
    VUE --> VUE_COMPILER
    VUE_COMPILER --> HTML
    HTML --> VITE
    
    style Step1 fill:#e1f5fe,stroke:#039be5,stroke-width:2px
    style Step2 fill:#fff3e0,stroke:#fb8c00,stroke-width:2px
    style Step3 fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    style MD fill:#ffffff,stroke:#333,stroke-width:1px
    style VUE fill:#ffffff,stroke:#333,stroke-width:1px
    style HTML fill:#ffffff,stroke:#333,stroke-width:1px
```

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸º **md æ–‡ä»¶ â†’ vue â†’ é™æ€ web** è¿™æ ·çš„æ¸²æŸ“è¿‡ç¨‹ã€‚

åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå…³é”®åˆ‡å…¥ç‚¹ï¼š

1. **Markdown è§£æé˜¶æ®µ**ï¼šé€šè¿‡ `extendsMarkdown` æ‹¦æˆª fence ä»£ç å—
2. **Vue å®¢æˆ·ç«¯å¢å¼ºé˜¶æ®µ**ï¼šé€šè¿‡ `clientConfigFile` æ³¨å†Œå…¨å±€ç»„ä»¶

## ä¸¤ç§æ–¹æ¡ˆ

VuePress å…¶å®ä¸ºæ’ä»¶åˆ¶ä½œæä¾›äº†å¾ˆå¤šæ¥å£ï¼Œé’ˆå¯¹ Mermaid æ¸²æŸ“ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ           | æ¸²æŸ“æ—¶æœº                                                     | ä¼˜ç‚¹                     | ç¼ºç‚¹                 |
| -------------- | ------------------------------------------------------------ | ------------------------ | -------------------- |
| **æ„å»ºæ—¶æ¸²æŸ“** | `extendsMarkdown` ä¸­ç›´æ¥mermaid.render()ç”Ÿæˆ SVGï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µå°±å®Œæˆsvgå›¾çš„ç”Ÿæˆ | SSR å‹å¥½ã€SEO å¥½ã€æ— é—ªçƒ | æ„å»ºæ…¢ã€ä¸»é¢˜åˆ‡æ¢å›°éš¾ |
| **è¿è¡Œæ—¶æ¸²æŸ“** | ç¬¬ä¸€é˜¶æ®µæ‹¦æˆªå®Œæˆååšæˆä¸€ä¸ª**Component**ç»„ä»¶ï¼Œç¬¬äºŒé˜¶æ®µåˆ©ç”¨å®¢æˆ·ç«¯ç»„ä»¶enhance vueæŒ‚è½½è¿™ä¸ªçš„Componentå¹¶è°ƒç”¨mermaid.render()å®Œæˆæ¸²æŸ“ | æ„å»ºå¿«ã€æ”¯æŒåŠ¨æ€ç‰¹æ€§     | æœ‰ FOUCã€éœ€å®¢æˆ·ç«¯ JS |

> vuepressçš„æ¥å£è¯´æ˜æ–‡æ¡£ï¼š[æ’ä»¶ API | VuePress](https://v2.vuepress.vuejs.org/zh/reference/plugin-api.html)

è€ƒè™‘åˆ°æˆ‘ä»¬çš„éœ€æ±‚ï¼ˆæ–‡æ¡£ç«™ã€ä¸»é¢˜å¯èƒ½åˆ‡æ¢ã€æ„å»ºé€Ÿåº¦ï¼‰ï¼Œ**é€‰æ‹©è¿è¡Œæ—¶æ¸²æŸ“æ–¹æ¡ˆ**æ›´åˆé€‚ã€‚

## æ’ä»¶å®ç°

### **å®‰è£…ä¾èµ–**

é¦–å…ˆéœ€è¦å®‰è£… `mermaid` åŒ…ï¼š

```bash
# npm
npm install mermaid

# pnpm
pnpm add mermaid

# yarn
yarn add mermaid
```

å®‰è£…å®Œæˆå¯ä»¥åˆ°package.jsonæŸ¥çœ‹æ˜¯å¦å·²ç»å®Œæˆå®‰è£…ï¼š

```json
  "dependencies": {
    "mermaid": "^11.12.2",
    ......
  }
```

### ç›®å½•ç»“æ„

```
.vuepress/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ mermaid.ts          # æ’ä»¶ä¸»æ–‡ä»¶ï¼ˆNode ç«¯ï¼‰
â”‚   â””â”€â”€ mermaid.client.ts   # å®¢æˆ·ç«¯å¢å¼ºæ–‡ä»¶ï¼ˆBrowser ç«¯ï¼‰
â””â”€â”€ config.ts               # VuePress é…ç½®æ–‡ä»¶
```

### æ’ä»¶ä¸»æ–‡ä»¶

```typescript
// .vuepress/plugins/mermaid.ts
import type { Plugin } from '@vuepress/core'
import { path } from '@vuepress/utils'

export const mermaidPlugin: Plugin = {
  name: 'mermaid-plugin',

  // æ‰©å±• Markdown æ¸²æŸ“è§„åˆ™
  extendsMarkdown: (md) => {
    const defaultFence = md.renderer.rules.fence
    
    md.renderer.rules.fence = (...args) => {
      const [tokens, idx] = args
      const token = tokens[idx]
      
      // æ£€æŸ¥ä»£ç å—çš„è¯­è¨€æ ‡è¯†æ˜¯å¦ä¸º 'mermaid'
      if (token.info?.trim() === 'mermaid') {
        const code = encodeURIComponent(token.content)
        return `<MermaidDiagram code="${code}" />`
      }
      
      return defaultFence?.(...args) || ''
    }
  },

  // æŒ‡å®šå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶è·¯å¾„
  clientConfigFile: path.resolve(__dirname, './mermaid.client.ts'),
}

export default mermaidPlugin
```

**å…³é”®ç‚¹è¯´æ˜ï¼š**

- `extendsMarkdown`ï¼šåœ¨ Markdown è§£æé˜¶æ®µæ‹¦æˆª ````mermaid` ä»£ç å—
- `encodeURIComponent`ï¼šå¯¹ä»£ç å†…å®¹è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢ç‰¹æ®Šå­—ç¬¦ç ´å HTML å±æ€§
- `clientConfigFile`ï¼šæŒ‡å‘å®¢æˆ·ç«¯å¢å¼ºæ–‡ä»¶ï¼Œç”¨äºæ³¨å†Œå…¨å±€ç»„ä»¶

### å®¢æˆ·ç«¯å¢å¼ºæ–‡ä»¶

```typescript
// .vuepress/plugins/mermaid.client.ts
import { defineClientConfig } from '@vuepress/client'
import { h, defineComponent } from 'vue'
import mermaid from 'mermaid'

// åˆå§‹åŒ– mermaid é…ç½®
mermaid.initialize({
  startOnLoad: false,      // ä¸è‡ªåŠ¨æ¸²æŸ“ï¼Œæ‰‹åŠ¨æ§åˆ¶
  theme: 'default',        // é»˜è®¤ä¸»é¢˜
  securityLevel: 'loose'   // å®½æ¾æ¨¡å¼ï¼ˆæ³¨æ„å®‰å…¨é£é™©ï¼‰
})

// å®šä¹‰ MermaidDiagram ç»„ä»¶
const MermaidDiagram = defineComponent({
  props: ['code'],
  
  async mounted() {
    try {
      const decoded = decodeURIComponent(this.code)
      const id = `mermaid-${Date.now()}-${Math.random().toString(36).slice(2)}`
      const { svg } = await mermaid.render(id, decoded)
      this.$el.innerHTML = svg
    } catch (err) {
      console.error('Mermaid render error:', err)
      this.$el.innerHTML = '<pre style="color:red">Mermaid å›¾è¡¨æ¸²æŸ“å¤±è´¥</pre>'
    }
  },

  render() {
    return h('div', {
      class: 'mermaid-diagram',
      style: { textAlign: 'center' }
    })
  },
})

// æ³¨å†Œå…¨å±€ç»„ä»¶
export default defineClientConfig({
  enhance({ app }) {
    app.component('MermaidDiagram', MermaidDiagram)
  }
})
```

**å…³é”®ç‚¹è¯´æ˜ï¼š**

- `startOnLoad: false`ï¼šç¦ç”¨è‡ªåŠ¨æ¸²æŸ“ï¼Œé¿å…ä¸æ‰‹åŠ¨æ¸²æŸ“å†²çª
- **å”¯ä¸€ ID ç”Ÿæˆ**ï¼šå¢åŠ äº† `Math.random()` ç¡®ä¿å¿«é€Ÿè¿ç»­æ¸²æŸ“æ—¶ ID ä¸å†²çª
- **é”™è¯¯å¤„ç†**ï¼šæ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œä¸å½±å“é¡µé¢å…¶ä»–å†…å®¹
- `defineClientConfig`ï¼šVuePress 2.x çš„å®¢æˆ·ç«¯é…ç½®æ ‡å‡†æ–¹å¼

### é…ç½®æ–‡ä»¶é›†æˆ

```typescript
// .vuepress/config.ts
import { defineUserConfig } from "vuepress"
import recoTheme from "vuepress-theme-reco"
import { viteBundler } from '@vuepress/bundler-vite'
import { mermaidPlugin } from './plugins/mermaid'

export default defineUserConfig({
  title: "SaltFishGC`s Blog",
  bundler: viteBundler(),
  plugins: [
    mermaidPlugin
  ],
  theme: recoTheme({
    // reco ä¸»é¢˜é…ç½®...
  })
})
```

## ä½¿ç”¨ç¤ºä¾‹

åœ¨ Markdown æ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨ï¼š

~~~markdown
```mermaid
graph TD
    A[å¼€å§‹] --> B{æ¡ä»¶åˆ¤æ–­}
    B -->|æ˜¯ | C[æ‰§è¡Œæ“ä½œ]
    B -->|å¦ | D[ç»“æŸ]
    C --> D
```
~~~

æ¸²æŸ“æ•ˆæœï¼š

```mermaid
graph TD
    A[å¼€å§‹] --> B{æ¡ä»¶åˆ¤æ–­}
    B -->|æ˜¯ | C[æ‰§è¡Œæ“ä½œ]
    B -->|å¦ | D[ç»“æŸ]
    C --> D
```

### æ›´å¤šå›¾è¡¨ç±»å‹

**åºåˆ—å›¾ï¼š**

~~~markdown
```mermaid
sequenceDiagram
    Alice->>John: Hello John, how are you?
    John-->>Alice: Great!
```
~~~

**ç±»å›¾ï¼š**

~~~markdown
```mermaid
classDiagram
    Animal <|-- Duck
    Animal <|-- Fish
    Animal: +int age
    Animal: +String gender
```
~~~

## æ ·å¼å®šåˆ¶

å¦‚æœæƒ³è®©å›¾è¡¨é€‚é… reco ä¸»é¢˜çš„æ·±è‰²æ¨¡å¼ï¼Œå¯ä»¥æ·»åŠ  CSS å˜é‡ï¼š

```css
/* .vuepress/styles/index.css */
.mermaid-diagram {
  margin: 1.5rem 0;
  padding: 1rem;
  background: var(--code-bg-color, #f6f8fa);
  border-radius: 8px;
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
[data-theme="dark"] .mermaid-diagram {
  background: #2d2d2d;
}
```

é…åˆ mermaid ä¸»é¢˜åˆ‡æ¢ï¼š

```typescript
// åœ¨ mermaid.client.ts ä¸­ç›‘å¬ä¸»é¢˜å˜åŒ–
import { useDarkMode } from '@vuepress/client'

const isDark = useDarkMode()
watch(isDark, (val) => {
  mermaid.initialize({
    theme: val ? 'dark' : 'default'
  })
  // é‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾è¡¨...
})
```

## æ³¨æ„äº‹é¡¹

| é—®é¢˜           | è§£å†³æ–¹æ¡ˆ                                        |
| -------------- | ----------------------------------------------- |
| **ID å†²çª**    | ä½¿ç”¨ `Date.now() + Math.random()` ç”Ÿæˆå”¯ä¸€ ID   |
| **SSR è­¦å‘Š**   | ç¡®ä¿ mermaid åªåœ¨ `mounted` ä¸­è°ƒç”¨ï¼ˆå®¢æˆ·ç«¯ï¼‰    |
| **æ„å»ºæŠ¥é”™**   | æ£€æŸ¥ mermaid æ˜¯å¦æ­£ç¡®å®‰è£… `npm install mermaid` |
| **æ ·å¼ä¸ç»§æ‰¿** | é€šè¿‡ CSS å˜é‡æˆ–å…¨å±€æ ·å¼è¦†ç›–                     |
| **ä¸»é¢˜åˆ‡æ¢**   | ç›‘å¬ä¸»é¢˜å˜åŒ–åé‡æ–°è°ƒç”¨ `mermaid.render()`       |

## æ€»ç»“

è¿™ä¸ªæ’ä»¶çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

1. **Markdown é˜¶æ®µ**ï¼šæ‹¦æˆª `mermaid` ä»£ç å—ï¼Œæ›¿æ¢ä¸ºè‡ªå®šä¹‰ç»„ä»¶æ ‡ç­¾
2. **å®¢æˆ·ç«¯é˜¶æ®µ**ï¼šæ³¨å†Œå…¨å±€ç»„ä»¶ï¼Œåœ¨ `mounted` é’©å­ä¸­è°ƒç”¨ mermaid æ¸²æŸ“
3. **è¿è¡Œæ—¶æ¸²æŸ“**ï¼šå¹³è¡¡äº†æ„å»ºé€Ÿåº¦å’ŒåŠ¨æ€ç‰¹æ€§éœ€æ±‚

ç›¸æ¯”ç›´æ¥ä½¿ç”¨ç°æˆæ’ä»¶ï¼Œæ‰‹æ“çš„å¥½å¤„æ˜¯ï¼š

- âœ… å®Œå…¨æ§åˆ¶æ¸²æŸ“é€»è¾‘
- âœ… é€‚é…ç‰¹å®šä¸»é¢˜é£æ ¼
- âœ… æ— ç‰ˆæœ¬å…¼å®¹é—®é¢˜
- âœ… ä»£ç ç²¾ç®€ï¼Œæ— å†—ä½™ä¾èµ–

